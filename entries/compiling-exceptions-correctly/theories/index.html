<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Session Compiling-Exceptions-Correctly - Archive of Formal Proofs</title><meta name=description content="A collection of proof libraries, examples, and larger scientific developments, mechanically checked in the theorem prover Isabelle."><meta property="og:title" content="Session Compiling-Exceptions-Correctly"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="/entries/compiling-exceptions-correctly/theories/"><meta property="og:image" content="/images/afp.png"><meta property="article:section" content="theories"><meta property="og:site_name" content="Archive of Formal Proofs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/afp.png"><meta name=twitter:title content="Session Compiling-Exceptions-Correctly"><meta name=twitter:description content><link rel=stylesheet type=text/css href=/css/front.min.css><link rel=stylesheet type=text/css href=/css/isabelle.css><link rel=icon href=/images/favicon.ico type=image/icon><script src=/js/flexsearch.min.js></script><script src=/js/banner.js></script><script src=/js/header-search.js></script></head><body class=mathjax_ignore><aside><div><div><a href=/><img src=/images/afp.png alt="Logo of the Archive of Formal Proofs" class=logo></a><ul><li><a href=/entries/compiling-exceptions-correctly>Return to entry</a></li></ul><hr><ul><li><a href=#Exceptions>Exceptions</a><ul><li><a href=#Exceptions-size_jump1>size_jump1</a></li><li><a href=#Exceptions-size_jump2>size_jump2</a></li><li><a href=#Exceptions-3>3</a></li><li><a href=#Exceptions-5>5</a></li><li><a href=#Exceptions-6>6</a></li><li><a href=#Exceptions-4>4</a></li><li><a href=#Exceptions-7>7</a></li></ul></li></ul></div><ul><li><a href=https://www.isa-afp.org/browser_info/current/AFP/Compiling-Exceptions-Correctly/outline.pdf>Proof
outline</a></li><li><a href=https://www.isa-afp.org/browser_info/current/AFP/Compiling-Exceptions-Correctly/document.pdf>Proof
document</a></li><li><a href=https://www.isa-afp.org/browser_info/current/AFP/Compiling-Exceptions-Correctly/session_graph.pdf>Theory dependencies</a></li></ul></div></aside><div class=contenttheories><header><form action=/%20search><div class=form-container><input id=searchInput type=search size=31 maxlength=255 aria-label="Search the AFP" list=autocomplete><button id=searchButton type=button><img src=/images/search.svg alt=Search></button>
<datalist id=autocomplete></datalist></div></form><h1><span class=first>S</span>ession <span class=first>C</span>ompiling-<span class=first>E</span>xceptions-<span class=first>C</span>orrectly</h1><div></div></header><div id=banner data-id=0><p>This is an unofficial reimagining of the <a href=https://isa-afp.org target=_blank rel="noreferrer noopener">Archive of Formal Proofs</a></p><button style=display:none id=close title=close><svg viewBox="0 0 6.718 6.718" aria-hidden="true" focusable="false"><rect transform="rotate(45)" x="4" y="-4" width="1.5" height="8"/><rect transform="rotate(45)" x=".75" y="-.75" width="8" height="1.5"/></svg></button></div><div><main><div id=Exceptions><div class=head><h1>Theory Exceptions</h1></div><pre class=source><span class=comment1>(*  Author:     Tobias Nipkow
    Copyright   2004 TU Muenchen
*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Compiling exception handling›</span></span>

<span class=keyword1><span class=command>theory</span></span> Exceptions
<span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The source language›</span></span>

<span class=keyword1><span class=command>datatype</span></span> expr <span class=main>=</span> Val <span class=quoted>int</span> <span class=main>|</span> Add <span class=quoted>expr</span> <span class=quoted>expr</span> <span class=main>|</span> Throw <span class=main>|</span> Catch <span class=quoted>expr</span> <span class=quoted>expr</span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>eval</span> <span class=main>::</span> <span class=quoted><span class=quoted>"expr <span class=main>⇒</span> int option"</span></span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval</span> <span class=main>(</span>Val <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> Some <span class=free><span class=bound><span class=entity>i</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval</span> <span class=main>(</span>Add <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span>
   <span class=main>(</span><span class=keyword1>case</span> <span class=free>eval</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None
    <span class=main>|</span> Some <span class=bound>i</span> <span class=main>⇒</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>eval</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None
                 <span class=main>|</span> Some <span class=bound>j</span> <span class=main>⇒</span> Some<span class=main>(</span><span class=bound>i</span><span class=main>+</span><span class=bound>j</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval</span> Throw <span class=main>=</span> None"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval</span> <span class=main>(</span>Catch <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>h</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>eval</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> <span class=free>eval</span> <span class=free><span class=bound><span class=entity>h</span></span></span> <span class=main>|</span> Some <span class=bound>i</span> <span class=main>⇒</span> Some <span class=bound>i</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The target language›</span></span>

<span class=keyword1><span class=command>datatype</span></span> instr <span class=main>=</span>
  Push <span class=quoted>int</span> <span class=main>|</span> ADD <span class=main>|</span> THROW <span class=main>|</span> Mark <span class=quoted>nat</span> <span class=main>|</span> Unmark <span class=main>|</span> Label <span class=quoted>nat</span> <span class=main>|</span> Jump <span class=quoted>nat</span>

<span class=keyword1><span class=command>datatype</span></span> item <span class=main>=</span> VAL <span class=quoted>int</span> <span class=main>|</span> HAN <span class=quoted>nat</span>

<span class=keyword1><span class=command>type_synonym</span></span> code <span class=main>=</span> <span class=quoted><span class=quoted>"instr list"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> stack <span class=main>=</span> <span class=quoted><span class=quoted>"item list"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>jump</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>jump</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>jump</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span>Label <span class=free><span class=bound><span class=entity>l'</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>l'</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=keyword1>else</span> <span class=free>jump</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>jump</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>c</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>jump</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>cs</span></span></span>"</span></span>

<span class=keyword1 id=Exceptions-size_jump1><span class=command>lemma</span></span> size_jump1<span class=main>:</span> <span class=quoted><span class=quoted>"size <span class=main>(</span>jump <span class=free>l</span> <span class=free>cs</span><span class=main>)</span> <span class=main>&lt;</span> Suc <span class=main>(</span>size <span class=free>cs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>cs</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper>a</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=Exceptions-size_jump2><span class=command>lemma</span></span> size_jump2<span class=main>:</span> <span class=quoted><span class=quoted>"size <span class=main>(</span>jump <span class=free>l</span> <span class=free>cs</span><span class=main>)</span> <span class=main>&lt;</span> size <span class=free>cs</span> <span class=main>∨</span> jump <span class=free>l</span> <span class=free>cs</span> <span class=main>=</span> <span class=free>cs</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>cs</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper>a</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>function</span></span> <span class=main>(</span>sequential<span class=main>)</span> <span class=entity>exec2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"bool <span class=main>⇒</span> code <span class=main>⇒</span> stack <span class=main>⇒</span> stack"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>[]</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>Push <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=free>exec2</span> True <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span>VAL <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>ADD<span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=main>(</span>VAL <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>#</span> VAL <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>exec2</span> True <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span>VAL<span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>+</span><span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>THROW<span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=free>exec2</span> False <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>Mark <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=free>exec2</span> True <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span>HAN <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>Unmark<span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>#</span> HAN <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>exec2</span> True <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>Label <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=free>exec2</span> True <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> True <span class=main>(</span>Jump <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=free>exec2</span> True <span class=main>(</span>jump <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>

<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> False <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> False <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span>VAL <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>exec2</span> False <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec2</span> False <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span>HAN <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>exec2</span> True <span class=main>(</span>jump <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>cs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>termination</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span>
  <span class=quoted><span class=quoted>"inv_image <span class=main>(</span>measure<span class=main>(</span><span class=main>%</span><span class=bound>cs</span><span class=main>.</span> size <span class=bound>cs</span><span class=main>)</span> <span class=keyword1>&lt;*lex*&gt;</span> measure<span class=main>(</span><span class=main>%</span><span class=bound>s</span><span class=main>.</span> size <span class=bound>s</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>%</span><span class=main>(</span><span class=bound>b</span><span class=main>,</span><span class=bound>cs</span><span class=main>,</span><span class=bound>s</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>cs</span><span class=main>,</span><span class=bound>s</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> size_jump1 size_jump2<span class=main>)</span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>exec</span> <span class=main>≡</span> exec2 True"</span></span>
<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>unwind</span> <span class=main>≡</span> exec2 False"</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The compiler›</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>compile</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> expr <span class=main>⇒</span> code <span class=main>*</span> nat"</span></span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span>Val <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[</span>Push <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span>Add <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span><span class=bound>m</span><span class=main>)</span> <span class=main>=</span> <span class=free>compile</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span><span class=bound>n</span><span class=main>)</span> <span class=main>=</span> <span class=free>compile</span> <span class=bound>m</span> <span class=free><span class=bound><span class=entity>y</span></span></span>
                       <span class=keyword1>in</span> <span class=main>(</span><span class=bound>xs</span> <span class=main>@</span> <span class=bound>ys</span> <span class=main>@</span> <span class=main>[</span>ADD<span class=main>]</span><span class=main>,</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=free><span class=bound><span class=entity>l</span></span></span> Throw <span class=main>=</span> <span class=main>(</span><span class=main>[</span>THROW<span class=main>]</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span>Catch <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>h</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span><span class=bound>m</span><span class=main>)</span> <span class=main>=</span> <span class=free>compile</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>+</span><span class=numeral>2</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>hs</span><span class=main>,</span><span class=bound>n</span><span class=main>)</span> <span class=main>=</span> <span class=free>compile</span> <span class=bound>m</span> <span class=free><span class=bound><span class=entity>h</span></span></span>
     <span class=keyword1>in</span> <span class=main>(</span>Mark <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=bound>xs</span> <span class=main>@</span> <span class=main>[</span>Unmark<span class=main>,</span> Jump <span class=main>(</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span><span class=main>,</span> Label <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span> <span class=main>@</span> <span class=bound>hs</span> <span class=main>@</span> <span class=main>[</span>Label<span class=main>(</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span><span class=main>]</span><span class=main>,</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>cmp</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> expr <span class=main>⇒</span> code"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>cmp</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>==</span> fst<span class=main>(</span>compile <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>isFresh</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> stack <span class=main>⇒</span> bool"</span></span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>isFresh</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>[]</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>isFresh</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>it</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>it</span></span></span> <span class=keyword1>of</span> VAL <span class=bound>i</span> <span class=main>⇒</span> <span class=free>isFresh</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>
                       <span class=main>|</span> HAN <span class=bound>l'</span> <span class=main>⇒</span> <span class=bound>l'</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>∧</span> <span class=free>isFresh</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>conv</span> <span class=main>::</span> <span class=quoted><span class=quoted>"code <span class=main>⇒</span> stack <span class=main>⇒</span> int option <span class=main>⇒</span> stack"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>conv</span> <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>io</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>io</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> unwind <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>
                  <span class=main>|</span> Some <span class=bound>i</span> <span class=main>⇒</span> exec <span class=free><span class=bound><span class=entity>cs</span></span></span> <span class=main>(</span>VAL <span class=bound>i</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The proofs›</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Lemma numbers are the same as in the paper.›</span></span>

<span class=keyword1><span class=command>declare</span></span>
  conv_def<span class=main>[</span><span class=operator>simp</span><span class=main>]</span> option.splits<span class=main>[</span><span class=operator>split</span><span class=main>]</span> Let_def<span class=main>[</span><span class=operator>simp</span><span class=main>]</span>

<span class=keyword1 id=Exceptions-3><span class=command>lemma</span></span> 3<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>l</span><span class=main>.</span> <span class=free>c</span> <span class=main>=</span> Label <span class=bound>l</span> <span class=main>⟹</span> isFresh <span class=bound>l</span> <span class=free>s</span><span class=main>)</span> <span class=main>⟹</span> unwind <span class=main>(</span><span class=free>c</span><span class=main>#</span><span class=free>cs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span> unwind <span class=free>cs</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper>a</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=free>c</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>corollary</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>!!</span><span class=bound>l</span><span class=main>.</span> <span class=free>c</span> <span class=main>≠</span> Label <span class=bound>l</span><span class=main>)</span> <span class=main>⟹</span> unwind <span class=main>(</span><span class=free>c</span><span class=main>#</span><span class=free>cs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span> unwind <span class=free>cs</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> 3<span class=main>)</span>

<span class=keyword1><span class=command>corollary</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"isFresh <span class=free>l</span> <span class=free>s</span> <span class=main>⟹</span> unwind <span class=main>(</span>Label <span class=free>l</span><span class=main>#</span><span class=free>cs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span> unwind <span class=free>cs</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> 3<span class=main>)</span>


<span class=keyword1 id=Exceptions-5><span class=command>lemma</span></span> 5<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> isFresh <span class=free>l</span> <span class=free>s</span><span class=main>;</span> <span class=free>l</span> <span class=main>≤</span> <span class=free>m</span> <span class=main>⟧</span> <span class=main>⟹</span> isFresh <span class=free>m</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>item.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>corollary</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"isFresh <span class=free>l</span> <span class=free>s</span> <span class=main>⟹</span> isFresh <span class=main>(</span>Suc <span class=free>l</span><span class=main>)</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>5<span class=main>)</span>


<span class=keyword1 id=Exceptions-6><span class=command>lemma</span></span> 6<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>l</span><span class=main>.</span> <span class=bound>l</span> <span class=main>≤</span> snd<span class=main>(</span>compile <span class=bound>l</span> <span class=free>e</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>e</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Val <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Add <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>l</span> <span class=main>≤</span> snd <span class=main>(</span>compile <span class=skolem>l</span> <span class=skolem>x</span><span class=main>)</span>›</span></span>
   <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹snd <span class=main>(</span>compile <span class=skolem>l</span> <span class=skolem>x</span><span class=main>)</span> <span class=main>≤</span> snd <span class=main>(</span>compile <span class=main>(</span>snd <span class=main>(</span>compile <span class=skolem>l</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=skolem>y</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>split_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> Throw <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Catch <span class=skolem>x</span> <span class=skolem>h</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>l</span><span class=main>+</span><span class=numeral>2</span> <span class=main>≤</span> snd <span class=main>(</span>compile <span class=main>(</span><span class=skolem>l</span><span class=main>+</span><span class=numeral>2</span><span class=main>)</span> <span class=skolem>x</span><span class=main>)</span>›</span></span>
   <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹snd <span class=main>(</span>compile <span class=main>(</span><span class=skolem>l</span><span class=main>+</span><span class=numeral>2</span><span class=main>)</span> <span class=skolem>x</span><span class=main>)</span> <span class=main>≤</span> snd <span class=main>(</span>compile <span class=main>(</span>snd <span class=main>(</span>compile <span class=main>(</span><span class=skolem>l</span><span class=main>+</span><span class=numeral>2</span><span class=main>)</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=skolem>h</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>split_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>corollary</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>&lt;</span> <span class=free>m</span> <span class=main>⟹</span> <span class=free>l</span> <span class=main>&lt;</span> snd<span class=main>(</span>compile <span class=free>m</span> <span class=free>e</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> 6<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> l <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>m</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> e <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>e</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>corollary</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"isFresh <span class=free>l</span> <span class=free>s</span> <span class=main>⟹</span> isFresh <span class=main>(</span>snd<span class=main>(</span>compile <span class=free>l</span> <span class=free>e</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> 5 6 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Contrary to what the paper says, the proof of lemma 4 does not
just need lemma 3 but also the above corollary of 5 and 6. Hence the
strange order of the lemmas in our proof.›</span></span>

<span class=keyword1 id=Exceptions-4><span class=command>lemma</span></span> 4 <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>l</span> <span class=bound>cs</span><span class=main>.</span> isFresh <span class=bound>l</span> <span class=free>s</span> <span class=main>⟹</span> unwind <span class=main>(</span>cmp <span class=bound>l</span> <span class=free>e</span> <span class=main>@</span> <span class=bound>cs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span> unwind <span class=bound>cs</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>e</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>split_def<span class=main>)</span>


<span class=keyword1 id=Exceptions-7><span class=command>lemma</span></span> 7 <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>&lt;</span> <span class=free>m</span> <span class=main>⟹</span> jump <span class=free>l</span> <span class=main>(</span>cmp <span class=free>m</span> <span class=free>e</span> <span class=main>@</span> <span class=free>cs</span><span class=main>)</span> <span class=main>=</span> jump <span class=free>l</span> <span class=free>cs</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>e</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>cs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>split_def<span class=main>)</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The compiler correctness theorem:›</span></span>

<span class=keyword1><span class=command>theorem</span></span> comp_corr<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>l</span> <span class=bound>s</span> <span class=bound>cs</span><span class=main>.</span> isFresh <span class=bound>l</span> <span class=bound>s</span> <span class=main>⟹</span> exec <span class=main>(</span>cmp <span class=bound>l</span> <span class=free>e</span> <span class=main>@</span> <span class=bound>cs</span><span class=main>)</span> <span class=bound>s</span> <span class=main>=</span> conv <span class=bound>cs</span> <span class=bound>s</span> <span class=main>(</span>eval <span class=free>e</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>e</span></span><span class=main>)</span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>split_def<span class=main>)</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The specialized and more readable version (omitted in the paper):›</span></span>

<span class=keyword1><span class=command>corollary</span></span> <span class=quoted><span class=quoted>"exec <span class=main>(</span>cmp <span class=free>l</span> <span class=free>e</span><span class=main>)</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> eval <span class=free>e</span> <span class=keyword1>of</span> None <span class=main>⇒</span> <span class=main>[]</span> <span class=main>|</span> Some <span class=bound>n</span> <span class=main>⇒</span> <span class=main>[</span>VAL <span class=bound>n</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> comp_corr<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> cs <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div></main></div></div></body></html>
<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Session MFODL_Monitor_Optimized - Archive of Formal Proofs</title><meta property="og:title" content="Session MFODL_Monitor_Optimized"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="/entries/mfodl_monitor_optimized/theories/"><meta property="og:image" content="/images/afp.png"><meta property="article:section" content="theories"><meta property="og:site_name" content="Archive of Formal Proofs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/afp.png"><meta name=twitter:title content="Session MFODL_Monitor_Optimized"><meta name=twitter:description content><link rel=stylesheet type=text/css href=/css/front.min.css><link rel=stylesheet type=text/css href=/css/isabelle.css><link rel=icon href=/images/favicon.ico type=image/icon><script src=/js/flexsearch.min.js></script><script src=/js/header-search.js></script></head><body class=mathjax_ignore><aside><div><div><a href=/><img src=/images/afp.png alt="Logo of the Archive of Formal Proofs" class=logo></a><ul><a href=/entries/mfodl_monitor_optimized><li>Return to entry</li></a></ul><hr><ul><a href=#Code_Double><li>Code_Double</li></a><a href=#Event_Data><li>Event_Data</li></a><a href=#Regex><li>Regex</li></a><a href=#Formula><li>Formula</li></a><a href=#Optimized_Join><li>Optimized_Join</li></a><a href=#Monitor><li>Monitor</li></a><a href=#Optimized_MTL><li>Optimized_MTL</li></a><a href=#Monitor_Impl><li>Monitor_Impl</li></a><a href=#Monitor_Code><li>Monitor_Code</li></a></ul></div><ul><a href=https://www.isa-afp.org/browser_info/current/AFP/MFODL_Monitor_Optimized/outline.pdf><li>Proof
outline</li></a><a href=https://www.isa-afp.org/browser_info/current/AFP/MFODL_Monitor_Optimized/document.pdf><li>Proof
document</li></a><a href=https://www.isa-afp.org/browser_info/current/AFP/MFODL_Monitor_Optimized/session_graph.pdf><li>Theory dependencies</li></a></ul></div></aside><div class="content theories"><header><form action=/%20search><div class=form-container><input id=searchInput type=search size=31 maxlength=255><button id=searchButton type=button><img src=/images/search.svg alt=Search></button><div id=searchInputautocomplete-list style=display:none><div></div></div></div></form><h1><span class=first>S</span>ession <span class=first>M</span><span class=first>F</span><span class=first>O</span><span class=first>D</span><span class=first>L</span>_<span class=first>M</span>onitor_<span class=first>O</span>ptimized</h1><div></div></header><div><main><div id=Code_Double><div class=head><h1>Theory Code_Double</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Code_Double
  <span class=keyword2><span class=keyword>imports</span></span> <a href=../IEEE_Floating_Point/IEEE_Properties.html>IEEE_Floating_Point.IEEE_Properties</a>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Code_Target_Int.html>HOL-Library.Code_Target_Int</a>"</span>
    <a href=../Containers/Collection_Eq.html>Containers.Collection_Eq</a>
    <a href=../Containers/Collection_Order.html>Containers.Collection_Order</a>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Code adaptation for IEEE double-precision floats›</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹copysign›</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> copysign <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main>(</span><span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=bound>e</span><span class=main>::</span><span class=tfree>'e</span> word<span class=main>,</span> <span class=bound>f</span><span class=main>::</span><span class=tfree>'f</span> word<span class=main>)</span> <span class=main>(</span><span class=bound>s</span><span class=main>::</span><span class=main>1</span> word<span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>e</span><span class=main>,</span> <span class=bound>f</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_copysign<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=main>(</span>copysign <span class=free>x</span> <span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> is_nan <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_nan_def <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Additional lemmas about generic floats›</span></span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_some_nan<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=main>(</span>some_nan <span class=main>::</span> <span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> some_nan_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> someI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Abs_float <span class=main>(</span><span class=main>0</span><span class=main>,</span> max_word <span class=main>::</span> <span class=tfree>'e</span> word<span class=main>,</span> <span class=main>1</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_nan_def exponent_def fraction_def emax_def Abs_float_inverse<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> not_is_nan_0<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_nan <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_nan_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> zero_simps<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> not_is_nan_1<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_nan <span class=main>1</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_nan_def <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_plus<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> is_nan <span class=main>(</span><span class=free>x</span> <span class=main>+</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> plus_float_def fadd_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_minus<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> is_nan <span class=main>(</span><span class=free>x</span> <span class=main>-</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> minus_float_def fsub_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_times<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> is_nan <span class=main>(</span><span class=free>x</span> <span class=main>*</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> times_float_def fmul_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_divide<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> is_nan <span class=main>(</span><span class=free>x</span> <span class=main>/</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> divide_float_def fdiv_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_float_sqrt<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>⟹</span> is_nan <span class=main>(</span>float_sqrt <span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> float_sqrt_def fsqrt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> nan_fcompare<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> fcompare <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> Und"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fcompare_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> nan_not_le<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> <span class=main>¬</span> <span class=free>x</span> <span class=main>≤</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> less_eq_float_def fle_def fcompare_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> nan_not_less<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> <span class=main>¬</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> less_float_def flt_def fcompare_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> nan_not_zero<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>⟹</span> <span class=main>¬</span> is_zero <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_nan_def is_zero_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> nan_not_infinity<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>⟹</span> <span class=main>¬</span> is_infinity <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_nan_def is_infinity_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> zero_not_infinity<span class=main>:</span> <span class=quoted><span class=quoted>"is_zero <span class=free>x</span> <span class=main>⟹</span> <span class=main>¬</span> is_infinity <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_zero_def is_infinity_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> zero_not_nan<span class=main>:</span> <span class=quoted><span class=quoted>"is_zero <span class=free>x</span> <span class=main>⟹</span> <span class=main>¬</span> is_nan <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_zero_def is_nan_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>lemma</span></span> minus_one_power_one_word<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>-</span><span class=main>1</span> <span class=main>::</span> real<span class=main>)</span> <span class=main>^</span> unat <span class=main>(</span><span class=free>x</span> <span class=main>::</span> <span class=main>1</span> word<span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> unat <span class=free>x</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>1</span> <span class=keyword1>else</span> <span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"unat <span class=free>x</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∨</span> unat <span class=free>x</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> le_SucE<span class=main>[</span><span class=operator>OF</span> unat_one_word_le<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valofn</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span> <span class=main>⇒</span> real"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valofn</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=numeral>2</span><span class=main>^</span>exponent <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span><span class=main>)</span> <span class=main>*</span>
      <span class=main>(</span><span class=main>1</span> <span class=main>+</span> real <span class=main>(</span>fraction <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span><span class=keyword1>LENGTH</span><span class=main>(</span><span class=tfree>'f</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valofd</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span> <span class=main>⇒</span> real"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valofd</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span><span class=main>)</span> <span class=main>*</span> <span class=main>(</span>real <span class=main>(</span>fraction <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span><span class=keyword1>LENGTH</span><span class=main>(</span><span class=tfree>'f</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valof_alt<span class=main>:</span> <span class=quoted><span class=quoted>"valof <span class=free>x</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> exponent <span class=free>x</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span>
    <span class=keyword1>if</span> sign <span class=free>x</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> valofd <span class=free>x</span> <span class=keyword1>else</span> <span class=main>-</span> valofd <span class=free>x</span>
  <span class=keyword1>else</span> <span class=keyword1>if</span> sign <span class=free>x</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> valofn <span class=free>x</span> <span class=keyword1>else</span> <span class=main>-</span> valofn <span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valofn_def valofd_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> minus_one_power_one_word unat_eq_0 <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fraction_less_2p<span class=main>:</span> <span class=quoted><span class=quoted>"fraction <span class=main>(</span><span class=free>x</span> <span class=main>::</span> <span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span> <span class=main>&lt;</span> <span class=numeral>2</span><span class=main>^</span><span class=keyword1>LENGTH</span><span class=main>(</span><span class=tfree>'f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> valofn_ge_0<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>≤</span> valofn <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valofn_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> valofn_ge_2p<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=numeral>2</span><span class=main>^</span>exponent <span class=main>(</span><span class=free>x</span> <span class=main>::</span> <span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span> <span class=main>≤</span> valofn <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valofn_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> valofn_less_2p<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"exponent <span class=free>x</span> <span class=main>&lt;</span> <span class=free>e</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>x</span> <span class=main>&lt;</span> <span class=numeral>2</span><span class=main>^</span><span class=free>e</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>1</span> <span class=main>+</span> real <span class=main>(</span>fraction <span class=free>x</span><span class=main>)</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span><span class=keyword1>LENGTH</span><span class=main>(</span><span class=tfree>'f</span><span class=main>)</span> <span class=main>&lt;</span> <span class=numeral>2</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fraction_less_2p<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>x</span> <span class=main>&lt;</span> <span class=main>(</span><span class=numeral>2</span><span class=main>^</span>exponent <span class=free>x</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span><span class=main>)</span> <span class=main>*</span> <span class=numeral>2</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> valofn_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> <span class=numeral>2</span><span class=main>^</span><span class=free>e</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_eq_Suc_le <span class=dynamic><span class=dynamic>field_simps</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> exp_less<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valofd_ge_0<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>≤</span> valofd <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valofd_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> valofd_less_2p<span class=main>:</span> <span class=quoted><span class=quoted>"valofd <span class=main>(</span><span class=free>x</span> <span class=main>::</span> <span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span> <span class=main>&lt;</span> <span class=numeral>2</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valofd_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fraction_less_2p <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> valofn_le_imp_exponent_le<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>y</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>x</span> <span class=main>≤</span> valofn <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"exponent <span class=free>x</span> <span class=main>≤</span> exponent <span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> ccontr<span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> exponent <span class=free>x</span> <span class=main>≤</span> exponent <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>y</span> <span class=main>&lt;</span> <span class=numeral>2</span><span class=main>^</span>exponent <span class=free>x</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valofn_less_2p<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>y</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> valofn <span class=free>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> valofn_ge_2p<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted>False</span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valofn_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>y</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>x</span> <span class=main>=</span> valofn <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"exponent <span class=free>x</span> <span class=main>=</span> exponent <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"fraction <span class=free>x</span> <span class=main>=</span> fraction <span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"exponent <span class=free>x</span> <span class=main>=</span> exponent <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> antisym valofn_le_imp_exponent_le<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"fraction <span class=free>x</span> <span class=main>=</span> fraction <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> valofn_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valofd_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>y</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valofd <span class=free>x</span> <span class=main>=</span> valofd <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fraction <span class=free>x</span> <span class=main>=</span> fraction <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> valofd_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> is_zero_valof_conv<span class=main>:</span> <span class=quoted><span class=quoted>"is_zero <span class=free>x</span> <span class=main>⟷</span> valof <span class=free>x</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_zero_def valof_alt
  <span class=keyword1><span class=command>using</span></span> valofn_ge_2p<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valofd_def <span class=dynamic><span class=dynamic>field_simps</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> order.antisym<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> valofd_neq_valofn<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>y</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"exponent <span class=free>y</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valofd <span class=free>x</span> <span class=main>≠</span> valofn <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>y</span> <span class=main>≠</span> valofd <span class=free>x</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valofd <span class=free>x</span> <span class=main>&lt;</span> <span class=numeral>2</span> <span class=main>/</span> <span class=numeral>2</span><span class=main>^</span>bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> valofd_less_2p<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> IEEE.exponent <span class=free>y</span> <span class=main>/</span> <span class=numeral>2</span> <span class=main>^</span> bias <span class=keyword1>TYPE</span><span class=main>(</span><span class=main>(</span><span class=tfree>'e</span><span class=main>,</span> <span class=tfree>'f</span><span class=main>)</span> IEEE.float<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> self_le_power <span class=dynamic><span class=dynamic>field_simps</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> valofn <span class=free>y</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> valofn_ge_2p<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"valofd <span class=free>x</span> <span class=main>≠</span> valofn <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"valofn <span class=free>y</span> <span class=main>≠</span> valofd <span class=free>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> sign_gt_0_conv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>&lt;</span> sign <span class=free>x</span> <span class=main>⟷</span> sign <span class=free>x</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>x</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> sign_cases<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> valof_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_zero <span class=free>x</span> <span class=main>∨</span> <span class=main>¬</span> is_zero <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valof <span class=free>x</span> <span class=main>=</span> valof <span class=free>y</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"valof <span class=free>x</span> <span class=main>=</span> valof <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valof <span class=free>y</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_zero_valof_conv<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> valof_alt
    <span class=keyword1><span class=command>using</span></span> valofd_ge_0<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> valofd_ge_0<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>y</span></span><span class=main>]</span> valofn_ge_0<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> valofn_ge_0<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>y</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valofd_neq_valofn sign_gt_0_conv <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> float_eqI <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> valofn_eq valofd_eq<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> zero_fcompare<span class=main>:</span> <span class=quoted><span class=quoted>"is_zero <span class=free>x</span> <span class=main>⟹</span> is_zero <span class=free>y</span> <span class=main>⟹</span> fcompare <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Eq"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fcompare_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> zero_not_infinity zero_not_nan is_zero_valof_conv<span class=main>)</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Doubles with a unified NaN value›</span></span>

<span class=keyword1><span class=command>quotient_type</span></span> double <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=numeral>11</span><span class=main>,</span> <span class=numeral>52</span><span class=main>)</span> <span class=keyword1>float</span>"</span></span> <span class=main>/</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> is_nan <span class=bound>x</span> <span class=main>∧</span> is_nan <span class=bound>y</span> <span class=main>∨</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> equivpI reflpI sympI transpI<span class=main>)</span>

<span class=keyword1><span class=command>instantiation</span></span> double <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>{</span>zero<span class=main>,</span> one<span class=main>,</span> plus<span class=main>,</span> minus<span class=main>,</span> uminus<span class=main>,</span> times<span class=main>,</span> ord<span class=main>}</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>zero_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>one_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>1</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>plus_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>plus</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> is_nan_plus<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>minus_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>minus</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> is_nan_minus<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>uminus_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>uminus</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>times_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>times</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> is_nan_times<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>less_eq_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>(≤)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_not_le<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>less_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>(&lt;)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_not_less<span class=main>)</span>

<span class=keyword1><span class=command>instance</span></span> <span class=keyword1><span class=command>..</span></span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>instantiation</span></span> double <span class=main>::</span> <span class=quoted>inverse</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> <span class=class_parameter>divide_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>divide</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> is_nan_divide<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity><span class=class_parameter>inverse_double</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>inverse_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=main>1</span> <span class=keyword1>div</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>

<span class=keyword1><span class=command>instance</span></span> <span class=keyword1><span class=command>..</span></span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> sqrt_double <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>float_sqrt</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> is_nan_float_sqrt<span class=main>)</span>

<span class=keyword1><span class=command>no_notation</span></span> plus_infinity <span class=main>(</span><span class=quoted>"<span class=keyword1>∞</span>"</span><span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> infinity <span class=main>::</span> <span class=quoted><span class=quoted>"double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>plus_infinity</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> nan <span class=main>::</span> <span class=quoted><span class=quoted>"double"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>some_nan</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> is_zero <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>IEEE.is_zero</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_not_zero<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> is_infinite <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>IEEE.is_infinity</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_not_infinity<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> is_nan <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>IEEE.is_nan</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> is_nan_conv<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>=</span> nan"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lift_definition</span></span> copysign_double <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> IEEE.is_nan <span class=bound>y</span> <span class=keyword1>then</span> some_nan <span class=keyword1>else</span> copysign <span class=bound>x</span> <span class=bound>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹Note: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>const</span></span> copysign_double<span class=antiquote><span class=antiquote>}</span></span></span></span> deviates from the IEEE standard in cases where
  the second argument is a NaN.›</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> fcompare_double <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> ccode"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>fcompare</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_fcompare<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> nan_fcompare_double<span class=main>:</span> <span class=quoted><span class=quoted>"is_nan <span class=free>x</span> <span class=main>∨</span> is_nan <span class=free>y</span> <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> Und"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>rule</span> nan_fcompare<span class=main>)</span>

<span class=keyword1><span class=command>consts</span></span> compare_double <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> integer"</span></span>

<span class=keyword1><span class=command>specification</span></span> <span class=main>(</span><span class=quoted>compare_double</span><span class=main>)</span>
  compare_double_less<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>&lt;</span> <span class=main>0</span> <span class=main>⟷</span> is_nan <span class=free>x</span> <span class=main>∧</span> <span class=main>¬</span> is_nan <span class=free>y</span> <span class=main>∨</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Lt"</span></span>
  compare_double_eq<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟷</span> is_nan <span class=free>x</span> <span class=main>∧</span> is_nan <span class=free>y</span> <span class=main>∨</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Eq"</span></span>
  compare_double_greater<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>&gt;</span> <span class=main>0</span> <span class=main>⟷</span> <span class=main>¬</span> is_nan <span class=free>x</span> <span class=main>∧</span> is_nan <span class=free>y</span> <span class=main>∨</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Gt"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> is_nan <span class=bound>x</span> <span class=keyword1>then</span> <span class=keyword1>if</span> is_nan <span class=bound>y</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> <span class=main>-</span><span class=main>1</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> is_nan <span class=bound>y</span> <span class=keyword1>then</span> <span class=main>1</span> <span class=keyword1>else</span> <span class=main>(</span><span class=keyword1>case</span> fcompare_double <span class=bound>x</span> <span class=bound>y</span> <span class=keyword1>of</span> ccode.Eq <span class=main>⇒</span> <span class=main>0</span> <span class=main>|</span> ccode.Lt <span class=main>⇒</span> <span class=main>-</span><span class=main>1</span> <span class=main>|</span> ccode.Gt <span class=main>⇒</span> <span class=main>1</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
        <span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> compare_double_simps <span class=main>=</span> compare_double_less compare_double_eq compare_double_greater

<span class=keyword1><span class=command>lemma</span></span> compare_double_le_0<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>≤</span> <span class=main>0</span> <span class=main>⟷</span>
  is_nan <span class=free>x</span> <span class=main>∨</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>∈</span> <span class=main>{</span>ccode.Eq<span class=main>,</span> ccode.Lt<span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> linorder_cases<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_simps nan_fcompare_double<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> double_of_integer <span class=main>::</span> <span class=quoted><span class=quoted>"integer <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> zerosign <span class=main>0</span> <span class=main>(</span>intround To_nearest <span class=main>(</span>int_of_integer <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>double_of_int</span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>double_of_int</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> double_of_integer <span class=main>(</span>integer_of_int <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"double_of_int <span class=main>(</span>int_of_integer <span class=free>x</span><span class=main>)</span> <span class=main>=</span> double_of_integer <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> double_of_int_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lift_definition</span></span> integer_of_double <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> integer"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>if</span> IEEE.is_nan <span class=bound>x</span> <span class=main>∨</span> IEEE.is_infinity <span class=bound>x</span> <span class=keyword1>then</span> undefined
     <span class=keyword1>else</span> integer_of_int <span class=main>⌊</span>valof <span class=main>(</span>intround float_To_zero <span class=main>(</span>valof <span class=bound>x</span><span class=main>)</span> <span class=main>::</span> <span class=main>(</span><span class=numeral>11</span><span class=main>,</span> <span class=numeral>52</span><span class=main>)</span> <span class=keyword1>float</span><span class=main>)</span><span class=main>⌋</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span> int_of_double<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>int_of_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> int_of_integer <span class=main>(</span>integer_of_double <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Linear ordering›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>lcompare_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> integer"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lcompare_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> is_zero <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∧</span> is_zero <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=keyword1>then</span>
      compare_double <span class=main>(</span>copysign_double <span class=main>1</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>copysign_double <span class=main>1</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> compare_double <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_swap<span class=main>:</span> <span class=quoted><span class=quoted>"fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Gt <span class=main>⟷</span> fcompare_double <span class=free>y</span> <span class=free>x</span> <span class=main>=</span> ccode.Lt"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_refl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_nan <span class=free>x</span> <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>x</span> <span class=main>=</span> ccode.Eq"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_Eq1<span class=main>:</span> <span class=quoted><span class=quoted>"fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Eq <span class=main>⟹</span> fcompare_double <span class=free>y</span> <span class=free>z</span> <span class=main>=</span> <span class=free>c</span> <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>z</span> <span class=main>=</span> <span class=free>c</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_Eq2<span class=main>:</span> <span class=quoted><span class=quoted>"fcompare_double <span class=free>y</span> <span class=free>z</span> <span class=main>=</span> ccode.Eq <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> <span class=free>c</span> <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>z</span> <span class=main>=</span> <span class=free>c</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_Lt_trans<span class=main>:</span> <span class=quoted><span class=quoted>"fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Lt <span class=main>⟹</span> fcompare_double <span class=free>y</span> <span class=free>z</span> <span class=main>=</span> ccode.Lt <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>z</span> <span class=main>=</span> ccode.Lt"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_zero <span class=free>x</span> <span class=main>∨</span> <span class=main>¬</span> is_zero <span class=free>y</span> <span class=main>⟹</span> fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Eq <span class=main>⟹</span> <span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def valof_eq IEEE.is_infinity_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> float_eqI<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fcompare_double_Lt_asym<span class=main>:</span> <span class=quoted><span class=quoted>"fcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> ccode.Lt <span class=main>⟹</span> fcompare_double <span class=free>y</span> <span class=free>x</span> <span class=main>=</span> ccode.Lt <span class=main>⟹</span> False"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fcompare_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> compare_double_swap<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>&lt;</span> compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>⟷</span> compare_double <span class=free>y</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_simps fcompare_double_swap<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> compare_double_refl<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>x</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_eq <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> fcompare_double_refl<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> compare_double_trans<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>≤</span> <span class=main>0</span> <span class=main>⟹</span> compare_double <span class=free>y</span> <span class=free>z</span> <span class=main>≤</span> <span class=main>0</span> <span class=main>⟹</span> compare_double <span class=free>x</span> <span class=free>z</span> <span class=main>≤</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_le_0 nan_fcompare_double
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> fcompare_double_Eq1 fcompare_double_Eq2 fcompare_double_Lt_trans<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> compare_double_antisym<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>≤</span> <span class=main>0</span> <span class=main>⟹</span> compare_double <span class=free>y</span> <span class=free>x</span> <span class=main>≤</span> <span class=main>0</span> <span class=main>⟹</span>
  <span class=main>¬</span> is_zero <span class=free>x</span> <span class=main>∨</span> <span class=main>¬</span> is_zero <span class=free>y</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> compare_double_le_0
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_fcompare_double is_nan_conv
      <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> fcompare_double_eq fcompare_double_eq<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> fcompare_double_Lt_asym<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> zero_compare_double_copysign<span class=main>:</span> <span class=quoted><span class=quoted>"compare_double <span class=main>(</span>copysign_double <span class=main>1</span> <span class=free>x</span><span class=main>)</span> <span class=main>(</span>copysign_double <span class=main>1</span> <span class=free>y</span><span class=main>)</span> <span class=main>≤</span> <span class=main>0</span> <span class=main>⟹</span>
  is_zero <span class=free>x</span> <span class=main>⟹</span> is_zero <span class=free>y</span> <span class=main>⟹</span> compare_double <span class=free>x</span> <span class=free>y</span> <span class=main>≤</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> compare_double_le_0
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nan_not_zero zero_fcompare <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> is_zero_double_cases<span class=main>:</span> <span class=quoted><span class=quoted>"is_zero <span class=free>x</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>x</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>x</span> <span class=main>=</span> <span class=main>-</span><span class=main>0</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> is_zero_cases<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> copysign_1_0<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"copysign_double <span class=main>1</span> <span class=main>0</span> <span class=main>=</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"copysign_double <span class=main>1</span> <span class=main>(</span><span class=main>-</span><span class=main>0</span><span class=main>)</span> <span class=main>=</span> <span class=main>-</span><span class=main>1</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> is_zero_uminus_double<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"is_zero <span class=main>(</span><span class=main>-</span> <span class=free>x</span><span class=main>)</span> <span class=main>⟷</span> is_zero <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> not_is_zero_one_double<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_zero <span class=main>1</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>unfold</span> IEEE.is_zero_def<span class=main><span class=keyword3>,</span></span> <span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> uminus_one_neq_one_double<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>-</span> <span class=main>1</span> <span class=main>≠</span> <span class=main>(</span><span class=main>1</span> <span class=main>::</span> double<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>lle_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lle_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> lcompare_double <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>≤</span> <span class=main>0</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>lless_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lless_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> lcompare_double <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>&lt;</span> <span class=main>0</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> lcompare_double_ge_0<span class=main>:</span> <span class=quoted><span class=quoted>"lcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>≥</span> <span class=main>0</span> <span class=main>⟷</span> lle_double <span class=free>y</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> lle_double_def lcompare_double_def
  <span class=keyword1><span class=command>using</span></span> compare_double_swap not_less <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> lcompare_double_gt_0<span class=main>:</span> <span class=quoted><span class=quoted>"lcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>&gt;</span> <span class=main>0</span> <span class=main>⟷</span> lless_double <span class=free>y</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> lless_double_def lcompare_double_def
  <span class=keyword1><span class=command>using</span></span> compare_double_swap <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> lcompare_double_eq_0<span class=main>:</span> <span class=quoted><span class=quoted>"lcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"lcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"is_zero <span class=free>x</span> <span class=main>∧</span> is_zero <span class=free>y</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lcompare_double_def compare_double_simps is_nan_conv
          <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> is_zero_double_cases <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> fcompare_double_eq<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lcompare_double_def linorder_not_less<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> compare_double_swap
          <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> compare_double_antisym<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"lcompare_double <span class=free>x</span> <span class=free>y</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lcompare_double_def compare_double_refl<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> lcompare_double_0_folds <span class=main>=</span> lle_double_def<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> lless_double_def<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
  lcompare_double_ge_0 lcompare_double_gt_0 lcompare_double_eq_0

<span class=keyword1><span class=command>interpretation</span></span> double_linorder<span class=main>:</span> linorder <span class=quoted>lle_double</span> <span class=quoted>lless_double</span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span> <span class=skolem>z</span> <span class=main>::</span> <span class=quoted>double</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"lless_double <span class=skolem>x</span> <span class=skolem>y</span> <span class=main>⟷</span> lle_double <span class=skolem>x</span> <span class=skolem>y</span> <span class=main>∧</span> <span class=main>¬</span> lle_double <span class=skolem>y</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lless_double_def lle_double_def lcompare_double_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_swap not_le<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>x</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lle_double_def lcompare_double_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_refl<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>x</span> <span class=skolem>z</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>x</span> <span class=skolem>y</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>y</span> <span class=skolem>z</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> that
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lle_double_def lcompare_double_def not_le compare_double_swap
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> compare_double_trans zero_compare_double_copysign
        zero_compare_double_copysign<span class=main><span class=main>[</span></span><span class=operator>OF</span> less_imp_le<span class=main><span class=main>]</span></span> compare_double_antisym<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>x</span> <span class=skolem>y</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>y</span> <span class=skolem>x</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"is_zero <span class=skolem>x</span> <span class=main>∧</span> is_zero <span class=skolem>y</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> that <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lle_double_def lcompare_double_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> is_zero_double_cases
          <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> compare_double_antisym<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> that <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lle_double_def lcompare_double_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> compare_double_antisym<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"lle_double <span class=skolem>x</span> <span class=skolem>y</span> <span class=main>∨</span> lle_double <span class=skolem>y</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lle_double_def lcompare_double_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compare_double_swap not_le<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>instantiation</span></span> double <span class=main>::</span> <span class=quoted>equal</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity><span class=class_parameter>equal_double</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>equal_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> lcompare_double <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>0</span>"</span></span>

<span class=keyword1><span class=command>instance</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>intro_classes</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> equal_double_def lcompare_double_eq_0<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>eq<span class=main>)</span> ceq <span class=quoted>double</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>comparator_double</span> <span class=main>::</span> <span class=quoted><span class=quoted>"double comparator"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>comparator_double</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>c</span> <span class=main>=</span> lcompare_double <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=keyword1>in</span>
    <span class=keyword1>if</span> <span class=bound>c</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> order.Eq <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>c</span> <span class=main>&lt;</span> <span class=main>0</span> <span class=keyword1>then</span> order.Lt <span class=keyword1>else</span> order.Gt<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> comparator_double<span class=main>:</span> <span class=quoted><span class=quoted>"comparator comparator_double"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> comparator_double_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lcompare_double_0_folds <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> comparator.intro<span class=main>)</span>

<span class=keyword1><span class=command>local_setup</span></span> <span class=quoted>‹
  <span class=entity>Comparator_Generator.register_foreign_comparator</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>double</span><span class=antiquote>}</span></span>
    <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>comparator_double</span><span class=antiquote>}</span></span>
    <span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> comparator_double<span class=antiquote>}</span></span></span>
›</span>

<span class=keyword1><span class=command>derive</span></span> ccompare <span class=quoted>double</span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Code setup›</span></span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span>
      <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>::</span> double"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>1</span> <span class=main>::</span> double"</span></span>
      <span class=quoted><span class=quoted>"plus <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted><span class=quoted>"minus <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted><span class=quoted>"uminus <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted><span class=quoted>"times <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted><span class=quoted>"less_eq <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted><span class=quoted>"less <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted><span class=quoted>"divide <span class=main>::</span> double <span class=main>⇒</span> <span class=main>_</span>"</span></span>
      <span class=quoted>sqrt_double</span> <span class=quoted>infinity</span> <span class=quoted>nan</span> <span class=quoted>is_zero</span> <span class=quoted>is_infinite</span> <span class=quoted>is_nan</span> <span class=quoted>copysign_double</span> <span class=quoted>fcompare_double</span>
      <span class=quoted>double_of_integer</span> <span class=quoted>integer_of_double</span>
      <span class=main>]</span><span class=main>]</span>

<span class=keyword1><span class=command>code_printing</span></span>
  <span class=keyword2><span class=keyword>code_module</span></span> FloatUtil <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span>
<span class=quoted>‹module FloatUtil : sig
  val iszero : float -&gt; bool
  val isinfinite : float -&gt; bool
  val isnan : float -&gt; bool
  val copysign : float -&gt; float -&gt; float
  val compare : float -&gt; float -&gt; Z.t
end = struct
  let iszero x = (Pervasives.classify_float x = Pervasives.FP_zero);;
  let isinfinite x = (Pervasives.classify_float x = Pervasives.FP_infinite);;
  let isnan x = (Pervasives.classify_float x = Pervasives.FP_nan);;
  let copysign x y = if isnan y then Pervasives.nan else Pervasives.copysign x y;;
  let compare x y = Z.of_int (Pervasives.compare x y);;
end;;›</span>

<span class=keyword1><span class=command>code_reserved</span></span> OCaml Pervasives FloatUtil

<span class=keyword1><span class=command>code_printing</span></span>
  <span class=keyword2><span class=keyword>type_constructor</span></span> double <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"float"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"uminus <span class=main>::</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.(~-.)"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>(+)</span> <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.(+.)"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>(*)</span> <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.( *. )"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>(/)</span> <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.('/.)"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>(-)</span> <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.(-.)"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>::</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"0.0"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>1</span> <span class=main>::</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"1.0"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>(≤)</span> <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.(&lt;=)"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"<span class=main>(&lt;)</span> <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> bool"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.(&lt;)"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"sqrt_double <span class=main>::</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.sqrt"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"infinity <span class=main>::</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.infinity"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"nan <span class=main>::</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Pervasives.nan"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"is_zero <span class=main>::</span> double <span class=main>⇒</span> bool"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"FloatUtil.iszero"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"is_infinite <span class=main>::</span> double <span class=main>⇒</span> bool"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"FloatUtil.isinfinite"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"is_nan <span class=main>::</span> double <span class=main>⇒</span> bool"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"FloatUtil.isnan"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"copysign_double <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"FloatUtil.copysign"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"compare_double <span class=main>::</span> double <span class=main>⇒</span> double <span class=main>⇒</span> integer"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"FloatUtil.compare"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"double_of_integer <span class=main>::</span> integer <span class=main>⇒</span> double"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Z.to'_float"</span>
  <span class=main>|</span> <span class=keyword2><span class=keyword>constant</span></span> <span class=quoted><span class=quoted>"integer_of_double <span class=main>::</span> double <span class=main>⇒</span> integer"</span></span> <span class=main>⇀</span> <span class=main>(</span>OCaml<span class=main>)</span> <span class=quoted>"Z.of'_float"</span>

<span class=keyword1><span class=command>hide_const</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>open</span></span><span class=main>)</span> fcompare_double

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>

</pre></div><div id=Event_Data><div class=head><h1>Theory Event_Data</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Event_Data
  <span class=keyword2><span class=keyword>imports</span></span>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Char_ord.html>HOL-Library.Char_ord</a>"</span>
    <a href=Code_Double.html>Code_Double</a>
    <a href=../Deriving/Derive.html>Deriving.Derive</a>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Event parameters›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>div_to_zero</span> <span class=main>::</span> <span class=quoted><span class=quoted>"integer <span class=main>⇒</span> integer <span class=main>⇒</span> integer"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>div_to_zero</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>z</span> <span class=main>=</span> fst <span class=main>(</span>Code_Numeral.divmod_abs <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=keyword1>in</span>
    <span class=keyword1>if</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=main>0</span><span class=main>)</span> <span class=main>≠</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>&lt;</span> <span class=main>0</span><span class=main>)</span> <span class=keyword1>then</span> <span class=main>-</span> <span class=bound>z</span> <span class=keyword1>else</span> <span class=bound>z</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>mod_to_zero</span> <span class=main>::</span> <span class=quoted><span class=quoted>"integer <span class=main>⇒</span> integer <span class=main>⇒</span> integer"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mod_to_zero</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>z</span> <span class=main>=</span> snd <span class=main>(</span>Code_Numeral.divmod_abs <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=keyword1>in</span>
    <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>-</span> <span class=bound>z</span> <span class=keyword1>else</span> <span class=bound>z</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>⟹</span> div_to_zero <span class=free>a</span> <span class=free>b</span> <span class=main>*</span> <span class=free>b</span> <span class=main>+</span> mod_to_zero <span class=free>a</span> <span class=free>b</span> <span class=main>=</span> <span class=free>a</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> div_to_zero_def mod_to_zero_def Let_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> minus_mod_eq_mult_div<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> div_minus_right mod_minus_right <span class=dynamic><span class=dynamic>ac_simps</span></span><span class=main>)</span>


<span class=keyword1><span class=command>datatype</span></span> event_data <span class=main>=</span> EInt <span class=quoted>integer</span> <span class=main>|</span> EFloat <span class=quoted>double</span> <span class=main>|</span> EString <span class=quoted>String.literal</span>

<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>eq<span class=main>)</span> ceq <span class=quoted>event_data</span>
<span class=keyword1><span class=command>derive</span></span> ccompare <span class=quoted>event_data</span>

<span class=keyword1><span class=command>instantiation</span></span> event_data <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>{</span>ord<span class=main>,</span> plus<span class=main>,</span> minus<span class=main>,</span> uminus<span class=main>,</span> times<span class=main>,</span> divide<span class=main>,</span> modulo<span class=main>}</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>less_eq_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> double_of_integer <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EInt <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>≤</span> EString <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>⟷</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> double_of_integer <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>≤</span> EString <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>⟷</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EString <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> EString <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> lexordp_eq <span class=main>(</span>String.explode <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>String.explode <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EString <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>≤</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>⟷</span> False"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity><span class=class_parameter>less_event_data</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data <span class=main>⇒</span> event_data <span class=main>⇒</span> bool"</span></span>  <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>less_event_data</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>∧</span> <span class=main>¬</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>plus_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EInt <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span>double_of_integer <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> double_of_integer <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>::</span>event_data<span class=main>)</span> <span class=main>+</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> EFloat nan"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>minus_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EInt <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span>double_of_integer <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> double_of_integer <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>::</span>event_data<span class=main>)</span> <span class=main>-</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> EFloat nan"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>uminus_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=main>-</span> EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> EInt <span class=main>(</span><span class=main>-</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>-</span> EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=main>-</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>-</span> <span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>::</span>event_data<span class=main>)</span> <span class=main>=</span> EFloat nan"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>times_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EInt <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span>double_of_integer <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> double_of_integer <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>::</span>event_data<span class=main>)</span> <span class=main>*</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> EFloat nan"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>divide_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EInt <span class=main>(</span>div_to_zero <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span>double_of_integer <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> double_of_integer <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"EFloat <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> EFloat <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>::</span>event_data<span class=main>)</span> <span class=keyword1>div</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> EFloat nan"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity><span class=class_parameter>modulo_event_data</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"EInt <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>mod</span> EInt <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> EInt <span class=main>(</span>mod_to_zero <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>::</span>event_data<span class=main>)</span> <span class=keyword1>mod</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> EFloat nan"</span></span>

<span class=keyword1><span class=command>instance</span></span> <span class=keyword1><span class=command>..</span></span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>integer_of_event_data</span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data <span class=main>⇒</span> integer"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>integer_of_event_data</span> <span class=main>(</span>EInt <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>integer_of_event_data</span> <span class=main>(</span>EFloat <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> integer_of_double <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>integer_of_event_data</span> <span class=main>(</span>EString <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>double_of_event_data</span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data <span class=main>⇒</span> double"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>double_of_event_data</span> <span class=main>(</span>EInt <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> double_of_integer <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>double_of_event_data</span> <span class=main>(</span>EFloat <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>double_of_event_data</span> <span class=main>(</span>EString <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> nan"</span></span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Regex><div class=head><h1>Theory Regex</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Regex
  <span class=keyword2><span class=keyword>imports</span></span>
    <span class=quoted>"<a href=../MFOTL_Monitor/Trace.html>MFOTL_Monitor.Trace</a>"</span>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Lattice_Syntax.html>HOL-Library.Lattice_Syntax</a>"</span>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Extended_Nat.html>HOL-Library.Extended_Nat</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Regular expressions›</span></span>

<span class=keyword1><span class=command>context</span></span> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>datatype</span></span> <span class=main>(</span>atms<span class=main>:</span> <span class=tfree>'a</span><span class=main>)</span> regex <span class=main>=</span> Skip <span class=quoted>nat</span> <span class=main>|</span> Test <span class=tfree><span class=quoted><span class=tfree>'a</span></span></span>
  <span class=main>|</span> Plus <span class=quoted><span class=quoted>"<span class=tfree>'a</span> regex"</span></span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> regex"</span></span> <span class=main>|</span> Times <span class=quoted><span class=quoted>"<span class=tfree>'a</span> regex"</span></span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> regex"</span></span>  <span class=main>|</span> Star <span class=quoted><span class=quoted>"<span class=tfree>'a</span> regex"</span></span>

<span class=keyword1><span class=command>lemma</span></span> finite_atms<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>atms <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>Wild</span> <span class=main>=</span> Skip <span class=main>1</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> size_regex_estimation<span class=main>[</span><span class=operator>termination_simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=free>x</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>&lt;</span> size_regex <span class=free>f</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> size_regex_estimation'<span class=main>[</span><span class=operator>termination_simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>≤</span> <span class=free>f</span> <span class=free>x</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>≤</span> size_regex <span class=free>f</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>TimesL</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>S</span></span></span> <span class=main>=</span> Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>S</span></span></span>"</span></span>
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>TimesR</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>r</span><span class=main>.</span> Times <span class=bound>r</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>R</span></span></span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>fv_regex</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fv_regex_cong<span class=main>[</span><span class=operator>fundef_cong</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>=</span> <span class=free>r'</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>fv</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>fv'</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>r</span> <span class=main>=</span> fv_regex <span class=free>fv'</span> <span class=free>r'</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r'</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> finite_fv_regex<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> finite <span class=main>(</span><span class=free>fv</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> finite <span class=main>(</span>fv_regex <span class=free>fv</span> <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> fv_regex_commute<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>fv</span> <span class=bound>z</span> <span class=main>⟷</span> <span class=free>g</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>fv'</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> fv_regex <span class=free>fv</span> <span class=free>r</span> <span class=main>⟷</span> <span class=free>g</span> <span class=free>x</span> <span class=main>∈</span> fv_regex <span class=free>fv'</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> fv_regex_alt<span class=main>:</span> <span class=quoted><span class=quoted>"fv_regex <span class=free>fv</span> <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span><span class=main>.</span> <span class=free>fv</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=entity>nfv_regex</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>nfv_regex</span> <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> Max <span class=main>(</span>insert <span class=main>0</span> <span class=main>(</span>Suc <span class=main>`</span> fv_regex <span class=free><span class=bound><span class=entity>fv</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> insert_Un<span class=main>:</span> <span class=quoted><span class=quoted>"insert <span class=free>x</span> <span class=main>(</span><span class=free>A</span> <span class=main>∪</span> <span class=free>B</span><span class=main>)</span> <span class=main>=</span> insert <span class=free>x</span> <span class=free>A</span> <span class=main>∪</span> insert <span class=free>x</span> <span class=free>B</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> nfv_regex_simps<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> finite <span class=main>(</span><span class=free>fv</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>s</span> <span class=main>⟹</span> finite <span class=main>(</span><span class=free>fv</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=free>fv</span> <span class=main>(</span>Skip <span class=free>n</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=free>fv</span> <span class=main>(</span>Test <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> Max <span class=main>(</span>insert <span class=main>0</span> <span class=main>(</span>Suc <span class=main>`</span> <span class=free>fv</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=free>fv</span> <span class=main>(</span>Plus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv_regex <span class=free>fv</span> <span class=free>r</span><span class=main>)</span> <span class=main>(</span>nfv_regex <span class=free>fv</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=free>fv</span> <span class=main>(</span>Times <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv_regex <span class=free>fv</span> <span class=free>r</span><span class=main>)</span> <span class=main>(</span>nfv_regex <span class=free>fv</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=free>fv</span> <span class=main>(</span>Star <span class=free>r</span><span class=main>)</span> <span class=main>=</span> nfv_regex <span class=free>fv</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> nfv_regex_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_Un Max_Un insert_Un <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> Un_insert_right Un_insert_left<span class=main>)</span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>min_regex_default</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=keyword1>if</span> atms <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=keyword1>else</span> Min <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>z</span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>`</span> atms <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>match</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>nat <span class=main>⇒</span> <span class=tfree>'a</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> regex <span class=main>⇒</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> <span class=bound>j</span> <span class=main>=</span> <span class=bound>i</span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>j</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=bound>i</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>⊔</span> <span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>OO</span> <span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>match</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> match_cong<span class=main>[</span><span class=operator>fundef_cong</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>=</span> <span class=free>r'</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>i</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>t</span> <span class=bound>i</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>t'</span> <span class=bound>i</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> match <span class=free>t</span> <span class=free>r</span> <span class=main>=</span> match <span class=free>t'</span> <span class=free>r'</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r'</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>eps</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∨</span> <span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eps</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>lpd</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>{}</span> <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> <span class=main>{</span>Skip <span class=bound>m</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> TimesR <span class=main>(</span><span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> eps <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>then</span> <span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> TimesR <span class=main>(</span><span class=free>lpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>lpdκ</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>{}</span> <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>Skip <span class=bound>m</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lpdκ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>Times <span class=bound>t</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> eps <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>then</span> <span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lpdκ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>Times <span class=bound>t</span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>rpd</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>{}</span> <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> <span class=main>{</span>Skip <span class=bound>m</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> TimesL <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>(</span><span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> eps <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=keyword1>then</span> <span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> TimesL <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>rpd</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>rpdκ</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>{}</span> <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>Skip <span class=bound>m</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rpdκ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> eps <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=keyword1>then</span> <span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rpdκ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rpdκ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>Times <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>test</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> lpdκ_lpd<span class=main>:</span> <span class=quoted><span class=quoted>"lpdκ <span class=free>κ</span> <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>=</span> <span class=free>κ</span> <span class=main>`</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>κ</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> rpdκ_rpd<span class=main>:</span> <span class=quoted><span class=quoted>"rpdκ <span class=free>κ</span> <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>=</span> <span class=free>κ</span> <span class=main>`</span> rpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>κ</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> match_le<span class=main>:</span> <span class=quoted><span class=quoted>"match <span class=free>test</span> <span class=free>r</span> <span class=free>i</span> <span class=free>j</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>j</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> order.trans <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Star.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> match.simps <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=skolem>i</span></span> <span class=quoted><span class=skolem>j</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtranclp.induct<span class=main>)</span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Star.IH<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> match_rtranclp_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>test</span> <span class=free>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=free>i</span> <span class=free>j</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> match.simps<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> match_le<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> eps_match<span class=main>:</span> <span class=quoted><span class=quoted>"eps <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟷</span> match <span class=free>test</span> <span class=free>r</span> <span class=free>i</span> <span class=free>i</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> antisym<span class=main><span class=main>[</span></span><span class=operator>OF</span> match_le match_le<span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> lpd_match<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=free>j</span> <span class=main>⟹</span> match <span class=free>test</span> <span class=free>r</span> <span class=free>i</span> <span class=free>j</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>s</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>s</span><span class=main>)</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>j</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"match <span class=free>test</span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>.</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>k</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=bound>k</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=skolem>i</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&gt;</span><span class=skolem>i</span><span class=main>.</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>k</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=bound>k</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> match_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>test</span></span> <span class=quoted><span class=skolem>r</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> nat_less_le <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=skolem>i</span> <span class=main>∧</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=skolem>i</span> <span class=skolem>s</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>j</span> <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&gt;</span><span class=skolem>i</span><span class=main>.</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=skolem>i</span> <span class=skolem>r</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=bound>k</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=bound>k</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Times.IH<span class=main>(</span>1<span class=main>)</span> Times.IH<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> Times.prems<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=skolem>i</span> <span class=main>∧</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=skolem>i</span> <span class=skolem>s</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>j</span> <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>.</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=skolem>i</span> <span class=skolem>r</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=bound>k</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=bound>k</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Times.prems <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> disj_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> refl<span class=main><span class=main>]</span></span> iff_exI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>⨆</span> <span class=main>(</span>match <span class=free>test</span> <span class=main>`</span> lpd <span class=free>test</span> <span class=skolem>i</span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def TimesR_def eps_match<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span><span class=main>∈</span>lpd <span class=free>test</span> <span class=skolem>i</span> <span class=skolem>r</span><span class=main>.</span> <span class=main>(</span>match <span class=free>test</span> <span class=bound>s</span> <span class=keyword1>OO</span> <span class=main>(</span>match <span class=free>test</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span><span class=main>)</span> <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>j</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>test</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> that Star.prems match_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>test</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> converse_rtranclp_induct<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>step <span class=skolem>i</span> <span class=skolem>k</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=skolem>k</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_less Star.IH <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> Star.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> match_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>test</span></span> <span class=main>_</span>  <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def TimesR_def Suc_le_eq Star.IH<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>i</span></span><span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> converse_rtranclp_into_rtranclp<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> rpd_match<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=free>j</span> <span class=main>⟹</span> match <span class=free>test</span> <span class=free>r</span> <span class=free>i</span> <span class=free>j</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>s</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=free>j</span> <span class=free>r</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>s</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span><span class=free>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>j</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"match <span class=free>test</span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>.</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>k</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=bound>k</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=skolem>j</span> <span class=skolem>j</span> <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&lt;</span><span class=skolem>j</span><span class=main>.</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>k</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=bound>k</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> match_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>test</span></span> <span class=quoted><span class=skolem>s</span></span> <span class=main>_</span> <span class=quoted><span class=skolem>j</span></span><span class=main>]</span> nat_less_le <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=skolem>j</span> <span class=skolem>r</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>(</span><span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=skolem>j</span> <span class=skolem>j</span>  <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&lt;</span><span class=skolem>j</span><span class=main>.</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>k</span> <span class=main>∧</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=skolem>j</span> <span class=skolem>s</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=bound>k</span> <span class=main>(</span><span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Times.IH<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> Times.prems<span class=main>]</span> Times.IH<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=skolem>j</span> <span class=skolem>r</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>(</span><span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> match <span class=free>test</span> <span class=skolem>s</span> <span class=skolem>j</span> <span class=skolem>j</span>  <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>.</span> match <span class=free>test</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>k</span> <span class=main>∧</span> <span class=main>(</span><span class=main>⨆</span><span class=bound>t</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=skolem>j</span> <span class=skolem>s</span><span class=main>.</span> match <span class=free>test</span> <span class=bound>t</span><span class=main>)</span> <span class=bound>k</span> <span class=main>(</span><span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Times.prems <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> disj_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> refl<span class=main><span class=main>]</span></span> iff_exI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>⨆</span> <span class=main>(</span>match <span class=free>test</span> <span class=main>`</span> rpd <span class=free>test</span> <span class=skolem>j</span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>(</span><span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def TimesR_def eps_match<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span><span class=main>∈</span>rpd <span class=free>test</span> <span class=skolem>j</span> <span class=skolem>r</span><span class=main>.</span> <span class=main>(</span><span class=main>(</span>match <span class=free>test</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=keyword1>OO</span> match <span class=free>test</span> <span class=bound>s</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>(</span><span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>test</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> that Star.prems match_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>test</span></span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtranclp_induct<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>step <span class=skolem>k</span> <span class=skolem>j</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> <span class=skolem>j</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_less Star.IH <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> Star.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def TimesR_def <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Star.IH<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> rtranclp.rtrancl_into_rtrancl <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>test</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>unfolded</span> One_nat_def<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> lpd_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>s</span> <span class=main>⊆</span> fv_regex <span class=free>fv</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def TimesL_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits nat.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> rpd_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>s</span> <span class=main>⊆</span> fv_regex <span class=free>fv</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def TimesL_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits nat.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> match_fv_cong<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>i</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>test</span> <span class=bound>i</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>test'</span> <span class=bound>i</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> match <span class=free>test</span> <span class=free>r</span> <span class=main>=</span> match <span class=free>test'</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> eps_fv_cong<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>i</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>test</span> <span class=bound>i</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>test'</span> <span class=bound>i</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> eps <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>=</span> eps <span class=free>test'</span> <span class=free>i</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>datatype</span></span> modality <span class=main>=</span> Past <span class=main>|</span> Futu
<span class=keyword1><span class=command>datatype</span></span> safety <span class=main>=</span> Strict <span class=main>|</span> Lax

<span class=keyword1><span class=command>context</span></span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>fv</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span> set"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=free>safe</span> <span class=main>::</span> <span class=quoted><span class=quoted>"safety <span class=main>⇒</span> <span class=tfree>'a</span> <span class=main>⇒</span> bool"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>fun</span></span> <span class=entity>safe_regex</span> <span class=main>::</span> <span class=quoted><span class=quoted>"modality <span class=main>⇒</span> safety <span class=main>⇒</span> <span class=tfree>'a</span> regex <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>(</span>Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>(</span>Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>safe</span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>=</span> Lax <span class=main>∨</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> Futu <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>=</span> Lax <span class=main>∨</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>⊆</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=free>safe_regex</span> Futu <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∧</span> <span class=free>safe_regex</span> Futu Lax <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> Past <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>(</span>Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>=</span> Lax <span class=main>∨</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>⊆</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=free>safe_regex</span> Past <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=free>safe_regex</span> Past Lax <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>(</span>Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>=</span> Lax <span class=main>∨</span> fv_regex <span class=free>fv</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span> <span class=main>∧</span> <span class=free>safe_regex</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemmas</span></span> safe_regex_induct <span class=main>=</span> safe_regex.induct<span class=main>[</span><span class=operator>case_names</span> Skip Test Plus TimesF TimesP Star<span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> safe_cosafe<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>safe</span> Strict <span class=bound>x</span> <span class=main>⟹</span> <span class=free>safe</span> Lax <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> safe_regex <span class=free>m</span> Strict <span class=free>r</span> <span class=main>⟹</span> safe_regex <span class=free>m</span> Lax <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>m</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> safe_lpd_fv_regex_le<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>r</span> <span class=main>⊆</span> fv_regex <span class=free>fv</span> <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_lpd_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>s</span> <span class=main>=</span> fv_regex <span class=free>fv</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> eq_iff lpd_fv_regex safe_lpd_fv_regex_le<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> cosafe_lpd<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Lax <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> safe_regex Futu Lax <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Plus<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Plus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Times<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Times<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_lpd<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span><span class=main>.</span> <span class=free>safe</span> Strict <span class=bound>x</span> <span class=main>⟶</span> <span class=free>safe</span> Lax <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
  safe_regex Futu Strict <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> lpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> safe_regex Futu Strict <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Plus<span class=main>(</span>3<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Plus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> ball_Un<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Times<span class=main>(</span>3<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def ball_Un <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Times<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> cosafe_lpd <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> lpd_fv_regex <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Star<span class=main>(</span>2<span class=main>,</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesR_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Star<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> cosafe_lpd
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_cosafe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> lpd_fv_regex<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> fv<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>fv</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_rpd_fv_regex_le<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>r</span> <span class=main>⊆</span> fv_regex <span class=free>fv</span> <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_rpd_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> fv_regex <span class=free>fv</span> <span class=free>s</span> <span class=main>=</span> fv_regex <span class=free>fv</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> eq_iff rpd_fv_regex safe_rpd_fv_regex_le<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> cosafe_rpd<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Lax <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> safe_regex Past Lax <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Plus<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Plus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Times<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Times<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_rpd<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span><span class=main>.</span> <span class=free>safe</span> Strict <span class=bound>x</span> <span class=main>⟶</span> <span class=free>safe</span> Lax <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
  safe_regex Past Strict <span class=free>r</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> rpd <span class=free>test</span> <span class=free>i</span> <span class=free>r</span> <span class=main>⟹</span> safe_regex Past Strict <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Plus<span class=main>(</span>3<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Plus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> ball_Un<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Times<span class=main>(</span>3<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def ball_Un <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Times<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> cosafe_rpd <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> rpd_fv_regex <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Star<span class=main>(</span>2<span class=main>,</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> TimesL_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Star<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> cosafe_rpd
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_cosafe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> rpd_fv_regex<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> fv<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>fv</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_regex_safe<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>g</span> <span class=bound>r</span><span class=main>.</span> <span class=free>safe</span> <span class=bound>g</span> <span class=bound>r</span> <span class=main>⟹</span> <span class=free>safe</span> Lax <span class=bound>r</span><span class=main>)</span> <span class=main>⟹</span>
  safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>safe</span> Lax <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> safe_regex_map_regex<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>g</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>safe</span> <span class=bound>g</span> <span class=bound>x</span> <span class=main>⟹</span>  <span class=free>safe</span> <span class=bound>g</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>fv</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>fv</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
   safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> safe_regex <span class=free>m</span> <span class=free>g</span> <span class=main>(</span>map_regex <span class=free>f</span> <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_regex_alt regex.set_map<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>lemma</span></span> safe_regex_cong<span class=main>[</span><span class=operator>fundef_cong</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>g</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>safe</span> <span class=bound>g</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>safe'</span> <span class=bound>g</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
  Regex.safe_regex <span class=free>fv</span> <span class=free>safe</span> <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>=</span> Regex.safe_regex <span class=free>fv</span> <span class=free>safe'</span> <span class=free>m</span> <span class=free>g</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> safe_regex_mono<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>g</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>safe</span> <span class=bound>g</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>safe'</span> <span class=bound>g</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
  Regex.safe_regex <span class=free>fv</span> <span class=free>safe</span> <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> Regex.safe_regex <span class=free>fv</span> <span class=free>safe'</span> <span class=free>m</span> <span class=free>g</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> match_map_regex<span class=main>:</span> <span class=quoted><span class=quoted>"match <span class=free>t</span> <span class=main>(</span>map_regex <span class=free>f</span> <span class=free>r</span><span class=main>)</span> <span class=main>=</span> match <span class=main>(</span><span class=main>λ</span><span class=bound>k</span> <span class=bound>z</span><span class=main>.</span> <span class=free>t</span> <span class=bound>k</span> <span class=main>(</span><span class=free>f</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> match_cong_strong<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>k</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=free>i</span> <span class=main>..&lt;</span> <span class=free>j</span> <span class=main>+</span> <span class=main>1</span><span class=main>}</span> <span class=main>⟹</span> <span class=bound>z</span> <span class=main>∈</span> atms <span class=free>r</span> <span class=main>⟹</span> <span class=free>t</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>t'</span> <span class=bound>k</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> match <span class=free>t</span> <span class=free>r</span> <span class=free>i</span> <span class=free>j</span> <span class=main>=</span> match <span class=free>t'</span> <span class=free>r</span> <span class=free>i</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>j</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Times.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> relcompp_apply <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> le_less_trans match_le less_Suc_eq_le
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Times.IH<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span> Times.IH<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span> match_le<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> match.simps
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>assume</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>t</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> match.simps<span class=main>(</span>5<span class=main>)</span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> match_le<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>t'</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Star.prems
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>i</span></span> <span class=quoted><span class=skolem>j</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtranclp.induct<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>rtrancl_into_rtrancl <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span><span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> rtrancl_into_rtrancl<span class=main>(</span>1<span class=main>,</span>2<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> rtranclp.rtrancl_into_rtrancl<span class=main><span class=main>[</span></span><span class=operator>OF</span> rtrancl_into_rtrancl.IH<span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Star.IH<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span>
            <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le match_rtranclp_le <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_Suc_eq_le<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>assume</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>t'</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> match.simps<span class=main>(</span>5<span class=main>)</span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> match_le<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>match <span class=free>t</span> <span class=skolem>r</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Star.prems
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>i</span></span> <span class=quoted><span class=skolem>j</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtranclp.induct<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>rtrancl_into_rtrancl <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span><span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> rtrancl_into_rtrancl<span class=main>(</span>1<span class=main>,</span>2<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> rtranclp.rtrancl_into_rtrancl<span class=main><span class=main>[</span></span><span class=operator>OF</span> rtrancl_into_rtrancl.IH<span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Star.IH<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span>
            <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_le match_rtranclp_le <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_Suc_eq_le<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Formula><div class=head><h1>Theory Formula</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Formula
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Event_Data.html>Event_Data</a>
    <a href=Regex.html>Regex</a>
    <span class=quoted>"<a href=../MFOTL_Monitor/Interval.html>MFOTL_Monitor.Interval</a>"</span>
    <span class=quoted>"<a href=../MFOTL_Monitor/Trace.html>MFOTL_Monitor.Trace</a>"</span>
    <span class=quoted>"<a href=../MFOTL_Monitor/Abstract_Monitor.html>MFOTL_Monitor.Abstract_Monitor</a>"</span>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Mapping.html>HOL-Library.Mapping</a>"</span>
    <a href=../Containers/Set_Impl.html>Containers.Set_Impl</a>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Metric first-order dynamic logic›</span></span>

<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>eq<span class=main>)</span> ceq <span class=quoted>enat</span>

<span class=keyword1><span class=command>instantiation</span></span> enat <span class=main>::</span> <span class=quoted>ccompare</span> <span class=keyword2><span class=keyword>begin</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity><span class=class_parameter>ccompare_enat</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"enat comparator option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ccompare_enat</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span> <span class=keyword1>then</span> order.Eq <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=bound>y</span> <span class=keyword1>then</span> order.Lt <span class=keyword1>else</span> order.Gt<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>instance</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>intro_classes</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> ccompare_enat_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> comparator.intro<span class=main>)</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>context</span></span> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Formulas and satisfiability›</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> name <span class=main>=</span> <span class=quoted>String.literal</span>
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> event <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>name <span class=main>×</span> event_data list<span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> database <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>name<span class=main>,</span> event_data list set list<span class=main>)</span> mapping"</span></span>
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> prefix <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>name <span class=main>×</span> event_data list<span class=main>)</span> prefix"</span></span>
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> trace <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>name <span class=main>×</span> event_data list<span class=main>)</span> trace"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> env <span class=main>=</span> <span class=quoted><span class=quoted>"event_data list"</span></span>

<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Syntax›</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>datatype</span></span> trm <span class=main>=</span> <span class=entity>is_Var</span><span class=main>:</span> Var <span class=quoted>nat</span> <span class=main>|</span> <span class=entity>is_Const</span><span class=main>:</span> Const <span class=quoted>event_data</span>
  <span class=main>|</span> Plus <span class=quoted>trm</span> <span class=quoted>trm</span> <span class=main>|</span> Minus <span class=quoted>trm</span> <span class=quoted>trm</span> <span class=main>|</span> UMinus <span class=quoted>trm</span> <span class=main>|</span> Mult <span class=quoted>trm</span> <span class=quoted>trm</span> <span class=main>|</span> Div <span class=quoted>trm</span> <span class=quoted>trm</span> <span class=main>|</span> Mod <span class=quoted>trm</span> <span class=quoted>trm</span>
  <span class=main>|</span> F2i <span class=quoted>trm</span> <span class=main>|</span> I2f <span class=quoted>trm</span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>fvi_trm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> trm <span class=main>⇒</span> nat set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>then</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Const <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∪</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Minus <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∪</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>UMinus <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Mult <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∪</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Div <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∪</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Mod <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∪</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>F2i <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>I2f <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi_trm</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>fv_trm</span> <span class=main>≡</span> fvi_trm <span class=main>0</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>primrec</span></span> <span class=entity>eval_trm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"env <span class=main>⇒</span> trm <span class=main>⇒</span> event_data"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Const <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Plus <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>+</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Minus <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>-</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>UMinus <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>-</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Mult <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>*</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Div <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>div</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Mod <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>mod</span> <span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>F2i <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> EInt <span class=main>(</span>integer_of_event_data <span class=main>(</span><span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>I2f <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> EFloat <span class=main>(</span>double_of_event_data <span class=main>(</span><span class=free>eval_trm</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> eval_trm_fv_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv_trm <span class=free>t</span><span class=main>.</span> <span class=free>v</span> <span class=main>!</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>v'</span> <span class=main>!</span> <span class=bound>x</span> <span class=main>⟹</span> eval_trm <span class=free>v</span> <span class=free>t</span> <span class=main>=</span> eval_trm <span class=free>v'</span> <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>simp_all</span>


<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>datatype</span></span> agg_type <span class=main>=</span> Agg_Cnt <span class=main>|</span> Agg_Min <span class=main>|</span> Agg_Max <span class=main>|</span> Agg_Sum <span class=main>|</span> Agg_Avg <span class=main>|</span> Agg_Med
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>type_synonym</span></span> agg_op <span class=main>=</span> <span class=quoted><span class=quoted>"agg_type <span class=main>×</span> event_data"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>flatten_multiset</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>event_data <span class=main>×</span> enat<span class=main>)</span> set <span class=main>⇒</span> event_data list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>flatten_multiset</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> concat <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>c</span><span class=main>)</span><span class=main>.</span> replicate <span class=main>(</span>the_enat <span class=bound>c</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span> <span class=main>(</span>csorted_list_of_set <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_agg_op</span> <span class=main>::</span> <span class=quoted><span class=quoted>"agg_op <span class=main>⇒</span> <span class=main>(</span>event_data <span class=main>×</span> enat<span class=main>)</span> set <span class=main>⇒</span> event_data"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_agg_op</span> <span class=main>(</span>Agg_Cnt<span class=main>,</span> <span class=free><span class=bound><span class=entity>y0</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> EInt <span class=main>(</span>integer_of_int <span class=main>(</span>length <span class=main>(</span>flatten_multiset <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_agg_op</span> <span class=main>(</span>Agg_Min<span class=main>,</span> <span class=free><span class=bound><span class=entity>y0</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> flatten_multiset <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>y0</span></span></span>
    <span class=main>|</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>xs</span> <span class=main>⇒</span> foldl min <span class=bound>x</span> <span class=bound>xs</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_agg_op</span> <span class=main>(</span>Agg_Max<span class=main>,</span> <span class=free><span class=bound><span class=entity>y0</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> flatten_multiset <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>y0</span></span></span>
    <span class=main>|</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>xs</span> <span class=main>⇒</span> foldl max <span class=bound>x</span> <span class=bound>xs</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_agg_op</span> <span class=main>(</span>Agg_Sum<span class=main>,</span> <span class=free><span class=bound><span class=entity>y0</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> foldl plus <span class=free><span class=bound><span class=entity>y0</span></span></span> <span class=main>(</span>flatten_multiset <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_agg_op</span> <span class=main>(</span>Agg_Avg<span class=main>,</span> <span class=free><span class=bound><span class=entity>y0</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=keyword1>let</span> <span class=bound>xs</span> <span class=main>=</span> flatten_multiset <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=keyword1>in</span> <span class=keyword1>case</span> <span class=bound>xs</span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>⇒</span> <span class=main>0</span>
    <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> double_of_event_data <span class=main>(</span>foldl plus <span class=main>(</span>EInt <span class=main>0</span><span class=main>)</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>/</span> double_of_int <span class=main>(</span>length <span class=bound>xs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_agg_op</span> <span class=main>(</span>Agg_Med<span class=main>,</span> <span class=free><span class=bound><span class=entity>y0</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>M</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span><span class=keyword1>let</span> <span class=bound>xs</span> <span class=main>=</span> flatten_multiset <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>;</span> <span class=bound>u</span> <span class=main>=</span> length <span class=bound>xs</span> <span class=keyword1>in</span>
    <span class=keyword1>if</span> <span class=bound>u</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span>
      <span class=keyword1>let</span> <span class=bound>u'</span> <span class=main>=</span> <span class=bound>u</span> <span class=keyword1>div</span> <span class=numeral>2</span> <span class=keyword1>in</span>
      <span class=keyword1>if</span> even <span class=bound>u</span> <span class=keyword1>then</span>
        <span class=main>(</span>double_of_event_data <span class=main>(</span><span class=bound>xs</span> <span class=main>!</span> <span class=main>(</span><span class=bound>u'</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>+</span> double_of_event_data <span class=main>(</span><span class=bound>xs</span> <span class=main>!</span> <span class=bound>u'</span><span class=main>)</span> <span class=main>/</span> double_of_int <span class=numeral>2</span><span class=main>)</span>
      <span class=keyword1>else</span> double_of_event_data <span class=main>(</span><span class=bound>xs</span> <span class=main>!</span> <span class=bound>u'</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>datatype</span></span> <span class=main>(</span>discs_sels<span class=main>)</span> formula <span class=main>=</span> Pred <span class=quoted>name</span> <span class=quoted><span class=quoted>"trm list"</span></span>
  <span class=main>|</span> Let <span class=quoted>name</span> <span class=quoted>formula</span> <span class=quoted>formula</span>
  <span class=main>|</span> Eq <span class=quoted>trm</span> <span class=quoted>trm</span> <span class=main>|</span> Less <span class=quoted>trm</span> <span class=quoted>trm</span> <span class=main>|</span> LessEq <span class=quoted>trm</span> <span class=quoted>trm</span>
  <span class=main>|</span> Neg <span class=quoted>formula</span> <span class=main>|</span> Or <span class=quoted>formula</span> <span class=quoted>formula</span> <span class=main>|</span> And <span class=quoted>formula</span> <span class=quoted>formula</span> <span class=main>|</span> Ands <span class=quoted><span class=quoted>"formula list"</span></span> <span class=main>|</span> Exists <span class=quoted>formula</span>
  <span class=main>|</span> Agg <span class=quoted>nat</span> <span class=quoted>agg_op</span> <span class=quoted>nat</span> <span class=quoted>trm</span> <span class=quoted>formula</span>
  <span class=main>|</span> Prev <span class=quoted>ℐ</span> <span class=quoted>formula</span> <span class=main>|</span> Next <span class=quoted>ℐ</span> <span class=quoted>formula</span>
  <span class=main>|</span> Since <span class=quoted>formula</span> <span class=quoted>ℐ</span> <span class=quoted>formula</span> <span class=main>|</span> Until <span class=quoted>formula</span> <span class=quoted>ℐ</span> <span class=quoted>formula</span>
  <span class=main>|</span> MatchF <span class=quoted>ℐ</span> <span class=quoted><span class=quoted>"formula Regex.regex"</span></span> <span class=main>|</span> MatchP <span class=quoted>ℐ</span> <span class=quoted><span class=quoted>"formula Regex.regex"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>FF</span> <span class=main>=</span> Exists <span class=main>(</span>Neg <span class=main>(</span>Eq <span class=main>(</span>Var <span class=main>0</span><span class=main>)</span> <span class=main>(</span>Var <span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>TT</span> <span class=main>≡</span> Neg FF"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>fun</span></span> <span class=entity>fvi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> formula <span class=main>⇒</span> nat set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Pred <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∪</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∪</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∪</span> fvi_trm <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∪</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∪</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>xs</span> <span class=main>=</span> map <span class=main>(</span><span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=keyword1>in</span> <span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=bound>xs</span><span class=main>.</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b'</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>b'</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∪</span> fvi_trm <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>b'</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=keyword1>then</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∪</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∪</span> <span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.fv_regex <span class=main>(</span><span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>(</span>MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.fv_regex <span class=main>(</span><span class=free>fvi</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>fv</span> <span class=main>≡</span> fvi <span class=main>0</span>"</span></span>
<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>fv_regex</span> <span class=main>≡</span> Regex.fv_regex fv"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fv_abbrevs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"fv TT <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=quoted><span class=quoted>"fv FF <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> TT_def FF_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> fv_subset_Ands<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> set <span class=free>φs</span> <span class=main>⟹</span> fv <span class=free>φ</span> <span class=main>⊆</span> fv <span class=main>(</span>Ands <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> finite_fvi_trm<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fvi_trm <span class=free>b</span> <span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> finite_fvi<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fvi <span class=free>b</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>b</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_trm_plus<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> fvi_trm <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>c</span><span class=main>)</span> <span class=free>t</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>+</span> <span class=free>c</span> <span class=main>∈</span> fvi_trm <span class=free>b</span> <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_trm_iff_fv_trm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> fvi_trm <span class=free>b</span> <span class=free>t</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>+</span> <span class=free>b</span> <span class=main>∈</span> fv_trm <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> fvi_trm_plus<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main>=</span></span><span class=quoted><span class=main>0</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> c<span class=main><span class=main>=</span></span><span class=quoted><span class=free>b</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_plus<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> fvi <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>c</span><span class=main>)</span> <span class=free>φ</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>+</span> <span class=free>c</span> <span class=main>∈</span> fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>b</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> formula.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b'</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>+</span> <span class=free>c</span> <span class=main>+</span> <span class=skolem>b'</span> <span class=main>=</span> <span class=skolem>b</span> <span class=main>+</span> <span class=skolem>b'</span> <span class=main>+</span> <span class=free>c</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> Agg <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> * fvi_trm_plus<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_trm_plus fv_regex_commute<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> g <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>+</span> <span class=free>c</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_Suc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> fvi <span class=main>(</span>Suc <span class=free>b</span><span class=main>)</span> <span class=free>φ</span> <span class=main>⟷</span> Suc <span class=free>x</span> <span class=main>∈</span> fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> fvi_plus<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> c<span class=main><span class=main>=</span></span><span class=quoted><span class=main>1</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_plus_bound<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fvi <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>c</span><span class=main>)</span> <span class=free>φ</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fvi <span class=free>b</span> <span class=free>φ</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>c</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=free>c</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=free>c</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>=</span> <span class=skolem>i'</span> <span class=main>+</span> <span class=free>c</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nat_le_iff_add <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_less<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>∈</span> fvi <span class=free>b</span> <span class=free>φ</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_plus<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> fvi_Suc_bound<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fvi <span class=main>(</span>Suc <span class=free>b</span><span class=main>)</span> <span class=free>φ</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fvi <span class=free>b</span> <span class=free>φ</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> Suc <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fvi_plus_bound<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> c<span class=main><span class=main>=</span></span><span class=quoted><span class=main>1</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_iff_fv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> fvi <span class=free>b</span> <span class=free>φ</span> <span class=main>⟷</span> <span class=free>x</span> <span class=main>+</span> <span class=free>b</span> <span class=main>∈</span> fv <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> fvi_plus<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main>=</span></span><span class=quoted><span class=main>0</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> c<span class=main><span class=main>=</span></span><span class=quoted><span class=free>b</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=entity>nfv</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>nfv</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> Max <span class=main>(</span>insert <span class=main>0</span> <span class=main>(</span>Suc <span class=main>`</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>nfv_regex</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>nfv_regex</span> <span class=main>≡</span> Regex.nfv_regex fv"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>definition</span></span> <span class=entity>envs</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> env set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>envs</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> nfv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> nfv_simps<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Let <span class=free>p</span> <span class=free>φ</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>=</span> nfv <span class=free>ψ</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Neg <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> nfv <span class=free>φ</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Or <span class=free>φ</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>nfv <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>And <span class=free>φ</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>nfv <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Prev <span class=free>I</span> <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> nfv <span class=free>φ</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Next <span class=free>I</span> <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> nfv <span class=free>φ</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Since <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>nfv <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Until <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>nfv <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=main>=</span> Regex.nfv_regex fv <span class=free>r</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv <span class=main>(</span>MatchF <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=main>=</span> Regex.nfv_regex fv <span class=free>r</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=main>(</span>Regex.Skip <span class=free>n</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=main>(</span>Regex.Test <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> Max <span class=main>(</span>insert <span class=main>0</span> <span class=main>(</span>Suc <span class=main>`</span> fv <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=main>(</span>Regex.Plus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>nfv_regex <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=main>(</span>Regex.Times <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>nfv_regex <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"nfv_regex <span class=main>(</span>Regex.Star <span class=free>r</span><span class=main>)</span> <span class=main>=</span> nfv_regex <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> nfv_def Regex.nfv_regex_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_Un Max_Un<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> nfv_Ands<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Ands <span class=free>l</span><span class=main>)</span> <span class=main>=</span> Max <span class=main>(</span>insert <span class=main>0</span> <span class=main>(</span>nfv <span class=main>`</span> set <span class=free>l</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> nfv_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv <span class=main>(</span>Ands <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fv <span class=skolem>a</span> <span class=main>∪</span> fv <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nfv <span class=main>(</span>Ands <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> max <span class=main>(</span>nfv <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>nfv <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> nfv_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_Un Max.union<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Cons.IH <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> fvi_less_nfv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fv <span class=free>φ</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> nfv <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> nfv_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Max_gr_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max.strict_coboundedI2<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fvi_less_nfv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fv_regex <span class=free>φ</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> nfv_regex <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Regex.nfv_regex_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Max_gr_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max.strict_coboundedI2<span class=main>)</span>

<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Future reach›</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>fun</span></span> <span class=entity>future_bounded</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Pred <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Eq <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Less <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>LessEq <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> list_all <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>l</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≠</span> <span class=main>∞</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.pred_regex <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>future_bounded</span> <span class=main>(</span>MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Regex.pred_regex <span class=free>future_bounded</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≠</span> <span class=main>∞</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Semantics›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>ecard</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> finite <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=keyword1>then</span> card <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=keyword1>else</span> <span class=main>∞</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>fun</span></span> <span class=entity>sat</span> <span class=main>::</span> <span class=quoted><span class=quoted>"trace <span class=main>⇒</span> <span class=main>(</span>name <span class=main>⇀</span> nat <span class=main>⇒</span> event_data list set<span class=main>)</span> <span class=main>⇒</span> env <span class=main>⇒</span> nat <span class=main>⇒</span> formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Pred <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span>
       None <span class=main>⇒</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span> map <span class=main>(</span>eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>∈</span> Γ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span>
     <span class=main>|</span> Some <span class=bound>X</span> <span class=main>⇒</span> map <span class=main>(</span>eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>∈</span> <span class=bound>X</span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>V</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>↦</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> nfv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=bound>v</span> <span class=bound>i</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>=</span> eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>&lt;</span> eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>≤</span> eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>¬</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∨</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>φ</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>.</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>φ</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span><span class=bound>z</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>M</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span> ecard <span class=bound>Zs</span><span class=main>)</span> <span class=main>|</span> <span class=bound>x</span> <span class=bound>Zs</span><span class=main>.</span> <span class=bound>Zs</span> <span class=main>=</span> <span class=main>{</span><span class=bound>zs</span><span class=main>.</span> length <span class=bound>zs</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> eval_trm <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>=</span> <span class=bound>x</span><span class=main>}</span> <span class=main>∧</span> <span class=bound>Zs</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>M</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>⟶</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span><span class=main>)</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> eval_agg_op <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=bound>M</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> False <span class=main>|</span> Suc <span class=bound>j</span> <span class=main>⇒</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>j</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>j</span></span><span class=main>≤</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>.</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>j</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>j</span> <span class=main>&lt;..</span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>}</span><span class=main>.</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>k</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>j</span></span><span class=main>≥</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>.</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>j</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>..&lt;</span> <span class=bound>j</span><span class=main>}</span><span class=main>.</span> <span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>k</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>j</span></span><span class=main>≤</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>.</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> Regex.match <span class=main>(</span><span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>j</span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>j</span></span><span class=main>≥</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>.</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> Regex.match <span class=main>(</span><span class=free>sat</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>j</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> sat_abbrevs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> TT"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> FF"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> TT_def FF_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_Ands<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Ands <span class=free>l</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=free>l</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=bound>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_Until_rec<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Until <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>⟷</span>
  mem <span class=main>0</span> <span class=free>I</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>ψ</span> <span class=main>∨</span>
  <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Until <span class=free>φ</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>⟷</span> <span class=var>?R</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>elim</span> disjE conjE<span class=main>)</span><span class=main><span class=keyword3>?</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>≤</span> <span class=skolem>j</span>"</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=skolem>j</span> <span class=free>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=free>i</span> <span class=main>..&lt;</span> <span class=skolem>j</span><span class=main>}</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=bound>k</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>=</span> <span class=skolem>j</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> j<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> diff_le_mono<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False j<span class=main>(</span>1<span class=main>,</span>4<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False j <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Until <span class=free>φ</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv le_diff_conv2 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> Δ<span class=main>:</span> <span class=quoted><span class=quoted>"Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> now<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
   <span class=quoted>"next"</span><span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Until <span class=free>φ</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted>"next"</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> <span class=skolem>j</span>"</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=skolem>j</span> <span class=free>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span> <span class=main>..&lt;</span> <span class=skolem>j</span><span class=main>}</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=bound>k</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> Δ j<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv2<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> now j<span class=main>(</span>1<span class=main>,</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_eq_less_or_eq<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>i</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_Since_rec<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>⟷</span>
  mem <span class=main>0</span> <span class=free>I</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>ψ</span> <span class=main>∨</span>
  <span class=main>(</span><span class=free>i</span> <span class=main>&gt;</span> <span class=main>0</span> <span class=main>∧</span> Δ <span class=free>σ</span> <span class=free>i</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>⟷</span> <span class=var>?R</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>elim</span> disjE conjE<span class=main>)</span><span class=main><span class=keyword3>?</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> <span class=free>i</span>"</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>j</span><span class=main>)</span> <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=skolem>j</span> <span class=free>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>j</span> <span class=main>&lt;..</span> <span class=free>i</span><span class=main>}</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=bound>k</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>=</span> <span class=skolem>j</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> j<span class=main>(</span>1<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>=</span> <span class=skolem>k</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>i</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> j<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> False <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Δ <span class=free>σ</span> <span class=free>i</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> diff_le_mono2 le_Suc_eq<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False j<span class=main>(</span>1<span class=main>,</span>4<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False j <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv le_diff_conv2 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>&lt;</span> <span class=free>i</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> Δ<span class=main>:</span> <span class=quoted><span class=quoted>"Δ <span class=free>σ</span> <span class=free>i</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> now<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
   <span class=quoted>"prev"</span><span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted>"prev"</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>j</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=skolem>j</span> <span class=free>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>j</span> <span class=main>&lt;..</span> <span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>}</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=bound>k</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> Δ i j<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>j</span><span class=main>)</span> <span class=free>I</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv2<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> now i j<span class=main>(</span>1<span class=main>,</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_Suc_eq gr0_conv_Suc <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_MatchF_rec<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>MatchF <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=main>⟷</span> mem <span class=main>0</span> <span class=free>I</span> <span class=main>∧</span> Regex.eps <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span> <span class=main>∨</span>
  Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>s</span> <span class=main>∈</span> Regex.lpd <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>MatchF <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=bound>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>⟷</span> <span class=var>?R1</span> <span class=main>∨</span> <span class=var>?R2</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>elim</span> disjE conjE bexE<span class=main>)</span><span class=main><span class=keyword3>?</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≥</span> <span class=free>i</span>"</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=free>i</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?R1</span> <span class=main>∨</span> <span class=var>?R2</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=skolem>j</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=free>i</span> <span class=skolem>j</span>›</span></span> lpd_match<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=skolem>j</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span>"</span></span> <span class=quoted><span class=free>r</span></span><span class=main>]</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> Regex.lpd <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=skolem>s</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> True j <span class=keyword1><span class=command>have</span></span> <span class=var><span class=quoted><span class=var>?R2</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv le_diff_conv2 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> le_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eps_match<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"enat <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> Regex.lpd <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>MatchF <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&gt;</span> <span class=free>i</span>"</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=skolem>s</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>j</span>"</span></span>
    <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Suc_le_eq<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv lpd_match <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>s</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eps_match <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>i</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_MatchP_rec<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=main>⟷</span> mem <span class=main>0</span> <span class=free>I</span> <span class=main>∧</span> Regex.eps <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span> <span class=main>∨</span>
  <span class=free>i</span> <span class=main>&gt;</span> <span class=main>0</span> <span class=main>∧</span> Δ <span class=free>σ</span> <span class=free>i</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>s</span> <span class=main>∈</span> Regex.rpd <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span><span class=main>.</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>MatchP <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=bound>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>⟷</span> <span class=var>?R1</span> <span class=main>∨</span> <span class=var>?R2</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>elim</span> disjE conjE bexE<span class=main>)</span><span class=main><span class=keyword3>?</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> <span class=free>i</span>"</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>j</span><span class=main>)</span> <span class=free>I</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=skolem>j</span> <span class=free>i</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?R1</span> <span class=main>∨</span> <span class=var>?R2</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> <span class=free>i</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=skolem>j</span> <span class=free>i</span>›</span></span> rpd_match<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>j</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span>"</span></span> <span class=quoted><span class=free>r</span></span><span class=main>]</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> Regex.rpd <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=skolem>s</span> <span class=skolem>j</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> True j <span class=keyword1><span class=command>have</span></span> <span class=var><span class=quoted><span class=var>?R2</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv le_diff_conv2 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> le_trans<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eps_match<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"enat <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> Regex.rpd <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>MatchP <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span> <span class=skolem>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> <span class=free>i</span>"</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=skolem>s</span> <span class=skolem>j</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"mem <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>j</span><span class=main>)</span> <span class=main>(</span>subtract <span class=main>(</span>Δ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> gr0_conv_Suc less_Suc_eq_le<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?L</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv rpd_match <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>s</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eps_match <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>i</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_Since_0<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>0</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>⟷</span> mem <span class=main>0</span> <span class=free>I</span> <span class=main>∧</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>0</span> <span class=free>ψ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_MatchP_0<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=main>0</span> <span class=main>(</span>MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=main>⟷</span> mem <span class=main>0</span> <span class=free>I</span> <span class=main>∧</span> Regex.eps <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=main>0</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eps_match<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_Since_point<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>⋀</span><span class=bound>j</span><span class=main>.</span> <span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>⟹</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>j</span><span class=main>)</span> <span class=free>I</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>j</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> diff_le_self<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_MatchP_point<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>⋀</span><span class=bound>j</span><span class=main>.</span> <span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>⟹</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>j</span><span class=main>)</span> <span class=free>I</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>j</span><span class=main>)</span><span class=main>)</span> <span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> diff_le_self<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_Since_pointD<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=main>(</span>point <span class=free>t</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>⟹</span> mem <span class=free>t</span> <span class=free>I</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>Since <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_MatchP_pointD<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>MatchP <span class=main>(</span>point <span class=free>t</span><span class=main>)</span> <span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> mem <span class=free>t</span> <span class=free>I</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_fv_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=free>φ</span><span class=main>.</span> <span class=free>v</span><span class=main>!</span><span class=bound>x</span> <span class=main>=</span> <span class=free>v'</span><span class=main>!</span><span class=bound>x</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>=</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v'</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>V</span></span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>v'</span></span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> formula.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>n</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> map_cong eval_trm_fv_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> Pred<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>simplified</span><span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>THEN</span> bspec<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>b</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Eq <span class=skolem>x1</span> <span class=skolem>x2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> fvi.simps sat.simps <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> UnCI eval_trm_fv_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Less <span class=skolem>x1</span> <span class=skolem>x2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> fvi.simps sat.simps <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> UnCI eval_trm_fv_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>LessEq <span class=skolem>x1</span> <span class=skolem>x2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> fvi.simps sat.simps <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> UnCI eval_trm_fv_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> <span class=bound>φ</span> <span class=main>∈</span> set <span class=skolem>l</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=bound>φ</span> <span class=main>=</span> sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v'</span> <span class=skolem>i</span> <span class=bound>φ</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>φ</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv <span class=skolem>φ</span> <span class=main>⊆</span> fv <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> fv_subset_Ands <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=skolem>φ</span><span class=main>.</span> <span class=skolem>v</span><span class=main>!</span><span class=bound>x</span> <span class=main>=</span> <span class=skolem>v'</span><span class=main>!</span><span class=bound>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Ands.prems <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=skolem>φ</span> <span class=main>=</span> sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v'</span> <span class=skolem>i</span> <span class=skolem>φ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Ands.hyps <span class=quoted><span class=quoted>‹<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> sat_Ands <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat.simps <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> iff_exI<span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_Suc nth_Cons'<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>!</span> <span class=skolem>y</span> <span class=main>=</span> <span class=skolem>v'</span> <span class=main>!</span> <span class=skolem>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Agg.prems <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ</span> <span class=main>=</span> sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v'</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
    <span class=keyword1><span class=command>using</span></span> that Agg.prems <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Agg.hyps<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> v<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> v'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v'</span>"</span></span><span class=main><span class=main>]</span></span>
        nth_append fvi_iff_fv<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>f</span> <span class=main>=</span> eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v'</span><span class=main>)</span> <span class=skolem>f</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
    <span class=keyword1><span class=command>using</span></span> that Agg.prems <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> eval_trm_fv_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> v<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> v'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v'</span>"</span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append fvi_iff_fv<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>b</span></span><span class=main><span class=main>]</span></span> fvi_trm_iff_fv_trm<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"length <span class=skolem>zs</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> conj_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v'</span><span class=main>)</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> match_fv_cong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_regex_alt<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v'</span><span class=main>)</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> match_fv_cong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_regex_alt<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> 10 0 <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> iff_exI<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> match_fv_cong<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv_regex <span class=free>r</span><span class=main>.</span> <span class=free>v</span><span class=main>!</span><span class=bound>x</span> <span class=main>=</span> <span class=free>v'</span><span class=main>!</span><span class=bound>x</span> <span class=main>⟹</span> Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v'</span><span class=main>)</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> match_fv_cong<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> sat_fv_cong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_regex_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> eps_fv_cong<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv_regex <span class=free>r</span><span class=main>.</span> <span class=free>v</span><span class=main>!</span><span class=bound>x</span> <span class=main>=</span> <span class=free>v'</span><span class=main>!</span><span class=bound>x</span> <span class=main>⟹</span> Regex.eps <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span> <span class=main>=</span> Regex.eps <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v'</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> eps_match <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>erule</span> match_fv_cong<span class=main><span class=main>[</span></span><span class=operator>THEN</span> fun_cong<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> fun_cong<span class=main><span class=main>]</span></span><span class=main>)</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Past-only formulas›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>past_only</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Pred <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Eq <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Less <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>LessEq <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Let <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>past_only</span> <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=main>∧</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>past_only</span> <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=main>∧</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>past_only</span> <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=main>∧</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>α</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>.</span> <span class=free>past_only</span> <span class=bound>α</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Agg <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Prev <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Next <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>past_only</span> <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=main>∧</span> <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>α</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=free><span class=bound><span class=entity>β</span></span></span><span class=main>)</span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>MatchP <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.pred_regex <span class=free>past_only</span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>past_only</span> <span class=main>(</span>MatchF <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> False"</span></span>

<span class=keyword1><span class=command>lemma</span></span> past_only_sat<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ</span>"</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> plen <span class=free>π</span> <span class=main>⟹</span> dom <span class=free>V</span> <span class=main>=</span> dom <span class=free>V'</span> <span class=main>⟹</span>
     <span class=main>(</span><span class=main>⋀</span><span class=bound>p</span> <span class=bound>i</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> dom <span class=free>V</span> <span class=main>⟹</span> <span class=bound>i</span> <span class=main>&lt;</span> plen <span class=free>π</span> <span class=main>⟹</span> the <span class=main>(</span><span class=free>V</span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span> <span class=main>=</span> the <span class=main>(</span><span class=free>V'</span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
     past_only <span class=free>φ</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>=</span> sat <span class=free>σ'</span> <span class=free>V'</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>V</span></span> <span class=quoted><span class=free>V'</span></span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>i</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>V</span> <span class=skolem>e</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> None
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>V'</span> <span class=skolem>e</span> <span class=main>=</span> None"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹dom <span class=skolem>V</span> <span class=main>=</span> dom <span class=skolem>V'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> None Γ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> Pred<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>a</span><span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>V'</span> <span class=skolem>e</span> <span class=main>=</span> Some <span class=skolem>a'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Some <span class=quoted><span class=quoted>‹dom <span class=skolem>V</span> <span class=main>=</span> dom <span class=skolem>V'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"the <span class=main>(</span><span class=skolem>V</span> <span class=skolem>e</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>=</span> the <span class=main>(</span><span class=skolem>V'</span> <span class=skolem>e</span><span class=main>)</span> <span class=skolem>i</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Some Pred<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> domI<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?V</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>V</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>(</span><span class=bound>V</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> nfv <span class=skolem>φ</span> <span class=main>∧</span> sat <span class=bound>σ</span> <span class=bound>V</span> <span class=bound>v</span> <span class=bound>i</span> <span class=skolem>φ</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat.simps <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> Let.IH<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fact</span>
    <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"past_only <span class=skolem>ψ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span><span class=main>)</span> <span class=main>=</span> dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V'</span> <span class=free>σ'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> fun_upd_apply<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p'</span> <span class=skolem>i</span>
    <span class=keyword3><span class=command>assume</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>∈</span> dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"the <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span> <span class=skolem>p'</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>=</span> the <span class=main>(</span><span class=var>?V</span> <span class=skolem>V'</span> <span class=free>σ'</span> <span class=skolem>p'</span><span class=main>)</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>=</span> <span class=skolem>p</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>with</span></span> Let <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Let.prems<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Γ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Prev <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.split<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Since <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=free>σ'</span> <span class=skolem>V'</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span> <span class=skolem>a</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Regex.match_cong_strong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> regex.pred_set<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> MatchP<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Safe formulas›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>remove_neg</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> formula"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>remove_neg</span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>remove_neg</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fvi_remove_neg<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"fvi <span class=free>b</span> <span class=main>(</span>remove_neg <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> partition_cong<span class=main>[</span><span class=operator>fundef_cong</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>=</span> <span class=free>ys</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>set <span class=free>xs</span> <span class=main>⟹</span> <span class=free>f</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>g</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> partition <span class=free>f</span> <span class=free>xs</span> <span class=main>=</span> partition <span class=free>g</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ys</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> size_remove_neg<span class=main>[</span><span class=operator>termination_simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"size <span class=main>(</span>remove_neg <span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> size <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>is_constraint</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main>(</span>Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main>(</span>Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main>(</span>LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main>(</span>Neg <span class=main>(</span>Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main>(</span>Neg <span class=main>(</span>Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main>(</span>Neg <span class=main>(</span>LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>is_constraint</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> False"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>safe_assignment</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set <span class=main>⇒</span> formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_assignment</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span>
       Eq <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span> <span class=main>(</span>Var <span class=bound>y</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∉</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>⟷</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span>
     <span class=main>|</span> Eq <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span> <span class=bound>t</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∉</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>∧</span> fv_trm <span class=bound>t</span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span>
     <span class=main>|</span> Eq <span class=bound>t</span> <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∉</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>∧</span> fv_trm <span class=bound>t</span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span>
     <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>safe_formula</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>is_Const <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∧</span> <span class=main>(</span>is_Const <span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>∨</span> is_Var <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>∨</span> is_Var <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∧</span> is_Const <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Neg <span class=main>(</span>Eq <span class=main>(</span>Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>Var <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Pred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> is_Var <span class=bound>t</span> <span class=main>∨</span> is_Const <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span>nfv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>}</span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>=</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span>
    <span class=main>(</span>safe_assignment <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∨</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∨</span>
      fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=main>(</span>is_constraint <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>of</span> Neg <span class=bound>ψ'</span> <span class=main>⇒</span> <span class=free>safe_formula</span> <span class=bound>ψ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>pos</span><span class=main>,</span> <span class=bound>neg</span><span class=main>)</span> <span class=main>=</span> partition <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=keyword1>in</span> <span class=bound>pos</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>∧</span>
    list_all <span class=free>safe_formula</span> <span class=main>(</span>map remove_neg <span class=bound>neg</span><span class=main>)</span> <span class=main>∧</span> <span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span>map fv <span class=bound>neg</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span>map fv <span class=bound>pos</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>∉</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> fv_trm <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span>
    <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>safe_formula</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span>
    <span class=main>(</span><span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>safe_formula</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=free>safe_formula</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.safe_regex fv <span class=main>(</span><span class=main>λ</span><span class=bound>g</span> <span class=bound>φ</span><span class=main>.</span> <span class=free>safe_formula</span> <span class=bound>φ</span> <span class=main>∨</span>
     <span class=main>(</span><span class=bound>g</span> <span class=main>=</span> Lax <span class=main>∧</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>φ</span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>safe_formula</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span> Past Strict <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_formula</span> <span class=main>(</span>MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.safe_regex fv <span class=main>(</span><span class=main>λ</span><span class=bound>g</span> <span class=bound>φ</span><span class=main>.</span> <span class=free>safe_formula</span> <span class=bound>φ</span> <span class=main>∨</span>
     <span class=main>(</span><span class=bound>g</span> <span class=main>=</span> Lax <span class=main>∧</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>φ</span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>safe_formula</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span> Futu Strict <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>safe_regex</span> <span class=main>≡</span> Regex.safe_regex fv <span class=main>(</span><span class=main>λ</span><span class=bound>g</span> <span class=bound>φ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>∨</span>
  <span class=main>(</span><span class=bound>g</span> <span class=main>=</span> Lax <span class=main>∧</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>φ</span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> safe_formula <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> safe_regex_safe_formula<span class=main>:</span>
  <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> <span class=free>φ</span> <span class=main>∈</span> Regex.atms <span class=free>r</span> <span class=main>⟹</span> safe_formula <span class=free>φ</span> <span class=main>∨</span>
  <span class=main>(</span><span class=main>∃</span><span class=bound>ψ</span><span class=main>.</span> <span class=free>φ</span> <span class=main>=</span> Neg <span class=bound>ψ</span> <span class=main>∧</span> safe_formula <span class=bound>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>g</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_safe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> formula<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=free><span class=quoted><span class=free>φ</span></span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_abbrevs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula TT"</span></span> <span class=quoted><span class=quoted>"safe_formula FF"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> TT_def FF_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>safe_neg</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_neg</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⟷</span> <span class=main>(</span><span class=main>¬</span> safe_formula <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⟶</span> safe_formula <span class=main>(</span>remove_neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>atms</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula Regex.regex <span class=main>⇒</span> formula set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>atms</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>φ</span> <span class=main>∈</span> Regex.atms <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>.</span>
     <span class=keyword1>if</span> safe_formula <span class=bound>φ</span> <span class=keyword1>then</span> <span class=main>{</span><span class=bound>φ</span><span class=main>}</span> <span class=keyword1>else</span> <span class=keyword1>case</span> <span class=bound>φ</span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=main>{</span><span class=bound>φ'</span><span class=main>}</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=main>{}</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> atms_simps<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"atms <span class=main>(</span>Regex.Skip <span class=free>n</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=quoted><span class=quoted>"atms <span class=main>(</span>Regex.Test <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_formula <span class=free>φ</span> <span class=keyword1>then</span> <span class=main>{</span><span class=free>φ</span><span class=main>}</span> <span class=keyword1>else</span> <span class=keyword1>case</span> <span class=free>φ</span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=main>{</span><span class=bound>φ'</span><span class=main>}</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"atms <span class=main>(</span>Regex.Plus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> atms <span class=free>r</span> <span class=main>∪</span> atms <span class=free>s</span>"</span></span>
  <span class=quoted><span class=quoted>"atms <span class=main>(</span>Regex.Times <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> atms <span class=free>r</span> <span class=main>∪</span> atms <span class=free>s</span>"</span></span>
  <span class=quoted><span class=quoted>"atms <span class=main>(</span>Regex.Star <span class=free>r</span><span class=main>)</span> <span class=main>=</span> atms <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> atms_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> finite_atms<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>atms <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> disjE_Not2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>∨</span> <span class=free>Q</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>¬</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>R</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>lemma</span></span> safe_formula_induct<span class=main>[</span><span class=operator>consumes</span> 1<span class=main>,</span> <span class=operator>case_names</span> Eq_Const Eq_Var1 Eq_Var2 neq_Var Pred Let
    And_assign And_safe And_constraint And_Not Ands Neg Or Exists Agg
    Prev Next Since Not_Since Until Not_Until MatchP MatchF<span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Eq_Const<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>c</span> <span class=bound>d</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Eq <span class=main>(</span>Const <span class=bound>c</span><span class=main>)</span> <span class=main>(</span>Const <span class=bound>d</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Eq_Var1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>c</span> <span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Eq <span class=main>(</span>Const <span class=bound>c</span><span class=main>)</span> <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Eq_Var2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>c</span> <span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Eq <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span> <span class=main>(</span>Const <span class=bound>c</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> neq_Var<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Neg <span class=main>(</span>Eq <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span> <span class=main>(</span>Var <span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Pred<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>e</span> <span class=bound>ts</span><span class=main>.</span> <span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=bound>ts</span><span class=main>.</span> is_Var <span class=bound>t</span> <span class=main>∨</span> is_Const <span class=bound>t</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Pred <span class=bound>e</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Let<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>p</span> <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>.</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span>nfv <span class=bound>φ</span><span class=main>}</span> <span class=main>⊆</span> fv <span class=bound>φ</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Let <span class=bound>p</span> <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> And_assign<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>ψ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> safe_assignment <span class=main>(</span>fv <span class=bound>φ</span><span class=main>)</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>And <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> And_safe<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>ψ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=main>¬</span> safe_assignment <span class=main>(</span>fv <span class=bound>φ</span><span class=main>)</span> <span class=bound>ψ</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span>
      <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>And <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> And_constraint<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>ψ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=main>¬</span> safe_assignment <span class=main>(</span>fv <span class=bound>φ</span><span class=main>)</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=main>¬</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span>
      fv <span class=bound>ψ</span> <span class=main>⊆</span> fv <span class=bound>φ</span> <span class=main>⟹</span> is_constraint <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>And <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> And_Not<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>ψ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=main>¬</span> safe_assignment <span class=main>(</span>fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>Neg <span class=bound>ψ</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span> safe_formula <span class=main>(</span>Neg <span class=bound>ψ</span><span class=main>)</span> <span class=main>⟹</span>
      fv <span class=main>(</span>Neg <span class=bound>ψ</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=bound>φ</span> <span class=main>⟹</span> <span class=main>¬</span> is_constraint <span class=main>(</span>Neg <span class=bound>ψ</span><span class=main>)</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>And <span class=bound>φ</span> <span class=main>(</span>Neg <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Ands<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>l</span> <span class=bound>pos</span> <span class=bound>neg</span><span class=main>.</span> <span class=main>(</span><span class=bound>pos</span><span class=main>,</span> <span class=bound>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=bound>l</span> <span class=main>⟹</span> <span class=bound>pos</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span>
      list_all safe_formula <span class=bound>pos</span> <span class=main>⟹</span> list_all safe_formula <span class=main>(</span>map remove_neg <span class=bound>neg</span><span class=main>)</span> <span class=main>⟹</span>
      <span class=main>(</span><span class=main>⋃</span><span class=bound>φ</span><span class=main>∈</span>set <span class=bound>neg</span><span class=main>.</span> fv <span class=bound>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>φ</span><span class=main>∈</span>set <span class=bound>pos</span><span class=main>.</span> fv <span class=bound>φ</span><span class=main>)</span> <span class=main>⟹</span>
      list_all <span class=free>P</span> <span class=bound>pos</span> <span class=main>⟹</span> list_all <span class=free>P</span> <span class=main>(</span>map remove_neg <span class=bound>neg</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Ands <span class=bound>l</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Neg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> fv <span class=bound>φ</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Or<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>ψ</span><span class=main>.</span> fv <span class=bound>ψ</span> <span class=main>=</span> fv <span class=bound>φ</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Or <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Exists<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Exists <span class=bound>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Agg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>y</span> <span class=bound>ω</span> <span class=bound>b</span> <span class=bound>f</span> <span class=bound>φ</span><span class=main>.</span> <span class=bound>y</span> <span class=main>+</span> <span class=bound>b</span> <span class=main>∉</span> fv <span class=bound>φ</span> <span class=main>⟹</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=bound>b</span><span class=main>}</span> <span class=main>⊆</span> fv <span class=bound>φ</span> <span class=main>⟹</span> fv_trm <span class=bound>f</span> <span class=main>⊆</span> fv <span class=bound>φ</span> <span class=main>⟹</span>
      safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Agg <span class=bound>y</span> <span class=bound>ω</span> <span class=bound>b</span> <span class=bound>f</span> <span class=bound>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Prev<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>I</span> <span class=bound>φ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Prev <span class=bound>I</span> <span class=bound>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Next<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>I</span> <span class=bound>φ</span><span class=main>.</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Next <span class=bound>I</span> <span class=bound>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Since<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>.</span> fv <span class=bound>φ</span> <span class=main>⊆</span> fv <span class=bound>ψ</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Since <span class=bound>φ</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Not_Since<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>.</span> fv <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=bound>ψ</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span>
      <span class=main>¬</span> safe_formula <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Since <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span> <span class=bound>I</span> <span class=bound>ψ</span> <span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Until<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>.</span> fv <span class=bound>φ</span> <span class=main>⊆</span> fv <span class=bound>ψ</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Until <span class=bound>φ</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Not_Until<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>.</span> fv <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=bound>ψ</span> <span class=main>⟹</span> safe_formula <span class=bound>φ</span> <span class=main>⟹</span>
      <span class=main>¬</span> safe_formula <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span> <span class=main>⟹</span> safe_formula <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Until <span class=main>(</span>Neg <span class=bound>φ</span><span class=main>)</span> <span class=bound>I</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> MatchP<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>I</span> <span class=bound>r</span><span class=main>.</span> safe_regex Past Strict <span class=bound>r</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>φ</span> <span class=main>∈</span> atms <span class=bound>r</span><span class=main>.</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>MatchP <span class=bound>I</span> <span class=bound>r</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> MatchF<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>I</span> <span class=bound>r</span><span class=main>.</span> safe_regex Futu Strict <span class=bound>r</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>φ</span> <span class=main>∈</span> atms <span class=bound>r</span><span class=main>.</span> <span class=free>P</span> <span class=bound>φ</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>MatchF <span class=bound>I</span> <span class=bound>r</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>t1</span> <span class=skolem>t2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Eq_Const Eq_Var1 Eq_Var2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> trm.is_Const_def trm.is_Var_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>9 <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=main>(</span>And <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>φ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=main>(</span>And <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>consider</span></span>
    <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"safe_assignment <span class=main>(</span>fv <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>ψ</span>"</span></span>
    <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_assignment <span class=main>(</span>fv <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>ψ</span>"</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>ψ</span>"</span></span>
    <span class=main>|</span> <span class=main>(</span>c<span class=main>)</span> <span class=quoted><span class=quoted>"fv <span class=skolem>ψ</span> <span class=main>⊆</span> fv <span class=skolem>φ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_assignment <span class=main>(</span>fv <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_formula <span class=skolem>ψ</span>"</span></span> <span class=quoted><span class=quoted>"is_constraint <span class=skolem>ψ</span>"</span></span>
    <span class=main>|</span> <span class=main>(</span>d<span class=main>)</span> <span class=skolem>ψ'</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"fv <span class=skolem>ψ</span> <span class=main>⊆</span> fv <span class=skolem>φ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_assignment <span class=main>(</span>fv <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_formula <span class=skolem>ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> is_constraint <span class=skolem>ψ</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>ψ</span> <span class=main>=</span> Neg <span class=skolem>ψ'</span>"</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>ψ'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>ψ</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> a
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"9.IH"</span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> And_assign<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> b
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"9.IH"</span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> And_safe<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> c
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"9.IH"</span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> And_constraint<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> d
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"9.IH"</span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> And_Not<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>10 <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=skolem><span class=skolem>neg</span></span> <span class=keyword2><span class=keyword>where</span></span> posneg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>pos</span><span class=main>,</span> <span class=skolem>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.prems"</span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=skolem>pos</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> safe_remove_neg<span class=main>:</span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.prems"</span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=skolem>pos</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> posneg <span class=quoted>"10.IH"</span><span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.IH"</span><span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> posneg<span class=main>]</span> safe_remove_neg <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.IH"</span><span class=main>(</span>1<span class=main>)</span> <span class=quoted>"10.prems"</span> Ands posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>15 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>φ</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"15.IH"</span><span class=main>(</span>1<span class=main>)</span> <span class=quoted>"15.IH"</span><span class=main>(</span>3<span class=main>)</span> <span class=quoted>"15.prems"</span> Since <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Since Not_Since<span class=main>)</span> <span class=comment1>(*SLOW*)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>16 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>φ</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"16.IH"</span><span class=main>(</span>1<span class=main>)</span> <span class=quoted>"16.IH"</span><span class=main>(</span>3<span class=main>)</span> <span class=quoted>"16.prems"</span> Until <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Until Not_Until<span class=main>)</span> <span class=comment1>(*SLOW*)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>17 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> MatchP<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>18 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> MatchF<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> assms<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_formula_NegD<span class=main>:</span>
  <span class=quoted><span class=quoted>"safe_formula <span class=main>(</span>Formula.Neg <span class=free>φ</span><span class=main>)</span> <span class=main>⟹</span> fv <span class=free>φ</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=free>φ</span> <span class=main>=</span> Formula.Eq <span class=main>(</span>Formula.Var <span class=bound>x</span><span class=main>)</span> <span class=main>(</span>Formula.Var <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=quoted>"Formula.Neg <span class=free>φ</span>"</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula_induct<span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Slicing traces›</span></span>

<span class=keyword2><span class=keyword>qualified</span></span> <span class=keyword1><span class=command>fun</span></span> <span class=entity>matches</span> <span class=main>::</span>
  <span class=quoted><span class=quoted>"env <span class=main>⇒</span> formula <span class=main>⇒</span> name <span class=main>×</span> event_data list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Pred <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span>fst <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> map <span class=main>(</span>eval_trm <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span> snd <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=main>(</span><span class=main>∃</span><span class=bound>v'</span><span class=main>.</span> <span class=free>matches</span> <span class=bound>v'</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>∧</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span> <span class=bound>v'</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span>
    fst <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>≠</span> <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>∧</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Eq <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Less <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>LessEq <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> False"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>∨</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>∨</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>φ</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>.</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=free>matches</span> <span class=main>(</span><span class=bound>z</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>zs</span><span class=main>.</span> length <span class=bound>zs</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>∧</span> <span class=free>matches</span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>∨</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>∨</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>φ</span> <span class=main>∈</span> Regex.atms <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>.</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>(</span>MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>φ</span> <span class=main>∈</span> Regex.atms <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>.</span> <span class=free>matches</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> matches_cong<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=free>φ</span><span class=main>.</span> <span class=free>v</span><span class=main>!</span><span class=bound>x</span> <span class=main>=</span> <span class=free>v'</span><span class=main>!</span><span class=bound>x</span> <span class=main>⟹</span> matches <span class=free>v</span> <span class=free>φ</span> <span class=free>e</span> <span class=main>=</span> matches <span class=free>v'</span> <span class=free>φ</span> <span class=free>e</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>v'</span></span> <span class=quoted><span class=free>e</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>n</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> map_cong eval_trm_fv_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> Pred<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>[</span></span></span><span class=operator>simplified</span><span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>THEN</span> bspec<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>b</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>e</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 11 0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> <span class=bound>φ</span> <span class=main>∈</span> <span class=main>(</span>set <span class=skolem>l</span><span class=main>)</span> <span class=main>⟹</span> matches <span class=skolem>v</span> <span class=bound>φ</span> <span class=skolem>e</span> <span class=main>=</span> matches <span class=skolem>v'</span> <span class=bound>φ</span> <span class=skolem>e</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>φ</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> <span class=main>(</span>set <span class=skolem>l</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv <span class=skolem>φ</span> <span class=main>⊆</span> fv <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> fv_subset_Ands <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=skolem>φ</span><span class=main>.</span> <span class=skolem>v</span><span class=main>!</span><span class=bound>x</span> <span class=main>=</span> <span class=skolem>v'</span><span class=main>!</span><span class=bound>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Ands.prems <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"matches <span class=skolem>v</span> <span class=skolem>φ</span> <span class=skolem>e</span> <span class=main>=</span> matches <span class=skolem>v'</span> <span class=skolem>φ</span> <span class=skolem>e</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Ands.hyps <span class=quoted><span class=quoted>‹<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> matches.simps <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> iff_exI<span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_Suc nth_Cons'<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"matches <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>φ</span> <span class=skolem>e</span> <span class=main>=</span> matches <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v'</span><span class=main>)</span> <span class=skolem>φ</span> <span class=skolem>e</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
    <span class=keyword1><span class=command>using</span></span> that Agg.prems <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Agg.hyps<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> v<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> v'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v'</span>"</span></span><span class=main><span class=main>]</span></span>
        nth_append fvi_iff_fv<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> 9 0 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nth_Cons' fv_regex_alt<span class=main>)</span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>relevant_events</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>relevant_events</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>S</span></span></span> <span class=main>≡</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>S</span></span></span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=bound>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> sat_slice_strong<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> <span class=free>S</span>"</span></span> <span class=quoted><span class=quoted>"dom <span class=free>V</span> <span class=main>=</span> dom <span class=free>V'</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>p</span> <span class=bound>v</span> <span class=bound>i</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> dom <span class=free>V</span> <span class=main>⟹</span> <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>v</span><span class=main>)</span> <span class=main>∈</span> relevant_events <span class=free>φ</span> <span class=free>S</span> <span class=main>⟹</span> <span class=bound>v</span> <span class=main>∈</span> the <span class=main>(</span><span class=free>V</span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span> <span class=main>⟷</span> <span class=bound>v</span> <span class=main>∈</span> the <span class=main>(</span><span class=free>V'</span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"relevant_events <span class=free>φ</span> <span class=free>S</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> fst <span class=bound>e</span> <span class=main>∈</span> dom <span class=free>V</span><span class=main>}</span> <span class=main>⊆</span> <span class=free>E</span> <span class=main>⟹</span>
    sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span> sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=free>V'</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>V</span></span> <span class=quoted><span class=free>V'</span></span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>S</span></span> <span class=quoted><span class=free>i</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>r</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>V</span> <span class=skolem>r</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> None
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>V'</span> <span class=skolem>r</span> <span class=main>=</span> None"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹dom <span class=skolem>V</span> <span class=main>=</span> dom <span class=skolem>V'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> None Pred<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> domIff <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> subsetD<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>a</span><span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>V'</span> <span class=skolem>r</span> <span class=main>=</span> Some <span class=skolem>a'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Some <span class=quoted><span class=quoted>‹dom <span class=skolem>V</span> <span class=main>=</span> dom <span class=skolem>V'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>map <span class=main>(</span>eval_trm <span class=skolem>v</span><span class=main>)</span> <span class=skolem>ts</span> <span class=main>∈</span> the <span class=main>(</span><span class=skolem>V</span> <span class=skolem>r</span><span class=main>)</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>map <span class=main>(</span>eval_trm <span class=skolem>v</span><span class=main>)</span> <span class=skolem>ts</span> <span class=main>∈</span> the <span class=main>(</span><span class=skolem>V'</span> <span class=skolem>r</span><span class=main>)</span> <span class=skolem>i</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Some Pred<span class=main>(</span>2<span class=main>,</span>4<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> domI<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat.simps
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> Let<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> relevant v dom V<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>V <span class=skolem>p'</span> <span class=skolem>v'</span> <span class=skolem>i</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>=</span> <span class=skolem>p</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> True
      <span class=keyword1><span class=command>with</span></span> V <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fun_upd_apply eqTrueI<span class=main>[</span><span class=operator>OF</span> True<span class=main>]</span> if_True option.sel mem_Collect_eq
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> ex_cong conj_cong refl Let<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span>
        S<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>v'</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>v</span> <span class=main>∈</span> <span class=skolem>S</span><span class=main>.</span> matches <span class=bound>v</span> <span class=skolem>ψ</span> <span class=main>(</span><span class=skolem>p</span><span class=main>,</span> <span class=bound>v'</span><span class=main>)</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> V<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>V</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
        <span class=operator>goal_cases</span> relevant' v' dom' V'<span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> relevant'
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>elim</span> subset_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> set_eq_iff<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>V' <span class=skolem>p'</span> <span class=skolem>v'</span> <span class=skolem>i</span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> V<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> set_eq_iff<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> V<span class=main>(</span>2<span class=main>,</span>3<span class=main>,</span>5<span class=main>,</span>6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fun_upd_apply eq_False<span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>,</span> <span class=operator>OF</span> False<span class=main>]</span> if_False
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> V<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> False<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> dom_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Or <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Or.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>S</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>V</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>v</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>V'</span></span></span></span><span class=main>]</span> Or.prems
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> And.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>S</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>V</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>v</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>V'</span></span></span></span><span class=main>]</span> And.prems
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=quoted><span class=quoted>"relevant_events <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=skolem>S</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> fst <span class=bound>e</span> <span class=main>∈</span> dom <span class=skolem>V</span><span class=main>}</span> <span class=main>⊆</span> <span class=free>E</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=skolem>S</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Ands.prems<span class=main>(</span>1<span class=main>)</span> Ands.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>e</span><span class=main>.</span> <span class=skolem>S</span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=bound>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> fst <span class=bound>e</span> <span class=main>∈</span> dom <span class=skolem>V</span><span class=main>}</span> <span class=main>⊆</span> <span class=free>E</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> <span class=bound>φ</span> <span class=main>∈</span> set <span class=skolem>l</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=bound>φ</span> <span class=main>⟷</span> sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=bound>φ</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>φ</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"relevant_events <span class=skolem>φ</span> <span class=skolem>S</span> <span class=main>=</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> <span class=skolem>S</span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=skolem>φ</span> <span class=bound>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>e</span><span class=main>.</span> <span class=skolem>S</span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=skolem>φ</span> <span class=bound>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span> <span class=main>⊆</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> <span class=skolem>S</span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=bound>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>⊆</span> <span class=var>?B</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> subsetI<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>e</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>S</span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=skolem>φ</span> <span class=skolem>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>S</span> <span class=main>∩</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> matches <span class=bound>v</span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=skolem>e</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"matches <span class=skolem>v</span> <span class=skolem>φ</span> <span class=skolem>e</span>"</span></span> <span class=keyword1><span class=command>using</span></span> calculation <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"relevant_events <span class=skolem>φ</span> <span class=skolem>S</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>.</span> fst <span class=bound>e</span> <span class=main>∈</span> dom <span class=skolem>V</span><span class=main>}</span> <span class=main>⊆</span> <span class=free>E</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Ands.prems<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=skolem>φ</span> <span class=main>⟷</span> sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=skolem>φ</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Ands.prems<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Ands.IH<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>φ</span></span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>V</span></span> <span class=quoted><span class=skolem>v</span></span> <span class=quoted><span class=skolem>V'</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main><span class=main>]</span></span> Ands.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> <span class=bound>φ</span> <span class=main>∈</span> set <span class=skolem>l</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=bound>φ</span> <span class=main>=</span> sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=skolem>v</span> <span class=skolem>i</span> <span class=bound>φ</span>›</span></span> sat_Ands <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span><span class=skolem>z</span> <span class=main>#</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ</span> <span class=main>=</span> sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=main>(</span><span class=skolem>z</span> <span class=main>#</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> Exists.prems<span class=main>(</span>1-3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Exists.IH<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> S<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=skolem>z</span> <span class=main>#</span> <span class=bound>v</span> <span class=main>|</span> <span class=bound>v</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> <span class=skolem>S</span><span class=main>}</span>"</span></span><span class=main><span class=main>]</span></span> Exists.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ</span> <span class=main>=</span> sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
    <span class=keyword1><span class=command>using</span></span> that Agg.prems<span class=main>(</span>1-3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Agg.IH<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> S<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=skolem>zs</span> <span class=main>@</span> <span class=bound>v</span> <span class=main>|</span> <span class=bound>v</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> <span class=skolem>S</span><span class=main>}</span>"</span></span><span class=main><span class=main>]</span></span> Agg.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> conj_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Prev <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> nat.case_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Next <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Since <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Since.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>S</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>V</span></span></span></span><span class=main>]</span> Since.prems
   <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Until.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>S</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>V</span></span></span></span><span class=main>]</span> Until.prems
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchP.prems<span class=main>(</span>1-3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Regex.match_fv_cong MatchP<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>V</span></span> <span class=quoted><span class=skolem>v</span></span><span class=main><span class=main>]</span></span> MatchP.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchF.prems<span class=main>(</span>1-3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=main>(</span>map_Γ <span class=main>(</span><span class=main>λ</span><span class=bound>D</span><span class=main>.</span> <span class=bound>D</span> <span class=main>∩</span> <span class=free>E</span><span class=main>)</span> <span class=free>σ</span><span class=main>)</span> <span class=skolem>V'</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Regex.match_fv_cong MatchF<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>V</span></span> <span class=quoted><span class=skolem>v</span></span><span class=main><span class=main>]</span></span> MatchF.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp_all</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Translation to n-ary conjunction›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>get_and_list</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> formula list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>get_and_list</span> <span class=main>(</span>Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>l</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>get_and_list</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>]</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fv_get_and<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> fvi <span class=free>b</span> <span class=bound>x</span><span class=main>)</span> <span class=main>=</span> fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> get_and_list.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> safe_get_and<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> list_all safe_neg <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> get_and_list.induct<span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_neg_def list_all_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sat_get_and<span class=main>:</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span> list_all <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span><span class=main>)</span> <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> get_and_list.induct<span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>convert_multiway</span> <span class=main>::</span> <span class=quoted><span class=quoted>"formula <span class=main>⇒</span> formula"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> Neg <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> Or <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_assignment <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>then</span>
      And <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> safe_formula <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>then</span>
      Ands <span class=main>(</span>get_and_list <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>@</span> get_and_list <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> is_constraint <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>then</span>
      And <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>
    <span class=keyword1>else</span> Ands <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>#</span> get_and_list <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> Exists <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> Since <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> Until <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span>Regex.map_regex <span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=main>(</span>MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span>Regex.map_regex <span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>convert_multiway_regex</span> <span class=main>≡</span> Regex.map_regex convert_multiway"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fv_safe_get_and<span class=main>:</span>
  <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> fv <span class=free>φ</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=main>(</span>filter safe_formula <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> get_and_list.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=skolem><span class=skolem>neg</span></span> <span class=keyword2><span class=keyword>where</span></span> posneg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>pos</span><span class=main>,</span> <span class=skolem>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"get_and_list <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> sub<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>neg</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>pos</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"1.prems"</span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>pos</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>pos</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>neg</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> sub <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> ex_safe_get_and<span class=main>:</span>
  <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> list_ex safe_formula <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> get_and_list.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"get_and_list <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=skolem><span class=skolem>neg</span></span> <span class=keyword2><span class=keyword>where</span></span> posneg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>pos</span><span class=main>,</span> <span class=skolem>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"1.prems"</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>pos</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>using</span></span> Bex_set_list_ex <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> case_NegE<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> <span class=free>φ</span> <span class=keyword1>of</span> Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>P</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>φ'</span><span class=main>.</span> <span class=free>φ</span> <span class=main>=</span> Neg <span class=bound>φ'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>φ'</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> convert_multiway_remove_neg<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=main>(</span>remove_neg <span class=free>φ</span><span class=main>)</span> <span class=main>⟹</span> convert_multiway <span class=main>(</span>remove_neg <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> remove_neg <span class=main>(</span>convert_multiway <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> case_NegE<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fv_convert_multiway<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> fvi <span class=free>b</span> <span class=main>(</span>convert_multiway <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>b</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>9 <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>ψ</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_get_and Un_commute<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>15 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>φ</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> 15 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> <span class=quoted>"15.prems"</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>=</span> Neg <span class=skolem>φ'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> False 15 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>16 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>φ</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> 16 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> <span class=quoted>"16.prems"</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>=</span> Neg <span class=skolem>φ'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> False 16 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>17 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> convert_multiway.simps fvi.simps fv_regex_alt regex.set_map image_image
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted>Union</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> image_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> refl<span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>18 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> convert_multiway.simps fvi.simps fv_regex_alt regex.set_map image_image
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted>Union</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> image_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> refl<span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> convert_multiway.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> get_and_nonempty<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"get_and_list <span class=free>φ</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> future_bounded_get_and<span class=main>:</span>
  <span class=quoted><span class=quoted>"list_all future_bounded <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> future_bounded <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> safe_convert_multiway<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> safe_formula <span class=main>(</span>convert_multiway <span class=free>φ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_safe <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And <span class=skolem>φ</span> <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=var>?a</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cφ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>φ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> b_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>=</span> Ands <span class=main>(</span>get_and_list <span class=var>?cφ</span> <span class=main>@</span> get_and_list <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_safe <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?l</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"get_and_list <span class=var>?cφ</span> <span class=main>@</span> get_and_list <span class=var>?cψ</span>"</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=skolem><span class=skolem>neg</span></span> <span class=keyword2><span class=keyword>where</span></span> posneg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>pos</span><span class=main>,</span> <span class=skolem>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=var>?l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=skolem>pos</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> lsafe_neg<span class=main>:</span> <span class=quoted><span class=quoted>"list_all safe_neg <span class=var>?l</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> And_safe <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_get_and<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=skolem>neg</span> <span class=main>⟹</span> safe_formula <span class=main>(</span>remove_neg <span class=bound>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>neg</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_formula <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_neg <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> lsafe_neg <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>neg</span>›</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> safe_neg_def list_all_iff partition_set<span class=main>[</span><span class=operator>OF</span> posneg<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=main>(</span>remove_neg <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> safe_neg_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>

    <span class=keyword1><span class=command>have</span></span> pos_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> filter safe_formula <span class=main>(</span>get_and_list <span class=var>?cφ</span> <span class=main>@</span> get_and_list <span class=var>?cψ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>neg</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>pos</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fv <span class=var>?cφ</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=main>(</span>filter safe_formula <span class=main>(</span>get_and_list <span class=var>?cφ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>⊆</span> <span class=var>?fvφ</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span> And_safe <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> fv_safe_get_and<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fv <span class=var>?cψ</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=main>(</span>filter safe_formula <span class=main>(</span>get_and_list <span class=var>?cψ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>⊆</span> <span class=var>?fvψ</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span> And_safe <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> fv_safe_get_and<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>neg</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=var>?cφ</span> <span class=main>∪</span> fv <span class=var>?cψ</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>neg</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> <span class=main>(</span>set <span class=skolem>pos</span> <span class=main>∪</span> set <span class=skolem>neg</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⊆</span> fv <span class=main>(</span>convert_multiway <span class=skolem>φ</span><span class=main>)</span> <span class=main>∪</span> fv <span class=main>(</span>convert_multiway <span class=skolem>ψ</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> partition_set<span class=main>[</span><span class=operator>OF</span> posneg<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>simplified</span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fv_get_and<span class=main>)</span>
        <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>neg</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=var>?fvφ</span> <span class=main>∪</span> <span class=var>?fvψ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> pos_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=main>(</span>get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>x</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> And_safe <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> ex_safe_get_and <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_ex_iff<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> pos_filter <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> filter_empty_conv<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> b_def
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>neg</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>pos</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>›</span></span>
        <span class=quoted><span class=quoted>‹list_all safe_formula <span class=skolem>pos</span>›</span></span> posneg
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_Not <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And <span class=skolem>φ</span> <span class=main>(</span>Neg <span class=skolem>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=var>?a</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cφ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>φ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> b_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>=</span> Ands <span class=main>(</span>Neg <span class=var>?cψ</span> <span class=main>#</span> get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_Not <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?l</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Neg <span class=var>?cψ</span> <span class=main>#</span> get_and_list <span class=var>?cφ</span>"</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=var>?cφ</span>›</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_neg <span class=main>(</span>get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_get_and<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_neg <span class=main>(</span>Neg <span class=var>?cψ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=var>?cψ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_neg_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> lsafe_neg<span class=main>:</span> <span class=quoted><span class=quoted>"list_all safe_neg <span class=var>?l</span>"</span></span> <span class=keyword1><span class=command>using</span></span> calculation <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=skolem><span class=skolem>neg</span></span> <span class=keyword2><span class=keyword>where</span></span> posneg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>pos</span><span class=main>,</span> <span class=skolem>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=var>?l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=skolem>pos</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=main>(</span>set <span class=skolem>neg</span><span class=main>)</span> <span class=main>⟹</span> safe_formula <span class=main>(</span>remove_neg <span class=bound>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>neg</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> safe_formula <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> filter.simps<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_neg <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> lsafe_neg <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>neg</span>›</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> safe_neg_def list_all_iff partition_set<span class=main>[</span><span class=operator>OF</span> posneg<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=main>(</span>remove_neg <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> safe_neg_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Ball_set_list_all <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>qed</span></span>

    <span class=keyword1><span class=command>have</span></span> pos_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> filter safe_formula <span class=var>?l</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> neg_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>neg</span> <span class=main>=</span> filter <span class=main>(</span>Not <span class=main>∘</span> safe_formula<span class=main>)</span> <span class=var>?l</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=skolem>neg</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=skolem>pos</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> fv_neg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=skolem>neg</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=var>?l</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posneg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=var>?l</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=var>?cφ</span> <span class=main>∪</span> fv <span class=var>?cψ</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fv_get_and fv_convert_multiway<span class=main>)</span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv <span class=var>?cφ</span> <span class=main>∪</span> fv <span class=var>?cψ</span> <span class=main>⊆</span> fv <span class=var>?cφ</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span> <span class=quoted><span class=quoted>‹fv <span class=main>(</span>Neg <span class=skolem>ψ</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=skolem>φ</span>›</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fv_convert_multiway<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=main>(</span>set <span class=skolem>neg</span><span class=main>)</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> fv <span class=var>?cφ</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> fv_neg <span class=keyword1><span class=command>unfolding</span></span> neg_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> pos_filter
        <span class=keyword1><span class=command>using</span></span> fv_safe_get_and<span class=main>[</span><span class=operator>OF</span> And_Not.IH<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=main>(</span>get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>x</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> And_Not.IH <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> ex_safe_get_and <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_ex_iff<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> pos_filter <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> filter_empty_conv<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> b_def
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>neg</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>pos</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>›</span></span>
        <span class=quoted><span class=quoted>‹list_all safe_formula <span class=skolem>pos</span>›</span></span> posneg
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Neg <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=main>(</span>Neg <span class=skolem>φ'</span><span class=main>)</span> <span class=main>⟷</span> safe_formula <span class=skolem>φ'</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"fv <span class=skolem>φ'</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ'</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Neg <span class=skolem>φ'</span>"</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula.cases<span class=main>)</span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>with</span></span> Neg <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fv_convert_multiway<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def fv_convert_multiway <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_map_regex
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 case_NegE
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def fv_convert_multiway <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_map_regex
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 case_NegE
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_convert_multiway<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> future_bounded_convert_multiway<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> future_bounded <span class=main>(</span>convert_multiway <span class=free>φ</span><span class=main>)</span> <span class=main>=</span> future_bounded <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_safe <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And <span class=skolem>φ</span> <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=var>?a</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cφ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>φ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> b_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>=</span> Ands <span class=main>(</span>get_and_list <span class=var>?cφ</span> <span class=main>@</span> get_and_list <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_safe <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?a</span> <span class=main>=</span> <span class=main>(</span>future_bounded <span class=var>?cφ</span> <span class=main>∧</span> future_bounded <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_safe <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?cφ</span> <span class=main>=</span> list_all future_bounded <span class=main>(</span>get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> future_bounded_get_and safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?cψ</span> <span class=main>=</span> list_all future_bounded <span class=main>(</span>get_and_list <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> future_bounded_get_and safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?b</span> <span class=main>=</span> list_all future_bounded <span class=main>(</span>get_and_list <span class=var>?cφ</span> <span class=main>@</span> get_and_list <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> b_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_Not <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And <span class=skolem>φ</span> <span class=main>(</span>Neg <span class=skolem>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=var>?a</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cφ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>φ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> b_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>=</span> Ands <span class=main>(</span>Neg <span class=var>?cψ</span> <span class=main>#</span> get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_Not <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?a</span> <span class=main>=</span> <span class=main>(</span>future_bounded <span class=var>?cφ</span> <span class=main>∧</span> future_bounded <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_Not <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?cφ</span> <span class=main>=</span> list_all future_bounded <span class=main>(</span>get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> future_bounded_get_and safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"future_bounded <span class=var>?b</span> <span class=main>=</span> list_all future_bounded <span class=main>(</span>Neg <span class=var>?cψ</span> <span class=main>#</span> get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> b_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.pred_map o_def<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def regex.pred_set regex.set_map ball_Un
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main><span class=main>[</span></span><span class=operator>THEN</span> disjE_Not2<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def regex.pred_set regex.set_map ball_Un
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main><span class=main>[</span></span><span class=operator>THEN</span> disjE_Not2<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_convert_multiway<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=main>(</span>convert_multiway <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_safe <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And <span class=skolem>φ</span> <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=var>?a</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?la</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"get_and_list <span class=main>(</span>convert_multiway <span class=skolem>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?lb</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"get_and_list <span class=main>(</span>convert_multiway <span class=skolem>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?sat</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=skolem>v</span> <span class=skolem>i</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> b_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>=</span> Ands <span class=main>(</span><span class=var>?la</span> <span class=main>@</span> <span class=var>?lb</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> And_safe <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=var>?sat</span> <span class=var>?la</span> <span class=main>⟷</span> <span class=var>?sat</span> <span class=skolem>φ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> And_safe sat_get_and <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=var>?sat</span> <span class=var>?lb</span> <span class=main>⟷</span> <span class=var>?sat</span> <span class=skolem>ψ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> And_safe sat_get_and <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> And_safe <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_Not <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And <span class=skolem>φ</span> <span class=main>(</span>Neg <span class=skolem>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=var>?a</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?la</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"get_and_list <span class=main>(</span>convert_multiway <span class=skolem>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?lb</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?sat</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"sat <span class=free>σ</span> <span class=free>V</span> <span class=skolem>v</span> <span class=skolem>i</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> b_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>=</span> Ands <span class=main>(</span>Neg <span class=var>?lb</span> <span class=main>#</span> <span class=var>?la</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> And_Not <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=var>?sat</span> <span class=var>?la</span> <span class=main>⟷</span> <span class=var>?sat</span> <span class=skolem>φ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> And_Not sat_get_and <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> And_Not <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nfv_def fv_convert_multiway <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> conj_cong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=main>(</span>convert_multiway_regex <span class=skolem>r</span><span class=main>)</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> match_map_regex
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Regex.match_fv_cong<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=main>(</span>convert_multiway_regex <span class=skolem>r</span><span class=main>)</span> <span class=main>=</span> Regex.match <span class=main>(</span>sat <span class=free>σ</span> <span class=free>V</span> <span class=skolem>v</span><span class=main>)</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> match_map_regex
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Regex.match_fv_cong<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> nat.case_cong<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(*context*)</span>

<span class=keyword1><span class=command>interpretation</span></span> Formula_slicer<span class=main>:</span> abstract_slicer <span class=quoted><span class=quoted>"relevant_events <span class=free>φ</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=free>φ</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> sat_slice_iff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> <span class=free>S</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span> Formula.sat <span class=main>(</span>Formula_slicer.slice <span class=free>φ</span> <span class=free>S</span> <span class=free>σ</span><span class=main>)</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sat_slice_strong<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> Neg_splits<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>φ</span> <span class=keyword1>of</span> formula.Neg <span class=bound>ψ</span> <span class=main>⇒</span> <span class=free>f</span> <span class=bound>ψ</span> <span class=main>|</span> <span class=bound>φ</span> <span class=main>⇒</span> <span class=free>g</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span>
   <span class=main>(</span><span class=main>(</span><span class=main>∀</span><span class=bound>ψ</span><span class=main>.</span> <span class=free>φ</span> <span class=main>=</span> formula.Neg <span class=bound>ψ</span> <span class=main>⟶</span> <span class=free>P</span> <span class=main>(</span><span class=free>f</span> <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=main>¬</span> Formula.is_Neg <span class=free>φ</span><span class=main>)</span> <span class=main>⟶</span> <span class=free>P</span> <span class=main>(</span><span class=free>g</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>φ</span> <span class=keyword1>of</span> formula.Neg <span class=bound>ψ</span> <span class=main>⇒</span> <span class=free>f</span> <span class=bound>ψ</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=free>g</span> <span class=free>φ</span><span class=main>)</span> <span class=main>=</span>
   <span class=main>(</span><span class=main>¬</span> <span class=main>(</span><span class=main>(</span><span class=main>∃</span><span class=bound>ψ</span><span class=main>.</span> <span class=free>φ</span> <span class=main>=</span> formula.Neg <span class=bound>ψ</span> <span class=main>∧</span> <span class=main>¬</span> <span class=free>P</span> <span class=main>(</span><span class=free>f</span> <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=main>(</span><span class=main>¬</span> Formula.is_Neg <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span> <span class=free>P</span> <span class=main>(</span><span class=free>g</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Formula.is_Neg_def<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Optimized_Join><div class=head><h1>Theory Optimized_Join</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Optimized_Join
  <span class=keyword2><span class=keyword>imports</span></span> <span class=quoted>"<a href=../Generic_Join/Generic_Join_Correctness.html>Generic_Join.Generic_Join_Correctness</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Optimized relational join›</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Binary join›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>join_mask</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> nat set <span class=main>⇒</span> bool list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>join_mask</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>=</span> map <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>[</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>]</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>proj_tuple</span> <span class=main>::</span> <span class=quoted><span class=quoted>"bool list <span class=main>⇒</span> <span class=tfree>'a</span> tuple <span class=main>⇒</span> <span class=tfree>'a</span> tuple"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>proj_tuple</span> <span class=main>[]</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>proj_tuple</span> <span class=main>(</span>True <span class=main>#</span> <span class=free><span class=bound><span class=entity>bs</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free>proj_tuple</span> <span class=free><span class=bound><span class=entity>bs</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>proj_tuple</span> <span class=main>(</span>False <span class=main>#</span> <span class=free><span class=bound><span class=entity>bs</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> None <span class=main>#</span> <span class=free>proj_tuple</span> <span class=free><span class=bound><span class=entity>bs</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>proj_tuple</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>bs</span></span></span><span class=main>)</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>proj_tuple</span> <span class=main>[]</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> proj_tuple_replicate<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> set <span class=free>bs</span> <span class=main>⟹</span> <span class=main>¬</span><span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> length <span class=free>bs</span> <span class=main>=</span> length <span class=free>as</span> <span class=main>⟹</span>
  proj_tuple <span class=free>bs</span> <span class=free>as</span> <span class=main>=</span> replicate <span class=main>(</span>length <span class=free>bs</span><span class=main>)</span> None"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>bs</span></span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> proj_tuple.induct<span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> proj_tuple_join_mask_empty<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>=</span> <span class=free>n</span> <span class=main>⟹</span>
  proj_tuple <span class=main>(</span>join_mask <span class=free>n</span> <span class=main>{}</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> replicate <span class=free>n</span> None"</span></span>
  <span class=keyword1><span class=command>using</span></span> proj_tuple_replicate<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"join_mask <span class=free>n</span> <span class=main>{}</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> join_mask_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> proj_tuple_alt<span class=main>:</span> <span class=quoted><span class=quoted>"proj_tuple <span class=free>bs</span> <span class=free>as</span> <span class=main>=</span> map2 <span class=main>(</span><span class=main>λ</span><span class=bound>b</span> <span class=bound>a</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>b</span> <span class=keyword1>then</span> <span class=bound>a</span> <span class=keyword1>else</span> None<span class=main>)</span> <span class=free>bs</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>bs</span></span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> proj_tuple.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> map2_map<span class=main>:</span> <span class=quoted><span class=quoted>"map2 <span class=free>f</span> <span class=main>(</span>map <span class=free>g</span> <span class=main>[</span><span class=main>0</span><span class=main>..&lt;</span>length <span class=free>as</span><span class=main>]</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> map <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=free>f</span> <span class=main>(</span><span class=free>g</span> <span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=free>as</span> <span class=main>!</span> <span class=bound>i</span><span class=main>)</span><span class=main>)</span> <span class=main>[</span><span class=main>0</span><span class=main>..&lt;</span>length <span class=free>as</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> nth_equalityI<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> proj_tuple_join_mask_restrict<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>=</span> <span class=free>n</span> <span class=main>⟹</span>
  proj_tuple <span class=main>(</span>join_mask <span class=free>n</span> <span class=free>X</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> restrict <span class=free>X</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> restrict_def proj_tuple_alt join_mask_def map2_map<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_proj_idle<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> wf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>X</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"proj_tuple <span class=main>(</span>join_mask <span class=free>n</span> <span class=free>X</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> proj_tuple_join_mask_restrict<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>X</span></span><span class=main>,</span> <span class=operator>unfolded</span> restrict_idle<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf<span class=main><span class=main>]</span></span><span class=main>]</span> wf
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_change_base<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> wf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>X</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> mask<span class=main>:</span> <span class=quoted><span class=quoted>"join_mask <span class=free>n</span> <span class=free>X</span> <span class=main>=</span> join_mask <span class=free>n</span> <span class=free>Y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>Y</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> wf mask <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def join_mask_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>proj_tuple_in_join</span> <span class=main>::</span> <span class=quoted><span class=quoted>"bool <span class=main>⇒</span> bool list <span class=main>⇒</span> <span class=tfree>'a</span> tuple <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>proj_tuple_in_join</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>bs</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> proj_tuple <span class=free><span class=bound><span class=entity>bs</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=keyword1>else</span> proj_tuple <span class=free><span class=bound><span class=entity>bs</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=main>∉</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>join_cond</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span><span class=bound>as</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=bound>as</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=keyword1>else</span> <span class=bound>as</span> <span class=main>∉</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>join_filter_cond</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> join_cond <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=bound>as</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> proj_tuple_in_join_mask_idle<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> wf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>X</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"proj_tuple_in_join <span class=free>pos</span> <span class=main>(</span>join_mask <span class=free>n</span> <span class=free>X</span><span class=main>)</span> <span class=free>as</span> <span class=free>t</span> <span class=main>⟷</span> join_cond <span class=free>pos</span> <span class=free>t</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> wf_tuple_proj_idle<span class=main>[</span><span class=operator>OF</span> wf<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> proj_tuple_in_join_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> join_sub<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>L</span> <span class=main>⊆</span> <span class=free>R</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>L</span> <span class=free>t1</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>R</span> <span class=free>t2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"join <span class=free>t2</span> <span class=free>pos</span> <span class=free>t1</span> <span class=main>=</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=free>t2</span><span class=main>.</span> proj_tuple_in_join <span class=free>pos</span> <span class=main>(</span>join_mask <span class=free>n</span> <span class=free>L</span><span class=main>)</span> <span class=bound>as</span> <span class=free>t1</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms proj_tuple_join_mask_restrict<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>L</span></span><span class=main>]</span> join_restrict<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>t2</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>L</span></span> <span class=quoted><span class=free>pos</span></span><span class=main>]</span>
    wf_tuple_length restrict_idle
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def proj_tuple_in_join_def sup.absorb1<span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> join_sub'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span> <span class=main>⊆</span> <span class=free>L</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>L</span> <span class=free>t1</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>R</span> <span class=free>t2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"join <span class=free>t2</span> True <span class=free>t1</span> <span class=main>=</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=free>t1</span><span class=main>.</span> proj_tuple_in_join True <span class=main>(</span>join_mask <span class=free>n</span> <span class=free>R</span><span class=main>)</span> <span class=bound>as</span> <span class=free>t2</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms proj_tuple_join_mask_restrict<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>R</span></span><span class=main>]</span> join_restrict<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>t2</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>L</span></span> <span class=quoted>True</span><span class=main>]</span>
    wf_tuple_length restrict_idle
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def proj_tuple_in_join_def sup.absorb1 Un_absorb1<span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> join_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> tab<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>R</span> <span class=free>t1</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>R</span> <span class=free>t2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"join <span class=free>t2</span> <span class=free>pos</span> <span class=free>t1</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>pos</span> <span class=keyword1>then</span> <span class=free>t2</span> <span class=main>∩</span> <span class=free>t1</span> <span class=keyword1>else</span> <span class=free>t2</span> <span class=main>-</span> <span class=free>t1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> join_sub<span class=main>[</span><span class=operator>OF</span> _ tab<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>pos</span></span><span class=main>]</span> tab<span class=main>(</span>2<span class=main>)</span> proj_tuple_in_join_mask_idle<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>R</span></span> <span class=main>_</span> <span class=quoted><span class=free>pos</span></span> <span class=quoted><span class=free>t1</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> join_no_cols<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> tab<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=main>{}</span> <span class=free>t1</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>R</span> <span class=free>t2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"join <span class=free>t2</span> <span class=free>pos</span> <span class=free>t1</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=free>pos</span> <span class=main>⟷</span> replicate <span class=free>n</span> None <span class=main>∈</span> <span class=free>t1</span><span class=main>)</span> <span class=keyword1>then</span> <span class=free>t2</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> join_sub<span class=main>[</span><span class=operator>OF</span> _ tab<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>pos</span></span><span class=main>]</span> tab<span class=main>(</span>2<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def proj_tuple_in_join_def wf_tuple_length proj_tuple_join_mask_empty<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> join_empty_left<span class=main>:</span> <span class=quoted><span class=quoted>"join <span class=main>{}</span> <span class=free>pos</span> <span class=free>t</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> join_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> join_empty_right<span class=main>:</span> <span class=quoted><span class=quoted>"join <span class=free>t</span> <span class=free>pos</span> <span class=main>{}</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>pos</span> <span class=keyword1>then</span> <span class=main>{}</span> <span class=keyword1>else</span> <span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> join_def<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>bin_join</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> nat set <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> bool <span class=main>⇒</span> nat set <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> <span class=tfree>'a</span> table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>bin_join</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>A'</span></span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> <span class=main>{}</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=main>{}</span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>A'</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>⟷</span> replicate <span class=free><span class=bound><span class=entity>n</span></span></span> None <span class=main>∈</span> <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>)</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>A'</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=keyword1>then</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>∩</span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>A'</span></span></span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=keyword1>then</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>.</span> proj_tuple_in_join <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>(</span>join_mask <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>A'</span></span></span><span class=main>)</span> <span class=bound>as</span> <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>}</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>A'</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>.</span> proj_tuple_in_join <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>(</span>join_mask <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=bound>as</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>}</span>
    <span class=keyword1>else</span> join <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> bin_join_table<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> tab<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A</span> <span class=free>t</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A'</span> <span class=free>t'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"bin_join <span class=free>n</span> <span class=free>A</span> <span class=free>t</span> <span class=free>pos</span> <span class=free>A'</span> <span class=free>t'</span> <span class=main>=</span> join <span class=free>t</span> <span class=free>pos</span> <span class=free>t'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms join_empty_left<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>pos</span></span> <span class=quoted><span class=free>t'</span></span><span class=main>]</span> join_empty_right<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>t</span></span> <span class=quoted><span class=free>pos</span></span><span class=main>]</span>
    join_no_cols<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>t'</span></span> <span class=quoted><span class=free>pos</span></span><span class=main>]</span> join_eq<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>t'</span></span> <span class=quoted><span class=free>t</span></span> <span class=quoted><span class=free>pos</span></span><span class=main>]</span> join_sub<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>,</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
    join_sub'<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>,</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Multi-way join›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mmulti_join'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>nat set list <span class=main>⇒</span> nat set list <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span> <span class=tfree>'a</span> table<span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mmulti_join'</span> <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=main>=</span> <span class=main>(</span>
    <span class=keyword1>let</span> <span class=bound>Q</span> <span class=main>=</span> set <span class=main>(</span>zip <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>L</span></span></span><span class=main>)</span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=bound>Q_neg</span> <span class=main>=</span> set <span class=main>(</span>zip <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free><span class=bound><span class=entity>A_pos</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>L</span></span></span><span class=main>)</span><span class=main>)</span> <span class=keyword1>in</span>
    New_max_getIJ_wrapperGenericJoin <span class=bound>Q</span> <span class=bound>Q_neg</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> mmulti_join'_correct<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A_pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=main>(</span><span class=free>A_pos</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=free>L</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> mmulti_join' <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span> <span class=main>⟷</span> wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>A</span><span class=main>∈</span>set <span class=free>A_pos</span><span class=main>.</span> <span class=bound>A</span><span class=main>)</span> <span class=free>z</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=free>z</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>)</span> <span class=free>A_pos</span> <span class=main>(</span>take <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=free>z</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span> <span class=free>A_neg</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>Q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>Q</span> <span class=main>=</span> set <span class=main>(</span>zip <span class=free>A_pos</span> <span class=free>L</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> Q_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>Q</span> <span class=main>=</span> set <span class=main>(</span>zip <span class=free>A_pos</span> <span class=main>(</span>take <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_zip<span class=main>)</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>Q_neg</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>Q_neg</span> <span class=main>=</span> set <span class=main>(</span>zip <span class=free>A_neg</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"mmulti_join' <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?r</span> <span class=main>=</span> New_max_getIJ_wrapperGenericJoin <span class=skolem>Q</span> <span class=skolem>Q_neg</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_def Q_neg_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> New_max.wrapperGenericJoin.simps<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=skolem>Q</span> <span class=main>≥</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_def <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Suc_le_eq card_gt_0_iff zip_eq_Nil_iff<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=main>(</span><span class=skolem>Q</span> <span class=main>∪</span> <span class=skolem>Q_neg</span><span class=main>)</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_alt Q_neg_def <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> zip_append1 list_all2_iff<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> <span class=var>?r</span> <span class=main>⟷</span> wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Q</span><span class=main>.</span> <span class=bound>A</span><span class=main>)</span> <span class=free>z</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Q</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=free>z</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Q_neg</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=free>z</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> New_max.wrapper_correctness case_prod_beta' <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>A</span><span class=main>∈</span>set <span class=free>A_pos</span><span class=main>.</span> <span class=bound>A</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Q</span><span class=main>.</span> <span class=bound>A</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_pos</span> <span class=main>≤</span> length <span class=free>L</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> Q_alt
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> in_set_impl_in_set_zip1<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> ys<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"take <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span>"</span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> set_zip_leftD<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Q</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=bound>z</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>)</span> <span class=main>⟷</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=bound>z</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>)</span> <span class=free>A_pos</span> <span class=main>(</span>take <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_alt <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_iff<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>A</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Q_neg</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=bound>z</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span> <span class=main>⟷</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=bound>z</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span> <span class=free>A_neg</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_neg_def <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_iff<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Q_def Q_neg_def <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> restrict_nested <span class=main>=</span> New_max.restrict_nested

<span class=keyword1><span class=command>lemma</span></span> list_all2_opt_True<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_xs</span> <span class=main>=</span> length <span class=free>xs</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_ys</span> <span class=main>=</span> length <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_zs</span> <span class=main>=</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> assms_dest<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_x</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_y</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_x</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append1 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>(</span>join <span class=free>x</span> True <span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> join_table<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A_x</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>A_y</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted>True</span> <span class=quoted><span class=quoted>"<span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> assms_dest<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> assms_dest<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_set_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mmulti_join'_opt_True<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_xs</span> <span class=main>=</span> length <span class=free>xs</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_ys</span> <span class=main>=</span> length <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_zs</span> <span class=main>=</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span> <span class=free>A_neg</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span> <span class=main>=</span>
    mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=free>A_neg</span>
    <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> assms_dest<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_x</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_y</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_x</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append1 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>(</span>join <span class=free>x</span> True <span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> join_table<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A_x</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>A_y</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted>True</span> <span class=quoted><span class=quoted>"<span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> assms_dest<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> assms_dest<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_set_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> list_all2'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> res<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>z</span> <span class=bound>Z</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=bound>Z</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span> <span class=main>⊆</span> <span class=bound>Z</span> <span class=main>⟹</span>
    restrict <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=bound>z</span> <span class=main>∈</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>⟷</span> restrict <span class=free>A_x</span> <span class=bound>z</span> <span class=main>∈</span> <span class=free>x</span> <span class=main>∧</span> restrict <span class=free>A_y</span> <span class=bound>z</span> <span class=main>∈</span> <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> join_restrict<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A_x</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted><span class=free>A_y</span></span> <span class=quoted>True</span><span class=main>]</span> wf_tuple_restrict_simple<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span>"</span></span><span class=main>]</span>
      assms_dest<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def restrict_nested Int_absorb2<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>z</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span> <span class=free>A_neg</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> z_in_dest<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>z</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_zs</span> <span class=free>zs</span>"</span></span>
      <span class=quoted><span class=quoted>"restrict <span class=free>A_x</span> <span class=skolem>z</span> <span class=main>∈</span> <span class=free>x</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_ys</span> <span class=free>ys</span>"</span></span>
      <span class=quoted><span class=quoted>"restrict <span class=free>A_y</span> <span class=skolem>z</span> <span class=main>∈</span> <span class=free>y</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_xs</span> <span class=free>xs</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>L_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_append1
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=free>A_neg</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ list_all2'<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span> res<span class=main>[</span><span class=operator>OF</span> z_in_dest<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_appendI le_supI2 Un_assoc <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>z</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=free>A_neg</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> True <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> z_in_dest<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>z</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_zs</span> <span class=free>zs</span>"</span></span>
      <span class=quoted><span class=quoted>"restrict <span class=main>(</span><span class=free>A_x</span> <span class=main>∪</span> <span class=free>A_y</span><span class=main>)</span> <span class=skolem>z</span> <span class=main>∈</span> join <span class=free>x</span> True <span class=free>y</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_ys</span> <span class=free>ys</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_xs</span> <span class=free>xs</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>L_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ list_all2'<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_append Un_assoc
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span> <span class=free>A_neg</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span> res<span class=main>[</span><span class=operator>OF</span> z_in_dest<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_appendI le_supI2 Un_assoc <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_opt_False<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_ws</span> <span class=main>=</span> length <span class=free>ws</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_xs</span> <span class=main>=</span> length <span class=free>xs</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_ys</span> <span class=main>=</span> length <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_zs</span> <span class=main>=</span> length <span class=free>zs</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A_y</span> <span class=main>⊆</span> <span class=free>A_x</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> assms_dest<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_x</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_y</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_x</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_x</span> <span class=main>(</span>join <span class=free>x</span> False <span class=free>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> join_table<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A_x</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>A_y</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted>False</span> <span class=quoted><span class=free>A_x</span></span><span class=main>,</span> <span class=operator>OF</span> assms_dest<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span><span class=main>]</span> assms<span class=main>(</span>6<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms assms_dest<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mmulti_join'_opt_False<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_ws</span> <span class=main>=</span> length <span class=free>ws</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_xs</span> <span class=main>=</span> length <span class=free>xs</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_ys</span> <span class=main>=</span> length <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_zs</span> <span class=main>=</span> length <span class=free>zs</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A_y</span> <span class=main>⊆</span> <span class=free>A_x</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
    mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> assms_dest<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_x</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_y</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_x</span>"</span></span> <span class=quoted><span class=quoted>"wf_set <span class=free>n</span> <span class=free>A_y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A_x</span> <span class=main>(</span>join <span class=free>x</span> False <span class=free>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> join_table<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A_x</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>A_y</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted>False</span> <span class=quoted><span class=free>A_x</span></span><span class=main>,</span> <span class=operator>OF</span> assms_dest<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span><span class=main>]</span> assms<span class=main>(</span>6<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> list_all2'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span>
    <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=free>ws</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms assms_dest<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> res<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> restrict <span class=free>A_x</span> <span class=bound>z</span> <span class=main>∈</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>⟷</span> restrict <span class=free>A_x</span> <span class=bound>z</span> <span class=main>∈</span> <span class=free>x</span> <span class=main>∧</span> restrict <span class=free>A_y</span> <span class=bound>z</span> <span class=main>∉</span> <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> join_restrict<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A_x</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted><span class=free>A_y</span></span> <span class=quoted>False</span><span class=main>,</span> <span class=operator>OF</span> _ _ assms<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span><span class=main>]</span> assms_dest<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> assms<span class=main>(</span>6<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def restrict_nested Int_absorb2 Un_absorb2<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>z</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=free>ws</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> z_in_dest<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>z</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_zs</span> <span class=free>zs</span>"</span></span>
      <span class=quoted><span class=quoted>"restrict <span class=free>A_x</span> <span class=skolem>z</span> <span class=main>∈</span> <span class=free>x</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_xs</span> <span class=free>xs</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_ws</span> <span class=free>ws</span>"</span></span>
      <span class=quoted><span class=quoted>"restrict <span class=free>A_y</span> <span class=skolem>z</span> <span class=main>∉</span> <span class=free>y</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_ys</span> <span class=free>ys</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_append1
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=free>ws</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ list_all2'<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span> res
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_appendI Un_assoc <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>z</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_ys</span><span class=main>)</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> join <span class=free>x</span> False <span class=free>y</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=free>ws</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> z_in_dest<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>z</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_zs</span> <span class=free>zs</span>"</span></span>
      <span class=quoted><span class=quoted>"restrict <span class=free>A_x</span> <span class=skolem>z</span> <span class=main>∈</span> join <span class=free>x</span> False <span class=free>y</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_xs</span> <span class=free>xs</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_ws</span> <span class=free>ws</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>z</span><span class=main>)</span><span class=main>)</span> <span class=free>A_ys</span> <span class=free>ys</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ list_all2'<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_append1
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> mmulti_join' <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span><span class=main>)</span>
      <span class=main>(</span><span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=free>ws</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span> res
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms list_all2_appendI Un_assoc <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> mmulti_join'.simps
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>find_sub_in</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set <span class=main>⇒</span> <span class=tfree>'a</span> set list <span class=main>⇒</span> bool <span class=main>⇒</span>
  <span class=main>(</span><span class=tfree>'a</span> set list <span class=main>×</span> <span class=tfree>'a</span> set <span class=main>×</span> <span class=tfree>'a</span> set list<span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>find_sub_in</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>=</span> None"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>find_sub_in</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=keyword1>then</span> Some <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>find_sub_in</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None <span class=main>|</span> Some <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_in_sound<span class=main>:</span> <span class=quoted><span class=quoted>"find_sub_in <span class=free>X</span> <span class=free>xs</span> <span class=free>b</span> <span class=main>=</span> Some <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>xs</span> <span class=main>=</span> <span class=free>ys</span> <span class=main>@</span> <span class=free>z</span> <span class=main>#</span> <span class=free>zs</span> <span class=main>∧</span> <span class=main>(</span><span class=free>z</span> <span class=main>⊆</span> <span class=free>X</span> <span class=main>∨</span> <span class=main>(</span><span class=free>b</span> <span class=main>∧</span> <span class=free>X</span> <span class=main>⊆</span> <span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>b</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> find_sub_in.induct<span class=main>)</span>
     <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>find_sub_True</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set list <span class=main>⇒</span>
  <span class=main>(</span><span class=tfree>'a</span> set list <span class=main>×</span> <span class=tfree>'a</span> set <span class=main>×</span> <span class=tfree>'a</span> set list <span class=main>×</span> <span class=tfree>'a</span> set <span class=main>×</span> <span class=tfree>'a</span> set list<span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>find_sub_True</span> <span class=main>[]</span> <span class=main>=</span> None"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>find_sub_True</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> find_sub_in <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> True <span class=keyword1>of</span> None <span class=main>⇒</span>
    <span class=main>(</span><span class=keyword1>case</span> <span class=free>find_sub_True</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None
    <span class=main>|</span> Some <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>w</span><span class=main>,</span> <span class=bound>ws</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=bound>ys</span><span class=main>,</span> <span class=bound>w</span><span class=main>,</span> <span class=bound>ws</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>
  <span class=main>|</span> Some <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span> <span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_True_sound<span class=main>:</span> <span class=quoted><span class=quoted>"find_sub_True <span class=free>xs</span> <span class=main>=</span> Some <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>xs</span> <span class=main>=</span> <span class=free>ys</span> <span class=main>@</span> <span class=free>w</span> <span class=main>#</span> <span class=free>ws</span> <span class=main>@</span> <span class=free>z</span> <span class=main>#</span> <span class=free>zs</span> <span class=main>∧</span> <span class=main>(</span><span class=free>z</span> <span class=main>⊆</span> <span class=free>w</span> <span class=main>∨</span> <span class=free>w</span> <span class=main>⊆</span> <span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> find_sub_in_sound
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>w</span></span> <span class=quoted><span class=free>ws</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> find_sub_True.induct<span class=main>)</span>
     <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>find_sub_False</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set list <span class=main>⇒</span> <span class=tfree>'a</span> set list <span class=main>⇒</span>
  <span class=main>(</span><span class=main>(</span><span class=tfree>'a</span> set list <span class=main>×</span> <span class=tfree>'a</span> set <span class=main>×</span> <span class=tfree>'a</span> set list<span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span> set list <span class=main>×</span> <span class=tfree>'a</span> set <span class=main>×</span> <span class=tfree>'a</span> set list<span class=main>)</span><span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>find_sub_False</span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>ns</span></span></span> <span class=main>=</span> None"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>find_sub_False</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ns</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> find_sub_in <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>ns</span></span></span> False <span class=keyword1>of</span> None <span class=main>⇒</span>
    <span class=main>(</span><span class=keyword1>case</span> <span class=free>find_sub_False</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=free><span class=bound><span class=entity>ns</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None
    <span class=main>|</span> Some <span class=main>(</span><span class=main>(</span><span class=bound>rs</span><span class=main>,</span> <span class=bound>w</span><span class=main>,</span> <span class=bound>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=bound>rs</span><span class=main>,</span> <span class=bound>w</span><span class=main>,</span> <span class=bound>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>|</span> Some <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_False_sound<span class=main>:</span> <span class=quoted><span class=quoted>"find_sub_False <span class=free>xs</span> <span class=free>ns</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>xs</span> <span class=main>=</span> <span class=free>rs</span> <span class=main>@</span> <span class=free>w</span> <span class=main>#</span> <span class=free>ws</span> <span class=main>∧</span> <span class=free>ns</span> <span class=main>=</span> <span class=free>ys</span> <span class=main>@</span> <span class=free>z</span> <span class=main>#</span> <span class=free>zs</span> <span class=main>∧</span> <span class=main>(</span><span class=free>z</span> <span class=main>⊆</span> <span class=free>w</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> find_sub_in_sound
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ns</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>rs</span></span> <span class=quoted><span class=free>w</span></span> <span class=quoted><span class=free>ws</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> find_sub_False.induct<span class=main>)</span>
     <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>proj_list_3</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> list <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'b</span> list <span class=main>×</span> <span class=tfree>'b</span> <span class=main>×</span> <span class=tfree>'b</span> list<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> list <span class=main>×</span> <span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'a</span> list<span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>proj_list_3</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>zs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>!</span> <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span><span class=main>,</span>
    take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>zs</span></span></span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> proj_list_3_same<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"proj_list_3 <span class=free>xs</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>=</span> <span class=free>ys'</span> <span class=main>@</span> <span class=free>z'</span> <span class=main>#</span> <span class=free>zs'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> id_take_nth_drop<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> proj_list_3_length<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"proj_list_3 <span class=free>xs</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>ys</span> <span class=main>=</span> length <span class=free>ys'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>zs</span> <span class=main>=</span> length <span class=free>zs'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>proj_list_5</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> list <span class=main>⇒</span>
  <span class=main>(</span><span class=tfree>'b</span> list <span class=main>×</span> <span class=tfree>'b</span> <span class=main>×</span> <span class=tfree>'b</span> list <span class=main>×</span> <span class=tfree>'b</span> <span class=main>×</span> <span class=tfree>'b</span> list<span class=main>)</span> <span class=main>⇒</span>
  <span class=main>(</span><span class=tfree>'a</span> list <span class=main>×</span> <span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'a</span> list <span class=main>×</span> <span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'a</span> list<span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>proj_list_5</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ws</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>zs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>!</span> <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span><span class=main>,</span>
    take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ws</span></span></span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>!</span> <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free><span class=bound><span class=entity>ws</span></span></span><span class=main>)</span><span class=main>,</span>
    drop <span class=main>(</span>length <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free><span class=bound><span class=entity>ws</span></span></span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> proj_list_5_same<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"proj_list_5 <span class=free>xs</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>w'</span><span class=main>,</span> <span class=free>ws'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>ws</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>=</span> <span class=free>ys'</span> <span class=main>@</span> <span class=free>w'</span> <span class=main>#</span> <span class=free>ws'</span> <span class=main>@</span> <span class=free>z'</span> <span class=main>#</span> <span class=free>zs'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>!</span> length <span class=free>ys</span> <span class=main>#</span> take <span class=main>(</span>length <span class=free>ws</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>Suc <span class=main>(</span>length <span class=free>ys</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span> <span class=main>=</span> take <span class=main>(</span>Suc <span class=main>(</span>length <span class=free>ws</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free>ys</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq nth_Cons <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.split<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"take <span class=main>(</span>Suc <span class=main>(</span>length <span class=free>ws</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free>ys</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> drop <span class=main>(</span>Suc <span class=main>(</span>length <span class=free>ys</span> <span class=main>+</span> length <span class=free>ws</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span>
      drop <span class=main>(</span>length <span class=free>ys</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Suc_eq_plus1 add.assoc<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=main>1</span></span><span class=main>]</span> add.commute<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"length <span class=free>ws</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span>
      drop_drop<span class=main>[</span><span class=operator>symmetric</span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"length <span class=free>ws</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span> append_take_drop_id <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Cons_nth_drop_Suc append_Cons<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> proj_list_5_length<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"proj_list_5 <span class=free>xs</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>w'</span><span class=main>,</span> <span class=free>ws'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>ws</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>ys</span> <span class=main>=</span> length <span class=free>ys'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>ws</span> <span class=main>=</span> length <span class=free>ws'</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>zs</span> <span class=main>=</span> length <span class=free>zs'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>dominate_True</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set list <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span>
  <span class=main>(</span><span class=main>(</span>nat set list <span class=main>×</span> nat set <span class=main>×</span> nat set list <span class=main>×</span> nat set <span class=main>×</span> nat set list<span class=main>)</span> <span class=main>×</span>
  <span class=main>(</span><span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> table <span class=main>×</span> <span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> table <span class=main>×</span> <span class=tfree>'a</span> table list<span class=main>)</span><span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dominate_True</span> <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>L_pos</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> find_sub_True <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None
  <span class=main>|</span> Some <span class=bound>split</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=bound>split</span><span class=main>,</span> proj_list_5 <span class=free><span class=bound><span class=entity>L_pos</span></span></span> <span class=bound>split</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_True_proj_list_5_same<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"find_sub_True <span class=free>xs</span> <span class=main>=</span> Some <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>xs'</span>"</span></span>
    <span class=quoted><span class=quoted>"proj_list_5 <span class=free>xs'</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>w'</span><span class=main>,</span> <span class=free>ws'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>xs'</span> <span class=main>=</span> <span class=free>ys'</span> <span class=main>@</span> <span class=free>w'</span> <span class=main>#</span> <span class=free>ws'</span> <span class=main>@</span> <span class=free>z'</span> <span class=main>#</span> <span class=free>zs'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> len<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>xs'</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>ws</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>zs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> find_sub_True_sound<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> proj_list_5_same<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> len<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_True_proj_list_5_length<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"find_sub_True <span class=free>xs</span> <span class=main>=</span> Some <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>xs'</span>"</span></span>
    <span class=quoted><span class=quoted>"proj_list_5 <span class=free>xs'</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>w'</span><span class=main>,</span> <span class=free>ws'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>ys</span> <span class=main>=</span> length <span class=free>ys'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>ws</span> <span class=main>=</span> length <span class=free>ws'</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>zs</span> <span class=main>=</span> length <span class=free>zs'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> find_sub_True_sound<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> proj_list_5_length<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main><span class=main>(</span></span></span></span>3<span class=main><span class=main><span class=main><span class=main>)</span></span></span></span><span class=main>]</span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> dominate_True_sound<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dominate_True <span class=free>A_pos</span> <span class=free>L_pos</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>(</span><span class=free>A_zs</span><span class=main>,</span> <span class=free>A_x</span><span class=main>,</span> <span class=free>A_xs</span><span class=main>,</span> <span class=free>A_y</span><span class=main>,</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=free>zs</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=free>xs</span><span class=main>,</span> <span class=free>y</span><span class=main>,</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_pos</span> <span class=main>=</span> length <span class=free>L_pos</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>A_pos</span> <span class=main>=</span> <span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>L_pos</span> <span class=main>=</span> <span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_xs</span> <span class=main>=</span> length <span class=free>xs</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_ys</span> <span class=main>=</span> length <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_zs</span> <span class=main>=</span> length <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms find_sub_True_sound find_sub_True_proj_list_5_same find_sub_True_proj_list_5_length
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> proj_list_5.simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span> <span class=operator>fast</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>dominate_False</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set list <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span> nat set list <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span>
  <span class=main>(</span><span class=main>(</span><span class=main>(</span>nat set list <span class=main>×</span> nat set <span class=main>×</span> nat set list<span class=main>)</span> <span class=main>×</span> nat set list <span class=main>×</span> nat set <span class=main>×</span> nat set list<span class=main>)</span> <span class=main>×</span>
  <span class=main>(</span><span class=main>(</span><span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> table <span class=main>×</span> <span class=tfree>'a</span> table list<span class=main>)</span> <span class=main>×</span>
  <span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> table <span class=main>×</span> <span class=tfree>'a</span> table list<span class=main>)</span><span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dominate_False</span> <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>L_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=free><span class=bound><span class=entity>L_neg</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> find_sub_False <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> None
  <span class=main>|</span> Some <span class=main>(</span><span class=bound>pos_split</span><span class=main>,</span> <span class=bound>neg_split</span><span class=main>)</span> <span class=main>⇒</span>
    Some <span class=main>(</span><span class=main>(</span><span class=bound>pos_split</span><span class=main>,</span> <span class=bound>neg_split</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span>proj_list_3 <span class=free><span class=bound><span class=entity>L_pos</span></span></span> <span class=bound>pos_split</span><span class=main>,</span> proj_list_3 <span class=free><span class=bound><span class=entity>L_neg</span></span></span> <span class=bound>neg_split</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_False_proj_list_3_same_left<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"find_sub_False <span class=free>xs</span> <span class=free>ns</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>xs'</span>"</span></span> <span class=quoted><span class=quoted>"proj_list_3 <span class=free>xs'</span> <span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>rs'</span><span class=main>,</span> <span class=free>w'</span><span class=main>,</span> <span class=free>ws'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>xs'</span> <span class=main>=</span> <span class=free>rs'</span> <span class=main>@</span> <span class=free>w'</span> <span class=main>#</span> <span class=free>ws'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> len<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>xs'</span> <span class=main>=</span> length <span class=free>rs</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>ws</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> find_sub_False_sound<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> proj_list_3_same<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> len<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_False_proj_list_3_length_left<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"find_sub_False <span class=free>xs</span> <span class=free>ns</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>xs'</span>"</span></span> <span class=quoted><span class=quoted>"proj_list_3 <span class=free>xs'</span> <span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>rs'</span><span class=main>,</span> <span class=free>w'</span><span class=main>,</span> <span class=free>ws'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>rs</span> <span class=main>=</span> length <span class=free>rs'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>ws</span> <span class=main>=</span> length <span class=free>ws'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> find_sub_False_sound<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> proj_list_3_length<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>3<span class=main><span class=main><span class=main>)</span></span></span><span class=main>]</span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_False_proj_list_3_same_right<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"find_sub_False <span class=free>xs</span> <span class=free>ns</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>ns</span> <span class=main>=</span> length <span class=free>ns'</span>"</span></span> <span class=quoted><span class=quoted>"proj_list_3 <span class=free>ns'</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>ns'</span> <span class=main>=</span> <span class=free>ys'</span> <span class=main>@</span> <span class=free>z'</span> <span class=main>#</span> <span class=free>zs'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> len<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>ns'</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=free>zs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> find_sub_False_sound<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> proj_list_3_same<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> len<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> find_sub_False_proj_list_3_length_right<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"find_sub_False <span class=free>xs</span> <span class=free>ns</span> <span class=main>=</span> Some <span class=main>(</span><span class=main>(</span><span class=free>rs</span><span class=main>,</span> <span class=free>w</span><span class=main>,</span> <span class=free>ws</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>ns</span> <span class=main>=</span> length <span class=free>ns'</span>"</span></span> <span class=quoted><span class=quoted>"proj_list_3 <span class=free>ns'</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys'</span><span class=main>,</span> <span class=free>z'</span><span class=main>,</span> <span class=free>zs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>ys</span> <span class=main>=</span> length <span class=free>ys'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>zs</span> <span class=main>=</span> length <span class=free>zs'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> find_sub_False_sound<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> proj_list_3_length<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>3<span class=main><span class=main><span class=main>)</span></span></span><span class=main>]</span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> dominate_False_sound<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dominate_False <span class=free>A_pos</span> <span class=free>L_pos</span> <span class=free>A_neg</span> <span class=free>L_neg</span> <span class=main>=</span>
    Some <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=free>A_zs</span><span class=main>,</span> <span class=free>A_x</span><span class=main>,</span> <span class=free>A_xs</span><span class=main>)</span><span class=main>,</span> <span class=free>A_ws</span><span class=main>,</span> <span class=free>A_y</span><span class=main>,</span> <span class=free>A_ys</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=main>(</span><span class=free>zs</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=free>xs</span><span class=main>)</span><span class=main>,</span> <span class=free>ws</span><span class=main>,</span> <span class=free>y</span><span class=main>,</span> <span class=free>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_pos</span> <span class=main>=</span> length <span class=free>L_pos</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_neg</span> <span class=main>=</span> length <span class=free>L_neg</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>A_pos</span> <span class=main>=</span> <span class=main>(</span><span class=free>A_zs</span> <span class=main>@</span> <span class=free>A_x</span> <span class=main>#</span> <span class=free>A_xs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A_neg</span> <span class=main>=</span> <span class=free>A_ws</span> <span class=main>@</span> <span class=free>A_y</span> <span class=main>#</span> <span class=free>A_ys</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>L_pos</span> <span class=main>=</span> <span class=main>(</span><span class=free>zs</span> <span class=main>@</span> <span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>L_neg</span> <span class=main>=</span> <span class=free>ws</span> <span class=main>@</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_ws</span> <span class=main>=</span> length <span class=free>ws</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_xs</span> <span class=main>=</span> length <span class=free>xs</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>A_ys</span> <span class=main>=</span> length <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>A_zs</span> <span class=main>=</span> length <span class=free>zs</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A_y</span> <span class=main>⊆</span> <span class=free>A_x</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms find_sub_False_proj_list_3_same_left find_sub_False_proj_list_3_same_right
    find_sub_False_proj_list_3_length_left find_sub_False_proj_list_3_length_right
    find_sub_False_sound
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> proj_list_3.simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span> <span class=operator>fast</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>mmulti_join</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>nat <span class=main>⇒</span> nat set list <span class=main>⇒</span> nat set list <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span> <span class=tfree>'a</span> table<span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mmulti_join</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> length <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=main>+</span> length <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=main>≠</span> length <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=keyword1>then</span> <span class=main>{}</span> <span class=keyword1>else</span>
    <span class=keyword1>let</span> <span class=bound>L_pos</span> <span class=main>=</span> take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>A_pos</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>L</span></span></span><span class=main>;</span> <span class=bound>L_neg</span> <span class=main>=</span> drop <span class=main>(</span>length <span class=free><span class=bound><span class=entity>A_pos</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=keyword1>case</span> dominate_True <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=bound>L_pos</span> <span class=keyword1>of</span> None <span class=main>⇒</span>
      <span class=main>(</span><span class=keyword1>case</span> dominate_False <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=bound>L_pos</span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=bound>L_neg</span> <span class=keyword1>of</span> None <span class=main>⇒</span> mmulti_join' <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=free><span class=bound><span class=entity>L</span></span></span>
      <span class=main>|</span> Some <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=bound>A_zs</span><span class=main>,</span> <span class=bound>A_x</span><span class=main>,</span> <span class=bound>A_xs</span><span class=main>)</span><span class=main>,</span> <span class=bound>A_ws</span><span class=main>,</span> <span class=bound>A_y</span><span class=main>,</span> <span class=bound>A_ys</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>xs</span><span class=main>)</span><span class=main>,</span> <span class=bound>ws</span><span class=main>,</span> <span class=bound>y</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span><span class=main>)</span> <span class=main>⇒</span>
        <span class=free>mmulti_join</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span><span class=bound>A_zs</span> <span class=main>@</span> <span class=bound>A_x</span> <span class=main>#</span> <span class=bound>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=bound>A_ws</span> <span class=main>@</span> <span class=bound>A_ys</span><span class=main>)</span>
        <span class=main>(</span><span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> bin_join <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=bound>A_x</span> <span class=bound>x</span> False <span class=bound>A_y</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=bound>ws</span> <span class=main>@</span> <span class=bound>ys</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>|</span> Some <span class=main>(</span><span class=main>(</span><span class=bound>A_zs</span><span class=main>,</span> <span class=bound>A_x</span><span class=main>,</span> <span class=bound>A_xs</span><span class=main>,</span> <span class=bound>A_y</span><span class=main>,</span> <span class=bound>A_ys</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>xs</span><span class=main>,</span> <span class=bound>y</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span><span class=main>)</span> <span class=main>⇒</span>
      <span class=free>mmulti_join</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span><span class=bound>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=bound>A_x</span> <span class=main>∪</span> <span class=bound>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=bound>A_xs</span> <span class=main>@</span> <span class=bound>A_ys</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span>
      <span class=main>(</span><span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> bin_join <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=bound>A_x</span> <span class=bound>x</span> True <span class=bound>A_y</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>xs</span> <span class=main>@</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>@</span> <span class=bound>L_neg</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>n</span><span class=main>,</span> <span class=bound>A_pos</span><span class=main>,</span> <span class=bound>A_neg</span><span class=main>,</span> <span class=bound>L</span><span class=main>)</span><span class=main>.</span> length <span class=bound>A_pos</span> <span class=main>+</span> length <span class=bound>A_neg</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>use</span> find_sub_True_sound find_sub_False_sound <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> <span class=quoted>‹<span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main>:</span> option.splits›</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> mmulti_join_link<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A_pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=main>(</span><span class=free>A_pos</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=free>L</span>"</span></span>
    <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"mmulti_join <span class=free>n</span> <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span> <span class=main>=</span> mmulti_join' <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>A_pos</span></span> <span class=quoted><span class=free>A_neg</span></span> <span class=quoted><span class=free>L</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mmulti_join.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>n</span> <span class=skolem>A_pos</span> <span class=skolem>A_neg</span> <span class=skolem>L</span><span class=main>)</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L_pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L_pos</span> <span class=main>=</span> take <span class=main>(</span>length <span class=skolem>A_pos</span><span class=main>)</span> <span class=skolem>L</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L_neg</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L_neg</span> <span class=main>=</span> drop <span class=main>(</span>length <span class=skolem>A_pos</span><span class=main>)</span> <span class=skolem>L</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> L_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> <span class=skolem>L_pos</span> <span class=main>@</span> <span class=skolem>L_neg</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> L_pos_def L_neg_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lens_match<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>A_pos</span> <span class=main>=</span> length <span class=skolem>L_pos</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>A_neg</span> <span class=main>=</span> length <span class=skolem>L_neg</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> L_pos_def L_neg_def 1<span class=main>(</span>4<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> L_def<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> lens_sum<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>A_pos</span> <span class=main>+</span> length <span class=skolem>A_neg</span> <span class=main>=</span> length <span class=skolem>L</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> L_def<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"dominate_True <span class=skolem>A_pos</span> <span class=skolem>L_pos</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> None
    <span class=keyword1><span class=command>note</span></span> dom_True <span class=main>=</span> None
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"dominate_False <span class=skolem>A_pos</span> <span class=skolem>L_pos</span> <span class=skolem>A_neg</span> <span class=skolem>L_neg</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> None
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> mmulti_join.simps<span class=main>)</span>
           <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> dominate_True.simps dominate_False.simps mmulti_join.simps
            mmulti_join'.simps <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def dom_True L_pos_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> None
            L_neg_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> lens_sum <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>a</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>A_zs</span></span> <span class=skolem><span class=skolem>A_x</span></span> <span class=skolem><span class=skolem>A_xs</span></span> <span class=skolem><span class=skolem>A_ws</span></span> <span class=skolem><span class=skolem>A_y</span></span> <span class=skolem><span class=skolem>A_ys</span></span> <span class=skolem><span class=skolem>zs</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=skolem><span class=skolem>xs</span></span> <span class=skolem><span class=skolem>ws</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=skolem><span class=skolem>ys</span></span> <span class=keyword2><span class=keyword>where</span></span>
        dom_False<span class=main>:</span> <span class=quoted><span class=quoted>"dominate_False <span class=skolem>A_pos</span> <span class=skolem>L_pos</span> <span class=skolem>A_neg</span> <span class=skolem>L_neg</span> <span class=main>=</span>
        Some <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=skolem>A_zs</span><span class=main>,</span> <span class=skolem>A_x</span><span class=main>,</span> <span class=skolem>A_xs</span><span class=main>)</span><span class=main>,</span> <span class=skolem>A_ws</span><span class=main>,</span> <span class=skolem>A_y</span><span class=main>,</span> <span class=skolem>A_ys</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>xs</span><span class=main>)</span><span class=main>,</span> <span class=skolem>ws</span><span class=main>,</span> <span class=skolem>y</span><span class=main>,</span> <span class=skolem>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>note</span></span> list_all2 <span class=main>=</span> 1<span class=main>(</span>4<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> L_def dominate_False_sound<span class=main><span class=main>[</span></span><span class=operator>OF</span> dom_False lens_match<span class=main><span class=main>]</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>have</span></span> lens<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>A_ws</span> <span class=main>=</span> length <span class=skolem>ws</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>A_xs</span> <span class=main>=</span> length <span class=skolem>xs</span>"</span></span>
        <span class=quoted><span class=quoted>"length <span class=skolem>A_ys</span> <span class=main>=</span> length <span class=skolem>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>A_zs</span> <span class=main>=</span> length <span class=skolem>zs</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> dominate_False_sound<span class=main>[</span><span class=operator>OF</span> dom_False lens_match<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> sub<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>A_y</span> <span class=main>⊆</span> <span class=skolem>A_x</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> dominate_False_sound<span class=main>[</span><span class=operator>OF</span> dom_False lens_match<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> list_all2'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=skolem>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=skolem>n</span> <span class=bound>A</span><span class=main>)</span>
        <span class=main>(</span><span class=main>(</span><span class=skolem>A_zs</span> <span class=main>@</span> <span class=skolem>A_x</span> <span class=main>#</span> <span class=skolem>A_xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>A_ws</span> <span class=main>@</span> <span class=skolem>A_ys</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> join <span class=skolem>x</span> False <span class=skolem>y</span> <span class=main>#</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>ws</span> <span class=main>@</span> <span class=skolem>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> list_all2_opt_False<span class=main>[</span><span class=operator>OF</span> list_all2 lens sub<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>have</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>A_x</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>A_y</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> list_all2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lens list_all2_append<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> bin_join_conv<span class=main>:</span> <span class=quoted><span class=quoted>"join <span class=skolem>x</span> False <span class=skolem>y</span> <span class=main>=</span> bin_join <span class=skolem>n</span> <span class=skolem>A_x</span> <span class=skolem>x</span> False <span class=skolem>A_y</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> bin_join_table<span class=main>[</span><span class=operator>OF</span> tabs<span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>have</span></span> mmulti<span class=main>:</span> <span class=quoted><span class=quoted>"mmulti_join <span class=skolem>n</span> <span class=skolem>A_pos</span> <span class=skolem>A_neg</span> <span class=skolem>L</span> <span class=main>=</span> mmulti_join <span class=skolem>n</span> <span class=main>(</span><span class=skolem>A_zs</span> <span class=main>@</span> <span class=skolem>A_x</span> <span class=main>#</span> <span class=skolem>A_xs</span><span class=main>)</span> <span class=main>(</span><span class=skolem>A_ws</span> <span class=main>@</span> <span class=skolem>A_ys</span><span class=main>)</span>
        <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> bin_join <span class=skolem>n</span> <span class=skolem>A_x</span> <span class=skolem>x</span> False <span class=skolem>A_y</span> <span class=skolem>y</span> <span class=main>#</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>ws</span> <span class=main>@</span> <span class=skolem>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> mmulti_join.simps<span class=main>)</span>
           <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> dominate_True.simps dominate_False.simps mmulti_join.simps
            <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def dom_True L_pos_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> L_neg_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> dom_False lens_sum<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> mmulti
        <span class=keyword1><span class=command>unfolding</span></span> L_def dominate_False_sound<span class=main>[</span><span class=operator>OF</span> dom_False lens_match<span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ L_pos_def L_neg_def dom_True dom_False<span class=main><span class=main>,</span></span>
            <span class=operator>OF</span> _ _ _ _ _ _ _ _ _ _ _ _ _ list_all2'<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> bin_join_conv<span class=main><span class=main>]</span></span><span class=main><span class=main>,</span></span>
            <span class=operator>unfolded</span> mmulti_join'_opt_False<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> list_all2 lens sub<span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>symmetric</span><span class=main><span class=main><span class=main>,</span></span></span>
            <span class=operator>unfolded</span> bin_join_conv<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
           <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lens_sum<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>a</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>A_zs</span></span> <span class=skolem><span class=skolem>A_x</span></span> <span class=skolem><span class=skolem>A_xs</span></span> <span class=skolem><span class=skolem>A_y</span></span> <span class=skolem><span class=skolem>A_ys</span></span> <span class=skolem><span class=skolem>zs</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=skolem><span class=skolem>xs</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=skolem><span class=skolem>ys</span></span> <span class=keyword2><span class=keyword>where</span></span> dom_True<span class=main>:</span> <span class=quoted><span class=quoted>"dominate_True <span class=skolem>A_pos</span> <span class=skolem>L_pos</span> <span class=main>=</span>
      Some <span class=main>(</span><span class=main>(</span><span class=skolem>A_zs</span><span class=main>,</span> <span class=skolem>A_x</span><span class=main>,</span> <span class=skolem>A_xs</span><span class=main>,</span> <span class=skolem>A_y</span><span class=main>,</span> <span class=skolem>A_ys</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>xs</span><span class=main>,</span> <span class=skolem>y</span><span class=main>,</span> <span class=skolem>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>note</span></span> list_all2 <span class=main>=</span> 1<span class=main>(</span>4<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> L_def dominate_True_sound<span class=main><span class=main>[</span></span><span class=operator>OF</span> dom_True lens_match<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>have</span></span> lens<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>A_xs</span> <span class=main>=</span> length <span class=skolem>xs</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>A_ys</span> <span class=main>=</span> length <span class=skolem>ys</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>A_zs</span> <span class=main>=</span> length <span class=skolem>zs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> dominate_True_sound<span class=main>[</span><span class=operator>OF</span> dom_True lens_match<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>(</span></span></span></span></span></span>1<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>)</span></span></span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> list_all2'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=skolem>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=skolem>n</span> <span class=bound>A</span><span class=main>)</span>
      <span class=main>(</span><span class=main>(</span><span class=skolem>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>A_x</span> <span class=main>∪</span> <span class=skolem>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=skolem>A_xs</span> <span class=main>@</span> <span class=skolem>A_ys</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>A_neg</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> join <span class=skolem>x</span> True <span class=skolem>y</span> <span class=main>#</span> <span class=skolem>xs</span> <span class=main>@</span> <span class=skolem>ys</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>L_neg</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> list_all2_opt_True<span class=main>[</span><span class=operator>OF</span> list_all2 lens<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>A_x</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>A_y</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> list_all2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lens list_all2_append<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> bin_join_conv<span class=main>:</span> <span class=quoted><span class=quoted>"join <span class=skolem>x</span> True <span class=skolem>y</span> <span class=main>=</span> bin_join <span class=skolem>n</span> <span class=skolem>A_x</span> <span class=skolem>x</span> True <span class=skolem>A_y</span> <span class=skolem>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> bin_join_table<span class=main>[</span><span class=operator>OF</span> tabs<span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> mmulti<span class=main>:</span> <span class=quoted><span class=quoted>"mmulti_join <span class=skolem>n</span> <span class=skolem>A_pos</span> <span class=skolem>A_neg</span> <span class=skolem>L</span> <span class=main>=</span> mmulti_join <span class=skolem>n</span> <span class=main>(</span><span class=skolem>A_zs</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>A_x</span> <span class=main>∪</span> <span class=skolem>A_y</span><span class=main>)</span> <span class=main>#</span> <span class=skolem>A_xs</span> <span class=main>@</span> <span class=skolem>A_ys</span><span class=main>)</span>
      <span class=skolem>A_neg</span> <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> bin_join <span class=skolem>n</span> <span class=skolem>A_x</span> <span class=skolem>x</span> True <span class=skolem>A_y</span> <span class=skolem>y</span> <span class=main>#</span> <span class=skolem>xs</span> <span class=main>@</span> <span class=skolem>ys</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>L_neg</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> mmulti_join.simps<span class=main>)</span>
         <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> dominate_True.simps dominate_False.simps mmulti_join.simps
          <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def dom_True L_pos_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> L_neg_def lens_sum<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> mmulti
      <span class=keyword1><span class=command>unfolding</span></span> L_def dominate_True_sound<span class=main>[</span><span class=operator>OF</span> dom_True lens_match<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>(</span></span></span></span></span></span>1<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>)</span></span></span></span></span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> 1<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ L_pos_def L_neg_def dom_True<span class=main><span class=main>,</span></span>
          <span class=operator>OF</span> _ _ _ _ _ _ _ _ _ _ _ list_all2'<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> bin_join_conv<span class=main><span class=main>]</span></span><span class=main><span class=main>,</span></span>
          <span class=operator>unfolded</span> mmulti_join'_opt_True<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> list_all2 lens<span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>symmetric</span><span class=main><span class=main><span class=main>,</span></span></span>
          <span class=operator>unfolded</span> bin_join_conv<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
         <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lens_sum<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mmulti_join_correct<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A_pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=main>(</span><span class=free>A_pos</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=free>L</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> mmulti_join <span class=free>n</span> <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span> <span class=main>⟷</span> wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>A</span><span class=main>∈</span>set <span class=free>A_pos</span><span class=main>.</span> <span class=bound>A</span><span class=main>)</span> <span class=free>z</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=free>z</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>)</span> <span class=free>A_pos</span> <span class=main>(</span>take <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> restrict <span class=bound>A</span> <span class=free>z</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span> <span class=free>A_neg</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=free>L</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mmulti_join_link<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> <span class=keyword1><span class=command>using</span></span> mmulti_join'_correct<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Monitor><div class=head><h1>Theory Monitor</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Monitor
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Formula.html>Formula</a>
    <a href=Optimized_Join.html>Optimized_Join</a>
    <span class=quoted>"<a href=../MFOTL_Monitor/Abstract_Monitor.html>MFOTL_Monitor.Abstract_Monitor</a>"</span>
    <span class=quoted>"<a href=../../HOL/HOL-Library/While_Combinator.html>HOL-Library.While_Combinator</a>"</span>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Mapping.html>HOL-Library.Mapping</a>"</span>
    <span class=quoted>"<a href=../Deriving/Derive.html>Deriving.Derive</a>"</span>
    <span class=quoted>"<a href=../Generic_Join/Generic_Join_Correctness.html>Generic_Join.Generic_Join_Correctness</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Generic monitoring algorithm›</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹The algorithm defined here abstracts over the implementation of the temporal operators.›</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Monitorable formulas›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⟷</span> safe_formula <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> Formula.future_bounded <span class=free><span class=bound><span class=entity>φ</span></span></span>"</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_regex</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>⟷</span> safe_regex <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> Regex.pred_regex Formula.future_bounded <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>is_simple_eq</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trm <span class=main>⇒</span> Formula.trm <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_simple_eq</span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>=</span> <span class=main>(</span>Formula.is_Const <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∧</span> <span class=main>(</span>Formula.is_Const <span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>∨</span> Formula.is_Var <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>∨</span>
    Formula.is_Var <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>∧</span> Formula.is_Const <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mmonitorable_exec</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.formula <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> is_simple_eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.Eq <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Pred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> list_all <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> Formula.is_Var <span class=bound>t</span> <span class=main>∨</span> Formula.is_Const <span class=bound>t</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span>Formula.nfv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>}</span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span>
    <span class=main>(</span>safe_assignment <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∨</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∨</span>
      fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>⊆</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=main>(</span>is_constraint <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>of</span> Formula.Neg <span class=bound>ψ'</span> <span class=main>⇒</span> <span class=free>mmonitorable_exec</span> <span class=bound>ψ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>pos</span><span class=main>,</span> <span class=bound>neg</span><span class=main>)</span> <span class=main>=</span> partition <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=keyword1>in</span>
    <span class=bound>pos</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>∧</span> list_all <span class=free>mmonitorable_exec</span> <span class=main>(</span>map remove_neg <span class=bound>neg</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span>map fv <span class=bound>neg</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span><span class=main>(</span>set <span class=main>(</span>map fv <span class=bound>pos</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>∉</span> Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> Formula.fv_trm <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span>
    <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span> Formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>mmonitorable_exec</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≠</span> <span class=main>∞</span> <span class=main>∧</span>
    <span class=main>(</span><span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∨</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span> Formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>mmonitorable_exec</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=free>mmonitorable_exec</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> Regex.safe_regex Formula.fv <span class=main>(</span><span class=main>λ</span><span class=bound>g</span> <span class=bound>φ</span><span class=main>.</span> <span class=free>mmonitorable_exec</span> <span class=bound>φ</span> <span class=main>∨</span> <span class=main>(</span><span class=bound>g</span> <span class=main>=</span> Lax <span class=main>∧</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>φ</span> <span class=keyword1>of</span> Formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>mmonitorable_exec</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span> Past Strict <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main>(</span>Formula.MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Regex.safe_regex Formula.fv <span class=main>(</span><span class=main>λ</span><span class=bound>g</span> <span class=bound>φ</span><span class=main>.</span> <span class=free>mmonitorable_exec</span> <span class=bound>φ</span> <span class=main>∨</span> <span class=main>(</span><span class=bound>g</span> <span class=main>=</span> Lax <span class=main>∧</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>φ</span> <span class=keyword1>of</span> Formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=free>mmonitorable_exec</span> <span class=bound>φ'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>)</span><span class=main>)</span> Futu Strict <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≠</span> <span class=main>∞</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mmonitorable_exec</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> False"</span></span>

<span class=keyword1><span class=command>lemma</span></span> cases_Neg_iff<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> <span class=free>φ</span> <span class=keyword1>of</span> formula.Neg <span class=bound>ψ</span> <span class=main>⇒</span> <span class=free>P</span> <span class=bound>ψ</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>ψ</span><span class=main>.</span> <span class=free>φ</span> <span class=main>=</span> formula.Neg <span class=bound>ψ</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> safe_formula_mmonitorable_exec<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> Formula.future_bounded <span class=free>φ</span> <span class=main>⟹</span> mmonitorable_exec <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>8 <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>9 <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>10 <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted>"10.prems"</span><span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> bounded<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=skolem>φ</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>poss</span></span> <span class=skolem><span class=skolem>negs</span></span> <span class=keyword2><span class=keyword>where</span></span> posnegs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>poss</span><span class=main>,</span> <span class=skolem>negs</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>posm</span></span> <span class=skolem><span class=skolem>negm</span></span> <span class=keyword2><span class=keyword>where</span></span> posnegm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>posm</span><span class=main>,</span> <span class=skolem>negm</span><span class=main>)</span> <span class=main>=</span> partition mmonitorable_exec <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>poss</span> <span class=main>⊆</span> set <span class=skolem>posm</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> subsetI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>poss</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posnegs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"mmonitorable_exec <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.hyps"</span><span class=main>(</span>1<span class=main>)</span> bounded <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>posm</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>poss</span>›</span></span> posnegm posnegs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>negm</span> <span class=main>⊆</span> set <span class=skolem>negs</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posnegm posnegs <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=quoted><span class=quoted>"<span class=skolem>poss</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>negs</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>negs</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>poss</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.prems"</span><span class=main>(</span>1<span class=main>)</span> posnegs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>posm</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹set <span class=skolem>poss</span> <span class=main>⊆</span> set <span class=skolem>posm</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all mmonitorable_exec <span class=main>(</span>map remove_neg <span class=skolem>negm</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?l</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"map remove_neg <span class=skolem>negm</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=var>?l</span> <span class=main>⟹</span> mmonitorable_exec <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=var>?l</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> set <span class=skolem>negm</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> remove_neg <span class=skolem>y</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> set <span class=skolem>negs</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹set <span class=skolem>negm</span> <span class=main>⊆</span> set <span class=skolem>negs</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>x</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>=</span> remove_neg <span class=skolem>y</span>›</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>negs</span><span class=main>)</span>›</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_def<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"mmonitorable_exec <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=skolem>y</span> <span class=main>=</span> Formula.Neg <span class=bound>z</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>z</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>=</span> Formula.Neg <span class=skolem>z</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.hyps"</span><span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> posnegs refl<span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>=</span> remove_neg <span class=skolem>y</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span> <span class=main>∈</span> set <span class=skolem>negs</span>›</span></span> posnegs bounded
            <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>x</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"remove_neg <span class=skolem>y</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>y</span></span><span class=main>)</span> <span class=operator>simp_all</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>=</span> remove_neg <span class=skolem>y</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted>"10.hyps"</span><span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span> <span class=main>∈</span> set <span class=skolem>negs</span>›</span></span> posnegs <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>x</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span> <span class=main>=</span> <span class=skolem>x</span>›</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>negm</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span>set <span class=skolem>posm</span><span class=main>.</span> fv <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>negs</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>poss</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹set <span class=skolem>poss</span> <span class=main>⊆</span> set <span class=skolem>posm</span>›</span></span> <span class=quoted><span class=quoted>‹set <span class=skolem>negm</span> <span class=main>⊆</span> set <span class=skolem>negs</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> posnegm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>15 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>16 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>17 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_mono<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff regex.pred_set<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>18 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_mono<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff regex.pred_set<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_simple_eq_def list.pred_set<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_assignment_future_bounded<span class=main>:</span> <span class=quoted><span class=quoted>"safe_assignment <span class=free>X</span> <span class=free>φ</span> <span class=main>⟹</span> Formula.future_bounded <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> safe_assignment_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> is_constraint_future_bounded<span class=main>:</span> <span class=quoted><span class=quoted>"is_constraint <span class=free>φ</span> <span class=main>⟹</span> Formula.future_bounded <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> is_constraint.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> mmonitorable_exec_mmonitorable<span class=main>:</span> <span class=quoted><span class=quoted>"mmonitorable_exec <span class=free>φ</span> <span class=main>⟹</span> mmonitorable <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mmonitorable_exec.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>7 <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> safe_assignment_future_bounded is_constraint_future_bounded<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>8 <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>poss</span></span> <span class=skolem><span class=skolem>negs</span></span> <span class=keyword2><span class=keyword>where</span></span> posnegs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>poss</span><span class=main>,</span> <span class=skolem>negs</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>posm</span></span> <span class=skolem><span class=skolem>negm</span></span> <span class=keyword2><span class=keyword>where</span></span> posnegm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>posm</span><span class=main>,</span> <span class=skolem>negm</span><span class=main>)</span> <span class=main>=</span> partition mmonitorable_exec <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> pos_monitorable<span class=main>:</span> <span class=quoted><span class=quoted>"list_all mmonitorable_exec <span class=skolem>posm</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posnegm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> neg_monitorable<span class=main>:</span> <span class=quoted><span class=quoted>"list_all mmonitorable_exec <span class=main>(</span>map remove_neg <span class=skolem>negm</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted>"8.prems"</span> posnegm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>posm</span> <span class=main>⊆</span> set <span class=skolem>poss</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted>"8.hyps"</span><span class=main>(</span>1<span class=main>)</span> posnegs posnegm <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>negs</span> <span class=main>⊆</span> set <span class=skolem>negm</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> posnegs posnegm <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>poss</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted>"8.prems"</span> posnegm <span class=quoted><span class=quoted>‹set <span class=skolem>posm</span> <span class=main>⊆</span> set <span class=skolem>poss</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>negs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> neg_monitorable <span class=quoted>"8.hyps"</span><span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> posnegm refl<span class=main>]</span> <span class=quoted><span class=quoted>‹set <span class=skolem>negs</span> <span class=main>⊆</span> set <span class=skolem>negm</span>›</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>negm</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>posm</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted>"8.prems"</span> posnegm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>negs</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>poss</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹set <span class=skolem>posm</span> <span class=main>⊆</span> set <span class=skolem>poss</span>›</span></span> <span class=quoted><span class=quoted>‹set <span class=skolem>negs</span> <span class=main>⊆</span> set <span class=skolem>negm</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=main>(</span>Formula.Ands <span class=skolem>l</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posnegs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=main>(</span>Formula.Ands <span class=skolem>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all Formula.future_bounded <span class=skolem>posm</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> pos_monitorable <span class=quoted>"8.hyps"</span><span class=main>(</span>1<span class=main>)</span> posnegm <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.pred_mono_strong<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> fnegm<span class=main>:</span> <span class=quoted><span class=quoted>"list_all Formula.future_bounded <span class=main>(</span>map remove_neg <span class=skolem>negm</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> neg_monitorable <span class=quoted>"8.hyps"</span><span class=main>(</span>2<span class=main>)</span> posnegm <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.pred_mono_strong<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all Formula.future_bounded <span class=skolem>negm</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=skolem>negm</span> <span class=main>⟹</span> Formula.future_bounded <span class=bound>x</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>negm</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=main>(</span>remove_neg <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> fnegm <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> set <span class=skolem>negm</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>x</span></span><span class=main>)</span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all Formula.future_bounded <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>using</span></span> posnegm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>13 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>14 <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> one_enat_def cases_Neg_iff<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>15 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_mono<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> mmonitorable_regex_def mmonitorable_def cases_Neg_iff regex.pred_set<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>16 <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_regex_mono<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> mmonitorable_regex_def mmonitorable_def cases_Neg_iff regex.pred_set<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> mmonitorable_def mmonitorable_regex_def is_simple_eq_def one_enat_def list.pred_set<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> monitorable_formula_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"mmonitorable <span class=free>φ</span> <span class=main>=</span> mmonitorable_exec <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> mmonitorable_exec_mmonitorable safe_formula_mmonitorable_exec mmonitorable_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Handling regular expressions›</span></span>

<span class=keyword1><span class=command>datatype</span></span> mregex <span class=main>=</span>
  MSkip <span class=quoted>nat</span>
  <span class=main>|</span> MTestPos <span class=quoted>nat</span>
  <span class=main>|</span> MTestNeg <span class=quoted>nat</span>
  <span class=main>|</span> MPlus <span class=quoted>mregex</span> <span class=quoted>mregex</span>
  <span class=main>|</span> MTimes <span class=quoted>mregex</span> <span class=quoted>mregex</span>
  <span class=main>|</span> MStar <span class=quoted>mregex</span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>ok</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ok</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>ok</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>from_mregex</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>from_mregex</span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> Regex.Skip <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>from_mregex</span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>=</span> Regex.Test <span class=main>(</span><span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>from_mregex</span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_formula <span class=main>(</span>Formula.Neg <span class=main>(</span><span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>then</span> Regex.Test <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.Neg <span class=main>(</span><span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> Regex.Test <span class=main>(</span>Formula.Neg <span class=main>(</span><span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>from_mregex</span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>=</span> Regex.Plus <span class=main>(</span><span class=free>from_mregex</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>from_mregex</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>from_mregex</span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>=</span> Regex.Times <span class=main>(</span><span class=free>from_mregex</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>from_mregex</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>from_mregex</span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>=</span> Regex.Star <span class=main>(</span><span class=free>from_mregex</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>to_mregex_exec</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>to_mregex_exec</span> <span class=main>(</span>Regex.Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>=</span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex_exec</span> <span class=main>(</span>Regex.Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_formula <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>then</span> <span class=main>(</span>MTestPos <span class=main>(</span>length <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>]</span><span class=main>)</span>
     <span class=keyword1>else</span> <span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span> Formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=main>(</span>MTestNeg <span class=main>(</span>length <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=bound>φ'</span><span class=main>]</span><span class=main>)</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=main>(</span>MSkip <span class=main>0</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex_exec</span> <span class=main>(</span>Regex.Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex_exec</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ms</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex_exec</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>ys</span>
     <span class=keyword1>in</span> <span class=main>(</span>MPlus <span class=bound>mr</span> <span class=bound>ms</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex_exec</span> <span class=main>(</span>Regex.Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex_exec</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ms</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex_exec</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>ys</span>
     <span class=keyword1>in</span> <span class=main>(</span>MTimes <span class=bound>mr</span> <span class=bound>ms</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex_exec</span> <span class=main>(</span>Regex.Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex_exec</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>MStar <span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>shift</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>shift</span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>=</span> MSkip <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>shift</span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>=</span> MTestPos <span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>shift</span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>=</span> MTestNeg <span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>shift</span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>=</span> MPlus <span class=main>(</span><span class=free>shift</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>shift</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>shift</span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>=</span> MTimes <span class=main>(</span><span class=free>shift</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>shift</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>shift</span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>=</span> MStar <span class=main>(</span><span class=free>shift</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>k</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>to_mregex</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>to_mregex</span> <span class=main>(</span>Regex.Skip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex</span> <span class=main>(</span>Regex.Test <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_formula <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>then</span> <span class=main>(</span>MTestPos <span class=main>0</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>]</span><span class=main>)</span>
     <span class=keyword1>else</span> <span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span> Formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=main>(</span>MTestNeg <span class=main>0</span><span class=main>,</span> <span class=main>[</span><span class=bound>φ'</span><span class=main>]</span><span class=main>)</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=main>(</span>MSkip <span class=main>0</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex</span> <span class=main>(</span>Regex.Plus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ms</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex</span> <span class=free><span class=bound><span class=entity>s</span></span></span>
     <span class=keyword1>in</span> <span class=main>(</span>MPlus <span class=bound>mr</span> <span class=main>(</span>shift <span class=bound>ms</span> <span class=main>(</span>length <span class=bound>ys</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=bound>ys</span> <span class=main>@</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex</span> <span class=main>(</span>Regex.Times <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ms</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex</span> <span class=free><span class=bound><span class=entity>s</span></span></span>
     <span class=keyword1>in</span> <span class=main>(</span>MTimes <span class=bound>mr</span> <span class=main>(</span>shift <span class=bound>ms</span> <span class=main>(</span>length <span class=bound>ys</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=bound>ys</span> <span class=main>@</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>to_mregex</span> <span class=main>(</span>Regex.Star <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>=</span> <span class=free>to_mregex</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>MStar <span class=bound>mr</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> shift_0<span class=main>:</span> <span class=quoted><span class=quoted>"shift <span class=free>r</span> <span class=main>0</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> shift_shift<span class=main>:</span> <span class=quoted><span class=quoted>"shift <span class=main>(</span>shift <span class=free>r</span> <span class=free>k</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> shift <span class=free>r</span> <span class=main>(</span><span class=free>k</span> <span class=main>+</span> <span class=free>j</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_to_mregex_exec<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>case</span> to_mregex <span class=free>r</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>⇒</span> to_mregex_exec <span class=free>r</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>(</span>shift <span class=bound>mr</span> <span class=main>(</span>length <span class=free>xs</span><span class=main>)</span><span class=main>,</span> <span class=free>xs</span> <span class=main>@</span> <span class=bound>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> shift_shift <span class=dynamic><span class=dynamic>ac_simps</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_to_mregex_exec_Nil<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> to_mregex_exec <span class=free>r</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> to_mregex_to_mregex_exec<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> xs<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> r <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>r</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> shift_0<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ok_mono<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>m</span> <span class=main>≤</span> <span class=free>n</span> <span class=main>⟹</span> ok <span class=free>n</span> <span class=free>mr</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> from_mregex_cong<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> <span class=free>m</span><span class=main>.</span> <span class=free>xs</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>=</span> <span class=free>ys</span> <span class=main>!</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> from_mregex <span class=free>mr</span> <span class=free>xs</span> <span class=main>=</span> from_mregex <span class=free>mr</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> not_Neg_cases<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>ψ</span><span class=main>.</span> <span class=free>φ</span> <span class=main>≠</span> Formula.Neg <span class=bound>ψ</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>φ</span> <span class=keyword1>of</span> formula.Neg <span class=bound>ψ</span> <span class=main>⇒</span> <span class=free>f</span> <span class=bound>ψ</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_exec_ok<span class=main>:</span>
  <span class=quoted><span class=quoted>"to_mregex_exec <span class=free>r</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>ys</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>zs</span><span class=main>.</span> <span class=free>ys</span> <span class=main>=</span> <span class=free>xs</span> <span class=main>@</span> <span class=bound>zs</span> <span class=main>∧</span> set <span class=bound>zs</span> <span class=main>=</span> atms <span class=free>r</span> <span class=main>∧</span> ok <span class=main>(</span>length <span class=free>ys</span><span class=main>)</span> <span class=free>mr</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quoted><span class=free>ys</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Skip <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x'</span><span class=main>.</span> <span class=skolem>x</span> <span class=main>=</span> Formula.Neg <span class=bound>x'</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> Test <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> Test <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def not_Neg_cases <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits formula.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits formula.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> ok_shift<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=main>(</span><span class=free>i</span> <span class=main>+</span> <span class=free>m</span><span class=main>)</span> <span class=main>(</span>Monitor.shift <span class=free>r</span> <span class=free>i</span><span class=main>)</span> <span class=main>⟷</span> ok <span class=free>m</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_ok<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>ys</span><span class=main>)</span> <span class=main>⟹</span> set <span class=free>ys</span> <span class=main>=</span> atms <span class=free>r</span> <span class=main>∧</span> ok <span class=main>(</span>length <span class=free>ys</span><span class=main>)</span> <span class=free>mr</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quoted><span class=free>ys</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Skip <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x'</span><span class=main>.</span> <span class=skolem>x</span> <span class=main>=</span> Formula.Neg <span class=bound>x'</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> Test <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> Test <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def not_Neg_cases <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> ok_shift atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Times <span class=skolem>r1</span> <span class=skolem>r2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> ok_shift atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> ok_mono <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> from_mregex_shift<span class=main>:</span> <span class=quoted><span class=quoted>"from_mregex <span class=main>(</span>shift <span class=free>r</span> <span class=main>(</span>length <span class=free>xs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>=</span> from_mregex <span class=free>r</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> from_mregex_to_mregex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> case_prod from_mregex <span class=main>(</span>to_mregex <span class=free>r</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> to_mregex_ok <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> from_mregex_cong <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append from_mregex_shift cases_Neg_iff
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits modality.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> from_mregex_eq<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span> from_mregex <span class=free>mr</span> <span class=free>φs</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> from_mregex_to_mregex<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>r</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> from_mregex_to_mregex_exec<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> case_prod from_mregex <span class=main>(</span>to_mregex_exec <span class=free>r</span> <span class=free>xs</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>b</span> <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Plus<span class=main>(</span>3<span class=main>)</span> Plus<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>xs</span></span><span class=main>]</span> Plus<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>to_mregex_exec <span class=skolem>r</span> <span class=skolem>xs</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> to_mregex_exec_ok
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> from_mregex_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> m <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>snd <span class=main>(</span>to_mregex_exec <span class=skolem>r</span> <span class=skolem>xs</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesF <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> TimesF<span class=main>(</span>3<span class=main>)</span> TimesF<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>xs</span></span><span class=main>]</span> TimesF<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>to_mregex_exec <span class=skolem>r</span> <span class=skolem>xs</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> to_mregex_exec_ok
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> from_mregex_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> m <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>snd <span class=main>(</span>to_mregex_exec <span class=skolem>r</span> <span class=skolem>xs</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesP <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> TimesP<span class=main>(</span>3<span class=main>)</span> TimesP<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>xs</span></span><span class=main>]</span> TimesP<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>to_mregex_exec <span class=skolem>r</span> <span class=skolem>xs</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> to_mregex_exec_ok
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> from_mregex_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> m <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>snd <span class=main>(</span>to_mregex_exec <span class=skolem>r</span> <span class=skolem>xs</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>b</span> <span class=skolem>g</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Star<span class=main>(</span>2<span class=main>)</span> Star<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>xs</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>


<span class=keyword1><span class=command>derive</span></span> linorder <span class=quoted>mregex</span>

<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹LPD›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>saturate</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>saturate</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>=</span> while <span class=main>(</span><span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>S</span> <span class=main>≠</span> <span class=bound>S</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>f</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> saturate_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"saturate <span class=free>f</span> <span class=free>S</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>S'</span> <span class=main>=</span> <span class=free>f</span> <span class=free>S</span> <span class=keyword1>in</span> <span class=keyword1>if</span> <span class=bound>S'</span> <span class=main>=</span> <span class=free>S</span> <span class=keyword1>then</span> <span class=free>S</span> <span class=keyword1>else</span> saturate <span class=free>f</span> <span class=bound>S'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> saturate_def Let_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> while_unfold<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>MTimesL</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>S</span></span></span> <span class=main>=</span> MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>S</span></span></span>"</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>MTimesR</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>r</span><span class=main>.</span> MTimes <span class=bound>r</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>R</span></span></span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>LPD</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>LPD</span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>{}</span> <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> <span class=main>{</span>MSkip <span class=bound>m</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>LPD</span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>LPD</span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>LPD</span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>LPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>LPD</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>LPD</span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> MTimesR <span class=main>(</span><span class=free>LPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∪</span> <span class=free>LPD</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>LPD</span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> MTimesR <span class=main>(</span><span class=free>LPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>LPDi</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>LPDi</span> <span class=main>0</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>LPDi</span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>s</span> <span class=main>∈</span> LPD <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>.</span> <span class=free>LPDi</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>s</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_Suc_alt<span class=main>:</span> <span class=quoted><span class=quoted>"LPDi <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span> <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>s</span> <span class=main>∈</span> LPDi <span class=free>i</span> <span class=free>r</span><span class=main>.</span> LPD <span class=bound>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>LPDs</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>i</span><span class=main>.</span> LPDi <span class=bound>i</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_refl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>∈</span> LPDs <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> LPDs_def <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>lemma</span></span> LPDs_trans<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>∈</span> LPD <span class=free>s</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> LPDs <span class=free>t</span> <span class=main>⟹</span> <span class=free>r</span> <span class=main>∈</span> LPDs <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> LPDs_def LPDi_Suc_alt <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> LPDi.simps <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_Test<span class=main>:</span>
  <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=main>(</span>MSkip <span class=main>0</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MSkip <span class=main>0</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=main>(</span>MTestPos <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestPos <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=main>(</span>MTestNeg <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestNeg <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_Test<span class=main>:</span>
  <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MSkip <span class=main>0</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MSkip <span class=main>0</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MTestPos <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestPos <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MTestNeg <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestNeg <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>using</span></span> LPDi_Test <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_MSkip<span class=main>:</span> <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=main>(</span>MSkip <span class=free>n</span><span class=main>)</span> <span class=main>⊆</span> MSkip <span class=main>`</span> <span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free>n</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>n</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDi_Test<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_Suc_eq <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_MSkip<span class=main>:</span> <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MSkip <span class=free>n</span><span class=main>)</span> <span class=main>⊆</span> MSkip <span class=main>`</span> <span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free>n</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>using</span></span> LPDi_MSkip <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_Plus<span class=main>:</span> <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=main>(</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> LPDi <span class=free>i</span> <span class=free>r</span> <span class=main>∪</span> LPDi <span class=free>i</span> <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_Plus<span class=main>:</span> <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> LPDs <span class=free>r</span> <span class=main>∪</span> LPDs <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>using</span></span> LPDi_Plus<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_Times<span class=main>:</span>
  <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=main>(</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> MTimesR <span class=main>(</span><span class=main>⋃</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>.</span> LPDi <span class=bound>j</span> <span class=free>r</span><span class=main>)</span> <span class=free>s</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>.</span> LPDi <span class=bound>j</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> Suc<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_Times<span class=main>:</span> <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> MTimesR <span class=main>(</span>LPDs <span class=free>r</span><span class=main>)</span> <span class=free>s</span> <span class=main>∪</span> LPDs <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>using</span></span> LPDi_Times<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_Star<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>⟹</span> LPDi <span class=free>j</span> <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MStar <span class=free>r</span><span class=main>}</span> <span class=main>∪</span> MTimesR <span class=main>(</span><span class=main>⋃</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>.</span> LPDi <span class=bound>j</span> <span class=free>r</span><span class=main>)</span> <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>j</span></span> <span class=quoted><span class=free>r</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Suc<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 5 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def image_iff le_Suc_eq
        <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>0</span>"</span></span><span class=main><span class=main>]</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> Suc<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDi_Times<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_Star<span class=main>:</span> <span class=quoted><span class=quoted>"LPDs <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MStar <span class=free>r</span><span class=main>}</span> <span class=main>∪</span> MTimesR <span class=main>(</span>LPDs <span class=free>r</span><span class=main>)</span> <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>using</span></span> LPDi_Star<span class=main>[</span><span class=operator>OF</span> order_refl<span class=main>,</span> <span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>r</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> finite_LPDs<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>LPDs <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MSkip <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDs_MSkip<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTestPos <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDs_Test<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTestNeg <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDs_Test<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDs_Plus<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDs_Times<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> MTimesR_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> LPDs_Star<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> MTimesR_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>context</span></span> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>abbreviation</span></span> <span class=main>(</span>input<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>addLPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>S</span><span class=main>.</span> insert <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>S</span> <span class=main>∪</span> Set.bind <span class=main>(</span>insert <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>S</span><span class=main>)</span> LPD"</span></span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>lemma</span></span> mono_addLPD<span class=main>:</span> <span class=quoted><span class=quoted>"mono <span class=main>(</span>addLPD <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mono_def Set.bind_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>lemma</span></span> LPDs_aux1<span class=main>:</span> <span class=quoted><span class=quoted>"lfp <span class=main>(</span>addLPD <span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> LPDs <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> lfp_induct<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addLPD<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> LPDs_refl LPDs_trans <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Set.bind_def<span class=main>)</span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>lemma</span></span> LPDs_aux2<span class=main>:</span> <span class=quoted><span class=quoted>"LPDi <span class=free>i</span> <span class=free>r</span> <span class=main>⊆</span> lfp <span class=main>(</span>addLPD <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> lfp_unfold<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addLPD<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> lfp_unfold<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addLPD<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> LPDi_Suc_alt <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> LPDi.simps<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_alt<span class=main>:</span> <span class=quoted><span class=quoted>"LPDs <span class=free>r</span> <span class=main>=</span> lfp <span class=main>(</span>addLPD <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> LPDs_aux1 LPDs_aux2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> LPDs_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"LPDs <span class=free>r</span> <span class=main>=</span> saturate <span class=main>(</span>addLPD <span class=free>r</span><span class=main>)</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_alt saturate_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> lfp_while<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addLPD _ finite_LPDs<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=quoted><span class=free>r</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> LPDs_refl LPDs_trans Set.bind_def<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹RPD›</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>RPD</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>RPD</span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>{}</span> <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> <span class=main>{</span>MSkip <span class=bound>m</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>RPD</span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>RPD</span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>RPD</span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>RPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>RPD</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>RPD</span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> MTimesL <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>(</span><span class=free>RPD</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>∪</span> <span class=free>RPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>RPD</span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> MTimesL <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>RPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>RPDi</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>RPDi</span> <span class=main>0</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>RPDi</span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>s</span> <span class=main>∈</span> RPD <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>.</span> <span class=free>RPDi</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>s</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_Suc_alt<span class=main>:</span> <span class=quoted><span class=quoted>"RPDi <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span> <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>s</span> <span class=main>∈</span> RPDi <span class=free>i</span> <span class=free>r</span><span class=main>.</span> RPD <span class=bound>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>RPDs</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>i</span><span class=main>.</span> RPDi <span class=bound>i</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_refl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>∈</span> RPDs <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> RPDs_def <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>lemma</span></span> RPDs_trans<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>∈</span> RPD <span class=free>s</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> RPDs <span class=free>t</span> <span class=main>⟹</span> <span class=free>r</span> <span class=main>∈</span> RPDs <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> RPDs_def RPDi_Suc_alt <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> RPDi.simps <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_Test<span class=main>:</span>
  <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=main>(</span>MSkip <span class=main>0</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MSkip <span class=main>0</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=main>(</span>MTestPos <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestPos <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=main>(</span>MTestNeg <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestNeg <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_Test<span class=main>:</span>
  <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MSkip <span class=main>0</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MSkip <span class=main>0</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MTestPos <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestPos <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MTestNeg <span class=free>φ</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTestNeg <span class=free>φ</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>using</span></span> RPDi_Test <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_MSkip<span class=main>:</span> <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=main>(</span>MSkip <span class=free>n</span><span class=main>)</span> <span class=main>⊆</span> MSkip <span class=main>`</span> <span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free>n</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>n</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDi_Test<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_Suc_eq <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_MSkip<span class=main>:</span> <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MSkip <span class=free>n</span><span class=main>)</span> <span class=main>⊆</span> MSkip <span class=main>`</span> <span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free>n</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>using</span></span> RPDi_MSkip <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_Plus<span class=main>:</span> <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=main>(</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> RPDi <span class=free>i</span> <span class=free>r</span> <span class=main>∪</span> RPDi <span class=free>i</span> <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_Suc_RPD_Plus<span class=main>:</span>
  <span class=quoted><span class=quoted>"RPDi <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span> <span class=free>r</span> <span class=main>⊆</span> RPDs <span class=main>(</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"RPDi <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span> <span class=free>s</span> <span class=main>⊆</span> RPDs <span class=main>(</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=free>i</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_Plus<span class=main>:</span> <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MPlus <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> RPDs <span class=free>r</span> <span class=main>∪</span> RPDs <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>using</span></span> RPDi_Plus<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_Times<span class=main>:</span>
  <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=main>(</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> MTimesL <span class=free>r</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>.</span> RPDi <span class=bound>j</span> <span class=free>s</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>.</span> RPDi <span class=bound>j</span> <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> Suc<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_Times<span class=main>:</span> <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MTimes <span class=free>r</span> <span class=free>s</span><span class=main>}</span> <span class=main>∪</span> MTimesL <span class=free>r</span> <span class=main>(</span>RPDs <span class=free>s</span><span class=main>)</span> <span class=main>∪</span> RPDs <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>using</span></span> RPDi_Times<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_Star<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>⟹</span> RPDi <span class=free>j</span> <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MStar <span class=free>r</span><span class=main>}</span> <span class=main>∪</span> MTimesL <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>.</span> RPDi <span class=bound>j</span> <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>j</span></span> <span class=quoted><span class=free>r</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Suc<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 5 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def image_iff le_Suc_eq
        <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>0</span>"</span></span><span class=main><span class=main>]</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> Suc<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> set_mp<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDi_Times<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_Star<span class=main>:</span> <span class=quoted><span class=quoted>"RPDs <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>MStar <span class=free>r</span><span class=main>}</span> <span class=main>∪</span> MTimesL <span class=main>(</span>MStar <span class=free>r</span><span class=main>)</span> <span class=main>(</span>RPDs <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>using</span></span> RPDi_Star<span class=main>[</span><span class=operator>OF</span> order_refl<span class=main>,</span> <span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>r</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> finite_RPDs<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>RPDs <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> MSkip
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDs_MSkip<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTestPos <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDs_Test<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTestNeg <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDs_Test<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDs_Plus<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDs_Times<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> MTimesL_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> finite_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> RPDs_Star<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> MTimesL_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>context</span></span> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>abbreviation</span></span> <span class=main>(</span>input<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>addRPD</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>S</span><span class=main>.</span> insert <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>S</span> <span class=main>∪</span> Set.bind <span class=main>(</span>insert <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>S</span><span class=main>)</span> RPD"</span></span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>lemma</span></span> mono_addRPD<span class=main>:</span> <span class=quoted><span class=quoted>"mono <span class=main>(</span>addRPD <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mono_def Set.bind_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>lemma</span></span> RPDs_aux1<span class=main>:</span> <span class=quoted><span class=quoted>"lfp <span class=main>(</span>addRPD <span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> RPDs <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> lfp_induct<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addRPD<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> RPDs_refl RPDs_trans <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Set.bind_def<span class=main>)</span>

<span class=keyword2><span class=keyword>private</span></span> <span class=keyword1><span class=command>lemma</span></span> RPDs_aux2<span class=main>:</span> <span class=quoted><span class=quoted>"RPDi <span class=free>i</span> <span class=free>r</span> <span class=main>⊆</span> lfp <span class=main>(</span>addRPD <span class=free>r</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> lfp_unfold<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addRPD<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> lfp_unfold<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addRPD<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> RPDi_Suc_alt <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> RPDi.simps<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_alt<span class=main>:</span> <span class=quoted><span class=quoted>"RPDs <span class=free>r</span> <span class=main>=</span> lfp <span class=main>(</span>addRPD <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> RPDs_aux1 RPDs_aux2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> RPDs_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"RPDs <span class=free>r</span> <span class=main>=</span> saturate <span class=main>(</span>addRPD <span class=free>r</span><span class=main>)</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_alt saturate_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> lfp_while<span class=main><span class=main>[</span></span><span class=operator>OF</span> mono_addRPD _ finite_RPDs<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=quoted><span class=free>r</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> RPDs_refl RPDs_trans Set.bind_def<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹The executable monitor›</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> ts <span class=main>=</span> <span class=quoted>nat</span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> mbuf2 <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> table list"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> mbufn <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> table list list"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> msaux <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> list"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> muaux <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> table <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> list"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> mrδaux <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ts <span class=main>×</span> <span class=main>(</span>mregex<span class=main>,</span> <span class=tfree>'a</span> table<span class=main>)</span> mapping<span class=main>)</span> list"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> mlδaux <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> list"</span></span>

<span class=keyword1><span class=command>datatype</span></span> mconstraint <span class=main>=</span> MEq <span class=main>|</span> MLess <span class=main>|</span> MLessEq

<span class=keyword1><span class=command>record</span></span> args <span class=main>=</span>
  args_ivl <span class=main>::</span> <span class=quoted>ℐ</span>
  args_n <span class=main>::</span> <span class=quoted>nat</span>
  args_L <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span>
  args_R <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span>
  args_pos <span class=main>::</span> <span class=quoted>bool</span>

<span class=keyword1><span class=command>datatype</span></span> <span class=main>(</span>dead <span class=tfree>'msaux</span><span class=main>,</span> dead <span class=tfree>'muaux</span><span class=main>)</span> mformula <span class=main>=</span>
  MRel <span class=quoted><span class=quoted>"event_data table"</span></span>
  <span class=main>|</span> MPred <span class=quoted>Formula.name</span> <span class=quoted><span class=quoted>"Formula.trm list"</span></span>
  <span class=main>|</span> MLet <span class=quoted>Formula.name</span> <span class=quoted>nat</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span>
  <span class=main>|</span> MAnd <span class=quoted><span class=quoted>"nat set"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted>bool</span> <span class=quoted><span class=quoted>"nat set"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"event_data mbuf2"</span></span>
  <span class=main>|</span> MAndAssign <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"nat <span class=main>×</span> Formula.trm"</span></span>
  <span class=main>|</span> MAndRel <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"Formula.trm <span class=main>×</span> bool <span class=main>×</span> mconstraint <span class=main>×</span> Formula.trm"</span></span>
  <span class=main>|</span> MAnds <span class=quoted><span class=quoted>"nat set list"</span></span> <span class=quoted><span class=quoted>"nat set list"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula list"</span></span> <span class=quoted><span class=quoted>"event_data mbufn"</span></span>
  <span class=main>|</span> MOr <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"event_data mbuf2"</span></span>
  <span class=main>|</span> MNeg <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span>
  <span class=main>|</span> MExists <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span>
  <span class=main>|</span> MAgg <span class=quoted>bool</span> <span class=quoted>nat</span> <span class=quoted>Formula.agg_op</span> <span class=quoted>nat</span> <span class=quoted><span class=quoted>"Formula.trm"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span>
  <span class=main>|</span> MPrev <span class=quoted>ℐ</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted>bool</span> <span class=quoted><span class=quoted>"event_data table list"</span></span> <span class=quoted><span class=quoted>"ts list"</span></span>
  <span class=main>|</span> MNext <span class=quoted>ℐ</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted>bool</span> <span class=quoted><span class=quoted>"ts list"</span></span>
  <span class=main>|</span> MSince <span class=quoted>args</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"event_data mbuf2"</span></span> <span class=quoted><span class=quoted>"ts list"</span></span> <span class=quoted><span class=quoted>"<span class=tfree>'msaux</span>"</span></span>
  <span class=main>|</span> MUntil <span class=quoted>args</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=quoted><span class=quoted>"event_data mbuf2"</span></span> <span class=quoted><span class=quoted>"ts list"</span></span> <span class=quoted><span class=quoted>"<span class=tfree>'muaux</span>"</span></span>
  <span class=main>|</span> MMatchP <span class=quoted>ℐ</span> <span class=quoted><span class=quoted>"mregex"</span></span> <span class=quoted><span class=quoted>"mregex list"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula list"</span></span> <span class=quoted><span class=quoted>"event_data mbufn"</span></span> <span class=quoted><span class=quoted>"ts list"</span></span> <span class=quoted><span class=quoted>"event_data mrδaux"</span></span>
  <span class=main>|</span> MMatchF <span class=quoted>ℐ</span> <span class=quoted><span class=quoted>"mregex"</span></span> <span class=quoted><span class=quoted>"mregex list"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula list"</span></span> <span class=quoted><span class=quoted>"event_data mbufn"</span></span> <span class=quoted><span class=quoted>"ts list"</span></span> <span class=quoted><span class=quoted>"event_data mlδaux"</span></span>

<span class=keyword1><span class=command>record</span></span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate <span class=main>=</span>
  mstate_i <span class=main>::</span> <span class=quoted>nat</span>
  mstate_m <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span>
  mstate_n <span class=main>::</span> <span class=quoted>nat</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eq_rel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> Formula.trm <span class=main>⇒</span> Formula.trm <span class=main>⇒</span> event_data table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eq_rel</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Const <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Const <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=keyword1>then</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eq_rel</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Const <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> singleton_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eq_rel</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Const <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> singleton_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eq_rel</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>lemma</span></span> regex_atms_size<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> regex.atms <span class=free>r</span> <span class=main>⟹</span> size <span class=free>x</span> <span class=main>&lt;</span> regex.size_regex size <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> atms_size<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> atms <span class=free>r</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"size <span class=free>x</span> <span class=main>&lt;</span> Regex.size_regex size <span class=free>r</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> regex.atms <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> <span class=skolem>y</span> <span class=keyword1>of</span> formula.Neg <span class=bound>z</span> <span class=main>⇒</span> <span class=free>x</span> <span class=main>=</span> <span class=bound>z</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"size <span class=free>x</span> <span class=main>&lt;</span> Regex.size_regex size <span class=free>r</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>y</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> formula.exhaust<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> regex_atms_size<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> atms_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> regex_atms_size<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>init_args</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ℐ <span class=main>⇒</span> nat <span class=main>⇒</span> nat set <span class=main>⇒</span> nat set <span class=main>⇒</span> bool <span class=main>⇒</span> args"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>init_args</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>=</span> <span class=main>⦇</span>args_ivl <span class=main>=</span> <span class=free><span class=bound><span class=entity>I</span></span></span><span class=main>,</span> args_n <span class=main>=</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span> args_L <span class=main>=</span> <span class=free><span class=bound><span class=entity>L</span></span></span><span class=main>,</span> args_R <span class=main>=</span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>,</span> args_pos <span class=main>=</span> <span class=free><span class=bound><span class=entity>pos</span></span></span><span class=main>⦈</span>"</span></span>

<span class=keyword1><span class=command>locale</span></span> msaux <span class=main>=</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>valid_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> event_data msaux <span class=main>⇒</span> bool"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>init_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>add_new_ts_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>join_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>add_new_table_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>result_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> event_data table"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_init_msaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>L</span> <span class=main>⊆</span> <span class=free>R</span> <span class=main>⟹</span>
    <span class=free>valid_msaux</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>pos</span><span class=main>)</span> <span class=main>0</span> <span class=main>(</span><span class=free>init_msaux</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>pos</span><span class=main>)</span><span class=main>)</span> <span class=main>[]</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_add_new_ts_msaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span> <span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span> <span class=main>⟹</span>
    <span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span><span class=free>add_new_ts_msaux</span> <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_join_msaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span>
    table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span> <span class=main>⟹</span>
    <span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span><span class=free>join_msaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_add_new_table_msaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span>
    table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>rel2</span> <span class=main>⟹</span>
    <span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span><span class=free>add_new_table_msaux</span> <span class=free>args</span> <span class=free>rel2</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span><span class=keyword1>case</span> <span class=free>auxlist</span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>=&gt;</span> <span class=main>[</span><span class=main>(</span><span class=free>cur</span><span class=main>,</span> <span class=free>rel2</span><span class=main>)</span><span class=main>]</span>
    <span class=main>|</span> <span class=main>(</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=free>cur</span> <span class=keyword1>then</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span> <span class=main>∪</span> <span class=free>rel2</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span> <span class=keyword1>else</span> <span class=main>(</span><span class=free>cur</span><span class=main>,</span> <span class=free>rel2</span><span class=main>)</span> <span class=main>#</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> valid_result_msaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span> <span class=free>result_msaux</span> <span class=free>args</span> <span class=free>aux</span> <span class=main>=</span>
    foldr <span class=main>(∪)</span> <span class=main>[</span><span class=bound>rel</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=free>auxlist</span><span class=main>,</span> left <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>≤</span> <span class=free>cur</span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>check_before</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ℐ <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>check_before</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>dt</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span> <span class=main>⟷</span> enat <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>+</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>&lt;</span> enat <span class=free><span class=bound><span class=entity>dt</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>proj_thd</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'b</span> <span class=main>×</span> <span class=tfree>'c</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'c</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>proj_thd</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>a2</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>update_until</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> ts <span class=main>⇒</span> event_data muaux <span class=main>⇒</span> event_data muaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>update_until</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>rel1</span></span></span> <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=main>(</span>args_pos <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free><span class=bound><span class=entity>rel1</span></span></span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free><span class=bound><span class=entity>rel1</span></span></span><span class=main>,</span>
      <span class=keyword1>if</span> mem <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=main>(</span>args_pos <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>@</span>
    <span class=main>[</span><span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>rel1</span></span></span><span class=main>,</span> <span class=keyword1>if</span> left <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span><span class=main>]</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> map_proj_thd_update_until<span class=main>:</span> <span class=quoted><span class=quoted>"map proj_thd <span class=main>(</span>takeWhile <span class=main>(</span>check_before <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=free>nt</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>=</span>
  map proj_thd <span class=main>(</span>takeWhile <span class=main>(</span>check_before <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=free>nt</span><span class=main>)</span> <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>auxlist</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> update_until_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>auxlist</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> update_until_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_until</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ℐ <span class=main>⇒</span> ts <span class=main>⇒</span> event_data muaux <span class=main>⇒</span> event_data table list <span class=main>×</span> event_data muaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_until</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_until</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2</span></span></span><span class=main>)</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>+</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=keyword1>then</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_until</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=keyword1>in</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a2</span></span></span> <span class=main>#</span> <span class=bound>xs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2</span></span></span><span class=main>)</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> eval_until_length<span class=main>:</span>
  <span class=quoted><span class=quoted>"eval_until <span class=free>I</span> <span class=free>nt</span> <span class=free>auxlist</span> <span class=main>=</span> <span class=main>(</span><span class=free>res</span><span class=main>,</span> <span class=free>auxlist'</span><span class=main>)</span> <span class=main>⟹</span> length <span class=free>auxlist</span> <span class=main>=</span> length <span class=free>res</span> <span class=main>+</span> length <span class=free>auxlist'</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>I</span></span> <span class=quoted><span class=free>nt</span></span> <span class=quoted><span class=free>auxlist</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>res</span></span> <span class=quoted><span class=free>auxlist'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> eval_until.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> eval_until_res<span class=main>:</span> <span class=quoted><span class=quoted>"eval_until <span class=free>I</span> <span class=free>nt</span> <span class=free>auxlist</span> <span class=main>=</span> <span class=main>(</span><span class=free>res</span><span class=main>,</span> <span class=free>auxlist'</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>res</span> <span class=main>=</span> map proj_thd <span class=main>(</span>takeWhile <span class=main>(</span>check_before <span class=free>I</span> <span class=free>nt</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>I</span></span> <span class=quoted><span class=free>nt</span></span> <span class=quoted><span class=free>auxlist</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>res</span></span> <span class=quoted><span class=free>auxlist'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> eval_until.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> eval_until_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"eval_until <span class=free>I</span> <span class=free>nt</span> <span class=free>auxlist</span> <span class=main>=</span> <span class=main>(</span><span class=free>res</span><span class=main>,</span> <span class=free>auxlist'</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>auxlist'</span> <span class=main>=</span> drop <span class=main>(</span>length <span class=free>res</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>I</span></span> <span class=quoted><span class=free>nt</span></span> <span class=quoted><span class=free>auxlist</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>res</span></span> <span class=quoted><span class=free>auxlist'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> eval_until.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>locale</span></span> muaux <span class=main>=</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>valid_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> event_data muaux <span class=main>⇒</span> bool"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>init_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'muaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>add_new_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> <span class=tfree>'muaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>length_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> nat"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>eval_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> event_data table list <span class=main>×</span> <span class=tfree>'muaux</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_init_muaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>L</span> <span class=main>⊆</span> <span class=free>R</span> <span class=main>⟹</span>
    <span class=free>valid_muaux</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>pos</span><span class=main>)</span> <span class=main>0</span> <span class=main>(</span><span class=free>init_muaux</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>pos</span><span class=main>)</span><span class=main>)</span> <span class=main>[]</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_add_new_muaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span>
    table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span> <span class=main>⟹</span>
    table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>rel2</span> <span class=main>⟹</span>
    <span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span> <span class=main>⟹</span>
    <span class=free>valid_muaux</span> <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span><span class=free>add_new_muaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_length_muaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span> <span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span> <span class=main>=</span> length <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_eval_muaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span> <span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span> <span class=main>⟹</span>
    <span class=free>eval_muaux</span> <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=free>res</span><span class=main>,</span> <span class=free>aux'</span><span class=main>)</span> <span class=main>⟹</span> eval_until <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=free>nt</span> <span class=free>auxlist</span> <span class=main>=</span> <span class=main>(</span><span class=free>res'</span><span class=main>,</span> <span class=free>auxlist'</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>res</span> <span class=main>=</span> <span class=free>res'</span> <span class=main>∧</span> <span class=free>valid_muaux</span> <span class=free>args</span> <span class=free>cur</span> <span class=free>aux'</span> <span class=free>auxlist'</span>"</span></span>

<span class=keyword1><span class=command>locale</span></span> maux <span class=main>=</span> msaux <span class=quoted><span class=free>valid_msaux</span></span> <span class=quoted><span class=free>init_msaux</span></span> <span class=quoted><span class=free>add_new_ts_msaux</span></span> <span class=quoted><span class=free>join_msaux</span></span> <span class=quoted><span class=free>add_new_table_msaux</span></span> <span class=quoted><span class=free>result_msaux</span></span> <span class=main>+</span>
  muaux <span class=quoted><span class=free>valid_muaux</span></span> <span class=quoted><span class=free>init_muaux</span></span> <span class=quoted><span class=free>add_new_muaux</span></span> <span class=quoted><span class=free>length_muaux</span></span> <span class=quoted><span class=free>eval_muaux</span></span>
  <span class=keyword2><span class=keyword>for</span></span> <span class=free>valid_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> event_data msaux <span class=main>⇒</span> bool"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>init_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>add_new_ts_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>join_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>add_new_table_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> <span class=tfree>'msaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>result_msaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> event_data table"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>valid_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> event_data muaux <span class=main>⇒</span> bool"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>init_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'muaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>add_new_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> <span class=tfree>'muaux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>length_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> nat"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>eval_muaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> nat <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> event_data table list <span class=main>×</span> <span class=tfree>'muaux</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>split_assignment</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> nat <span class=main>×</span> Formula.trm"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>split_assignment</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=keyword1>of</span>
      <span class=main>(</span>Formula.Var <span class=bound>x</span><span class=main>,</span> Formula.Var <span class=bound>y</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=keyword1>then</span> <span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>
    <span class=main>|</span> <span class=main>(</span>Formula.Var <span class=bound>x</span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>
    <span class=main>|</span> <span class=main>(</span><span class=main><span class=bound>_</span></span><span class=main>,</span> Formula.Var <span class=bound>y</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_assignment</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>split_constraint</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.formula <span class=main>⇒</span> Formula.trm <span class=main>×</span> bool <span class=main>×</span> mconstraint <span class=main>×</span> Formula.trm"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> True<span class=main>,</span> MEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main>(</span>Formula.Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> True<span class=main>,</span> MLess<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main>(</span>Formula.LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> True<span class=main>,</span> MLessEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> False<span class=main>,</span> MEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> False<span class=main>,</span> MLess<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> False<span class=main>,</span> MLessEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>split_constraint</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>function</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=main>(</span>sequential<span class=main>)</span> <span class=entity>minit0</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> MNeg <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=keyword1>else</span> MRel empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> MRel <span class=main>(</span>eq_rel <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Pred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> MPred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> MLet <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>(</span>Formula.nfv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=main>(</span>Formula.nfv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> MOr <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_assignment <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>then</span>
      MAndAssign <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>split_assignment <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> safe_formula <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>then</span>
      MAnd <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> True <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> is_constraint <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>then</span>
      MAndRel <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>split_constraint <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=keyword1>of</span> Formula.Neg <span class=bound>ψ</span> <span class=main>⇒</span>
      MAnd <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> False <span class=main>(</span>fv <span class=bound>ψ</span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=bound>ψ</span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>pos</span><span class=main>,</span> <span class=bound>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=bound>mpos</span> <span class=main>=</span> map <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=bound>pos</span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=bound>mneg</span> <span class=main>=</span> map <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>(</span>map remove_neg <span class=bound>neg</span><span class=main>)</span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=bound>vpos</span> <span class=main>=</span> map fv <span class=bound>pos</span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=bound>vneg</span> <span class=main>=</span> map fv <span class=bound>neg</span> <span class=keyword1>in</span>
    MAnds <span class=bound>vpos</span> <span class=bound>vneg</span> <span class=main>(</span><span class=bound>mpos</span> <span class=main>@</span> <span class=bound>mneg</span><span class=main>)</span> <span class=main>(</span>replicate <span class=main>(</span>length <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> MExists <span class=main>(</span><span class=free>minit0</span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> MAgg <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free>minit0</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> MPrev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> True <span class=main>[]</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span> MNext <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> True <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_formula <span class=free><span class=bound><span class=entity>φ</span></span></span>
    <span class=keyword1>then</span> MSince <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> True<span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=free>init_msaux</span> <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> True<span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span>
      Formula.Neg <span class=bound>φ</span> <span class=main>⇒</span> MSince <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> False<span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=free>init_msaux</span> <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> False<span class=main>)</span><span class=main>)</span>
    <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> undefined<span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> safe_formula <span class=free><span class=bound><span class=entity>φ</span></span></span>
    <span class=keyword1>then</span> MUntil <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> True<span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=free>init_muaux</span> <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> True<span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>of</span>
      Formula.Neg <span class=bound>φ</span> <span class=main>⇒</span> MUntil <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> False<span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=free>init_muaux</span> <span class=main>(</span>init_args <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> False<span class=main>)</span><span class=main>)</span>
    <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> undefined<span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>=</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span>
    <span class=keyword1>in</span> MMatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=bound>mr</span> <span class=main>(</span>sorted_list_of_set <span class=main>(</span>RPDs <span class=bound>mr</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>(</span>replicate <span class=main>(</span>length <span class=bound>φs</span><span class=main>)</span> <span class=main>[]</span><span class=main>)</span> <span class=main>[]</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>=</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span>
    <span class=keyword1>in</span> MMatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=bound>mr</span> <span class=main>(</span>sorted_list_of_set <span class=main>(</span>LPDs <span class=bound>mr</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>(</span>replicate <span class=main>(</span>length <span class=bound>φs</span><span class=main>)</span> <span class=main>[]</span><span class=main>)</span> <span class=main>[]</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>minit0</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> undefined"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span><span class=main>.</span> size <span class=bound>φ</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_Suc_eq_le size_list_estimation' size_remove_neg
      <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> to_mregex_ok<span class=main><span class=main>[</span></span><span class=operator>OF</span> sym<span class=main><span class=main>]</span></span> atms_size<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>minit</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.formula <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>minit</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>n</span> <span class=main>=</span> Formula.nfv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>in</span> <span class=main>⦇</span>mstate_i <span class=main>=</span> <span class=main>0</span><span class=main>,</span> mstate_m <span class=main>=</span> minit0 <span class=bound>n</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span> mstate_n <span class=main>=</span> <span class=bound>n</span><span class=main>⦈</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>minit_safe</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>minit_safe</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> mmonitorable_exec <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>then</span> minit <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>else</span> undefined<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mprev_next</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ℐ <span class=main>⇒</span> event_data table list <span class=main>⇒</span> ts list <span class=main>⇒</span> event_data table list <span class=main>×</span> event_data table list <span class=main>×</span> ts list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mprev_next</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mprev_next</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mprev_next</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mprev_next</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>=</span> <span class=free>mprev_next</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=main>(</span><span class=keyword1>if</span> mem <span class=main>(</span><span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span> <span class=main>#</span> <span class=bound>ys</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mbuf2_add</span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data table list <span class=main>⇒</span> event_data table list <span class=main>⇒</span> event_data mbuf2 <span class=main>⇒</span> event_data mbuf2"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mbuf2_add</span> <span class=free><span class=bound><span class=entity>xs'</span></span></span> <span class=free><span class=bound><span class=entity>ys'</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>xs'</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>ys'</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mbuf2_take</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> event_data mbuf2 <span class=main>⇒</span> <span class=tfree>'b</span> list <span class=main>×</span> event_data mbuf2"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mbuf2_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>buf</span><span class=main>)</span> <span class=main>=</span> <span class=free>mbuf2_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=keyword1>in</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>#</span> <span class=bound>zs</span><span class=main>,</span> <span class=bound>buf</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mbuf2_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mbuf2t_take</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span>
    event_data mbuf2 <span class=main>⇒</span> ts list <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>×</span> event_data mbuf2 <span class=main>×</span> ts list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mbuf2t_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>z</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>mbuf2t_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>mbuf2t_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>z</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> size_list_length_diff1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span> <span class=main>[]</span> <span class=main>∉</span> set <span class=free>xs</span> <span class=main>⟹</span>
  size_list <span class=main>(</span><span class=main>λ</span><span class=bound>xs</span><span class=main>.</span> length <span class=bound>xs</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=free>xs</span> <span class=main>&lt;</span> size_list length <span class=free>xs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>x</span> <span class=skolem>xs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>xs</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mbufn_add</span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data table list list <span class=main>⇒</span> event_data mbufn <span class=main>⇒</span> event_data mbufn"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mbufn_add</span> <span class=free><span class=bound><span class=entity>xs'</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=main>=</span> List.map2 <span class=main>(@)</span> <span class=free><span class=bound><span class=entity>xs</span></span></span> <span class=free><span class=bound><span class=entity>xs'</span></span></span>"</span></span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>mbufn_take</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>event_data table list <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> event_data mbufn <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>×</span> event_data mbufn"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mbufn_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>z</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>=</span> <span class=main>[]</span> <span class=main>∨</span> <span class=main>[]</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=keyword1>then</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=free>mbufn_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span>map hd <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>(</span>map tl <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=bound>buf</span><span class=main>)</span><span class=main>.</span> size_list length <span class=bound>buf</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> comp_def Suc_le_eq size_list_length_diff1<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>mbufnt_take</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>event_data table list <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span>
    <span class=tfree>'b</span> <span class=main>⇒</span> event_data mbufn <span class=main>⇒</span> ts list <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>×</span> event_data mbufn <span class=main>×</span> ts list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mbufnt_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>z</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=main>[]</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>∨</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span> <span class=main>[]</span> <span class=keyword1>then</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=free>mbufnt_take</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span>map hd <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span>hd <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>(</span>map tl <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span>tl <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>match</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trm list <span class=main>⇒</span> event_data list <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇀</span> event_data<span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=main>[]</span> <span class=main>[]</span> <span class=main>=</span> Some Map.empty"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=main>(</span>Formula.Const <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=keyword1>then</span> <span class=free>match</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=keyword1>else</span> None<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>match</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=keyword1>of</span>
      None <span class=main>⇒</span> None
    <span class=main>|</span> Some <span class=bound>f</span> <span class=main>⇒</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>f</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>of</span>
        None <span class=main>⇒</span> Some <span class=main>(</span><span class=bound>f</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>↦</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span>
      <span class=main>|</span> Some <span class=bound>z</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=bound>z</span> <span class=keyword1>then</span> Some <span class=bound>f</span> <span class=keyword1>else</span> None<span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>match</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> None"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>meval_trm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trm <span class=main>⇒</span> event_data tuple <span class=main>⇒</span> event_data"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> the <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Const <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Plus <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>+</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Minus <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>-</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.UMinus <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=main>-</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Mult <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>*</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Div <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=keyword1>div</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.Mod <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=keyword1>mod</span> <span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.F2i <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> EInt <span class=main>(</span>integer_of_event_data <span class=main>(</span><span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval_trm</span> <span class=main>(</span>Formula.I2f <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> EFloat <span class=main>(</span>double_of_event_data <span class=main>(</span><span class=free>meval_trm</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>eval_agg</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> bool <span class=main>⇒</span> nat <span class=main>⇒</span> Formula.agg_op <span class=main>⇒</span> nat <span class=main>⇒</span> Formula.trm <span class=main>⇒</span>
  event_data table <span class=main>⇒</span> event_data table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_agg</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>rel</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>rel</span></span></span> <span class=main>=</span> empty_table
    <span class=keyword1>then</span> singleton_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>(</span>eval_agg_op <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=main>{}</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span>
      <span class=keyword1>let</span> <span class=bound>group</span> <span class=main>=</span> Set.filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> drop <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>k</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>;</span>
        <span class=bound>M</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=main>(</span><span class=bound>y</span><span class=main>,</span> ecard <span class=main>(</span>Set.filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> meval_trm <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=bound>group</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> meval_trm <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>`</span> <span class=bound>group</span>
      <span class=keyword1>in</span> <span class=bound>k</span><span class=main>[</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=bound>M</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>`</span> <span class=main>(</span>drop <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>update_since</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> ts <span class=main>⇒</span>
  <span class=tfree>'msaux</span> <span class=main>⇒</span> event_data table <span class=main>×</span> <span class=tfree>'msaux</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>update_since</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>rel1</span></span></span> <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>aux0</span> <span class=main>=</span> <span class=free>join_msaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>rel1</span></span></span> <span class=main>(</span><span class=free>add_new_ts_msaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span><span class=main>;</span>
         <span class=bound>aux'</span> <span class=main>=</span> <span class=free>add_new_table_msaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=bound>aux0</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=free>result_msaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=bound>aux'</span><span class=main>,</span> <span class=bound>aux'</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>lookup</span> <span class=main>=</span> Mapping.lookup_default empty_table"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>ε_lax</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> join <span class=free><span class=bound><span class=entity>guard</span></span></span> True <span class=main>(</span><span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> join <span class=free><span class=bound><span class=entity>guard</span></span></span> False <span class=main>(</span><span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> join <span class=main>(</span><span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> True <span class=main>(</span><span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ε_lax</span> <span class=free><span class=bound><span class=entity>guard</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>guard</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>rε_strict</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>i</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>=</span> empty_table <span class=keyword1>then</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> ε_lax <span class=main>(</span><span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>lε_strict</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>i</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>!</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>=</span> empty_table <span class=keyword1>then</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> ε_lax <span class=main>(</span><span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lε_strict</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>rδ</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>mregex <span class=main>⇒</span> mregex<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>mregex<span class=main>,</span> <span class=tfree>'a</span> table<span class=main>)</span> mapping <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span> mregex <span class=main>⇒</span> <span class=tfree>'a</span> table"</span></span>  <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> empty_table <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> lookup <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MSkip <span class=bound>m</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> empty_table"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> empty_table"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rδ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∪</span> ε_lax <span class=main>(</span><span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>rδ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MTimes <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>lδ</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>mregex <span class=main>⇒</span> mregex<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>mregex<span class=main>,</span> <span class=tfree>'a</span> table<span class=main>)</span> mapping <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>⇒</span> mregex <span class=main>⇒</span> <span class=tfree>'a</span> table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MSkip <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> empty_table <span class=main>|</span> Suc <span class=bound>m</span> <span class=main>⇒</span> lookup <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MSkip <span class=bound>m</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestPos <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> empty_table"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTestNeg <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>=</span> empty_table"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MPlus <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> <span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lδ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MTimes <span class=bound>t</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∪</span> ε_lax <span class=main>(</span><span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>lδ</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>lδ</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MTimes <span class=bound>t</span> <span class=main>(</span>MStar <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> mrtabulate <span class=main>::</span> <span class=quoted><span class=quoted>"mregex list <span class=main>⇒</span> <span class=main>(</span>mregex <span class=main>⇒</span> <span class=tfree>'b</span> table<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>mregex<span class=main>,</span> <span class=tfree>'b</span> table<span class=main>)</span> mapping"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>ks</span> <span class=bound>f</span><span class=main>.</span> <span class=main>(</span>map_of <span class=main>(</span>List.map_filter <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> <span class=keyword1>let</span> <span class=bound>fk</span> <span class=main>=</span> <span class=bound>f</span> <span class=bound>k</span> <span class=keyword1>in</span> <span class=keyword1>if</span> <span class=bound>fk</span> <span class=main>=</span> empty_table <span class=keyword1>then</span> None <span class=keyword1>else</span> Some <span class=main>(</span><span class=bound>k</span><span class=main>,</span> <span class=bound>fk</span><span class=main>)</span><span class=main>)</span> <span class=bound>ks</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> lookup_tabulate<span class=main>:</span>
  <span class=quoted><span class=quoted>"distinct <span class=free>xs</span> <span class=main>⟹</span> lookup <span class=main>(</span>mrtabulate <span class=free>xs</span> <span class=free>f</span><span class=main>)</span> <span class=free>x</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=keyword1>then</span> <span class=free>f</span> <span class=free>x</span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> lookup_default_def lookup_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def map_filter_def map_of_eq_None_iff o_def image_image <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> map_of_SomeD
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>update_matchP</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ℐ <span class=main>⇒</span> mregex <span class=main>⇒</span> mregex list <span class=main>⇒</span> event_data table list <span class=main>⇒</span> ts <span class=main>⇒</span>
  event_data mrδaux <span class=main>⇒</span> event_data table <span class=main>×</span> event_data mrδaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>update_matchP</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>aux</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=main>[</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> mrtabulate <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>(</span><span class=main>λ</span><span class=bound>mr</span><span class=main>.</span>
        rδ id <span class=bound>rel</span> <span class=free><span class=bound><span class=entity>rels</span></span></span> <span class=bound>mr</span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=keyword1>then</span> rε_strict <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span> <span class=bound>mr</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>,</span> enat <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=free><span class=bound><span class=entity>I</span></span></span><span class=main>]</span>
      <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> <span class=main>[</span><span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> mrtabulate <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>(</span>rε_strict <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>]</span>
      <span class=main>|</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>aux'</span> <span class=main>⇒</span> <span class=main>(</span><span class=keyword1>if</span> fst <span class=bound>x</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=keyword1>then</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>aux'</span>
                     <span class=keyword1>else</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> mrtabulate <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>(</span>rε_strict <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>aux'</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span>foldr <span class=main>(∪)</span> <span class=main>[</span>lookup <span class=bound>rel</span> <span class=free><span class=bound><span class=entity>mr</span></span></span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=bound>aux</span><span class=main>,</span> left <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>update_matchF_base</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>update_matchF_base</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=bound>X</span> <span class=main>=</span> mrtabulate <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>(</span>lε_strict <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span><span class=main>)</span>
     <span class=keyword1>in</span> <span class=main>(</span><span class=main>[</span><span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>rels</span></span></span><span class=main>,</span> <span class=keyword1>if</span> left <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> lookup <span class=bound>X</span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span><span class=main>]</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>update_matchF_step</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>update_matchF_step</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rels'</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span> <span class=main>(</span><span class=bound>aux'</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=bound>Y</span> <span class=main>=</span> mrtabulate <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>(</span>lδ id <span class=bound>X</span> <span class=bound>rels'</span><span class=main>)</span>
     <span class=keyword1>in</span> <span class=main>(</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rels'</span><span class=main>,</span> <span class=keyword1>if</span> mem <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=keyword1>then</span> <span class=bound>rel</span> <span class=main>∪</span> lookup <span class=bound>Y</span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=keyword1>else</span> <span class=bound>rel</span><span class=main>)</span> <span class=main>#</span> <span class=bound>aux'</span><span class=main>,</span> <span class=bound>Y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>update_matchF</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ℐ <span class=main>⇒</span> mregex <span class=main>⇒</span> mregex list <span class=main>⇒</span> event_data table list <span class=main>⇒</span> ts <span class=main>⇒</span> event_data mlδaux <span class=main>⇒</span> event_data mlδaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>update_matchF</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span>
     fst <span class=main>(</span>foldr <span class=main>(</span>update_matchF_step <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>update_matchF_base <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>rels</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_matchF</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ℐ <span class=main>⇒</span> mregex <span class=main>⇒</span> ts <span class=main>⇒</span> event_data mlδaux <span class=main>⇒</span> event_data table list <span class=main>×</span> event_data mlδaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_matchF</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_matchF</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>rels</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>)</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>+</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=keyword1>then</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_matchF</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=keyword1>in</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>rel</span></span></span> <span class=main>#</span> <span class=bound>xs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>rels</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>)</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>map_split</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>map_split</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>map_split</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>xs</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=bound>z</span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>zs</span><span class=main>)</span> <span class=main>=</span> <span class=free>map_split</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>xs</span></span></span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>y</span> <span class=main>#</span> <span class=bound>ys</span><span class=main>,</span> <span class=bound>z</span> <span class=main>#</span> <span class=bound>zs</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_assignment</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>×</span> Formula.trm <span class=main>⇒</span> event_data tuple <span class=main>⇒</span> event_data tuple"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_assignment</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>[</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>:=</span>Some <span class=main>(</span>meval_trm <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>]</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_constraint0</span> <span class=main>::</span> <span class=quoted><span class=quoted>"mconstraint <span class=main>⇒</span> event_data <span class=main>⇒</span> event_data <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_constraint0</span> MEq <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_constraint0</span> MLess <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>eval_constraint0</span> MLessEq <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_constraint</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trm <span class=main>×</span> bool <span class=main>×</span> mconstraint <span class=main>×</span> Formula.trm <span class=main>⇒</span> event_data tuple <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>c</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=main>(</span>eval_constraint0 <span class=free><span class=bound><span class=entity>c</span></span></span> <span class=main>(</span>meval_trm <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>meval_trm <span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>meval</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ts <span class=main>⇒</span> Formula.database <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula <span class=main>⇒</span>
    event_data table list <span class=main>×</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MRel <span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[</span><span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>]</span><span class=main>,</span> MRel <span class=free><span class=bound><span class=entity>rel</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MPred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=main>λ</span><span class=bound>f</span><span class=main>.</span> Table.tabulate <span class=bound>f</span> <span class=main>0</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>`</span> Option.these
    <span class=main>(</span>match <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>`</span> <span class=bound>X</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> <span class=main>[</span><span class=main>{}</span><span class=main>]</span> <span class=main>|</span> Some <span class=bound>xs</span> <span class=main>⇒</span> <span class=bound>xs</span><span class=main>)</span><span class=main>,</span> MPred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MLet <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>(</span>Mapping.update <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>(</span>map <span class=main>(</span>image <span class=main>(</span>map the<span class=main>)</span><span class=main>)</span> <span class=bound>xs</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>db</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> MLet <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=bound>φ</span> <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MAnd <span class=free><span class=bound><span class=entity>A_φ</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>A_ψ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>;</span>
      <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>buf</span><span class=main>)</span> <span class=main>=</span> mbuf2_take <span class=main>(</span><span class=main>λ</span><span class=bound>r1</span> <span class=bound>r2</span><span class=main>.</span> bin_join <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>A_φ</span></span></span> <span class=bound>r1</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>A_ψ</span></span></span> <span class=bound>r2</span><span class=main>)</span> <span class=main>(</span>mbuf2_add <span class=bound>xs</span> <span class=bound>ys</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MAnd <span class=free><span class=bound><span class=entity>A_φ</span></span></span> <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>A_ψ</span></span></span> <span class=bound>ψ</span> <span class=bound>buf</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MAndAssign <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>r</span><span class=main>.</span> eval_assignment <span class=free><span class=bound><span class=entity>conf</span></span></span> <span class=main>`</span> <span class=bound>r</span><span class=main>)</span> <span class=bound>xs</span><span class=main>,</span> MAndAssign <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MAndRel <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>map <span class=main>(</span>Set.filter <span class=main>(</span>eval_constraint <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span><span class=main>)</span> <span class=bound>xs</span><span class=main>,</span> MAndRel <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MAnds <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>R</span> <span class=main>=</span> map <span class=main>(</span><span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>L</span></span></span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=bound>buf</span> <span class=main>=</span> mbufn_add <span class=main>(</span>map fst <span class=bound>R</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=keyword1>in</span>
    <span class=keyword1>let</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>buf</span><span class=main>)</span> <span class=main>=</span> mbufn_take <span class=main>(</span><span class=main>λ</span><span class=bound>xs</span> <span class=bound>zs</span><span class=main>.</span> <span class=bound>zs</span> <span class=main>@</span> <span class=main>[</span>mmulti_join <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=bound>xs</span><span class=main>]</span><span class=main>)</span> <span class=main>[]</span> <span class=bound>buf</span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MAnds <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=main>(</span>map snd <span class=bound>R</span><span class=main>)</span> <span class=bound>buf</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MOr <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>;</span>
      <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>buf</span><span class=main>)</span> <span class=main>=</span> mbuf2_take <span class=main>(</span><span class=main>λ</span><span class=bound>r1</span> <span class=bound>r2</span><span class=main>.</span> <span class=bound>r1</span> <span class=main>∪</span> <span class=bound>r2</span><span class=main>)</span> <span class=main>(</span>mbuf2_add <span class=bound>xs</span> <span class=bound>ys</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MOr <span class=bound>φ</span> <span class=bound>ψ</span> <span class=bound>buf</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MNeg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>r</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>r</span> <span class=main>=</span> empty_table <span class=keyword1>then</span> unit_table <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=keyword1>else</span> empty_table<span class=main>)</span><span class=main>)</span> <span class=bound>xs</span><span class=main>,</span> MNeg <span class=bound>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MExists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>r</span><span class=main>.</span> tl <span class=main>`</span> <span class=bound>r</span><span class=main>)</span> <span class=bound>xs</span><span class=main>,</span> MExists <span class=bound>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MAgg <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>map <span class=main>(</span>eval_agg <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=bound>xs</span><span class=main>,</span> MAgg <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MPrev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span>
      <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>buf</span><span class=main>,</span> <span class=bound>nts</span><span class=main>)</span> <span class=main>=</span> mprev_next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>@</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=keyword1>then</span> empty_table <span class=main>#</span> <span class=bound>zs</span> <span class=keyword1>else</span> <span class=bound>zs</span><span class=main>,</span> MPrev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=bound>φ</span> False <span class=bound>buf</span> <span class=bound>nts</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MNext <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span>
      <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>first</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>first</span></span></span><span class=main>)</span> <span class=keyword1>of</span> <span class=main>(</span><span class=main><span class=bound>_</span></span> <span class=main>#</span> <span class=bound>xs</span><span class=main>,</span> True<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> False<span class=main>)</span> <span class=main>|</span> <span class=bound>a</span> <span class=main>⇒</span> <span class=bound>a</span><span class=main>)</span><span class=main>;</span>
      <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=bound>nts</span><span class=main>)</span> <span class=main>=</span> mprev_next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=bound>xs</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MNext <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=bound>φ</span> <span class=bound>first</span> <span class=bound>nts</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MSince <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>;</span>
      <span class=main>(</span><span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>,</span> <span class=bound>buf</span><span class=main>,</span> <span class=bound>nts</span><span class=main>)</span> <span class=main>=</span> mbuf2t_take <span class=main>(</span><span class=main>λ</span><span class=bound>r1</span> <span class=bound>r2</span> <span class=bound>t</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>.</span>
        <span class=keyword1>let</span> <span class=main>(</span><span class=bound>z</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=main>=</span> update_since <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=bound>r1</span> <span class=bound>r2</span> <span class=bound>t</span> <span class=bound>aux</span>
        <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=main>[</span><span class=bound>z</span><span class=main>]</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>(</span>mbuf2_add <span class=bound>xs</span> <span class=bound>ys</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MSince <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=bound>φ</span> <span class=bound>ψ</span> <span class=bound>buf</span> <span class=bound>nts</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MUntil <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>ys</span><span class=main>,</span> <span class=bound>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>;</span>
      <span class=main>(</span><span class=bound>aux</span><span class=main>,</span> <span class=bound>buf</span><span class=main>,</span> <span class=bound>nts</span><span class=main>)</span> <span class=main>=</span> mbuf2t_take <span class=main>(</span><span class=free>add_new_muaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>mbuf2_add <span class=bound>xs</span> <span class=bound>ys</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span><span class=main>;</span>
      <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=main>=</span> <span class=free>eval_muaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>nts</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=bound>aux</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MUntil <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=bound>φ</span> <span class=bound>ψ</span> <span class=bound>buf</span> <span class=bound>nts</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MMatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xss</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>=</span> map_split id <span class=main>(</span>map <span class=main>(</span><span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span><span class=main>;</span>
      <span class=main>(</span><span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>,</span> <span class=bound>buf</span><span class=main>,</span> <span class=bound>nts</span><span class=main>)</span> <span class=main>=</span> mbufnt_take <span class=main>(</span><span class=main>λ</span><span class=bound>rels</span> <span class=bound>t</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>.</span>
        <span class=keyword1>let</span> <span class=main>(</span><span class=bound>z</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=main>=</span> update_matchP <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=bound>rels</span> <span class=bound>t</span> <span class=bound>aux</span>
        <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=main>[</span><span class=bound>z</span><span class=main>]</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>(</span>mbufn_add <span class=bound>xss</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MMatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=bound>φs</span> <span class=bound>buf</span> <span class=bound>nts</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>(</span>MMatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xss</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>=</span> map_split id <span class=main>(</span>map <span class=main>(</span><span class=free>meval</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span><span class=main>)</span><span class=main>;</span>
      <span class=main>(</span><span class=bound>aux</span><span class=main>,</span> <span class=bound>buf</span><span class=main>,</span> <span class=bound>nts</span><span class=main>)</span> <span class=main>=</span> mbufnt_take <span class=main>(</span>update_matchF <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>mbufn_add <span class=bound>xss</span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span><span class=main>)</span><span class=main>;</span>
      <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=main>=</span> eval_matchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>nts</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=bound>aux</span>
    <span class=keyword1>in</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> MMatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=bound>φs</span> <span class=bound>buf</span> <span class=bound>nts</span> <span class=bound>aux</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>mstep</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.database <span class=main>×</span> ts <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>×</span> event_data table<span class=main>)</span> list <span class=main>×</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mstep</span> <span class=free><span class=bound><span class=entity>tdb</span></span></span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>m</span><span class=main>)</span> <span class=main>=</span> meval <span class=main>(</span>mstate_n <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>)</span> <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>tdb</span></span></span><span class=main>)</span> <span class=main>(</span>fst <span class=free><span class=bound><span class=entity>tdb</span></span></span><span class=main>)</span> <span class=main>(</span>mstate_m <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>)</span>
     <span class=keyword1>in</span> <span class=main>(</span>List.enumerate <span class=main>(</span>mstate_i <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>)</span> <span class=bound>xs</span><span class=main>,</span>
      <span class=main>⦇</span>mstate_i <span class=main>=</span> mstate_i <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>+</span> length <span class=bound>xs</span><span class=main>,</span> mstate_m <span class=main>=</span> <span class=bound>m</span><span class=main>,</span> mstate_n <span class=main>=</span> mstate_n <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>⦈</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Verdict delay›</span></span>

<span class=keyword1><span class=command>context</span></span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>σ</span> <span class=main>::</span> <span class=quoted>Formula.trace</span> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>progress</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Formula.name <span class=main>⇀</span> nat<span class=main>)</span> <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> nat <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Pred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=keyword1>of</span> None <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>|</span> Some <span class=bound>k</span> <span class=main>⇒</span> <span class=bound>k</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free>progress</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>↦</span> <span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Or <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> min <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.And <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> min <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Ands <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>=</span> <span class=main>[]</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=keyword1>else</span> Min <span class=main>(</span>set <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> <span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Exists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> min <span class=main>(</span>Suc <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> <span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>-</span> <span class=main>1</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Since <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> min <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Until <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span>
    Inf <span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=main>∀</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>∧</span> <span class=bound>k</span> <span class=main>≤</span> min <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>⟶</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>+</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≥</span> τ <span class=free>σ</span> <span class=bound>k</span><span class=main>}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span> min_regex_default <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>=</span>
    Inf <span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=main>∀</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>∧</span> <span class=bound>k</span> <span class=main>≤</span> min_regex_default <span class=main>(</span><span class=free>progress</span> <span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=main>⟶</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>+</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>≥</span> τ <span class=free>σ</span> <span class=bound>k</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>progress_regex</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>=</span> min_regex_default <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> progress.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>
<span class=keyword1><span class=command>lemmas</span></span> progress_simps<span class=main>[</span><span class=operator>simp</span><span class=main>]</span> <span class=main>=</span> progress.simps<span class=main>[</span><span class=operator>folded</span> progress_regex_def<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>[</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator>THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> fun_cong<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator><span class=operator>THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> fun_cong<span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main><span class=main>]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>pred_mapping</span> <span class=free><span class=bound><span class=entity>Q</span></span></span> <span class=main>=</span> pred_fun <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> True<span class=main>)</span> <span class=main>(</span>pred_option <span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>rel_mapping</span> <span class=free><span class=bound><span class=entity>Q</span></span></span> <span class=main>=</span> rel_fun <span class=main>(=)</span> <span class=main>(</span>rel_option <span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_alt<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=free>Q</span> <span class=free>P</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span> <span class=main>∈</span> dom <span class=free>P</span><span class=main>.</span> <span class=free>Q</span> <span class=main>(</span>the <span class=main>(</span><span class=free>P</span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> pred_mapping_def pred_fun_def option.pred_set dom_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> rel_mapping_alt<span class=main>:</span> <span class=quoted><span class=quoted>"rel_mapping <span class=free>Q</span> <span class=free>P</span> <span class=free>P'</span> <span class=main>=</span> <span class=main>(</span>dom <span class=free>P</span> <span class=main>=</span> dom <span class=free>P'</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span> <span class=main>∈</span> dom <span class=free>P</span><span class=main>.</span> <span class=free>Q</span> <span class=main>(</span>the <span class=main>(</span><span class=free>P</span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>the <span class=main>(</span><span class=free>P'</span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rel_mapping_def rel_fun_def rel_option_iff dom_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> rel_mapping_map_upd<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=free>x</span> <span class=free>y</span> <span class=main>⟹</span> rel_mapping <span class=free>Q</span> <span class=free>P</span> <span class=free>P'</span> <span class=main>⟹</span> rel_mapping <span class=free>Q</span> <span class=main>(</span><span class=free>P</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=free>P'</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_map_upd<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=free>x</span> <span class=main>⟹</span> pred_mapping <span class=free>Q</span> <span class=free>P</span> <span class=main>⟹</span> pred_mapping <span class=free>Q</span> <span class=main>(</span><span class=free>P</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_empty<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=free>Q</span> Map.empty"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_mono<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=free>Q</span> <span class=free>P</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>≤</span> <span class=free>R</span> <span class=main>⟹</span> pred_mapping <span class=free>R</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_mono_strong<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=free>Q</span> <span class=free>P</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> dom <span class=free>P</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span>the <span class=main>(</span><span class=free>P</span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>R</span> <span class=main>(</span>the <span class=main>(</span><span class=free>P</span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> pred_mapping <span class=free>R</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_mono_gen<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span> <span class=main>⟹</span> rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>P'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt dom_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Min.coboundedI<span class=main><span class=main>[</span></span><span class=operator>THEN</span> order_trans<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Until<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>P</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>P'</span></span></span></span><span class=main>]</span> Until.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> trans_le_add1<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_superset_mono<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchF<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=skolem>P</span></span> <span class=quoted><span class=skolem>P'</span></span><span class=main>]</span> MatchF.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=quoted>"regex.atms <span class=skolem>r</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Min_le_iff progress_regex_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> trans_le_add1<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_superset_mono <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> less_le_trans order_trans<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Min_le_iff progress_regex_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> rel_mapping_reflp<span class=main>:</span> <span class=quoted><span class=quoted>"reflp <span class=free>Q</span> <span class=main>⟹</span> rel_mapping <span class=free>Q</span> <span class=free>P</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt reflp_def<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> progress_mono <span class=main>=</span> progress_mono_gen<span class=main>[</span><span class=operator>OF</span> _ rel_mapping_reflp<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> reflp_def<span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>simplified</span><span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> progress_le_gen<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Min.coboundedI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> a<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>hd <span class=skolem>l</span><span class=main>)</span> <span class=free>j</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>THEN</span> order_trans<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> trans_le_add1<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_lower<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> trans_le_add1<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_lower<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Min_le_iff progress_regex_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> progress_le<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> progress_le_gen<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted>Map.empty</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> progress_0_gen<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=main>0</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> progress_le_gen<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=free>P</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> progress_0<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>0</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>max_mapping</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'a</span> option<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'a</span> option<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>::</span> linorder<span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>max_mapping</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=keyword1>of</span>
    <span class=main>(</span>None<span class=main>,</span> None<span class=main>)</span> <span class=main>⇒</span> None
  <span class=main>|</span> <span class=main>(</span>Some <span class=bound>x</span><span class=main>,</span> None<span class=main>)</span> <span class=main>⇒</span> None
  <span class=main>|</span> <span class=main>(</span>None<span class=main>,</span> Some <span class=bound>x</span><span class=main>)</span> <span class=main>⇒</span> None
  <span class=main>|</span> <span class=main>(</span>Some <span class=bound>x</span><span class=main>,</span> Some <span class=bound>y</span><span class=main>)</span> <span class=main>⇒</span> Some <span class=main>(</span>max <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>Max_mapping</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'a</span> option<span class=main>)</span> set <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>::</span> linorder<span class=main>)</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Max_mapping</span> <span class=free><span class=bound><span class=entity>Ps</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=main>∀</span><span class=bound>P</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>Ps</span></span></span><span class=main>.</span> <span class=bound>P</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>≠</span> None<span class=main>)</span> <span class=keyword1>then</span> Some <span class=main>(</span>Max <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>P</span><span class=main>.</span> the <span class=main>(</span><span class=bound>P</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>Ps</span></span></span><span class=main>)</span><span class=main>)</span> <span class=keyword1>else</span> None<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> dom_max_mapping<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=main>(</span>max_mapping <span class=free>P1</span> <span class=free>P2</span><span class=main>)</span> <span class=main>=</span> dom <span class=free>P1</span> <span class=main>∩</span> dom <span class=free>P2</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> max_mapping_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> dom_Max_mapping<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=main>(</span>Max_mapping <span class=free>X</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋂</span><span class=bound>P</span> <span class=main>∈</span> <span class=free>X</span><span class=main>.</span> dom <span class=bound>P</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Max_mapping_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Max_mapping_coboundedI<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>Q</span> <span class=main>∈</span> <span class=free>X</span><span class=main>.</span> dom <span class=bound>Q</span> <span class=main>=</span> dom <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>∈</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=main>(</span>Max_mapping <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rel_mapping_alt
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> conjI ballI<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>X</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dom <span class=free>P</span> <span class=main>=</span> dom <span class=main>(</span>Max_mapping <span class=free>X</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> dom <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"the <span class=main>(</span><span class=free>P</span> <span class=skolem>p</span><span class=main>)</span> <span class=main>≤</span> the <span class=main>(</span>Max_mapping <span class=free>X</span> <span class=skolem>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Max_mapping_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Max.coboundedI imageI<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> rel_mapping_trans<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=keyword1>OO</span> <span class=free>Q</span> <span class=main>≤</span> <span class=free>R</span> <span class=main>⟹</span>
  rel_mapping <span class=free>P</span> <span class=free>P1</span> <span class=free>P2</span> <span class=main>⟹</span> rel_mapping <span class=free>Q</span> <span class=free>P2</span> <span class=free>P3</span> <span class=main>⟹</span> rel_mapping <span class=free>R</span> <span class=free>P1</span> <span class=free>P3</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt dom_def set_eq_iff<span class=main>)</span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>range_mapping</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> nat <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'b</span> <span class=main>⇒</span> nat option<span class=main>)</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>range_mapping</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>≡</span> pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>≤</span> <span class=bound>x</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>P</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> range_mapping_relax<span class=main>:</span>
  <span class=quoted><span class=quoted>"range_mapping <span class=free>i</span> <span class=free>j</span> <span class=free>P</span> <span class=main>⟹</span> <span class=free>i'</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>⟹</span> <span class=free>j'</span> <span class=main>≥</span> <span class=free>j</span> <span class=main>⟹</span> range_mapping <span class=free>i'</span> <span class=free>j'</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def set_eq_iff max_mapping_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> range_mapping_max_mapping<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"range_mapping <span class=free>i</span> <span class=free>j1</span> <span class=free>P1</span> <span class=main>⟹</span> range_mapping <span class=free>i</span> <span class=free>j2</span> <span class=free>P2</span> <span class=main>⟹</span> range_mapping <span class=free>i</span> <span class=main>(</span>max <span class=free>j1</span> <span class=free>j2</span><span class=main>)</span> <span class=main>(</span>max_mapping <span class=free>P1</span> <span class=free>P2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def set_eq_iff max_mapping_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> range_mapping_Max_mapping<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"finite <span class=free>X</span> <span class=main>⟹</span> <span class=free>X</span> <span class=main>≠</span> <span class=main>{}</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>X</span><span class=main>.</span> range_mapping <span class=free>i</span> <span class=main>(</span><span class=free>j</span> <span class=bound>x</span><span class=main>)</span> <span class=main>(</span><span class=free>P</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> range_mapping <span class=free>i</span> <span class=main>(</span>Max <span class=main>(</span><span class=free>j</span> <span class=main>`</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>Max_mapping <span class=main>(</span><span class=free>P</span> <span class=main>`</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt Max_mapping_def dom_def image_iff
      <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Max_ge_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_le<span class=main>:</span>
  <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>(≤)</span> <span class=free>i</span><span class=main>)</span> <span class=free>P1</span> <span class=main>⟹</span> rel_mapping <span class=main>(≤)</span> <span class=free>P1</span> <span class=free>P2</span> <span class=main>⟹</span> pred_mapping <span class=main>(</span><span class=main>(≤)</span> <span class=main>(</span><span class=free>i</span> <span class=main>::</span> nat<span class=main>)</span><span class=main>)</span> <span class=free>P2</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt pred_mapping_alt dom_def set_eq_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> pred_mapping_le'<span class=main>:</span>
  <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>(≤)</span> <span class=free>j</span><span class=main>)</span> <span class=free>P1</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>j</span> <span class=main>⟹</span> rel_mapping <span class=main>(≤)</span> <span class=free>P1</span> <span class=free>P2</span> <span class=main>⟹</span> pred_mapping <span class=main>(</span><span class=main>(≤)</span> <span class=main>(</span><span class=free>i</span> <span class=main>::</span> nat<span class=main>)</span><span class=main>)</span> <span class=free>P2</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt pred_mapping_alt dom_def set_eq_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_mapping_cobounded1<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=free>P1</span> <span class=main>⊆</span> dom <span class=free>P2</span> <span class=main>⟹</span> rel_mapping <span class=main>(≤)</span> <span class=free>P1</span> <span class=main>(</span>max_mapping <span class=free>P1</span> <span class=free>P2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> max_mapping_def rel_mapping_alt <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> dom_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_mapping_cobounded2<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=free>P2</span> <span class=main>⊆</span> dom <span class=free>P1</span> <span class=main>⟹</span> rel_mapping <span class=main>(≤)</span> <span class=free>P2</span> <span class=main>(</span>max_mapping <span class=free>P1</span> <span class=free>P2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> max_mapping_def rel_mapping_alt <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> dom_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_mapping_fun_upd2<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"max_mapping <span class=free>P1</span> <span class=main>(</span><span class=free>P2</span><span class=main>(</span><span class=free>p</span> <span class=main>:=</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>max_mapping <span class=free>P1</span> <span class=free>P2</span><span class=main>)</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> max_mapping_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> rel_mapping_max_mapping_fun_upd<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=free>P2</span> <span class=main>⊆</span> dom <span class=free>P1</span> <span class=main>⟹</span> <span class=free>p</span> <span class=main>∈</span> dom <span class=free>P2</span> <span class=main>⟹</span> the <span class=main>(</span><span class=free>P2</span> <span class=free>p</span><span class=main>)</span> <span class=main>≤</span> <span class=free>y</span> <span class=main>⟹</span>
  rel_mapping <span class=main>(≤)</span> <span class=free>P2</span> <span class=main>(</span>max_mapping <span class=free>P1</span> <span class=free>P2</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt max_mapping_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_ge_gen<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=free>φ</span> <span class=main>⟹</span>
   <span class=main>∃</span><span class=bound>P</span> <span class=bound>j</span><span class=main>.</span> dom <span class=bound>P</span> <span class=main>=</span> <span class=free>S</span> <span class=main>∧</span> range_mapping <span class=free>i</span> <span class=bound>j</span> <span class=bound>P</span> <span class=main>∧</span> <span class=free>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=bound>P</span> <span class=free>φ</span> <span class=bound>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>S</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=skolem>i</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt pred_mapping_alt dom_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P2</span></span> <span class=skolem><span class=skolem>j2</span></span> <span class=keyword2><span class=keyword>where</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P2</span> <span class=main>=</span> insert <span class=skolem>p</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j2</span> <span class=skolem>P2</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>ψ</span> <span class=skolem>j2</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Let<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt rel_mapping_alt dom_def<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P1</span></span> <span class=skolem><span class=skolem>j1</span></span> <span class=keyword2><span class=keyword>where</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P1</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=main>(</span>the <span class=main>(</span><span class=skolem>P2</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=skolem>j1</span> <span class=skolem>P1</span>"</span></span>
    <span class=quoted><span class=quoted>"the <span class=main>(</span><span class=skolem>P2</span> <span class=skolem>p</span><span class=main>)</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ</span> <span class=skolem>j1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Let<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P12</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> P1 P2 <span class=keyword1><span class=command>have</span></span> le1<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ</span> <span class=skolem>j1</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>:=</span> <span class=skolem>P1</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> progress_mono_gen<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt max_mapping_def<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> P1 P2 <span class=keyword1><span class=command>have</span></span> le2<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>ψ</span> <span class=skolem>j2</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ</span> <span class=skolem>j1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ψ</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> progress_mono_gen<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rel_mapping_alt max_mapping_def<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> progress.simps
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>:=</span> <span class=skolem>P1</span> <span class=skolem>p</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span><span class=main><span class=main>]</span></span> conjI<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dom <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>:=</span> <span class=skolem>P1</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1 P2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> dom_def max_mapping_def<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span> <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>:=</span> <span class=skolem>P1</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1 P2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def max_mapping_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>ψ</span> <span class=skolem>j2</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fact</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ</span> <span class=skolem>j1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ψ</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> le2 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>:=</span> <span class=skolem>P1</span> <span class=skolem>p</span><span class=main>)</span><span class=main>(</span><span class=skolem>p</span><span class=main>↦</span>progress <span class=free>σ</span> <span class=main>(</span><span class=var>?P12</span><span class=main>(</span><span class=skolem>p</span> <span class=main>:=</span> <span class=skolem>P1</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ψ</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> progress_mono_gen <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le1 rel_mapping_alt<span class=main>)</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> <span class=main>...</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Eq _ _<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=skolem>i</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Less _ _<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=skolem>i</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>LessEq _ _<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=skolem>i</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Or <span class=skolem>φ1</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Or<span class=main>(</span>3<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P1</span></span> <span class=skolem><span class=skolem>j1</span></span> <span class=keyword2><span class=keyword>where</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P1</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j1</span> <span class=skolem>P1</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ1</span> <span class=skolem>j1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Or<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> Or<span class=main>(</span>3<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P2</span></span> <span class=skolem><span class=skolem>j2</span></span> <span class=keyword2><span class=keyword>where</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P2</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j2</span> <span class=skolem>P2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>φ2</span> <span class=skolem>j2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Or<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span><span class=main>)</span> <span class=main>(</span>Formula.Or <span class=skolem>φ1</span> <span class=skolem>φ2</span><span class=main>)</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_mono_gen<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> P1 P2 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And <span class=skolem>φ1</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> And<span class=main>(</span>3<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P1</span></span> <span class=skolem><span class=skolem>j1</span></span> <span class=keyword2><span class=keyword>where</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P1</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j1</span> <span class=skolem>P1</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ1</span> <span class=skolem>j1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> And<span class=main>(</span>3<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P2</span></span> <span class=skolem><span class=skolem>j2</span></span> <span class=keyword2><span class=keyword>where</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P2</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j2</span> <span class=skolem>P2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>φ2</span> <span class=skolem>j2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span><span class=main>)</span> <span class=main>(</span>Formula.And <span class=skolem>φ1</span> <span class=skolem>φ2</span><span class=main>)</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_mono_gen<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> P1 P2 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>=</span> <span class=main>[]</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=skolem>i</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>from</span></span> Ands.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> Formula.future_bounded <span class=bound>φ</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>
    <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>φ</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span>
      <span class=keyword1><span class=command>with</span></span> Ands.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"dom <span class=skolem>P</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j</span> <span class=skolem>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=skolem>j</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Ands<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>φ</span></span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>Pj</span><span class=main>.</span> dom <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=skolem>i</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span>"</span></span>
        <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>Pj</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>Pj</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>P</span><span class=main>,</span> <span class=skolem>j</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=main>∃</span><span class=bound>Pj</span><span class=main>.</span> dom <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=skolem>i</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=bound>φ</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span>"</span></span>
      <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=main>∃</span><span class=bound>Pj</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>Pj</span> <span class=bound>φ</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> Ands<span class=main>(</span>1<span class=main>)</span> Ands.prems False <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>Pjf</span><span class=main>.</span> <span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=var>?P</span> <span class=main>(</span><span class=bound>Pjf</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>φ</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Ball_def <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> choice<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>Pjf</span></span> <span class=keyword2><span class=keyword>where</span></span> Pjf<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=var>?P</span> <span class=main>(</span><span class=skolem>Pjf</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>φ</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>Pf</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>Pf</span> <span class=main>=</span> fst <span class=keyword1>o</span> <span class=skolem>Pjf</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>jf</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>jf</span> <span class=main>=</span> snd <span class=keyword1>o</span> <span class=skolem>Pjf</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=main>(</span><span class=skolem>Pf</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=main>(</span><span class=skolem>jf</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>(</span><span class=skolem>Pf</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=skolem>Pf</span> <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span><span class=skolem>jf</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ</span>
      <span class=keyword1><span class=command>using</span></span> Pjf<span class=main>[</span><span class=operator>THEN</span> bspec<span class=main>,</span> <span class=operator>OF</span> that<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> Pf_def jf_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> progress.simps eq_False<span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>,</span> <span class=operator>OF</span> False<span class=main>]</span> if_False
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>subst</span> Min_ge_iff<span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> False<span class=main>)</span><span class=main><span class=keyword3>,</span></span>
          <span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=keyword1>MAX</span> <span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=skolem>jf</span> <span class=bound>φ</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Max_mapping <span class=main>(</span><span class=skolem>Pf</span> <span class=main>`</span> set <span class=skolem>l</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span>
          conjI ballI order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> *<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> progress_mono_gen<span class=main><span class=main>]</span></span> Max_mapping_coboundedI<span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> False *<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted><span class=quoted><span class=quoted>‹<span class=skolem><span class=skolem><span class=skolem>φ</span></span></span> <span class=main><span class=main><span class=main>∈</span></span></span> set <span class=skolem><span class=skolem><span class=skolem>l</span></span></span>›</span></span></span></span><span class=main><span class=main>]</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span> <span class=main>∈</span> set <span class=skolem>l</span>›</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Prev <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"dom <span class=skolem>P</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j</span> <span class=skolem>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Prev<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Prev<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"dom <span class=skolem>P</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=skolem>i</span> <span class=main>(</span>max <span class=skolem>i</span> <span class=skolem>j</span><span class=main>)</span> <span class=skolem>P</span> <span class=main>∧</span> <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Prev <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>(</span>max <span class=skolem>i</span> <span class=skolem>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_Suc_eq max_def pred_mapping_alt <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_mono<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Next <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"dom <span class=skolem>P</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=skolem>j</span> <span class=skolem>P</span>"</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Next<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>P</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>j</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Since <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Since<span class=main>(</span>3<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P1</span></span> <span class=skolem><span class=skolem>j1</span></span> <span class=keyword2><span class=keyword>where</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P1</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j1</span> <span class=skolem>P1</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ1</span> <span class=skolem>j1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Since<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> Since<span class=main>(</span>3<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P2</span></span> <span class=skolem><span class=skolem>j2</span></span> <span class=keyword2><span class=keyword>where</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P2</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=skolem>i</span> <span class=skolem>j2</span> <span class=skolem>P2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>φ2</span> <span class=skolem>j2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Since<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>S</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span><span class=main>)</span> <span class=main>(</span>Formula.Since <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_mono_gen<span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> P1 P2 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> pred_mapping_le <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max_mapping_cobounded1<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Until.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=skolem>i'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ex_le_τ<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>&lt;</span> τ <span class=free>σ</span> <span class=skolem>i'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> Until.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P1</span></span> <span class=skolem><span class=skolem>j1</span></span> <span class=keyword2><span class=keyword>where</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P1</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=main>(</span>Suc <span class=skolem>i'</span><span class=main>)</span> <span class=skolem>j1</span> <span class=skolem>P1</span>"</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i'</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ1</span> <span class=skolem>j1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Until<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Until.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P2</span></span> <span class=skolem><span class=skolem>j2</span></span> <span class=keyword2><span class=keyword>where</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"dom <span class=skolem>P2</span> <span class=main>=</span> <span class=skolem>S</span>"</span></span> <span class=quoted><span class=quoted>"range_mapping <span class=main>(</span>Suc <span class=skolem>i'</span><span class=main>)</span> <span class=skolem>j2</span> <span class=skolem>P2</span>"</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i'</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>φ2</span> <span class=skolem>j2</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> Until<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P12</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=var>?P12</span> <span class=main>(</span>Formula.Until <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> progress.simps
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> cInf_greatest<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> nonempty greatest<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> nonempty
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> trans_le_add1<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>greatest <span class=skolem>x</span><span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> P1<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span> <span class=main>&lt;</span> <span class=skolem>j1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_eq_Suc_le <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> progress_le_gen <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans pred_mapping_mono_strong<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span> <span class=main>&lt;</span> max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P1</span> <span class=skolem>φ1</span> <span class=skolem>j1</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=var>?P12</span> <span class=skolem>φ1</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1<span class=main>(</span>1<span class=main>)</span> P2<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> progress_mono_gen max_mapping_cobounded1<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P2</span> <span class=skolem>φ2</span> <span class=skolem>j2</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=var>?P12</span> <span class=skolem>φ2</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1<span class=main>(</span>1<span class=main>)</span> P2<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> progress_mono_gen max_mapping_cobounded2<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span> <span class=main>≤</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=var>?P12</span> <span class=skolem>φ1</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=var>?P12</span> <span class=skolem>φ2</span> <span class=main>(</span>max <span class=skolem>j1</span> <span class=skolem>j2</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1<span class=main>(</span>3<span class=main>)</span> P2<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> greatest <span class=quoted><span class=quoted>‹<span class=skolem>i'</span> <span class=main>&lt;</span> max <span class=skolem>j1</span> <span class=skolem>j2</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i'</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>x</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>&lt;</span> τ <span class=free>σ</span> <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> less_τD<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>with</span></span> P1 P2 <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> <span class=skolem>i'</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max_mapping <span class=skolem>P1</span> <span class=skolem>P2</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"max <span class=skolem>j1</span> <span class=skolem>j2</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> range_mapping_relax<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"regex.atms <span class=skolem>r</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> MatchP.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> progress.simps
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=skolem>i</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt regex.pred_set<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pick</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pick</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> <span class=keyword1>SOME</span> <span class=bound>Pj</span><span class=main>.</span> dom <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=skolem>i</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>∧</span>
       <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=bound>φ</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?pickP</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=keyword1>o</span> <span class=skolem>pick</span>"</span></span> <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?pickj</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"snd <span class=keyword1>o</span> <span class=skolem>pick</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> MatchP <span class=keyword1><span class=command>have</span></span> pick<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> regex.atms <span class=skolem>r</span> <span class=main>⟹</span> dom <span class=main>(</span><span class=var>?pickP</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span>
      range_mapping <span class=skolem>i</span> <span class=main>(</span><span class=var>?pickj</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>(</span><span class=var>?pickP</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=var>?pickP</span> <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span><span class=var>?pickj</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ</span>
      <span class=keyword1><span class=command>unfolding</span></span> pick_def o_def future_bounded.simps regex.pred_set
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> someI_ex<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>Pj</span><span class=main>.</span> dom <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=skolem>i</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>∧</span>
         <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> progress.simps
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Max_mapping <span class=main>(</span><span class=var>?pickP</span> <span class=main>`</span> regex.atms <span class=skolem>r</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Max <span class=main>(</span><span class=var>?pickj</span> <span class=main>`</span> regex.atms <span class=skolem>r</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Max_mapping_coboundedI
          order_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> pick<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>THEN</span> conjunct2<span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main><span class=main>]</span></span></span> progress_mono_gen<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchF.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i'</span></span> <span class=keyword2><span class=keyword>where</span></span> i'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=skolem>i'</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ex_le_τ<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>&lt;</span> τ <span class=free>σ</span> <span class=skolem>i'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> ix<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i'</span> <span class=main>≤</span> <span class=skolem>b</span> <span class=main>+</span> τ <span class=free>σ</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>+</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>&lt;</span> τ <span class=free>σ</span> <span class=skolem>i'</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> less_τD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> that less_le_trans <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"regex.atms <span class=skolem>r</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> MatchF.prems i' ix <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> progress.simps
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>e</span> <span class=main>∈</span> <span class=skolem>S</span> <span class=keyword1>then</span> Some <span class=main>(</span>Suc <span class=skolem>i'</span><span class=main>)</span> <span class=keyword1>else</span> None"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i'</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt regex.pred_set add.commute less_Suc_eq
          <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_greatest <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>i'</span></span><span class=main><span class=main>]</span></span> less_imp_le<span class=main><span class=main>[</span></span><span class=operator>THEN</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>i'</span></span> <span class=quoted><span class=free>σ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ</span></span> <span class=keyword2><span class=keyword>where</span></span> φ<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> regex.atms <span class=skolem>r</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pick</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pick</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> <span class=keyword1>SOME</span> <span class=bound>Pj</span><span class=main>.</span> dom <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=main>(</span>Suc <span class=skolem>i'</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>∧</span>
      Suc <span class=skolem>i'</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=bound>φ</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pickP</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pickP</span> <span class=main>=</span> fst <span class=keyword1>o</span> <span class=skolem>pick</span>"</span></span> <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pickj</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pickj</span> <span class=main>=</span> snd <span class=keyword1>o</span> <span class=skolem>pick</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> MatchF <span class=keyword1><span class=command>have</span></span> pick<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> regex.atms <span class=skolem>r</span> <span class=main>⟹</span> dom <span class=main>(</span><span class=skolem>pickP</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span>
    range_mapping <span class=main>(</span>Suc <span class=skolem>i'</span><span class=main>)</span> <span class=main>(</span><span class=skolem>pickj</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>(</span><span class=skolem>pickP</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>∧</span> Suc <span class=skolem>i'</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span><span class=skolem>pickP</span> <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span><span class=skolem>pickj</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ</span>
      <span class=keyword1><span class=command>unfolding</span></span> pick_def o_def future_bounded.simps regex.pred_set pickj_def pickP_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> someI_ex<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>Pj</span><span class=main>.</span> dom <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>S</span> <span class=main>∧</span> range_mapping <span class=main>(</span>Suc <span class=skolem>i'</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=main>∧</span>
       Suc <span class=skolem>i'</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=main>(</span>fst <span class=bound>Pj</span><span class=main>)</span> <span class=skolem>φ</span> <span class=main>(</span>snd <span class=bound>Pj</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Max_mapping <span class=main>(</span><span class=skolem>pickP</span> <span class=main>`</span> regex.atms <span class=skolem>r</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?j</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Max <span class=main>(</span><span class=skolem>pickj</span> <span class=main>`</span> regex.atms <span class=skolem>r</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> pick<span class=main>[</span><span class=operator>OF</span> φ<span class=main>]</span> False φ <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i'</span> <span class=main>≤</span> <span class=var>?j</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> order_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> pick<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>THEN</span> conjunct2<span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> φ<span class=main><span class=main>]</span></span> order_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> progress_le_gen<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Max_ge_iff <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> range_mapping_relax<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ _ order_refl<span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> i' 1 ix
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> MatchF.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Regex.pred_regex Formula.future_bounded <span class=skolem>r</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> τ_mono<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=var><span class=quoted><span class=var>?j</span></span></span> <span class=quoted><span class=free>σ</span></span><span class=main>]</span> less_τD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> pick False
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=var>?j</span>"</span></span><span class=main><span class=main>]</span></span>  exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_greatest
          order_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> le_SucI<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> order_refl<span class=main><span class=main><span class=main>]</span></span></span> order_trans<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> pick<span class=main><span class=main><span class=main><span class=main>[</span></span></span></span><span class=operator>THEN</span> conjunct2<span class=main><span class=main><span class=main><span class=main>,</span></span></span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main><span class=main><span class=main>]</span></span></span></span> progress_mono_gen<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span>
          range_mapping_Max_mapping<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ ballI<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> range_mapping_relax<span class=main><span class=main><span class=main><span class=main>[</span></span></span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i'</span>"</span></span> <span class=main><span class=main><span class=main><span class=main>_</span></span></span></span> <span class=main><span class=main><span class=main><span class=main>_</span></span></span></span> <span class=quoted><span class=skolem>i</span></span><span class=main><span class=main><span class=main><span class=main>,</span></span></span></span> <span class=operator>OF</span> _ _ order_refl<span class=main><span class=main><span class=main><span class=main>]</span></span></span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=dynamic><span class=dynamic>ac_simps</span></span> Suc_le_eq trans_le_add2 Max_mapping_coboundedI progress_regex_def
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span>"</span></span><span class=main><span class=main>]</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=var><span class=quoted><span class=var>?j</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_ge<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=free>φ</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=free>i</span> <span class=main>≤</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=bound>j</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> progress_ge_gen<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>{}</span>"</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>σ</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> cInf_restrict_nat<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Inf <span class=free>A</span> <span class=main>=</span> Inf <span class=main>{</span><span class=bound><span class=bound>y</span></span> <span class=main>∈</span> <span class=free>A</span><span class=main>.</span> <span class=bound>y</span> <span class=main>≤</span> <span class=free>x</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> antisym <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> cInf_greatest cInf_lower Inf_nat_def1<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_time_conv<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span><span class=free>j</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> τ <span class=free>σ'</span> <span class=bound>i</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span> <span class=main>=</span> progress <span class=free>σ'</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> <span class=free>j</span> <span class=main>-</span> <span class=main>1</span> <span class=main>⟷</span> <span class=skolem>i</span> <span class=main>&lt;</span> <span class=free>j</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> Until <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>enat <span class=skolem>b</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>j</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>n</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> enat * Until <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> τ_mono<span class=main>[</span><span class=operator>THEN</span> trans_le_add1<span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 8 0
            <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> box_equals<span class=main><span class=main>[</span></span><span class=operator>OF</span> arg_cong<span class=main><span class=main><span class=main>[</span></span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted>Inf</span><span class=main><span class=main><span class=main>]</span></span></span>
              cInf_restrict_nat<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>symmetric</span><span class=main><span class=main><span class=main>,</span></span></span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=skolem>n</span></span><span class=main><span class=main><span class=main>]</span></span></span> cInf_restrict_nat<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>symmetric</span><span class=main><span class=main><span class=main>,</span></span></span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=skolem>n</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> <span class=free>j</span> <span class=main>-</span> <span class=main>1</span> <span class=main>⟷</span> <span class=skolem>i</span> <span class=main>&lt;</span> <span class=free>j</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> MatchF <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> τ_mono<span class=main>[</span><span class=operator>THEN</span> trans_le_add1<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>j</span></span><span class=main>)</span>
      <span class=main>(</span><span class=main>(</span><span class=operator>auto</span> 6 0 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_le_gen progress_regex_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> box_equals<span class=main><span class=main>[</span></span><span class=operator>OF</span> arg_cong<span class=main><span class=main><span class=main>[</span></span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted>Inf</span><span class=main><span class=main><span class=main>]</span></span></span>
            cInf_restrict_nat<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>symmetric</span><span class=main><span class=main><span class=main>,</span></span></span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>-</span><span class=main>1</span>"</span></span><span class=main><span class=main><span class=main>]</span></span></span> cInf_restrict_nat<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>symmetric</span><span class=main><span class=main><span class=main>,</span></span></span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>-</span><span class=main>1</span>"</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main><span class=keyword3>[</span></span><span class=main><span class=keyword3>]</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_regex_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Inf_UNIV_nat<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf UNIV <span class=main>::</span> nat<span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> cInf_eq_minimum<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_prefix_conv<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>=</span> progress <span class=free>σ'</span> <span class=free>P</span> <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> progress_time_conv τ_prefix_conv<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> bounded_rtranclp_mono<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>n</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'x</span> <span class=main>::</span> linorder"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> <span class=free>R</span> <span class=bound>i</span> <span class=bound>j</span> <span class=main>⟹</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> <span class=free>S</span> <span class=bound>i</span> <span class=bound>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> <span class=free>R</span> <span class=bound>i</span> <span class=bound>j</span> <span class=main>⟹</span> <span class=bound>i</span> <span class=main>≤</span> <span class=bound>j</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"rtranclp <span class=free>R</span> <span class=free>i</span> <span class=free>j</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> rtranclp <span class=free>S</span> <span class=free>i</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtranclp_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>step <span class=skolem>y</span> <span class=skolem>z</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>y</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>z</span></span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> rtrancl_into_rtrancl<span class=main><span class=main>[</span></span><span class=operator>to_pred</span><span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_prefix_conv_gen<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>⟹</span> dom <span class=free>V</span> <span class=main>=</span> dom <span class=free>V'</span> <span class=main>⟹</span> dom <span class=free>P</span> <span class=main>=</span> dom <span class=free>V</span> <span class=main>⟹</span>
    pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> plen <span class=free>π</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>⋀</span><span class=bound>p</span> <span class=bound>i</span> <span class=bound>φ</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> dom <span class=free>V</span> <span class=main>⟹</span> <span class=bound>i</span> <span class=main>&lt;</span> the <span class=main>(</span><span class=free>P</span> <span class=bound>p</span><span class=main>)</span> <span class=main>⟹</span> the <span class=main>(</span><span class=free>V</span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span> <span class=main>=</span> the <span class=main>(</span><span class=free>V'</span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
    Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span> Formula.sat <span class=free>σ'</span> <span class=free>V'</span> <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>V</span></span> <span class=quoted><span class=free>V'</span></span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>i</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Pred.prems<span class=main>(</span>1<span class=main>,</span>4<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2 progress_le_gen<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>V</span> <span class=skolem>e</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> None
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>V'</span> <span class=skolem>e</span> <span class=main>=</span> None"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹dom <span class=skolem>V</span> <span class=main>=</span> dom <span class=skolem>V'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> None Γ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>›</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>a</span><span class=main>)</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>V'</span> <span class=skolem>e</span> <span class=main>=</span> Some <span class=skolem>a'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Some <span class=quoted><span class=quoted>‹dom <span class=skolem>V</span> <span class=main>=</span> dom <span class=skolem>V'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> the <span class=main>(</span><span class=skolem>P</span> <span class=skolem>e</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Pred.prems<span class=main>(</span>1-3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"the <span class=main>(</span><span class=skolem>V</span> <span class=skolem>e</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>=</span> the <span class=main>(</span><span class=skolem>V'</span> <span class=skolem>e</span><span class=main>)</span> <span class=skolem>i</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Some <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> Pred.prems<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> domI<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Some <span class=quoted><span class=quoted>‹<span class=skolem>V'</span> <span class=skolem>e</span> <span class=main>=</span> Some <span class=skolem>a'</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?V</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>V</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>(</span><span class=bound>V</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> Formula.nfv <span class=skolem>φ</span> <span class=main>∧</span> Formula.sat <span class=bound>σ</span> <span class=bound>V</span> <span class=bound>v</span> <span class=bound>i</span> <span class=skolem>φ</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat.simps <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> Let.IH<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=main>(</span><span class=skolem>P</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ψ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span><span class=main>)</span> <span class=main>=</span> dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V'</span> <span class=free>σ'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dom <span class=main>(</span><span class=skolem>P</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> Let.prems <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> plen <span class=free>π</span><span class=main>)</span> <span class=main>(</span><span class=skolem>P</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> pred_mapping_map_upd <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> progress_le_gen<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p'</span> <span class=skolem>i</span> <span class=skolem>φ'</span>
    <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>∈</span> dom <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> the <span class=main>(</span><span class=main>(</span><span class=skolem>P</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>p'</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"the <span class=main>(</span><span class=var>?V</span> <span class=skolem>V</span> <span class=free>σ</span> <span class=skolem>p'</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>=</span> the <span class=main>(</span><span class=var>?V</span> <span class=skolem>V'</span> <span class=free>σ'</span> <span class=skolem>p'</span><span class=main>)</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>=</span> <span class=skolem>p</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>with</span></span> Let 2 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> 1 2 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Let.prems<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Eq <span class=skolem>t1</span> <span class=skolem>t2</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Neg <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Or <span class=skolem>φ1</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Ands.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=skolem>i</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=bound>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>with</span></span> Ands <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat_Ands <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Prev <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>i</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Next <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>of</span> <span class=main><span class=main><span class=main>_</span></span></span> <span class=quoted><span class=skolem>P</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=skolem>φ</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Next.prems τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> sat.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> conj_cong Next<span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Since <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Since.prems τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> sat.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> conj_cong ex_cong ball_cong Since<span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Until.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> right<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Inf_UNIV_nat<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Until.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>j</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ1</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ2</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le not_le <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Suc_leI <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span>"</span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_cInf_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ1</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ2</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> less_τD<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>[</span><span class=operator>OF</span> that<span class=main>]</span> Until<span class=main>(</span>6<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> less_eq_Suc_le order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main>]</span></span><span class=main>)</span>

  <span class=keyword1><span class=command>from</span></span> Until.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> progress <span class=free>σ'</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Until <span class=skolem>φ1</span> <span class=skolem>I</span> <span class=skolem>φ2</span><span class=main>)</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> progress_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>j</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> progress <span class=free>σ'</span> <span class=skolem>P</span> <span class=skolem>φ1</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> progress <span class=free>σ'</span> <span class=skolem>P</span> <span class=skolem>φ2</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le not_le <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Suc_leI <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span>"</span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_cInf_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 11<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ1</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> 21<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ2</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
    <span class=keyword1><span class=command>unfolding</span></span> progress_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> less_τD<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ'</span></span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> 31<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
    <span class=keyword1><span class=command>using</span></span> 11<span class=main>[</span><span class=operator>OF</span> that<span class=main>]</span> Until<span class=main>(</span>6<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> less_eq_Suc_le order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat.simps
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>intro</span> ex_cong iffI<span class=main><span class=keyword3>;</span></span> <span class=operator>elim</span> conjE<span class=main>)</span><span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> LR RL<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>LR <span class=skolem>j</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Until<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 1<span class=main>]</span> Until<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 2<span class=main>]</span> τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> 3<span class=main>]</span> Until.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv add.commute <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> less_imp_le order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>RL <span class=skolem>j</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Until<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 11<span class=main>]</span> Until<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 21<span class=main>]</span> τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> 31<span class=main>]</span> Until.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> le_diff_conv add.commute <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> less_imp_le order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> MatchP.prems τ_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> sat.simps
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> ex_cong conj_cong match_cong_strong MatchP<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_regex_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchF.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> right<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Inf_UNIV_nat<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"regex.atms <span class=skolem>r</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>from</span></span> MatchF.prems<span class=main>(</span>1<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> plen <span class=free>π</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le not_le <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_cInf_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> τ_mono discrete not_le order.strict_trans2 that<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> MatchF.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> progress <span class=free>σ'</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> progress_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>≤</span> plen <span class=free>π</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le not_le <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_cInf_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> τ_mono discrete not_le order.strict_trans2 that<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> MatchF.prems<span class=main>(</span>1<span class=main>,</span>4<span class=main>)</span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> sat.simps conj_commute<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>≤</span> <span class=main>_</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>≤</span> <span class=main>_</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> ex_cong conj_cong match_cong_strong<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> left right sat<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>left <span class=skolem>j</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main>)</span>
          <span class=main>(</span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 1<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>,</span></span>
            <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 2<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>right <span class=skolem>j</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main>)</span>
          <span class=main>(</span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>,</span></span>
            <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 2<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>from</span></span> MatchF.prems<span class=main>(</span>1<span class=main>)</span> False <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>regex.atms <span class=skolem>r</span><span class=main>.</span> <span class=skolem>j</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> 0 6 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le not_le progress_regex_def
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_cInf_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> regex.atms <span class=skolem>r</span> <span class=main>⟹</span> <span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span> <span class=skolem>φ</span>
      <span class=keyword1><span class=command>using</span></span> that
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> less_τD<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=quoted><span class=quoted>"regex.atms <span class=skolem>r</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
      <span class=keyword1><span class=command>using</span></span> that
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MatchF<span class=main><span class=main><span class=main>(</span></span></span>5<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>of</span> <span class=quoted><span class=free>σ</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=quoted><span class=skolem>k</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

    <span class=keyword1><span class=command>from</span></span> MatchF.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> progress <span class=free>σ'</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> progress_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>regex.atms <span class=skolem>r</span><span class=main>.</span> <span class=skolem>j</span> <span class=main>≤</span> progress <span class=free>σ'</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> 0 6 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_eq_Suc_le not_le progress_regex_def
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_cInf_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 11<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> regex.atms <span class=skolem>r</span> <span class=main>⟹</span> <span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span> <span class=skolem>φ</span>
      <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>using</span></span> progress_prefix_conv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> less_τD<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ'</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> 21<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> plen <span class=free>π</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ'</span> <span class=skolem>k</span> <span class=main>≤</span> τ <span class=free>σ'</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
      <span class=keyword1><span class=command>using</span></span> 11<span class=main>[</span><span class=operator>OF</span> that<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ progress_le_gen<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MatchF<span class=main><span class=main><span class=main>(</span></span></span>5<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>of</span> <span class=quoted><span class=free>σ</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=quoted><span class=skolem>k</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sat.simps conj_commute<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>≤</span> <span class=main>_</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>≤</span> <span class=main>_</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>intro</span> ex_cong conj_cong match_cong_strong MatchF<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MatchF<span class=main><span class=main>(</span></span>3-6<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>assumption</span><span class=main><span class=keyword3>?</span></span><span class=main>)</span><span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> right left progress<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>right <span class=skolem>j</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main>)</span>
          <span class=main>(</span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>,</span></span>
            <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 21<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>left <span class=skolem>j</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> right enat_ord_code le_diff_conv add.commute<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>b</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main>)</span>
          <span class=main>(</span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 21<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>,</span></span>
            <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 21<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>progress <span class=skolem>j</span> <span class=skolem>k</span> <span class=skolem>z</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> right enat_ord_code le_diff_conv add.commute<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>b</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>elim</span> 1<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> τ_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> 21<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> τ_mono<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_prefix_conv<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>⟹</span>
    Formula.sat <span class=free>σ</span> Map.empty <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span> Formula.sat <span class=free>σ'</span> Map.empty <span class=free>v</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>erule</span> sat_prefix_conv_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> progress_remove_neg<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=free>P</span> <span class=main>(</span>remove_neg <span class=free>φ</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>φ</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> safe_progress_get_and<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span>
  Min <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>`</span> set <span class=main>(</span>get_and_list <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> get_and_list.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> progress_convert_multiway<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=main>(</span>convert_multiway <span class=free>φ</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_safe <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?c</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=main>(</span>Formula.And <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cφ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>φ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> c_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?c</span> <span class=main>=</span> Formula.Ands <span class=main>(</span>get_and_list <span class=var>?cφ</span> <span class=main>@</span> get_and_list <span class=var>?cψ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_safe <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=var>?cφ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=var>?cψ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> c_eq
    <span class=keyword1><span class=command>using</span></span> And_safe.IH
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> get_and_nonempty Min.union safe_progress_get_and<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_Not <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?c</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=main>(</span>Formula.And <span class=skolem>φ</span> <span class=main>(</span>Formula.Neg <span class=skolem>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cφ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>φ</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?cψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"convert_multiway <span class=skolem>ψ</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> c_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?c</span> <span class=main>=</span> Formula.Ands <span class=main>(</span>Formula.Neg <span class=var>?cψ</span> <span class=main>#</span> get_and_list <span class=var>?cφ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> And_Not <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>φ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=var>?cφ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹safe_formula <span class=skolem>ψ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"safe_formula <span class=var>?cψ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> safe_convert_multiway<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> c_eq
    <span class=keyword1><span class=command>using</span></span> And_Not.IH
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> get_and_nonempty Min.union safe_progress_get_and<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchP <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> progress.simps regex.map convert_multiway.simps regex.set_map image_image
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> if_cong arg_cong<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted>Min</span><span class=main><span class=main>]</span></span> image_cong<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MatchF <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> progress.simps regex.map convert_multiway.simps regex.set_map image_image
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> if_cong arg_cong<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted>Min</span><span class=main><span class=main>]</span></span> arg_cong<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted>Inf</span><span class=main><span class=main>]</span></span> arg_cong<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>(≤)</span> <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span>
      image_cong Collect_cong all_cong1 imp_cong conj_cong image_cong<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Specification›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>pprogress</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.formula <span class=main>⇒</span> Formula.prefix <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>pprogress</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>THE</span> <span class=bound>n</span><span class=main>.</span> <span class=main>∀</span><span class=bound>σ</span><span class=main>.</span> prefix_of <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=bound>σ</span> <span class=main>⟶</span> progress <span class=bound>σ</span> Map.empty <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>(</span>plen <span class=free><span class=bound><span class=entity>π</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=bound>n</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> pprogress_eq<span class=main>:</span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ</span> <span class=main>⟹</span> pprogress <span class=free>φ</span> <span class=free>π</span> <span class=main>=</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> pprogress_def <span class=keyword1><span class=command>using</span></span> progress_prefix_conv
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>locale</span></span> future_bounded_mfodl <span class=main>=</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>φ</span> <span class=main>::</span> <span class=quoted>Formula.formula</span>
  <span class=keyword2><span class=keyword>assumes</span></span> future_bounded<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.future_bounded <span class=free>φ</span>"</span></span>

<span class=keyword1><span class=command>sublocale</span></span> future_bounded_mfodl <span class=main>⊆</span> sliceable_timed_progress <span class=quoted><span class=quoted>"Formula.nfv <span class=free>φ</span>"</span></span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ</span>"</span></span> <span class=quoted><span class=quoted>"relevant_events <span class=free>φ</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>σ</span> <span class=bound>v</span> <span class=bound>i</span><span class=main>.</span> Formula.sat <span class=bound>σ</span> Map.empty <span class=bound>v</span> <span class=bound>i</span> <span class=free>φ</span>"</span></span> <span class=quoted><span class=quoted>"pprogress <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_less_nfv<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>2 <span class=skolem>v</span> <span class=skolem>v'</span> <span class=skolem>σ</span> <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> sat_fv_cong<span class=main><span class=main>[</span></span><span class=operator>rule_format</span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>v</span> <span class=skolem>S</span> <span class=skolem>σ</span> <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> sat_slice_iff<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>4 <span class=skolem>π</span> <span class=skolem>π'</span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=skolem>π'</span> <span class=skolem>σ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ex_prefix_of <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=skolem>π</span> <span class=skolem>σ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> prefix_of_antimono<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span> <span class=main>≤</span> <span class=skolem>π'</span>›</span></span> <span class=quoted><span class=quoted>‹prefix_of <span class=skolem>π'</span> <span class=skolem>σ</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pprogress_eq plen_mono progress_mono<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>5 <span class=skolem>σ</span> <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≤</span> progress <span class=skolem>σ</span> Map.empty <span class=free>φ</span> <span class=skolem>j</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> future_bounded progress_ge <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≤</span> pprogress <span class=free>φ</span> <span class=main>(</span>take_prefix <span class=skolem>j</span> <span class=skolem>σ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pprogress_eq<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>σ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>6 <span class=skolem>π</span> <span class=skolem>σ</span> <span class=skolem>σ'</span> <span class=skolem>i</span> <span class=skolem>v</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> progress <span class=skolem>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=skolem>π</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pprogress_eq<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> 6 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> sat_prefix_conv <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>7 <span class=skolem>π</span> <span class=skolem>π'</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"plen <span class=skolem>π</span> <span class=main>=</span> plen <span class=skolem>π'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>σ'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=skolem>π</span> <span class=skolem>σ</span>"</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=skolem>π'</span> <span class=skolem>σ'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ex_prefix_of <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> plen <span class=skolem>π</span><span class=main>.</span> τ <span class=skolem>σ</span> <span class=bound>i</span> <span class=main>=</span> τ <span class=skolem>σ'</span> <span class=bound>i</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 7 calculation
    <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pprogress_eq progress_time_conv<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>locale</span></span> verimon_spec <span class=main>=</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>φ</span> <span class=main>::</span> <span class=quoted>Formula.formula</span>
  <span class=keyword2><span class=keyword>assumes</span></span> monitorable<span class=main>:</span> <span class=quoted><span class=quoted>"mmonitorable <span class=free>φ</span>"</span></span>

<span class=keyword1><span class=command>sublocale</span></span> verimon_spec <span class=main>⊆</span> future_bounded_mfodl
  <span class=keyword1><span class=command>using</span></span> monitorable <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> mmonitorable_def<span class=main>)</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Correctness›</span></span>

<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Invariants›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_mbuf2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> event_data table <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> event_data table <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span>
    event_data mbuf2 <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_mbuf2</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>ja</span></span></span> <span class=free><span class=bound><span class=entity>jb</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>Q</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>ja</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>jb</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>⇒</span>
    list_all2 <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>[</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>ja</span></span></span><span class=main>]</span> <span class=bound>xs</span> <span class=main>∧</span> list_all2 <span class=free><span class=bound><span class=entity>Q</span></span></span> <span class=main>[</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>jb</span></span></span><span class=main>]</span> <span class=bound>ys</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>inductive</span></span> <span class=entity>list_all3</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'c</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> list <span class=main>⇒</span> <span class=tfree>'b</span> list <span class=main>⇒</span> <span class=tfree>'c</span> list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=entity>P</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'c</span> <span class=main>⇒</span> bool<span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>list_all3</span> <span class=free>P</span> <span class=main>[]</span> <span class=main>[]</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free><span class=bound><span class=entity>a1</span></span></span> <span class=free><span class=bound><span class=entity>a2</span></span></span> <span class=free><span class=bound><span class=entity>a3</span></span></span> <span class=main>⟹</span> <span class=free>list_all3</span> <span class=free>P</span> <span class=free><span class=bound><span class=entity>q1</span></span></span> <span class=free><span class=bound><span class=entity>q2</span></span></span> <span class=free><span class=bound><span class=entity>q3</span></span></span> <span class=main>⟹</span> <span class=free>list_all3</span> <span class=free>P</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a1</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>q1</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a2</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>q2</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a3</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>q3</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_list_all2D<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟹</span>
  <span class=main>(</span>length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>∧</span> list_all2 <span class=main>(</span>case_prod <span class=free>P</span><span class=main>)</span> <span class=main>(</span>zip <span class=free>xs</span> <span class=free>ys</span><span class=main>)</span> <span class=free>zs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_all3.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_list_all3I<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>⟹</span> list_all2 <span class=main>(</span>case_prod <span class=free>P</span><span class=main>)</span> <span class=main>(</span>zip <span class=free>xs</span> <span class=free>ys</span><span class=main>)</span> <span class=free>zs</span> <span class=main>⟹</span>
  list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_induct2<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_Cons1 <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all3.intros<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_list_all2_eq<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟷</span>
  <span class=main>(</span>length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>∧</span> list_all2 <span class=main>(</span>case_prod <span class=free>P</span><span class=main>)</span> <span class=main>(</span>zip <span class=free>xs</span> <span class=free>ys</span><span class=main>)</span> <span class=free>zs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> list_all2_list_all3I list_all3_list_all2D <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_mapD<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=main>(</span>map <span class=free>f</span> <span class=free>xs</span><span class=main>)</span> <span class=main>(</span>map <span class=free>g</span> <span class=free>ys</span><span class=main>)</span> <span class=main>(</span>map <span class=free>h</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟹</span>
  list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>(</span><span class=free>g</span> <span class=bound>y</span><span class=main>)</span> <span class=main>(</span><span class=free>h</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=quoted>"map <span class=free>f</span> <span class=free>xs</span>"</span></span> <span class=quoted><span class=quoted>"map <span class=free>g</span> <span class=free>ys</span>"</span></span> <span class=quoted><span class=quoted>"map <span class=free>h</span> <span class=free>zs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_all3.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all3.intros<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_mapI<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>(</span><span class=free>g</span> <span class=bound>y</span><span class=main>)</span> <span class=main>(</span><span class=free>h</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟹</span>
  list_all3 <span class=free>P</span> <span class=main>(</span>map <span class=free>f</span> <span class=free>xs</span><span class=main>)</span> <span class=main>(</span>map <span class=free>g</span> <span class=free>ys</span><span class=main>)</span> <span class=main>(</span>map <span class=free>h</span> <span class=free>zs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_all3.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all3.intros<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_map_iff<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=main>(</span>map <span class=free>f</span> <span class=free>xs</span><span class=main>)</span> <span class=main>(</span>map <span class=free>g</span> <span class=free>ys</span><span class=main>)</span> <span class=main>(</span>map <span class=free>h</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟷</span>
  list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>(</span><span class=free>g</span> <span class=bound>y</span><span class=main>)</span> <span class=main>(</span><span class=free>h</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> list_all3_mapD list_all3_mapI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>lemmas</span></span> list_all3_map <span class=main>=</span>
  list_all3_map_iff<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> g<span class=main><span class=main>=</span></span><span class=quoted>id</span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> h<span class=main><span class=main>=</span></span><span class=quoted>id</span><span class=main>,</span> <span class=operator>unfolded</span> list.map_id id_apply<span class=main>]</span>
  list_all3_map_iff<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main>=</span></span><span class=quoted>id</span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> h<span class=main><span class=main>=</span></span><span class=quoted>id</span><span class=main>,</span> <span class=operator>unfolded</span> list.map_id id_apply<span class=main>]</span>
  list_all3_map_iff<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main>=</span></span><span class=quoted>id</span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> g<span class=main><span class=main>=</span></span><span class=quoted>id</span><span class=main>,</span> <span class=operator>unfolded</span> list.map_id id_apply<span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_conv_all_nth<span class=main>:</span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>=</span>
  <span class=main>(</span>length <span class=free>xs</span> <span class=main>=</span> length <span class=free>ys</span> <span class=main>∧</span> length <span class=free>ys</span> <span class=main>=</span> length <span class=free>zs</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> length <span class=free>xs</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span><span class=free>xs</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=free>ys</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=free>zs</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_list_all2_eq list_all2_conv_all_nth<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_refl <span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main><span class=main>?</span></span></span></span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>x</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>xs</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_mbufn</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> nat list <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> event_data table <span class=main>⇒</span> bool<span class=main>)</span> list <span class=main>⇒</span> event_data mbufn <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_mbufn</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>js</span></span></span> <span class=free><span class=bound><span class=entity>Ps</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟷</span> list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>P</span> <span class=bound>j</span> <span class=bound>xs</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> list_all2 <span class=bound>P</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>]</span> <span class=bound>xs</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>Ps</span></span></span> <span class=free><span class=bound><span class=entity>js</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_mbuf2'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span>
  Formula.formula <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> event_data mbuf2 <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_mbuf2'</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟷</span> wf_mbuf2 <span class=main>(</span>min <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>buf</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_mbufn'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span>
  Formula.formula Regex.regex <span class=main>⇒</span> event_data mbufn <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_mbufn'</span> <span class=free><span class=bound><span class=entity>σ</span></span></span>  <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟷</span> <span class=main>(</span><span class=keyword1>case</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>⇒</span>
    wf_mbufn <span class=main>(</span>progress_regex <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=bound>φ</span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=bound>φs</span><span class=main>)</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>i</span><span class=main>.</span> qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=bound>φ</span><span class=main>)</span><span class=main>)</span> <span class=bound>φs</span><span class=main>)</span>
    <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbuf2'_UNIV_alt<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=free>j</span> <span class=free>n</span> UNIV <span class=free>φ</span> <span class=free>ψ</span> <span class=free>buf</span> <span class=main>⟷</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>buf</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>⇒</span>
  list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> wf_table <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>
    <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>..&lt;</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=bound>xs</span> <span class=main>∧</span>
  list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> wf_table <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span>
    <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>..&lt;</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=bound>ys</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> mem_restr_UNIV<span class=main><span class=main>[</span></span><span class=operator>THEN</span> eqTrueI<span class=main><span class=main>,</span></span> <span class=operator>abs_def</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_ts</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> ts list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_ts</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>⟷</span> list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>min <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>(</span>progress <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>]</span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_ts_regex</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> Formula.formula Regex.regex <span class=main>⇒</span> ts list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_ts_regex</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>⟷</span> list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>progress_regex <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>]</span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>Sincep</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>≡</span> Formula.Since <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>else</span> Formula.Neg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> msaux<span class=main>)</span> <span class=entity>wf_since_aux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data list set <span class=main>⇒</span> args <span class=main>⇒</span>
  Formula.formula <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> <span class=tfree>'msaux</span> <span class=main>⇒</span> nat <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_since_aux</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>⟷</span> Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>cur</span> <span class=bound>auxlist</span><span class=main>.</span> <span class=free>valid_msaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=bound>cur</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=bound>auxlist</span> <span class=main>∧</span>
    <span class=bound>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=bound>auxlist</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=bound>auxlist</span> <span class=main>⟶</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>∧</span>
      qtable <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>(</span>Sincep <span class=main>(</span>args_pos <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span><span class=main>)</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>⟶</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=bound>auxlist</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_matchP_aux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span>
    ℐ <span class=main>⇒</span> Formula.formula Regex.regex <span class=main>⇒</span> event_data mrδaux <span class=main>⇒</span> nat <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_matchP_aux</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>⟷</span> sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>⟶</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=keyword1>case</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>⇒</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>ms</span> <span class=main>∈</span> RPDs <span class=bound>mr</span><span class=main>.</span> qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv_regex <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span>
         <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=bound>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
         <span class=main>(</span>lookup <span class=bound>X</span> <span class=bound>ms</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>⟶</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> qtable_mem_restr_UNIV<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span><span class=main>(</span>mem_restr UNIV<span class=main>)</span> <span class=free>Q</span> <span class=free>X</span> <span class=main>=</span> wf_table <span class=free>n</span> <span class=free>A</span> <span class=free>Q</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> qtable_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> msaux<span class=main>)</span> wf_since_aux_UNIV_alt<span class=main>:</span>
  <span class=quoted><span class=quoted>"wf_since_aux <span class=free>σ</span> <span class=free>V</span> UNIV <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>aux</span> <span class=free>ne</span> <span class=main>⟷</span> Formula.fv <span class=free>φ</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>cur</span> <span class=bound>auxlist</span><span class=main>.</span> <span class=free>valid_msaux</span> <span class=free>args</span> <span class=bound>cur</span> <span class=free>aux</span> <span class=bound>auxlist</span> <span class=main>∧</span>
    <span class=bound>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>ne</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=bound>auxlist</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=bound>auxlist</span> <span class=main>⟶</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>∧</span>
      wf_table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span>
          <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Sincep <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>.</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>⟶</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=bound>auxlist</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_since_aux_def qtable_mem_restr_UNIV <span class=keyword1><span class=command>..</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_until_auxlist</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span> bool <span class=main>⇒</span>
    Formula.formula <span class=main>⇒</span> ℐ <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> event_data muaux <span class=main>⇒</span> nat <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_until_auxlist</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>auxlist</span></span></span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>⟷</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>i</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>r1</span><span class=main>,</span> <span class=bound>r2</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span> <span class=main>∧</span>
      qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=main>(</span><span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=bound>i</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>+</span>length <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>}</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>
          <span class=keyword1>else</span> <span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=bound>i</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>+</span>length <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>}</span><span class=main>.</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span> <span class=bound>r1</span> <span class=main>∧</span>
      qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>+</span> length <span class=free><span class=bound><span class=entity>auxlist</span></span></span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span>
          Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>j</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span>
          <span class=main>(</span><span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=bound>i</span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>}</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=bound>r2</span><span class=main>)</span>
      <span class=free><span class=bound><span class=entity>auxlist</span></span></span> <span class=main>[</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>+</span>length <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>]</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> muaux<span class=main>)</span> <span class=entity>wf_until_aux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data list set <span class=main>⇒</span> args <span class=main>⇒</span>
  Formula.formula <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> <span class=tfree>'muaux</span> <span class=main>⇒</span> nat <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_until_aux</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>⟷</span> Formula.fv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>cur</span> <span class=bound>auxlist</span><span class=main>.</span> <span class=free>valid_muaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=bound>cur</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=bound>auxlist</span> <span class=main>∧</span>
      <span class=bound>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>+</span> length <span class=bound>auxlist</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>+</span> length <span class=bound>auxlist</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
      wf_until_auxlist <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>args_pos <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=bound>auxlist</span> <span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> muaux<span class=main>)</span> wf_until_aux_UNIV_alt<span class=main>:</span>
  <span class=quoted><span class=quoted>"wf_until_aux <span class=free>σ</span> <span class=free>V</span> UNIV <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>aux</span> <span class=free>ne</span> <span class=main>⟷</span> Formula.fv <span class=free>φ</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>cur</span> <span class=bound>auxlist</span><span class=main>.</span> <span class=free>valid_muaux</span> <span class=free>args</span> <span class=bound>cur</span> <span class=free>aux</span> <span class=bound>auxlist</span> <span class=main>∧</span>
      <span class=bound>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>ne</span> <span class=main>+</span> length <span class=bound>auxlist</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=bound>auxlist</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>i</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>r1</span><span class=main>,</span> <span class=bound>r2</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>∧</span>
      wf_table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=keyword1>if</span> <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span>
          <span class=keyword1>then</span> <span class=main>(</span><span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=bound>i</span><span class=main>..&lt;</span><span class=free>ne</span><span class=main>+</span>length <span class=bound>auxlist</span><span class=main>}</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span><span class=main>)</span>
          <span class=keyword1>else</span> <span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=bound>i</span><span class=main>..&lt;</span><span class=free>ne</span><span class=main>+</span>length <span class=bound>auxlist</span><span class=main>}</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=bound>r1</span> <span class=main>∧</span>
      wf_table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free>ne</span> <span class=main>+</span> length <span class=bound>auxlist</span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>∧</span>
          Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>j</span> <span class=free>ψ</span> <span class=main>∧</span>
          <span class=main>(</span><span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=bound>i</span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>}</span><span class=main>.</span> <span class=keyword1>if</span> <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span> <span class=keyword1>then</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span> <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=bound>r2</span><span class=main>)</span>
      <span class=bound>auxlist</span> <span class=main>[</span><span class=free>ne</span><span class=main>..&lt;</span><span class=free>ne</span><span class=main>+</span>length <span class=bound>auxlist</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def wf_until_auxlist_def qtable_mem_restr_UNIV <span class=keyword1><span class=command>..</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_matchF_aux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span>
    ℐ <span class=main>⇒</span> Formula.formula Regex.regex <span class=main>⇒</span> event_data mlδaux <span class=main>⇒</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_matchF_aux</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>⟷</span> <span class=main>(</span><span class=keyword1>case</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>⇒</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>i</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rels</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span> <span class=main>∧</span>
        list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span>
          Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=bound>φ</span><span class=main>)</span><span class=main>)</span> <span class=bound>φs</span> <span class=bound>rels</span> <span class=main>∧</span>
        qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv_regex <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>ne</span></span></span> <span class=main>+</span> length <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>∧</span>
          Regex.match <span class=main>(</span>Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>i</span> <span class=bound>j</span><span class=main>)</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span>
    <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>[</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>ne</span></span></span><span class=main>+</span>length <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>]</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>wf_matchF_invar</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_matchF_invar</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>=</span>
     <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>aux</span><span class=main>,</span> <span class=bound>Y</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>aux</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>∧</span> wf_matchF_aux <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=bound>aux</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>0</span> <span class=main>∧</span>
     <span class=main>(</span><span class=keyword1>case</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr</span><span class=main>,</span> <span class=bound>φs</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>∀</span><span class=bound>ms</span> <span class=main>∈</span> LPDs <span class=bound>mr</span><span class=main>.</span>
       qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv_regex <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span>
         Regex.match <span class=main>(</span>Formula.sat <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=bound>φs</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>+</span> length <span class=bound>aux</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=bound>Y</span> <span class=bound>ms</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>lift_envs'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span> event_data list set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lift_envs'</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>xs</span><span class=main>,</span><span class=bound>ys</span><span class=main>)</span><span class=main>.</span> <span class=bound>xs</span> <span class=main>@</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>`</span> <span class=main>(</span><span class=main>{</span><span class=bound>xs</span><span class=main>.</span> length <span class=bound>xs</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span> <span class=main>×</span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>formula_of_constraint</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trm <span class=main>×</span> bool <span class=main>×</span> mconstraint <span class=main>×</span> Formula.trm <span class=main>⇒</span> Formula.formula"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>formula_of_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> True<span class=main>,</span> MEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>formula_of_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> True<span class=main>,</span> MLess<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> Formula.Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>formula_of_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> True<span class=main>,</span> MLessEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> Formula.LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>formula_of_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> False<span class=main>,</span> MEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> Formula.Neg <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>formula_of_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> False<span class=main>,</span> MLess<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> Formula.Neg <span class=main>(</span>Formula.Less <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>formula_of_constraint</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span> False<span class=main>,</span> MLessEq<span class=main>,</span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>=</span> Formula.Neg <span class=main>(</span>Formula.LessEq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>inductive</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>wf_mformula</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.trace <span class=main>⇒</span> nat <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span>
  nat <span class=main>⇒</span> event_data list set <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mformula <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> bool"</span></span>
  <span class=keyword2><span class=keyword>for</span></span> <span class=entity>σ</span> <span class=entity>j</span> <span class=keyword2><span class=keyword>where</span></span>
    Eq<span class=main>:</span> <span class=quoted><span class=quoted>"is_simple_eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>⟹</span>
    <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv_trm <span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv_trm <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MRel <span class=main>(</span>eq_rel <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>Formula.Eq <span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> neq_Var<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MRel empty_table<span class=main>)</span> <span class=main>(</span>Formula.Neg <span class=main>(</span>Formula.Eq <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Pred<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv <span class=main>(</span>Formula.Pred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span>
    <span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> Formula.is_Var <span class=bound>t</span> <span class=main>∨</span> Formula.is_Const <span class=bound>t</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MPred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Pred <span class=free><span class=bound><span class=entity>e</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Let<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> UNIV <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span><span class=main>)</span><span class=main>)</span>
      <span class=main>(</span><span class=free><span class=bound><span class=entity>V</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>↦</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=bound>v</span> <span class=bound>i</span> <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>}</span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>=</span> Formula.nfv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MLet <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Let <span class=free><span class=bound><span class=entity>p</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> And<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>χ</span></span></span> <span class=main>=</span> Formula.And <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span>
      <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>χ</span></span></span> <span class=main>=</span> Formula.And <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>(</span>Formula.Neg <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span> <span class=main>∧</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    wf_mbuf2' <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MAnd <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>(</span>fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>χ</span></span></span>"</span></span>
  <span class=main>|</span> AndAssign<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∉</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> Formula.fv_trm <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>conf</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>=</span> Formula.Eq <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>∨</span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>=</span> Formula.Eq <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>(</span>Formula.Var <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MAndAssign <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.And <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> AndRel<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>=</span> formula_of_constraint <span class=free><span class=bound><span class=entity>conf</span></span></span> <span class=main>⟹</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>t1</span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=bound>t2</span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>conf</span></span></span> <span class=keyword1>in</span> Formula.fv_trm <span class=bound>t1</span> <span class=main>∪</span> Formula.fv_trm <span class=bound>t2</span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MAndRel <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>conf</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.And <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Ands<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>φ'</span><span class=main>.</span> <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=bound>φ</span> <span class=bound>φ'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>l_pos</span></span></span> <span class=main>@</span> map remove_neg <span class=free><span class=bound><span class=entity>l_neg</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    wf_mbufn <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Ands <span class=free><span class=bound><span class=entity>l'</span></span></span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=bound>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>l_pos</span></span></span> <span class=main>@</span> map remove_neg <span class=free><span class=bound><span class=entity>l_neg</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span> <span class=bound>i</span><span class=main>.</span>
      qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=bound>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>l_pos</span></span></span> <span class=main>@</span> map remove_neg <span class=free><span class=bound><span class=entity>l_neg</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    <span class=main>(</span><span class=free><span class=bound><span class=entity>l_pos</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l_neg</span></span></span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=free><span class=bound><span class=entity>l'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>l_pos</span></span></span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span>
    list_all safe_formula <span class=main>(</span>map remove_neg <span class=free><span class=bound><span class=entity>l_neg</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=main>=</span> map fv <span class=free><span class=bound><span class=entity>l_pos</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=main>=</span> map fv <span class=free><span class=bound><span class=entity>l_neg</span></span></span> <span class=main>⟹</span>
    <span class=main>⋃</span><span class=main>(</span>set <span class=free><span class=bound><span class=entity>A_neg</span></span></span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span><span class=main>(</span>set <span class=free><span class=bound><span class=entity>A_pos</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MAnds <span class=free><span class=bound><span class=entity>A_pos</span></span></span> <span class=free><span class=bound><span class=entity>A_neg</span></span></span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Ands <span class=free><span class=bound><span class=entity>l'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Or<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>=</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    wf_mbuf2' <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MOr <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Or <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Neg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MNeg <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Neg <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Exists<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>(</span>lift_envs <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MExists <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Exists <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Agg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>(</span>lift_envs' <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>∉</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    Formula.fv_trm <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=main>=</span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⊆</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>}</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MAgg <span class=free><span class=bound><span class=entity>g0</span></span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Agg <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=free><span class=bound><span class=entity>ω</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Prev<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=main>⟷</span> <span class=free>j</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟹</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>(</span>Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span><span class=main>]</span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MPrev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Prev <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Next<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=main>⟷</span> progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟹</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MNext <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>first</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Next <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Since<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    <span class=keyword1>if</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=main>=</span> Formula.Neg <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    safe_formula <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=main>=</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>⟹</span>
    args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>⟹</span>
    args_n <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span>
    args_L <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    args_R <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    wf_mbuf2' <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    wf_ts <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>⟹</span>
    wf_since_aux <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Since <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MSince <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Since <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> Until<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span> <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    <span class=keyword1>if</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=main>=</span> Formula.Neg <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    safe_formula <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=main>=</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>⟹</span>
    args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=main>⟹</span>
    args_n <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>⟹</span>
    args_L <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⟹</span>
    args_R <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    Formula.fv <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=main>⊆</span> Formula.fv <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=main>⟹</span>
    wf_mbuf2' <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    wf_ts <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>⟹</span>
    wf_until_aux <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Until <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
    progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.Until <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>φ'</span></span></span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span> <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MUntil <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>ψ</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.Until <span class=free><span class=bound><span class=entity>φ''</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ψ'</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> MatchP<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr'</span><span class=main>,</span> <span class=bound>φs'</span><span class=main>)</span> <span class=main>⇒</span>
      list_all2 <span class=main>(</span><span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=bound>φs'</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=main>=</span> <span class=bound>mr'</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>RPDs <span class=free><span class=bound><span class=entity>mr</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    safe_regex Past Strict <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>⟹</span>
    wf_mbufn' <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    wf_ts_regex <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>⟹</span>
    wf_matchP_aux <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MMatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.MatchP <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>
  <span class=main>|</span> MatchF<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> to_mregex <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>mr'</span><span class=main>,</span> <span class=bound>φs'</span><span class=main>)</span> <span class=main>⇒</span>
      list_all2 <span class=main>(</span><span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=bound>φs'</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=main>=</span> <span class=bound>mr'</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>LPDs <span class=free><span class=bound><span class=entity>mr</span></span></span><span class=main>)</span> <span class=main>⟹</span>
    safe_regex Futu Strict <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>⟹</span>
    wf_mbufn' <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=main>⟹</span>
    wf_ts_regex <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=main>⟹</span>
    wf_matchF_aux <span class=free>σ</span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>0</span> <span class=main>⟹</span>
    progress <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>(</span>Formula.MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span> progress_regex <span class=free>σ</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=free>j</span> <span class=main>⟹</span>
    <span class=free>wf_mformula</span> <span class=free>σ</span> <span class=free>j</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>MMatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free><span class=bound><span class=entity>mrs</span></span></span> <span class=free><span class=bound><span class=entity>φs</span></span></span> <span class=free><span class=bound><span class=entity>buf</span></span></span> <span class=free><span class=bound><span class=entity>nts</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span> <span class=main>(</span>Formula.MatchF <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> <span class=entity>wf_mstate</span> <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.formula <span class=main>⇒</span> Formula.prefix <span class=main>⇒</span> event_data list set <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wf_mstate</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>⟷</span> mstate_n <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span> Formula.nfv <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>σ</span><span class=main>.</span> prefix_of <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=bound>σ</span> <span class=main>⟶</span>
    mstate_i <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span> progress <span class=bound>σ</span> Map.empty <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=main>(</span>plen <span class=free><span class=bound><span class=entity>π</span></span></span><span class=main>)</span> <span class=main>∧</span>
    wf_mformula <span class=bound>σ</span> <span class=main>(</span>plen <span class=free><span class=bound><span class=entity>π</span></span></span><span class=main>)</span> Map.empty Map.empty <span class=main>(</span>mstate_n <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span>mstate_m <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Initialisation›</span></span>


<span class=keyword1><span class=command>lemma</span></span> wf_mbuf2'_0<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span> wf_mbuf2' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=main>0</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbufn'_0<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span> pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span> wf_mbufn' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=main>0</span> <span class=free>n</span> <span class=free>R</span> <span class=free>r</span> <span class=main>(</span>replicate <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn'_def wf_mbufn_def map_replicate_const<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_map <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all3_refl <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Min_eq_iff progress_regex_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_ts_0<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts <span class=free>σ</span> <span class=free>P</span> <span class=main>0</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> wf_ts_regex_0<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts_regex <span class=free>σ</span> <span class=free>P</span> <span class=main>0</span> <span class=free>r</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> msaux<span class=main>)</span> wf_since_aux_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ'</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ'</span> <span class=main>⟹</span>
  wf_since_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ'</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>ψ'</span><span class=main>)</span> <span class=free>b</span><span class=main>)</span> <span class=free>φ'</span> <span class=free>ψ'</span> <span class=main>(</span><span class=free>init_msaux</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ'</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>ψ'</span><span class=main>)</span> <span class=free>b</span><span class=main>)</span><span class=main>)</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_since_aux_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> valid_init_msaux<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> muaux<span class=main>)</span> wf_until_aux_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ'</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ'</span> <span class=main>⟹</span>
  wf_until_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ'</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>ψ'</span><span class=main>)</span> <span class=free>b</span><span class=main>)</span> <span class=free>φ'</span> <span class=free>ψ'</span> <span class=main>(</span><span class=free>init_muaux</span> <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ'</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>ψ'</span><span class=main>)</span> <span class=free>b</span><span class=main>)</span><span class=main>)</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def wf_until_auxlist_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> valid_init_muaux<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_matchP_aux_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchP_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>[]</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_matchP_aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> wf_matchF_aux_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>[]</span> <span class=main>0</span> <span class=free>k</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_matchF_aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> fv_regex_alt<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> Formula.fv_regex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>φ</span> <span class=main>∈</span> atms <span class=free>r</span><span class=main>.</span> Formula.fv <span class=bound>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fv_regex_alt atms_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> to_mregex_atms <span class=main>=</span>
  to_mregex_ok<span class=main>[</span><span class=operator>THEN</span> conjunct1<span class=main>,</span> <span class=operator>THEN</span> equalityD1<span class=main>,</span> <span class=operator>THEN</span> set_mp<span class=main>,</span> <span class=operator>rotated</span><span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> wf_minit0<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv <span class=free>φ</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span>
  pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span>
  wf_mformula <span class=free>σ</span> <span class=main>0</span> <span class=free>P</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=main>(</span>minit0 <span class=free>n</span> <span class=free>φ</span><span class=main>)</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>V</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_formula_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Eq_Const <span class=skolem>c</span> <span class=skolem>d</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_simple_eq_def <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> eq_rel.simps <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Eq<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Eq_Var1 <span class=skolem>c</span> <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_simple_eq_def <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> eq_rel.simps <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Eq<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Eq_Var2 <span class=skolem>c</span> <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_simple_eq_def <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> eq_rel.simps <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Eq<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>neq_Var <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.neq_Var<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Pred<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Let <span class=skolem>p</span> <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> fvi_less_nfv <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> pred_mapping_alt dom_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Let Let<span class=main><span class=main>(</span></span>4<span class=main><span class=main>,</span></span>5<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_assign <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=skolem>ψ</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> 1 <span class=quoted><span class=quoted>‹safe_assignment <span class=main>(</span>fv <span class=skolem>φ</span><span class=main>)</span> <span class=skolem>ψ</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∉</span> fv <span class=skolem>φ</span>"</span></span> <span class=quoted><span class=quoted>"fv_trm <span class=skolem>t</span> <span class=main>⊆</span> fv <span class=skolem>φ</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>ψ</span> <span class=main>=</span> Formula.Eq <span class=main>(</span>Formula.Var <span class=skolem>x</span><span class=main>)</span> <span class=skolem>t</span> <span class=main>∨</span> <span class=skolem>ψ</span> <span class=main>=</span> Formula.Eq <span class=skolem>t</span> <span class=main>(</span>Formula.Var <span class=skolem>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> safe_assignment_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> formula.splits trm.splits<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> And_assign <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.AndAssign <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> trm.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_safe <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.And wf_mbuf2'_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_constraint <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹fv <span class=skolem>ψ</span> <span class=main>⊆</span> fv <span class=skolem>φ</span>›</span></span> <span class=quoted><span class=quoted>‹is_constraint <span class=skolem>ψ</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t1</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=skolem><span class=skolem>c</span></span> <span class=skolem><span class=skolem>t2</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t1</span><span class=main>,</span> <span class=skolem>p</span><span class=main>,</span> <span class=skolem>c</span><span class=main>,</span> <span class=skolem>t2</span><span class=main>)</span> <span class=main>=</span> split_constraint <span class=skolem>ψ</span>"</span></span>
    <span class=quoted><span class=quoted>"formula_of_constraint <span class=main>(</span>split_constraint <span class=skolem>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>ψ</span>"</span></span>
    <span class=quoted><span class=quoted>"fv_trm <span class=skolem>t1</span> <span class=main>∪</span> fv_trm <span class=skolem>t2</span> <span class=main>⊆</span> fv <span class=skolem>φ</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> is_constraint.induct<span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> And_constraint <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.AndRel<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>And_Not <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.And wf_mbuf2'_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>l</span> <span class=skolem>pos</span> <span class=skolem>neg</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> posneg <span class=main>=</span> <span class=quoted>"Ands.hyps"</span><span class=main>(</span>1<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?wf_minit</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wf_mformula <span class=free>σ</span> <span class=main>0</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>minit0 <span class=skolem>n</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?pos</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"filter safe_formula <span class=skolem>l</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?neg</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"filter <span class=main>(</span>Not <span class=main>∘</span> safe_formula<span class=main>)</span> <span class=skolem>l</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=var>?wf_minit</span> <span class=var>?pos</span> <span class=skolem>pos</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Ands.IH<span class=main>(</span>1<span class=main>)</span> Ands.prems posneg <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_refl_strong<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=var>?wf_minit</span> <span class=main>(</span>map remove_neg <span class=var>?neg</span><span class=main>)</span> <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Ands.IH<span class=main>(</span>2<span class=main>)</span> Ands.prems posneg <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map list_all_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_refl_strong<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=main><span class=bound>_</span></span> <span class=main><span class=bound>_</span></span><span class=main>.</span> True<span class=main>)</span> <span class=main>(</span><span class=var>?pos</span> <span class=main>@</span> map remove_neg <span class=var>?neg</span><span class=main>)</span> <span class=main>(</span><span class=var>?pos</span> <span class=main>@</span> map remove_neg <span class=var>?neg</span><span class=main>)</span> <span class=skolem>l</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth comp_def sum_length_filter_compl<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span> <span class=main>(</span><span class=keyword1>MIN</span> <span class=bound>φ</span><span class=main>∈</span>set <span class=skolem>l</span><span class=main>.</span> <span class=main>(</span><span class=main>0</span> <span class=main>::</span> nat<span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Min_eq_iff<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Ands.hyps Ands.prems<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_mbufn_def list_all3_map list.rel_map map_replicate_const<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> subset_eq
        map_map<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> map_append<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map map_append
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Ands list_all2_appendI<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Neg <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Neg<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Or <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Or wf_mbuf2'_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Exists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_Suc_bound <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Exists<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Agg Agg.IH fvi_plus_bound<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Prev <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>thm</span></span> wf_mformula.Prev<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=skolem>P</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Prev<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Next <span class=skolem>I</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Next<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Since <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> wf_since_aux_Nil
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> init_args_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Since wf_mbuf2'_0 wf_ts_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Not_Since <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> wf_since_aux_Nil
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> init_args_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Since wf_mbuf2'_0 wf_ts_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Until <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> valid_length_muaux<span class=main>[</span><span class=operator>OF</span> valid_init_muaux<span class=main><span class=main>[</span></span><span class=operator>OF</span> Until<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> wf_until_aux_Nil
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> init_args_def <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> progress_simps <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Until wf_mbuf2'_0 wf_ts_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Not_Until <span class=skolem>φ</span> <span class=skolem>I</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> valid_length_muaux<span class=main>[</span><span class=operator>OF</span> valid_init_muaux<span class=main><span class=main>[</span></span><span class=operator>OF</span> Not_Until<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> wf_until_aux_Nil
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> init_args_def <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> progress_simps <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Until wf_mbuf2'_0 wf_ts_0<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map fv_regex_alt <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> progress_simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.MatchP list.rel_refl_strong wf_mbufn'_0 wf_ts_regex_0 wf_matchP_aux_Nil
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> to_mregex_atms<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map fv_regex_alt progress_le Min_eq_iff progress_regex_def
        <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> progress_simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.MatchF list.rel_refl_strong wf_mbufn'_0 wf_ts_regex_0 wf_matchF_aux_Nil
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> to_mregex_atms<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> wf_mstate_minit<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=free>φ</span> <span class=main>⟹</span> wf_mstate <span class=free>φ</span> pnil <span class=free>R</span> <span class=main>(</span>minit <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_mstate_def minit_def Let_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_minit0 fvi_less_nfv<span class=main>)</span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Evaluation›</span></span>

<span class=keyword1><span class=command>lemma</span></span> match_wf_tuple<span class=main>:</span> <span class=quoted><span class=quoted>"Some <span class=free>f</span> <span class=main>=</span> match <span class=free>ts</span> <span class=free>xs</span> <span class=main>⟹</span>
  wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> Formula.fv_trm <span class=bound>t</span><span class=main>)</span> <span class=main>(</span>Table.tabulate <span class=free>f</span> <span class=main>0</span> <span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> match.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> match_fvi_trm_None<span class=main>:</span> <span class=quoted><span class=quoted>"Some <span class=free>f</span> <span class=main>=</span> match <span class=free>ts</span> <span class=free>xs</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> <span class=free>x</span> <span class=main>∉</span> Formula.fv_trm <span class=bound>t</span> <span class=main>⟹</span> <span class=free>f</span> <span class=free>x</span> <span class=main>=</span> None"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> match.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> match_fvi_trm_Some<span class=main>:</span> <span class=quoted><span class=quoted>"Some <span class=free>f</span> <span class=main>=</span> match <span class=free>ts</span> <span class=free>xs</span> <span class=main>⟹</span> <span class=free>t</span> <span class=main>∈</span> set <span class=free>ts</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> Formula.fv_trm <span class=free>t</span> <span class=main>⟹</span> <span class=free>f</span> <span class=free>x</span> <span class=main>≠</span> None"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> match.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> match_eval_trm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> <span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>Formula.fv_trm <span class=bound>t</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> Some <span class=free>f</span> <span class=main>=</span> match <span class=free>ts</span> <span class=free>xs</span> <span class=main>⟹</span>
    map <span class=main>(</span>Formula.eval_trm <span class=main>(</span>Table.tabulate <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> the <span class=main>(</span><span class=free>f</span> <span class=bound>i</span><span class=main>)</span><span class=main>)</span> <span class=main>0</span> <span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>xs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> match.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>x</span> <span class=skolem>ts</span> <span class=skolem>y</span> <span class=skolem>ys</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> 3<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> 3<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_fvi_trm_Some sym <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> eval_trm_fv_cong<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_tabulate_Some<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>Table.tabulate <span class=free>f</span> <span class=main>0</span> <span class=free>n</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=free>f</span> <span class=free>x</span> <span class=main>=</span> Some <span class=bound>y</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> ex_match<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> Formula.fv_trm <span class=bound>t</span><span class=main>)</span> <span class=free>v</span> <span class=main>⟹</span>
  <span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv_trm <span class=bound>t</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>n</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>Formula.is_Var <span class=bound>t</span> <span class=main>∨</span> Formula.is_Const <span class=bound>t</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>∃</span><span class=bound>f</span><span class=main>.</span> match <span class=free>ts</span> <span class=main>(</span>map <span class=main>(</span>Formula.eval_trm <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span><span class=main>)</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> Some <span class=bound>f</span> <span class=main>∧</span> <span class=free>v</span> <span class=main>=</span> Table.tabulate <span class=bound>f</span> <span class=main>0</span> <span class=free>n</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=quoted>"map <span class=main>(</span>Formula.eval_trm <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span><span class=main>)</span> <span class=free>ts</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> match.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>x</span> <span class=skolem>ts</span> <span class=skolem>y</span> <span class=skolem>ys</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>t</span><span class=main>∈</span>set <span class=skolem>ts</span><span class=main>.</span> Formula.fv_trm <span class=bound>t</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> 3 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> insert_absorb <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_tuple_tabulate_Some meta_spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>v</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> 3<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword1><span class=command>have</span></span>
      *<span class=main>:</span> <span class=quoted><span class=quoted>"map <span class=main>(</span>Formula.eval_trm <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ts</span> <span class=main>=</span> map <span class=main>(</span>Formula.eval_trm <span class=main>(</span>map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=skolem>x</span> <span class=main>:=</span> None<span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ts</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def nth_list_update <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> eval_trm_fv_cong<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> False 3<span class=main>(</span>2-4<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"match <span class=skolem>ts</span> <span class=main>(</span>map <span class=main>(</span>Formula.eval_trm <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ts</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>[</span><span class=skolem>x</span> <span class=main>:=</span> None<span class=main>]</span> <span class=main>=</span> Table.tabulate <span class=skolem>f</span> <span class=main>0</span> <span class=free>n</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> *
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> 3<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>[</span><span class=skolem>x</span> <span class=main>:=</span> None<span class=main>]</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def nth_list_update <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> eval_trm_fv_cong<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False this <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=skolem>x</span> <span class=main>=</span> None"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>v</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> match_fvi_trm_None<span class=main><span class=main>[</span></span><span class=operator>OF</span> sym<span class=main><span class=main>]</span></span> arg_cong<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted>length</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 3<span class=main>(</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq wf_tuple_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> nth_equalityI<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> eq_rel_eval_trm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> eq_rel <span class=free>n</span> <span class=free>t1</span> <span class=free>t2</span> <span class=main>⟹</span> is_simple_eq <span class=free>t1</span> <span class=free>t2</span> <span class=main>⟹</span>
  <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv_trm <span class=free>t1</span> <span class=main>∪</span> Formula.fv_trm <span class=free>t2</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span>
  Formula.eval_trm <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span> <span class=free>t1</span> <span class=main>=</span> Formula.eval_trm <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span> <span class=free>t2</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>t1</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>t2</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_simple_eq_def singleton_table_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> in_eq_rel<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span>Formula.fv_trm <span class=free>t1</span> <span class=main>∪</span> Formula.fv_trm <span class=free>t2</span><span class=main>)</span> <span class=free>v</span> <span class=main>⟹</span>
  is_simple_eq <span class=free>t1</span> <span class=free>t2</span> <span class=main>⟹</span>
  Formula.eval_trm <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span> <span class=free>t1</span> <span class=main>=</span> Formula.eval_trm <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span> <span class=free>t2</span> <span class=main>⟹</span>
  <span class=free>v</span> <span class=main>∈</span> eq_rel <span class=free>n</span> <span class=free>t1</span> <span class=free>t2</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>t1</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>t2</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> is_simple_eq_def singleton_table_def wf_tuple_def unit_table_def
      <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> nth_equalityI <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> table_eq_rel<span class=main>:</span> <span class=quoted><span class=quoted>"is_simple_eq <span class=free>t1</span> <span class=free>t2</span> <span class=main>⟹</span>
  table <span class=free>n</span> <span class=main>(</span>Formula.fv_trm <span class=free>t1</span> <span class=main>∪</span> Formula.fv_trm <span class=free>t2</span><span class=main>)</span> <span class=main>(</span>eq_rel <span class=free>n</span> <span class=free>t1</span> <span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>t1</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>t2</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> is_simple_eq_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_Suc_fviD<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=main>(</span>Formula.fvi <span class=free>b</span> <span class=free>φ</span><span class=main>)</span> <span class=free>v</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=main>(</span>Formula.fvi <span class=main>(</span>Suc <span class=free>b</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>tl <span class=free>v</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_Suc nth_tl<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> table_fvi_tl<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=main>(</span>Formula.fvi <span class=free>b</span> <span class=free>φ</span><span class=main>)</span> <span class=free>X</span> <span class=main>⟹</span> table <span class=free>n</span> <span class=main>(</span>Formula.fvi <span class=main>(</span>Suc <span class=free>b</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>tl <span class=main>`</span> <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> table_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> wf_tuple_Suc_fviD<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_Suc_fvi_SomeI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∈</span> Formula.fvi <span class=free>b</span> <span class=free>φ</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=main>(</span>Formula.fvi <span class=main>(</span>Suc <span class=free>b</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=free>v</span> <span class=main>⟹</span>
  wf_tuple <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=main>(</span>Formula.fvi <span class=free>b</span> <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>Some <span class=free>x</span> <span class=main>#</span> <span class=free>v</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_Suc less_Suc_eq_0_disj<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_Suc_fvi_NoneI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∉</span> Formula.fvi <span class=free>b</span> <span class=free>φ</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=main>(</span>Formula.fvi <span class=main>(</span>Suc <span class=free>b</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=free>v</span> <span class=main>⟹</span>
  wf_tuple <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=main>(</span>Formula.fvi <span class=free>b</span> <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>None <span class=main>#</span> <span class=free>v</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_Suc less_Suc_eq_0_disj<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_project_fv<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=main>(</span>fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=main>(</span>lift_envs <span class=free>R</span><span class=main>)</span><span class=main>)</span> <span class=free>P</span> <span class=free>X</span> <span class=main>⟹</span>
    qtable <span class=free>n</span> <span class=main>(</span>Formula.fvi <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span><span class=main>(</span><span class=keyword1>if</span> <span class=main>0</span> <span class=main>∈</span> fv <span class=free>φ</span> <span class=keyword1>then</span> Some <span class=bound>x</span> <span class=keyword1>else</span> None<span class=main>)</span> <span class=main>#</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>tl <span class=main>`</span> <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> neq0_conv <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_iff Bex_def fvi_Suc <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_project<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mem_restr_lift_envs'_append<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> <span class=free>b</span> <span class=main>⟹</span> mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span> <span class=main>=</span> mem_restr <span class=free>R</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mem_restr_def lift_envs'_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_append list.rel_map <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"map the <span class=free>xs</span>"</span></span><span class=main><span class=main>]</span></span> list.rel_refl<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> nth_list_update_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span><span class=main>[</span><span class=free>i</span> <span class=main>:=</span> <span class=free>x</span><span class=main>]</span> <span class=main>!</span> <span class=free>j</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>i</span> <span class=main>&lt;</span> length <span class=free>xs</span> <span class=main>∧</span> <span class=free>i</span> <span class=main>=</span> <span class=free>j</span> <span class=keyword1>then</span> <span class=free>x</span> <span class=keyword1>else</span> <span class=free>xs</span> <span class=main>!</span> <span class=free>j</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_upd_None<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=free>xs</span> <span class=main>⟹</span> <span class=free>A</span> <span class=main>-</span> <span class=main>{</span><span class=free>i</span><span class=main>}</span> <span class=main>=</span> <span class=free>B</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=free>B</span> <span class=main>(</span><span class=free>xs</span><span class=main>[</span><span class=free>i</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_list_update_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mem_restr_upd_None<span class=main>:</span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=free>xs</span> <span class=main>⟹</span> mem_restr <span class=free>R</span> <span class=main>(</span><span class=free>xs</span><span class=main>[</span><span class=free>i</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mem_restr_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth nth_list_update_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mem_restr_dropI<span class=main>:</span> <span class=quoted><span class=quoted>"mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=free>xs</span> <span class=main>⟹</span> mem_restr <span class=free>R</span> <span class=main>(</span>drop <span class=free>b</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mem_restr_def lift_envs'_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> append_eq_conv_conj list_all2_append2<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mem_restr_dropD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span> <span class=main>≤</span> length <span class=free>xs</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=main>(</span>drop <span class=free>b</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>a</span> <span class=bound>b</span><span class=main>.</span> <span class=bound>a</span> <span class=main>≠</span> None <span class=main>⟶</span> <span class=bound>a</span> <span class=main>=</span> Some <span class=bound>b</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>R</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=var>?R</span> <span class=main>(</span>drop <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mem_restr_def <span class=keyword1><span class=command>..</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> mem_restr_def <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=var>?R</span> <span class=main>(</span>take <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=free>xs</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_refl<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹list_all2 <span class=var>?R</span> <span class=main>(</span>drop <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=skolem>v</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=var>?R</span> <span class=main>(</span>take <span class=free>b</span> <span class=free>xs</span> <span class=main>@</span> drop <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> list_all2_appendI<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=var>?R</span> <span class=free>xs</span> <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"map the <span class=main>(</span>take <span class=free>b</span> <span class=free>xs</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>v</span> <span class=main>∈</span> lift_envs' <span class=free>b</span> <span class=free>R</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> lift_envs'_def <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>∈</span> <span class=free>R</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_append<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>a</span> <span class=main>{</span><span class=bound><span class=bound>x</span></span> <span class=main>∈</span> <span class=free>A</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>a</span><span class=main>}</span> <span class=free>xs</span> <span class=main>⟹</span>
  wf_tuple <span class=free>b</span> <span class=main>{</span><span class=bound>x</span> <span class=main>-</span> <span class=free>a</span> <span class=main>|</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>≥</span> <span class=free>a</span><span class=main>}</span> <span class=free>ys</span> <span class=main>⟹</span>
  wf_tuple <span class=main>(</span><span class=free>a</span> <span class=main>+</span> <span class=free>b</span><span class=main>)</span> <span class=free>A</span> <span class=main>(</span><span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_append eq_diff_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_map_Some<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>xs</span> <span class=main>=</span> <span class=free>n</span> <span class=main>⟹</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free>n</span><span class=main>}</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>map Some <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> wf_tuple_drop<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>n</span><span class=main>)</span> <span class=free>A</span> <span class=free>xs</span> <span class=main>⟹</span> <span class=main>{</span><span class=bound>x</span> <span class=main>-</span> <span class=free>b</span> <span class=main>|</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>≥</span> <span class=free>b</span><span class=main>}</span> <span class=main>=</span> <span class=free>B</span> <span class=main>⟹</span>
  wf_tuple <span class=free>n</span> <span class=free>B</span> <span class=main>(</span>drop <span class=free>b</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1><span class=command>lemma</span></span> ecard_image<span class=main>:</span> <span class=quoted><span class=quoted>"inj_on <span class=free>f</span> <span class=free>A</span> <span class=main>⟹</span> ecard <span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=free>A</span><span class=main>)</span> <span class=main>=</span> ecard <span class=free>A</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ecard_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> card_image <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> finite_imageD<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> meval_trm_eval_trm<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=free>x</span> <span class=main>⟹</span> fv_trm <span class=free>t</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span>
    meval_trm <span class=free>t</span> <span class=free>x</span> <span class=main>=</span> Formula.eval_trm <span class=main>(</span>map the <span class=free>x</span><span class=main>)</span> <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> list_update_id<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>!</span> <span class=free>i</span> <span class=main>=</span> <span class=free>z</span> <span class=main>⟹</span> <span class=free>xs</span><span class=main>[</span><span class=free>i</span><span class=main>:=</span><span class=free>z</span><span class=main>]</span> <span class=main>=</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.split<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_wf_tupleD<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>X</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>X</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=bound>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> qtable_def table_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_eval_agg<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> inner<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>n</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> n<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>Formula.fv <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> fresh<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>+</span> <span class=free>b</span> <span class=main>∉</span> Formula.fv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> b_fv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>}</span> <span class=main>⊆</span> Formula.fv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> f_fv<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv_trm <span class=free>f</span> <span class=main>⊆</span> Formula.fv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> g0<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>g0</span> <span class=main>=</span> <span class=main>(</span>Formula.fv <span class=free>φ</span> <span class=main>⊆</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>eval_agg <span class=free>n</span> <span class=free>g0</span> <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>rel</span><span class=main>)</span>"</span></span>
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"qtable <span class=main>_</span> <span class=var>?fv</span> <span class=main>_</span> <span class=var>?Q</span> <span class=var>?rel'</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>M</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>M</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>{</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span> ecard <span class=bound>Zs</span><span class=main>)</span> <span class=main>|</span> <span class=bound>x</span> <span class=bound>Zs</span><span class=main>.</span>
      <span class=bound>Zs</span> <span class=main>=</span> <span class=main>{</span><span class=bound>zs</span><span class=main>.</span> length <span class=bound>zs</span> <span class=main>=</span> <span class=free>b</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>∧</span> Formula.eval_trm <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=bound>v</span><span class=main>)</span> <span class=free>f</span> <span class=main>=</span> <span class=bound>x</span><span class=main>}</span> <span class=main>∧</span>
      <span class=bound>Zs</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> f_fvi<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fvi_trm <span class=free>b</span> <span class=free>f</span> <span class=main>⊆</span> Formula.fvi <span class=free>b</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> f_fv <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_trm_iff_fv_trm<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span> fvi_iff_fv<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>g0</span> <span class=main>∧</span> <span class=free>rel</span> <span class=main>=</span> empty_table"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fvi <span class=free>b</span> <span class=free>φ</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> g0 fvi_iff_fv<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fvi_trm <span class=free>b</span> <span class=free>f</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> f_fvi <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtableI<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=var>?fv</span> <span class=var>?rel'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> eval_agg_def True<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>"</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?zs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"map2 <span class=main>(</span><span class=main>λ</span><span class=bound>z</span> <span class=bound>i</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>i</span> <span class=main>∈</span> Formula.fv <span class=free>φ</span> <span class=keyword1>then</span> Some <span class=bound>z</span> <span class=keyword1>else</span> None<span class=main>)</span> <span class=skolem>zs</span> <span class=main>[</span><span class=main>0</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>b</span> <span class=main>{</span><span class=bound><span class=bound>x</span></span> <span class=main>∈</span> fv <span class=free>φ</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>b</span><span class=main>}</span> <span class=var>?zs</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>n</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span><span class=var>?zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>›</span></span> True
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> g0 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_tuple_append wf_tuple_upd_None<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=main>(</span><span class=var>?zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_append <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableI<span class=main><span class=main>[</span></span><span class=operator>OF</span> inner<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span>
              <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mem_restr_upd_None<span class=main>)</span>
        <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=main>(</span><span class=var>?zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> g0 nth_append <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> sat_fv_cong<span class=main>)</span>
        <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> M_empty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>M</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> M_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> eval_agg <span class=free>n</span> <span class=free>g0</span> <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>rel</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> M_empty True that n
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> M_def eval_agg_def g0 singleton_table_def<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> singleton_table <span class=free>n</span> <span class=free>y</span> <span class=main>(</span>the <span class=main>(</span><span class=skolem>v</span> <span class=main>!</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>v</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> wf_tuple_def singleton_table_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tabulate_alt map_nth
            <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> map_cong<span class=main><span class=main><span class=main>[</span></span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> g<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=quoted>"<span class=main>(!)</span> <span class=skolem>v</span>"</span></span><span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>simplified</span> nth_map<span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>OF</span> refl<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> eval_agg <span class=free>n</span> <span class=free>g0</span> <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>rel</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> M_empty True that n
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> M_def eval_agg_def g0<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> non_default_case<span class=main>:</span> False
    <span class=keyword1><span class=command>have</span></span> union_fv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>+</span> <span class=free>b</span><span class=main>)</span> <span class=main>`</span> Formula.fvi <span class=free>b</span> <span class=free>φ</span> <span class=main>=</span> fv <span class=free>φ</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> b_fv
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_iff_fv<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> image_eqI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>x</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>-</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>for</span></span></span></span> <span class=skolem>x</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> b_n<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=free>φ</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>b</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>"</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>b</span> <span class=main>+</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≥</span> <span class=free>b</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>-</span> <span class=free>b</span> <span class=main>∈</span> <span class=var>?fv</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fvi_iff_fv<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> n f_fvi <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Un_absorb2<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>

    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>M'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>M'</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> <span class=keyword1>let</span> <span class=bound>group</span> <span class=main>=</span> Set.filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> drop <span class=free>b</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>k</span><span class=main>)</span> <span class=free>rel</span><span class=main>;</span>
        <span class=bound>images</span> <span class=main>=</span> meval_trm <span class=free>f</span> <span class=main>`</span> <span class=bound>group</span>
      <span class=keyword1>in</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=main>(</span><span class=bound>y</span><span class=main>,</span> ecard <span class=main>(</span>Set.filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> meval_trm <span class=free>f</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=bound>group</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=bound>images</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> M'_M<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>M'</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>from</span></span> that <span class=keyword1><span class=command>have</span></span> wf_x<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>n</span><span class=main>)</span> <span class=main>(</span>fv <span class=free>φ</span><span class=main>)</span> <span class=skolem>x</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableE<span class=main><span class=main>[</span></span><span class=operator>OF</span> inner<span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> wf_zs_x<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=main>(</span><span class=free>b</span> <span class=main>+</span> <span class=free>n</span><span class=main>)</span> <span class=main>(</span>fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>map Some <span class=skolem>zs</span> <span class=main>@</span> drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
        <span class=keyword1><span class=command>using</span></span> that b_fv
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_tuple_append wf_tuple_map_Some wf_tuple_drop<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>∧</span>
          Formula.eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>f</span> <span class=main>=</span> <span class=skolem>y</span><span class=main>)</span> <span class=main>⟷</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>rel</span> <span class=main>∧</span> take <span class=free>b</span> <span class=bound>a</span> <span class=main>=</span> map Some <span class=skolem>zs</span> <span class=main>∧</span> drop <span class=free>b</span> <span class=bound>a</span> <span class=main>=</span> drop <span class=free>b</span> <span class=skolem>x</span> <span class=main>∧</span> meval_trm <span class=free>f</span> <span class=bound>a</span> <span class=main>=</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
        <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=var>?B</span> <span class=bound>a</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>zs</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI conjI<span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span> <span class=main>(</span>map Some <span class=skolem>zs</span> <span class=main>@</span> drop <span class=main>(</span>length <span class=skolem>zs</span><span class=main>)</span> <span class=skolem>x</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> in_qtableI<span class=main>[</span><span class=operator>OF</span> inner wf_zs_x<span class=main>]</span> <span class=quoted><span class=quoted>‹mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=skolem>x</span>›</span></span>
            meval_trm_eval_trm<span class=main>[</span><span class=operator>OF</span> wf_zs_x f_fv b_n<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mem_restr_dropI<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=var>?B</span> <span class=bound>a</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=var>?B</span> <span class=bound>a</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span> <span class=skolem>a</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> a_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> map Some <span class=skolem>zs</span> <span class=main>@</span> drop <span class=free>b</span> <span class=skolem>x</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> append_take_drop_id<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>b</span></span> <span class=quoted><span class=skolem>a</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>a</span> <span class=main>=</span> <span class=free>b</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> inner <span class=keyword1><span class=command>unfolding</span></span> qtable_def table_def
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_tuple_length<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> wf_tuple_length<span class=main>[</span><span class=operator>OF</span> wf_x<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> a_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=skolem>a</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹mem_restr <span class=main>_</span> <span class=skolem>x</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> a_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mem_restr_dropI<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> in_qtableE<span class=main>[</span><span class=operator>OF</span> inner <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> a_eq sat_fv_cong<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?B</span> <span class=skolem>a</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Formula.eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>f</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> meval_trm_eval_trm<span class=main>[</span><span class=operator>OF</span> wf_zs_x f_fv b_n<span class=main>,</span> <span class=operator>OF</span> <span class=quoted><span class=quoted>‹length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>›</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>unfolding</span></span> a_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"map Some <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> take <span class=free>b</span> <span class=skolem>a</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span>
        <span class=keyword1><span class=command>using</span></span> that b_fv inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span>
        <span class=keyword1><span class=command>unfolding</span></span> table_def wf_tuple_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"ecard <span class=main>{</span><span class=bound>zs</span><span class=main>.</span> <span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>rel</span> <span class=main>∧</span> take <span class=free>b</span> <span class=bound>a</span> <span class=main>=</span> map Some <span class=bound>zs</span> <span class=main>∧</span> drop <span class=free>b</span> <span class=bound>a</span> <span class=main>=</span> drop <span class=free>b</span> <span class=skolem>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>a</span><span class=main>}</span> <span class=main>=</span>
        ecard <span class=main>{</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>rel</span> <span class=main>∧</span> drop <span class=free>b</span> <span class=bound>a</span> <span class=main>=</span> drop <span class=free>b</span> <span class=skolem>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>a</span><span class=main>}</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"ecard <span class=var>?A</span> <span class=main>=</span> ecard <span class=var>?B</span>"</span></span><span class=main>)</span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>P</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ecard <span class=var>?A</span> <span class=main>=</span> ecard <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>zs</span><span class=main>.</span> map Some <span class=bound>zs</span> <span class=main>@</span> drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span> <span class=main>`</span> <span class=var>?A</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> ecard_image<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> inj_onI<span class=main>)</span>
        <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>zs</span><span class=main>.</span> map Some <span class=bound>zs</span> <span class=main>@</span> drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span> <span class=main>`</span> <span class=var>?A</span> <span class=main>=</span> <span class=var>?B</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> eq_commute<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_iff<span class=main><span class=keyword3>,</span></span> <span class=operator>metis</span> <span class=quoted>"2"</span> append_take_drop_id<span class=main>)</span>
        <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> M_def M'_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> non_default_case Let_def image_def Set.filter_def 1 3<span class=main><span class=keyword3>,</span></span> <span class=operator>metis</span> <span class=quoted>"2"</span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>have</span></span> drop_lift<span class=main>:</span> <span class=quoted><span class=quoted>"mem_restr <span class=main>(</span>lift_envs' <span class=free>b</span> <span class=free>R</span><span class=main>)</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=main>(</span><span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span><span class=skolem>z</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>=</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>drop <span class=free>b</span> <span class=skolem>x</span> <span class=main>!</span> <span class=free>y</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"drop <span class=free>b</span> <span class=skolem>x</span> <span class=main>!</span> <span class=free>y</span> <span class=main>=</span> None"</span></span>
          <span class=keyword1><span class=command>using</span></span> fresh n inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> add.commute wf_tuple_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>=</span> drop <span class=free>b</span> <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>x</span> <span class=main>=</span> <span class=free>b</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> that<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=main>(</span><span class=main>(</span>drop <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span><span class=skolem>z</span><span class=main>,</span> <span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mem_restr_upd_None<span class=main>)</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mem_restr_dropD<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>

    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M'</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>`</span> drop <span class=free>b</span> <span class=main>`</span> <span class=free>rel</span> <span class=main>⟷</span>
          <span class=skolem>v</span> <span class=main>∈</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=bound>k</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>`</span> drop <span class=free>b</span> <span class=main>`</span> <span class=free>rel</span>"</span></span>
        <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span> <span class=main>⟷</span> <span class=skolem>v</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>proof</span></span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v'</span></span> <span class=keyword2><span class=keyword>where</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v'</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>=</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M'</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>]</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>M'</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> M'_M drop_lift<span class=main>)</span>
        <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v'</span></span> <span class=keyword2><span class=keyword>where</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v'</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>=</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>]</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>M'</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> M'_M<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> drop_lift<span class=main>)</span>
        <span class=keyword1><span class=command>with</span></span> * <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> eval_agg <span class=free>n</span> <span class=free>g0</span> <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>rel</span> <span class=main>⟷</span> <span class=skolem>v</span> <span class=main>∈</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=bound>k</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>`</span> drop <span class=free>b</span> <span class=main>`</span> <span class=free>rel</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> non_default_case eval_agg_def M'_def Let_def<span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> alt <span class=main>=</span> this

    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtableI<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=var>?fv</span> <span class=var>?rel'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span> n f_fvi
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eval_agg_def non_default_case table_def wf_tuple_def Let_def nth_list_update
            fvi_iff_fv<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span> add.commute<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>"</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> length_v<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>v</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>

      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> eval_agg <span class=free>n</span> <span class=free>g0</span> <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>rel</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> that <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v'</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>=</span> <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>]</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> alt<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> length_v'<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>v'</span> <span class=main>=</span> <span class=free>b</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=skolem>v'</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v'</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span> <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>=</span> <span class=main>_</span>›</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableE<span class=main><span class=main>[</span></span><span class=operator>OF</span> inner<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> drop_lift <span class=quoted><span class=quoted>‹<span class=skolem>v'</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> sat_fv_cong<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> ballI<span class=main>)</span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> <span class=free>y</span> <span class=main>+</span> <span class=free>b</span>"</span></span> <span class=keyword1><span class=command>using</span></span> fresh <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> length <span class=skolem>v'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>›</span></span> b_n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_v'<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"map the <span class=skolem>v'</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>=</span> <span class=main>_</span>›</span></span> nth_append<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>M</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> M_def length_v'<span class=main>)</span>

        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>&lt;</span> length <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_v'<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span>
          Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> sat_fv_cong ballI<span class=main>)</span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> <span class=free>y</span> <span class=main>+</span> <span class=free>b</span>"</span></span> <span class=keyword1><span class=command>using</span></span> fresh <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> length <span class=skolem>v'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>›</span></span> b_n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_v'<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>=</span> <span class=main>_</span>›</span></span> that nth_append<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>f</span> <span class=main>=</span>
          Formula.eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span> <span class=free>f</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> eval_trm_fv_cong ballI<span class=main>)</span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fv_trm <span class=free>f</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> <span class=free>y</span> <span class=main>+</span> <span class=free>b</span>"</span></span> <span class=keyword1><span class=command>using</span></span> f_fv fresh <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> length <span class=skolem>v'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> fv_trm <span class=free>f</span>›</span></span> f_fv b_n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> length_v'<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span>drop <span class=free>b</span> <span class=skolem>v'</span><span class=main>)</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>=</span> <span class=main>_</span>›</span></span> that nth_append<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map the <span class=skolem>v</span> <span class=main>!</span> <span class=free>y</span> <span class=main>=</span> eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> M_def <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>=</span> <span class=main>_</span>›</span></span> conj_commute <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> conj_cong<span class=main>)</span>
        <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> M_def<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>

      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> eval_agg <span class=free>n</span> <span class=free>g0</span> <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>rel</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> sat_Agg<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>Formula.Agg <span class=free>y</span> <span class=free>ω</span> <span class=free>b</span> <span class=free>f</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>zs</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"map Some <span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fv <span class=free>φ</span> <span class=main>⊆</span> <span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>}</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>with</span></span> non_default_case <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>≠</span> empty_table"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> g0<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> <span class=free>n</span><span class=main>.</span> <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>=</span> None<span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> True <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>›</span></span> f_fv
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def fvi_iff_fv<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span> fvi_trm_iff_fv_trm<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> x<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> <span class=free>n</span><span class=main>.</span> drop <span class=free>b</span> <span class=skolem>x</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>=</span> None<span class=main>)</span> <span class=main>∧</span> length <span class=skolem>x</span> <span class=main>=</span> <span class=free>b</span> <span class=main>+</span> <span class=free>n</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> True <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span> inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span> f_fv
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>=</span> drop <span class=free>b</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> list_eq_iff_nth_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> length_v<span class=main>)</span>
          <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"take <span class=free>b</span> <span class=skolem>x</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map <span class=main>(</span>Some <span class=main>∘</span> the<span class=main>)</span> <span class=main>(</span>take <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> take <span class=free>b</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> True <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>rel</span>›</span></span> inner<span class=main>[</span><span class=operator>THEN</span> qtable_wf_tupleD<span class=main>]</span> b_fv
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> map_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> g<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted>id</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> refl<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def in_set_conv_nth<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map Some <span class=main>(</span>map the <span class=main>(</span>take <span class=free>b</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=skolem>thesis</span></span> <span class=keyword1><span class=command>using</span></span> x<span class=main>[</span><span class=operator>THEN</span> conjunct2<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> that<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>with</span></span> sat_Agg <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>zs</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> fresh
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_update not_less nth_append <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> sat_fv_cong<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span>
                <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> nth_list_update_neq<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map Some <span class=skolem>zs</span> <span class=main>@</span> <span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>∈</span> <span class=free>rel</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> b_fv f_fv fresh
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableI<span class=main><span class=main>[</span></span><span class=operator>OF</span> inner<span class=main><span class=main>]</span></span> wf_tuple_append wf_tuple_map_Some
                wf_tuple_upd_None <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>›</span></span> mem_restr_upd_None <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span>
                <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>›</span></span> set_eq_iff fvi_iff_fv<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span> fvi_trm_iff_fv_trm<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
              <span class=operator>force</span><span class=main><span class=keyword3>+</span></span>
          <span class=keyword1><span class=command>with</span></span> that <span class=quoted><span class=quoted>‹length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=skolem>thesis</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span> <span class=main>∈</span> drop <span class=free>b</span> <span class=main>`</span> <span class=free>rel</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> image_eqI<span class=main>)</span> <span class=operator>auto</span>

        <span class=keyword1><span class=command>have</span></span> y_length<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>&lt;</span> length <span class=skolem>v</span>"</span></span> <span class=keyword1><span class=command>using</span></span> n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_v<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>⟷</span>
          Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> sat_fv_cong ballI<span class=main>)</span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> <span class=free>y</span> <span class=main>+</span> <span class=free>b</span>"</span></span> <span class=keyword1><span class=command>using</span></span> fresh <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>b</span> <span class=main>+</span> length <span class=skolem>v</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> fv <span class=free>φ</span>›</span></span> b_n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_v<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> that nth_append<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=free>f</span> <span class=main>=</span>
          Formula.eval_trm <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=free>f</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>zs</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>zs</span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> eval_trm_fv_cong ballI<span class=main>)</span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fv_trm <span class=free>f</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> <span class=free>y</span> <span class=main>+</span> <span class=free>b</span>"</span></span> <span class=keyword1><span class=command>using</span></span> f_fv fresh <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>b</span> <span class=main>+</span> length <span class=skolem>v</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> fv_trm <span class=free>f</span>›</span></span> f_fv b_n <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> length_v<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span> <span class=main>@</span> map the <span class=skolem>v</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>x</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> that nth_append<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map the <span class=skolem>v</span> <span class=main>!</span> <span class=free>y</span> <span class=main>=</span> eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> sat_Agg <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> M_def <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> conj_cong<span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> rev_conj_cong<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>!</span> <span class=free>y</span> <span class=main>=</span> Some <span class=main>(</span>eval_agg_op <span class=free>ω</span> <span class=main>(</span><span class=skolem>M</span> <span class=main>(</span>map the <span class=main>(</span><span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=var>?fv</span> <span class=skolem>v</span>›</span></span> y_length <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> alt<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹mem_restr <span class=free>R</span> <span class=skolem>v</span>›</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> image_eqI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>None<span class=main>]</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>use</span> 1 2 <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> <span class=quoted>‹<span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main>:</span> y_length list_update_id›</span><span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mprev<span class=main>:</span> <span class=quoted><span class=quoted>"mprev_next <span class=free>I</span> <span class=free>xs</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>xs'</span><span class=main>,</span> <span class=free>ts'</span><span class=main>)</span> <span class=main>⟹</span>
  list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>xs</span> <span class=main>⟹</span> list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>ts</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>j'</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>&lt;</span> <span class=free>j</span> <span class=main>⟹</span>
  list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=keyword1>if</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=free>I</span> <span class=keyword1>then</span> <span class=free>P</span> <span class=bound>i</span> <span class=bound>X</span> <span class=keyword1>else</span> <span class=bound>X</span> <span class=main>=</span> empty_table<span class=main>)</span>
    <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span>min <span class=free>j'</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>]</span> <span class=free>ys</span> <span class=main>∧</span>
  list_all2 <span class=free>P</span> <span class=main>[</span>min <span class=free>j'</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>xs'</span> <span class=main>∧</span>
  list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>min <span class=free>j'</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>I</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>xs'</span></span> <span class=quoted><span class=free>ts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mprev_next.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>I</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"min <span class=free>j'</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>I</span> <span class=skolem>v</span> <span class=skolem>v'</span> <span class=skolem>t</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"min <span class=free>j'</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> 3 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>4 <span class=skolem>I</span> <span class=skolem>x</span> <span class=skolem>xs</span> <span class=skolem>t</span> <span class=skolem>t'</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> 4<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"tl <span class=skolem>ys</span>"</span></span> <span class=quoted><span class=skolem>xs'</span></span> <span class=quoted><span class=skolem>ts'</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span>"</span></span><span class=main>]</span> 4<span class=main>(</span>2-6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> mnext<span class=main>:</span> <span class=quoted><span class=quoted>"mprev_next <span class=free>I</span> <span class=free>xs</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>(</span><span class=free>ys</span><span class=main>,</span> <span class=free>xs'</span><span class=main>,</span> <span class=free>ts'</span><span class=main>)</span> <span class=main>⟹</span>
  list_all2 <span class=free>P</span> <span class=main>[</span>Suc <span class=free>i</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>xs</span> <span class=main>⟹</span> list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>ts</span> <span class=main>⟹</span> Suc <span class=free>i</span> <span class=main>≤</span> <span class=free>j'</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>&lt;</span> <span class=free>j</span> <span class=main>⟹</span>
  list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=keyword1>if</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=free>I</span> <span class=keyword1>then</span> <span class=free>P</span> <span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=bound>X</span> <span class=keyword1>else</span> <span class=bound>X</span> <span class=main>=</span> empty_table<span class=main>)</span>
    <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span>min <span class=main>(</span><span class=free>j'</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>]</span> <span class=free>ys</span> <span class=main>∧</span>
  list_all2 <span class=free>P</span> <span class=main>[</span>Suc <span class=main>(</span>min <span class=main>(</span><span class=free>j'</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>xs'</span> <span class=main>∧</span>
  list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>min <span class=main>(</span><span class=free>j'</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>I</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>xs'</span></span> <span class=quoted><span class=free>ts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mprev_next.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>I</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"min <span class=main>(</span><span class=free>j'</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>I</span> <span class=skolem>v</span> <span class=skolem>v'</span> <span class=skolem>t</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"min <span class=main>(</span><span class=free>j'</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> 3 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>4 <span class=skolem>I</span> <span class=skolem>x</span> <span class=skolem>xs</span> <span class=skolem>t</span> <span class=skolem>t'</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> 4<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"tl <span class=skolem>ys</span>"</span></span> <span class=quoted><span class=skolem>xs'</span></span> <span class=quoted><span class=skolem>ts'</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span>"</span></span><span class=main>]</span> 4<span class=main>(</span>2-6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits if_splits<span class=main>)</span> <span class=comment1>(* slow 10 sec *)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> in_foldr_UnI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>A</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> foldr <span class=main>(∪)</span> <span class=free>xs</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> in_foldr_UnE<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> foldr <span class=main>(∪)</span> <span class=free>xs</span> <span class=main>{}</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>A</span><span class=main>.</span> <span class=bound>A</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=bound>A</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sat_the_restrict<span class=main>:</span> <span class=quoted><span class=quoted>"fv <span class=free>φ</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=main>(</span>restrict <span class=free>A</span> <span class=free>v</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>=</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sat_fv_cong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> map_the_restrict<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> eps_the_restrict<span class=main>:</span> <span class=quoted><span class=quoted>"fv_regex <span class=free>r</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span> Regex.eps <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=main>(</span>restrict <span class=free>A</span> <span class=free>v</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span> <span class=main>=</span> Regex.eps <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> eps_fv_cong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> map_the_restrict<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> sorted_wrt_filter<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"sorted_wrt <span class=free>R</span> <span class=free>xs</span> <span class=main>⟹</span> sorted_wrt <span class=free>R</span> <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> concat_map_filter<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"concat <span class=main>(</span>map <span class=free>f</span> <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> concat <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>x</span> <span class=keyword1>then</span> <span class=free>f</span> <span class=bound>x</span> <span class=keyword1>else</span> <span class=main>[]</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> map_filter_alt<span class=main>:</span>
  <span class=quoted><span class=quoted>"map <span class=free>f</span> <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span><span class=main>)</span> <span class=main>=</span> concat <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>x</span> <span class=keyword1>then</span> <span class=main>[</span><span class=free>f</span> <span class=bound>x</span><span class=main>]</span> <span class=keyword1>else</span> <span class=main>[]</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> update_since<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_since_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>aux</span> <span class=free>ne</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtable1<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span><span class=main>)</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtable2<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>ψ</span><span class=main>)</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> result_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>rel</span><span class=main>,</span> <span class=free>aux'</span><span class=main>)</span> <span class=main>=</span> update_since <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=free>aux</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> fvi_subset<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_ivl<span class=main>:</span> <span class=quoted><span class=quoted>"args_ivl <span class=free>args</span> <span class=main>=</span> <span class=free>I</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_n<span class=main>:</span> <span class=quoted><span class=quoted>"args_n <span class=free>args</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_L<span class=main>:</span> <span class=quoted><span class=quoted>"args_L <span class=free>args</span> <span class=main>=</span> Formula.fv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_R<span class=main>:</span> <span class=quoted><span class=quoted>"args_R <span class=free>args</span> <span class=main>=</span> Formula.fv <span class=free>ψ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_pos<span class=main>:</span> <span class=quoted><span class=quoted>"args_pos <span class=free>args</span> <span class=main>=</span> <span class=free>pos</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_since_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>aux'</span> <span class=main>(</span>Suc <span class=free>ne</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?wf_tuple</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=bound>v</span>"</span></span>
  <span class=keyword1><span class=command>note</span></span> sat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> pre<span class=main>[</span><span class=operator>unfolded</span> wf_since_aux_def<span class=main>]</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>cur</span></span> <span class=skolem><span class=skolem>auxlist</span></span> <span class=keyword2><span class=keyword>where</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=skolem>cur</span> <span class=free>aux</span> <span class=skolem>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>y</span> <span class=main>&lt;</span> fst <span class=bound>x</span><span class=main>)</span> <span class=skolem>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span> <span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist</span> <span class=main>⟹</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>∧</span>
      qtable <span class=free>n</span> <span class=main>(</span>fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
        <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=bound>X</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>⟹</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>⟹</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span> <span class=main>⟹</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> cur_def<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>ne</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> args_ivl args_n args_pos <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>from</span></span> pre<span class=main>[</span><span class=operator>unfolded</span> wf_since_aux_def<span class=main>]</span> <span class=keyword1><span class=command>have</span></span> fv_sub<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>aux0</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>aux0</span> <span class=main>=</span> <span class=free>join_msaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=main>(</span><span class=free>add_new_ts_msaux</span> <span class=free>args</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=free>aux</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>auxlist0</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>auxlist0</span> <span class=main>=</span> <span class=main>[</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=free>pos</span> <span class=free>rel1</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=skolem>auxlist</span><span class=main>,</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free>I</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tabL<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> qtable1<span class=main>[</span><span class=operator>unfolded</span> qtable_def<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> args_n<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> args_L<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> cur_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> cur_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> valid0<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=skolem>aux0</span> <span class=skolem>auxlist0</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> aux0_def auxlist0_def
    <span class=keyword1><span class=command>using</span></span> valid_join_msaux<span class=main>[</span><span class=operator>OF</span> valid_add_new_ts_msaux<span class=main><span class=main>[</span></span><span class=operator>OF</span> aux<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>OF</span> cur_le tabL<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_ivl args_pos cur_def map_filter_alt split_beta <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> map_cong<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> aux<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> sorted_auxlist0<span class=main>:</span> <span class=quoted><span class=quoted>"sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=skolem>auxlist0</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist0_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>auxlist</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sorted_wrt_append<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> in_auxlist0_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span> <span class=main>⟹</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>∧</span>
      qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>∧</span>
        <span class=main>(</span><span class=keyword1>if</span> <span class=free>pos</span> <span class=keyword1>then</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span> <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>X</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>X</span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist0_def <span class=keyword1><span class=command>using</span></span> fvi_subset
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 1 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_join<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ qtable1<span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sat_the_restrict <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> aux<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> in_auxlist0_le_τ<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span> <span class=main>⟹</span> <span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>X</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> τ_mono diff_le_self le_trans<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> in_auxlist0_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>⟹</span> <span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>⟹</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span> <span class=main>⟹</span>
    <span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>t</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> aux<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> gr0_conv_Suc <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> diff_le_mono τ_mono<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> join <span class=skolem>X</span> <span class=free>pos</span> <span class=free>rel1</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> auxlist0_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>X</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> auxlist0_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>auxlist0</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>⟹</span> <span class=free>ne</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∨</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>⟶</span>
        <span class=main>(</span><span class=main>∄</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> in_auxlist0_2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

  <span class=keyword1><span class=command>have</span></span> aux'_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>aux'</span> <span class=main>=</span> <span class=free>add_new_table_msaux</span> <span class=free>args</span> <span class=free>rel2</span> <span class=skolem>aux0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> result_eq <span class=keyword1><span class=command>unfolding</span></span> aux0_def update_since_def Let_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>auxlist'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    auxlist'_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>auxlist'</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>auxlist0</span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>⇒</span> <span class=main>[</span><span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>,</span> <span class=free>rel2</span><span class=main>)</span><span class=main>]</span>
    <span class=main>|</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>auxlist'</span> <span class=main>⇒</span> <span class=main>(</span><span class=keyword1>if</span> fst <span class=bound>x</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=keyword1>then</span> <span class=main>(</span>fst <span class=bound>x</span><span class=main>,</span> snd <span class=bound>x</span> <span class=main>∪</span> <span class=free>rel2</span><span class=main>)</span> <span class=main>#</span> <span class=bound>auxlist'</span> <span class=keyword1>else</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>,</span> <span class=free>rel2</span><span class=main>)</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>auxlist'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tabR<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> qtable2<span class=main>[</span><span class=operator>unfolded</span> qtable_def<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> args_n<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> args_R<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> valid'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_msaux</span> <span class=free>args</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=free>aux'</span> <span class=skolem>auxlist'</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> aux'_eq auxlist'_eq <span class=keyword1><span class=command>using</span></span> valid_add_new_table_msaux<span class=main>[</span><span class=operator>OF</span> valid0 tabR<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_le <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits option.splits if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> sorted_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=skolem>auxlist'</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq
    <span class=keyword1><span class=command>using</span></span> sorted_auxlist0 in_auxlist0_le_τ <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>auxlist0</span></span><span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> in_auxlist'_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>∧</span>
      qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=skolem>X</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist'</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>X</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>auxlist0</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>with</span></span> auxlist' <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>using</span></span> qtable2 auxlist0_Nil
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> sat_Since_rec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>ne</span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ refl<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> t<span class=main>:</span> True
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>with</span></span> auxlist' Cons t <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>X</span> <span class=main>=</span> snd <span class=skolem>a</span> <span class=main>∪</span> <span class=free>rel2</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>using</span></span> sorted_auxlist0 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> in_auxlist0_1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span> Cons <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
          <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> fst <span class=skolem>a</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> fst <span class=skolem>a</span>"</span></span>
          <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>
            <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> fst <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>pos</span> <span class=keyword1>then</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span>
              <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> True<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> qtable2 t True
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sat_Since_rec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>ne</span></span><span class=main><span class=main>]</span></span> sat.simps<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>with</span></span> auxlist' Cons t <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>X</span> <span class=main>=</span> <span class=free>rel2</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>using</span></span> sorted_auxlist0 in_auxlist0_le_τ<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>with</span></span> auxlist' Cons t False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>using</span></span> qtable2 in_auxlist0_2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span><span class=main>]</span> in_auxlist0_le_τ<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span> sorted_auxlist0
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sat_Since_rec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>ne</span></span><span class=main><span class=main>]</span></span> sat.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> enat_0_iff not_le
              <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ refl<span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_τ_less meta_mp<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> auxlist' Cons <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span>
        <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=main>∧</span>
           <span class=main>(</span><span class=keyword1>if</span> <span class=free>pos</span> <span class=keyword1>then</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span> <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=skolem>X</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> in_auxlist0_1 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>with</span></span> False auxlist' Cons <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>using</span></span> qtable2
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sat_Since_rec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>ne</span></span><span class=main><span class=main>]</span></span> sat.simps<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span>
            diff_diff_right<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> j<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>_</span> <span class=main>+</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> k<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span><span class=main><span class=main>,</span></span>
              <span class=operator>OF</span> trans_le_add2<span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ refl<span class=main><span class=main>]</span></span> order_trans <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> le_τ_less<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>

  <span class=keyword1><span class=command>have</span></span> in_auxlist'_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist'</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>auxlist0</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>with</span></span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> that <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> le_τ_less neq0_conv <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False that <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> One_nat_def Suc_leI Suc_pred τ_mono diff_is_0_eq' order.antisym neq0_conv not_le<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist0</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>›</span></span>
      <span class=keyword1><span class=command>using</span></span> τ_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span>"</span></span> <span class=quoted><span class=free>σ</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_auxlist0_2 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> τ_mono<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> auxlist'_eq <span class=keyword1><span class=command>using</span></span> False <span class=quoted><span class=quoted>‹τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>X</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.split<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>

  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wf_since_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>aux'</span> <span class=main>(</span>Suc <span class=free>ne</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_since_aux_def args_ivl args_n args_pos
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fv_sub <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> in_auxlist'_1 <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> sorted_auxlist' in_auxlist'_2
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>auxlist'</span></span><span class=main><span class=main>]</span></span> valid'<span class=main>)</span>

  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>=</span> <span class=free>result_msaux</span> <span class=free>args</span> <span class=free>aux'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> result_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> update_since_def Let_def<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> valid' <span class=keyword1><span class=command>have</span></span> rel_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>=</span> foldr <span class=main>(∪)</span> <span class=main>[</span><span class=bound>rel</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=skolem>auxlist'</span><span class=main>,</span> left <span class=free>I</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> args_ivl valid_result_msaux
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> foldr <span class=main>(∪)</span> <span class=main>(</span>concat <span class=bound>x</span><span class=main>)</span> <span class=main>{}</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> rel_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist'</span><span class=main>.</span> <span class=keyword1>if</span> left <span class=free>I</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=bound>rel</span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> rel_eq
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_foldr_UnE bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_foldr_UnI<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> rel_alt
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtable_Union<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> Qi<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>v</span><span class=main>.</span>
    left <span class=free>I</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Sincep <span class=free>pos</span> <span class=free>φ</span> <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
        <span class=operator>goal_cases</span> finite qtable equiv<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>equiv <span class=skolem>v</span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main><span class=keyword3>,</span></span> <span class=operator>erule</span> sat_Since_point<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> left right<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>left <span class=skolem>j</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> in_auxlist'_2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>j</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> _ _ exI<span class=main>,</span> <span class=operator>OF</span> _ _ refl<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> right
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> sat_Since_pointD <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> in_auxlist'_1<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_auxlist'_1 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_empty<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> fv_regex_from_mregex<span class=main>:</span>
  <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=free>mr</span> <span class=main>⟹</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>φ</span> <span class=main>∈</span> set <span class=free>φs</span><span class=main>.</span> fv <span class=bound>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Bex_def in_set_conv_nth<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> qtable_ε_lax<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=free>mr</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=free>Q</span> <span class=free>guard</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
   <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Regex.eps <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span> <span class=bound>v</span><span class=main>)</span> <span class=main>(</span>ε_lax <span class=free>guard</span> <span class=free>rels</span> <span class=free>mr</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MPlus<span class=main>(</span>3-6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> MPlus<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=skolem>mr1</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=skolem>mr2</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fv_regex_from_mregex<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φs</span></span> <span class=quoted><span class=skolem>mr1</span></span><span class=main>]</span> fv_regex_from_mregex<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φs</span></span> <span class=quoted><span class=skolem>mr2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> subset_eq<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> MTimes<span class=main>(</span>3-6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eps_the_restrict restrict_idle <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_join<span class=main><span class=main>[</span></span><span class=operator>OF</span> MTimes<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_empty_iff list_all2_conv_all_nth
    in_set_conv_nth restrict_idle sat_the_restrict
    <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> in_qtableI qtableI <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_join<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> A<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>A</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> C<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>A</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> nullary_qtable_cases<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>X</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>X</span> <span class=main>=</span> empty_table <span class=main>∨</span> <span class=free>X</span> <span class=main>=</span> unit_table <span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> qtable_def table_empty<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_empty_unit_table<span class=main>:</span>
  <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>R</span> <span class=free>P</span> empty_table <span class=main>⟹</span> qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>¬</span> <span class=free>P</span> <span class=bound>v</span><span class=main>)</span> <span class=main>(</span>unit_table <span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> qtable_unit_table <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> qtable_empty_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_unit_empty_table<span class=main>:</span>
  <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>R</span> <span class=free>P</span> <span class=main>(</span>unit_table <span class=free>n</span><span class=main>)</span> <span class=main>⟹</span> qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>¬</span> <span class=free>P</span> <span class=bound>v</span><span class=main>)</span> empty_table"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_empty <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> in_qtableE <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_empty unit_table_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_nonempty_empty_table<span class=main>:</span>
  <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>R</span> <span class=free>P</span> <span class=free>X</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> qtable <span class=free>n</span> <span class=main>{}</span> <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>¬</span> <span class=free>P</span> <span class=bound>v</span><span class=main>)</span> empty_table"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>frule</span> nullary_qtable_cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> qtable_unit_empty_table<span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> qtable_rε_strict<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=free>mr</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Regex.eps <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>rε_strict <span class=free>n</span> <span class=free>rels</span> <span class=free>mr</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>hypsubst</span><span class=main><span class=keyword3>,</span></span> <span class=operator>induct</span> <span class=quoted>Past</span> <span class=quoted>Strict</span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Skip <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_empty_iff qtable_unit_table <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth qtable_empty_unit_table
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_nonempty_empty_table <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> qtable_union <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesP <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_ε_lax<span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_unit_table <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> qtable_lε_strict<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=free>mr</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Regex.eps <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lε_strict <span class=free>n</span> <span class=free>rels</span> <span class=free>mr</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>hypsubst</span><span class=main><span class=keyword3>,</span></span> <span class=operator>induct</span> <span class=quoted>Futu</span> <span class=quoted>Strict</span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Skip <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_empty_iff qtable_unit_table <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth qtable_empty_unit_table
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_nonempty_empty_table <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> qtable_union <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesF <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_ε_lax<span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_unit_table <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> rtranclp_False<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> False<span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=main>=</span> <span class=main>(=)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> False<span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>*</sup><span class=hidden>⇧</span><sup>*</sup></span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=main>⟹</span> <span class=skolem>i</span> <span class=main>=</span> <span class=skolem>j</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=main>::</span> <span class=tfree><span class=quoted><span class=tfree>'a</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=skolem>i</span></span> <span class=quoted><span class=skolem>j</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtranclp.induct<span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>inductive</span></span> <span class=entity>ok_rctxt</span> <span class=keyword2><span class=keyword>for</span></span> <span class=entity>φs</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ok_rctxt</span> <span class=free>φs</span> id id"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok_rctxt</span> <span class=free>φs</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>κ'</span></span></span> <span class=main>⟹</span> <span class=free>ok_rctxt</span> <span class=free>φs</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MTimes <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ'</span></span></span> <span class=main>(</span>Regex.Times <span class=main>(</span>from_mregex <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free>φs</span><span class=main>)</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> ok_rctxt_swap<span class=main>:</span> <span class=quoted><span class=quoted>"ok_rctxt <span class=free>φs</span> <span class=free>κ</span> <span class=free>κ'</span> <span class=main>⟹</span> from_mregex <span class=main>(</span><span class=free>κ</span> <span class=free>mr</span><span class=main>)</span> <span class=free>φs</span> <span class=main>=</span> <span class=free>κ'</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>κ</span></span> <span class=quoted><span class=free>κ'</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> ok_rctxt.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> ok_rctxt_cong<span class=main>:</span> <span class=quoted><span class=quoted>"ok_rctxt <span class=free>φs</span> <span class=free>κ</span> <span class=free>κ'</span> <span class=main>⟹</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>s</span> <span class=main>⟹</span>
  Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=main>(</span><span class=free>κ'</span> <span class=free>r</span><span class=main>)</span> <span class=free>i</span> <span class=free>j</span> <span class=main>=</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=main>(</span><span class=free>κ'</span> <span class=free>s</span><span class=main>)</span> <span class=free>i</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>κ</span></span> <span class=quoted><span class=free>κ'</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> ok_rctxt.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_rδκ<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=free>mr</span>"</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>j</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"ok_rctxt <span class=free>φs</span> <span class=free>κ</span> <span class=free>κ'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>ms</span> <span class=main>∈</span> <span class=free>κ</span> <span class=main>`</span> RPD <span class=free>mr</span><span class=main>.</span> qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=free>Q</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=free>rel</span> <span class=bound>ms</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
  <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span> <span class=main>∈</span> Regex.rpdκ <span class=free>κ'</span> <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>j</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span><span class=main>.</span> <span class=free>Q</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>s</span><span class=main>)</span>
  <span class=main>(</span>rδ <span class=free>κ</span> <span class=free>rel</span> <span class=free>rels</span> <span class=free>mr</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>κ</span></span> <span class=quoted><span class=free>κ'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> MSkip
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rtranclp_False ok_rctxt_swap qtable_empty_iff
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ ok_rctxt_cong<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>of</span> <span class=main><span class=main><span class=main>_</span></span></span> <span class=quoted><span class=skolem>κ</span></span> <span class=quoted><span class=skolem>κ'</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MPlus<span class=main>(</span>3-7<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> MPlus<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MTimes<span class=main>(</span>3-7<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> MTimes<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> qtable_ε_lax<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> _ _ _ MTimes<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> ok_rctxt.intros<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def Ball_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>mr</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MStar<span class=main>(</span>2-6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> MStar<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> ok_rctxt.intros <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def Ball_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_empty_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> qtable_rδ <span class=main>=</span> qtable_rδκ<span class=main>[</span><span class=operator>OF</span> _ _ _ ok_rctxt.intros<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>unfolded</span> rpdκ_rpd image_id id_apply<span class=main>]</span>

<span class=keyword1><span class=command>inductive</span></span> <span class=entity>ok_lctxt</span> <span class=keyword2><span class=keyword>for</span></span> <span class=entity>φs</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ok_lctxt</span> <span class=free>φs</span> id id"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>ok_lctxt</span> <span class=free>φs</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=free><span class=bound><span class=entity>κ'</span></span></span> <span class=main>⟹</span> <span class=free>ok_lctxt</span> <span class=free>φs</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ</span></span></span> <span class=main>(</span>MTimes <span class=bound>t</span> <span class=free><span class=bound><span class=entity>mr</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>κ'</span></span></span> <span class=main>(</span>Regex.Times <span class=bound>t</span> <span class=main>(</span>from_mregex <span class=free><span class=bound><span class=entity>mr</span></span></span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> ok_lctxt_swap<span class=main>:</span> <span class=quoted><span class=quoted>"ok_lctxt <span class=free>φs</span> <span class=free>κ</span> <span class=free>κ'</span> <span class=main>⟹</span> from_mregex <span class=main>(</span><span class=free>κ</span> <span class=free>mr</span><span class=main>)</span> <span class=free>φs</span> <span class=main>=</span> <span class=free>κ'</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>κ</span></span> <span class=quoted><span class=free>κ'</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> ok_lctxt.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> ok_lctxt_cong<span class=main>:</span> <span class=quoted><span class=quoted>"ok_lctxt <span class=free>φs</span> <span class=free>κ</span> <span class=free>κ'</span> <span class=main>⟹</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>r</span> <span class=main>=</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=free>s</span> <span class=main>⟹</span>
  Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=main>(</span><span class=free>κ'</span> <span class=free>r</span><span class=main>)</span> <span class=free>i</span> <span class=free>j</span> <span class=main>=</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=free>v</span><span class=main>)</span> <span class=main>(</span><span class=free>κ'</span> <span class=free>s</span><span class=main>)</span> <span class=free>i</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>κ</span></span> <span class=quoted><span class=free>κ'</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=free>s</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> ok_lctxt.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_lδκ<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=free>mr</span>"</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>j</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"ok_lctxt <span class=free>φs</span> <span class=free>κ</span> <span class=free>κ'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>ms</span> <span class=main>∈</span> <span class=free>κ</span> <span class=main>`</span> LPD <span class=free>mr</span><span class=main>.</span> qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=free>Q</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=free>rel</span> <span class=bound>ms</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
  <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span> <span class=main>∈</span> Regex.lpdκ <span class=free>κ'</span> <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>j</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span><span class=main>.</span> <span class=free>Q</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>s</span><span class=main>)</span>
  <span class=main>(</span>lδ <span class=free>κ</span> <span class=free>rel</span> <span class=free>rels</span> <span class=free>mr</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>κ</span></span> <span class=quoted><span class=free>κ'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> MSkip
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rtranclp_False ok_lctxt_swap qtable_empty_iff
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ ok_rctxt_cong<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>of</span> <span class=main><span class=main><span class=main>_</span></span></span> <span class=quoted><span class=skolem>κ</span></span> <span class=quoted><span class=skolem>κ'</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MPlus<span class=main>(</span>3-7<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> MPlus<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>,</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MTimes<span class=main>(</span>3-7<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> MTimes<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span> qtable_ε_lax<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> _ _ _ MTimes<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> ok_lctxt.intros<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def Ball_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>mr</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MStar<span class=main>(</span>2-6<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> MStar<span class=main><span class=main><span class=main>(</span></span></span>1<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> ok_lctxt.intros <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def Ball_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_empty_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> qtable_lδ <span class=main>=</span> qtable_lδκ<span class=main>[</span><span class=operator>OF</span> _ _ _ ok_lctxt.intros<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>unfolded</span> lpdκ_lpd image_id id_apply<span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> RPD_fv_regex_le<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>ms</span> <span class=main>∈</span> RPD <span class=free>mr</span> <span class=main>⟹</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPD_safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> RPD <span class=free>mr</span> <span class=main>⟹</span> safe_regex Past <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted>Past</span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Skip
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>g</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span> <span class=skolem>mrs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mrs</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr</span> <span class=skolem>ms</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Plus<span class=main>(</span>3-5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Plus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesP <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span> <span class=skolem>mrs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mrs</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr</span> <span class=skolem>ms</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> TimesP<span class=main>(</span>3-5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>g</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPD_fv_regex_le TimesP<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>g</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>x6</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Star<span class=main>(</span>2-4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>g</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPD_fv_regex_le
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_cosafe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Star<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> RPDi <span class=free>n</span> <span class=free>mr</span> <span class=main>==&gt;</span> safe_regex Past <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPD_safe<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> RPDs <span class=free>mr</span> <span class=main>==&gt;</span> safe_regex Past <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPDi_safe<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPD_safe_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> RPD <span class=free>mr</span> <span class=main>⟹</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted>Past</span> <span class=quoted>Strict</span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Skip <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesP <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPD_fv_regex_le <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> modality.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPD_fv_regex_le<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_safe_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> RPDi <span class=free>n</span> <span class=free>mr</span> <span class=main>==&gt;</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 5 0 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPD_safe_fv_regex RPD_safe<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_safe_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> RPDs <span class=free>mr</span> <span class=main>==&gt;</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> RPDi_safe_fv_regex<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPD_ok<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> RPD <span class=free>mr</span> <span class=main>⟹</span> ok <span class=free>m</span> <span class=free>ms</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MPlus<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> MPlus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MTimes<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> MTimes<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>mr</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MStar<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> MStar<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesL_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDi_ok<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> RPDi <span class=free>n</span> <span class=free>mr</span> <span class=main>⟹</span> ok <span class=free>m</span> <span class=free>ms</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> RPD_ok<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_ok<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> RPDs <span class=free>mr</span> <span class=main>⟹</span> ok <span class=free>m</span> <span class=free>ms</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> RPDi_ok<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPD_fv_regex_le<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>ms</span> <span class=main>∈</span> LPD <span class=free>mr</span> <span class=main>⟹</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⊆</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPD_safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> LPD <span class=free>mr</span> <span class=main>==&gt;</span> safe_regex Futu <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted>Futu</span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Skip
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>g</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span> <span class=skolem>mrs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mrs</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr</span> <span class=skolem>ms</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Plus<span class=main>(</span>3-5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Plus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesF <span class=skolem>g</span> <span class=skolem>r</span> <span class=skolem>s</span> <span class=skolem>mrs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mrs</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr</span> <span class=skolem>ms</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> TimesF<span class=main>(</span>3-5<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>g</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPD_fv_regex_le <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> modality.splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> TimesF<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>g</span> <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>x6</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Star<span class=main>(</span>2-4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>g</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPD_fv_regex_le
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_cosafe<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Star<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> LPDi <span class=free>n</span> <span class=free>mr</span> <span class=main>==&gt;</span> safe_regex Futu <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPD_safe<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span> <span class=main>==&gt;</span> safe_regex Futu <span class=free>g</span> <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPDi_safe<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPD_safe_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> LPD <span class=free>mr</span> <span class=main>==&gt;</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted>Futu</span> <span class=quoted>Strict</span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Skip
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Test <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Plus <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>TimesF <span class=skolem>r</span> <span class=skolem>s</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPD_fv_regex_le <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> modality.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Star <span class=skolem>r</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPD_fv_regex_le<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_safe_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> LPDi <span class=free>n</span> <span class=free>mr</span> <span class=main>==&gt;</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 5 0 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPD_safe_fv_regex LPD_safe<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_safe_fv_regex<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span> <span class=main>==&gt;</span> fv_regex <span class=main>(</span>from_mregex <span class=free>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> LPDi_safe_fv_regex<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPD_ok<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> LPD <span class=free>mr</span> <span class=main>⟹</span> ok <span class=free>m</span> <span class=free>ms</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPlus <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MPlus<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> MPlus<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MTimes <span class=skolem>mr1</span> <span class=skolem>mr2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MTimes<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> MTimes<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MStar <span class=skolem>mr</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MStar<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> MStar<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> MTimesR_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDi_ok<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> LPDi <span class=free>n</span> <span class=free>mr</span> <span class=main>⟹</span> ok <span class=free>m</span> <span class=free>ms</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ms</span></span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> LPD_ok<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_ok<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=free>m</span> <span class=free>mr</span> <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span> <span class=main>⟹</span> ok <span class=free>m</span> <span class=free>ms</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> LPDi_ok<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> update_matchP<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchP_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>aux</span> <span class=free>ne</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>RPDs <span class=free>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtables<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> result_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>rel</span><span class=main>,</span> <span class=free>aux'</span><span class=main>)</span> <span class=main>=</span> update_matchP <span class=free>n</span> <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>rels</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=free>aux</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_matchP_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>aux'</span> <span class=main>(</span>Suc <span class=free>ne</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Formula.MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?wf_tuple</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=main>(</span>Formula.fv_regex <span class=free>r</span><span class=main>)</span> <span class=bound>v</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?update</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>rel</span> <span class=bound>t</span><span class=main>.</span> mrtabulate <span class=free>mrs</span> <span class=main>(</span><span class=main>λ</span><span class=bound>mr</span><span class=main>.</span>
    rδ id <span class=bound>rel</span> <span class=free>rels</span> <span class=bound>mr</span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=keyword1>then</span> rε_strict <span class=free>n</span> <span class=free>rels</span> <span class=bound>mr</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>note</span></span> sat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>

  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>aux0</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>aux0</span> <span class=main>=</span> <span class=main>[</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=var>?update</span> <span class=bound>rel</span> <span class=bound>t</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=free>aux</span><span class=main>,</span> enat <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=free>I</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> sorted_aux0<span class=main>:</span> <span class=quoted><span class=quoted>"sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=skolem>aux0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pre<span class=main>[</span><span class=operator>unfolded</span> wf_matchP_aux_def<span class=main>,</span> <span class=operator>THEN</span> conjunct1<span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> aux0_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sorted_wrt_append<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ms</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ms</span> <span class=main>∈</span> RPDs <span class=free>mr</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=free>r</span>"</span></span>
      <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=skolem>ms</span>"</span></span> <span class=quoted><span class=quoted>"RPD <span class=skolem>ms</span> <span class=main>⊆</span> RPDs <span class=free>mr</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> safe RPDs_safe RPDs_safe_fv_regex mr from_mregex_to_mregex RPDs_ok to_mregex_ok RPDs_trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>note</span></span> * <span class=main>=</span> this
  <span class=keyword1><span class=command>have</span></span> **<span class=main>:</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> Nat.diff_diff_right τ_mono add.commute add_diff_cancel_left diff_le_self le_add2 order_trans<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> ***<span class=main>:</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span>  <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=skolem>i</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> Suc_pred τ_mono diff_le_self le_τ_less le_antisym not_less_eq that<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> in_aux0_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span> <span class=main>⟹</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>ms</span><span class=main>∈</span>RPDs <span class=free>mr</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span>
         <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=skolem>X</span> <span class=bound>ms</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>X</span>
    <span class=keyword1><span class=command>unfolding</span></span> aux0_def <span class=keyword1><span class=command>using</span></span> safe mr mrs
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lookup_tabulate map_of_map_restrict restrict_map_def finite_RPDs * ** RPDs_trans diff_le_mono2
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> sat_MatchP_rec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>ne</span></span><span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span>
        qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_rδ<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> _ _ qtables<span class=main><span class=main><span class=main>]</span></span></span> qtable_rε_strict<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> _ _ _ qtables<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>,</span></span>
          <span class=operator>of</span> <span class=quoted><span class=skolem>ms</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span> <span class=bound>r</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=bound>v</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>0</span><span class=main>)</span> <span class=bound>r</span><span class=main>)</span>"</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>ms</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>for</span></span></span></span> <span class=skolem>ms</span><span class=main><span class=main>]</span></span>
        qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_rδ<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> _ _ qtables<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>,</span></span>
          <span class=operator>of</span> <span class=quoted><span class=skolem>ms</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span> <span class=bound>r</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=bound>v</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span><span class=main>)</span> <span class=bound>r</span><span class=main>)</span>"</span></span>
          <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span>  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span><span class=main>)</span>  <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>for</span></span></span></span> <span class=skolem>ms</span> <span class=skolem>i</span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>unfolded</span> wf_matchP_aux_def<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> conjunct1<span class=main><span class=main>,</span></span> <span class=operator>rule_format</span><span class=main><span class=main>]</span></span>
        sat_MatchP_rec<span class=main><span class=main>[</span></span><span class=quoted><span class=operator>"of"</span></span> <span class=quoted><span class=free>σ</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>ne</span></span><span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bspec order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ τ_mono<span class=main><span class=main>]</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span> <span class=comment1>(* slow 7 sec *)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> in_aux0_le_τ<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span> <span class=main>⟹</span> <span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>X</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> τ_mono diff_le_self le_trans<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> in_aux0_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>⟹</span> <span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>⟹</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span> <span class=main>⟹</span>
    <span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>t</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>aux</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>unfolded</span> wf_matchP_aux_def<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main>,</span></span> <span class=operator>rule_format</span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> gr0_conv_Suc <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order_trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> diff_le_mono τ_mono<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=var>?update</span> <span class=skolem>X</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> aux0_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> id_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>X</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> aux0_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>aux0</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>⟹</span> <span class=free>ne</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∨</span> <span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>⟶</span>
        <span class=main>(</span><span class=main>∄</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> in_aux0_2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>=</span> <span class=main>0</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

  <span class=keyword1><span class=command>have</span></span> aux'_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>aux'</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>aux0</span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>⇒</span> <span class=main>[</span><span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>,</span> mrtabulate <span class=free>mrs</span> <span class=main>(</span>rε_strict <span class=free>n</span> <span class=free>rels</span><span class=main>)</span><span class=main>)</span><span class=main>]</span>
    <span class=main>|</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>aux'</span> <span class=main>⇒</span> <span class=main>(</span><span class=keyword1>if</span> fst <span class=bound>x</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=keyword1>then</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>aux'</span>
       <span class=keyword1>else</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span><span class=main>,</span> mrtabulate <span class=free>mrs</span> <span class=main>(</span>rε_strict <span class=free>n</span> <span class=free>rels</span><span class=main>)</span><span class=main>)</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>aux'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> result_eq <span class=keyword1><span class=command>unfolding</span></span> aux0_def update_matchP_def Let_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> sorted_aux'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted_wrt <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> fst <span class=bound>x</span> <span class=main>&gt;</span> fst <span class=bound>y</span><span class=main>)</span> <span class=free>aux'</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> aux'_eq
    <span class=keyword1><span class=command>using</span></span> sorted_aux0 in_aux0_le_τ <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>aux0</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

  <span class=keyword1><span class=command>have</span></span> in_aux'_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>∧</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>∧</span>
     <span class=main>(</span><span class=main>∀</span><span class=bound>ms</span><span class=main>∈</span>RPDs <span class=free>mr</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span>
        Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=skolem>X</span> <span class=bound>ms</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> aux'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>aux'</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>X</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>aux0</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>with</span></span> aux' <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>using</span></span> safe mrs qtables aux0_Nil *
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> sat_MatchP_rec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>ne</span></span><span class=main><span class=main>]</span></span>
          lookup_tabulate finite_RPDs <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits
          <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_rε_strict<span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> t<span class=main>:</span> True
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>with</span></span> aux' Cons t <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>X</span> <span class=main>=</span> snd <span class=skolem>a</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>using</span></span> sorted_aux0 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> in_aux0_1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span> Cons <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
          <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> fst <span class=skolem>a</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> fst <span class=skolem>a</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>ms</span> <span class=main>∈</span> RPDs <span class=free>mr</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span>
            <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> fst <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=bound>ms</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> t True
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>with</span></span> aux' Cons t <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>X</span> <span class=main>=</span> mrtabulate <span class=free>mrs</span> <span class=main>(</span>rε_strict <span class=free>n</span> <span class=free>rels</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>using</span></span> sorted_aux0 in_aux0_le_τ<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>with</span></span> aux' Cons t False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>using</span></span> safe mrs qtables * in_aux0_2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span><span class=main>]</span> in_aux0_le_τ<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span> sorted_aux0
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sat_MatchP_rec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> i<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>ne</span></span><span class=main><span class=main>]</span></span> zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> enat_0_iff not_le
              lookup_tabulate finite_RPDs <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits
              <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_rε_strict<span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_τ_less meta_mp<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> aux' Cons <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>ms</span> <span class=main>∈</span> RPDs <span class=free>mr</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span>
          <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=bound>ms</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lookup <span class=skolem>X</span> <span class=bound>ms</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> in_aux0_1 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>with</span></span> False aux' Cons <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>

  <span class=keyword1><span class=command>have</span></span> in_aux'_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>aux'</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>aux0</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>with</span></span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>using</span></span> eq_fst_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>t</span></span> <span class=quoted><span class=skolem>a</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> that <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> le_τ_less neq0_conv <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> False that <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span><span class=main>-</span><span class=main>1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> One_nat_def Suc_leI Suc_pred τ_mono diff_is_0_eq' order.antisym neq0_conv not_le<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>aux0</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>≤</span> right <span class=free>I</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>∃</span><span class=bound>i</span><span class=main>.</span> τ <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=skolem>t</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>atomize_elim</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_aux0_2<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> aux'_eq <span class=keyword1><span class=command>using</span></span> False
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>X</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.split<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>

  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wf_matchP_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>aux'</span> <span class=main>(</span>Suc <span class=free>ne</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_matchP_aux_def <span class=keyword1><span class=command>using</span></span> mr
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> in_aux'_1 <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> sorted_aux' in_aux'_2<span class=main>)</span>

  <span class=keyword1><span class=command>have</span></span> rel_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>=</span> foldr <span class=main>(∪)</span> <span class=main>[</span>lookup <span class=bound>rel</span> <span class=free>mr</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=free>aux'</span><span class=main>,</span> left <span class=free>I</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> aux'_eq aux0_def
    <span class=keyword1><span class=command>using</span></span> result_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> update_matchP_def Let_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> rel_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>aux'</span><span class=main>.</span> <span class=keyword1>if</span> left <span class=free>I</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=keyword1>then</span> lookup <span class=bound>rel</span> <span class=free>mr</span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> rel_eq
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_foldr_UnE bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_foldr_UnI<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Formula.MatchP <span class=free>I</span> <span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> rel_alt
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtable_Union<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> Qi<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>v</span><span class=main>.</span>
    left <span class=free>I</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>ne</span> <span class=main>(</span>Formula.MatchP <span class=main>(</span>point <span class=main>(</span>τ <span class=free>σ</span> <span class=free>ne</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free>r</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
        <span class=operator>goal_cases</span> finite qtable equiv<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>equiv <span class=skolem>v</span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main><span class=keyword3>,</span></span> <span class=operator>erule</span> sat_MatchP_point<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> left right<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>left <span class=skolem>j</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> in_aux'_2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>j</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> _ _ exI<span class=main>,</span> <span class=operator>OF</span> _ _ refl<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> right
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> sat_MatchP_pointD <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> in_aux'_1<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_aux'_1 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_empty <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bspec<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ RPDs_refl<span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> from_mregex_eq<span class=main><span class=main>[</span></span><span class=operator>OF</span> safe mr<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> length_update_until<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=free>aux</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> update_until_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> wf_update_until_auxlist<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=free>auxlist</span> <span class=free>ne</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtable1<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>auxlist</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtable2<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>auxlist</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> fvi_subset<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_ivl<span class=main>:</span> <span class=quoted><span class=quoted>"args_ivl <span class=free>args</span> <span class=main>=</span> <span class=free>I</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_n<span class=main>:</span> <span class=quoted><span class=quoted>"args_n <span class=free>args</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_pos<span class=main>:</span> <span class=quoted><span class=quoted>"args_pos <span class=free>args</span> <span class=main>=</span> <span class=free>pos</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=free>ne</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_until_auxlist_def length_update_until
  <span class=keyword1><span class=command>unfolding</span></span> update_until_def list.rel_map add_Suc_right upt.simps eqTrueI<span class=main>[</span><span class=operator>OF</span> le_add1<span class=main>]</span> if_True
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> list_all2_appendI<span class=main><span class=keyword3>,</span></span> <span class=operator>unfold</span> list.rel_map<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> old new<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> old
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> list.rel_mono_strong<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>unfolded</span> wf_until_auxlist_def<span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>safe</span><span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> mono1 mono2<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>mono1 <span class=skolem>i</span> <span class=skolem>X</span> <span class=skolem>Y</span> <span class=skolem>v</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_ivl args_n args_pos sat_the_restrict less_Suc_eq
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_join<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ qtable1<span class=main><span class=main>]</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ qtable1<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>mono2 <span class=skolem>i</span> <span class=skolem>X</span> <span class=skolem>Y</span> <span class=skolem>v</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> fvi_subset
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_ivl args_n args_pos sat_the_restrict less_Suc_eq <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ qtable_join_fixed<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> qtable2<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ refl<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>+</span> length <span class=free>auxlist</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=comment1>(* slow 8 sec*)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> new
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_empty qtable1 qtable2<span class=main><span class=main>[</span></span><span class=operator>THEN</span> qtable_cong<span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=free>ne</span> <span class=main>+</span> length <span class=free>auxlist</span>"</span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_ivl args_n args_pos less_Suc_eq zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> muaux<span class=main>)</span> wf_update_until<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>aux</span> <span class=free>ne</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtable1<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span> <span class=free>φ</span><span class=main>)</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtable2<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ψ</span><span class=main>)</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> fvi_subset<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=free>φ</span> <span class=main>⊆</span> Formula.fv <span class=free>ψ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_ivl<span class=main>:</span> <span class=quoted><span class=quoted>"args_ivl <span class=free>args</span> <span class=main>=</span> <span class=free>I</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_n<span class=main>:</span> <span class=quoted><span class=quoted>"args_n <span class=free>args</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_L<span class=main>:</span> <span class=quoted><span class=quoted>"args_L <span class=free>args</span> <span class=main>=</span> Formula.fv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_R<span class=main>:</span> <span class=quoted><span class=quoted>"args_R <span class=free>args</span> <span class=main>=</span> Formula.fv <span class=free>ψ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_pos<span class=main>:</span> <span class=quoted><span class=quoted>"args_pos <span class=free>args</span> <span class=main>=</span> <span class=free>pos</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_until_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>R</span> <span class=free>args</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=main>(</span><span class=free>add_new_muaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span><span class=main>)</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=main>∧</span>
      <span class=free>length_muaux</span> <span class=free>args</span> <span class=main>(</span><span class=free>add_new_muaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span><span class=main>)</span> <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>(</span><span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> pre <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>cur</span></span> <span class=skolem><span class=skolem>auxlist</span></span> <span class=keyword2><span class=keyword>where</span></span> valid_aux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=free>args</span> <span class=skolem>cur</span> <span class=free>aux</span> <span class=skolem>auxlist</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    cur<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>ne</span> <span class=main>+</span> length <span class=skolem>auxlist</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=skolem>auxlist</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    pre_list<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=skolem>auxlist</span> <span class=free>ne</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def args_ivl args_n args_pos <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> length_aux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span> <span class=main>=</span> length <span class=skolem>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_length_muaux<span class=main>[</span><span class=operator>OF</span> valid_aux<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>nt</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nt</span> <span class=main>≡</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> nt_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>≤</span> <span class=skolem>nt</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> cur nt_def length_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>auxlist'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>auxlist'</span> <span class=main>≡</span> update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=skolem>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=skolem>auxlist</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> length_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>auxlist'</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=skolem>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist'_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_update_until<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tab1<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> qtable1 <span class=keyword1><span class=command>unfolding</span></span> args_n<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> args_L<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> qtable_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tab2<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> qtable2 <span class=keyword1><span class=command>unfolding</span></span> args_n<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> args_R<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> qtable_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> fv_sub<span class=main>:</span> <span class=quoted><span class=quoted>"fv <span class=free>φ</span> <span class=main>⊆</span> fv <span class=free>ψ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pre <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> valid_add_new_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=free>args</span> <span class=skolem>nt</span> <span class=main>(</span><span class=free>add_new_muaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=skolem>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=skolem>auxlist'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_add_new_muaux<span class=main>[</span><span class=operator>OF</span> valid_aux tab1 tab2 nt_mono<span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist'_def nt_def length_aux <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>length_muaux</span> <span class=free>args</span> <span class=main>(</span><span class=free>add_new_muaux</span> <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=skolem>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>(</span><span class=free>length_muaux</span> <span class=free>args</span> <span class=free>aux</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_length_muaux<span class=main>[</span><span class=operator>OF</span> valid_add_new_auxlist<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> length_auxlist' length_aux<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=skolem>auxlist'</span> <span class=free>ne</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wf_update_until_auxlist<span class=main>[</span><span class=operator>OF</span> pre_list qtable1<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> length_aux<span class=main><span class=main>]</span></span> qtable2<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> length_aux<span class=main><span class=main>]</span></span> fv_sub args_ivl args_n args_pos<span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist'_def <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=skolem>auxlist</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>ne</span> <span class=main>+</span> length <span class=skolem>auxlist'</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=skolem>auxlist'</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> cur length_auxlist' <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def nt_def length_aux args_ivl args_n args_pos <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> length_update_matchF_base<span class=main>:</span>
  <span class=quoted><span class=quoted>"length <span class=main>(</span>fst <span class=main>(</span>update_matchF_base <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>nt</span> <span class=free>entry</span> <span class=free>st</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def update_matchF_base_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> length_update_matchF_step<span class=main>:</span>
  <span class=quoted><span class=quoted>"length <span class=main>(</span>fst <span class=main>(</span>update_matchF_step <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>nt</span> <span class=free>entry</span> <span class=free>st</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=main>(</span>fst <span class=free>st</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def update_matchF_step_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> length_foldr_update_matchF_step<span class=main>:</span>
  <span class=quoted><span class=quoted>"length <span class=main>(</span>fst <span class=main>(</span>foldr <span class=main>(</span>update_matchF_step <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>nt</span><span class=main>)</span> <span class=free>aux</span> <span class=free>base</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> length <span class=free>aux</span> <span class=main>+</span> length <span class=main>(</span>fst <span class=free>base</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>aux</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>base</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def length_update_matchF_step<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> length_update_matchF<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=main>(</span>update_matchF <span class=free>n</span> <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>rels</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=free>aux</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> update_matchF_def update_matchF_base_def length_foldr_update_matchF_step
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_update_matchF_base_invar<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>LPDs <span class=free>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtables<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>j</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_matchF_invar <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span>update_matchF_base <span class=free>n</span> <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>rels</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=free>j</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> from_mregex<span class=main>:</span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> safe mr <span class=keyword1><span class=command>using</span></span> from_mregex_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ms</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=free>r</span>"</span></span>
      <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=skolem>ms</span>"</span></span> <span class=quoted><span class=quoted>"LPD <span class=skolem>ms</span> <span class=main>⊆</span> LPDs <span class=free>mr</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> safe LPDs_safe LPDs_safe_fv_regex mr from_mregex_to_mregex LPDs_ok to_mregex_ok LPDs_trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>note</span></span> * <span class=main>=</span> this
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_matchF_invar_def wf_matchF_aux_def update_matchF_base_def mr prod.case Let_def mrs
    <span class=keyword1><span class=command>using</span></span> safe
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> * from_mregex qtables qtable_empty_iff zero_enat_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span>
        lookup_tabulate finite_LPDs eps_match less_Suc_eq LPDs_refl
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_lε_strict<span class=main><span class=main><span class=main>[</span></span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> φs<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=free>φs</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> qtables exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>j</span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> Un_empty_table<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>rel</span> <span class=main>∪</span> empty_table <span class=main>=</span> <span class=free>rel</span>"</span></span> <span class=quoted><span class=quoted>"empty_table <span class=main>∪</span> <span class=free>rel</span> <span class=main>=</span> <span class=free>rel</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> empty_table_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> wf_matchF_invar_step<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> wf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_invar <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>st</span> <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>LPDs <span class=free>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtables<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> rel<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>Formula.fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=free>i</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free>i</span> <span class=main>+</span> length <span class=main>(</span>fst <span class=free>st</span><span class=main>)</span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=free>i</span><span class=main>)</span> <span class=free>I</span> <span class=main>∧</span>
          Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>r</span> <span class=free>i</span> <span class=bound>j</span><span class=main>)</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> entry<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>entry</span> <span class=main>=</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>i</span><span class=main>,</span> <span class=free>rels</span><span class=main>,</span> <span class=free>rel</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> length <span class=main>(</span>fst <span class=free>st</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_matchF_invar <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span>update_matchF_step <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>nt</span> <span class=free>entry</span> <span class=free>st</span><span class=main>)</span> <span class=free>i</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> from_mregex<span class=main>:</span> <span class=quoted><span class=quoted>"from_mregex <span class=free>mr</span> <span class=free>φs</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> safe mr <span class=keyword1><span class=command>using</span></span> from_mregex_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ms</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fv_regex <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=main>=</span> fv_regex <span class=free>r</span>"</span></span>
      <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"ok <span class=main>(</span>length <span class=free>φs</span><span class=main>)</span> <span class=skolem>ms</span>"</span></span> <span class=quoted><span class=quoted>"LPD <span class=skolem>ms</span> <span class=main>⊆</span> LPDs <span class=free>mr</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> safe LPDs_safe LPDs_safe_fv_regex mr from_mregex_to_mregex LPDs_ok to_mregex_ok LPDs_trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>note</span></span> * <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>aux</span> <span class=skolem>X</span> <span class=skolem>ms</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>st</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>aux</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> wf mr <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=main>(</span>fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>from_mregex <span class=skolem>ms</span> <span class=free>φs</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> length <span class=skolem>aux</span><span class=main>)</span><span class=main>)</span>
      <span class=main>(</span>lδ <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>)</span> <span class=skolem>X</span> <span class=free>rels</span> <span class=skolem>ms</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> qtable_lδ<span class=main><span class=main><span class=main>[</span></span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> φs<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=free>φs</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span></span> A<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=quoted>"fv_regex <span class=free>r</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span></span>
              Q<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span> <span class=bound>r</span><span class=main>.</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=bound>v</span><span class=main>)</span> <span class=bound>r</span> <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span> <span class=main>(</span><span class=free>i</span> <span class=main>+</span> length <span class=skolem>aux</span><span class=main>)</span>"</span></span><span class=main><span class=main><span class=main>,</span></span></span> <span class=operator>OF</span> _ _ qtables<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_matchF_invar_def * LPDs_trans lpd_match<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>i</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bspec<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>note</span></span> lδ <span class=main>=</span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"lookup <span class=main>(</span>mrtabulate <span class=free>mrs</span> <span class=skolem>f</span><span class=main>)</span> <span class=skolem>ms</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>ms</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ms</span> <span class=main>∈</span> LPDs <span class=free>mr</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ms</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>f</span> <span class=main>::</span> <span class=quoted><span class=quoted>"mregex <span class=main>⇒</span> <span class=tfree>'a</span> table"</span></span>
    <span class=keyword1><span class=command>using</span></span> that mrs  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lookup_tabulate finite_LPDs <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> wf mr mrs entry nt LPDs_trans
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def wf_matchF_invar_def update_matchF_step_def wf_matchF_aux_def mr * LPDs_refl
        list_all2_Cons1 append_eq_Cons_conv upt_eq_Cons_conv Suc_le_eq qtables
        lookup_tabulate finite_LPDs id_def lδ from_mregex less_Suc_eq
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_union<span class=main><span class=main>[</span></span><span class=operator>OF</span> rel lδ<span class=main><span class=main>]</span></span> qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> rel<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>+</span> length <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> wf_update_matchF_invar<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>aux</span> <span class=free>ne</span> <span class=main>(</span>length <span class=main>(</span>fst <span class=free>st</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> wf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_invar <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>st</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>aux</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>LPDs <span class=free>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> j<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>=</span> <span class=free>ne</span> <span class=main>+</span> length <span class=free>aux</span> <span class=main>+</span> length <span class=main>(</span>fst <span class=free>st</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_matchF_invar <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span>foldr <span class=main>(</span>update_matchF_step <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=free>aux</span> <span class=free>st</span><span class=main>)</span> <span class=free>ne</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pre wf <span class=keyword1><span class=command>unfolding</span></span> j
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>aux</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ne</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>entry</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Cons<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Suc <span class=skolem>ne</span>"</span></span><span class=main>]</span> Cons<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> foldr.simps o_apply
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> wf_matchF_invar_step<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> rels <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>snd <span class=skolem>entry</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> rel <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>snd <span class=skolem>entry</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> safe mr mrs wf_matchF_aux_def wf_matchF_invar_def list_all2_Cons1 append_eq_Cons_conv
        Suc_le_eq upt_eq_Cons_conv length_foldr_update_matchF_step add.assoc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>lemma</span></span> wf_update_matchF<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>aux</span> <span class=free>ne</span> <span class=main>0</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>LPDs <span class=free>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>aux</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> qtables<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>rel</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>aux</span><span class=main>)</span> <span class=bound>φ</span><span class=main>)</span> <span class=bound>rel</span><span class=main>)</span> <span class=free>φs</span> <span class=free>rels</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span>update_matchF <span class=free>n</span> <span class=free>I</span> <span class=free>mr</span> <span class=free>mrs</span> <span class=free>rels</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> update_matchF_def <span class=keyword1><span class=command>using</span></span> wf_update_matchF_base_invar<span class=main>[</span><span class=operator>OF</span> safe mr mrs qtables<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>I</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>unfolding</span></span> nt
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> wf_update_matchF_invar<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ safe mr mrs<span class=main><span class=main>,</span></span> <span class=operator>unfolded</span> wf_matchF_invar_def split_beta<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> conjunct2<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> conjunct1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> length_update_matchF_base wf_matchF_invar_def update_matchF_base_def Let_def pre<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_until_aux_Cons<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=main>⟹</span>
  wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=free>aux</span> <span class=main>(</span>Suc <span class=free>ne</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_until_auxlist_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upt_conv_Cons <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> if_cong<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_matchF_aux_Cons<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span><span class=free>entry</span> <span class=main>#</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=free>i</span> <span class=main>⟹</span>
  wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=free>aux</span> <span class=main>(</span>Suc <span class=free>ne</span><span class=main>)</span> <span class=free>i</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_matchF_aux_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upt_conv_Cons <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span> if_cong <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_until_aux_Cons1<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=main>(</span><span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>a1</span><span class=main>,</span> <span class=free>a2</span><span class=main>)</span> <span class=main>#</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=main>⟹</span> <span class=free>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_until_auxlist_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upt_conv_Cons <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_matchF_aux_Cons1<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span><span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>rels</span><span class=main>,</span> <span class=free>rel</span><span class=main>)</span> <span class=main>#</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=free>i</span> <span class=main>⟹</span> <span class=free>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=free>ne</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_matchF_aux_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upt_conv_Cons <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_until_aux_Cons3<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>pos</span> <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span> <span class=main>(</span><span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>a1</span><span class=main>,</span> <span class=free>a2</span><span class=main>)</span> <span class=main>#</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=main>⟹</span>
  qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=free>ne</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> Suc <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>aux</span><span class=main>)</span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=free>I</span> <span class=main>∧</span>
    Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>j</span> <span class=free>ψ</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=free>ne</span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>}</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>pos</span> <span class=keyword1>then</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span> <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>a2</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_until_auxlist_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upt_conv_Cons <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_matchF_aux_Cons3<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>I</span> <span class=free>r</span> <span class=main>(</span><span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>rels</span><span class=main>,</span> <span class=free>rel</span><span class=main>)</span> <span class=main>#</span> <span class=free>aux</span><span class=main>)</span> <span class=free>ne</span> <span class=free>i</span> <span class=main>⟹</span>
  qtable <span class=free>n</span> <span class=main>(</span>Formula.fv_regex <span class=free>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=free>ne</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> Suc <span class=main>(</span><span class=free>ne</span> <span class=main>+</span> length <span class=free>aux</span> <span class=main>+</span> <span class=free>i</span><span class=main>)</span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=free>ne</span><span class=main>)</span> <span class=free>I</span> <span class=main>∧</span>
    Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=free>r</span> <span class=free>ne</span> <span class=bound>j</span><span class=main>)</span><span class=main>)</span> <span class=free>rel</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_matchF_aux_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upt_conv_Cons <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upt_append<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>≤</span> <span class=free>b</span> <span class=main>⟹</span> <span class=free>b</span> <span class=main>≤</span> <span class=free>c</span> <span class=main>⟹</span> <span class=main>[</span><span class=free>a</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>]</span> <span class=main>@</span> <span class=main>[</span><span class=free>b</span><span class=main>..&lt;</span><span class=free>c</span><span class=main>]</span> <span class=main>=</span> <span class=main>[</span><span class=free>a</span><span class=main>..&lt;</span><span class=free>c</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> le_Suc_ex upt_add_eq_append<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbuf2_add<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=free>i</span> <span class=free>ja</span> <span class=free>jb</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>ja</span><span class=main>..&lt;</span><span class=free>ja'</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>Q</span> <span class=main>[</span><span class=free>jb</span><span class=main>..&lt;</span><span class=free>jb'</span><span class=main>]</span> <span class=free>ys</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>ja</span> <span class=main>≤</span> <span class=free>ja'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>jb</span> <span class=main>≤</span> <span class=free>jb'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=free>i</span> <span class=free>ja'</span> <span class=free>jb'</span> <span class=free>P</span> <span class=free>Q</span> <span class=main>(</span>mbuf2_add <span class=free>xs</span> <span class=free>ys</span> <span class=free>buf</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_append2 upt_append <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD
      <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>ja</span><span class=main>]</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>ja</span><span class=main>..&lt;</span><span class=free>ja'</span><span class=main>]</span>"</span></span><span class=main><span class=main>]</span></span>
      exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>jb</span><span class=main>]</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>jb</span><span class=main>..&lt;</span><span class=free>jb'</span><span class=main>]</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbufn_add<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all3 list_all2 <span class=free>Ps</span> <span class=main>(</span>List.map2 <span class=main>(</span><span class=main>λ</span><span class=bound>j</span> <span class=bound>j'</span><span class=main>.</span> <span class=main>[</span><span class=bound>j</span><span class=main>..&lt;</span><span class=bound>j'</span><span class=main>]</span><span class=main>)</span> <span class=free>js</span> <span class=free>js'</span><span class=main>)</span> <span class=free>xss</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(≤)</span> <span class=free>js</span> <span class=free>js'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js'</span> <span class=free>Ps</span> <span class=main>(</span>mbufn_add <span class=free>xss</span> <span class=free>buf</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth
<span class=keyword1><span class=command>proof</span></span> <span class=operator>safe</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"length <span class=free>Ps</span> <span class=main>=</span> length <span class=free>js'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>js'</span> <span class=main>=</span> length <span class=main>(</span>mbufn_add <span class=free>xss</span> <span class=free>buf</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth list_all2_conv_all_nth <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>k</span> <span class=keyword3><span class=command>assume</span></span> k<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> length <span class=free>Ps</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>≤</span> <span class=free>js'</span> <span class=main>!</span> <span class=skolem>k</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth list_all2_conv_all_nth
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>i</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> k <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>js'</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>]</span> <span class=main>=</span>  <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>js</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>]</span> <span class=main>@</span> <span class=main>[</span><span class=free>js</span> <span class=main>!</span> <span class=skolem>k</span> <span class=main>..&lt;</span><span class=free>js'</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"length <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>js</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>]</span> <span class=main>=</span> length <span class=main>(</span><span class=free>buf</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth list_all2_conv_all_nth
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> upt_append<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> k <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=free>Ps</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>)</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>js'</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>]</span> <span class=main>(</span>mbufn_add <span class=free>xss</span> <span class=free>buf</span> <span class=main>!</span> <span class=skolem>k</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>[</span><span class=operator>unfolded</span> wf_mbufn_def list_all3_conv_all_nth<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_append<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mbuf2_take_eqD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbuf2_take <span class=free>f</span> <span class=free>buf</span> <span class=main>=</span> <span class=main>(</span><span class=free>xs</span><span class=main>,</span> <span class=free>buf'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=free>i</span> <span class=free>ja</span> <span class=free>jb</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>buf</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=main>(</span>min <span class=free>ja</span> <span class=free>jb</span><span class=main>)</span> <span class=free>ja</span> <span class=free>jb</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>buf'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>P</span> <span class=bound>i</span> <span class=bound>x</span> <span class=main>∧</span> <span class=free>Q</span> <span class=bound>i</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span>min <span class=free>ja</span> <span class=free>jb</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbuf2_take.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv min_absorb1 min_absorb2 <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_Nil<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=main>[]</span> <span class=main>⟷</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>∧</span> <span class=free>ys</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=main>[]</span> <span class=free>zs</span> <span class=main>⟷</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>∧</span> <span class=free>zs</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=main>[]</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟷</span> <span class=free>ys</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>∧</span> <span class=free>zs</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> list_all3_conv_all_nth <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_Cons<span class=main>:</span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=main>(</span><span class=free>z</span> <span class=main>#</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>xs'</span> <span class=bound>y</span> <span class=bound>ys'</span><span class=main>.</span> <span class=free>xs</span> <span class=main>=</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>xs'</span> <span class=main>∧</span> <span class=free>ys</span> <span class=main>=</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>ys'</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=free>z</span> <span class=main>∧</span> list_all3 <span class=free>P</span> <span class=bound>xs'</span> <span class=bound>ys'</span> <span class=free>zs</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=main>(</span><span class=free>y</span> <span class=main>#</span> <span class=free>ys</span><span class=main>)</span> <span class=free>zs</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>xs'</span> <span class=bound>z</span> <span class=bound>zs'</span><span class=main>.</span> <span class=free>xs</span> <span class=main>=</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>xs'</span> <span class=main>∧</span> <span class=free>zs</span> <span class=main>=</span> <span class=bound>z</span> <span class=main>#</span> <span class=bound>zs'</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=free>y</span> <span class=bound>z</span> <span class=main>∧</span> list_all3 <span class=free>P</span> <span class=bound>xs'</span> <span class=free>ys</span> <span class=bound>zs'</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=main>(</span><span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span> <span class=bound>ys'</span> <span class=bound>z</span> <span class=bound>zs'</span><span class=main>.</span> <span class=free>ys</span> <span class=main>=</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>ys'</span> <span class=main>∧</span> <span class=free>zs</span> <span class=main>=</span> <span class=bound>z</span> <span class=main>#</span> <span class=bound>zs'</span> <span class=main>∧</span> <span class=free>P</span> <span class=free>x</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>∧</span> list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=bound>ys'</span> <span class=bound>zs'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> list_all3_conv_all_nth
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> length_Suc_conv Suc_length_conv nth_Cons <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> nat.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_mono_strong<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=free>ys</span> <span class=main>⟹</span> <span class=bound>z</span> <span class=main>∈</span> set <span class=free>zs</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span>
  list_all3 <span class=free>Q</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_all3.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all3.intros<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>Mini</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Mini</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>js</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>js</span></span></span> <span class=main>=</span> <span class=main>[]</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=keyword1>else</span> Min <span class=main>(</span>set <span class=free><span class=bound><span class=entity>js</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbufn_in_set_Mini<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> set <span class=free>buf</span> <span class=main>⟹</span> Mini <span class=free>i</span> <span class=free>js</span> <span class=main>=</span> <span class=free>i</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> in_set_conv_nth
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>elim</span> exE conjE<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>k</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>≤</span> <span class=skolem>j</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>∈</span> set <span class=free>js</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>j</span>
    <span class=keyword1><span class=command>using</span></span> that assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth in_set_conv_nth <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> length <span class=free>buf</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>buf</span> <span class=main>!</span> <span class=skolem>k</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>unfolding</span></span> Mini_def wf_mbufn_def list_all3_conv_all_nth
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>k</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Min_eqI <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbufn_notin_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∉</span> set <span class=free>buf</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>∈</span> set <span class=free>js</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>&lt;</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> set <span class=free>js</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> le_neq_implies_less <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbufn_map_tl<span class=main>:</span>
  <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span> <span class=main>⟹</span> <span class=main>[]</span> <span class=main>∉</span> set <span class=free>buf</span> <span class=main>⟹</span> wf_mbufn <span class=main>(</span>Suc <span class=free>i</span><span class=main>)</span> <span class=free>js</span> <span class=free>Ps</span> <span class=main>(</span>map tl <span class=free>buf</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_mbufn_def list_all3_map Suc_le_eq
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> rel_funD<span class=main><span class=main>[</span></span><span class=operator>OF</span> tl_transfer<span class=main><span class=main>]</span></span>  <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all3_mono_strong le_neq_implies_less<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_list_all2I<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=free>Q</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=free>xs</span> <span class=free>ys</span> <span class=free>zs</span> <span class=main>⟹</span> list_all2 <span class=free>Q</span> <span class=free>xs</span> <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quoted><span class=free>zs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_all3.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> mbuf2t_take_eqD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbuf2t_take <span class=free>f</span> <span class=free>z</span> <span class=free>buf</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=free>i</span> <span class=free>ja</span> <span class=free>jb</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>ja</span> <span class=main>≤</span> <span class=free>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>jb</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=main>(</span>min <span class=free>ja</span> <span class=free>jb</span><span class=main>)</span> <span class=free>ja</span> <span class=free>jb</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>buf'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span>min <span class=free>ja</span> <span class=free>jb</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>nts'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quoted><span class=free>nts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>z'</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quoted><span class=free>nts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbuf2t_take.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_mbufn_take<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbufn_take <span class=free>f</span> <span class=free>z</span> <span class=free>buf</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=main>(</span>Mini <span class=free>i</span> <span class=free>js</span><span class=main>)</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>z'</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbufn_take.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> rec<span class=main>:</span> <span class=main>(</span>1 <span class=skolem>f</span> <span class=skolem>z</span> <span class=skolem>buf</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>buf</span> <span class=main>=</span> <span class=main>[]</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> rec.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> nonempty<span class=main>:</span> False
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> set <span class=skolem>buf</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>from</span></span> rec.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>j</span><span class=main>∈</span>set <span class=free>js</span><span class=main>.</span> <span class=skolem>i</span> <span class=main>≤</span> <span class=bound>j</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth list_all3_conv_all_nth<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> True rec.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> set <span class=free>js</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth list_all3_conv_all_nth list_all2_iff<span class=main>)</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mini <span class=skolem>i</span> <span class=free>js</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> Mini_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> antisym<span class=main><span class=main>[</span></span><span class=operator>OF</span> Min.coboundedI Min.boundedI<span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> rec.prems nonempty True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>from</span></span> nonempty rec.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mini <span class=skolem>i</span> <span class=free>js</span> <span class=main>=</span> Mini <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=free>js</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> Mini_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹Mini <span class=skolem>i</span> <span class=free>js</span> <span class=main>=</span> Mini <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=free>js</span>›</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> rec.IH<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>(</span><span class=skolem>buf</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>∨</span> <span class=main>[]</span> <span class=main>∈</span> set <span class=skolem>buf</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nonempty False <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>P</span> <span class=bound>j</span> <span class=bound>xs</span><span class=main>.</span> Suc <span class=skolem>i</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> list_all2 <span class=bound>P</span> <span class=main>[</span>Suc <span class=skolem>i</span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>]</span> <span class=bound>xs</span><span class=main>)</span> <span class=free>Ps</span> <span class=free>js</span> <span class=main>(</span>map tl <span class=skolem>buf</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> False rec.prems<span class=main>(</span>2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_map <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all3_mono_strong <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list.rel_sel<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"mbufn_take <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span>map hd <span class=skolem>buf</span><span class=main>)</span> <span class=skolem>z</span><span class=main>)</span> <span class=main>(</span>map tl <span class=skolem>buf</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>z'</span><span class=main>,</span> <span class=skolem>buf'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> nonempty False rec.prems<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mbufnt_take_eqD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbufnt_take <span class=free>f</span> <span class=free>z</span> <span class=free>buf</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span> <span class=main>∈</span> set <span class=free>js</span> <span class=main>⟹</span> <span class=bound>k</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>=</span> Mini <span class=main>(</span><span class=free>i</span> <span class=main>+</span> length <span class=free>nts</span><span class=main>)</span> <span class=free>js</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>k</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span><span class=free>k</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>nts'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1-4<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> assms<span class=main>(</span>5<span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quoted><span class=free>nts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>z'</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quoted><span class=free>nts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbufnt_take.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> IH<span class=main>:</span> <span class=main>(</span>1 <span class=skolem>f</span> <span class=skolem>z</span> <span class=skolem>buf</span> <span class=skolem>nts</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> mbufnt_take.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>
  <span class=keyword3><span class=command>case</span></span> 1
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span>Suc <span class=skolem>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=main>(</span>tl <span class=skolem>nts</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_sel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span>"</span></span> <span class=quoted><span class=skolem>nts</span></span><span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> wf_mbufn_in_set_Mini<span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> mbufnt_take.simps<span class=main>)</span>
      <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Mini_def wf_mbufn_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all3_mono_strong
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> IH<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ wf_mbufn_map_tl<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> 1<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> *<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 2
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span>Suc <span class=skolem>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=main>(</span>tl <span class=skolem>nts</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_sel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span>"</span></span> <span class=quoted><span class=skolem>nts</span></span><span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"Suc <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> <span class=main>(</span>length <span class=skolem>nts</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>nts</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nts</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> length_greater_0_conv<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> 2 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> wf_mbufn_in_set_Mini<span class=main>[</span><span class=operator>OF</span> 2<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> wf_mbufn_notin_set<span class=main>[</span><span class=operator>OF</span> 2<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> mbufnt_take.simps<span class=main>)</span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Mini_def wf_mbufn_def
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> IH<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ wf_mbufn_map_tl<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> 2<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> *<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mbuf2t_take_induct<span class=main>[</span><span class=operator>consumes</span> 5<span class=main>,</span> <span class=operator>case_names</span> base step<span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbuf2t_take <span class=free>f</span> <span class=free>z</span> <span class=free>buf</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbuf2 <span class=free>i</span> <span class=free>ja</span> <span class=free>jb</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>ja</span> <span class=main>≤</span> <span class=free>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>jb</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=free>i</span> <span class=free>z</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span> <span class=bound>x</span> <span class=bound>y</span> <span class=bound>t</span> <span class=bound>z</span><span class=main>.</span> <span class=free>i</span> <span class=main>≤</span> <span class=bound>k</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> <span class=free>ja</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> <span class=free>jb</span> <span class=main>⟹</span>
      <span class=free>P</span> <span class=bound>k</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>k</span> <span class=bound>y</span> <span class=main>⟹</span> <span class=free>R</span> <span class=bound>k</span> <span class=bound>t</span> <span class=main>⟹</span> <span class=free>U</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>U</span> <span class=main>(</span>Suc <span class=bound>k</span><span class=main>)</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span> <span class=bound>y</span> <span class=bound>t</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>min <span class=free>ja</span> <span class=free>jb</span><span class=main>)</span> <span class=free>z'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quoted><span class=free>nts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>z'</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quoted><span class=free>nts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbuf2t_take.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> arg_cong2<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>U</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ refl<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_hdD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>xs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free>i</span> <span class=main>(</span>hd <span class=free>xs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> list_all2_conv_all_nth
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> hd_conv_nth <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> zero_less_diff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mbufn_take_induct<span class=main>[</span><span class=operator>consumes</span> 3<span class=main>,</span> <span class=operator>case_names</span> base step<span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbufn_take <span class=free>f</span> <span class=free>z</span> <span class=free>buf</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=free>i</span> <span class=free>z</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span> <span class=bound>xs</span> <span class=bound>z</span><span class=main>.</span> <span class=free>i</span> <span class=main>≤</span> <span class=bound>k</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> Mini <span class=free>i</span> <span class=free>js</span> <span class=main>⟹</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>P</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>k</span> <span class=bound>x</span><span class=main>)</span> <span class=free>Ps</span> <span class=bound>xs</span> <span class=main>⟹</span> <span class=free>U</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>U</span> <span class=main>(</span>Suc <span class=bound>k</span><span class=main>)</span> <span class=main>(</span><span class=free>f</span> <span class=bound>xs</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>Mini <span class=free>i</span> <span class=free>js</span><span class=main>)</span> <span class=free>z'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>z'</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbufn_take.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> rec<span class=main>:</span> <span class=main>(</span>1 <span class=skolem>f</span> <span class=skolem>z</span> <span class=skolem>buf</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>buf</span> <span class=main>=</span> <span class=main>[]</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> rec.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> Mini_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> nonempty<span class=main>:</span> False
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> set <span class=skolem>buf</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>from</span></span> rec.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>j</span><span class=main>∈</span>set <span class=free>js</span><span class=main>.</span> <span class=skolem>i</span> <span class=main>≤</span> <span class=bound>j</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth list_all3_conv_all_nth<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> True rec.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> set <span class=free>js</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth list_all3_conv_all_nth list_all2_iff<span class=main>)</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mini <span class=skolem>i</span> <span class=free>js</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> Mini_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> antisym<span class=main><span class=main>[</span></span><span class=operator>OF</span> Min.coboundedI Min.boundedI<span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> rec.prems nonempty True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> nonempty rec.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> more<span class=main>:</span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>≤</span> Mini <span class=skolem>i</span> <span class=free>js</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> diff_is_0_eq not_le <span class=keyword1><span class=command>unfolding</span></span> Mini_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth list_all3_conv_all_nth list_all2_iff<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mini <span class=skolem>i</span> <span class=free>js</span> <span class=main>=</span> Mini <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=free>js</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> Mini_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹Mini <span class=skolem>i</span> <span class=free>js</span> <span class=main>=</span> Mini <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=free>js</span>›</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> rec.IH<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>(</span><span class=skolem>buf</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>∨</span> <span class=main>[]</span> <span class=main>∈</span> set <span class=skolem>buf</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nonempty False <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"mbufn_take <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span>map hd <span class=skolem>buf</span><span class=main>)</span> <span class=skolem>z</span><span class=main>)</span> <span class=main>(</span>map tl <span class=skolem>buf</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>z'</span><span class=main>,</span> <span class=skolem>buf'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> nonempty False rec.prems <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>P</span> <span class=bound>j</span> <span class=bound>xs</span><span class=main>.</span> Suc <span class=skolem>i</span> <span class=main>≤</span> <span class=bound>j</span> <span class=main>∧</span> list_all2 <span class=bound>P</span> <span class=main>[</span>Suc <span class=skolem>i</span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>]</span> <span class=bound>xs</span><span class=main>)</span> <span class=free>Ps</span> <span class=free>js</span> <span class=main>(</span>map tl <span class=skolem>buf</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> False rec.prems
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_map <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all3_mono_strong <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list.rel_sel<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span>map hd <span class=skolem>buf</span><span class=main>)</span> <span class=skolem>z</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> more False rec.prems
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_map <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> rec.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> list_all3_list_all2I
              <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all3_mono_strong <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list.rel_sel<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span> <span class=bound>xs</span> <span class=bound>z</span><span class=main>.</span> Suc <span class=skolem>i</span> <span class=main>≤</span> <span class=bound>k</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> Mini <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=free>js</span> <span class=main>⟹</span>
          list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>P</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>k</span><span class=main>)</span> <span class=free>Ps</span> <span class=bound>xs</span> <span class=main>⟹</span> <span class=free>U</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>U</span> <span class=main>(</span>Suc <span class=bound>k</span><span class=main>)</span> <span class=main>(</span><span class=skolem>f</span> <span class=bound>xs</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> rec.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Mini_def<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mbufnt_take_induct<span class=main>[</span><span class=operator>consumes</span> 5<span class=main>,</span> <span class=operator>case_names</span> base step<span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"mbufnt_take <span class=free>f</span> <span class=free>z</span> <span class=free>buf</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_mbufn <span class=free>i</span> <span class=free>js</span> <span class=free>Ps</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span><span class=free>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span> <span class=main>∈</span> set <span class=free>js</span> <span class=main>⟹</span> <span class=bound>k</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=free>i</span> <span class=free>z</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span> <span class=bound>xs</span> <span class=bound>t</span> <span class=bound>z</span><span class=main>.</span> <span class=free>i</span> <span class=main>≤</span> <span class=bound>k</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> Mini <span class=free>j</span> <span class=free>js</span> <span class=main>⟹</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>P</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>k</span> <span class=bound>x</span><span class=main>)</span> <span class=free>Ps</span> <span class=bound>xs</span> <span class=main>⟹</span> <span class=free>R</span> <span class=bound>k</span> <span class=bound>t</span> <span class=main>⟹</span> <span class=free>U</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>U</span> <span class=main>(</span>Suc <span class=bound>k</span><span class=main>)</span> <span class=main>(</span><span class=free>f</span> <span class=bound>xs</span> <span class=bound>t</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>Mini <span class=main>(</span><span class=free>i</span> <span class=main>+</span> length <span class=free>nts</span><span class=main>)</span> <span class=free>js</span><span class=main>)</span> <span class=free>z'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>buf</span></span> <span class=quoted><span class=free>nts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>z'</span></span> <span class=quoted><span class=free>buf'</span></span> <span class=quoted><span class=free>nts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> mbufnt_take.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>f</span> <span class=skolem>z</span> <span class=skolem>buf</span> <span class=skolem>nts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=free>R</span> <span class=main>[</span>Suc <span class=skolem>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span> <span class=main>(</span>tl <span class=skolem>nts</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_sel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>i</span><span class=main>..&lt;</span><span class=free>j</span><span class=main>]</span>"</span></span> <span class=quoted><span class=skolem>nts</span></span><span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> mbufnt_take.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> 1<span class=main>(</span>2-6<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>=</span> Min <span class=main>(</span>set <span class=free>js</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>js</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nts</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def <span class=keyword1><span class=command>using</span></span> wf_mbufn_in_set_Mini<span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Mini_def list_all3_Cons neq_Nil_conv<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> 1<span class=main>(</span>2-7<span class=main>)</span> list_all2_hdD<span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main><span class=main>(</span></span></span>4<span class=main><span class=main><span class=main>)</span></span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn_def <span class=keyword1><span class=command>using</span></span> wf_mbufn_in_set_Mini<span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>]</span> wf_mbufn_notin_set<span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> mbufnt_take.simps<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mini_def list.rel_map Suc_le_eq
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> arg_cong2<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>U</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ refl<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span>
        list_all3_mono_strong<span class=main><span class=main>[</span></span><span class=operator>THEN</span> list_all3_list_all2I<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>of</span> <span class=main><span class=main><span class=main>_</span></span></span> <span class=main><span class=main><span class=main>_</span></span></span> <span class=quoted><span class=free>js</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span> list_all2_hdD
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ wf_mbufn_map_tl<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> 1<span class=main><span class=main><span class=main>(</span></span></span>3<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> * _ 1<span class=main><span class=main><span class=main>(</span></span></span>7<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split if_splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> mbuf2_take_add'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbuf2_take <span class=free>f</span> <span class=main>(</span>mbuf2_add <span class=free>xs</span> <span class=free>ys</span> <span class=free>buf</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>zs</span><span class=main>,</span> <span class=free>buf'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=free>j</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> rm<span class=main>:</span> <span class=quoted><span class=quoted>"rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> xs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ys<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>ψ</span> <span class=free>j'</span><span class=main>]</span> <span class=free>ys</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>j'</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>buf'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>Z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>X</span> <span class=bound>Y</span><span class=main>.</span>
      qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span> <span class=bound>X</span> <span class=main>∧</span>
      qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>ψ</span><span class=main>)</span> <span class=bound>Y</span> <span class=main>∧</span>
      <span class=bound>Z</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>X</span> <span class=bound>Y</span><span class=main>)</span>
      <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span><span class=main>..&lt;</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>ψ</span> <span class=free>j'</span><span class=main>)</span><span class=main>]</span> <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pre rm <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2'_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mbuf2_take_eqD<span class=main><span class=main>[</span></span><span class=operator>OF</span> eq<span class=main><span class=main>]</span></span> wf_mbuf2_add<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ xs ys<span class=main><span class=main>]</span></span> progress_mono_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span> rm<span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> mbuf2t_take_add'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbuf2t_take <span class=free>f</span> <span class=free>z</span> <span class=main>(</span>mbuf2_add <span class=free>xs</span> <span class=free>ys</span> <span class=free>buf</span><span class=main>)</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> bounded<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j'</span><span class=main>)</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> rm<span class=main>:</span> <span class=quoted><span class=quoted>"rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=free>j</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_nts<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> xs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ys<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>ψ</span> <span class=free>j'</span><span class=main>]</span> <span class=free>ys</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>j'</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>buf'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_ts <span class=free>σ</span> <span class=free>P'</span> <span class=free>j'</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>nts'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pre_buf pre_nts bounded rm <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2'_def wf_ts_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mbuf2t_take_eqD<span class=main><span class=main>[</span></span><span class=operator>OF</span> eq<span class=main><span class=main>]</span></span> wf_mbuf2_add<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ xs ys<span class=main><span class=main>]</span></span> progress_mono_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span> rm<span class=main><span class=main>]</span></span>
      progress_le_gen<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ok_0_atms<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=main>0</span> <span class=free>mr</span> <span class=main>⟹</span> regex.atms <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>mr</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> ok_0_progress<span class=main>:</span> <span class=quoted><span class=quoted>"ok <span class=main>0</span> <span class=free>mr</span> <span class=main>⟹</span> progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=main>(</span>from_mregex <span class=free>mr</span> <span class=main>[]</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>drule</span> ok_0_atms<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_regex_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> atms_empty_atms<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> atms <span class=free>r</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>⟷</span> regex.atms <span class=free>r</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>r</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_regex_induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> cases_Neg_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> atms_empty_progress<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> atms <span class=free>r</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>⟹</span> progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>=</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>drule</span> atms_empty_atms<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_regex_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_empty_progress<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>⟹</span>
  progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>=</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> from_mregex_eq ok_0_progress to_mregex_ok atms_empty_atms <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>

<span class=keyword1><span class=command>lemma</span></span> progress_regex_le<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span> <span class=main>⟹</span> progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> progress_le_gen <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Min_le_iff progress_regex_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Neg_acyclic<span class=main>:</span> <span class=quoted><span class=quoted>"formula.Neg <span class=free>x</span> <span class=main>=</span> <span class=free>x</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>x</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> case_Neg_in_iff<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>y</span> <span class=keyword1>of</span> formula.Neg <span class=bound>φ'</span> <span class=main>⇒</span> <span class=main>{</span><span class=bound>φ'</span><span class=main>}</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=main>{}</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> formula.Neg <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>y</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> atms_nonempty_progress<span class=main>:</span>
  <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> atms <span class=free>r</span> <span class=main>≠</span> <span class=main>{}</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>`</span> atms <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>`</span> regex.atms <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>frule</span> atms_empty_atms<span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atms_def image_iff case_Neg_in_iff <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> disjE_Not2 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_regex_safe_formula<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_nonempty_progress<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φs</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span>
  progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>MIN</span> <span class=bound>φ</span><span class=main>∈</span>set <span class=free>φs</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> atms_nonempty_progress to_mregex_ok <span class=keyword1><span class=command>unfolding</span></span> progress_regex_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>

<span class=keyword1><span class=command>lemma</span></span> to_mregex_progress<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span> <span class=main>⟹</span> to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span> <span class=main>⟹</span>
  progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>φs</span> <span class=main>=</span> <span class=main>[]</span> <span class=keyword1>then</span> <span class=free>j</span> <span class=keyword1>else</span> <span class=main>(</span><span class=keyword1>MIN</span> <span class=bound>φ</span><span class=main>∈</span>set <span class=free>φs</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> to_mregex_nonempty_progress to_mregex_empty_progress <span class=keyword1><span class=command>unfolding</span></span> progress_regex_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> mbufnt_take_add'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbufnt_take <span class=free>f</span> <span class=free>z</span> <span class=main>(</span>mbufn_add <span class=free>xss</span> <span class=free>buf</span><span class=main>)</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> bounded<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j'</span><span class=main>)</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> rm<span class=main>:</span> <span class=quoted><span class=quoted>"rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbufn' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=free>j</span> <span class=free>n</span> <span class=free>R</span> <span class=free>r</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_nts<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> xss<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 list_all2
     <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=bound>φ</span><span class=main>)</span><span class=main>)</span> <span class=free>φs</span><span class=main>)</span>
     <span class=main>(</span>map2 upt <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span> <span class=free>φs</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=bound>φ</span> <span class=free>j'</span><span class=main>)</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span> <span class=free>xss</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_mbufn' <span class=free>σ</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>j'</span> <span class=free>n</span> <span class=free>R</span> <span class=free>r</span> <span class=free>buf'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"wf_ts_regex <span class=free>σ</span> <span class=free>P'</span> <span class=free>j'</span> <span class=free>r</span> <span class=free>nts'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pre_buf pre_nts bounded rm mr safe xss <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span>  <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn'_def wf_ts_regex_def
  <span class=keyword1><span class=command>using</span></span> atms_empty_progress<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>r</span></span><span class=main>]</span> to_mregex_ok<span class=main>[</span><span class=operator>OF</span> mr<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map to_mregex_empty_progress to_mregex_nonempty_progress Mini_def
      <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> progress_mono_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span> rm<span class=main><span class=main>]</span></span> list.rel_refl_strong progress_le_gen
      <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mbufnt_take_eqD<span class=main><span class=main>[</span></span><span class=operator>OF</span> eq wf_mbufn_add<span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mbuf2t_take_add_induct'<span class=main>[</span><span class=operator>consumes</span> 6<span class=main>,</span> <span class=operator>case_names</span> base step<span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbuf2t_take <span class=free>f</span> <span class=free>z</span> <span class=main>(</span>mbuf2_add <span class=free>xs</span> <span class=free>ys</span> <span class=free>buf</span><span class=main>)</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> bounded<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j'</span><span class=main>)</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> rm<span class=main>:</span> <span class=quoted><span class=quoted>"rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=free>j</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>ψ</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_nts<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> xs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ys<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>ψ</span> <span class=free>j'</span><span class=main>]</span> <span class=free>ys</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> base<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=free>z</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> step<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span> <span class=bound>X</span> <span class=bound>Y</span> <span class=bound>z</span><span class=main>.</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>≤</span> <span class=bound>k</span> <span class=main>⟹</span>
      Suc <span class=bound>k</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>ψ</span> <span class=free>j'</span> <span class=main>⟹</span>
      qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>φ</span><span class=main>)</span> <span class=bound>X</span> <span class=main>⟹</span>
      qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=free>ψ</span><span class=main>)</span> <span class=bound>Y</span> <span class=main>⟹</span>
      <span class=free>U</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>U</span> <span class=main>(</span>Suc <span class=bound>k</span><span class=main>)</span> <span class=main>(</span><span class=free>f</span> <span class=bound>X</span> <span class=bound>Y</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>k</span><span class=main>)</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>j'</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>ψ</span> <span class=free>j'</span><span class=main>)</span><span class=main>)</span> <span class=free>z'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pre_buf pre_nts bounded rm <span class=keyword1><span class=command>unfolding</span></span> wf_mbuf2'_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mbuf2t_take_induct<span class=main><span class=main>[</span></span><span class=operator>OF</span> eq<span class=main><span class=main>]</span></span> wf_mbuf2_add<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ xs ys<span class=main><span class=main>]</span></span> progress_mono_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span> rm<span class=main><span class=main>]</span></span>
      progress_le_gen base step<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mbufnt_take_add_induct'<span class=main>[</span><span class=operator>consumes</span> 6<span class=main>,</span> <span class=operator>case_names</span> base step<span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbufnt_take <span class=free>f</span> <span class=free>z</span> <span class=main>(</span>mbufn_add <span class=free>xss</span> <span class=free>buf</span><span class=main>)</span> <span class=free>nts</span> <span class=main>=</span> <span class=main>(</span><span class=free>z'</span><span class=main>,</span> <span class=free>buf'</span><span class=main>,</span> <span class=free>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> bounded<span class=main>:</span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>j'</span><span class=main>)</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> rm<span class=main>:</span> <span class=quoted><span class=quoted>"rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex <span class=free>m</span> <span class=free>g</span> <span class=free>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>mr</span><span class=main>,</span> <span class=free>φs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbufn' <span class=free>σ</span> <span class=free>P</span> <span class=free>V</span> <span class=free>j</span> <span class=free>n</span> <span class=free>R</span> <span class=free>r</span> <span class=free>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pre_nts<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span><span class=main>..&lt;</span><span class=free>j'</span><span class=main>]</span> <span class=free>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> xss<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 list_all2
     <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span> <span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=bound>φ</span><span class=main>)</span><span class=main>)</span> <span class=free>φs</span><span class=main>)</span>
     <span class=main>(</span>map2 upt <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=bound>φ</span> <span class=free>j</span><span class=main>)</span> <span class=free>φs</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=bound>φ</span> <span class=free>j'</span><span class=main>)</span> <span class=free>φs</span><span class=main>)</span><span class=main>)</span> <span class=free>xss</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> base<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span><span class=main>)</span> <span class=free>z</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> step<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span> <span class=bound>Xs</span> <span class=bound>z</span><span class=main>.</span> progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>≤</span> <span class=bound>k</span> <span class=main>⟹</span> Suc <span class=bound>k</span> <span class=main>≤</span> progress_regex <span class=free>σ</span> <span class=free>P'</span> <span class=free>r</span> <span class=free>j'</span> <span class=main>⟹</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=bound>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=bound>φ</span><span class=main>)</span><span class=main>)</span> <span class=free>φs</span> <span class=bound>Xs</span> <span class=main>⟹</span>
      <span class=free>U</span> <span class=bound>k</span> <span class=bound>z</span> <span class=main>⟹</span> <span class=free>U</span> <span class=main>(</span>Suc <span class=bound>k</span><span class=main>)</span> <span class=main>(</span><span class=free>f</span> <span class=bound>Xs</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>k</span><span class=main>)</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>U</span> <span class=main>(</span>progress_regex <span class=free>σ</span> <span class=free>P'</span> <span class=free>r</span> <span class=free>j'</span><span class=main>)</span> <span class=free>z'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pre_buf pre_nts bounded rm <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span> to_mregex_progress<span class=main>[</span><span class=operator>OF</span> safe mr<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>P'</span></span> <span class=quoted><span class=free>j'</span></span><span class=main>]</span> to_mregex_empty_progress<span class=main>[</span><span class=operator>OF</span> safe<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>mr</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>j</span></span><span class=main>]</span> base
  <span class=keyword1><span class=command>unfolding</span></span> wf_mbufn'_def mr prod.case
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mbufnt_take_induct<span class=main><span class=main>[</span></span><span class=operator>OF</span> eq wf_mbufn_add<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> _ xss<span class=main><span class=main><span class=main>]</span></span></span> pre_nts<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=quoted><span class=free>U</span></span><span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map le_imp_diff_is_add <span class=dynamic><span class=dynamic>ac_simps</span></span> Mini_def
      <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> progress_mono_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span> <span class=main>≤</span> <span class=free>j'</span>›</span></span> rm<span class=main><span class=main>]</span></span> list.rel_refl_strong progress_le_gen
      <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> base step  <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_Until_le<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=free>P</span> <span class=main>(</span>Formula.Until <span class=free>φ</span> <span class=free>I</span> <span class=free>ψ</span><span class=main>)</span> <span class=free>j</span> <span class=main>≤</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>ψ</span> <span class=free>j</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> trans_le_add1 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_lower<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_MatchF_le<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=free>P</span> <span class=main>(</span>Formula.MatchF <span class=free>I</span> <span class=free>r</span><span class=main>)</span> <span class=free>j</span> <span class=main>≤</span> progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=free>I</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> trans_le_add1 progress_regex_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_lower<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_upt_Cons<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free>a</span> <span class=free>x</span> <span class=main>⟹</span> list_all2 <span class=free>P</span> <span class=main>[</span>Suc <span class=free>a</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>]</span> <span class=free>xs</span> <span class=main>⟹</span> Suc <span class=free>a</span> <span class=main>≤</span> <span class=free>b</span> <span class=main>⟹</span>
  list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>a</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>]</span> <span class=main>(</span><span class=free>x</span> <span class=main>#</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_upt_append<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>a</span><span class=main>..&lt;</span><span class=free>b</span><span class=main>]</span> <span class=free>xs</span> <span class=main>⟹</span> list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>b</span><span class=main>..&lt;</span><span class=free>c</span><span class=main>]</span> <span class=free>ys</span> <span class=main>⟹</span>
  <span class=free>a</span> <span class=main>≤</span> <span class=free>b</span> <span class=main>⟹</span> <span class=free>b</span> <span class=main>≤</span> <span class=free>c</span> <span class=main>⟹</span> list_all2 <span class=free>P</span> <span class=main>[</span><span class=free>a</span><span class=main>..&lt;</span><span class=free>c</span><span class=main>]</span> <span class=main>(</span><span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>a</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all3_list_all2_conv<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=free>R</span> <span class=free>xs</span> <span class=free>xs</span> <span class=free>ys</span> <span class=main>=</span> list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>x</span><span class=main>)</span> <span class=free>xs</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> map_split_map<span class=main>:</span> <span class=quoted><span class=quoted>"map_split <span class=free>f</span> <span class=main>(</span>map <span class=free>g</span> <span class=free>xs</span><span class=main>)</span> <span class=main>=</span> map_split <span class=main>(</span><span class=free>f</span> <span class=keyword1>o</span> <span class=free>g</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> map_split_alt<span class=main>:</span> <span class=quoted><span class=quoted>"map_split <span class=free>f</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>(</span>map <span class=main>(</span>fst <span class=keyword1>o</span> <span class=free>f</span><span class=main>)</span> <span class=free>xs</span><span class=main>,</span> map <span class=main>(</span>snd <span class=keyword1>o</span> <span class=free>f</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fv_formula_of_constraint<span class=main>:</span> <span class=quoted><span class=quoted>"fv <span class=main>(</span>formula_of_constraint <span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fv_trm <span class=free>t1</span> <span class=main>∪</span> fv_trm <span class=free>t2</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span>"</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> formula_of_constraint.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> wf_mformula_wf_set<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>φ'</span> <span class=main>⟹</span> wf_set <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_set_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>AndRel <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ</span> <span class=skolem>φ'</span> <span class=skolem>ψ'</span> <span class=skolem>conf</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fv_formula_of_constraint <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> subsetD<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Ands <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>l</span> <span class=skolem>l_pos</span> <span class=skolem>l_neg</span> <span class=skolem>l'</span> <span class=skolem>buf</span> <span class=skolem>A_pos</span> <span class=skolem>A_neg</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Ands.IH <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ'</span><span class=main>∈</span>set <span class=main>(</span><span class=skolem>l_pos</span> <span class=main>@</span> map remove_neg <span class=skolem>l_neg</span><span class=main>)</span><span class=main>.</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=bound>φ'</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth all_set_conv_all_nth<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>@</span> <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> set_append<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ'</span><span class=main>∈</span>set <span class=main>(</span><span class=skolem>l_pos</span> <span class=main>@</span> <span class=skolem>l_neg</span><span class=main>)</span><span class=main>.</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=bound>φ'</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> bspec<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"remove_neg <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Ands.hyps<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Agg <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>b</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ</span> <span class=skolem>φ'</span> <span class=skolem>y</span> <span class=skolem>f</span> <span class=skolem>g0</span> <span class=skolem>ω</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Formula.fvi_trm <span class=skolem>b</span> <span class=skolem>f</span> <span class=main>⊆</span> Formula.fvi <span class=skolem>b</span> <span class=skolem>φ'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_trm_iff_fv_trm<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>b</span></span><span class=main><span class=main>]</span></span> fvi_iff_fv<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Agg <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Un_absorb2 fvi_iff_fv<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> b<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>b</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchP <span class=skolem>r</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φs</span> <span class=skolem>mr</span> <span class=skolem>mrs</span> <span class=skolem>buf</span> <span class=skolem>nts</span> <span class=skolem>I</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φs'</span></span> <span class=keyword2><span class=keyword>where</span></span> conv<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=skolem>r</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>mr</span><span class=main>,</span> <span class=skolem>φs'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> MatchP <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ'</span><span class=main>∈</span>set <span class=skolem>φs'</span><span class=main>.</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=bound>φ'</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth all_set_conv_all_nth<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>φs'</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> conv <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> to_mregex_ok<span class=main><span class=main>[</span></span><span class=operator>THEN</span> conjunct1<span class=main><span class=main>]</span></span> fv_regex_alt<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹safe_regex <span class=main>_</span> <span class=main>_</span> <span class=skolem>r</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MatchF <span class=skolem>r</span>  <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φs</span> <span class=skolem>mr</span> <span class=skolem>mrs</span> <span class=skolem>buf</span> <span class=skolem>nts</span> <span class=skolem>I</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φs'</span></span> <span class=keyword2><span class=keyword>where</span></span> conv<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=skolem>r</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>mr</span><span class=main>,</span> <span class=skolem>φs'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> MatchF <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>φ'</span><span class=main>∈</span>set <span class=skolem>φs'</span><span class=main>.</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>fv <span class=bound>φ'</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth all_set_conv_all_nth<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>φs'</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> conv <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> to_mregex_ok<span class=main><span class=main>[</span></span><span class=operator>THEN</span> conjunct1<span class=main><span class=main>]</span></span> fv_regex_alt<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹safe_regex <span class=main>_</span> <span class=main>_</span> <span class=skolem>r</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fvi_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_mmulti_join<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> pos<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span> <span class=bound>X</span><span class=main>.</span> qtable <span class=free>n</span> <span class=bound>A</span> <span class=free>P</span> <span class=bound>Qi</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>Q_pos</span> <span class=free>L_pos</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> neg<span class=main>:</span> <span class=quoted><span class=quoted>"list_all3 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span> <span class=bound>X</span><span class=main>.</span> qtable <span class=free>n</span> <span class=bound>A</span> <span class=free>P</span> <span class=bound>Qi</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>Q_neg</span> <span class=free>L_neg</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> C_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>C</span> <span class=main>=</span> <span class=main>⋃</span><span class=main>(</span>set <span class=free>A_pos</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> L_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>L</span> <span class=main>=</span> <span class=free>L_pos</span> <span class=main>@</span> <span class=free>L_neg</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>A_pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> fv_subset<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋃</span><span class=main>(</span>set <span class=free>A_neg</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span><span class=main>(</span>set <span class=free>A_pos</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> restrict_pos<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> list_all <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_pos</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> restrict_neg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> list_all <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Qs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>x</span> <span class=main>⟷</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>Q_pos</span> <span class=main>∧</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=main>¬</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>Q_neg</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>C</span> <span class=free>P</span> <span class=free>Q</span> <span class=main>(</span>mmulti_join <span class=free>n</span> <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtableI<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> pos <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>L_pos</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth qtable_def<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> neg <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>L_neg</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth qtable_def<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> L<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>X</span><span class=main>.</span> table <span class=free>n</span> <span class=bound>A</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=free>n</span> <span class=bound>A</span><span class=main>)</span> <span class=main>(</span><span class=free>A_pos</span> <span class=main>@</span> <span class=free>A_neg</span><span class=main>)</span> <span class=main>(</span><span class=free>L_pos</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> list_all2_appendI<span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> in_join_iff <span class=main>=</span> mmulti_join_correct<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>A_pos</span> <span class=main>≠</span> <span class=main>[]</span>›</span></span> L<span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> 1 <span class=keyword1><span class=command>have</span></span> take_eq<span class=main>:</span> <span class=quoted><span class=quoted>"take <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=main>(</span><span class=free>L_pos</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span> <span class=main>=</span> <span class=free>L_pos</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> 1 <span class=keyword1><span class=command>have</span></span> drop_eq<span class=main>:</span> <span class=quoted><span class=quoted>"drop <span class=main>(</span>length <span class=free>A_pos</span><span class=main>)</span> <span class=main>(</span><span class=free>L_pos</span> <span class=main>@</span> <span class=free>L_neg</span><span class=main>)</span> <span class=main>=</span> <span class=free>L_neg</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>

  <span class=keyword1><span class=command>note</span></span> mmulti_join.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>C</span> <span class=main>(</span>mmulti_join <span class=free>n</span> <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> C_eq L_eq table_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> in_join_iff<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> mmulti_join <span class=free>n</span> <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span>"</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> Qs<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ _ conjI<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> pos'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>L_pos</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> neg'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>L_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> that<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> L_eq in_join_iff take_eq drop_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>Q_pos</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> pos pos' restrict_pos that<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> fv_subset'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> length <span class=free>A_neg</span> <span class=main>⟹</span> <span class=free>A_neg</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>⊆</span> <span class=free>C</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fv_subset <span class=keyword1><span class=command>unfolding</span></span> C_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Sup_le_iff<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=main>¬</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>Q_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> neg neg' restrict_neg that<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def
          wf_tuple_restrict_simple<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ fv_subset'<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> mmulti_join <span class=free>n</span> <span class=free>A_pos</span> <span class=free>A_neg</span> <span class=free>L</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>unfolding</span></span> L_eq in_join_iff take_eq drop_eq
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> conjI<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> that <span class=keyword1><span class=command>have</span></span> pos'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>Q_pos</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> neg'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=main>¬</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>Q_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Qs<span class=main>[</span><span class=operator>THEN</span> iffD1<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>A</span><span class=main>∈</span>set <span class=free>A_pos</span><span class=main>.</span> <span class=bound>A</span><span class=main>)</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=skolem>x</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> C_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∈)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_pos</span> <span class=free>L_pos</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> pos pos' restrict_pos that<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def
          C_eq wf_tuple_restrict_simple<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ Sup_upper<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> <span class=main>(∉)</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=free>A_neg</span> <span class=free>L_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> neg neg' restrict_neg that<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> nth_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>i'</span><span class=main>.</span> <span class=bound>i'</span> <span class=main>&lt;</span> length <span class=free>xs</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span><span class=free>xs</span> <span class=main>!</span> <span class=bound>i'</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span><span class=free>xs</span> <span class=main>!</span> <span class=bound>i'</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span> <span class=main>!</span> <span class=free>i</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>lifting<span class=main><span class=main>)</span></span> in_set_conv_nth set_filter mem_Collect_eq<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> nth_partition<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length <span class=free>xs</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>i'</span><span class=main>.</span> <span class=bound>i'</span> <span class=main>&lt;</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span> <span class=main>!</span> <span class=bound>i'</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>i'</span><span class=main>.</span> <span class=bound>i'</span> <span class=main>&lt;</span> length <span class=main>(</span>filter <span class=main>(</span>Not <span class=main>∘</span> <span class=free>P</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span>filter <span class=main>(</span>Not <span class=main>∘</span> <span class=free>P</span><span class=main>)</span> <span class=free>xs</span> <span class=main>!</span> <span class=bound>i'</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span><span class=free>xs</span> <span class=main>!</span> <span class=free>i</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> in_set_conv_nth set_filter mem_Collect_eq comp_apply<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_bin_join<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=free>P</span> <span class=free>Q1</span> <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>B</span> <span class=free>P</span> <span class=free>Q2</span> <span class=free>Y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=free>b</span> <span class=main>⟹</span> <span class=free>B</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>C</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=free>B</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=free>P</span> <span class=main>(</span>restrict <span class=free>B</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>b</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>x</span> <span class=main>⟷</span> <span class=free>Q1</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q2</span> <span class=main>(</span>restrict <span class=free>B</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span> <span class=free>b</span> <span class=main>⟹</span> wf_tuple <span class=free>n</span> <span class=free>C</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>x</span> <span class=main>⟷</span> <span class=free>Q1</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span> <span class=free>Q2</span> <span class=main>(</span>restrict <span class=free>B</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>C</span> <span class=free>P</span> <span class=free>Q</span> <span class=main>(</span>bin_join <span class=free>n</span> <span class=free>A</span> <span class=free>X</span> <span class=free>b</span> <span class=free>B</span> <span class=free>Y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> qtable_join<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> bin_join_table<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>X</span></span> <span class=quoted><span class=free>B</span></span> <span class=quoted><span class=free>Y</span></span> <span class=quoted><span class=free>b</span></span><span class=main>]</span> assms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> qtable_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> restrict_update<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∉</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>&lt;</span> length <span class=free>x</span> <span class=main>⟹</span> restrict <span class=free>A</span> <span class=main>(</span><span class=free>x</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span><span class=free>z</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> restrict <span class=free>A</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> restrict_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nth_list_update<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_assign<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>X</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"insert <span class=free>y</span> <span class=free>A</span> <span class=main>=</span> <span class=free>A'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∉</span> <span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x'</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=bound>x'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=bound>x'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q'</span> <span class=main>(</span><span class=bound>x</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x'</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=bound>x'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x'</span> <span class=main>⟹</span> <span class=free>Q'</span> <span class=bound>x'</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=bound>x'</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x'</span> <span class=main>!</span> <span class=free>y</span> <span class=main>=</span> Some <span class=main>(</span><span class=free>f</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=bound>x'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A'</span> <span class=free>P</span> <span class=free>Q'</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>`</span> <span class=free>X</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"qtable <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=var>?Y</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtableI<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A</span> <span class=free>X</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> qtable_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A'</span> <span class=var>?Y</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> table_def wf_tuple_def <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> nth_list_update<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x'</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> <span class=var>?Y</span>"</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=skolem>x'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x'</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>X</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> x'_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>=</span> <span class=skolem>x</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span><span class=free>f</span> <span class=skolem>x</span><span class=main>)</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> qtable_def table_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>&lt;</span> length <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_tuple_def<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=skolem>x</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"restrict <span class=free>A</span> <span class=skolem>x'</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> x'_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> restrict_update<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main><span class=main>(</span></span></span>4<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> restrict_idle<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=skolem>x'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>P</span> <span class=skolem>x'</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>5<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=skolem>x</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>X</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>elim</span> in_qtableE<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=skolem>x</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>P</span> <span class=skolem>x</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>Q'</span> <span class=skolem>x'</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> x'_eq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> assms<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x'</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=skolem>x'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q'</span> <span class=skolem>x'</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_tuple_restrict_simple<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=skolem>x'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>P</span> <span class=skolem>x'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> assms<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> y<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>!</span> <span class=free>y</span> <span class=main>=</span> Some <span class=main>(</span><span class=free>f</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=skolem>x'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>P</span> <span class=skolem>x'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>Q'</span> <span class=skolem>x'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> assms<span class=main><span class=main>(</span></span>7<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"restrict <span class=free>A</span> <span class=skolem>x'</span> <span class=main>∈</span> <span class=free>X</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> in_qtableI<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>=</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span>Some <span class=main>(</span><span class=free>f</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span><span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> y assms<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=main>(</span>restrict <span class=free>A</span> <span class=skolem>x'</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹wf_tuple <span class=free>n</span> <span class=free>A'</span> <span class=skolem>x'</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq wf_tuple_def nth_list_update nth_restrict<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> <span class=var>?Y</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> sat_the_update<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∉</span> fv <span class=free>φ</span> <span class=main>⟹</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=main>(</span><span class=free>x</span><span class=main>[</span><span class=free>y</span><span class=main>:=</span><span class=free>z</span><span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span> <span class=main>=</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=free>x</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sat_fv_cong<span class=main>)</span> <span class=main>(</span><span class=operator>metis</span> map_update nth_list_update_neq<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> progress_constraint<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=free>P</span> <span class=main>(</span>formula_of_constraint <span class=free>c</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> formula_of_constraint.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_filter<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>X</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>x</span> <span class=main>∧</span> <span class=free>R</span> <span class=bound>x</span> <span class=main>⟷</span> <span class=free>Q'</span> <span class=bound>x</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=free>P</span> <span class=free>Q'</span> <span class=main>(</span>Set.filter <span class=free>R</span> <span class=free>X</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"qtable <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=var>?Y</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtableI<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A</span> <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> qtable_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"table <span class=free>n</span> <span class=free>A</span> <span class=var>?Y</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> table_def wf_tuple_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?Y</span>"</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>Q'</span> <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableE<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q'</span> <span class=skolem>x</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> Set.filter <span class=free>R</span> <span class=free>X</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableI<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> eval_constraint_sat_eq<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=free>x</span> <span class=main>⟹</span> fv_trm <span class=free>t1</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span> fv_trm <span class=free>t2</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span>
  <span class=main>∀</span><span class=bound>i</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> eval_constraint <span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span> <span class=free>x</span> <span class=main>=</span>
    Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=free>x</span><span class=main>)</span> <span class=free>i</span> <span class=main>(</span>formula_of_constraint <span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span>"</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> formula_of_constraint.induct<span class=main>)</span>
    <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> meval_trm_eval_trm<span class=main>)</span>

<span class=keyword1><span class=command>declare</span></span> progress_le_gen<span class=main>[</span><span class=operator>simp</span><span class=main>]</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>wf_envs</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>=</span>
  <span class=main>(</span>dom <span class=free><span class=bound><span class=entity>V</span></span></span> <span class=main>=</span> dom <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span>
   Mapping.keys <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>=</span> dom <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∪</span> <span class=main>{</span><span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> fst <span class=main>`</span> Γ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>}</span> <span class=main>∧</span>
   rel_mapping <span class=main>(≤)</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=main>∧</span>
   pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span>
   pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> Suc <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=main>∧</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound>p</span> <span class=main>∈</span> Mapping.keys <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=main>-</span> dom <span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>.</span> the <span class=main>(</span>Mapping.lookup <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=bound>p</span><span class=main>)</span> <span class=main>=</span> <span class=main>[</span><span class=main>{</span><span class=bound>ts</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∈</span> Γ <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>}</span><span class=main>]</span><span class=main>)</span> <span class=main>∧</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound>p</span> <span class=main>∈</span> dom <span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>.</span> list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>=</span> the <span class=main>(</span><span class=free><span class=bound><span class=entity>V</span></span></span> <span class=bound>p</span><span class=main>)</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>the <span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=bound>p</span><span class=main>)</span><span class=main>..&lt;</span>the <span class=main>(</span><span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=bound>p</span><span class=main>)</span><span class=main>]</span> <span class=main>(</span>the <span class=main>(</span>Mapping.lookup <span class=free><span class=bound><span class=entity>db</span></span></span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>lift_definition</span></span> mk_db <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Formula.name <span class=main>×</span> event_data list<span class=main>)</span> set <span class=main>⇒</span> Formula.database"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>X</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>p</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=bound>X</span> <span class=keyword1>then</span> Some <span class=main>[</span><span class=main>{</span><span class=bound>ts</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>}</span><span class=main>]</span> <span class=keyword1>else</span> None<span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> wf_envs_mk_db<span class=main>:</span> <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> Map.empty Map.empty Map.empty <span class=main>(</span>mk_db <span class=main>(</span>Γ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def mk_db_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_iff rel_mapping_alt<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_envs_update<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> wf_envs<span class=main>:</span> <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> m_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>=</span> Formula.nfv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> in_fv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>0</span> <span class=main>..&lt;</span> <span class=free>m</span><span class=main>}</span> <span class=main>⊆</span> fv <span class=free>φ</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> xs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>m</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr UNIV<span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=main>(</span><span class=free>P</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=free>P'</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span><span class=free>V</span><span class=main>(</span><span class=free>p</span> <span class=main>↦</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> <span class=free>m</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=bound>v</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>Mapping.update <span class=free>p</span> <span class=main>(</span>map <span class=main>(</span>image <span class=main>(</span>map the<span class=main>)</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span> <span class=free>db</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> conjI ballI<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 3
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_envs_def pred_mapping_alt progress_le progress_mono_gen
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> rel_mapping_map_upd<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>6 <span class=skolem>p'</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>∈</span> dom <span class=free>P</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_envs_def lookup_update'<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>7 <span class=skolem>p'</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> xs in_fv <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> map the <span class=main>`</span> <span class=bound>y</span> <span class=main>=</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> <span class=free>m</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=bound>v</span> <span class=bound>x</span> <span class=free>φ</span><span class=main>}</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=free>xs</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>elim</span> list.rel_mono_strong<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def nth_append
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableE in_qtableI <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> image_eqI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"map Some <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>=</span> the <span class=main>(</span><span class=free>V</span> <span class=skolem>p'</span><span class=main>)</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>the <span class=main>(</span><span class=free>P</span> <span class=skolem>p'</span><span class=main>)</span><span class=main>..&lt;</span>the <span class=main>(</span><span class=free>P'</span> <span class=skolem>p'</span><span class=main>)</span><span class=main>]</span> <span class=main>(</span>the <span class=main>(</span>Mapping.lookup <span class=free>db</span> <span class=skolem>p'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>≠</span> <span class=skolem>p'</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> that 7 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>∈</span> dom <span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> wf_envs <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_envs_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.rel_map image_iff lookup_update'<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>use</span> assms <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> <span class=quoted>‹<span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main>:</span> wf_envs_def›</span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_envs_P_simps<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free>j</span><span class=main>)</span> <span class=free>P</span>"</span></span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> pred_mapping <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> Suc <span class=free>j</span><span class=main>)</span> <span class=free>P'</span>"</span></span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> rel_mapping <span class=main>(≤)</span> <span class=free>P</span> <span class=free>P'</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> wf_envs_progress_le<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>≤</span> Suc <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> wf_envs_progress_regex_le<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> progress_regex <span class=free>σ</span> <span class=free>P</span> <span class=free>r</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> progress_regex <span class=free>σ</span> <span class=free>P'</span> <span class=free>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>≤</span> Suc <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_regex_le<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> wf_envs_progress_mono<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
   <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span> <span class=main>⟹</span> <span class=free>a</span> <span class=main>≤</span> <span class=free>b</span> <span class=main>⟹</span> progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ</span> <span class=free>a</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ</span> <span class=free>b</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_mono_gen<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> qtable_wf_tuple_cong<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=free>n</span> <span class=free>A</span> <span class=free>P</span> <span class=free>Q</span> <span class=free>X</span> <span class=main>⟹</span> <span class=free>A</span> <span class=main>=</span> <span class=free>B</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>v</span><span class=main>.</span> wf_tuple <span class=free>n</span> <span class=free>A</span> <span class=bound>v</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>v</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>v</span> <span class=main>=</span> <span class=free>Q'</span> <span class=bound>v</span><span class=main>)</span> <span class=main>⟹</span> qtable <span class=free>n</span> <span class=free>B</span> <span class=free>P</span> <span class=free>Q'</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> qtable_def table_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> meval<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=free>φ</span> <span class=free>φ'</span>"</span></span> <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=free>P</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>db</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> meval <span class=free>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=free>db</span> <span class=free>φ</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>xs</span><span class=main>,</span> <span class=bound>φ<span class=hidden>⇩</span><sub>n</sub></span><span class=main>)</span> <span class=main>⇒</span> wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=free>P'</span> <span class=free>V</span> <span class=free>n</span> <span class=free>R</span> <span class=bound>φ<span class=hidden>⇩</span><sub>n</sub></span> <span class=free>φ'</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=free>n</span> <span class=main>(</span>Formula.fv <span class=free>φ'</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=free>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ'</span><span class=main>)</span><span class=main>)</span>
    <span class=main>[</span>progress <span class=free>σ</span> <span class=free>P</span> <span class=free>φ'</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=free>P'</span> <span class=free>φ'</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=bound>xs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>db</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>P'</span></span> <span class=quoted><span class=free>V</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>φ'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MRel <span class=skolem>rel</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ball_Un <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> wf_mformula.intros table_eq_rel eq_rel_eval_trm
        in_eq_rel qtable_empty qtable_unit_table <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtableI<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPred <span class=skolem>e</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> dom <span class=skolem>P</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> MPred<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> Mapping.keys <span class=skolem>db</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> dom <span class=skolem>P'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> dom <span class=skolem>V</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>=</span> the <span class=main>(</span><span class=skolem>V</span> <span class=skolem>e</span><span class=main>)</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>the <span class=main>(</span><span class=skolem>P</span> <span class=skolem>e</span><span class=main>)</span><span class=main>..&lt;</span>the <span class=main>(</span><span class=skolem>P'</span> <span class=skolem>e</span><span class=main>)</span><span class=main>]</span>
         <span class=main>(</span>the <span class=main>(</span>Mapping.lookup <span class=skolem>db</span> <span class=skolem>e</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def rel_mapping_alt <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>with</span></span> MPred<span class=main>(</span>1<span class=main>)</span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
        <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Pred qtableI bexI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>_</span> <span class=main>=</span> tabulate <span class=bound>x</span> <span class=main>0</span> <span class=skolem>n</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> refl<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> ex_match
        <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map table_def match_wf_tuple in_these_eq match_eval_trm image_iff
          list.map_comp keys_dom_lookup<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword1><span class=command>note</span></span> MPred<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> False MPred<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∉</span> dom <span class=skolem>P'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∉</span> dom <span class=skolem>V</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def rel_mapping_alt <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> False MPred<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> fst <span class=main>`</span> Γ <span class=free>σ</span> <span class=free>j</span> <span class=main>⟷</span> <span class=skolem>e</span> <span class=main>∈</span> Mapping.keys <span class=skolem>db</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>from</span></span> False MPred<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> Mapping.keys <span class=skolem>db</span> <span class=main>⟹</span> Mapping.lookup <span class=skolem>db</span> <span class=skolem>e</span> <span class=main>=</span> Some <span class=main>[</span><span class=main>{</span><span class=bound>ts</span><span class=main>.</span> <span class=main>(</span><span class=skolem>e</span><span class=main>,</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∈</span> Γ <span class=free>σ</span> <span class=free>j</span><span class=main>}</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> wf_envs_def keys_dom_lookup <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Diff_iff domD option.sel<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> * <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=skolem>db</span> <span class=skolem>e</span> <span class=keyword1>of</span> None <span class=main>⇒</span> <span class=main>[</span><span class=main>{}</span><span class=main>]</span> <span class=main>|</span> Some <span class=bound>xs</span> <span class=main>⇒</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>=</span> <span class=main>[</span><span class=main>{</span><span class=bound>ts</span><span class=main>.</span> <span class=main>(</span><span class=skolem>e</span><span class=main>,</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∈</span> Γ <span class=free>σ</span> <span class=free>j</span><span class=main>}</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> fst <span class=main>`</span> Γ <span class=free>σ</span> <span class=free>j</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> image_iff keys_dom_lookup <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
        <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Pred qtableI bexI<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>_</span> <span class=main>=</span> tabulate <span class=bound>x</span> <span class=main>0</span> <span class=skolem>n</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> refl<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> ex_match
        <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map table_def match_wf_tuple in_these_eq match_eval_trm image_iff list.map_comp<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MLet <span class=skolem>p</span> <span class=skolem>m</span> <span class=skolem>φ1</span> <span class=skolem>φ2</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MLet.prems<span class=main>(</span>1<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ1'</span></span> <span class=skolem><span class=skolem>φ2'</span></span> <span class=keyword2><span class=keyword>where</span></span> Let<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> Formula.Let <span class=skolem>p</span> <span class=skolem>φ1'</span> <span class=skolem>φ2'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    1<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>m</span> UNIV <span class=skolem>φ1</span> <span class=skolem>φ1'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    fv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m</span> <span class=main>=</span> Formula.nfv <span class=skolem>φ1'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>0</span><span class=main>..&lt;</span><span class=skolem>m</span><span class=main>}</span> <span class=main>⊆</span> fv <span class=skolem>φ1'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    2<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=main>(</span><span class=skolem>P</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ1'</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span>
      <span class=main>(</span><span class=skolem>V</span><span class=main>(</span><span class=skolem>p</span> <span class=main>↦</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> length <span class=bound>v</span> <span class=main>=</span> <span class=skolem>m</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=bound>v</span> <span class=bound>i</span> <span class=skolem>φ1'</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
      <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ2</span> <span class=skolem>φ2'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>xs</span></span> <span class=skolem><span class=skolem>φ1_new</span></span> <span class=keyword2><span class=keyword>where</span></span> e1<span class=main>:</span> <span class=quoted><span class=quoted>"meval <span class=skolem>m</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ1</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>xs</span><span class=main>,</span> <span class=skolem>φ1_new</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
      wf1<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>P'</span> <span class=skolem>V</span> <span class=skolem>m</span> UNIV <span class=skolem>φ1_new</span> <span class=skolem>φ1'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
      res1<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>m</span> <span class=main>(</span>fv <span class=skolem>φ1'</span><span class=main>)</span> <span class=main>(</span>mem_restr UNIV<span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=skolem>φ1'</span><span class=main>)</span><span class=main>)</span>
       <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ1'</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ1'</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=skolem>xs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> MLet<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> MLet.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eqTrueI<span class=main><span class=main>[</span></span><span class=operator>OF</span> mem_restr_UNIV<span class=main><span class=main>,</span></span> <span class=operator>abs_def</span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MLet<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 2 wf_envs_update<span class=main><span class=main>[</span></span><span class=operator>OF</span> MLet.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> fv res1<span class=main><span class=main>]</span></span><span class=main>]</span> wf1 e1 fv
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> Let
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_upd_def <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Let<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MAnd <span class=skolem>A_φ</span> <span class=skolem>φ</span> <span class=skolem>pos</span> <span class=skolem>A_ψ</span> <span class=skolem>ψ</span> <span class=skolem>buf</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MAnd.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sat_the_restrict <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> bin_join.simps
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MAnd.IH <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.And qtable_bin_join
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> mbuf2_take_add'<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> list.rel_mono_strong<span class=main><span class=main>[</span></span><span class=operator>OF</span> mbuf2_take_add'<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MAndAssign <span class=skolem>φ</span> <span class=skolem>conf</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MAndAssign.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ''</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>ψ''</span></span> <span class=keyword2><span class=keyword>where</span></span>
    wf_envs<span class=main>:</span> <span class=quoted><span class=quoted>"wf_envs <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>P'</span> <span class=skolem>V</span> <span class=skolem>db</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    φ'_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> formula.And <span class=skolem>φ''</span> <span class=skolem>ψ''</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    wf_φ<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ</span> <span class=skolem>φ''</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∉</span> fv <span class=skolem>φ''</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    fv_t_subset<span class=main>:</span> <span class=quoted><span class=quoted>"fv_trm <span class=skolem>t</span> <span class=main>⊆</span> fv <span class=skolem>φ''</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    conf<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>conf</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    ψ''_eqs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ψ''</span> <span class=main>=</span> formula.Eq <span class=main>(</span>trm.Var <span class=skolem>x</span><span class=main>)</span> <span class=skolem>t</span> <span class=main>∨</span> <span class=skolem>ψ''</span> <span class=main>=</span> formula.Eq <span class=skolem>t</span> <span class=main>(</span>trm.Var <span class=skolem>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> wf_φ wf_envs <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>xs</span></span> <span class=skolem><span class=skolem>φ<span class=hidden>⇩</span><sub>n</sub></span></span> <span class=keyword2><span class=keyword>where</span></span>
    meval_eq<span class=main>:</span> <span class=quoted><span class=quoted>"meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>xs</span><span class=main>,</span> <span class=skolem>φ<span class=hidden>⇩</span><sub>n</sub></span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    wf_φ<span class=hidden>⇩</span><sub>n</sub><span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>P'</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ<span class=hidden>⇩</span><sub>n</sub></span> <span class=skolem>φ''</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    xs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=skolem>φ''</span><span class=main>)</span><span class=main>)</span>
        <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=skolem>xs</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MAndAssign.IH<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> progress_eqs<span class=main>:</span>
      <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ'</span> <span class=free>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=free>j</span>"</span></span>
      <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ψ''_eqs wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> wf_envs<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> φ'_eq<span class=main>)</span>

  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> meval_eq<span class=main><span class=keyword3>,</span></span> <span class=operator>intro</span> conjI<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>P'</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>MAndAssign <span class=skolem>φ<span class=hidden>⇩</span><sub>n</sub></span> <span class=skolem>conf</span><span class=main>)</span> <span class=skolem>φ'</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> φ'_eq
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wf_mformula.AndAssign<span class=main>)</span> <span class=operator>fact</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>φ'</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=skolem>φ'</span><span class=main>)</span><span class=main>)</span>
        <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ'</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=main>(</span>map <span class=main>(</span><span class=main>(`)</span> <span class=main>(</span>eval_assignment <span class=skolem>conf</span><span class=main>)</span><span class=main>)</span> <span class=skolem>xs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> list.rel_map progress_eqs conf<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> eval_assignment.simps
      <span class=keyword1><span class=command>using</span></span> xs
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> list.rel_mono_strong<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span> <span class=skolem>X</span>
      <span class=keyword3><span class=command>assume</span></span> qtable<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>X</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>φ'</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ'</span><span class=main>)</span>
          <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span><span class=main>[</span><span class=skolem>x</span> <span class=main>:=</span> Some <span class=main>(</span>meval_trm <span class=skolem>t</span> <span class=bound>y</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>X</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtable_assign<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fact</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"insert <span class=skolem>x</span> <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=main>=</span> fv <span class=skolem>φ'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> ψ''_eqs fv_t_subset <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> φ'_eq<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∉</span> fv <span class=skolem>φ''</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fact</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
        <span class=keyword3><span class=command>assume</span></span> wf_v<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>φ'</span><span class=main>)</span> <span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=skolem>R</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=skolem>R</span> <span class=main>(</span>restrict <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

        <span class=keyword3><span class=command>assume</span></span> sat<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ'</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=main>(</span>restrict <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span><span class=main>)</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ''</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> φ'_eq sat_the_restrict<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map the <span class=skolem>v</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> Formula.eval_trm <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> sat ψ''_eqs <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> φ'_eq<span class=main>)</span>
        <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> Formula.eval_trm <span class=main>(</span>map the <span class=main>(</span>restrict <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span><span class=main>)</span><span class=main>)</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> fv_t_subset <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_the_restrict <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> eval_trm_fv_cong<span class=main>)</span>
        <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map the <span class=skolem>v</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> meval_trm <span class=skolem>t</span> <span class=main>(</span>restrict <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> meval_trm_eval_trm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=quoted>"fv <span class=skolem>φ''</span>"</span></span> <span class=quoted><span class=quoted>"restrict <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span>"</span></span> <span class=quoted><span class=skolem>t</span></span><span class=main>]</span>
            fv_t_subset wf_v wf_mformula_wf_set<span class=main>[</span><span class=operator>unfolded</span> wf_set_def<span class=main>,</span> <span class=operator>OF</span> wf_φ<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> φ'_eq <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_tuple_restrict<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>!</span> <span class=skolem>x</span> <span class=main>=</span> Some <span class=main>(</span>meval_trm <span class=skolem>t</span> <span class=main>(</span>restrict <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span><span class=main>)</span>
          <span class=keyword1><span class=command>using</span></span> ψ''_eqs wf_v <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def φ'_eq<span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> A B <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>∧</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
        <span class=keyword3><span class=command>assume</span></span> wf_v<span class=main>:</span> <span class=quoted><span class=quoted>"wf_tuple <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=skolem>R</span> <span class=skolem>v</span>"</span></span>
          <span class=keyword2><span class=keyword>and</span></span> sat<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ''</span>"</span></span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?v</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>[</span><span class=skolem>x</span> <span class=main>:=</span> Some <span class=main>(</span>meval_trm <span class=skolem>t</span> <span class=skolem>v</span><span class=main>)</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>from</span></span> sat <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=var>?v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ''</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∉</span> fv <span class=skolem>φ''</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sat_the_update<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> fv_trm <span class=skolem>t</span> <span class=main>⟹</span> <span class=skolem>x</span> <span class=main>≠</span> <span class=skolem>y</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
          <span class=keyword1><span class=command>using</span></span> fv_t_subset <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∉</span> fv <span class=skolem>φ''</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=var>?v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>ψ''</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> ψ''_eqs meval_trm_eval_trm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=quoted>"fv <span class=skolem>φ''</span>"</span></span> <span class=quoted><span class=skolem>v</span></span> <span class=quoted><span class=skolem>t</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>&lt;</span> <span class=skolem>n</span>›</span></span>
            fv_t_subset wf_v wf_mformula_wf_set<span class=main>[</span><span class=operator>unfolded</span> wf_set_def<span class=main>,</span> <span class=operator>OF</span> wf_φ<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> wf_tuple_def map_update <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> eval_trm_fv_cong<span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> A B <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=var>?v</span><span class=main>)</span> <span class=skolem>i</span> <span class=skolem>φ'</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> φ'_eq<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MAndRel <span class=skolem>φ</span> <span class=skolem>conf</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MAndRel.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> progress_constraint progress_le list.rel_map fv_formula_of_constraint
        Un_absorb2 wf_mformula_wf_set<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> wf_set_def<span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MAndRel.IH<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> db<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>db</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> P<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>P</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> P'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=skolem>P'</span></span><span class=main><span class=main>]</span></span> eval_constraint_sat_eq<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.AndRel
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong qtable_filter eval_constraint_sat_eq<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MAnds <span class=skolem>A_pos</span> <span class=skolem>A_neg</span> <span class=skolem>l</span> <span class=skolem>buf</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> mbufn_take.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> mbufn_add.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> mmulti_join.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>

  <span class=keyword1><span class=command>from</span></span> MAnds.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=skolem><span class=skolem>neg</span></span> <span class=skolem><span class=skolem>l'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    wf_l<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span>wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span><span class=main>)</span> <span class=skolem>l</span> <span class=main>(</span><span class=skolem>pos</span> <span class=main>@</span> map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    wf_buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbufn <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Ands <span class=skolem>l'</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=bound>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span><span class=skolem>pos</span> <span class=main>@</span> map remove_neg <span class=skolem>neg</span><span class=main>)</span><span class=main>)</span>
      <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span> <span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=bound>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>pos</span> <span class=main>@</span> map remove_neg <span class=skolem>neg</span><span class=main>)</span><span class=main>)</span> <span class=skolem>buf</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    posneg<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>pos</span><span class=main>,</span> <span class=skolem>neg</span><span class=main>)</span> <span class=main>=</span> partition safe_formula <span class=skolem>l'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    safe_neg<span class=main>:</span> <span class=quoted><span class=quoted>"list_all safe_formula <span class=main>(</span>map remove_neg <span class=skolem>neg</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    A_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>A_pos</span> <span class=main>=</span> map fv <span class=skolem>pos</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>A_neg</span> <span class=main>=</span> map fv <span class=skolem>neg</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    fv_subset<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=main>(</span>set <span class=skolem>A_neg</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>⋃</span> <span class=main>(</span>set <span class=skolem>A_pos</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> Formula.Ands <span class=skolem>l'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> progress_eq<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>formula.Ands <span class=skolem>l'</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span>
      Mini <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Ands <span class=skolem>l'</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=bound>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>pos</span> <span class=main>@</span> map remove_neg <span class=skolem>neg</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>›</span></span> posneg
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Mini_def image_Un<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> Collect_disj_eq<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted>Min</span><span class=main><span class=main>]</span></span><span class=main>)</span>

  <span class=keyword1><span class=command>have</span></span> join_ok<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=skolem>n</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>l'</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span>
        <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> list_all <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span><span class=main>)</span> <span class=skolem>l'</span><span class=main>)</span>
        <span class=main>(</span>mmulti_join <span class=skolem>n</span> <span class=skolem>A_pos</span> <span class=skolem>A_neg</span> <span class=skolem>L</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> args_ok<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=bound>x</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span><span class=skolem>pos</span> <span class=main>@</span> map remove_neg <span class=skolem>neg</span><span class=main>)</span> <span class=skolem>L</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span> <span class=skolem>L</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> qtable_mmulti_join<span class=main>)</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ok</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span> <span class=bound>X</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=bound>A</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=bound>Qi</span> <span class=bound>X</span> <span class=main>∧</span> wf_set <span class=skolem>n</span> <span class=bound>A</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?L_pos</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"take <span class=main>(</span>length <span class=skolem>A_pos</span><span class=main>)</span> <span class=skolem>L</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?L_neg</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"drop <span class=main>(</span>length <span class=skolem>A_pos</span><span class=main>)</span> <span class=skolem>L</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>pos</span> <span class=main>≤</span> length <span class=skolem>L</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> args_ok <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all3 <span class=var>?ok</span> <span class=skolem>A_pos</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span> <span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span> <span class=bound>ψ</span><span class=main>)</span> <span class=skolem>pos</span><span class=main>)</span> <span class=var>?L_pos</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> args_ok wf_l <span class=keyword1><span class=command>unfolding</span></span> A_eq
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth nth_append
          <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula_wf_set<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>j</span></span> <span class=quoted><span class=skolem>P</span></span> <span class=quoted><span class=skolem>V</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>R</span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> order.strict_trans2<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ 1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> args_ok <span class=keyword1><span class=command>have</span></span> prems_neg<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=bound>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span> <span class=main>(</span>remove_neg <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>neg</span> <span class=var>?L_neg</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> A_eq list_all2_append1 list.rel_map<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all3 <span class=var>?ok</span> <span class=skolem>A_neg</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span> <span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span> <span class=main>(</span>remove_neg <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span> <span class=skolem>neg</span><span class=main>)</span> <span class=var>?L_neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> prems_neg wf_l <span class=keyword1><span class=command>unfolding</span></span> A_eq
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length nth_append less_diff_conv
          <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula_wf_set<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>j</span></span> <span class=quoted><span class=skolem>P</span></span> <span class=quoted><span class=skolem>V</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>R</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"remove_neg <span class=main>_</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span><span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>l'</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span><span class=main>(</span>set <span class=skolem>A_pos</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fv_subset posneg <span class=keyword1><span class=command>unfolding</span></span> A_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> take <span class=main>(</span>length <span class=skolem>A_pos</span><span class=main>)</span> <span class=skolem>L</span> <span class=main>@</span> drop <span class=main>(</span>length <span class=skolem>A_pos</span><span class=main>)</span> <span class=skolem>L</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>A_pos</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>›</span></span> A_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data tuple"</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=skolem>n</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span>fv <span class=main>`</span> set <span class=skolem>l'</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=skolem>R</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> mem_restr <span class=skolem>R</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=skolem>A_pos</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>A</span><span class=main>.</span> mem_restr <span class=skolem>R</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=skolem>A_neg</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.pred_set<span class=main>)</span>

    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all Formula.is_Neg <span class=skolem>neg</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> posneg safe_neg
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.pred_map <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.pred_mono_strong
          <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> formula.exhaust<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>ψ</span></span> <span class=quoted><span class=quoted>"Formula.is_Neg <span class=skolem>ψ</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>for</span></span></span></span> <span class=skolem>ψ</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=main>(</span>remove_neg <span class=bound>ψ</span><span class=main>)</span> <span class=main>⟷</span>
      <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=skolem>v</span><span class=main>)</span> <span class=skolem>i</span> <span class=bound>ψ</span><span class=main>)</span> <span class=skolem>neg</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>v</span> <span class=skolem>i</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Formula.is_Neg_def <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.pred_mono_strong<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=skolem>x</span><span class=main>)</span> <span class=skolem>k</span><span class=main>)</span> <span class=skolem>l'</span> <span class=main>=</span>
       <span class=main>(</span>list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=skolem>A_pos</span>
         <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span> <span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span> <span class=bound>ψ</span><span class=main>)</span> <span class=skolem>pos</span><span class=main>)</span> <span class=main>∧</span>
        list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>A</span> <span class=bound>Qi</span><span class=main>.</span> <span class=main>¬</span> <span class=bound>Qi</span> <span class=main>(</span>restrict <span class=bound>A</span> <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=skolem>A_neg</span>
         <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>ψ</span> <span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=skolem>k</span>
                       <span class=main>(</span>remove_neg <span class=bound>ψ</span><span class=main>)</span><span class=main>)</span>
           <span class=skolem>neg</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> posneg
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> A_eq list_all2_conv_all_nth list_all_length sat_the_restrict
          <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> nth_filter nth_partition<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted>safe_formula</span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> Q<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Formula.sat <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>fact</span>

  <span class=keyword1><span class=command>from</span></span> MAnds.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ'</span> <span class=main>=</span> Formula.Ands <span class=skolem>l'</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.rel_map progress_eq map2_map_map list_all3_map
        list_all3_list_all2_conv list.pred_map
        <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> set_append map_append progress_simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Ands<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ posneg <span class=quoted><span class=quoted>‹<span class=skolem>pos</span> <span class=main>≠</span> <span class=main>[]</span>›</span></span> safe_neg A_eq fv_subset<span class=main><span class=main>]</span></span>
        list.rel_mono_strong<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf_l<span class=main><span class=main>]</span></span> wf_mbufn_add<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf_buf<span class=main><span class=main>]</span></span>
        list.rel_flip<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>OF</span> list.rel_mono_strong<span class=main><span class=main>,</span></span> <span class=operator>OF</span> wf_l<span class=main><span class=main>]</span></span>
        list.rel_refl join_ok<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> list.pred_set<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MAnds.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MAnds.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mbufn_take list_all2_appendI
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> mbufn_take_induct<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_mbufn_add<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> wf_buf<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MOr <span class=skolem>φ</span> <span class=skolem>ψ</span> <span class=skolem>buf</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MOr.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MOr.IH <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Or qtable_union
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> mbuf2_take_add'<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> list.rel_mono_strong<span class=main><span class=main>[</span></span><span class=operator>OF</span> mbuf2_take_add'<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MNeg <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=skolem>n</span> <span class=main>{}</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=skolem>P</span> <span class=bound>v</span><span class=main>)</span> <span class=skolem>X</span> <span class=main>⟹</span>
    <span class=main>¬</span> qtable <span class=skolem>n</span> <span class=main>{}</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>¬</span> <span class=skolem>P</span> <span class=bound>v</span><span class=main>)</span> empty_table <span class=main>⟹</span> <span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>X</span> <span class=main>⟹</span> False"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>P</span> <span class=skolem>x</span> <span class=skolem>X</span>
    <span class=keyword1><span class=command>using</span></span> nullary_qtable_cases qtable_unit_empty_table <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>from</span></span> MNeg.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Neg <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MNeg.IH
        <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.rel_map
        <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> nullary_qtable_cases qtable_unit_empty_table <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> qtable_empty_unit_table
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> *<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MExists <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MExists.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list.rel_map fvi_Suc sat_fv_cong nth_Cons'
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Exists <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MExists.IH qtable_project_fv
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong table_fvi_tl qtable_cong sat_fv_cong<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>,</span></span> <span class=operator>rotated</span> -1<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MAgg <span class=skolem>g0</span> <span class=skolem>y</span> <span class=skolem>ω</span> <span class=skolem>b</span> <span class=skolem>f</span> <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MAgg.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> wf_mformula_wf_set<span class=main>[</span><span class=operator>OF</span> MAgg.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>unfolded</span> wf_set_def<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.rel_map <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> sat.simps fvi.simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Agg qtable_eval_agg <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MAgg.IH <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MPrev <span class=skolem>I</span> <span class=skolem>φ</span> <span class=skolem>first</span> <span class=skolem>buf</span> <span class=skolem>nts</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MPrev.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Prev <span class=skolem>ψ</span><span class=main>)</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?xs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ls</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>mprev_next <span class=skolem>I</span> <span class=main>(</span><span class=skolem>buf</span> <span class=main>@</span> <span class=var>?xs</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>snd <span class=main>(</span>mprev_next <span class=skolem>I</span> <span class=main>(</span><span class=skolem>buf</span> <span class=main>@</span> <span class=var>?xs</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ts</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>snd <span class=main>(</span>mprev_next <span class=skolem>I</span> <span class=main>(</span><span class=skolem>buf</span> <span class=main>@</span> <span class=var>?xs</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=skolem>ψ</span><span class=main>)</span> <span class=bound>X</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?min</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> Prev MPrev.IH<span class=main>[</span><span class=operator>OF</span> _ MPrev.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>R</span></span> <span class=quoted><span class=skolem>ψ</span></span><span class=main>]</span> <span class=keyword1><span class=command>have</span></span> IH<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>P'</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=var>?φ</span> <span class=skolem>ψ</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=var>?P</span> <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=var>?xs</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> Prev<span class=main>(</span>4<span class=main>,</span>5<span class=main>)</span> MPrev.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=keyword1>if</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=skolem>I</span> <span class=keyword1>then</span> <span class=var>?P</span> <span class=bound>i</span> <span class=bound>X</span> <span class=keyword1>else</span> <span class=bound>X</span> <span class=main>=</span> empty_table<span class=main>)</span>
        <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=var>?min</span><span class=main>]</span> <span class=var>?ls</span> <span class=main>∧</span>
       list_all2 <span class=var>?P</span> <span class=main>[</span><span class=var>?min</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=var>?rs</span> <span class=main>∧</span>
       list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span><span class=var>?min</span><span class=main>..&lt;</span>Suc <span class=free>j</span><span class=main>]</span> <span class=var>?ts</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> mprev<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_upt_append list_all2_appendI order.trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> min.cobounded1<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"min <span class=main>(</span>Suc <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> Suc <span class=main>(</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span><span class=main>-</span><span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Prev<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span> MPrev.prems<span class=main>(</span>2<span class=main>)</span> IH
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_Suc_upt<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> upt_Suc<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span><span class=main><span class=main>]</span></span> list.rel_map qtable_empty_iff
          <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Prev list.rel_mono_strong
          <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split if_split_asm<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MNext <span class=skolem>I</span> <span class=skolem>φ</span> <span class=skolem>first</span> <span class=skolem>nts</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MNext.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Next <span class=skolem>ψ</span><span class=main>)</span>

    <span class=keyword1><span class=command>have</span></span> min<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
      <span class=quoted><span class=quoted>"min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span><span class=free>j</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span> <span class=main>-</span> Suc <span class=main>0</span>"</span></span>
      <span class=quoted><span class=quoted>"min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span> <span class=free>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>-</span> Suc <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> MNext.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>ψ</span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?xs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ys</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> <span class=main>(</span><span class=var>?xs</span><span class=main>,</span> <span class=skolem>first</span><span class=main>)</span> <span class=keyword1>of</span> <span class=main>(</span><span class=main><span class=bound>_</span></span> <span class=main>#</span> <span class=bound>xs</span><span class=main>,</span> True<span class=main>)</span> <span class=main>⇒</span> <span class=bound>xs</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=var>?xs</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ls</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>mprev_next <span class=skolem>I</span> <span class=var>?ys</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>snd <span class=main>(</span>mprev_next <span class=skolem>I</span> <span class=var>?ys</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ts</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>snd <span class=main>(</span>mprev_next <span class=skolem>I</span> <span class=var>?ys</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>ψ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=skolem>ψ</span><span class=main>)</span> <span class=bound>X</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?min</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> Next MNext.IH<span class=main>[</span><span class=operator>OF</span> _ MNext.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>R</span></span> <span class=quoted><span class=skolem>ψ</span></span><span class=main>]</span> <span class=keyword1><span class=command>have</span></span> IH<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>P'</span> <span class=skolem>V</span>  <span class=skolem>n</span> <span class=skolem>R</span> <span class=var>?φ</span> <span class=skolem>ψ</span>"</span></span>
      <span class=quoted><span class=quoted>"list_all2 <span class=var>?P</span> <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=var>?xs</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> Next <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>X</span><span class=main>.</span> <span class=keyword1>if</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=skolem>I</span> <span class=keyword1>then</span> <span class=var>?P</span> <span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=bound>X</span> <span class=keyword1>else</span> <span class=bound>X</span> <span class=main>=</span> empty_table<span class=main>)</span>
        <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span> <span class=main>-</span> <span class=main>1</span><span class=main>..&lt;</span><span class=var>?min</span><span class=main>]</span> <span class=var>?ls</span> <span class=main>∧</span>
       list_all2 <span class=var>?P</span> <span class=main>[</span>Suc <span class=var>?min</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=var>?rs</span> <span class=main>∧</span>
       list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span><span class=var>?min</span><span class=main>..&lt;</span>Suc <span class=free>j</span><span class=main>]</span> <span class=var>?ts</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> that wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> MNext.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>ψ</span></span></span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> mnext<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_Cons2 upt_eq_Cons_conv
          <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_upt_append list_all2_appendI <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> MNext.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>ψ</span></span></span></span><span class=main>]</span>
      wf_envs_progress_mono<span class=main>[</span><span class=operator>OF</span> MNext.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>j</span></span> <span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span> <span class=quoted><span class=skolem>ψ</span></span><span class=main>,</span> <span class=operator>simplified</span><span class=main>]</span> Next IH
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>&gt;</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ</span> <span class=free>j</span>"</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> qtable_empty_iff le_Suc_eq le_diff_conv
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Next list.rel_mono_strong list_all2_appendI
          <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split list.splits if_split_asm<span class=main>)</span>  <span class=comment1>(* slow 5 sec*)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MSince <span class=skolem>args</span> <span class=skolem>φ</span> <span class=skolem>ψ</span> <span class=skolem>buf</span> <span class=skolem>nts</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> sat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> MSince.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ''</span></span> <span class=skolem><span class=skolem>φ'''</span></span> <span class=skolem><span class=skolem>ψ''</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> Since_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> Formula.Since <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pos<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>if</span> args_pos <span class=skolem>args</span> <span class=keyword1>then</span> <span class=skolem>φ'''</span> <span class=main>=</span> <span class=skolem>φ''</span> <span class=keyword1>else</span> <span class=skolem>φ'''</span> <span class=main>=</span> Formula.Neg <span class=skolem>φ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pos_eq<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>φ'''</span> <span class=main>=</span> args_pos <span class=skolem>args</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> φ<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ</span> <span class=skolem>φ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ψ<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>ψ</span> <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> fvi_subset<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=skolem>φ''</span> <span class=main>⊆</span> Formula.fv <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=free>j</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nts<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts <span class=free>σ</span> <span class=skolem>P</span> <span class=free>j</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"wf_since_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>R</span> <span class=skolem>args</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>aux</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Since <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_ivl<span class=main>:</span> <span class=quoted><span class=quoted>"args_ivl <span class=skolem>args</span> <span class=main>=</span> <span class=skolem>I</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_n<span class=main>:</span> <span class=quoted><span class=quoted>"args_n <span class=skolem>args</span> <span class=main>=</span> <span class=skolem>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_L<span class=main>:</span> <span class=quoted><span class=quoted>"args_L <span class=skolem>args</span> <span class=main>=</span> Formula.fv <span class=skolem>φ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_R<span class=main>:</span> <span class=quoted><span class=quoted>"args_R <span class=skolem>args</span> <span class=main>=</span> Formula.fv <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> φ'''<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=skolem>φ'''</span> <span class=main>=</span> Formula.fv <span class=skolem>φ''</span>"</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ'''</span> <span class=skolem>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=skolem>j</span>"</span></span>
    <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=skolem>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=skolem>j</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>j</span>
    <span class=keyword1><span class=command>using</span></span> pos <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MSince.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> nts_snoc<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span>
    <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ''</span> <span class=free>j</span><span class=main>)</span><span class=main>..&lt;</span>Suc <span class=free>j</span><span class=main>]</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nts <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_envs_progress_le<span class=main><span class=main>[</span></span><span class=operator>THEN</span> min.coboundedI1<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all2_appendI<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> update<span class=main>:</span> <span class=quoted><span class=quoted>"wf_since_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>R</span> <span class=skolem>args</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=main>(</span>snd <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Since <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>Formula.fv <span class=skolem>φ'''</span> <span class=main>∪</span> Formula.fv <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=main>(</span>Formula.Since <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Since <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Since <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=main>(</span>fst <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> eval_φ<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>xs</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eval_ψ<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>ys</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbuf2t_take <span class=main>(</span><span class=main>λ</span><span class=bound>r1</span> <span class=bound>r2</span> <span class=bound>t</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>.</span>
        <span class=keyword1>case</span> update_since <span class=skolem>args</span> <span class=bound>r1</span> <span class=bound>r2</span> <span class=bound>t</span> <span class=bound>aux</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>z</span><span class=main>,</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=main>[</span><span class=bound>z</span><span class=main>]</span><span class=main>,</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=skolem>aux</span><span class=main>)</span> <span class=main>(</span>mbuf2_add <span class=skolem>xs</span> <span class=skolem>ys</span> <span class=skolem>buf</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span><span class=main>,</span> <span class=skolem>buf'</span><span class=main>,</span> <span class=skolem>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>xs</span> <span class=skolem>ys</span> <span class=skolem>zs</span> <span class=skolem>aux'</span> <span class=skolem>buf'</span> <span class=skolem>nts'</span>
    <span class=keyword1><span class=command>unfolding</span></span> progress_simps φ'''
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> mbuf2t_take_add_induct'<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> j<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>j</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> j'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> z'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span>"</span></span><span class=main><span class=main>,</span></span>
      <span class=operator>OF</span> eq wf_envs_P_simps<span class=main><span class=main>[</span></span><span class=operator>OF</span> MSince.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span> buf nts_snoc<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
      <span class=operator>goal_cases</span> xs ys _ base step<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> xs
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>using</span></span> MSince.IH<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> φ MSince.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> eval_φ <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ys
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>using</span></span> MSince.IH<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> ψ MSince.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> eval_ψ <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> base
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>using</span></span> aux <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> φ'''<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>step <span class=skolem>k</span> <span class=skolem>X</span> <span class=skolem>Y</span> <span class=skolem>z</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>using</span></span> fvi_subset pos
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_ivl args_n args_L args_R Un_absorb1
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> update_since<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> list_all2_appendI <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> update_since<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span>
          <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> MSince.IH<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> φ MSince.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> MSince.IH<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> ψ MSince.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Since_eq <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split
        <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> wf_mformula.Since<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ pos pos_eq args_ivl args_n args_L args_R fvi_subset<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> mbuf2t_take_add'<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MSince.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> buf nts_snoc<span class=main><span class=main>]</span></span>
              mbuf2t_take_add'<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MSince.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> buf nts_snoc<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MUntil <span class=skolem>args</span> <span class=skolem>φ</span> <span class=skolem>ψ</span> <span class=skolem>buf</span> <span class=skolem>nts</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> sat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span> progress_simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> MUntil.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>φ''</span></span> <span class=skolem><span class=skolem>φ'''</span></span> <span class=skolem><span class=skolem>ψ''</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> Until_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pos<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>if</span> args_pos <span class=skolem>args</span> <span class=keyword1>then</span> <span class=skolem>φ'''</span> <span class=main>=</span> <span class=skolem>φ''</span> <span class=keyword1>else</span> <span class=skolem>φ'''</span> <span class=main>=</span> Formula.Neg <span class=skolem>φ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> pos_eq<span class=main>:</span> <span class=quoted><span class=quoted>"safe_formula <span class=skolem>φ'''</span> <span class=main>=</span> args_pos <span class=skolem>args</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> φ<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ</span> <span class=skolem>φ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ψ<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>ψ</span> <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> fvi_subset<span class=main>:</span> <span class=quoted><span class=quoted>"Formula.fv <span class=skolem>φ''</span> <span class=main>⊆</span> Formula.fv <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbuf2' <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=free>j</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nts<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts <span class=free>σ</span> <span class=skolem>P</span> <span class=free>j</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>R</span> <span class=skolem>args</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>aux</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_ivl<span class=main>:</span> <span class=quoted><span class=quoted>"args_ivl <span class=skolem>args</span> <span class=main>=</span> <span class=skolem>I</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_n<span class=main>:</span> <span class=quoted><span class=quoted>"args_n <span class=skolem>args</span> <span class=main>=</span> <span class=skolem>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_L<span class=main>:</span> <span class=quoted><span class=quoted>"args_L <span class=skolem>args</span> <span class=main>=</span> Formula.fv <span class=skolem>φ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> args_R<span class=main>:</span> <span class=quoted><span class=quoted>"args_R <span class=skolem>args</span> <span class=main>=</span> Formula.fv <span class=skolem>ψ''</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> length_aux<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux</span> <span class=main>=</span>
      min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ''</span> <span class=free>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> args_pos<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=skolem>args</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> φ'''<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ'''</span> <span class=skolem>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=skolem>j</span>"</span></span>  <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=skolem>j</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=skolem>j</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>j</span>
    <span class=keyword1><span class=command>using</span></span> pos <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> progress.simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> MUntil.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> nts_snoc<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span>
    <span class=main>[</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>φ''</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>ψ''</span> <span class=free>j</span><span class=main>)</span><span class=main>..&lt;</span>Suc <span class=free>j</span><span class=main>]</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nts <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_envs_progress_le<span class=main><span class=main>[</span></span><span class=operator>THEN</span> min.coboundedI1<span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all2_appendI<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span> <span class=skolem>ys</span> <span class=skolem>zs</span> <span class=skolem>aux'</span> <span class=skolem>aux''</span> <span class=skolem>buf'</span> <span class=skolem>nts'</span>
    <span class=keyword3><span class=command>assume</span></span> eval_φ<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>φ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>xs</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eval_ψ<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span> <span class=skolem>ψ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>ys</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eq1<span class=main>:</span> <span class=quoted><span class=quoted>"mbuf2t_take <span class=main>(</span><span class=free>add_new_muaux</span> <span class=skolem>args</span><span class=main>)</span> <span class=skolem>aux</span> <span class=main>(</span>mbuf2_add <span class=skolem>xs</span> <span class=skolem>ys</span> <span class=skolem>buf</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span>
        <span class=main>(</span><span class=skolem>aux'</span><span class=main>,</span> <span class=skolem>buf'</span><span class=main>,</span> <span class=skolem>nts'</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eq2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>eval_muaux</span> <span class=skolem>args</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=skolem>aux'</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux''</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>ne</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ne</span> <span class=main>≡</span> progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> update1<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>R</span> <span class=skolem>args</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>aux'</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>∧</span>
      <span class=skolem>ne</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux'</span> <span class=main>=</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> MUntil.IH<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> φ MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> eval_φ MUntil.IH<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> ψ MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
        eval_ψ nts_snoc nts_snoc length_aux aux fvi_subset
      <span class=keyword1><span class=command>unfolding</span></span> φ'''
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>elim</span> mbuf2t_take_add_induct'<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> j'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> eq1 wf_envs_P_simps<span class=main><span class=main>[</span></span><span class=operator>OF</span> MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span> buf<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_n args_L args_R ne_def wf_update_until<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>cur</span></span> <span class=skolem><span class=skolem>auxlist'</span></span> <span class=keyword2><span class=keyword>where</span></span> valid_aux'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=skolem>args</span> <span class=skolem>cur</span> <span class=skolem>aux'</span> <span class=skolem>auxlist'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
      cur<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>ne</span> <span class=main>+</span> length <span class=skolem>auxlist'</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span><span class=skolem>ne</span> <span class=main>+</span> length <span class=skolem>auxlist'</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
      wf_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>pos</span> <span class=skolem>φ''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span> <span class=skolem>auxlist'</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def ne_def args_ivl args_n args_pos <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> length_aux'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux'</span> <span class=main>=</span> length <span class=skolem>auxlist'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_length_muaux<span class=main>[</span><span class=operator>OF</span> valid_aux'<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> nts'<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>nts'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> MUntil.IH<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> φ MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> eval_φ MUntil.IH<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> ψ MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
        MUntil.prems<span class=main>(</span>2<span class=main>)</span> eval_ψ nts_snoc
      <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> mbuf2t_take_eqD<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> eq1<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> wf_mbuf2_add buf<span class=main><span class=main>[</span></span><span class=operator>unfolded</span> wf_mbuf2'_def<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>zs''</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>zs''</span> <span class=main>=</span> fst <span class=main>(</span>eval_until <span class=skolem>I</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=skolem>auxlist'</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>auxlist''</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>auxlist''</span> <span class=main>=</span> snd <span class=main>(</span>eval_until <span class=skolem>I</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=skolem>auxlist'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> current_w_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>≤</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>nts'</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>have</span></span> p_le<span class=main>:</span> <span class=quoted><span class=quoted>"min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>≤</span> <span class=free>j</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> MUntil.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> min_def le_diff_conv<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> cur conjunct2<span class=main>[</span><span class=operator>OF</span> update1<span class=main>,</span> <span class=operator>unfolded</span> length_aux'<span class=main>]</span>
        <span class=keyword1><span class=command>using</span></span> Nil <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>nt</span> <span class=skolem>x</span><span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> progress_φ'''<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> pos <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> progress.simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nt</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=main>(</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> nts'<span class=main>[</span><span class=operator>unfolded</span> wf_ts_def Cons<span class=main>]</span>
        <span class=keyword1><span class=command>unfolding</span></span> list_all2_Cons2 upt_eq_Cons_conv <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> cur conjunct2<span class=main>[</span><span class=operator>OF</span> update1<span class=main>,</span> <span class=operator>unfolded</span> length_aux'<span class=main>]</span> Cons progress_φ'''
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits list.splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> τ_mono<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>have</span></span> valid_aux''<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>valid_muaux</span> <span class=skolem>args</span> <span class=skolem>cur</span> <span class=skolem>aux''</span> <span class=skolem>auxlist''</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_eval_muaux<span class=main>[</span><span class=operator>OF</span> valid_aux' current_w_le eq2<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>zs''</span></span> <span class=quoted><span class=skolem>auxlist''</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> args_ivl zs''_def auxlist''_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> length_aux''<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux''</span> <span class=main>=</span> length <span class=skolem>auxlist''</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_length_muaux<span class=main>[</span><span class=operator>OF</span> valid_aux''<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> eq2'<span class=main>:</span> <span class=quoted><span class=quoted>"eval_until <span class=skolem>I</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=skolem>auxlist'</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>auxlist''</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_eval_muaux<span class=main>[</span><span class=operator>OF</span> valid_aux' current_w_le eq2<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>zs''</span></span> <span class=quoted><span class=skolem>auxlist''</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> args_ivl zs''_def auxlist''_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> length_aux'_aux''<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux'</span> <span class=main>=</span> length <span class=skolem>zs</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux''</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> eval_until_length<span class=main>[</span><span class=operator>OF</span> eq2'<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> length_aux' length_aux'' <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
      wf_until_auxlist <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>pos</span> <span class=skolem>φ''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span> <span class=skolem>auxlist'</span> <span class=skolem>i</span> <span class=main>⟹</span>
      <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>auxlist'</span> <span class=main>=</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
      wf_until_auxlist <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>pos</span> <span class=skolem>φ''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span> <span class=skolem>auxlist''</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
        <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>zs</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>∧</span>
        <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>zs</span> <span class=main>+</span> length <span class=skolem>auxlist''</span> <span class=main>=</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
        list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>Formula.fv <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span>
          <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=main>(</span>Formula.Until <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> <span class=skolem>φ''</span> <span class=keyword1>else</span> Formula.Neg <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
          <span class=main>[</span><span class=skolem>i</span><span class=main>..&lt;</span><span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>zs</span><span class=main>]</span> <span class=skolem>zs</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
      <span class=keyword1><span class=command>using</span></span> eq2'
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>auxlist'</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>zs</span></span> <span class=quoted><span class=skolem>auxlist''</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> antisym<span class=main><span class=main>[</span></span><span class=operator>OF</span> progress_Until_le<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>aux'</span><span class=main>)</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>a1</span></span> <span class=skolem><span class=skolem>a2</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a2</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> aux'<span class=main>:</span> <span class=quoted><span class=quoted>"wf_until_auxlist <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>pos</span> <span class=skolem>φ''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span> <span class=skolem>aux'</span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wf_until_aux_Cons<span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=skolem>i</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a2</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wf_until_aux_Cons1<span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=skolem>n</span> <span class=main>(</span>Formula.fv <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>j</span></span><span class=main>≥</span><span class=skolem>i</span><span class=main>.</span> <span class=bound>j</span> <span class=main>&lt;</span> Suc <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>aux'</span><span class=main>)</span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span> <span class=skolem>I</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>j</span> <span class=skolem>ψ''</span> <span class=main>∧</span>
        <span class=main>(</span><span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=main>{</span><span class=skolem>i</span><span class=main>..&lt;</span><span class=bound>j</span><span class=main>}</span><span class=main>.</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=skolem>φ''</span> <span class=keyword1>else</span> <span class=main>¬</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>k</span> <span class=skolem>φ''</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>a2</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a2</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wf_until_aux_Cons3<span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> Suc_i_aux'<span class=main>:</span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>aux'</span> <span class=main>=</span>
          min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≥</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"enat <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=main>≤</span> enat <span class=skolem>t</span> <span class=main>+</span> right <span class=skolem>I</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> that nts' <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def progress.simps
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv φ'''
            <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_lower τ_mono <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits list.splits<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"enat <span class=skolem>t</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> that <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m<span class=main>:</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>m</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> τ_min<span class=main>:</span>  <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span>min <span class=free>j</span> <span class=skolem>k</span><span class=main>)</span> <span class=main>=</span> min <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>k</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> min_of_mono monoI<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> le_progress_iff<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>⟷</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ</span>
          <span class=keyword1><span class=command>using</span></span> wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> MUntil.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>φ</span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> min_Suc<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"min <span class=free>j</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span> <span class=free>j</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?X</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=main>∀</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span> <span class=main>&lt;</span> Suc <span class=free>j</span> <span class=main>∧</span> <span class=bound>k</span> <span class=main>≤</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> enat <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>k</span><span class=main>)</span> <span class=main>≤</span> enat <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>+</span> right <span class=skolem>I</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?min</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"min <span class=free>j</span> <span class=main>(</span>min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=var>?min</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>j</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> τ_mono<span class=main>)</span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>from</span></span> m <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?X</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> τ_mono<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>σ</span></span><span class=main><span class=main>]</span></span>
              <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_le not_less φ''' <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> m <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> that nts' <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def progress.simps
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> cInf_greatest<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?X</span> <span class=main>≠</span> <span class=main>{}</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
            <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> 1 φ''' not_le not_less list_all2_Cons2 upt_eq_Cons_conv less_Suc_eq
              <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits
              <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=var>?min</span>"</span></span><span class=main><span class=main>]</span></span> less_le_trans<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>m</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>_</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>_</span> <span class=main>+</span> <span class=skolem>m</span>"</span></span><span class=main><span class=main>]</span></span> less_τD<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span>
        <span class=quoted><span class=quoted>"enat <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"enat <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>≤</span> right <span class=skolem>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ψ</span> <span class=main>=</span> <span class=skolem>ψ''</span> <span class=main>∨</span> <span class=skolem>ψ</span> <span class=main>=</span> <span class=skolem>φ''</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span> <span class=skolem>ψ</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> that<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>m</span>"</span></span>
          <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>m</span> <span class=main>&lt;</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>≤</span> <span class=skolem>m</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>with</span></span> that<span class=main>(</span>3<span class=main>)</span> nts' progress_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=skolem>ψ''</span></span> <span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span><span class=main>]</span> progress_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=skolem>φ''</span></span> <span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span><span class=main>]</span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> wf_ts_def le_diff_conv
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_le list_all2_Cons2 upt_eq_Cons_conv less_Suc_eq add.commute
              <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_less_trans<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span>"</span></span><span class=main><span class=main>]</span></span> less_τD<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Cons.prems Suc_i_aux'<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a2</span><span class=main>)</span>›</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> φ''' 1 sat.simps upt_conv_Cons <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span>  Cons.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ aux' Suc_i_aux'<span class=main><span class=main>]</span></span>
            <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> iff_exI qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> 3 refl<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>thm</span></span> this
    <span class=keyword1><span class=command>note</span></span> wf_aux'' <span class=main>=</span> this<span class=main>[</span><span class=operator>OF</span> wf_envs_progress_mono<span class=main><span class=main>[</span></span><span class=operator>OF</span> MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> le_SucI<span class=main><span class=main>[</span></span><span class=operator>OF</span> order_refl<span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span>
      wf_auxlist' conjunct2<span class=main><span class=main>[</span></span><span class=operator>OF</span> update1<span class=main><span class=main>,</span></span> <span class=operator>unfolded</span> ne_def length_aux'<span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=skolem>auxlist'</span> <span class=main>=</span>
      progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>+</span> length <span class=skolem>auxlist''</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> wf_aux'' valid_aux'' length_aux'_aux''
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ne_def length_aux' length_aux''<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>cur</span> <span class=main>=</span>
      <span class=main>(</span><span class=keyword1>if</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>+</span> length <span class=skolem>auxlist''</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>0</span>
      <span class=keyword1>else</span> τ <span class=free>σ</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>+</span> length <span class=skolem>auxlist''</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> cur ne_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_until_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>R</span> <span class=skolem>args</span> <span class=skolem>φ''</span> <span class=skolem>ψ''</span> <span class=skolem>aux''</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
      progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=skolem>zs</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>∧</span>
      progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=skolem>zs</span> <span class=main>+</span> <span class=free>length_muaux</span> <span class=skolem>args</span> <span class=skolem>aux''</span> <span class=main>=</span> min <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ'''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>ψ''</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
      list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>fv <span class=skolem>ψ''</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=main>(</span>formula.Until <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> <span class=skolem>φ''</span> <span class=keyword1>else</span> formula.Neg <span class=skolem>φ''</span><span class=main>)</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>formula.Until <span class=skolem>φ'''</span> <span class=skolem>I</span> <span class=skolem>ψ''</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=skolem>zs</span><span class=main>]</span> <span class=skolem>zs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> wf_aux'' valid_aux'' fvi_subset
      <span class=keyword1><span class=command>unfolding</span></span> wf_until_aux_def length_aux'' args_ivl args_n args_pos <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> length_aux''<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> update <span class=main>=</span> this
  <span class=keyword1><span class=command>from</span></span> MUntil.IH<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> φ MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> MUntil.IH<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> ψ MUntil.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> pos pos_eq fvi_subset <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 4 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> args_ivl args_n args_pos Until_eq φ''' progress.simps<span class=main><span class=main>(</span></span>6<span class=main><span class=main>)</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split if_splits
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> update<span class=main><span class=main>[</span></span><span class=operator>OF</span> refl refl<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.Until<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ _ _ args_ivl args_n args_L args_R fvi_subset<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong qtable_cong
        <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> mbuf2t_take_add'<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MUntil.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> buf nts_snoc<span class=main><span class=main>]</span></span>
              mbuf2t_take_add'<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MUntil.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> buf nts_snoc<span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MMatchP <span class=skolem>I</span> <span class=skolem>mr</span> <span class=skolem>mrs</span> <span class=skolem>φs</span> <span class=skolem>buf</span> <span class=skolem>nts</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> sat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span> mbufnt_take.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> mbufn_add.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> MMatchP.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=skolem><span class=skolem>ψs</span></span> <span class=keyword2><span class=keyword>where</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> Formula.MatchP <span class=skolem>I</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Past Strict <span class=skolem>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=skolem>r</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>mr</span><span class=main>,</span> <span class=skolem>ψs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>RPDs <span class=skolem>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ψs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span>wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span><span class=main>)</span> <span class=skolem>φs</span> <span class=skolem>ψs</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbufn' <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=free>j</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>r</span> <span class=skolem>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nts<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts_regex <span class=free>σ</span> <span class=skolem>P</span> <span class=free>j</span> <span class=skolem>r</span> <span class=skolem>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchP_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=skolem>aux</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> nts_snoc<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>[</span>progress_regex <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>r</span> <span class=free>j</span><span class=main>..&lt;</span>Suc <span class=free>j</span><span class=main>]</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nts <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_envs_progress_regex_le<span class=main><span class=main>[</span></span><span class=operator>OF</span> MMatchP.prems<span class=main><span class=main><span class=main><span class=main>(</span></span></span></span>2<span class=main><span class=main><span class=main><span class=main>)</span></span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all2_appendI<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> update<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchP_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=main>(</span>snd <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>Formula.fv_regex <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=main>(</span>Formula.MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=free>j</span><span class=main>..&lt;</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchP <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>]</span> <span class=main>(</span>fst <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> eval<span class=main>:</span> <span class=quoted><span class=quoted>"map <span class=main>(</span>fst <span class=keyword1>o</span> meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span><span class=main>)</span> <span class=skolem>φs</span> <span class=main>=</span> <span class=skolem>xss</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"mbufnt_take <span class=main>(</span><span class=main>λ</span><span class=bound>rels</span> <span class=bound>t</span> <span class=main>(</span><span class=bound>zs</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span><span class=main>.</span>
        <span class=keyword1>case</span> update_matchP <span class=skolem>n</span> <span class=skolem>I</span> <span class=skolem>mr</span> <span class=skolem>mrs</span> <span class=bound>rels</span> <span class=bound>t</span> <span class=bound>aux</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>z</span><span class=main>,</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>zs</span> <span class=main>@</span> <span class=main>[</span><span class=bound>z</span><span class=main>]</span><span class=main>,</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=skolem>aux</span><span class=main>)</span> <span class=main>(</span>mbufn_add <span class=skolem>xss</span> <span class=skolem>buf</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span><span class=main>,</span> <span class=skolem>buf'</span><span class=main>,</span> <span class=skolem>nts'</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>xss</span> <span class=skolem>zs</span> <span class=skolem>aux'</span> <span class=skolem>buf'</span> <span class=skolem>nts'</span>
    <span class=keyword1><span class=command>unfolding</span></span> progress_simps
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> mbufnt_take_add_induct'<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> j'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> z'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux'</span><span class=main>)</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> eq wf_envs_P_simps<span class=main><span class=main>[</span></span><span class=operator>OF</span> MMatchP.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span> safe mr buf nts_snoc<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
      <span class=operator>goal_cases</span> xss _ base step<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> xss
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>using</span></span> eval ψs
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map
          list.rel_flip<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>ψs</span></span> <span class=quoted><span class=skolem>φs</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MMatchP.IH<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MMatchP.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> base
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>using</span></span> aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>step <span class=skolem>k</span> <span class=skolem>Xs</span> <span class=skolem>z</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Un_absorb1 mrs safe mr <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> update_matchP<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> list_all2_appendI
          <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> update_matchP<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.split<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ψs
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eq mr mrs safe map_split_alt list.rel_flip<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>ψs</span></span> <span class=quoted><span class=skolem>φs</span></span><span class=main><span class=main>]</span></span>
        list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.intros
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong mbufnt_take_add'<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MMatchP.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> safe mr buf nts_snoc<span class=main><span class=main>]</span></span>
        mbufnt_take_add'<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MMatchP.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> safe mr buf nts_snoc<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MMatchP.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MMatchP.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>MMatchF <span class=skolem>I</span> <span class=skolem>mr</span> <span class=skolem>mrs</span> <span class=skolem>φs</span> <span class=skolem>buf</span> <span class=skolem>nts</span> <span class=skolem>aux</span><span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> sat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span> mbufnt_take.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> mbufn_add.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> progress_simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span>
  <span class=keyword1><span class=command>from</span></span> MMatchF.prems <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=skolem><span class=skolem>ψs</span></span> <span class=keyword2><span class=keyword>where</span></span> eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>φ'</span> <span class=main>=</span> Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> safe<span class=main>:</span> <span class=quoted><span class=quoted>"safe_regex Futu Strict <span class=skolem>r</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mr<span class=main>:</span> <span class=quoted><span class=quoted>"to_mregex <span class=skolem>r</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>mr</span><span class=main>,</span> <span class=skolem>ψs</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> mrs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>mrs</span> <span class=main>=</span> sorted_list_of_set <span class=main>(</span>LPDs <span class=skolem>mr</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> ψs<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span>wf_mformula <span class=free>σ</span> <span class=free>j</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span><span class=main>)</span> <span class=skolem>φs</span> <span class=skolem>ψs</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> buf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mbufn' <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>V</span> <span class=free>j</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>r</span> <span class=skolem>buf</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nts<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts_regex <span class=free>σ</span> <span class=skolem>P</span> <span class=free>j</span> <span class=skolem>r</span> <span class=skolem>nts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=skolem>aux</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>0</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> length_aux<span class=main>:</span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=skolem>aux</span> <span class=main>=</span> progress_regex <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>r</span> <span class=free>j</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_mformula.cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> nts_snoc<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span> <span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span>
    <span class=main>[</span>progress_regex <span class=free>σ</span> <span class=skolem>P</span> <span class=skolem>r</span> <span class=free>j</span><span class=main>..&lt;</span>Suc <span class=free>j</span><span class=main>]</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nts <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_envs_progress_regex_le<span class=main><span class=main>[</span></span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main><span class=main><span class=main>(</span></span></span></span>2<span class=main><span class=main><span class=main><span class=main>)</span></span></span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> list_all2_appendI<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xss</span> <span class=skolem>zs</span> <span class=skolem>aux'</span> <span class=skolem>aux''</span> <span class=skolem>buf'</span> <span class=skolem>nts'</span>
    <span class=keyword3><span class=command>assume</span></span> eval<span class=main>:</span> <span class=quoted><span class=quoted>"map <span class=main>(</span>fst <span class=keyword1>o</span> meval <span class=skolem>n</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=skolem>db</span><span class=main>)</span> <span class=skolem>φs</span> <span class=main>=</span> <span class=skolem>xss</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eq1<span class=main>:</span> <span class=quoted><span class=quoted>"mbufnt_take <span class=main>(</span>update_matchF <span class=skolem>n</span> <span class=skolem>I</span> <span class=skolem>mr</span> <span class=skolem>mrs</span><span class=main>)</span> <span class=skolem>aux</span> <span class=main>(</span>mbufn_add <span class=skolem>xss</span> <span class=skolem>buf</span><span class=main>)</span> <span class=main>(</span><span class=skolem>nts</span> <span class=main>@</span> <span class=main>[</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span>
        <span class=main>(</span><span class=skolem>aux'</span><span class=main>,</span> <span class=skolem>buf'</span><span class=main>,</span> <span class=skolem>nts'</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> eq2<span class=main>:</span> <span class=quoted><span class=quoted>"eval_matchF <span class=skolem>I</span> <span class=skolem>mr</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=skolem>aux'</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>zs</span><span class=main>,</span> <span class=skolem>aux''</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> update1<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=skolem>aux'</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=free>j</span><span class=main>)</span> <span class=main>0</span> <span class=main>∧</span>
      progress <span class=free>σ</span> <span class=skolem>P</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=free>j</span> <span class=main>+</span> length <span class=skolem>aux'</span> <span class=main>=</span> progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> eval nts_snoc nts_snoc length_aux aux ψs
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>elim</span> mbufnt_take_add_induct'<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> j'<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"Suc <span class=free>j</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> eq1 wf_envs_P_simps<span class=main><span class=main>[</span></span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span> safe mr buf<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> length_update_matchF
          list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map list.rel_flip<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>ψs</span></span> <span class=quoted><span class=skolem>φs</span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MMatchF.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span>
          <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> wf_update_matchF<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ safe mr mrs<span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> MMatchF.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> nts'<span class=main>:</span> <span class=quoted><span class=quoted>"wf_ts_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=skolem>r</span> <span class=skolem>nts'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> eval eval nts_snoc ψs
      <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> mbufnt_take_eqD<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> eq1 wf_mbufn_add<span class=main><span class=main><span class=main>[</span></span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> js'<span class=main><span class=main><span class=main><span class=main>=</span></span></span></span><span class=quoted><span class=quoted>"map <span class=main>(</span><span class=main>λ</span><span class=bound>φ</span><span class=main>.</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=bound>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=skolem>ψs</span>"</span></span><span class=main><span class=main><span class=main>,</span></span></span>
              <span class=operator>OF</span> buf<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>unfolded</span> wf_mbufn'_def mr prod.case<span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> to_mregex_progress<span class=main><span class=main>[</span></span><span class=operator>OF</span> safe mr<span class=main><span class=main>]</span></span> Mini_def
          list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map list.rel_flip<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>ψs</span></span> <span class=quoted><span class=skolem>φs</span></span><span class=main><span class=main>]</span></span>
          list_all2_Cons1 <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_refl_strong
          <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MMatchF.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
      wf_matchF_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=skolem>aux'</span> <span class=skolem>i</span> <span class=main>0</span> <span class=main>⟹</span>
      <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>aux'</span> <span class=main>=</span> progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>⟹</span>
      wf_matchF_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=skolem>aux''</span> <span class=main>(</span>progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span> <span class=main>0</span> <span class=main>∧</span>
        <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>zs</span> <span class=main>=</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>∧</span>
        <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>zs</span> <span class=main>+</span> length <span class=skolem>aux''</span> <span class=main>=</span> progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>∧</span>
        list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=skolem>n</span> <span class=main>(</span>Formula.fv_regex <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span>
          <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
          <span class=main>[</span><span class=skolem>i</span><span class=main>..&lt;</span><span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>zs</span><span class=main>]</span> <span class=skolem>zs</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
      <span class=keyword1><span class=command>using</span></span> eq2
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>aux'</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>zs</span></span> <span class=quoted><span class=skolem>aux''</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> antisym<span class=main><span class=main>[</span></span><span class=operator>OF</span> progress_MatchF_le<span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>aux'</span><span class=main>)</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>rels</span></span> <span class=skolem><span class=skolem>rel</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>rels</span><span class=main>,</span> <span class=skolem>rel</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> aux'<span class=main>:</span> <span class=quoted><span class=quoted>"wf_matchF_aux <span class=free>σ</span> <span class=skolem>V</span> <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>I</span> <span class=skolem>r</span> <span class=skolem>aux'</span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span> <span class=main>0</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wf_matchF_aux_Cons<span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> τ <span class=free>σ</span> <span class=skolem>i</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>rels</span><span class=main>,</span> <span class=skolem>rel</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wf_matchF_aux_Cons1<span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"qtable <span class=skolem>n</span> <span class=main>(</span>Formula.fv_regex <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>j</span></span><span class=main>≥</span><span class=skolem>i</span><span class=main>.</span> <span class=bound>j</span> <span class=main>&lt;</span> Suc <span class=main>(</span><span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>aux'</span><span class=main>)</span> <span class=main>∧</span> mem <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>j</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span> <span class=skolem>I</span> <span class=main>∧</span> Regex.match <span class=main>(</span>Formula.sat <span class=free>σ</span> <span class=skolem>V</span> <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=skolem>r</span> <span class=skolem>i</span> <span class=bound>j</span><span class=main>)</span><span class=main>)</span> <span class=skolem>rel</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>rels</span><span class=main>,</span> <span class=skolem>rel</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>using</span></span> wf_matchF_aux_Cons3 <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>from</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> Suc_i_aux'<span class=main>:</span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>+</span> length <span class=skolem>aux'</span> <span class=main>=</span> progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>≥</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"enat <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span> <span class=main>≤</span> enat <span class=skolem>t</span> <span class=main>+</span> right <span class=skolem>I</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> that nts' <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def progress_simps
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv
            <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> cInf_lower τ_mono <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits list.splits<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Suc <span class=skolem>i</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=main>(</span>Formula.MatchF <span class=skolem>I</span> <span class=skolem>r</span><span class=main>)</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"enat <span class=skolem>t</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> that <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m<span class=main>:</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>m</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> τ_min<span class=main>:</span>  <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span>min <span class=free>j</span> <span class=skolem>k</span><span class=main>)</span> <span class=main>=</span> min <span class=main>(</span>τ <span class=free>σ</span> <span class=free>j</span><span class=main>)</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>k</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> min_of_mono monoI<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> le_progress_iff<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"Suc <span class=free>j</span> <span class=main>≤</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>⟷</span> progress <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>φ</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>φ</span>
          <span class=keyword1><span class=command>using</span></span> wf_envs_progress_le<span class=main>[</span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>φ</span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> min_Suc<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"min <span class=free>j</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>=</span> <span class=free>j</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?X</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=main>∀</span><span class=bound>k</span><span class=main>.</span> <span class=bound>k</span> <span class=main>&lt;</span> Suc <span class=free>j</span> <span class=main>∧</span> <span class=bound>k</span> <span class=main>≤</span> progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span> <span class=main>⟶</span> enat <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>k</span><span class=main>)</span> <span class=main>≤</span> enat <span class=main>(</span>τ <span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>+</span> right <span class=skolem>I</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?min</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"min <span class=free>j</span> <span class=main>(</span>progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=var>?min</span> <span class=main>≤</span> τ <span class=free>σ</span> <span class=free>j</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> τ_mono<span class=main>)</span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>from</span></span> m <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?X</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> less_τD add_lessD1 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_le not_less<span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> m <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> that nts' wf_envs_progress_regex_le<span class=main>[</span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>r</span></span></span></span><span class=main>]</span>
          <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def progress_simps
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> cInf_greatest<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?X</span> <span class=main>≠</span> <span class=main>{}</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
            <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> 1 not_le not_less list_all2_Cons2 upt_eq_Cons_conv less_Suc_eq
              <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits
              <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=var>?min</span>"</span></span><span class=main><span class=main>]</span></span> less_le_trans<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>m</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>_</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>_</span> <span class=main>+</span> <span class=skolem>m</span>"</span></span><span class=main><span class=main>]</span></span> less_τD<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> *<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span> <span class=main>&lt;</span> progress_regex <span class=free>σ</span> <span class=skolem>P'</span> <span class=skolem>r</span> <span class=main>(</span>Suc <span class=free>j</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span>
        <span class=quoted><span class=quoted>"enat <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"enat <span class=main>(</span>τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>≤</span> right <span class=skolem>I</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> that<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>=</span> enat <span class=skolem>m</span>"</span></span>
          <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>+</span> <span class=skolem>m</span> <span class=main>&lt;</span> <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>nts'</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> τ <span class=free>σ</span> <span class=free>j</span> <span class=main>|</span> <span class=bound>nt</span> <span class=main>#</span> <span class=bound>x</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span> <span class=main>-</span> τ <span class=free>σ</span> <span class=skolem>i</span> <span class=main>≤</span> <span class=skolem>m</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>with</span></span> nts' wf_envs_progress_regex_le<span class=main>[</span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>r</span></span></span></span><span class=main>]</span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> wf_ts_regex_def le_diff_conv
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> not_le list_all2_Cons2 upt_eq_Cons_conv less_Suc_eq add.commute
              <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> le_less_trans<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=skolem>k</span>"</span></span><span class=main><span class=main>]</span></span> less_τD<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Cons.prems Suc_i_aux'<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span>
        <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>rels</span><span class=main>,</span> <span class=skolem>rel</span><span class=main>)</span>›</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> 1 sat.simps upt_conv_Cons <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span>  Cons.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ aux' Suc_i_aux'<span class=main><span class=main>]</span></span>
            <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> upt_Suc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits prod.splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> iff_exI qtable_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> 3 refl<span class=main><span class=main>]</span></span><span class=main>)</span>

    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>note</span></span> this<span class=main>[</span><span class=operator>OF</span> progress_mono_gen<span class=main><span class=main>[</span></span><span class=operator>OF</span> le_SucI<span class=main><span class=main>,</span></span> <span class=operator>OF</span> order.refl<span class=main><span class=main>]</span></span> conjunct1<span class=main><span class=main>[</span></span><span class=operator>OF</span> update1<span class=main><span class=main>]</span></span> conjunct2<span class=main><span class=main>[</span></span><span class=operator>OF</span> update1<span class=main><span class=main>]</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> update <span class=main>=</span> this<span class=main>[</span><span class=operator>OF</span> refl<span class=main>,</span> <span class=operator>rotated</span><span class=main>]</span>
  <span class=keyword1><span class=command>with</span></span> MMatchF.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ψs
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> eq mr mrs safe map_split_alt list.rel_flip<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>ψs</span></span> <span class=quoted><span class=skolem>φs</span></span><span class=main><span class=main>]</span></span>
        list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mformula.intros
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list.rel_mono_strong mbufnt_take_add'<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> safe mr buf nts_snoc<span class=main><span class=main>]</span></span>
        mbufnt_take_add'<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_P_simps<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>OF</span> MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main><span class=main>]</span></span></span> safe mr buf nts_snoc<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> MMatchF.IH<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ MMatchF.prems<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span> update <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Monitor step›</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> wf_mstate_mstep<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mstate <span class=free>φ</span> <span class=free>π</span> <span class=free>R</span> <span class=free>st</span> <span class=main>⟹</span> last_ts <span class=free>π</span> <span class=main>≤</span> snd <span class=free>tdb</span> <span class=main>⟹</span>
  wf_mstate <span class=free>φ</span> <span class=main>(</span>psnoc <span class=free>π</span> <span class=free>tdb</span><span class=main>)</span> <span class=free>R</span> <span class=main>(</span>snd <span class=main>(</span>mstep <span class=main>(</span>map_prod mk_db id <span class=free>tdb</span><span class=main>)</span> <span class=free>st</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> wf_mstate_def mstep_def Let_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> progress_mono le_imp_diff_is_add <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits
      <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> prefix_of_psnocE <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> meval<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ wf_envs_mk_db<span class=main><span class=main>]</span></span> list_all2_lengthD<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>flatten_verdicts</span> <span class=free><span class=bound><span class=entity>Vs</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span>set <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>i</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=bound>i</span><span class=main>,</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=bound>X</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>Vs</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> flatten_verdicts_append<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"flatten_verdicts <span class=main>(</span><span class=free>Vs</span> <span class=main>@</span> <span class=free>Us</span><span class=main>)</span> <span class=main>=</span> flatten_verdicts <span class=free>Vs</span> <span class=main>∪</span> flatten_verdicts <span class=free>Us</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>Vs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> flatten_verdicts_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> maux<span class=main>)</span> mstep_output_iff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mstate <span class=free>φ</span> <span class=free>π</span> <span class=free>R</span> <span class=free>st</span>"</span></span> <span class=quoted><span class=quoted>"last_ts <span class=free>π</span> <span class=main>≤</span> snd <span class=free>tdb</span>"</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=main>(</span>psnoc <span class=free>π</span> <span class=free>tdb</span><span class=main>)</span> <span class=free>σ</span>"</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=free>v</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> flatten_verdicts <span class=main>(</span>fst <span class=main>(</span>mstep <span class=main>(</span>map_prod mk_db id <span class=free>tdb</span><span class=main>)</span> <span class=free>st</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
    progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>≤</span> <span class=free>i</span> <span class=main>∧</span> <span class=free>i</span> <span class=main>&lt;</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>Suc <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    wf_tuple <span class=main>(</span>Formula.nfv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>Formula.fv <span class=free>φ</span><span class=main>)</span> <span class=free>v</span> <span class=main>∧</span> Formula.sat <span class=free>σ</span> Map.empty <span class=main>(</span>map the <span class=free>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> prefix_of_psnocE<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=free>σ</span>"</span></span>
    <span class=quoted><span class=quoted>"Γ <span class=free>σ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>=</span> fst <span class=free>tdb</span>"</span></span> <span class=quoted><span class=quoted>"τ <span class=free>σ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>=</span> snd <span class=free>tdb</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>‹prefix_of <span class=free>π</span> <span class=free>σ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"mstate_n <span class=free>st</span> <span class=main>=</span> Formula.nfv <span class=free>φ</span>"</span></span>
    <span class=quoted><span class=quoted>"mstate_i <span class=free>st</span> <span class=main>=</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> Map.empty Map.empty <span class=main>(</span>mstate_n <span class=free>st</span><span class=main>)</span> <span class=free>R</span> <span class=main>(</span>mstate_m <span class=free>st</span><span class=main>)</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_mstate_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> meval<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹wf_mformula <span class=free>σ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> Map.empty Map.empty <span class=main>(</span>mstate_n <span class=free>st</span><span class=main>)</span> <span class=free>R</span> <span class=main>(</span>mstate_m <span class=free>st</span><span class=main>)</span> <span class=free>φ</span>›</span></span> wf_envs_mk_db<span class=main>]</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>Vs</span></span> <span class=skolem><span class=skolem>st'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"meval <span class=main>(</span>mstate_n <span class=free>st</span><span class=main>)</span> <span class=main>(</span>τ <span class=free>σ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>mk_db <span class=main>(</span>Γ <span class=free>σ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>mstate_m <span class=free>st</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>Vs</span><span class=main>,</span> <span class=skolem>st'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"wf_mformula <span class=free>σ</span> <span class=main>(</span>Suc <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span>  Map.empty Map.empty <span class=main>(</span>mstate_n <span class=free>st</span><span class=main>)</span> <span class=free>R</span> <span class=skolem>st'</span> <span class=free>φ</span>"</span></span>
    <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> qtable <span class=main>(</span>mstate_n <span class=free>st</span><span class=main>)</span> <span class=main>(</span>fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> Map.empty <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=bound>i</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>
      <span class=main>[</span>progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>..&lt;</span>progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>Suc <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>]</span> <span class=skolem>Vs</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this assms<span class=main>(</span>4<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"qtable <span class=main>(</span>mstate_n <span class=free>st</span><span class=main>)</span> <span class=main>(</span>fv <span class=free>φ</span><span class=main>)</span> <span class=main>(</span>mem_restr <span class=free>R</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> Formula.sat <span class=free>σ</span> Map.empty <span class=main>(</span>map the <span class=bound>v</span><span class=main>)</span> <span class=free>i</span> <span class=free>φ</span><span class=main>)</span> <span class=main>(</span><span class=skolem>Vs</span> <span class=main>!</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=main>≤</span> <span class=free>i</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>Suc <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_conv_all_nth
        <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>i</span> <span class=main>-</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> mstep_def Let_def flatten_verdicts_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_enumerate_eq list_all2_conv_all_nth progress_mono le_imp_diff_is_add
        <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_qtableE in_qtableI <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=skolem>Vs</span> <span class=main>!</span> <span class=main>(</span><span class=free>i</span> <span class=main>-</span> progress <span class=free>σ</span> Map.empty <span class=free>φ</span> <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>‹Monitor function›</span></span>

<span class=keyword1><span class=command>locale</span></span> verimon <span class=main>=</span> verimon_spec <span class=main>+</span> maux

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> verimon<span class=main>)</span> mstep_mverdicts<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> wf<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mstate <span class=free>φ</span> <span class=free>π</span> <span class=free>R</span> <span class=free>st</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> le<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"last_ts <span class=free>π</span> <span class=main>≤</span> snd <span class=free>tdb</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> restrict<span class=main>:</span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=free>v</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> flatten_verdicts <span class=main>(</span>fst <span class=main>(</span>mstep <span class=main>(</span>map_prod mk_db id <span class=free>tdb</span><span class=main>)</span> <span class=free>st</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
    <span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> M <span class=main>(</span>psnoc <span class=free>π</span> <span class=free>tdb</span><span class=main>)</span> <span class=main>-</span> M <span class=free>π</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span> p2<span class=main>:</span> <span class=quoted><span class=quoted>"prefix_of <span class=main>(</span>psnoc <span class=free>π</span> <span class=free>tdb</span><span class=main>)</span> <span class=skolem>σ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ex_prefix_of <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> le <span class=keyword1><span class=command>have</span></span> p1<span class=main>:</span> <span class=quoted><span class=quoted>"prefix_of <span class=free>π</span> <span class=skolem>σ</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> prefix_of_psnocE<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> M_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> p2 progress_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ p1<span class=main><span class=main>]</span></span> sat_prefix_conv<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ p1<span class=main><span class=main>]</span></span> not_less
        pprogress_eq<span class=main><span class=main>[</span></span><span class=operator>OF</span> p1<span class=main><span class=main>]</span></span> pprogress_eq<span class=main><span class=main>[</span></span><span class=operator>OF</span> p2<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> mstep_output_iff<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf le p2 restrict<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span> spec<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>σ</span></span><span class=main><span class=main>]</span></span>
        mstep_output_iff<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf le _ restrict<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span> progress_sat_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> p1<span class=main><span class=main>]</span></span>
        <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> mstep_output_iff<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf le p2 restrict<span class=main><span class=main>,</span></span> <span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span> p1<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>context</span></span> maux
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>msteps0</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>msteps0</span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>msteps0</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tdb</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>π</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>V'</span><span class=main>,</span> <span class=bound>st'</span><span class=main>)</span> <span class=main>=</span> mstep <span class=main>(</span>map_prod mk_db id <span class=free><span class=bound><span class=entity>tdb</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>st</span></span></span><span class=main>;</span> <span class=main>(</span><span class=bound>V''</span><span class=main>,</span> <span class=bound>st''</span><span class=main>)</span> <span class=main>=</span> <span class=free>msteps0</span> <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=bound>st'</span> <span class=keyword1>in</span> <span class=main>(</span><span class=bound>V'</span> <span class=main>@</span> <span class=bound>V''</span><span class=main>,</span> <span class=bound>st''</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>msteps0_stateless</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>msteps0_stateless</span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>msteps0_stateless</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tdb</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>π</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>V'</span><span class=main>,</span> <span class=bound>st'</span><span class=main>)</span> <span class=main>=</span> mstep <span class=main>(</span>map_prod mk_db id <span class=free><span class=bound><span class=entity>tdb</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>st</span></span></span> <span class=keyword1>in</span> <span class=bound>V'</span> <span class=main>@</span> <span class=free>msteps0_stateless</span> <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=bound>st'</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> msteps0_msteps0_stateless<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>msteps0 <span class=free>w</span> <span class=free>st</span><span class=main>)</span> <span class=main>=</span> msteps0_stateless <span class=free>w</span> <span class=free>st</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>w</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>st</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> split_beta<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> msteps <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.prefix <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>×</span> event_data table<span class=main>)</span> list <span class=main>×</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>msteps0</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> msteps_stateless <span class=main>::</span> <span class=quoted><span class=quoted>"Formula.prefix <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'msaux</span><span class=main>,</span> <span class=tfree>'muaux</span><span class=main>)</span> mstate <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>×</span> event_data table<span class=main>)</span> list"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>msteps0_stateless</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> msteps_msteps_stateless<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>msteps <span class=free>w</span> <span class=free>st</span><span class=main>)</span> <span class=main>=</span> msteps_stateless <span class=free>w</span> <span class=free>st</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>rule</span> msteps0_msteps0_stateless<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> msteps0_snoc<span class=main>:</span> <span class=quoted><span class=quoted>"msteps0 <span class=main>(</span><span class=free>π</span> <span class=main>@</span> <span class=main>[</span><span class=free>tdb</span><span class=main>]</span><span class=main>)</span> <span class=free>st</span> <span class=main>=</span>
   <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>V'</span><span class=main>,</span> <span class=bound>st'</span><span class=main>)</span> <span class=main>=</span> msteps0 <span class=free>π</span> <span class=free>st</span><span class=main>;</span> <span class=main>(</span><span class=bound>V''</span><span class=main>,</span> <span class=bound>st''</span><span class=main>)</span> <span class=main>=</span> mstep <span class=main>(</span>map_prod mk_db id <span class=free>tdb</span><span class=main>)</span> <span class=bound>st'</span> <span class=keyword1>in</span> <span class=main>(</span><span class=bound>V'</span> <span class=main>@</span> <span class=bound>V''</span><span class=main>,</span> <span class=bound>st''</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>π</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>st</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> msteps_psnoc<span class=main>:</span> <span class=quoted><span class=quoted>"last_ts <span class=free>π</span> <span class=main>≤</span> snd <span class=free>tdb</span> <span class=main>⟹</span> msteps <span class=main>(</span>psnoc <span class=free>π</span> <span class=free>tdb</span><span class=main>)</span> <span class=free>st</span> <span class=main>=</span>
   <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>V'</span><span class=main>,</span> <span class=bound>st'</span><span class=main>)</span> <span class=main>=</span> msteps <span class=free>π</span> <span class=free>st</span><span class=main>;</span> <span class=main>(</span><span class=bound>V''</span><span class=main>,</span> <span class=bound>st''</span><span class=main>)</span> <span class=main>=</span> mstep <span class=main>(</span>map_prod mk_db id <span class=free>tdb</span><span class=main>)</span> <span class=bound>st'</span> <span class=keyword1>in</span> <span class=main>(</span><span class=bound>V'</span> <span class=main>@</span> <span class=bound>V''</span><span class=main>,</span> <span class=bound>st''</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer'</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> msteps0_snoc <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits prod.splits if_splits<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>monitor</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>monitor</span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=main>=</span> msteps_stateless <span class=free><span class=bound><span class=entity>π</span></span></span> <span class=main>(</span>minit_safe <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>lemma</span></span> Suc_length_conv_snoc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Suc <span class=free>n</span> <span class=main>=</span> length <span class=free>xs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span> <span class=bound>ys</span><span class=main>.</span> <span class=free>xs</span> <span class=main>=</span> <span class=bound>ys</span> <span class=main>@</span> <span class=main>[</span><span class=bound>y</span><span class=main>]</span> <span class=main>∧</span> length <span class=bound>ys</span> <span class=main>=</span> <span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rev_cases<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> verimon<span class=main>)</span> wf_mstate_msteps<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mstate <span class=free>φ</span> <span class=free>π</span> <span class=free>R</span> <span class=free>st</span> <span class=main>⟹</span> mem_restr <span class=free>R</span> <span class=free>v</span> <span class=main>⟹</span> <span class=free>π</span> <span class=main>≤</span> <span class=free>π'</span> <span class=main>⟹</span>
  <span class=free>X</span> <span class=main>=</span> msteps <span class=main>(</span>pdrop <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=free>π'</span><span class=main>)</span> <span class=free>st</span> <span class=main>⟹</span> wf_mstate <span class=free>φ</span> <span class=free>π'</span> <span class=free>R</span> <span class=main>(</span>snd <span class=free>X</span><span class=main>)</span> <span class=main>∧</span>
  <span class=main>(</span><span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> flatten_verdicts <span class=main>(</span>fst <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> M <span class=free>π'</span> <span class=main>-</span> M <span class=free>π</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=quoted>"plen <span class=free>π'</span> <span class=main>-</span> plen <span class=free>π</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>X</span></span> <span class=quoted><span class=free>st</span></span> <span class=quoted><span class=free>π</span></span> <span class=quoted><span class=free>π'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>from</span></span> 0<span class=main>(</span>1<span class=main>,</span>4<span class=main>,</span>5<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>π</span> <span class=main>=</span> <span class=skolem>π'</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>X</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=skolem>st</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>with</span></span> 0<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> flatten_verdicts_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Suc<span class=main>(</span>2<span class=main>,</span>5<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>π''</span></span> <span class=skolem><span class=skolem>tdb</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> plen <span class=skolem>π''</span> <span class=main>-</span> plen <span class=skolem>π</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>π</span> <span class=main>≤</span> <span class=skolem>π''</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>π'</span> <span class=main>=</span> psnoc <span class=skolem>π''</span> <span class=skolem>tdb</span>"</span></span> <span class=quoted><span class=quoted>"pdrop <span class=main>(</span>plen <span class=skolem>π</span><span class=main>)</span> <span class=main>(</span>psnoc <span class=skolem>π''</span> <span class=skolem>tdb</span><span class=main>)</span> <span class=main>=</span> psnoc <span class=main>(</span>pdrop <span class=main>(</span>plen <span class=skolem>π</span><span class=main>)</span> <span class=skolem>π''</span><span class=main>)</span> <span class=skolem>tdb</span>"</span></span>
    <span class=quoted><span class=quoted>"last_ts <span class=main>(</span>pdrop <span class=main>(</span>plen <span class=skolem>π</span><span class=main>)</span> <span class=skolem>π''</span><span class=main>)</span> <span class=main>≤</span> snd <span class=skolem>tdb</span>"</span></span> <span class=quoted><span class=quoted>"last_ts <span class=skolem>π''</span> <span class=main>≤</span> snd <span class=skolem>tdb</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>π''</span> <span class=main>≤</span> psnoc <span class=skolem>π''</span> <span class=skolem>tdb</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>atomize_elim</span><span class=main><span class=keyword3>,</span></span> <span class=operator>transfer</span><span class=main><span class=keyword3>,</span></span> <span class=operator>elim</span> exE<span class=main><span class=keyword3>,</span></span> <span class=operator>goal_cases</span> prefix<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>prefix _ _ <span class=skolem>π'</span> _ <span class=skolem>π_tdb</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>π_tdb</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rev_cases<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>snoc <span class=skolem>π</span> <span class=skolem>tdb</span><span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> prefix <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> bexI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"<span class=skolem>π'</span> <span class=main>@</span> <span class=skolem>π</span>"</span></span><span class=main><span class=main>]</span></span> exI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem>tdb</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sorted_append append_eq_Cons_conv <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>with</span></span> Suc<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> this<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> Suc.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> this<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> refl<span class=main>]</span> Suc.prems <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> msteps_msteps_stateless<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> msteps_psnoc split_beta mstep_mverdicts
        <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> mono_monitor<span class=main><span class=main>[</span></span><span class=operator>THEN</span> set_mp<span class=main><span class=main>,</span></span> <span class=operator>rotated</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> wf_mstate_mstep<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> verimon<span class=main>)</span> wf_mstate_msteps_stateless<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"wf_mstate <span class=free>φ</span> <span class=free>π</span> <span class=free>R</span> <span class=free>st</span>"</span></span> <span class=quoted><span class=quoted>"mem_restr <span class=free>R</span> <span class=free>v</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>π</span> <span class=main>≤</span> <span class=free>π'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> flatten_verdicts <span class=main>(</span>msteps_stateless <span class=main>(</span>pdrop <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=free>π'</span><span class=main>)</span> <span class=free>st</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> M <span class=free>π'</span> <span class=main>-</span> M <span class=free>π</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> wf_mstate_msteps<span class=main>[</span><span class=operator>OF</span> assms refl<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> msteps_msteps_stateless <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> verimon<span class=main>)</span> wf_mstate_msteps_stateless_UNIV<span class=main>:</span> <span class=quoted><span class=quoted>"wf_mstate <span class=free>φ</span> <span class=free>π</span> UNIV <span class=free>st</span> <span class=main>⟹</span> <span class=free>π</span> <span class=main>≤</span> <span class=free>π'</span> <span class=main>⟹</span>
  flatten_verdicts <span class=main>(</span>msteps_stateless <span class=main>(</span>pdrop <span class=main>(</span>plen <span class=free>π</span><span class=main>)</span> <span class=free>π'</span><span class=main>)</span> <span class=free>st</span><span class=main>)</span> <span class=main>=</span> M <span class=free>π'</span> <span class=main>-</span> M <span class=free>π</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> wf_mstate_msteps_stateless<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ mem_restr_UNIV<span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> verimon<span class=main>)</span> mverdicts_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"M pnil <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> M_def pprogress_eq<span class=main>)</span>

<span class=keyword1><span class=command>context</span></span> maux
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lemma</span></span> minit_safe_minit<span class=main>:</span> <span class=quoted><span class=quoted>"mmonitorable <span class=free>φ</span> <span class=main>⟹</span> minit_safe <span class=free>φ</span> <span class=main>=</span> minit <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> minit_safe_def monitorable_formula_code <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> wf_mstate_minit_safe<span class=main>:</span> <span class=quoted><span class=quoted>"mmonitorable <span class=free>φ</span> <span class=main>⟹</span> wf_mstate <span class=free>φ</span> pnil <span class=free>R</span> <span class=main>(</span>minit_safe <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> wf_mstate_minit minit_safe_minit mmonitorable_def <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> verimon<span class=main>)</span> monitor_mverdicts<span class=main>:</span> <span class=quoted><span class=quoted>"flatten_verdicts <span class=main>(</span>monitor <span class=free>φ</span> <span class=free>π</span><span class=main>)</span> <span class=main>=</span> M <span class=free>π</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> monitor_def <span class=keyword1><span class=command>using</span></span> monitorable
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> wf_mstate_msteps_stateless_UNIV<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf_mstate_minit_safe<span class=main><span class=main>,</span></span> <span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> mmonitorable_def mverdicts_Nil<span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Collected correctness results›</span></span>

<span class=keyword1><span class=command>context</span></span> verimon
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹We summarize the main results proved above.
\begin{enumerate}
\item The term <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>M</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> describes semantically the monitor's expected behaviour:
\begin{itemize}
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] mono_monitor<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> mono_monitor<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] sound_monitor<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> sound_monitor<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] complete_monitor<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> complete_monitor<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] sliceable_M<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> sliceable_M<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\end{itemize}
\item The executable monitor's online interface <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>minit_safe</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> and <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>mstep</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
  preserves the invariant <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>wf_mstate</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> and produces the the verdicts according
  to <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>M</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>:
\begin{itemize}
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] wf_mstate_minit_safe<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> wf_mstate_minit_safe<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] wf_mstate_mstep<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> wf_mstate_mstep<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] mstep_mverdicts<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> mstep_mverdicts<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\end{itemize}
\item The executable monitor's offline interface <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>monitor</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> implements <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>M</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>:
\begin{itemize}
\item <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span>[source] monitor_mverdicts<span class=antiquote><span class=antiquote>}</span></span></span></span>: <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>thm</span></span> monitor_mverdicts<span class=main><span class=main>[</span></span><span class=operator><span class=operator>no_vars</span></span><span class=main><span class=main>]</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
\end{itemize}
\end{enumerate}
›</span></span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Optimized_MTL><div class=head><h1>Theory Optimized_MTL</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Optimized_MTL
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Monitor.html>Monitor</a>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Efficient implementation of temporal operators›</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Optimized queue data structure›</span></span>

<span class=keyword1><span class=command>lemma</span></span> less_enat_iff<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>&lt;</span> enat <span class=free>i</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>j</span><span class=main>.</span> <span class=free>a</span> <span class=main>=</span> enat <span class=bound>j</span> <span class=main>∧</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free>i</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>a</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> queue_t <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> list <span class=main>×</span> <span class=tfree>'a</span> list"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>queue_invariant</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue_t <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>queue_invariant</span> <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>⇒</span> True <span class=main>|</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>l</span> <span class=main>#</span> <span class=bound>ls</span><span class=main>)</span> <span class=main>⇒</span> True <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>typedef</span></span> <span class=tfree>'a</span> queue <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>q</span> <span class=main>::</span> <span class=tfree>'a</span> queue_t<span class=main>.</span> queue_invariant <span class=bound>q</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits<span class=main>)</span>

<span class=keyword1><span class=command>setup_lifting</span></span> type_definition_queue

<span class=keyword1><span class=command>lift_definition</span></span> linearize <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> list"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>q</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>q</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>ls</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>fs</span> <span class=main>@</span> rev <span class=bound>ls</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> empty_queue <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> empty_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize empty_queue <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> empty_queue_def linearize_def<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> is_empty <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>q</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>q</span> <span class=keyword1>of</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>⇒</span> True <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> linearize_t_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> <span class=free>q</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>ls</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>fs</span> <span class=main>@</span> rev <span class=bound>ls</span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>⟷</span> <span class=free>q</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> is_empty_alt<span class=main>:</span> <span class=quoted><span class=quoted>"is_empty <span class=free>q</span> <span class=main>⟷</span> linearize <span class=free>q</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> linearize_t_Nil list.case_eq_if<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>prepend_queue_t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue_t <span class=main>⇒</span> <span class=tfree>'a</span> queue_t"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>prepend_queue_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>prepend_queue_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>prepend_queue_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> prepend_queue <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>prepend_queue_t</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> prepend_queue_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> prepend_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=main>(</span>prepend_queue <span class=free>a</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span> <span class=main>#</span> linearize <span class=free>q</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> queue_invariant_def linearize_def <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> prepend_queue_t.elims <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> append_queue <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>a</span> <span class=bound>q</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>q</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>ls</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>a</span> <span class=main>#</span> <span class=bound>ls</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> append_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=main>(</span>append_queue <span class=free>a</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> linearize <span class=free>q</span> <span class=main>@</span> <span class=main>[</span><span class=free>a</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> linearize_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>safe_last_t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue_t <span class=main>⇒</span> <span class=tfree>'a</span> option <span class=main>×</span> <span class=tfree>'a</span> queue_t"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_last_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>None<span class=main>,</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_last_t</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Some <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_last_t</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> safe_last <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> option <span class=main>×</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>safe_last_t</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits list.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_last_rep<span class=main>:</span> <span class=quoted><span class=quoted>"safe_last <span class=free>q</span> <span class=main>=</span> <span class=main>(</span><span class=free>α</span><span class=main>,</span> <span class=free>q'</span><span class=main>)</span> <span class=main>⟹</span> linearize <span class=free>q</span> <span class=main>=</span> linearize <span class=free>q'</span> <span class=main>∧</span>
  <span class=main>(</span><span class=keyword1>case</span> <span class=free>α</span> <span class=keyword1>of</span> None <span class=main>⇒</span> linearize <span class=free>q</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>|</span> Some <span class=bound>a</span> <span class=main>⇒</span> linearize <span class=free>q</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>∧</span> <span class=bound>a</span> <span class=main>=</span> last <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> safe_last_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>safe_hd_t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue_t <span class=main>⇒</span> <span class=tfree>'a</span> option <span class=main>×</span> <span class=tfree>'a</span> queue_t"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_hd_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>None<span class=main>,</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_hd_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Some <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_hd_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>fs</span> <span class=main>=</span> rev <span class=free><span class=bound><span class=entity>ls</span></span></span> <span class=keyword1>in</span> <span class=main>(</span>Some <span class=main>(</span>hd <span class=bound>fs</span><span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_hd_t</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Some <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>safe_hd_t</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span><span class=main>(</span>code_dt<span class=main>)</span> safe_hd <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> option <span class=main>×</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>safe_hd_t</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>q</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue_t"</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"queue_invariant <span class=skolem>q</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"pred_prod <span class=main>⊤</span> queue_invariant <span class=main>(</span>safe_hd_t <span class=skolem>q</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>q</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> safe_hd_t.cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def Let_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.split<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> safe_hd_rep<span class=main>:</span> <span class=quoted><span class=quoted>"safe_hd <span class=free>q</span> <span class=main>=</span> <span class=main>(</span><span class=free>α</span><span class=main>,</span> <span class=free>q'</span><span class=main>)</span> <span class=main>⟹</span> linearize <span class=free>q</span> <span class=main>=</span> linearize <span class=free>q'</span> <span class=main>∧</span>
  <span class=main>(</span><span class=keyword1>case</span> <span class=free>α</span> <span class=keyword1>of</span> None <span class=main>⇒</span> linearize <span class=free>q</span> <span class=main>=</span> <span class=main>[]</span> <span class=main>|</span> Some <span class=bound>a</span> <span class=main>⇒</span> linearize <span class=free>q</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>∧</span> <span class=bound>a</span> <span class=main>=</span> hd <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> queue_invariant_def Let_def hd_append <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> safe_hd_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>replace_hd_t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue_t <span class=main>⇒</span> <span class=tfree>'a</span> queue_t"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>replace_hd_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>replace_hd_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>replace_hd_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>fs</span> <span class=main>=</span> rev <span class=free><span class=bound><span class=entity>ls</span></span></span> <span class=keyword1>in</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> tl <span class=bound>fs</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>replace_hd_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>replace_hd_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> replace_hd <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>replace_hd_t</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> replace_hd_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> tl_append<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span> tl <span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span> <span class=main>=</span> tl <span class=main>(</span><span class=free>xs</span> <span class=main>@</span> <span class=free>ys</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> replace_hd_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=free>q</span> <span class=main>=</span> <span class=free>f</span> <span class=main>#</span> <span class=free>fs</span> <span class=main>⟹</span> linearize <span class=main>(</span>replace_hd <span class=free>a</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span> <span class=main>#</span> <span class=free>fs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>transfer</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>fs</span></span> <span class=quoted><span class=free>a</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>q</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"queue_invariant <span class=skolem>q</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> <span class=skolem>q</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>ls</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>fs</span> <span class=main>@</span> rev <span class=bound>ls</span><span class=main>)</span> <span class=main>=</span> <span class=free>f</span> <span class=main>#</span> <span class=free>fs</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>case</span> replace_hd_t <span class=free>a</span> <span class=skolem>q</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>fs</span><span class=main>,</span> <span class=bound>ls</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>fs</span> <span class=main>@</span> rev <span class=bound>ls</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span> <span class=main>#</span> <span class=free>fs</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span>"</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> replace_hd_t.cases<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def tl_append<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>replace_last_t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue_t <span class=main>⇒</span> <span class=tfree>'a</span> queue_t"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>replace_last_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>replace_last_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>replace_last_t</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> undefined"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> replace_last <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>replace_last_t</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> replace_last_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> replace_last_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=free>q</span> <span class=main>=</span> <span class=free>fs</span> <span class=main>@</span> <span class=main>[</span><span class=free>f</span><span class=main>]</span> <span class=main>⟹</span> linearize <span class=main>(</span>replace_last <span class=free>a</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> <span class=free>fs</span> <span class=main>@</span> <span class=main>[</span><span class=free>a</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits prod.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> replace_last_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>tl_queue_t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue_t <span class=main>⇒</span> <span class=tfree>'a</span> queue_t"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>tl_queue_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>tl_queue_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>tl_queue_t</span> <span class=main>(</span><span class=main>[]</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>tl <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>ls</span></span></span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>tl_queue_t</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>fs</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> tl_queue <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted>tl_queue_t</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> queue_invariant_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> tl_queue_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> tl_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>is_empty <span class=free>q</span> <span class=main>⟹</span> linearize <span class=main>(</span>tl_queue <span class=free>q</span><span class=main>)</span> <span class=main>=</span> tl <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> tl_append <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> tl_queue_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> length_tl_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>is_empty <span class=free>q</span> <span class=main>⟹</span>
  length <span class=main>(</span>linearize <span class=main>(</span>tl_queue <span class=free>q</span><span class=main>)</span><span class=main>)</span> <span class=main>&lt;</span> length <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits list.splits <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> tl_queue_t.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> length_tl_queue_safe_hd<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"safe_hd <span class=free>q</span> <span class=main>=</span> <span class=main>(</span>Some <span class=free>a</span><span class=main>,</span> <span class=free>q'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>linearize <span class=main>(</span>tl_queue <span class=free>q'</span><span class=main>)</span><span class=main>)</span> <span class=main>&lt;</span> length <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> safe_hd_rep<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_tl_queue_rep is_empty_alt<span class=main>)</span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>dropWhile_queue</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dropWhile_queue</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> safe_hd <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=keyword1>of</span> <span class=main>(</span>None<span class=main>,</span> <span class=bound>q'</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>q'</span>
  <span class=main>|</span> <span class=main>(</span>Some <span class=bound>a</span><span class=main>,</span> <span class=bound>q'</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>a</span> <span class=keyword1>then</span> <span class=free>dropWhile_queue</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span>tl_queue <span class=bound>q'</span><span class=main>)</span> <span class=keyword1>else</span> <span class=bound>q'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
  <span class=keyword1><span class=command>using</span></span> length_tl_queue_safe_hd<span class=main>[</span><span class=operator>OF</span> sym<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>f</span><span class=main>,</span> <span class=bound>q</span><span class=main>)</span><span class=main>.</span> length <span class=main>(</span>linearize <span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> dropWhile_hd_tl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span>
  dropWhile <span class=free>P</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>P</span> <span class=main>(</span>hd <span class=free>xs</span><span class=main>)</span> <span class=keyword1>then</span> dropWhile <span class=free>P</span> <span class=main>(</span>tl <span class=free>xs</span><span class=main>)</span> <span class=keyword1>else</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> dropWhile_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=main>(</span>dropWhile_queue <span class=free>f</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> dropWhile <span class=free>f</span> <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>q</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> dropWhile_queue.induct<span class=main>)</span>
     <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tl_queue_rep dropWhile_hd_tl is_empty_alt
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits option.splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_hd_rep<span class=main>)</span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>takeWhile_queue</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>takeWhile_queue</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> safe_hd <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=keyword1>of</span> <span class=main>(</span>None<span class=main>,</span> <span class=bound>q'</span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>q'</span>
  <span class=main>|</span> <span class=main>(</span>Some <span class=bound>a</span><span class=main>,</span> <span class=bound>q'</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>a</span>
    <span class=keyword1>then</span> prepend_queue <span class=bound>a</span> <span class=main>(</span><span class=free>takeWhile_queue</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span>tl_queue <span class=bound>q'</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> empty_queue<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
  <span class=keyword1><span class=command>using</span></span> length_tl_queue_safe_hd<span class=main>[</span><span class=operator>OF</span> sym<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>f</span><span class=main>,</span> <span class=bound>q</span><span class=main>)</span><span class=main>.</span> length <span class=main>(</span>linearize <span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> takeWhile_hd_tl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span>
  takeWhile <span class=free>P</span> <span class=free>xs</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>P</span> <span class=main>(</span>hd <span class=free>xs</span><span class=main>)</span> <span class=keyword1>then</span> hd <span class=free>xs</span> <span class=main>#</span> takeWhile <span class=free>P</span> <span class=main>(</span>tl <span class=free>xs</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> takeWhile_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=main>(</span>takeWhile_queue <span class=free>f</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> takeWhile <span class=free>f</span> <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>q</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> takeWhile_queue.induct<span class=main>)</span>
     <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> prepend_queue_rep tl_queue_rep empty_queue_rep takeWhile_hd_tl is_empty_alt
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits option.splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_hd_rep<span class=main>)</span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>takedropWhile_queue</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>⇒</span> <span class=tfree>'a</span> queue <span class=main>×</span> <span class=tfree>'a</span> list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>takedropWhile_queue</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> safe_hd <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=keyword1>of</span> <span class=main>(</span>None<span class=main>,</span> <span class=bound>q'</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>q'</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span>
  <span class=main>|</span> <span class=main>(</span>Some <span class=bound>a</span><span class=main>,</span> <span class=bound>q'</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>a</span>
    <span class=keyword1>then</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>takedropWhile_queue</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span>tl_queue <span class=bound>q'</span><span class=main>)</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>q''</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>q''</span><span class=main>,</span> <span class=bound>a</span> <span class=main>#</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=bound>q'</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
  <span class=keyword1><span class=command>using</span></span> length_tl_queue_safe_hd<span class=main>[</span><span class=operator>OF</span> sym<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>f</span><span class=main>,</span> <span class=bound>q</span><span class=main>)</span><span class=main>.</span> length <span class=main>(</span>linearize <span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> takedropWhile_queue_fst<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>takedropWhile_queue <span class=free>f</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> dropWhile_queue <span class=free>f</span> <span class=free>q</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>q</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> takedropWhile_queue.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>f</span> <span class=skolem>q</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> case_prod_unfold <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> takedropWhile_queue_snd<span class=main>:</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>takedropWhile_queue <span class=free>f</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> takeWhile <span class=free>f</span> <span class=main>(</span>linearize <span class=free>q</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>q</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> takedropWhile_queue.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>f</span> <span class=skolem>q</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> case_prod_unfold tl_queue_rep takeWhile_hd_tl is_empty_alt
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_hd_rep<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Optimized data structure for Since›</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> mmsaux <span class=main>=</span> <span class=quoted><span class=quoted>"ts <span class=main>×</span> ts <span class=main>×</span> bool list <span class=main>×</span> bool list <span class=main>×</span>
  <span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> queue <span class=main>×</span> <span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> queue <span class=main>×</span>
  <span class=main>(</span><span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> ts<span class=main>)</span> mapping<span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> ts<span class=main>)</span> mapping<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>time_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> mmsaux <span class=main>⇒</span> ts"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>time_mmsaux</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>nt</span><span class=main>,</span> <span class=main><span class=bound>_</span></span><span class=main>)</span> <span class=main>⇒</span> <span class=bound>nt</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>ts_tuple_rel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> set <span class=main>⇒</span> <span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> tuple<span class=main>)</span> set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ts_tuple_rel</span> <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=bound>X</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> finite_fst_ts_tuple_rel<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>xs</span><span class=main>)</span><span class=main>.</span> <span class=free>P</span> <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>xs</span><span class=main>)</span><span class=main>.</span> <span class=free>P</span> <span class=bound>tas</span><span class=main>}</span> <span class=main>⊆</span> fst <span class=main>`</span> ts_tuple_rel <span class=main>(</span>set <span class=free>xs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⊆</span> set <span class=main>(</span>map fst <span class=free>xs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> finite_subset <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_ext_Cons<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span> <span class=main>⟹</span>
  <span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_ext_Cons'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>tass</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_intro<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>∈</span> <span class=free>ys</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_dest<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=free>ys</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> <span class=free>ys</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=bound>X</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_Un<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span><span class=free>ys</span> <span class=main>∪</span> <span class=free>zs</span><span class=main>)</span> <span class=main>=</span> ts_tuple_rel <span class=free>ys</span> <span class=main>∪</span> ts_tuple_rel <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_ext<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span> <span class=main>⟹</span>
  <span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>Y</span> <span class=main>∪</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> tas_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>=</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tas</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=free>Y</span> <span class=main>∪</span> <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>Y</span> <span class=main>∪</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tas_def<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> ts_tuple_rel_intro<span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_ext'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span> <span class=main>∪</span> ts_tuple_rel <span class=main>(</span>set <span class=free>tass</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ts_tuple_rel_Un <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Un_commute <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> ts_tuple_rel_ext<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>tass</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span><span class=main>)</span> <span class=main>#</span> <span class=free>tass</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> ts_tuple_rel_ext_Cons'<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ys</span> <span class=main>⊆</span> <span class=free>zs</span> <span class=main>⟹</span> ts_tuple_rel <span class=free>ys</span> <span class=main>⊆</span> ts_tuple_rel <span class=free>zs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_filter<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>P</span> <span class=bound>t</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
  <span class=main>{</span><span class=main>(</span><span class=bound><span class=bound>t</span></span><span class=main>,</span> <span class=bound><span class=bound>X</span></span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>xs</span><span class=main>)</span><span class=main>.</span> <span class=free>P</span> <span class=bound>t</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> ts_tuple_rel_set_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>filter <span class=free>P</span> <span class=free>xs</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=free>x</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valid_tuple</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> ts<span class=main>)</span> mapping<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>ts <span class=main>×</span> <span class=tfree>'a</span> tuple<span class=main>)</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_tuple</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=bound>as</span> <span class=keyword1>of</span> None <span class=main>⇒</span> False
  <span class=main>|</span> Some <span class=bound>t'</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>≥</span> <span class=bound>t'</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>safe_max</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>::</span> linorder set <span class=main>⇒</span> <span class=tfree>'a</span> option"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>safe_max</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> None <span class=keyword1>else</span> Some <span class=main>(</span>Max <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> safe_max_empty<span class=main>:</span> <span class=quoted><span class=quoted>"safe_max <span class=free>X</span> <span class=main>=</span> None <span class=main>⟷</span> <span class=free>X</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_max_empty_dest<span class=main>:</span> <span class=quoted><span class=quoted>"safe_max <span class=free>X</span> <span class=main>=</span> None <span class=main>⟹</span> <span class=free>X</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_max_Some_intro<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>y</span><span class=main>.</span> safe_max <span class=free>X</span> <span class=main>=</span> Some <span class=bound>y</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> safe_max_empty <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> safe_max_Some_dest_in<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=free>X</span> <span class=main>⟹</span> safe_max <span class=free>X</span> <span class=main>=</span> Some <span class=free>x</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Max_in <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> safe_max_Some_dest_le<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=free>X</span> <span class=main>⟹</span> safe_max <span class=free>X</span> <span class=main>=</span> Some <span class=free>x</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>≤</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Max_ge <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>valid_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> Monitor.msaux <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ys</span></span></span> <span class=main>⟷</span>
    <span class=main>(</span>args_L <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=main>=</span> join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_L <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>maskR</span></span></span> <span class=main>=</span> join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>.</span> table <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∧</span>
    table <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>Mapping.keys <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>)</span> <span class=main>∧</span>
    table <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>Mapping.keys <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=main>∈</span> <span class=main>⋃</span><span class=main>(</span>snd <span class=main>`</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> wf_tuple <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>∧</span>
    ts_tuple_rel <span class=main>(</span>set <span class=free><span class=bound><span class=entity>ys</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=bound>tas</span><span class=main>}</span> <span class=main>∧</span>
    sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span> <span class=main>&lt;</span> left <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=free><span class=bound><span class=entity>tuple_in</span></span></span> <span class=bound>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=bound>as</span> <span class=keyword1>of</span> Some <span class=bound>t</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_filter_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>∈</span> Mapping.keys <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span> <span class=free>k</span> <span class=main>=</span> Mapping.lookup <span class=free>m</span> <span class=free>k</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> default_def insert_subset keys_default keys_filter lookup_default lookup_default_filter<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_filter_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> Mapping.keys <span class=free>m</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Mapping.lookup <span class=free>m</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> Mapping.keys <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_keys Mapping.keys_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_filter_keys_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>⟹</span> <span class=free>P'</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> Mapping.keys <span class=free>m</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>Mapping.lookup <span class=free>m</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>k</span> <span class=main>∈</span> Mapping.keys <span class=free>m</span><span class=main>.</span> <span class=free>P'</span> <span class=main>(</span>Mapping.lookup <span class=free>m</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_keys_dest<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> Mapping.keys <span class=free>f</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>y</span><span class=main>.</span> Mapping.lookup <span class=free>f</span> <span class=free>x</span> <span class=main>=</span> Some <span class=bound>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> domD keys_dom_lookup<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_keys_intro<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>f</span> <span class=free>x</span> <span class=main>≠</span> None <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> Mapping.keys <span class=free>f</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> domIff keys_dom_lookup<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> valid_mmsaux_tuple_in_keys<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
  <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>ys</span> <span class=main>⟹</span>
  Mapping.keys <span class=free>tuple_in</span> <span class=main>=</span> snd <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
  valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro safe_max_Some_intro
      <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_dest safe_max_Some_dest_in<span class=main><span class=main>[</span></span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main><span class=main>]</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>init_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>init_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_L <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>,</span>
  join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>,</span> empty_queue<span class=main>,</span> empty_queue<span class=main>,</span> Mapping.empty<span class=main>,</span> Mapping.empty<span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_init_mmsaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>L</span> <span class=main>⊆</span> <span class=free>R</span> <span class=main>⟹</span> valid_mmsaux <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>b</span><span class=main>)</span> <span class=main>0</span>
  <span class=main>(</span>init_mmsaux <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>b</span><span class=main>)</span><span class=main>)</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> init_args_def empty_queue_rep ts_tuple_rel_def join_mask_def
      Mapping.lookup_empty safe_max_def table_def<span class=main>)</span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>filter_cond</span> <span class=free><span class=bound><span class=entity>X'</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=main>¬</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>X'</span></span></span> <span class=main>∧</span> Mapping.lookup <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=bound>as</span> <span class=main>=</span> Some <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> dropWhile_filter<span class=main>:</span>
  <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=free>xs</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>⟹</span>
  dropWhile <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> filter_id_conv<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> dropWhile_filter'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>nt</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=free>xs</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>⟹</span>
  dropWhile <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>&lt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> filter_id_conv<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> dropWhile_filter''<span class=main>:</span>
  <span class=quoted><span class=quoted>"sorted <span class=free>xs</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=free>xs</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>⟹</span>
  dropWhile <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> filter_id_conv<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> order.trans<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> takeWhile_filter<span class=main>:</span>
  <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=free>xs</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>⟹</span>
  takeWhile <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_enat_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> filter_empty_conv<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> takeWhile_filter'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>nt</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=free>xs</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>⟹</span>
  takeWhile <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_enat_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> filter_empty_conv<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> takeWhile_filter''<span class=main>:</span>
  <span class=quoted><span class=quoted>"sorted <span class=free>xs</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=free>xs</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>⟹</span>
  takeWhile <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> <span class=free>c</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> less_enat_iff <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> filter_empty_conv<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fold_Mapping_filter_None<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>ts</span> <span class=free>as</span> <span class=main>=</span> None <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>ts</span><span class=main>.</span> Mapping.filter
  <span class=main>(</span>filter_cond <span class=bound>X</span> <span class=bound>ts</span> <span class=bound>t</span><span class=main>)</span> <span class=bound>ts</span><span class=main>)</span> <span class=free>ds</span> <span class=free>ts</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> None"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ds</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_filter_Some_P<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>P</span> <span class=free>m</span><span class=main>)</span> <span class=free>k</span> <span class=main>=</span> Some <span class=free>v</span> <span class=main>⟹</span> <span class=free>P</span> <span class=free>k</span> <span class=free>v</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_filter_None<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>v</span><span class=main>.</span> <span class=main>¬</span><span class=free>P</span> <span class=free>k</span> <span class=bound>v</span><span class=main>)</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>P</span> <span class=free>m</span><span class=main>)</span> <span class=free>k</span> <span class=main>=</span> None"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_filter_Some<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>v</span><span class=main>.</span> <span class=free>P</span> <span class=free>k</span> <span class=bound>v</span><span class=main>)</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>P</span> <span class=free>m</span><span class=main>)</span> <span class=free>k</span> <span class=main>=</span> Mapping.lookup <span class=free>m</span> <span class=free>k</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_filter_not_None<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>P</span> <span class=free>m</span><span class=main>)</span> <span class=free>k</span> <span class=main>≠</span> None <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>P</span> <span class=free>m</span><span class=main>)</span> <span class=free>k</span> <span class=main>=</span> Mapping.lookup <span class=free>m</span> <span class=free>k</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fold_Mapping_filter_Some_None<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>ts</span> <span class=free>as</span> <span class=main>=</span> Some <span class=free>t</span> <span class=main>⟹</span>
  <span class=free>as</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>ds</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>ts</span><span class=main>.</span> Mapping.filter <span class=main>(</span>filter_cond <span class=bound>X</span> <span class=bound>ts</span> <span class=bound>t</span><span class=main>)</span> <span class=bound>ts</span><span class=main>)</span> <span class=free>ds</span> <span class=free>ts</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> None"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ds</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>ds</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pair <span class=skolem>t'</span> <span class=skolem>X'</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Cons <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> fold_Mapping_filter_None<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Mapping.filter <span class=main>(</span>filter_cond <span class=skolem>X'</span> <span class=skolem>ts</span> <span class=skolem>t'</span><span class=main>)</span> <span class=skolem>ts</span>"</span></span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=skolem>ds</span></span><span class=main>]</span>
        Mapping_lookup_filter_not_None<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"filter_cond <span class=skolem>X'</span> <span class=skolem>ts</span> <span class=skolem>t'</span>"</span></span> <span class=quoted><span class=skolem>ts</span></span> <span class=quoted><span class=free>as</span></span><span class=main>]</span>
        fold_Mapping_filter_None<span class=main>[</span><span class=operator>OF</span> Mapping_lookup_filter_None<span class=main>,</span> <span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=skolem>ds</span></span> <span class=quoted><span class=skolem>ts</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>Mapping.filter <span class=main>(</span>filter_cond <span class=skolem>X'</span> <span class=skolem>ts</span> <span class=skolem>t'</span><span class=main>)</span> <span class=skolem>ts</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> None"</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> fold_Mapping_filter_Some_Some<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>ts</span> <span class=free>as</span> <span class=main>=</span> Some <span class=free>t</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>ds</span> <span class=main>⟹</span> <span class=free>as</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>ts</span><span class=main>.</span> Mapping.filter <span class=main>(</span>filter_cond <span class=bound>X</span> <span class=bound>ts</span> <span class=bound>t</span><span class=main>)</span> <span class=bound>ts</span><span class=main>)</span> <span class=free>ds</span> <span class=free>ts</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> Some <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ds</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>ds</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Pair <span class=skolem>t'</span> <span class=skolem>X'</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Cons <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_Some<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"filter_cond <span class=skolem>X'</span> <span class=skolem>ts</span> <span class=skolem>t'</span>"</span></span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=skolem>ts</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>shift_end</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>shift_end</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>I</span> <span class=main>=</span> args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>;</span>
    <span class=bound>data_prev'</span> <span class=main>=</span> dropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=bound>I</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>;</span>
    <span class=main>(</span><span class=bound>data_in</span><span class=main>,</span> <span class=bound>discard</span><span class=main>)</span> <span class=main>=</span> takedropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=bound>I</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>;</span>
    <span class=bound>tuple_in</span> <span class=main>=</span> fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>tuple_in</span><span class=main>.</span> Mapping.filter
      <span class=main>(</span>filter_cond <span class=bound>X</span> <span class=bound>tuple_in</span> <span class=bound>t</span><span class=main>)</span> <span class=bound>tuple_in</span><span class=main>)</span> <span class=bound>discard</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=bound>data_prev'</span><span class=main>,</span> <span class=bound>data_in</span><span class=main>,</span> <span class=bound>tuple_in</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_shift_end_mmsaux_unfolded<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span><span class=free>ot</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> nt_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>shift_end <span class=free>args</span> <span class=free>nt</span>
    <span class=main>(</span><span class=free>ot</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>data_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>data_in'</span> <span class=main>≡</span>
    fst <span class=main>(</span>takedropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=skolem>I</span><span class=main>)</span> <span class=free>data_in</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>data_prev'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>data_prev'</span> <span class=main>≡</span>
    dropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=skolem>I</span><span class=main>)</span> <span class=free>data_prev</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>discard</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>discard</span> <span class=main>≡</span>
    snd <span class=main>(</span>takedropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=skolem>I</span><span class=main>)</span> <span class=free>data_in</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_in'</span> <span class=main>≡</span> fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>tuple_in</span><span class=main>.</span> Mapping.filter
    <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> <span class=bound>X</span> <span class=main>∧</span> Mapping.lookup <span class=bound>tuple_in</span> <span class=bound>as</span> <span class=main>=</span> Some <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=bound>tuple_in</span><span class=main>)</span> <span class=skolem>discard</span> <span class=free>tuple_in</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tuple_in_Some_None<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span> <span class=bound>t</span> <span class=bound>X</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_in</span> <span class=bound>as</span> <span class=main>=</span> Some <span class=bound>t</span> <span class=main>⟹</span>
    <span class=bound>as</span> <span class=main>∈</span> <span class=bound>X</span> <span class=main>⟹</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>discard</span> <span class=main>⟹</span> Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> None"</span></span>
    <span class=keyword1><span class=command>using</span></span> fold_Mapping_filter_Some_None <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tuple_in_Some_Some<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span> <span class=bound>t</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_in</span> <span class=bound>as</span> <span class=main>=</span> Some <span class=bound>t</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>⋀</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>discard</span> <span class=main>⟹</span> <span class=bound>as</span> <span class=main>∉</span> <span class=bound>X</span><span class=main>)</span> <span class=main>⟹</span> Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> Some <span class=bound>t</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fold_Mapping_filter_Some_Some <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tuple_in_None_None<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_in</span> <span class=bound>as</span> <span class=main>=</span> None <span class=main>⟹</span>
    Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> None"</span></span>
    <span class=keyword1><span class=command>using</span></span> fold_Mapping_filter_None <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tuple_in'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_in'</span> <span class=main>⟹</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_in_Some_None tuple_in_Some_Some tuple_in_None_None
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> F1<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before nt_mono <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> F2<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before nt_mono <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_data_in'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_in'</span> <span class=main>=</span>
    filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=skolem>I</span><span class=main>)</span> <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> data_in'_def<span class=main>[</span><span class=operator>unfolded</span> takedropWhile_queue_fst<span class=main>]</span> dropWhile_queue_rep
      dropWhile_filter<span class=main>[</span><span class=operator>OF</span> F1<span class=main>]</span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> set_lin_data_in'<span class=main>:</span> <span class=quoted><span class=quoted>"set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span> <span class=main>⊆</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> sorted_lin_data_in'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_data_in' <span class=keyword1><span class=command>using</span></span> sorted_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> discard_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>discard</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=skolem>I</span><span class=main>)</span> <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> discard_def<span class=main>[</span><span class=operator>unfolded</span> takedropWhile_queue_snd<span class=main>]</span> takeWhile_filter<span class=main>[</span><span class=operator>OF</span> F1<span class=main>]</span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> lin_data_prev'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_prev'</span> <span class=main>=</span>
    filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=skolem>I</span><span class=main>)</span> <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> data_prev'_def<span class=main>[</span><span class=operator>unfolded</span> takedropWhile_queue_fst<span class=main>]</span> dropWhile_queue_rep
      dropWhile_filter<span class=main>[</span><span class=operator>OF</span> F2<span class=main>]</span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> sorted_lin_data_prev'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_data_prev' <span class=keyword1><span class=command>using</span></span> sorted_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lookup_tuple_in'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>tuple_in</span> <span class=skolem>as</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> None
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_max_empty_dest<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> ts_tuple_rel_mono<span class=main>[</span><span class=operator>OF</span> set_lin_data_in'<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> tuple_in_None_None<span class=main>[</span><span class=operator>OF</span> None<span class=main>]</span> <span class=keyword1><span class=command>using</span></span> iffD2<span class=main>[</span><span class=operator>OF</span> safe_max_empty<span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>t</span><span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>X</span><span class=main>.</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>discard</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>∈</span> <span class=bound>X</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> X_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>discard</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>X</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>&gt;</span> right <span class=skolem>I</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> X_def<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> discard_alt <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t'</span><span class=main>.</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
          valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t'</span> <span class=main>≤</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before Some safe_max_Some_dest_le<span class=main>[</span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_iff<span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> lin_data_in' <span class=keyword1><span class=command>using</span></span> ts_tuple_rel_set_filter
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
             <span class=main>(</span><span class=operator>meson</span> diff_le_mono2 enat_ord_simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> leD le_less_trans<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> tuple_in_Some_None<span class=main>[</span><span class=operator>OF</span> Some X_def<span class=main><span class=main>(</span></span>2<span class=main><span class=main>,</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>using</span></span> iffD2<span class=main>[</span><span class=operator>OF</span> safe_max_empty<span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> lookup_Some<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> Some <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> tuple_in_Some_Some<span class=main>[</span><span class=operator>OF</span> Some<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> t_as<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=quoted><span class=quoted>"valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before Some <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_max_Some_dest_in<span class=main><span class=main>[</span></span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> X_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> X_def False <span class=keyword1><span class=command>unfolding</span></span> discard_alt lin_data_in' <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> t_in_fst<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> t_as<span class=main>(</span>2<span class=main>)</span> X_def<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def image_iff<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t'</span><span class=main>.</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
          valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t'</span> <span class=main>≤</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before Some safe_max_Some_dest_le<span class=main>[</span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_iff<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Max_eqI<span class=main>[</span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main>,</span> <span class=operator>OF</span> _ t_in_fst<span class=main>]</span>
            ts_tuple_rel_mono<span class=main>[</span><span class=operator>OF</span> set_lin_data_in'<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> lookup_Some <span class=keyword1><span class=command>using</span></span> t_in_fst <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> table_in<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_in'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_in'_keys valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=free>tuple_since</span> <span class=bound>as</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=skolem>I</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=free>tuple_since</span> <span class=bound>as</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_data_prev' lin_data_in' ts_tuple_rel_Un ts_tuple_rel_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> data_prev'_def data_in'_def tuple_in'_def discard_def valid_before nt_mono
      sorted_lin_data_prev' sorted_lin_data_in' lin_data_prev' lin_data_in' lookup_tuple_in'
      table_in <span class=keyword1><span class=command>unfolding</span></span> I_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> valid_mmsaux.simps shift_end.simps Let_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span> <span class=operator>auto</span>
      <span class=comment1>(* takes long *)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_shift_end_mmsaux<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span> <span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span> <span class=main>⟹</span>
  valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>shift_end <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span>
  <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_shift_end_mmsaux_unfolded <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fast</span>

<span class=keyword1><span class=command>setup_lifting</span></span> type_definition_mapping

<span class=keyword1><span class=command>lift_definition</span></span> upd_set <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> set <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>m</span> <span class=bound>f</span> <span class=bound>X</span> <span class=bound>a</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>a</span> <span class=main>∈</span> <span class=bound>X</span> <span class=keyword1>then</span> Some <span class=main>(</span><span class=bound>f</span> <span class=bound>a</span><span class=main>)</span> <span class=keyword1>else</span> <span class=bound>m</span> <span class=bound>a</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_upd_set<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>upd_set <span class=free>m</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=free>a</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>if</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>X</span> <span class=keyword1>then</span> Some <span class=main>(</span><span class=free>f</span> <span class=free>a</span><span class=main>)</span> <span class=keyword1>else</span> Mapping.lookup <span class=free>m</span> <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup.rep_eq upd_set.rep_eq<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_upd_set_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=main>(</span>upd_set <span class=free>m</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=main>=</span> Mapping.keys <span class=free>m</span> <span class=main>∪</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_lookup_upd_set <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> upd_keys_on <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> set <span class=main>⇒</span>
  <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>m</span> <span class=bound>f</span> <span class=bound>X</span> <span class=bound>a</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span> <span class=keyword1>of</span> Some <span class=bound>b</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=keyword1>if</span> <span class=bound>a</span> <span class=main>∈</span> <span class=bound>X</span> <span class=keyword1>then</span> <span class=bound>f</span> <span class=bound>a</span> <span class=bound>b</span> <span class=keyword1>else</span> <span class=bound>b</span><span class=main>)</span>
  <span class=main>|</span> None <span class=main>⇒</span> None"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_upd_keys_on<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>upd_keys_on <span class=free>m</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=free>a</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free>m</span> <span class=free>a</span> <span class=keyword1>of</span> Some <span class=bound>b</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=keyword1>if</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>X</span> <span class=keyword1>then</span> <span class=free>f</span> <span class=free>a</span> <span class=bound>b</span> <span class=keyword1>else</span> <span class=bound>b</span><span class=main>)</span> <span class=main>|</span> None <span class=main>⇒</span> None<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup.rep_eq upd_keys_on.rep_eq<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_upd_keys_sub<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=main>(</span>upd_keys_on <span class=free>m</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=main>=</span> Mapping.keys <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_lookup_upd_keys_on <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> fold_append_queue_rep<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>q</span><span class=main>.</span> append_queue <span class=bound>x</span> <span class=bound>q</span><span class=main>)</span> <span class=free>xs</span> <span class=free>q</span><span class=main>)</span> <span class=main>=</span> linearize <span class=free>q</span> <span class=main>@</span> <span class=free>xs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>q</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> append_queue_rep<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Max_Un_absorb<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>X</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=free>Y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>Y</span> <span class=main>⟹</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>≤</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Max <span class=main>(</span><span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span><span class=main>)</span> <span class=main>=</span> Max <span class=free>X</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> Max_X_in_X<span class=main>:</span> <span class=quoted><span class=quoted>"Max <span class=free>X</span> <span class=main>∈</span> <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Max_in<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>have</span></span> Max_X_in_XY<span class=main>:</span> <span class=quoted><span class=quoted>"Max <span class=free>X</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Max_in<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> fin<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> Y_le_Max_X<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>Y</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>≤</span> Max <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> _ Max_X_in_X<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>have</span></span> XY_le_Max_X<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>∪</span> <span class=free>Y</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>≤</span> Max <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Max_ge<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> Y_le_Max_X <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Max_eqI<span class=main>[</span><span class=operator>OF</span> fin XY_le_Max_X Max_X_in_XY<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_fold_upd_set_idle<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound><span class=bound>t</span></span><span class=main>,</span> <span class=bound><span class=bound>X</span></span><span class=main>)</span> <span class=main>∈</span> set <span class=free>xs</span><span class=main>.</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>m</span><span class=main>.</span> upd_set <span class=bound>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=free>m</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> Mapping.lookup <span class=free>m</span> <span class=free>as</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>x</span> <span class=skolem>xs</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x1</span></span> <span class=skolem><span class=skolem>x2</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>x1</span><span class=main>,</span> <span class=skolem>x2</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>x</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>m</span><span class=main>.</span> upd_set <span class=bound>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=skolem>xs</span> <span class=main>(</span>upd_set <span class=skolem>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=skolem>x1</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=skolem>x2</span> <span class=skolem>x1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span>
    Mapping.lookup <span class=main>(</span>upd_set <span class=skolem>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=skolem>x1</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=skolem>x2</span> <span class=skolem>x1</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>upd_set <span class=skolem>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=skolem>x1</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=skolem>x2</span> <span class=skolem>x1</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> Mapping.lookup <span class=skolem>m</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>x1</span><span class=main>,</span> <span class=skolem>x2</span><span class=main>)</span>›</span></span> Mapping_lookup_upd_set<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>x1</span><span class=main>,</span> <span class=skolem>x2</span><span class=main>)</span>›</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_fold_upd_set_max<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound><span class=bound>t</span></span><span class=main>,</span> <span class=bound><span class=bound>X</span></span><span class=main>)</span> <span class=main>∈</span> set <span class=free>xs</span><span class=main>.</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span> <span class=main>⟹</span>
  sorted <span class=main>(</span>map fst <span class=free>xs</span><span class=main>)</span> <span class=main>⟹</span>
  Mapping.lookup <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>m</span><span class=main>.</span> upd_set <span class=bound>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=free>m</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span>
  Some <span class=main>(</span>Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound><span class=bound>t</span></span><span class=main>,</span> <span class=bound><span class=bound>X</span></span><span class=main>)</span> <span class=main>∈</span> set <span class=free>xs</span><span class=main>.</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>x</span> <span class=skolem>xs</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> tX_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>x</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> set_fst_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=main>(</span><span class=skolem>x</span> <span class=main>#</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span><span class=main>)</span> <span class=main>∪</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=skolem>X</span> <span class=skolem>t</span> <span class=keyword1>then</span> <span class=main>{</span><span class=skolem>t</span><span class=main>}</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> image_iff <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tX_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span> <span class=main>⊆</span> set <span class=skolem>xs</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> fin<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> finite_subset<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=main>(</span>insert <span class=skolem>t</span> <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
      Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Max_Un_absorb<span class=main>[</span><span class=operator>OF</span> fin<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=skolem>t</span><span class=main>}</span>"</span></span><span class=main>]</span> True Cons<span class=main>(</span>3<span class=main>)</span> tX_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons True <span class=keyword1><span class=command>unfolding</span></span> set_fst_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> empty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>∧</span> <span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>X</span> <span class=bound>t</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=free>Z</span> <span class=skolem>X</span> <span class=skolem>t</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons<span class=main>(</span>2<span class=main>)</span> set_fst_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Mapping_lookup_fold_upd_set_idle<span class=main>[</span><span class=operator>OF</span> empty<span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> set_fst_eq empty
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_lookup_upd_set tX_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>add_new_ts_mmsaux'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_ts_mmsaux'</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>I</span> <span class=main>=</span> args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>;</span>
    <span class=main>(</span><span class=bound>data_prev</span><span class=main>,</span> <span class=bound>move</span><span class=main>)</span> <span class=main>=</span> takedropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=bound>I</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>;</span>
    <span class=bound>data_in</span> <span class=main>=</span> fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>data_in</span><span class=main>.</span> append_queue <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>data_in</span><span class=main>)</span> <span class=bound>move</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>;</span>
    <span class=bound>tuple_in</span> <span class=main>=</span> fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>tuple_in</span><span class=main>.</span> upd_set <span class=bound>tuple_in</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>t</span><span class=main>)</span>
      <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=bound>move</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=bound>data_prev</span><span class=main>,</span> <span class=bound>data_in</span><span class=main>,</span> <span class=bound>tuple_in</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_keys_fold_upd_set<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>∈</span> Mapping.keys <span class=main>(</span>fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>m</span><span class=main>.</span> upd_set <span class=bound>m</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>t</span><span class=main>)</span> <span class=main>(</span><span class=free>Z</span> <span class=bound>t</span> <span class=bound>X</span><span class=main>)</span><span class=main>)</span>
  <span class=free>xs</span> <span class=free>m</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>k</span> <span class=main>∈</span> Mapping.keys <span class=free>m</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>xs</span><span class=main>.</span> <span class=free>k</span> <span class=main>∈</span> <span class=free>Z</span> <span class=bound>t</span> <span class=bound>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_upd_set_keys<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_add_new_ts_mmsaux'_unfolded<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span><span class=free>ot</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> nt_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span>add_new_ts_mmsaux' <span class=free>args</span> <span class=free>nt</span>
    <span class=main>(</span><span class=free>ot</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>data_prev'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>data_prev'</span> <span class=main>≡</span> dropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=skolem>I</span><span class=main>)</span> <span class=free>data_prev</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>move</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>move</span> <span class=main>≡</span> takeWhile <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=skolem>I</span><span class=main>)</span> <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>data_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>data_in'</span> <span class=main>≡</span> fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>data_in</span><span class=main>.</span> append_queue <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>data_in</span><span class=main>)</span>
    <span class=skolem>move</span> <span class=free>data_in</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_in'</span> <span class=main>≡</span> fold <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=bound>tuple_in</span><span class=main>.</span> upd_set <span class=bound>tuple_in</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>t</span><span class=main>)</span>
      <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=skolem>move</span> <span class=free>tuple_in</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tuple_in'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_in'</span> <span class=main>⟹</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span> <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span>set <span class=skolem>move</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Mapping_keys_fold_upd_set<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>t</span> <span class=bound>X</span><span class=main>.</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_in'_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> F1<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>ot</span> <span class=main>∧</span> <span class=free>ot</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before nt_mono <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> F2<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>ot</span> <span class=main>∧</span> <span class=free>ot</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>&lt;</span> left <span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before nt_mono <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_data_prev'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_prev'</span> <span class=main>=</span>
    filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span> <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> data_prev'_def dropWhile_queue_rep dropWhile_filter'<span class=main>[</span><span class=operator>OF</span> F2<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> move_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>move</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=skolem>I</span><span class=main>)</span> <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> move_def takeWhile_filter'<span class=main>[</span><span class=operator>OF</span> F2<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> sorted_move<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=skolem>move</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sorted_filter F2 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>fst <span class=main>`</span> set <span class=skolem>move</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>ot</span> <span class=main>∧</span> <span class=free>ot</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>&lt;</span> left <span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> move_filter F2<span class=main>(</span>3<span class=main>)</span> set_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> fst_set_before<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>.</span> <span class=main>∀</span><span class=bound>t'</span><span class=main>∈</span>fst <span class=main>`</span> set <span class=skolem>move</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=bound>t'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> F1<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> fst_ts_tuple_rel_before<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>fst <span class=main>`</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    <span class=main>∀</span><span class=bound>t'</span><span class=main>∈</span>fst <span class=main>`</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>move</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=bound>t'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> sorted_lin_data_prev'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_data_prev' <span class=keyword1><span class=command>using</span></span> sorted_filter F2 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_data_in'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_in'</span> <span class=main>=</span> linearize <span class=free>data_in</span> <span class=main>@</span> <span class=skolem>move</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> data_in'_def <span class=keyword1><span class=command>using</span></span> fold_append_queue_rep <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> sorted_lin_data_in'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_data_in' <span class=keyword1><span class=command>using</span></span> F1<span class=main>(</span>1<span class=main>)</span> sorted_move fst_set_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sorted_append<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> set_lin_prev'_in'<span class=main>:</span> <span class=quoted><span class=quoted>"set <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span> <span class=main>=</span>
    set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lin_data_prev' lin_data_in' move_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> ts_tuple_rel'<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> set_lin_prev'_in' <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lookup'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
      <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound><span class=bound>t</span></span><span class=main>,</span> <span class=bound><span class=bound>X</span></span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>move</span><span class=main>.</span> <span class=skolem>as</span> <span class=main>∈</span> <span class=bound>X</span> <span class=main>∧</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>have</span></span> move_absorb<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span>
        <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span> <span class=main>@</span> <span class=skolem>move</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>tuple_in</span> <span class=skolem>as</span> <span class=main>=</span>
        safe_max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>tuple_in</span> <span class=skolem>as</span> <span class=main>=</span>
        safe_max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> lin_data_in' move_absorb <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> Mapping_lookup_fold_upd_set_idle<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>move</span>"</span></span> <span class=quoted><span class=skolem>as</span></span>
          <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>X</span> <span class=bound>t</span><span class=main>.</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span>"</span></span><span class=main>]</span> True
        <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>have</span></span> split<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span>
        fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>move</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>∪</span>
        fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> lin_data_in' set_append ts_tuple_rel_Un <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> max_eq<span class=main>:</span> <span class=quoted><span class=quoted>"Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>move</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span>
        Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> split <span class=keyword1><span class=command>using</span></span> False fst_ts_tuple_rel_before
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def
            <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Max_Un_absorb<span class=main><span class=main>[</span></span><span class=operator>OF</span> finite_fst_ts_tuple_rel _ finite_fst_ts_tuple_rel<span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>move</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span><span class=main>}</span> <span class=main>=</span>
        fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>move</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def image_iff<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> Some <span class=main>(</span>Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>move</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Mapping_lookup_fold_upd_set_max<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>move</span>"</span></span> <span class=quoted><span class=skolem>as</span></span>
          <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>X</span> <span class=bound>t</span><span class=main>.</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> _ sorted_move<span class=main>]</span> False
        <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> max_eq <span class=keyword1><span class=command>using</span></span> False
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def lin_data_in' ts_tuple_rel_def<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> table_in'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_in'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span>
      <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_in'</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>as</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> tuple_in'_keys<span class=main>[</span><span class=operator>OF</span> assm<span class=main>]</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> disjE<span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>as</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def R_def<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>∈</span>set <span class=skolem>move</span><span class=main>.</span> <span class=skolem>as</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>as</span></span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> tX_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>move</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>X</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=main>⋃</span><span class=main>(</span>snd <span class=main>`</span> set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> move_def <span class=keyword1><span class=command>using</span></span> set_takeWhileD <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>as</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def R_def<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> data_prev'_move<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>data_prev'</span><span class=main>,</span> <span class=skolem>move</span><span class=main>)</span> <span class=main>=</span>
    takedropWhile_queue <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=skolem>I</span><span class=main>)</span> <span class=free>data_prev</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> takedropWhile_queue_fst takedropWhile_queue_snd data_prev'_def move_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> surjective_pairing<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=skolem>data_prev'</span><span class=main>,</span> <span class=skolem>data_in'</span><span class=main>,</span>
    <span class=skolem>tuple_in'</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lin_data_prev' sorted_lin_data_prev' lin_data_in' move_filter sorted_lin_data_in'
      nt_mono valid_before ts_tuple_rel' lookup' table_in' <span class=keyword1><span class=command>unfolding</span></span> I_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> valid_mmsaux.simps Let_def n_def R_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span> <span class=operator>auto</span>
      <span class=comment1>(* takes long *)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> add_new_ts_mmsaux'.simps Let_def data_in'_def tuple_in'_def I_def
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_add_new_ts_mmsaux'<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span> <span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span> <span class=main>⟹</span>
  valid_mmsaux <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span>add_new_ts_mmsaux' <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_add_new_ts_mmsaux'_unfolded <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fast</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>add_new_ts_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_ts_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span> add_new_ts_mmsaux' <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>(</span>shift_end <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_add_new_ts_mmsaux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span>add_new_ts_mmsaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_add_new_ts_mmsaux'<span class=main>[</span><span class=operator>OF</span> valid_shift_end_mmsaux<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>]</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>unfolding</span></span> add_new_ts_mmsaux_def <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>join_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>join_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>pos</span> <span class=main>=</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span> <span class=keyword1>then</span>
      <span class=main>(</span><span class=keyword1>let</span> <span class=bound>tuple_in</span> <span class=main>=</span> Mapping.filter <span class=main>(</span>join_filter_cond <span class=bound>pos</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>;</span>
      <span class=bound>tuple_since</span> <span class=main>=</span> Mapping.filter <span class=main>(</span>join_filter_cond <span class=bound>pos</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=keyword1>in</span>
      <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=bound>tuple_in</span><span class=main>,</span> <span class=bound>tuple_since</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=main>(</span><span class=main>∀</span><span class=bound>i</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>.</span> <span class=main>¬</span><span class=bound>i</span><span class=main>)</span> <span class=keyword1>then</span>
      <span class=main>(</span><span class=keyword1>let</span> <span class=bound>nones</span> <span class=main>=</span> replicate <span class=main>(</span>length <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>)</span> None<span class=main>;</span>
      <span class=bound>take_all</span> <span class=main>=</span> <span class=main>(</span><span class=bound>pos</span> <span class=main>⟷</span> <span class=bound>nones</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span><span class=main>;</span>
      <span class=bound>tuple_in</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>take_all</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span> <span class=keyword1>else</span> Mapping.empty<span class=main>)</span><span class=main>;</span>
      <span class=bound>tuple_since</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>take_all</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=keyword1>else</span> Mapping.empty<span class=main>)</span> <span class=keyword1>in</span>
      <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=bound>tuple_in</span><span class=main>,</span> <span class=bound>tuple_since</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span>
      <span class=main>(</span><span class=keyword1>let</span> <span class=bound>tuple_in</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=bound>pos</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=bound>as</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>;</span>
      <span class=bound>tuple_since</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=bound>pos</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=bound>as</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=keyword1>in</span>
      <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=bound>tuple_in</span><span class=main>,</span> <span class=bound>tuple_since</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>join_mmsaux_abs</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>join_mmsaux_abs</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>pos</span> <span class=main>=</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>tuple_in</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=bound>pos</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=bound>as</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>;</span>
    <span class=bound>tuple_since</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=bound>pos</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=bound>as</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=bound>tuple_in</span><span class=main>,</span> <span class=bound>tuple_since</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_filter_cong<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>k</span> <span class=bound>v</span><span class=main>.</span> <span class=bound>k</span> <span class=main>∈</span> Mapping.keys <span class=free>m</span> <span class=main>⟹</span> <span class=free>f</span> <span class=bound>k</span> <span class=bound>v</span> <span class=main>=</span> <span class=free>f'</span> <span class=bound>k</span> <span class=bound>v</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Mapping.filter <span class=free>f</span> <span class=free>m</span> <span class=main>=</span> Mapping.filter <span class=free>f'</span> <span class=free>m</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>k</span><span class=main>.</span> Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span> <span class=bound>k</span> <span class=main>=</span> Mapping.lookup <span class=main>(</span>Mapping.filter <span class=free>f'</span> <span class=free>m</span><span class=main>)</span> <span class=bound>k</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> cong
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> mapping_eqI<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> join_mmsaux_abs_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> table_left<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"join_mmsaux <span class=free>args</span> <span class=free>X</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=main>=</span>
    join_mmsaux_abs <span class=free>args</span> <span class=free>X</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>maskL</span> <span class=main>=</span> <span class=free>maskR</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> keys_wf_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span> <span class=main>⟹</span> wf_tuple <span class=skolem>n</span> <span class=skolem>L</span> <span class=bound>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wf_tuple_change_base valid_before True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def L_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> cong_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span> <span class=bound>n</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span> <span class=main>⟹</span>
    proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=bound>as</span> <span class=free>X</span> <span class=main>⟷</span> join_cond <span class=skolem>pos</span> <span class=free>X</span> <span class=bound>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> proj_tuple_in_join_mask_idle<span class=main>[</span><span class=operator>OF</span> keys_wf_in<span class=main>]</span> valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> valid_mmsaux.simps n_def L_def pos_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> keys_wf_since<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span> <span class=main>⟹</span> wf_tuple <span class=skolem>n</span> <span class=skolem>L</span> <span class=bound>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wf_tuple_change_base valid_before True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def L_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> cong_since<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span> <span class=bound>n</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span> <span class=main>⟹</span>
    proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=bound>as</span> <span class=free>X</span> <span class=main>⟷</span> join_cond <span class=skolem>pos</span> <span class=free>X</span> <span class=bound>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> proj_tuple_in_join_mask_idle<span class=main>[</span><span class=operator>OF</span> keys_wf_since<span class=main>]</span> valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> valid_mmsaux.simps n_def L_def pos_def<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> True Mapping_filter_cong<span class=main>[</span><span class=operator>OF</span> cong_in<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>tuple_in</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>k</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>k</span>"</span></span><span class=main>]</span>
      Mapping_filter_cong<span class=main>[</span><span class=operator>OF</span> cong_since<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>tuple_since</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>k</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>k</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pos_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span> <span class=main>∈</span> set <span class=free>maskL</span><span class=main>.</span> <span class=main>¬</span><span class=bound>i</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>have</span></span> length_maskL<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=free>maskL</span> <span class=main>=</span> <span class=skolem>n</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> join_mask_def n_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> proj_rep<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=bound>as</span> <span class=main>⟹</span> proj_tuple <span class=free>maskL</span> <span class=bound>as</span> <span class=main>=</span> replicate <span class=main>(</span>length <span class=free>maskL</span><span class=main>)</span> None"</span></span>
      <span class=keyword1><span class=command>using</span></span> True proj_tuple_replicate <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> length_maskL wf_tuple_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> keys_wf_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span> <span class=main>⟹</span> wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=bound>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def R_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> keys_wf_since<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span> <span class=main>⟹</span> wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=bound>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def R_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=main>(</span>Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=bound>as</span> <span class=free>X</span><span class=main>)</span>
      <span class=free>tuple_in</span><span class=main>)</span> <span class=bound>as</span> <span class=main>=</span> Mapping.lookup <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=skolem>pos</span> <span class=main>⟷</span> replicate <span class=main>(</span>length <span class=free>maskL</span><span class=main>)</span> None <span class=main>∈</span> <span class=free>X</span><span class=main>)</span>
      <span class=keyword1>then</span> <span class=free>tuple_in</span> <span class=keyword1>else</span> Mapping.empty<span class=main>)</span> <span class=bound>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> proj_rep<span class=main>[</span><span class=operator>OF</span> keys_wf_in<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter Mapping.lookup_empty proj_tuple_in_join_def
          Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=main>(</span>Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=bound>as</span> <span class=free>X</span><span class=main>)</span>
      <span class=free>tuple_since</span><span class=main>)</span> <span class=bound>as</span> <span class=main>=</span> Mapping.lookup <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=skolem>pos</span> <span class=main>⟷</span> replicate <span class=main>(</span>length <span class=free>maskL</span><span class=main>)</span> None <span class=main>∈</span> <span class=free>X</span><span class=main>)</span>
      <span class=keyword1>then</span> <span class=free>tuple_since</span> <span class=keyword1>else</span> Mapping.empty<span class=main>)</span> <span class=bound>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> proj_rep<span class=main>[</span><span class=operator>OF</span> keys_wf_since<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter Mapping.lookup_empty proj_tuple_in_join_def
          Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> False True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> mapping_eqI Let_def pos_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_join_mmsaux_unfolded<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> table_left'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span>join_mmsaux <span class=free>args</span> <span class=free>X</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword1><span class=command>note</span></span> table_left <span class=main>=</span> table_left'<span class=main>[</span><span class=operator>unfolded</span> n_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> L_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>]</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_in'</span> <span class=main>≡</span>
    Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=bound>as</span> <span class=free>X</span><span class=main>)</span> <span class=free>tuple_in</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_since'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_since'</span> <span class=main>≡</span>
    Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=bound>as</span> <span class=free>X</span><span class=main>)</span> <span class=free>tuple_since</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tuple_in_None_None<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_in</span> <span class=bound>as</span> <span class=main>=</span> None <span class=main>⟹</span>
    Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> None"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_not_None <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tuple_in'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_in'</span> <span class=main>⟹</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_in</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_in_None_None
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tuple_since_None_None<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_since</span> <span class=bound>as</span> <span class=main>=</span> None <span class=main>⟹</span>
    Mapping.lookup <span class=skolem>tuple_since'</span> <span class=bound>as</span> <span class=main>=</span> None"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tuple_since'_def <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_not_None <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tuple_since'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_since'</span> <span class=main>⟹</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_since_None_None
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> ts_tuple_rel'<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tas</span>
    <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=skolem><span class=skolem>Z</span></span> <span class=keyword2><span class=keyword>where</span></span> tas_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> join <span class=skolem>Z</span> <span class=skolem>pos</span> <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>Z</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>auxlist</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> join <span class=skolem>Z</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> tas_def<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> table_Z<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>Z</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def R_def<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> proj<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>Z</span>"</span></span> <span class=quoted><span class=quoted>"proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=skolem>as</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tas_def<span class=main>(</span>2<span class=main>)</span> join_sub<span class=main>[</span><span class=operator>OF</span> _ table_left table_Z<span class=main>]</span> valid_before
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span><span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tas_def<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tas_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel
      <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t'</span></span> <span class=keyword2><span class=keyword>where</span></span> t'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>tuple_since</span> <span class=skolem>as</span> <span class=main>=</span> Some <span class=skolem>t'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≥</span> <span class=skolem>t'</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> valid_tuple_since'<span class=main>:</span> <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> proj<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_since'_def Mapping_lookup_filter_Some valid_tuple_def<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tas_in valid_tuple_since' <span class=keyword1><span class=command>unfolding</span></span> tas_def<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tas</span>
    <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel
      <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> tas_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> tas_def<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> tuple_since'_def <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_not_None
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before assm tas_def<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>Z</span></span> <span class=keyword2><span class=keyword>where</span></span> Z_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>Z</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>Z</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>auxlist</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> table_Z<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>Z</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def R_def<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> tas_def<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=skolem>as</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> tuple_since'_def <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_Some_P
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> as_in_join<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> join <span class=skolem>Z</span> <span class=skolem>pos</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> join_sub<span class=main>[</span><span class=operator>OF</span> _ table_left table_Z<span class=main>]</span> Z_def<span class=main>(</span>1<span class=main>)</span> valid_before
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Z_def <span class=keyword1><span class=command>unfolding</span></span> tas_def<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> lookup_tuple_in'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>tuple_in</span> <span class=skolem>as</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> None
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> safe_max_empty_dest<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_not_None
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> tuple_in_None_None<span class=main>[</span><span class=operator>OF</span> None<span class=main>]</span> <span class=keyword1><span class=command>using</span></span> iffD2<span class=main>[</span><span class=operator>OF</span> safe_max_empty<span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>t</span><span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"proj_tuple_in_join <span class=skolem>pos</span> <span class=free>maskL</span> <span class=skolem>as</span> <span class=free>X</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> lookup_tuple_in'<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> Some <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Some <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_lookup_filter_Some<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before Some <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> safe_max_Some_dest_in<span class=main><span class=main>[</span></span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> t_in_fst<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_iff valid_tuple_def tuple_since'_def
            Mapping_lookup_filter_Some <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t'</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⟹</span> valid_tuple <span class=free>tuple_since</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_not_None
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t'</span><span class=main>.</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
          valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=bound>t'</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t'</span> <span class=main>≤</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before Some safe_max_Some_dest_le<span class=main>[</span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_iff<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Max_eqI<span class=main>[</span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"linearize <span class=free>data_in</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>,</span>
            <span class=operator>OF</span> _ t_in_fst<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> lookup_tuple_in' <span class=keyword1><span class=command>using</span></span> t_in_fst <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> lookup_tuple'<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> None"</span></span>
          <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_since'</span> <span class=skolem>as</span> <span class=main>=</span> None"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> tuple_in'_def tuple_since'_def
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_lookup_filter_None<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tas</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span>valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> lookup_tuple' <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> safe_max_def<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> table_join'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span> <span class=bound>ys</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>ys</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>auxlist</span> <span class=main>⟹</span> table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>join <span class=bound>ys</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>t</span> <span class=skolem>ys</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>ys</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> table_ys<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=skolem>ys</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>join <span class=skolem>ys</span> <span class=skolem>pos</span> <span class=free>X</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> join_table<span class=main>[</span><span class=operator>OF</span> table_ys table_left<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>pos</span></span> <span class=quoted><span class=skolem>R</span></span><span class=main>]</span> valid_before
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> table_in'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_in'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_in'_keys valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def table_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> table_since'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_since'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_since'_keys valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def table_def<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> join_mmsaux_abs_eq<span class=main>[</span><span class=operator>OF</span> valid_before table_left'<span class=main>]</span>
    <span class=keyword1><span class=command>using</span></span> valid_before ts_tuple_rel' lookup_tuple_in' tuple_in'_def tuple_since'_def table_join'
      Mapping_filter_keys<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>tuple_since</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>as</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>as</span> <span class=keyword1>of</span> Some <span class=bound>t</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span><span class=main>]</span>
      table_in' table_since' <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def L_def R_def pos_def table_def Let_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_join_mmsaux<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span>
  table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>X</span> <span class=main>⟹</span> valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
  <span class=main>(</span>join_mmsaux <span class=free>args</span> <span class=free>X</span> <span class=free>aux</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_join_mmsaux_unfolded <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fast</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>gc_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>gc_mmsaux</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>all_tuples</span> <span class=main>=</span> <span class=main>⋃</span><span class=main>(</span>snd <span class=main>`</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>;</span>
    <span class=bound>tuple_since'</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=bound>all_tuples</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=bound>tuple_since'</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_gc_mmsaux_unfolded<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span>
    <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>ys</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>gc_mmsaux <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span>
    <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span><span class=main>)</span> <span class=free>ys</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>all_tuples</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>all_tuples</span> <span class=main>≡</span> <span class=main>⋃</span><span class=main>(</span>snd <span class=main>`</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
    set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_since'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_since'</span> <span class=main>≡</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=skolem>all_tuples</span><span class=main>)</span> <span class=free>tuple_since</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tuple_since_None_None<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_since</span> <span class=bound>as</span> <span class=main>=</span> None <span class=main>⟹</span>
    Mapping.lookup <span class=skolem>tuple_since'</span> <span class=bound>as</span> <span class=main>=</span> None"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tuple_since'_def <span class=keyword1><span class=command>using</span></span> Mapping_lookup_filter_not_None <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tuple_since'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_since'</span> <span class=main>⟹</span> <span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuple_since_None_None
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> table_since'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_since'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def R_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> data_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tas</span><span class=main>.</span> <span class=bound>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
    set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>=</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tas</span>
    <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
    set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≡</span> fst <span class=skolem>tas</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>≡</span> snd <span class=skolem>tas</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>all_tuples</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> as_def all_tuples_def ts_tuple_rel_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_since'</span> <span class=skolem>as</span> <span class=main>=</span> Mapping.lookup <span class=free>tuple_since</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_since'_def Mapping.lookup_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=skolem>tas</span> <span class=main>=</span> valid_tuple <span class=free>tuple_since</span> <span class=skolem>tas</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def as_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> data_in_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tas</span><span class=main>.</span> <span class=bound>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
    valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>=</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_Un<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=free>ys</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> data_cong valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=free>tuple_in</span> <span class=bound>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> <span class=main>(</span><span class=operator>meson</span> data_in_cong<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_since'</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>tuple_since'</span> <span class=bound>as</span> <span class=keyword1>of</span>
    Some <span class=bound>t</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Mapping.keys_filter valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_since'_def Mapping.lookup_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits
        <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> all_tuples_def tuple_since'_def valid_before table_since'
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> n_def R_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_gc_mmsaux<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>ys</span> <span class=main>⟹</span> valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>gc_mmsaux <span class=free>aux</span><span class=main>)</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_gc_mmsaux_unfolded <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fast</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>gc_join_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>gc_join_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>if</span> enat <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>)</span> <span class=main>&gt;</span> right <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=keyword1>then</span> join_mmsaux <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span>gc_mmsaux <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span>
      <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1>else</span> join_mmsaux <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> gc_join_mmsaux_alt<span class=main>:</span> <span class=quoted><span class=quoted>"gc_join_mmsaux <span class=free>args</span> <span class=free>rel1</span> <span class=free>aux</span> <span class=main>=</span> join_mmsaux <span class=free>args</span> <span class=free>rel1</span> <span class=main>(</span>gc_mmsaux <span class=free>aux</span><span class=main>)</span> <span class=main>∨</span>
  gc_join_mmsaux <span class=free>args</span> <span class=free>rel1</span> <span class=free>aux</span> <span class=main>=</span> join_mmsaux <span class=free>args</span> <span class=free>rel1</span> <span class=free>aux</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> gc_join_mmsaux.simps <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> valid_gc_join_mmsaux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>gc_join_mmsaux <span class=free>args</span> <span class=free>rel1</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=main>(</span>args_pos <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> gc_join_mmsaux_alt<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>args</span></span> <span class=quoted><span class=free>rel1</span></span> <span class=quoted><span class=free>aux</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>using</span></span> valid_join_mmsaux<span class=main>[</span><span class=operator>OF</span> valid_gc_mmsaux<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    valid_join_mmsaux<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>add_new_table_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_table_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>tuple_since</span> <span class=main>=</span> upd_set <span class=free><span class=bound><span class=entity>tuple_since</span></span></span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>-</span> Mapping.keys <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=main>0</span> <span class=main>≥</span> left <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=keyword1>then</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> append_queue <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span>
      upd_set <span class=free><span class=bound><span class=entity>tuple_in</span></span></span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>,</span> <span class=bound>tuple_since</span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> append_queue <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=bound>tuple_since</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_add_new_table_mmsaux_unfolded<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> table_X<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>add_new_table_mmsaux <span class=free>args</span> <span class=free>X</span>
    <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span><span class=keyword1>case</span> <span class=free>auxlist</span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>=&gt;</span> <span class=main>[</span><span class=main>(</span><span class=free>cur</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>]</span>
    <span class=main>|</span> <span class=main>(</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=free>cur</span> <span class=keyword1>then</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span> <span class=main>∪</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span> <span class=keyword1>else</span> <span class=main>(</span><span class=free>cur</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> cur_nt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>cur</span> <span class=main>=</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_in'</span> <span class=main>≡</span> upd_set <span class=free>tuple_in</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=free>nt</span><span class=main>)</span> <span class=free>X</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tuple_since'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tuple_since'</span> <span class=main>≡</span> upd_set <span class=free>tuple_since</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=free>nt</span><span class=main>)</span>
    <span class=main>(</span><span class=free>X</span> <span class=main>-</span> Mapping.keys <span class=free>tuple_since</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>data_prev'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>data_prev'</span> <span class=main>≡</span> append_queue <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=free>data_prev</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>data_in'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>data_in'</span> <span class=main>≡</span> append_queue <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=free>data_in</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>auxlist'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>auxlist'</span> <span class=main>≡</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>auxlist</span> <span class=keyword1>of</span>
    <span class=main>[]</span> <span class=main>=&gt;</span> <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>]</span>
    <span class=main>|</span> <span class=main>(</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=free>nt</span> <span class=keyword1>then</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span> <span class=main>∪</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span> <span class=keyword1>else</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> table_in'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_in'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> table_X valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def tuple_in'_def Mapping_upd_set_keys n_def R_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> table_since'<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>tuple_since'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> table_X valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def tuple_since'_def Mapping_upd_set_keys n_def R_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tuple_since'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=free>tuple_since</span> <span class=main>⊆</span> Mapping.keys <span class=skolem>tuple_since'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Mapping_upd_set_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_since'_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> lin_data_prev'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_prev'</span> <span class=main>=</span> linearize <span class=free>data_prev</span> <span class=main>@</span> <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> data_prev'_def append_queue_rep <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> wf_data_prev'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>⋃</span><span class=main>(</span>snd <span class=main>`</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> wf_tuple <span class=skolem>n</span> <span class=skolem>R</span> <span class=bound>as</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_data_prev' <span class=keyword1><span class=command>using</span></span> table_X valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def R_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> lin_data_in'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_in'</span> <span class=main>=</span> linearize <span class=free>data_in</span> <span class=main>@</span> <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> data_in'_def append_queue_rep <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> table_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=skolem>auxlist'</span><span class=main>.</span> table <span class=skolem>n</span> <span class=skolem>R</span> <span class=bound>X</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> table_X table_Un valid_before
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> auxlist'_def n_def R_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> lookup_tuple_since'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>as</span> <span class=main>∈</span> Mapping.keys <span class=skolem>tuple_since'</span><span class=main>.</span>
    <span class=keyword1>case</span> Mapping.lookup <span class=skolem>tuple_since'</span> <span class=bound>as</span> <span class=keyword1>of</span> Some <span class=bound>t</span> <span class=main>⇒</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tuple_since'_def <span class=keyword1><span class=command>using</span></span> valid_before Mapping_lookup_upd_set<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>tuple_since</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> ts_tuple_rel_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=skolem>auxlist'</span><span class=main>)</span> <span class=main>=</span>
    ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span> <span class=main>∪</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> auxlist'_def
    <span class=keyword1><span class=command>using</span></span> ts_tuple_rel_ext ts_tuple_rel_ext' ts_tuple_rel_ext_Cons ts_tuple_rel_ext_Cons'
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.splits if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> valid_tuple_nt_X<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tas</span><span class=main>.</span> <span class=bound>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span> <span class=main>⟹</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def valid_tuple_def tuple_since'_def
        Mapping_lookup_upd_set <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> valid_tuple_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tas</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>⟹</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def Mapping_lookup_upd_set
        <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> ts_tuple_rel_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tuple_rel <span class=main>(</span>set <span class=skolem>auxlist'</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span>
    valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tas</span>
    <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>auxlist'</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
      set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assm<span class=main>[</span><span class=operator>unfolded</span> ts_tuple_rel_auxlist' ts_tuple_rel_Un<span class=main>]</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> UnE<span class=main>)</span>
      <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
        set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
        set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> ts_tuple_rel_Un <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> valid_tuple_mono<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
        set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assm valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_Un tuple_since'_def
            valid_tuple_def Mapping_lookup_upd_set ts_tuple_rel_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest
            <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tas</span>
    <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
      set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>(</span>ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
      set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>∪</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> ts_tuple_rel_Un<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>auxlist'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> UnE<span class=main>)</span>
      <span class=keyword3><span class=command>assume</span></span> assm'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
        set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> ts_tuple_rel <span class=main>{</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tas_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span>
        set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> tas_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>tas</span></span><span class=main>)</span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span> <span class=main>∪</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assm' <span class=keyword1><span class=command>unfolding</span></span> tas_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> t_le_nt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> valid_tas<span class=main>:</span> <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=skolem>tas</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assm <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=free>tuple_since</span> <span class=skolem>tas</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> valid_tas tas_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def
              Mapping_lookup_upd_set <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> <span class=free>nt</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=free>X</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_tas t_le_nt <span class=keyword1><span class=command>unfolding</span></span> tas_def
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def Mapping_lookup_upd_set
              <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"False"</span></span>
          <span class=keyword1><span class=command>using</span></span> assm' <span class=keyword1><span class=command>unfolding</span></span> tas_def ts_tuple_rel_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=skolem>auxlist'</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> tas_in valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_auxlist'<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> ts_tuple_rel_auxlist'<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>≥</span> left <span class=skolem>I</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> add_def<span class=main>:</span> <span class=quoted><span class=quoted>"add_new_table_mmsaux <span class=free>args</span> <span class=free>X</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span>
      <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=skolem>data_in'</span><span class=main>,</span>
      <span class=skolem>tuple_in'</span><span class=main>,</span> <span class=skolem>tuple_since'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> data_in'_def tuple_in'_def tuple_since'_def <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> left_I<span class=main>:</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>∧</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>≥</span> left <span class=skolem>I</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lin_data_in'<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> Mapping.lookup <span class=skolem>tuple_in'</span> <span class=bound>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
      <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>tuple_in'</span> <span class=skolem>as</span> <span class=main>=</span> safe_max <span class=main>(</span>fst <span class=main>`</span>
        <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=free>X</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def
              Mapping_lookup_upd_set <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>insert <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> nt_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>insert <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span>
          <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
          <span class=keyword3><span class=command>assume</span></span> a1<span class=main>:</span> <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>insert <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>.</span> <span class=free>nt</span> <span class=main>=</span> fst <span class=bound>p</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>insert <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span>
            <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>p</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>p</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> a1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>p</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>insert <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
            valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>p</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>p</span><span class=main>}</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>insert <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span>
          <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>⟹</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
            <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> eq_imp_le fst_conv insertE ts_tuple_rel_dest<span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=main>(</span>fst <span class=main>`</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>
          <span class=main>∪</span> set <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span><span class=main>.</span> valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=free>nt</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Max_eqI<span class=main>[</span><span class=operator>OF</span> finite_fst_ts_tuple_rel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>data_in'</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>,</span>
              <span class=operator>unfolded</span> lin_data_in' set_append<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> nt_in True
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_in'_def Mapping_lookup_upd_set safe_max_def lin_data_in'<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span>
          <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=skolem>data_in'</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
          valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lin_data_in' ts_tuple_rel_def valid_tuple_def
              tuple_since'_def Mapping_lookup_upd_set <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro
              <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> valid_before False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tuple_in'_def Mapping_lookup_upd_set<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms table_auxlist' sorted_append<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"map fst <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span><span class=main>]</span>
        lookup_tuple_since' ts_tuple_rel_auxlist' table_in' table_since'
      <span class=keyword1><span class=command>unfolding</span></span> add_def auxlist'_def<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> cur_nt I_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> valid_mmsaux.simps lin_data_in' n_def R_def<span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> add_def<span class=main>:</span> <span class=quoted><span class=quoted>"add_new_table_mmsaux <span class=free>args</span> <span class=free>X</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span>
      <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=skolem>data_prev'</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span>
      <span class=free>tuple_in</span><span class=main>,</span> <span class=skolem>tuple_since'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> data_prev'_def tuple_since'_def <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> left_I<span class=main>:</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> fst <span class=main>`</span> set <span class=main>(</span>linearize <span class=skolem>data_prev'</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>∧</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=main>&lt;</span> left <span class=skolem>I</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lin_data_prev' I_def<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span><span class=main>.</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span> <span class=main>=</span>
      <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span> <span class=skolem>tas</span>
      <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=skolem>tuple_since'</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>Z</span></span> <span class=keyword2><span class=keyword>where</span></span> Z_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=skolem>Z</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>Z</span><span class=main>)</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"valid_tuple <span class=skolem>tuple_since'</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tas</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>tas</span></span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=main>(</span>linearize <span class=free>data_in</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
        valid_tuple <span class=free>tuple_since</span> <span class=bound>tas</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>=</span> snd <span class=bound>tas</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assm
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> Mapping.keys <span class=free>tuple_since</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≥</span> <span class=free>nt</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Z_def<span class=main>(</span>4<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def
              Mapping_lookup_upd_set <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> Z_def<span class=main>(</span>3<span class=main>)</span> valid_before left_I <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_tuple_def tuple_since'_def Mapping_lookup_upd_set
           <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_lookup_upd_set valid_tuple_def tuple_since'_def
         <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms table_auxlist' sorted_append<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"map fst <span class=main>(</span>linearize <span class=free>data_prev</span><span class=main>)</span>"</span></span><span class=main>]</span>
        False lookup_tuple_since' ts_tuple_rel_auxlist' table_in' table_since' wf_data_prev'
        valid_before
      <span class=keyword1><span class=command>unfolding</span></span> add_def auxlist'_def<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> cur_nt I_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> valid_mmsaux.simps lin_data_prev' n_def R_def<span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
        <span class=comment1>(* takes long *)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_add_new_table_mmsaux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> table_X<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=main>(</span>add_new_table_mmsaux <span class=free>args</span> <span class=free>X</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span><span class=keyword1>case</span> <span class=free>auxlist</span> <span class=keyword1>of</span>
      <span class=main>[]</span> <span class=main>=&gt;</span> <span class=main>[</span><span class=main>(</span><span class=free>cur</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span><span class=main>]</span>
    <span class=main>|</span> <span class=main>(</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=free>cur</span> <span class=keyword1>then</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span> <span class=main>∪</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span> <span class=keyword1>else</span> <span class=main>(</span><span class=free>cur</span><span class=main>,</span> <span class=free>X</span><span class=main>)</span> <span class=main>#</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_add_new_table_mmsaux_unfolded assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fast</span>

<span class=keyword1><span class=command>lemma</span></span> foldr_ts_tuple_rel<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> foldr <span class=main>(∪)</span> <span class=main>(</span>concat <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=main>[</span><span class=bound>rel</span><span class=main>]</span> <span class=keyword1>else</span> <span class=main>[]</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>{}</span> <span class=main>⟷</span>
  <span class=main>(</span><span class=main>∃</span><span class=bound>t</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> iffI<span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> foldr <span class=main>(∪)</span> <span class=main>(</span>concat <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=main>[</span><span class=bound>rel</span><span class=main>]</span> <span class=keyword1>else</span> <span class=main>[]</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> tX_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>t</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=skolem>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_foldr_UnE<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>t</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>t</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>t</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> ts_tuple_rel <span class=main>(</span>set <span class=free>auxlist</span><span class=main>)</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>t</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>X</span></span> <span class=keyword2><span class=keyword>where</span></span> tX_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>t</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=skolem>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>X</span><span class=main>)</span> <span class=main>∈</span> set <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tuple_rel_def<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> foldr <span class=main>(∪)</span> <span class=main>(</span>concat <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=main>[</span><span class=bound>rel</span><span class=main>]</span> <span class=keyword1>else</span> <span class=main>[]</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> in_foldr_UnI<span class=main>[</span><span class=operator>OF</span> tX_def<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> tX_def assm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>auxlist</span></span><span class=main>)</span> <span class=operator>force</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> image_snd<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=free>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>⟹</span> <span class=free>b</span> <span class=main>∈</span> snd <span class=main>`</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>result_mmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> mmsaux <span class=main>⇒</span> <span class=tfree>'a</span> table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>result_mmsaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>gc</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_prev</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>data_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_in</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tuple_since</span></span></span><span class=main>)</span> <span class=main>=</span>
    Mapping.keys <span class=free><span class=bound><span class=entity>tuple_in</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_result_mmsaux_unfolded<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span>
    <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"result_mmsaux <span class=free>args</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>gc</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>data_prev</span><span class=main>,</span> <span class=free>data_in</span><span class=main>,</span> <span class=free>tuple_in</span><span class=main>,</span> <span class=free>tuple_since</span><span class=main>)</span> <span class=main>=</span>
    foldr <span class=main>(∪)</span> <span class=main>[</span><span class=bound>rel</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=free>auxlist</span><span class=main>,</span> left <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>≤</span> <span class=free>cur</span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_mmsaux_tuple_in_keys<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_Un ts_tuple_rel_Un foldr_ts_tuple_rel image_snd<span class=main>)</span>
     <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> ts_tuple_rel_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> ts_tuple_rel_dest<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_result_mmsaux<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmsaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span> <span class=main>⟹</span>
  result_mmsaux <span class=free>args</span> <span class=free>aux</span> <span class=main>=</span> foldr <span class=main>(∪)</span> <span class=main>[</span><span class=bound>rel</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=free>auxlist</span><span class=main>,</span> left <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>≤</span> <span class=free>cur</span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_result_mmsaux_unfolded <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fast</span>

<span class=keyword1><span class=command>interpretation</span></span> default_msaux<span class=main>:</span> msaux <span class=quoted>valid_mmsaux</span> <span class=quoted>init_mmsaux</span> <span class=quoted>add_new_ts_mmsaux</span> <span class=quoted>gc_join_mmsaux</span>
  <span class=quoted>add_new_table_mmsaux</span> <span class=quoted>result_mmsaux</span>
  <span class=keyword1><span class=command>using</span></span> valid_init_mmsaux valid_add_new_ts_mmsaux valid_gc_join_mmsaux valid_add_new_table_mmsaux
    valid_result_mmsaux
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>assumption</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Optimized data structure for Until›</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> tp <span class=main>=</span> <span class=quoted>nat</span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> mmuaux <span class=main>=</span> <span class=quoted><span class=quoted>"tp <span class=main>×</span> ts queue <span class=main>×</span> nat <span class=main>×</span> bool list <span class=main>×</span> bool list <span class=main>×</span>
  <span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> tp<span class=main>)</span> mapping <span class=main>×</span> <span class=main>(</span>tp<span class=main>,</span> <span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> ts <span class=main>+</span> tp<span class=main>)</span> mapping<span class=main>)</span> mapping <span class=main>×</span> <span class=tfree>'a</span> table list <span class=main>×</span> nat"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>tstp_lt</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ts <span class=main>+</span> tp <span class=main>⇒</span> ts <span class=main>⇒</span> tp <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>tstp_lt</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>=</span> case_sum <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span><span class=main>.</span> <span class=bound>ts'</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> <span class=bound>tp'</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>tstp_le</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ts <span class=main>+</span> tp <span class=main>⇒</span> ts <span class=main>⇒</span> tp <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>tstp_le</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>=</span> case_sum <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span><span class=main>.</span> <span class=bound>ts'</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> <span class=bound>tp'</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>ts_tp_lt</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ts <span class=main>⇒</span> tp <span class=main>⇒</span> ts <span class=main>+</span> tp <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ts_tp_lt</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=free><span class=bound><span class=entity>tstp</span></span></span> <span class=main>=</span> case_sum <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≤</span> <span class=bound>ts'</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>&lt;</span> <span class=bound>tp'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>ts_tp_lt'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ts <span class=main>⇒</span> tp <span class=main>⇒</span> ts <span class=main>+</span> tp <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ts_tp_lt'</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=free><span class=bound><span class=entity>tstp</span></span></span> <span class=main>=</span> case_sum <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>&lt;</span> <span class=bound>ts'</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>≤</span> <span class=bound>tp'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>ts_tp_le</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ts <span class=main>⇒</span> tp <span class=main>⇒</span> ts <span class=main>+</span> tp <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ts_tp_le</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=free><span class=bound><span class=entity>tstp</span></span></span> <span class=main>=</span> case_sum <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≤</span> <span class=bound>ts'</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>≤</span> <span class=bound>tp'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tstp</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>max_tstp</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ts <span class=main>+</span> tp <span class=main>⇒</span> ts <span class=main>+</span> tp <span class=main>⇒</span> ts <span class=main>+</span> tp"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>max_tstp</span> <span class=main>(</span>Inl <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span>Inl <span class=free><span class=bound><span class=entity>ts'</span></span></span><span class=main>)</span> <span class=main>=</span> Inl <span class=main>(</span>max <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>ts'</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>max_tstp</span> <span class=main>(</span>Inr <span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>)</span> <span class=main>(</span>Inr <span class=free><span class=bound><span class=entity>tp'</span></span></span><span class=main>)</span> <span class=main>=</span> Inr <span class=main>(</span>max <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=free><span class=bound><span class=entity>tp'</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>max_tstp</span> <span class=main>(</span>Inl <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> Inl <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>max_tstp</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>(</span>Inl <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>=</span> Inl <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_idem<span class=main>:</span> <span class=quoted><span class=quoted>"max_tstp <span class=main>(</span>max_tstp <span class=free>x</span> <span class=free>y</span><span class=main>)</span> <span class=free>y</span> <span class=main>=</span> max_tstp <span class=free>x</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>x</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>y</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_idem'<span class=main>:</span> <span class=quoted><span class=quoted>"max_tstp <span class=free>x</span> <span class=main>(</span>max_tstp <span class=free>x</span> <span class=free>y</span><span class=main>)</span> <span class=main>=</span> max_tstp <span class=free>x</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>x</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>y</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_d_d<span class=main>:</span> <span class=quoted><span class=quoted>"max_tstp <span class=free>d</span> <span class=free>d</span> <span class=main>=</span> <span class=free>d</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>d</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> max_cases<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>max <span class=free>a</span> <span class=free>b</span> <span class=main>=</span> <span class=free>a</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span>max <span class=free>a</span> <span class=free>b</span> <span class=main>=</span> <span class=free>b</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> max_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstpE<span class=main>:</span> <span class=quoted><span class=quoted>"isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span> <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span> <span class=main>=</span> <span class=free>tstp</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span> <span class=main>=</span> <span class=free>tstp'</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tstp</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>tstp'</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> max_cases<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_intro<span class=main>:</span> <span class=quoted><span class=quoted>"tstp_lt <span class=free>tstp</span> <span class=free>ts</span> <span class=free>tp</span> <span class=main>⟹</span> tstp_lt <span class=free>tstp'</span> <span class=free>ts</span> <span class=free>tp</span> <span class=main>⟹</span> isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span>
  tstp_lt <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span><span class=main>)</span> <span class=free>ts</span> <span class=free>tp</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tstp_lt_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_intro'<span class=main>:</span> <span class=quoted><span class=quoted>"isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span>
  ts_tp_le <span class=free>ts'</span> <span class=free>tp'</span> <span class=free>tstp</span> <span class=main>⟹</span> ts_tp_le <span class=free>ts'</span> <span class=free>tp'</span> <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tstp</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>tstp'</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_le_def tstp_le_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_intro''<span class=main>:</span> <span class=quoted><span class=quoted>"isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span>
  ts_tp_le <span class=free>ts'</span> <span class=free>tp'</span> <span class=free>tstp'</span> <span class=main>⟹</span> ts_tp_le <span class=free>ts'</span> <span class=free>tp'</span> <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tstp</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>tstp'</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_le_def tstp_le_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_intro'''<span class=main>:</span> <span class=quoted><span class=quoted>"isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span>
  ts_tp_lt' <span class=free>ts'</span> <span class=free>tp'</span> <span class=free>tstp</span> <span class=main>⟹</span> ts_tp_lt' <span class=free>ts'</span> <span class=free>tp'</span> <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tstp</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>tstp'</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def tstp_le_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_intro''''<span class=main>:</span> <span class=quoted><span class=quoted>"isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span>
  ts_tp_lt' <span class=free>ts'</span> <span class=free>tp'</span> <span class=free>tstp'</span> <span class=main>⟹</span> ts_tp_lt' <span class=free>ts'</span> <span class=free>tp'</span> <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tstp</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>tstp'</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def tstp_le_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> max_tstp_isl<span class=main>:</span> <span class=quoted><span class=quoted>"isl <span class=free>tstp</span> <span class=main>⟷</span> isl <span class=free>tstp'</span> <span class=main>⟹</span> isl <span class=main>(</span>max_tstp <span class=free>tstp</span> <span class=free>tstp'</span><span class=main>)</span> <span class=main>⟷</span> isl <span class=free>tstp</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>tstp</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>cases</span> <span class=quoted><span class=free>tstp'</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>filter_a1_map</span> <span class=main>::</span> <span class=quoted><span class=quoted>"bool <span class=main>⇒</span> tp <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> tp<span class=main>)</span> mapping <span class=main>⇒</span> <span class=tfree>'a</span> table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>filter_a1_map</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span> <span class=main>=</span>
    <span class=main>{</span><span class=bound><span class=bound>xs</span></span> <span class=main>∈</span> Mapping.keys <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>a1_map</span></span></span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tp'</span> <span class=main>⇒</span>
    <span class=main>(</span><span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>⟶</span> <span class=bound>tp'</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>¬</span><span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=main>⟶</span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>≤</span> <span class=bound>tp'</span><span class=main>)</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>filter_a2_map</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ℐ <span class=main>⇒</span> ts <span class=main>⇒</span> tp <span class=main>⇒</span> <span class=main>(</span>tp<span class=main>,</span> <span class=main>(</span><span class=tfree>'a</span> tuple<span class=main>,</span> ts <span class=main>+</span> tp<span class=main>)</span> mapping<span class=main>)</span> mapping <span class=main>⇒</span>
  <span class=tfree>'a</span> table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>filter_a2_map</span> <span class=free><span class=bound><span class=entity>I</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=bound>xs</span><span class=main>.</span> <span class=main>∃</span><span class=bound><span class=bound>tp'</span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>.</span> <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>a2_map</span></span></span> <span class=bound>tp'</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span>
    <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span> ts_tp_lt' <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=bound>tstp</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span>
    <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> False<span class=main>)</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>triple_eq_pair</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'b</span> <span class=main>×</span> <span class=tfree>'c</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'d</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'d</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'d</span> <span class=main>⇒</span> <span class=tfree>'c</span><span class=main>)</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>triple_eq_pair</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ts'</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tp'</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>ts'</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>a1</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>tp'</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>a2</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>ts'</span></span></span> <span class=free><span class=bound><span class=entity>tp'</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>valid_mmuaux'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux <span class=main>⇒</span> <span class=tfree>'a</span> muaux <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_mmuaux'</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=free><span class=bound><span class=entity>dt</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>,</span>
    <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>auxlist</span></span></span> <span class=main>⟷</span>
    args_L <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>⊆</span> args_R <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>maskL</span></span></span> <span class=main>=</span> join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_L <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>maskR</span></span></span> <span class=main>=</span> join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>∧</span>
    length <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>∧</span> sorted <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=main>∧</span> enat <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=main>≤</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    table <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_L <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>Mapping.keys <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>)</span> <span class=main>∧</span>
    Mapping.keys <span class=free><span class=bound><span class=entity>a2_map</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>..</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>}</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>a1_map</span></span></span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tp'</span> <span class=main>⇒</span> <span class=bound>tp'</span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>tp'</span> <span class=main>∈</span> Mapping.keys <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>a2_map</span></span></span> <span class=bound>tp'</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span>
      table <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>Mapping.keys <span class=bound>m</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=bound>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
      tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=main>-</span> <span class=main>(</span>left <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
    length <span class=free><span class=bound><span class=entity>done</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span> <span class=main>∧</span> length <span class=free><span class=bound><span class=entity>done</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>=</span> length <span class=free><span class=bound><span class=entity>auxlist</span></span></span> <span class=main>∧</span>
    rev <span class=free><span class=bound><span class=entity>done</span></span></span> <span class=main>=</span> map proj_thd <span class=main>(</span>take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>)</span><span class=main>.</span> check_before <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>dt</span></span></span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span>
    sorted <span class=main>(</span>map fst <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>)</span> <span class=main>∧</span>
    list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=main>(</span>args_pos <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=bound>tp'</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>auxlist</span></span></span><span class=main>)</span>
      <span class=main>(</span>zip <span class=main>(</span>linearize <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>)</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>]</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valid_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux <span class=main>⇒</span> <span class=tfree>'a</span> muaux <span class=main>⇒</span>
  bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_mmuaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=main>=</span> valid_mmuaux' <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>cur</span></span></span> <span class=free><span class=bound><span class=entity>cur</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_step_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> mmuaux <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_step_mmuaux</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>,</span>
    <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> safe_hd <span class=free><span class=bound><span class=entity>tss</span></span></span> <span class=keyword1>of</span> <span class=main>(</span>Some <span class=bound>ts</span><span class=main>,</span> <span class=bound>tss'</span><span class=main>)</span> <span class=main>⇒</span>
      <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>a2_map</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>)</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span>
        <span class=keyword1>let</span> <span class=bound>m</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=bound>tstp</span><span class=main>.</span> ts_tp_lt' <span class=bound>ts</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>)</span> <span class=bound>tstp</span><span class=main>)</span> <span class=bound>m</span><span class=main>;</span>
        <span class=bound>T</span> <span class=main>=</span> Mapping.keys <span class=bound>m</span><span class=main>;</span>
        <span class=bound>a2_map</span> <span class=main>=</span> Mapping.update <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>
          <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>a2_map</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=keyword1>of</span> Some <span class=bound>m'</span> <span class=main>⇒</span>
          Mapping.combine <span class=main>(</span><span class=main>λ</span><span class=bound>tstp</span> <span class=bound>tstp'</span><span class=main>.</span> max_tstp <span class=bound>tstp</span> <span class=bound>tstp'</span><span class=main>)</span> <span class=bound>m</span> <span class=bound>m'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>;</span>
        <span class=bound>a2_map</span> <span class=main>=</span> Mapping.delete <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>)</span> <span class=bound>a2_map</span> <span class=keyword1>in</span>
        <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> tl_queue <span class=bound>tss'</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>-</span> <span class=main>1</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=bound>a2_map</span><span class=main>,</span>
        <span class=bound>T</span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_update_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=main>(</span>Mapping.update <span class=free>a</span> <span class=free>b</span> <span class=free>m</span><span class=main>)</span> <span class=main>=</span> Mapping.keys <span class=free>m</span> <span class=main>∪</span> <span class=main>{</span><span class=free>a</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> drop_is_Cons_take<span class=main>:</span> <span class=quoted><span class=quoted>"drop <span class=free>n</span> <span class=free>xs</span> <span class=main>=</span> <span class=free>y</span> <span class=main>#</span> <span class=free>ys</span> <span class=main>⟹</span> take <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span> take <span class=free>n</span> <span class=free>xs</span> <span class=main>@</span> <span class=main>[</span><span class=free>y</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>n</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>x</span> <span class=skolem>xs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>n</span></span><span class=main>)</span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_weaken<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=free>f</span> <span class=free>xs</span> <span class=free>ys</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∈</span> set <span class=main>(</span>zip <span class=free>xs</span> <span class=free>ys</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>f</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟹</span> <span class=free>f'</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟹</span> list_all2 <span class=free>f'</span> <span class=free>xs</span> <span class=free>ys</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>ys</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> list_all2_induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_delete<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>Mapping.delete <span class=free>k</span> <span class=free>m</span><span class=main>)</span> <span class=free>k'</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>if</span> <span class=free>k</span> <span class=main>=</span> <span class=free>k'</span> <span class=keyword1>then</span> None <span class=keyword1>else</span> Mapping.lookup <span class=free>m</span> <span class=free>k'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_update<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>Mapping.update <span class=free>k</span> <span class=free>v</span> <span class=free>m</span><span class=main>)</span> <span class=free>k'</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>if</span> <span class=free>k</span> <span class=main>=</span> <span class=free>k'</span> <span class=keyword1>then</span> Some <span class=free>v</span> <span class=keyword1>else</span> Mapping.lookup <span class=free>m</span> <span class=free>k'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> hd_le_set<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=free>xs</span> <span class=main>⟹</span> <span class=free>xs</span> <span class=main>≠</span> <span class=main>[]</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> hd <span class=free>xs</span> <span class=main>≤</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> eq_iff list.sel<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> set_ConsD sorted.elims<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_lookup_combineE<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>Mapping.combine <span class=free>f</span> <span class=free>m</span> <span class=free>m'</span><span class=main>)</span> <span class=free>k</span> <span class=main>=</span> Some <span class=free>v</span> <span class=main>⟹</span>
  <span class=main>(</span>Mapping.lookup <span class=free>m</span> <span class=free>k</span> <span class=main>=</span> Some <span class=free>v</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span>Mapping.lookup <span class=free>m'</span> <span class=free>k</span> <span class=main>=</span> Some <span class=free>v</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>v'</span> <span class=bound>v''</span><span class=main>.</span> Mapping.lookup <span class=free>m</span> <span class=free>k</span> <span class=main>=</span> Some <span class=bound>v'</span> <span class=main>⟹</span> Mapping.lookup <span class=free>m'</span> <span class=free>k</span> <span class=main>=</span> Some <span class=bound>v''</span> <span class=main>⟹</span>
  <span class=free>f</span> <span class=bound>v'</span> <span class=bound>v''</span> <span class=main>=</span> <span class=free>v</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Mapping.lookup_combine
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> combine_options_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_keys_filterI<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>m</span> <span class=free>k</span> <span class=main>=</span> Some <span class=free>v</span> <span class=main>⟹</span> <span class=free>f</span> <span class=free>k</span> <span class=free>v</span> <span class=main>⟹</span>
  <span class=free>k</span> <span class=main>∈</span> Mapping.keys <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> Mapping_keys_filterD<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>∈</span> Mapping.keys <span class=main>(</span>Mapping.filter <span class=free>f</span> <span class=free>m</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>∃</span><span class=bound>v</span><span class=main>.</span> Mapping.lookup <span class=free>m</span> <span class=free>k</span> <span class=main>=</span> Some <span class=bound>v</span> <span class=main>∧</span> <span class=free>f</span> <span class=free>k</span> <span class=bound>v</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>lin_ts_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> mmuaux <span class=main>⇒</span> ts list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>lin_ts_mmuaux</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span><span class=main>)</span> <span class=main>=</span>
    linearize <span class=free><span class=bound><span class=entity>tss</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_eval_step_mmuaux'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=free>aux</span> <span class=main>=</span> <span class=free>ts</span> <span class=main>#</span> <span class=free>tss''</span>"</span></span> <span class=quoted><span class=quoted>"enat <span class=free>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>dt</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span> <span class=main>(</span>eval_step_mmuaux <span class=free>aux</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>∧</span>
    lin_ts_mmuaux <span class=main>(</span>eval_step_mmuaux <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> <span class=free>tss''</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp</span></span> <span class=skolem><span class=skolem>len</span></span> <span class=skolem><span class=skolem>tss</span></span> <span class=skolem><span class=skolem>maskL</span></span> <span class=skolem><span class=skolem>maskR</span></span> <span class=skolem><span class=skolem>a1_map</span></span> <span class=skolem><span class=skolem>a2_map</span></span> <span class=quoted>"<span class=skolem><span class=skolem>done</span></span>"</span> <span class=skolem><span class=skolem>done_length</span></span> <span class=keyword2><span class=keyword>where</span></span> aux_def<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tss'</span></span> <span class=keyword2><span class=keyword>where</span></span> safe_hd_eq<span class=main>:</span> <span class=quoted><span class=quoted>"safe_hd <span class=skolem>tss</span> <span class=main>=</span> <span class=main>(</span>Some <span class=free>ts</span><span class=main>,</span> <span class=skolem>tss'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> safe_hd_rep case_optionE
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"safe_hd <span class=skolem>tss</span>"</span></span><span class=main>)</span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>note</span></span> valid_before <span class=main>=</span> assms<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> aux_def<span class=main>]</span>
  <span class=keyword1><span class=command>have</span></span> lin_tss_not_Nil<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>tss</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> safe_hd_rep<span class=main>[</span><span class=operator>OF</span> safe_hd_eq<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> ts_hd<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ts</span> <span class=main>=</span> hd <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> safe_hd_rep<span class=main>[</span><span class=operator>OF</span> safe_hd_eq<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_tss'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>tss'</span> <span class=main>=</span> linearize <span class=skolem>tss</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> safe_hd_rep<span class=main>[</span><span class=operator>OF</span> safe_hd_eq<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> tss'_not_empty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>is_empty <span class=skolem>tss'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> is_empty_alt<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>tss'</span></span><span class=main>]</span> lin_tss_not_Nil <span class=keyword1><span class=command>unfolding</span></span> lin_tss' <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> len_pos<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>len</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lin_tss_not_Nil valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> a2_map_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>a2_map</span> <span class=main>=</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> len_tp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>len</span> <span class=main>≤</span> <span class=skolem>tp</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> tp_minus_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> a2_map_keys <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> tp_minus_keys'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> a2_map_keys len_pos len_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tp_minus_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>m</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tp_minus_keys m_def valid_before
    <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux'.simps n_def I_def R_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> m_inst<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>m</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>m</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Mapping_keys_intro <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> m_inst_isl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>m</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span> isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> m_inst<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tp_minus_keys' <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>m'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>m'</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>m'</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tp_minus_keys' m'_def valid_before
    <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux'.simps I_def n_def R_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> m'_inst<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>m'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>m'</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Mapping_keys_intro <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> m'_inst_isl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>m'</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span> isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> m'_inst<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>m_upd</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m_upd</span> <span class=main>=</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=bound>tstp</span><span class=main>.</span> ts_tp_lt' <span class=free>ts</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=bound>tstp</span><span class=main>)</span> <span class=skolem>m</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>T</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>T</span> <span class=main>=</span> Mapping.keys <span class=skolem>m_upd</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>mc</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>mc</span> <span class=main>=</span> Mapping.combine <span class=main>(</span><span class=main>λ</span><span class=bound>tstp</span> <span class=bound>tstp'</span><span class=main>.</span> max_tstp <span class=bound>tstp</span> <span class=bound>tstp'</span><span class=main>)</span> <span class=skolem>m_upd</span> <span class=skolem>m'</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>a2_map'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2_map'</span> <span class=main>=</span> Mapping.update <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=skolem>mc</span> <span class=skolem>a2_map</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>a2_map''</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2_map''</span> <span class=main>=</span> Mapping.delete <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>a2_map'</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> m_upd_lookup<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>m_upd</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> m_upd_def Mapping.lookup_filter
    <span class=keyword1><span class=command>using</span></span> m_inst<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> mc_lookup<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>mc</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mc_def Mapping.lookup_combine
    <span class=keyword1><span class=command>using</span></span> m_upd_lookup m'_inst<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> combine_options_def max_tstp_isl <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max_tstp_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> mc_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>mc</span> <span class=main>⊆</span> Mapping.keys <span class=skolem>m</span> <span class=main>∪</span> Mapping.keys <span class=skolem>m'</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mc_def Mapping.keys_combine m_upd_def
    <span class=keyword1><span class=command>using</span></span> Mapping.keys_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>have</span></span> tp_len_assoc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> len_pos len_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> a2_map''_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>a2_map''</span> <span class=main>=</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> a2_map''_def a2_map'_def Mapping.keys_delete Mapping_update_keys a2_map_keys
    <span class=keyword1><span class=command>using</span></span> tp_len_assoc <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_tss_Cons<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>tss</span> <span class=main>=</span> <span class=free>ts</span> <span class=main>#</span> linearize <span class=main>(</span>tl_queue <span class=skolem>tss'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lin_tss_not_Nil
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tl_queue_rep<span class=main><span class=main>[</span></span><span class=operator>OF</span> tss'_not_empty<span class=main><span class=main>]</span></span> lin_tss' ts_hd<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> tp_len_tp_unfold<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>#</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tp_len_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=keyword1><span class=command>using</span></span> len_pos len_tp Suc_diff_le upt_conv_Cons <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> id<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>+</span> <span class=main>1</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span> <span class=main>⟹</span>
    Mapping.lookup <span class=skolem>a2_map''</span> <span class=bound>x</span> <span class=main>=</span> Mapping.lookup <span class=skolem>a2_map</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> a2_map''_def a2_map'_def Mapping_lookup_delete Mapping_lookup_update tp_len_assoc
    <span class=keyword1><span class=command>using</span></span> len_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> list_all2<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>(</span>zip <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>unfolding</span></span> I_def pos_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>hd_aux</span></span> <span class=skolem><span class=skolem>tl_aux</span></span> <span class=keyword2><span class=keyword>where</span></span> aux_split<span class=main>:</span> <span class=quoted><span class=quoted>"drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>=</span> <span class=skolem>hd_aux</span> <span class=main>#</span> <span class=skolem>tl_aux</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=keyword1>case</span> <span class=skolem>hd_aux</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=free>ts</span><span class=main>,</span> filter_a1_map <span class=skolem>pos</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>a1_map</span><span class=main>,</span> filter_a2_map <span class=skolem>I</span> <span class=free>ts</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>a2_map</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> list_all2'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tl_aux</span>
      <span class=main>(</span>zip <span class=main>(</span>linearize <span class=main>(</span>tl_queue <span class=skolem>tss'</span><span class=main>)</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> list_all2<span class=main>[</span><span class=operator>unfolded</span> lin_tss_Cons tp_len_tp_unfold zip_Cons_Cons list_all2_Cons2<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lookup''_tp_minus<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map''</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>mc</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> a2_map''_def a2_map'_def Mapping_lookup_delete Mapping_lookup_update
      tp_len_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=keyword1><span class=command>using</span></span> len_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> filter_a2_map_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> <span class=bound>ts'</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=bound>tp'</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>}</span> <span class=main>⟹</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map</span> <span class=main>=</span>
    filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map''</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>xs</span>
    <span class=keyword3><span class=command>assume</span></span> assms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ts'</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp_bef</span></span> <span class=skolem><span class=skolem>m_bef</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> defs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp_bef</span> <span class=main>=</span> Some <span class=skolem>m_bef</span>"</span></span>
      <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m_bef</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>tstp</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a2_map_def<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> ts_le_ts'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ts</span> <span class=main>≤</span> <span class=skolem>ts'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> hd_le_set<span class=main>[</span><span class=operator>OF</span> _ lin_tss_not_Nil assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> valid_before
      <span class=keyword1><span class=command>unfolding</span></span> ts_hd <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> tp_bef_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>2<span class=main>)</span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> tp_minus_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map''</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>≤</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>have</span></span> m_bef_m<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m_bef</span> <span class=main>=</span> <span class=skolem>m</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>2<span class=main>)</span> m_def
          <span class=keyword1><span class=command>unfolding</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m_upd</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>3<span class=main>,</span>4<span class=main>)</span> assms<span class=main>(</span>2<span class=main>)</span> ts_le_ts' <span class=keyword1><span class=command>unfolding</span></span> m_bef_m m_upd_def
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter ts_tp_lt'_def <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro
              <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> Mapping.lookup <span class=skolem>mc</span> <span class=skolem>xs</span> <span class=keyword1>of</span> None <span class=main>⇒</span> False <span class=main>|</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
          ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=bound>tstp</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> mc_def Mapping.lookup_combine
          <span class=keyword1><span class=command>using</span></span> m'_inst<span class=main>(</span>2<span class=main>)</span> m_upd_lookup
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> combine_options_def defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> max_tstp_intro'''
              <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> lookup''_tp_minus tp_minus_le defs
          <span class=keyword1><span class=command>unfolding</span></span> m_bef_m filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True tp_bef_in <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> m_bef_m<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m_bef</span> <span class=main>=</span> <span class=skolem>m'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>2<span class=main>)</span> m'_def
          <span class=keyword1><span class=command>unfolding</span></span> tp_len_assoc <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> Mapping.lookup <span class=skolem>mc</span> <span class=skolem>xs</span> <span class=keyword1>of</span> None <span class=main>⇒</span> False <span class=main>|</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
          ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=bound>tstp</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> mc_def Mapping.lookup_combine
          <span class=keyword1><span class=command>using</span></span> m'_inst<span class=main>(</span>2<span class=main>)</span> m_upd_lookup defs<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m_bef_m<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> combine_options_def defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> max_tstp_intro''''
              <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> lookup''_tp_minus tp_minus_le defs
          <span class=keyword1><span class=command>unfolding</span></span> m_bef_m filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map''</span> <span class=skolem>tp_bef</span> <span class=main>=</span> Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp_bef</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> id tp_bef_in len_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def
        <span class=keyword1><span class=command>using</span></span> defs <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>xs</span>
    <span class=keyword3><span class=command>assume</span></span> assms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ts'</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map''</span>"</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp_bef</span></span> <span class=skolem><span class=skolem>m_bef</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> defs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span>
      <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map''</span> <span class=skolem>tp_bef</span> <span class=main>=</span> Some <span class=skolem>m_bef</span>"</span></span>
      <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m_bef</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>tstp</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a2_map_def<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> ts_le_ts'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ts</span> <span class=main>≤</span> <span class=skolem>ts'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> hd_le_set<span class=main>[</span><span class=operator>OF</span> _ lin_tss_not_Nil assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> valid_before
      <span class=keyword1><span class=command>unfolding</span></span> ts_hd <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> tp_bef_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>2<span class=main>)</span> a2_map''_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> tp_minus_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>have</span></span> m_beg_mc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m_bef</span> <span class=main>=</span> <span class=skolem>mc</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>unfolding</span></span> True a2_map''_def a2_map'_def tp_len_assoc Mapping_lookup_delete
          Mapping.lookup_update
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m_beg_mc mc_def<span class=main>]</span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> Mapping_lookup_combineE<span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> lassm<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m_upd</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> m_upd_def Mapping.lookup_filter
          <span class=keyword1><span class=command>using</span></span> m_def tp_minus_le<span class=main>(</span>1<span class=main>)</span> defs
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> lassm<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> m'_def defs<span class=main>(</span>4<span class=main>)</span> tp_minus_le defs
          <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def tp_len_assoc
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v'</span> <span class=skolem>v''</span>
        <span class=keyword3><span class=command>assume</span></span> lassms<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m_upd</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>v'</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>v''</span>"</span></span>
          <span class=quoted><span class=quoted>"max_tstp <span class=skolem>v'</span> <span class=skolem>v''</span> <span class=main>=</span> <span class=skolem>tstp</span>"</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> max_tstpE<span class=main>)</span>
          <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"isl <span class=skolem>v'</span> <span class=main>=</span> isl <span class=skolem>v''</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> m_upd_lookup m'_inst<span class=main>(</span>2<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"max_tstp <span class=skolem>v'</span> <span class=skolem>v''</span> <span class=main>=</span> <span class=skolem>v'</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span> m_def defs tp_minus_le<span class=main>(</span>1<span class=main>)</span>
            <span class=keyword1><span class=command>unfolding</span></span> tp_len_assoc m_upd_def Mapping.lookup_filter
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"max_tstp <span class=skolem>v'</span> <span class=skolem>v''</span> <span class=main>=</span> <span class=skolem>v''</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>2<span class=main>,</span>3<span class=main>)</span> m'_def defs tp_minus_le<span class=main>(</span>2<span class=main>)</span>
            <span class=keyword1><span class=command>unfolding</span></span> tp_len_assoc
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map''</span> <span class=skolem>tp_bef</span> <span class=main>=</span> Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp_bef</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> id tp_bef_in <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def
        <span class=keyword1><span class=command>using</span></span> defs <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> <span class=main>(</span><span class=operator>metis</span> option.simps<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> set_tl_tss'<span class=main>:</span> <span class=quoted><span class=quoted>"set <span class=main>(</span>linearize <span class=main>(</span>tl_queue <span class=skolem>tss'</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tl_queue_rep<span class=main>[</span><span class=operator>OF</span> tss'_not_empty<span class=main>]</span> lin_tss_Cons <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> list_all2''<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map''</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tl_aux</span>
      <span class=main>(</span>zip <span class=main>(</span>linearize <span class=main>(</span>tl_queue <span class=skolem>tss'</span><span class=main>)</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> filter_a2_map_cong set_tl_tss'
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> list_all2_weaken<span class=main><span class=main>[</span></span><span class=operator>OF</span> list_all2'<span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> in_set_zipE <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> prod.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> lookup''<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>tp'</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map''</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>a2_map''</span> <span class=bound>tp'</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span>
    table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=bound>m</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=bound>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> ballI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tp'</span>
    <span class=keyword3><span class=command>assume</span></span> assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map''</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=keyword2><span class=keyword>where</span></span> f_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map''</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>f</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> tp'_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assm <span class=keyword1><span class=command>unfolding</span></span> a2_map''_keys <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tp'_in_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>f</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>f</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>f</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
      tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> f_mc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>=</span> <span class=skolem>mc</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> f_def
        <span class=keyword1><span class=command>unfolding</span></span> a2_map''_def a2_map'_def Mapping_lookup_delete Mapping_lookup_update tp_len_assoc
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>f</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> f_mc
        <span class=keyword1><span class=command>using</span></span> mc_keys m_def m'_def m_inst m'_inst
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>f</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>f</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
        tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assm Mapping.keys_filter m_inst<span class=main>(</span>2<span class=main>)</span> m_inst_isl m'_inst<span class=main>(</span>2<span class=main>)</span> m'_inst_isl max_tstp_isl
        <span class=keyword1><span class=command>unfolding</span></span> f_mc mc_def Mapping.lookup_combine
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> combine_options_def m_upd_def Mapping.lookup_filter
            <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> max_tstp_intro Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_dest
            <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>f</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> tp'_in id<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>tp'</span></span><span class=main>]</span> f_def False <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> tp'_in_keys valid_before
        <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux'.simps I_def n_def R_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> Mapping.lookup <span class=skolem>a2_map''</span> <span class=skolem>tp'</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span>
      table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=bound>m</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=bound>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
      tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> f_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> tl_aux_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tl_aux</span> <span class=main>=</span> drop <span class=main>(</span>length <span class=skolem>done</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> aux_split<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Suc_eq_plus1 add_Suc drop0 drop_Suc_Cons drop_drop<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> T_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>T</span> <span class=main>=</span> filter_a2_map <span class=skolem>I</span> <span class=free>ts</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>a2_map</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=free>ts</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>a2_map</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp_bef</span></span> <span class=skolem><span class=skolem>m_bef</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> defs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>≤</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span>"</span></span>
      <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp_bef</span> <span class=main>=</span> Some <span class=skolem>m_bef</span>"</span></span>
      <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m_bef</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=free>ts</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>tstp</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tp_bef_minus<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp_bef</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_before Mapping_keys_intro <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>have</span></span> m_bef_m<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m_bef</span> <span class=main>=</span> <span class=skolem>m</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> defs<span class=main>(</span>2<span class=main>)</span> m_def
      <span class=keyword1><span class=command>unfolding</span></span> tp_bef_minus <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>T</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> defs
      <span class=keyword1><span class=command>unfolding</span></span> T_def m_upd_def m_bef_m
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_filterI Mapping_keys_intro<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>T</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=free>ts</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>a2_map</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> m_def Mapping.keys_filter
      <span class=keyword1><span class=command>unfolding</span></span> T_def m_upd_def filter_a2_map_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_filterD <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> min_auxlist_done<span class=main>:</span> <span class=quoted><span class=quoted>"min <span class=main>(</span>length <span class=free>auxlist</span><span class=main>)</span> <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=main>=</span> length <span class=skolem>done</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>.</span> check_before <span class=skolem>I</span> <span class=free>dt</span> <span class=bound>x</span>"</span></span>
    <span class=quoted><span class=quoted>"rev <span class=skolem>done</span> <span class=main>=</span> map proj_thd <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> list_all'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=main>(</span><span class=skolem>T</span> <span class=main>#</span> <span class=skolem>done</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>.</span> check_before <span class=skolem>I</span> <span class=free>dt</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"rev <span class=main>(</span><span class=skolem>T</span> <span class=main>#</span> <span class=skolem>done</span><span class=main>)</span> <span class=main>=</span> map proj_thd <span class=main>(</span>take <span class=main>(</span>length <span class=main>(</span><span class=skolem>T</span> <span class=main>#</span> <span class=skolem>done</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> drop_is_Cons_take<span class=main>[</span><span class=operator>OF</span> aux_split<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> aux_split<span class=main>(</span>2<span class=main>)</span> assms<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> T_eq I_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> eval_step_mmuaux_eq<span class=main>:</span> <span class=quoted><span class=quoted>"eval_step_mmuaux <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span>
    <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> tl_queue <span class=skolem>tss'</span><span class=main>,</span> <span class=skolem>len</span> <span class=main>-</span> <span class=main>1</span><span class=main>,</span>  <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map''</span><span class=main>,</span>
    <span class=skolem>T</span> <span class=main>#</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> safe_hd_eq m_def m'_def m_upd_def T_def mc_def a2_map'_def a2_map''_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=main>(</span>eval_step_mmuaux <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> <span class=free>tss''</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lin_tss_Cons assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> aux_def eval_step_mmuaux_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> valid_before a2_map''_keys sorted_tl list_all' lookup'' list_all2''
    <span class=keyword1><span class=command>unfolding</span></span> eval_step_mmuaux_eq valid_mmuaux'.simps tl_aux_def aux_def I_def n_def R_def pos_def
    <span class=keyword1><span class=command>using</span></span> lin_tss_not_Nil safe_hd_eq len_pos
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list.set_sel<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> lin_tss' tl_queue_rep<span class=main><span class=main>[</span></span><span class=operator>OF</span> tss'_not_empty<span class=main><span class=main>]</span></span> min_auxlist_done<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> done_empty_valid_mmuaux'_intro<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span>
    <span class=main>(</span><span class=free>tp</span><span class=main>,</span> <span class=free>tss</span><span class=main>,</span> <span class=free>len</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>a1_map</span><span class=main>,</span> <span class=free>a2_map</span><span class=main>,</span> <span class=free>done</span><span class=main>,</span> <span class=free>done_length</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt'</span>
    <span class=main>(</span><span class=free>tp</span><span class=main>,</span> <span class=free>tss</span><span class=main>,</span> <span class=free>len</span><span class=main>,</span> <span class=free>maskL</span><span class=main>,</span> <span class=free>maskR</span><span class=main>,</span> <span class=free>a1_map</span><span class=main>,</span> <span class=free>a2_map</span><span class=main>,</span> <span class=main>[]</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>
    <span class=main>(</span>drop <span class=main>(</span>length <span class=free>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sorted_drop <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> drop_map<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> valid_mmuaux'_mono<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>dt</span> <span class=main>≤</span> <span class=free>dt'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt'</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms less_le_trans <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>fastforce</span>

<span class=keyword1><span class=command>lemma</span></span> valid_foldl_eval_step_mmuaux'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=free>aux</span> <span class=main>=</span> <span class=free>tss</span> <span class=main>@</span> <span class=free>tss'</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>ts</span><span class=main>.</span> <span class=bound>ts</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=free>tss</span><span class=main>)</span> <span class=main>(</span>lin_ts_mmuaux <span class=free>aux</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> enat <span class=bound>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>dt</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span> <span class=main>(</span>foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=free>tss</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>∧</span>
    lin_ts_mmuaux <span class=main>(</span>foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=free>tss</span><span class=main>)</span> <span class=main>=</span> <span class=free>tss'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>tss</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>ts</span> <span class=skolem>tss</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> app_ass<span class=main>:</span> <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=skolem>aux</span> <span class=main>=</span> <span class=skolem>ts</span> <span class=main>#</span> <span class=main>(</span><span class=skolem>tss</span> <span class=main>@</span> <span class=free>tss'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"enat <span class=skolem>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>dt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> valid_step<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>dt</span> <span class=main>(</span>eval_step_mmuaux <span class=skolem>aux</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=main>(</span>eval_step_mmuaux <span class=skolem>aux</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>tss</span> <span class=main>@</span> <span class=free>tss'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_eval_step_mmuaux'<span class=main>[</span><span class=operator>OF</span> Cons<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> app_ass<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> valid_step<span class=main>]</span> valid_step Cons<span class=main>(</span>4<span class=main>)</span> app_ass <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> sorted_dropWhile_filter<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=free>xs</span> <span class=main>⟹</span> dropWhile <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span>
  filter <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> <span class=main>¬</span>enat <span class=bound>t</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span><span class=main>)</span> <span class=free>xs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>xs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>x</span> <span class=skolem>xs</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"enat <span class=skolem>x</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> neg<span class=main>:</span> <span class=quoted><span class=quoted>"enat <span class=skolem>x</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>≥</span> enat <span class=free>nt</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>z</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> set <span class=skolem>xs</span> <span class=main>⟹</span> <span class=main>¬</span>enat <span class=bound>z</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>z</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span> <span class=main>∈</span> set <span class=skolem>xs</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"enat <span class=skolem>z</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>≥</span> enat <span class=skolem>x</span> <span class=main>+</span> right <span class=free>I</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> neg <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"enat <span class=skolem>z</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>≥</span> enat <span class=free>nt</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> dual_order.trans <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>enat <span class=skolem>z</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>with</span></span> False <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> filter_empty_conv <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>shift_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>shift_mmuaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=bound>tss_list</span> <span class=main>=</span> linearize <span class=main>(</span>takeWhile_queue <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>&lt;</span> enat <span class=free><span class=bound><span class=entity>nt</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>)</span> <span class=keyword1>in</span>
    foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span>
      <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span><span class=main>)</span> <span class=bound>tss_list</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_shift_mmuaux'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span> <span class=main>(</span>shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>ts</span> <span class=main>∈</span> set <span class=main>(</span>lin_ts_mmuaux <span class=main>(</span>shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> <span class=main>¬</span>enat <span class=bound>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>nt</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> valid_folded<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> valid_mmuaux'_mono <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp</span></span> <span class=skolem><span class=skolem>len</span></span> <span class=skolem><span class=skolem>tss</span></span> <span class=skolem><span class=skolem>maskL</span></span> <span class=skolem><span class=skolem>maskR</span></span> <span class=skolem><span class=skolem>a1_map</span></span> <span class=skolem><span class=skolem>a2_map</span></span> <span class=quoted>"<span class=skolem><span class=skolem>done</span></span>"</span> <span class=skolem><span class=skolem>done_length</span></span> <span class=keyword2><span class=keyword>where</span></span> aux_def<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>note</span></span> valid_before <span class=main>=</span> valid_folded<span class=main>[</span><span class=operator>unfolded</span> aux_def<span class=main>]</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tss_list</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tss_list</span> <span class=main>=</span>
    linearize <span class=main>(</span>takeWhile_queue <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span><span class=main>)</span> <span class=skolem>tss</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> tss_list_takeWhile<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tss_list</span> <span class=main>=</span> takeWhile <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span><span class=main>)</span> <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tss_list_def <span class=keyword1><span class=command>unfolding</span></span> takeWhile_queue_rep <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tss_list'</span></span> <span class=keyword2><span class=keyword>where</span></span> tss_list'_def<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>tss</span> <span class=main>=</span> <span class=skolem>tss_list</span> <span class=main>@</span> <span class=skolem>tss_list'</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>tss_list'</span> <span class=main>=</span> dropWhile <span class=main>(</span><span class=main>λ</span><span class=bound>t</span><span class=main>.</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>&lt;</span> enat <span class=free>nt</span><span class=main>)</span> <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp'</span></span> <span class=skolem><span class=skolem>len'</span></span> <span class=skolem><span class=skolem>tss'</span></span> <span class=skolem><span class=skolem>maskL'</span></span> <span class=skolem><span class=skolem>maskR'</span></span> <span class=skolem><span class=skolem>a1_map'</span></span> <span class=skolem><span class=skolem>a2_map'</span></span> <span class=quoted>"<span class=skolem><span class=skolem>done'</span></span>"</span> <span class=skolem><span class=skolem>done_length'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    foldl_aux_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=skolem>tss'</span><span class=main>,</span> <span class=skolem>len'</span><span class=main>,</span> <span class=skolem>maskL'</span><span class=main>,</span> <span class=skolem>maskR'</span><span class=main>,</span> <span class=skolem>a1_map'</span><span class=main>,</span> <span class=skolem>a2_map'</span><span class=main>,</span>
      <span class=skolem>done'</span><span class=main>,</span> <span class=skolem>done_length'</span><span class=main>)</span> <span class=main>=</span> foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=skolem>tss_list</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=skolem>tss_list</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_tss_aux<span class=main>:</span> <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=free>aux</span> <span class=main>=</span> linearize <span class=skolem>tss</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"take <span class=main>(</span>length <span class=skolem>tss_list</span><span class=main>)</span> <span class=main>(</span>lin_ts_mmuaux <span class=free>aux</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>tss_list</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_tss_aux <span class=keyword1><span class=command>using</span></span> tss_list'_def<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> valid_foldl<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span>
    <span class=main>(</span>foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=skolem>tss_list</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"lin_ts_mmuaux <span class=main>(</span>foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=skolem>tss_list</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>tss_list'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_foldl_eval_step_mmuaux'<span class=main>[</span><span class=operator>OF</span> valid_before<span class=main><span class=main>[</span></span><span class=operator>folded</span> aux_def<span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>unfolded</span> lin_tss_aux<span class=main>,</span>
      <span class=operator>OF</span> tss_list'_def<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> tss_list_takeWhile set_takeWhileD
    <span class=keyword1><span class=command>unfolding</span></span> lin_tss_aux I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> shift_mmuaux_eq<span class=main>:</span> <span class=quoted><span class=quoted>"shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> foldl <span class=main>(</span><span class=main>λ</span><span class=bound>aux</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> eval_step_mmuaux <span class=bound>aux</span><span class=main>)</span> <span class=free>aux</span> <span class=skolem>tss_list</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tss_list_def <span class=keyword1><span class=command>unfolding</span></span> aux_def I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>ts</span><span class=main>.</span> <span class=bound>ts</span> <span class=main>∈</span> set <span class=skolem>tss_list'</span> <span class=main>⟹</span> <span class=main>¬</span>enat <span class=bound>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sorted_dropWhile_filter tss_list'_def<span class=main>(</span>2<span class=main>)</span> valid_before <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> valid_foldl<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> shift_mmuaux_eq<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> valid_foldl<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> shift_mmuaux_eq<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> upd_set' <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping <span class=main>⇒</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'b</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> set <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>m</span> <span class=bound>d</span> <span class=bound>f</span> <span class=bound>X</span> <span class=bound>a</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>a</span> <span class=main>∈</span> <span class=bound>X</span> <span class=keyword1>then</span> <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span> <span class=keyword1>of</span> Some <span class=bound>b</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=bound>f</span> <span class=bound>b</span><span class=main>)</span> <span class=main>|</span> None <span class=main>⇒</span> Some <span class=bound>d</span><span class=main>)</span>
    <span class=keyword1>else</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_lookup<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=free>a</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>X</span> <span class=keyword1>then</span>
  <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free>m</span> <span class=free>a</span> <span class=keyword1>of</span> Some <span class=bound>b</span> <span class=main>⇒</span> Some <span class=main>(</span><span class=free>f</span> <span class=bound>b</span><span class=main>)</span> <span class=main>|</span> None <span class=main>⇒</span> Some <span class=free>d</span><span class=main>)</span> <span class=keyword1>else</span> Mapping.lookup <span class=free>m</span> <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup.rep_eq upd_set'.rep_eq<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=main>(</span>upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=main>=</span> Mapping.keys <span class=free>m</span> <span class=main>∪</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_set'_lookup <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro
      <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> upd_nested <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'b</span><span class=main>,</span> <span class=tfree>'c</span><span class=main>)</span> mapping<span class=main>)</span> mapping <span class=main>⇒</span>
  <span class=tfree>'c</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'c</span> <span class=main>⇒</span> <span class=tfree>'c</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'b</span><span class=main>)</span> set <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'b</span><span class=main>,</span> <span class=tfree>'c</span><span class=main>)</span> mapping<span class=main>)</span> mapping"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>m</span> <span class=bound>d</span> <span class=bound>f</span> <span class=bound>X</span> <span class=bound>a</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span> <span class=keyword1>of</span> Some <span class=bound>m'</span> <span class=main>⇒</span> Some <span class=main>(</span>upd_set' <span class=bound>m'</span> <span class=bound>d</span> <span class=bound>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=bound>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>}</span><span class=main>)</span>
  <span class=main>|</span> None <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>a</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=bound>X</span> <span class=keyword1>then</span> Some <span class=main>(</span>upd_set' Mapping.empty <span class=bound>d</span> <span class=bound>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=bound>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>}</span><span class=main>)</span> <span class=keyword1>else</span> None"</span></span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> upd_nested_lookup<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>upd_nested <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=free>a</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free>m</span> <span class=free>a</span> <span class=keyword1>of</span> Some <span class=bound>m'</span> <span class=main>⇒</span> Some <span class=main>(</span>upd_set' <span class=bound>m'</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>
  <span class=main>|</span> None <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free>a</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=free>X</span> <span class=keyword1>then</span> Some <span class=main>(</span>upd_set' Mapping.empty <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span> <span class=keyword1>else</span> None<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup.abs_eq upd_nested.abs_eq<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_nested_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=main>(</span>upd_nested <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=free>X</span><span class=main>)</span> <span class=main>=</span> Mapping.keys <span class=free>m</span> <span class=main>∪</span> fst <span class=main>`</span> <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_nested_lookup Domain.DomainI fst_eq_Domain <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro
      <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>add_new_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> <span class=tfree>'a</span> table <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_mmuaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>rel1</span></span></span> <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>tp</span><span class=main>,</span> <span class=bound>tss</span><span class=main>,</span> <span class=bound>len</span><span class=main>,</span> <span class=bound>maskL</span><span class=main>,</span> <span class=bound>maskR</span><span class=main>,</span> <span class=bound>a1_map</span><span class=main>,</span> <span class=bound>a2_map</span><span class=main>,</span> <span class=bound>done</span><span class=main>,</span> <span class=bound>done_length</span><span class=main>)</span> <span class=main>=</span>
    shift_mmuaux <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span><span class=main>;</span>
    <span class=bound>I</span> <span class=main>=</span> args_ivl <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>;</span> <span class=bound>pos</span> <span class=main>=</span> args_pos <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>;</span>
    <span class=bound>new_tstp</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> left <span class=bound>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> Inr <span class=bound>tp</span> <span class=keyword1>else</span> Inl <span class=main>(</span><span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=main>-</span> <span class=main>(</span>left <span class=bound>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>;</span>
    <span class=bound>tmp</span> <span class=main>=</span> <span class=main>⋃</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>as</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>a1_map</span> <span class=main>(</span>proj_tuple <span class=bound>maskL</span> <span class=bound>as</span><span class=main>)</span> <span class=keyword1>of</span> None <span class=main>⇒</span>
      <span class=main>(</span><span class=keyword1>if</span> <span class=main>¬</span><span class=bound>pos</span> <span class=keyword1>then</span> <span class=main>{</span><span class=main>(</span><span class=bound>tp</span> <span class=main>-</span> <span class=bound>len</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>
      <span class=main>|</span> Some <span class=bound>tp'</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>pos</span> <span class=keyword1>then</span> <span class=main>{</span><span class=main>(</span>max <span class=main>(</span><span class=bound>tp</span> <span class=main>-</span> <span class=bound>len</span><span class=main>)</span> <span class=bound>tp'</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span>
      <span class=keyword1>else</span> <span class=main>{</span><span class=main>(</span>max <span class=main>(</span><span class=bound>tp</span> <span class=main>-</span> <span class=bound>len</span><span class=main>)</span> <span class=main>(</span><span class=bound>tp'</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>rel2</span></span></span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> left <span class=bound>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>{</span><span class=bound>tp</span><span class=main>}</span> <span class=main>×</span> <span class=free><span class=bound><span class=entity>rel2</span></span></span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span><span class=main>;</span>
    <span class=bound>a2_map</span> <span class=main>=</span> Mapping.update <span class=main>(</span><span class=bound>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> Mapping.empty
      <span class=main>(</span>upd_nested <span class=bound>a2_map</span> <span class=bound>new_tstp</span> <span class=main>(</span>max_tstp <span class=bound>new_tstp</span><span class=main>)</span> <span class=bound>tmp</span><span class=main>)</span><span class=main>;</span>
    <span class=bound>a1_map</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>pos</span> <span class=keyword1>then</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>rel1</span></span></span><span class=main>)</span>
      <span class=main>(</span>upd_set <span class=bound>a1_map</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>tp</span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>rel1</span></span></span> <span class=main>-</span> Mapping.keys <span class=bound>a1_map</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>else</span> upd_set <span class=bound>a1_map</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>tp</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>rel1</span></span></span><span class=main>)</span><span class=main>;</span>
    <span class=bound>tss</span> <span class=main>=</span> append_queue <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=bound>tss</span> <span class=keyword1>in</span>
    <span class=main>(</span><span class=bound>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>,</span> <span class=bound>tss</span><span class=main>,</span> <span class=bound>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>,</span> <span class=bound>maskL</span><span class=main>,</span> <span class=bound>maskR</span><span class=main>,</span> <span class=bound>a1_map</span><span class=main>,</span> <span class=bound>a2_map</span><span class=main>,</span> <span class=bound>done</span><span class=main>,</span> <span class=bound>done_length</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> fst_case<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> fst <span class=main>(</span><span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=free>y</span> <span class=bound>t</span> <span class=bound>a1</span> <span class=bound>a2</span><span class=main>,</span> <span class=free>z</span> <span class=bound>t</span> <span class=bound>a1</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fst"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_in_setE<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=free>P</span> <span class=free>xs</span> <span class=free>ys</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=free>ys</span> <span class=main>⟹</span> <span class=free>P</span> <span class=free>x</span> <span class=bound>y</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_all2_iff set_zip in_set_conv_nth<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_zip<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=free>f</span> <span class=free>g</span><span class=main>)</span> <span class=free>xs</span> <span class=main>(</span>zip <span class=free>ys</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=free>ys</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=free>Q</span> <span class=main>(</span>fst <span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_zip <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_in_setE triple_eq_pair.elims<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> list_appendE<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>xs</span> <span class=main>=</span> <span class=free>ys</span> <span class=main>@</span> <span class=free>zs</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=free>x</span> <span class=main>∈</span> set <span class=free>ys</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>x</span> <span class=main>∈</span> set <span class=free>zs</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> take_takeWhile<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>≤</span> length <span class=free>ys</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=free>n</span> <span class=free>ys</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=main>(</span>drop <span class=free>n</span> <span class=free>ys</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span><span class=free>P</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟹</span>
  take <span class=free>n</span> <span class=free>ys</span> <span class=main>=</span> takeWhile <span class=free>P</span> <span class=free>ys</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>ys</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>n</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>y</span> <span class=skolem>ys</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>n</span></span><span class=main>)</span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_add_new_mmuaux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> valid_before<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> tabs<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_L <span class=free>args</span><span class=main>)</span> <span class=free>rel1</span>"</span></span> <span class=quoted><span class=quoted>"table <span class=main>(</span>args_n <span class=free>args</span><span class=main>)</span> <span class=main>(</span>args_R <span class=free>args</span><span class=main>)</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> nt_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"valid_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=main>(</span>add_new_mmuaux <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>aux</span><span class=main>)</span>
    <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> args_n <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>L</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>=</span> args_L <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>R</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=main>=</span> args_R <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> valid_folded<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>4<span class=main>)</span> valid_mmuaux'_mono <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp</span></span> <span class=skolem><span class=skolem>len</span></span> <span class=skolem><span class=skolem>tss</span></span> <span class=skolem><span class=skolem>maskL</span></span> <span class=skolem><span class=skolem>maskR</span></span> <span class=skolem><span class=skolem>a1_map</span></span> <span class=skolem><span class=skolem>a2_map</span></span> <span class=quoted>"<span class=skolem><span class=skolem>done</span></span>"</span> <span class=skolem><span class=skolem>done_length</span></span> <span class=keyword2><span class=keyword>where</span></span> shift_aux_def<span class=main>:</span>
    <span class=quoted><span class=quoted>"shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> valid_shift_aux<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span>
    <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>ts</span><span class=main>.</span> <span class=bound>ts</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span>enat <span class=bound>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> enat <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_mmuaux'<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>unfolded</span> valid_mmuaux_def<span class=main><span class=main>]</span></span> assms<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> shift_aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>new_tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>new_tstp</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> Inr <span class=skolem>tp</span> <span class=keyword1>else</span> Inl <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> new_tstp_lt_isl<span class=main>:</span> <span class=quoted><span class=quoted>"tstp_lt <span class=skolem>new_tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"isl <span class=skolem>new_tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> new_tstp_def tstp_lt_def<span class=main>)</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tmp</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tmp</span> <span class=main>=</span> <span class=main>⋃</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>as</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>a1_map</span> <span class=main>(</span>proj_tuple <span class=skolem>maskL</span> <span class=bound>as</span><span class=main>)</span> <span class=keyword1>of</span> None <span class=main>⇒</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=main>¬</span><span class=skolem>pos</span> <span class=keyword1>then</span> <span class=main>{</span><span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>
    <span class=main>|</span> Some <span class=bound>tp'</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> <span class=main>{</span><span class=main>(</span>max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=bound>tp'</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span>
    <span class=keyword1>else</span> <span class=main>{</span><span class=main>(</span>max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>(</span><span class=bound>tp'</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>`</span> <span class=free>rel2</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>{</span><span class=skolem>tp</span><span class=main>}</span> <span class=main>×</span> <span class=free>rel2</span> <span class=keyword1>else</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> a1_map_lookup<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>as</span> <span class=bound>tp'</span><span class=main>.</span> Mapping.lookup <span class=skolem>a1_map</span> <span class=bound>as</span> <span class=main>=</span> Some <span class=bound>tp'</span> <span class=main>⟹</span> <span class=bound>tp'</span> <span class=main>&lt;</span> <span class=skolem>tp</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>1<span class=main>)</span> Mapping_keys_intro <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> fst_tmp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tp'</span><span class=main>.</span> <span class=bound>tp'</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=skolem>tmp</span> <span class=main>⟹</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span> <span class=main>≤</span> <span class=bound>tp'</span> <span class=main>∧</span> <span class=bound>tp'</span> <span class=main>&lt;</span> <span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tmp_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> less_SucI <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> snd_tmp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tp'</span><span class=main>.</span> table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>snd <span class=main>`</span> <span class=skolem>tmp</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tabs<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> tmp_def n_def R_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>a2_map'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2_map'</span> <span class=main>=</span> Mapping.update <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> Mapping.empty
    <span class=main>(</span>upd_nested <span class=skolem>a2_map</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=skolem>tmp</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>a1_map'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1_map'</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> Mapping.filter <span class=main>(</span><span class=main>λ</span><span class=bound>as</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> <span class=free>rel1</span><span class=main>)</span>
    <span class=main>(</span>upd_set <span class=skolem>a1_map</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=skolem>tp</span><span class=main>)</span> <span class=main>(</span><span class=free>rel1</span> <span class=main>-</span> Mapping.keys <span class=skolem>a1_map</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>else</span> upd_set <span class=skolem>a1_map</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=skolem>tp</span><span class=main>)</span> <span class=free>rel1</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>tss'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tss'</span> <span class=main>=</span> append_queue <span class=free>nt</span> <span class=skolem>tss</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> add_new_mmuaux_eq<span class=main>:</span> <span class=quoted><span class=quoted>"add_new_mmuaux <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>,</span> <span class=skolem>tss'</span><span class=main>,</span> <span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>,</span>
    <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map'</span><span class=main>,</span> <span class=skolem>a2_map'</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> shift_aux_def new_tstp_def tmp_def a2_map'_def a1_map'_def tss'_def
    <span class=keyword1><span class=command>unfolding</span></span> I_def pos_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> add_new_mmuaux.simps Let_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> update_until_eq<span class=main>:</span> <span class=quoted><span class=quoted>"update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span> <span class=main>=</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free>rel1</span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free>rel1</span><span class=main>,</span>
      <span class=keyword1>if</span> mem <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=skolem>I</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>@</span>
    <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>rel1</span><span class=main>,</span> <span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=free>rel2</span> <span class=keyword1>else</span> empty_table<span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> update_until_def I_def pos_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> len_done_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>done</span> <span class=main>≤</span> length <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> auxlist_split<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>auxlist</span> <span class=main>=</span> take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>@</span> drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> len_done_auxlist <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lin_tss'<span class=main>:</span> <span class=quoted><span class=quoted>"linearize <span class=skolem>tss'</span> <span class=main>=</span> linearize <span class=skolem>tss</span> <span class=main>@</span> <span class=main>[</span><span class=free>nt</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tss'_def append_queue_rep <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> refl<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> len_lin_tss'<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=main>(</span>linearize <span class=skolem>tss'</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_tss' <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> tmp<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>cur</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> sorted_lin_tss'<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>linearize <span class=skolem>tss'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_tss' <span class=keyword1><span class=command>using</span></span> tmp<span class=main>(</span>1<span class=main>)</span> le_trans<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>OF</span> tmp<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sorted_append<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> in_lin_tss<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=bound>t</span> <span class=main>≤</span> <span class=free>cur</span> <span class=main>∧</span> enat <span class=free>cur</span> <span class=main>≤</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> set_lin_tss'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss'</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>∧</span> enat <span class=free>nt</span> <span class=main>≤</span> enat <span class=bound>t</span> <span class=main>+</span> right <span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_tss' I_def <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>]</span> valid_shift_aux<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> not_less<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> a1_map'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>a1_map'</span> <span class=main>⊆</span> Mapping.keys <span class=skolem>a1_map</span> <span class=main>∪</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> a1_map'_def <span class=keyword1><span class=command>using</span></span> Mapping.keys_filter Mapping_upd_set_keys
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping_upd_set_keys <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_filterD<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tab_a1_map'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>L</span> <span class=main>(</span>Mapping.keys <span class=skolem>a1_map'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>1<span class=main>)</span> tabs<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def n_def L_def<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> a2_map_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>a2_map</span> <span class=main>=</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> a2_map'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>a2_map'</span> <span class=main>=</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.keys_update upd_nested_keys a2_map_keys <span class=keyword1><span class=command>using</span></span> fst_tmp
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a2_map'_keys'<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.keys <span class=skolem>a2_map'</span> <span class=main>=</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>..</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> len_upd_until<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>done</span> <span class=main>+</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>=</span> length <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>unfolding</span></span> update_until_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> set_take_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>⟹</span> check_before <span class=skolem>I</span> <span class=free>nt</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> list_all2_triple<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>
    <span class=main>(</span>zip <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>unfolding</span></span> I_def pos_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> set_drop_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span>check_before <span class=skolem>I</span> <span class=free>nt</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> list_all2_zip<span class=main><span class=main>[</span></span><span class=operator>OF</span> list_all2_triple<span class=main><span class=main>,</span></span>
      <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> length_done_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>done</span> <span class=main>≤</span> length <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> take_auxlist_takeWhile<span class=main>:</span> <span class=quoted><span class=quoted>"take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>=</span> takeWhile <span class=main>(</span>check_before <span class=skolem>I</span> <span class=free>nt</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> take_takeWhile<span class=main>[</span><span class=operator>OF</span> length_done_auxlist set_take_auxlist set_drop_auxlist<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>done</span> <span class=main>=</span> length <span class=main>(</span>takeWhile <span class=main>(</span>check_before <span class=skolem>I</span> <span class=free>nt</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> add_diff_cancel_right' auxlist_split diff_diff_cancel
        length_append length_done_auxlist length_drop take_auxlist_takeWhile<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> set_take_auxlist'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span>
    <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> check_before <span class=skolem>I</span> <span class=free>nt</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> I_def length_map map_proj_thd_update_until set_takeWhileD takeWhile_eq_take<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> rev_done<span class=main>:</span> <span class=quoted><span class=quoted>"rev <span class=skolem>done</span> <span class=main>=</span> map proj_thd <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> map proj_thd <span class=main>(</span>takeWhile <span class=main>(</span>check_before <span class=skolem>I</span> <span class=free>nt</span><span class=main>)</span>
    <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> take_auxlist_takeWhile map_proj_thd_update_until I_def<span class=main>)</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> rev_done'<span class=main>:</span> <span class=quoted><span class=quoted>"rev <span class=skolem>done</span> <span class=main>=</span> map proj_thd <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span>
    <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> length_map length_rev takeWhile_eq_take<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> map_fst_auxlist_take<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>map fst <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> set_take_auxlist
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> <span class=main>(</span><span class=operator>meson</span> add_increasing2 enat_ord_simps<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> le_cases not_less zero_le<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> map_fst_auxlist_drop<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>map fst <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> in_lin_tss<span class=main>[</span><span class=operator>OF</span> list_all2_zip<span class=main><span class=main>[</span></span><span class=operator>OF</span> list_all2_triple<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
      assms<span class=main>(</span>4<span class=main>)</span> dual_order.trans <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>have</span></span> set_drop_auxlist_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>t</span> <span class=bound>a1</span> <span class=bound>a2</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=bound>x</span> <span class=main>=</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⟹</span> mem <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=skolem>I</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>t</span> <span class=skolem>a1</span> <span class=skolem>a2</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> set <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"enat <span class=skolem>t</span> <span class=main>+</span> right <span class=skolem>I</span> <span class=main>≥</span> enat <span class=free>nt</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> set_drop_auxlist not_less
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span> <span class=main>≥</span> enat <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"right <span class=skolem>I</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"mem <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span><span class=main>)</span> <span class=skolem>I</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> sorted_fst_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> set_map_fst_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span><span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> set <span class=main>(</span>map fst <span class=free>auxlist</span><span class=main>)</span> <span class=main>⟹</span> <span class=bound>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arg_cong<span class=main>[</span><span class=operator>OF</span> auxlist_split<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"map fst"</span></span><span class=main>,</span> <span class=operator>unfolded</span> map_append<span class=main>]</span> map_fst_auxlist_take
      map_fst_auxlist_drop <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> lookup_a1_map_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>tp'</span><span class=main>.</span> Mapping.lookup <span class=skolem>a1_map</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tp'</span> <span class=main>⟹</span> <span class=bound>tp'</span> <span class=main>&lt;</span> <span class=skolem>tp</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux Mapping_keys_intro <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>have</span></span> lookup_a1_map_keys'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a1_map'</span><span class=main>.</span>
    <span class=keyword1>case</span> Mapping.lookup <span class=skolem>a1_map'</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tp'</span> <span class=main>⇒</span> <span class=bound>tp'</span> <span class=main>&lt;</span> <span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lookup_a1_map_keys <span class=keyword1><span class=command>unfolding</span></span> a1_map'_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter Mapping_lookup_upd_set Mapping_upd_set_keys
        <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> sorted_upd_until<span class=main>:</span> <span class=quoted><span class=quoted>"sorted <span class=main>(</span>map fst <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sorted_fst_auxlist set_map_fst_auxlist
    <span class=keyword1><span class=command>unfolding</span></span> update_until_eq
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sorted_append comp_def fst_case<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> lookup_a2_map<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tp'</span> <span class=bound>m</span><span class=main>.</span> Mapping.lookup <span class=skolem>a2_map</span> <span class=bound>tp'</span> <span class=main>=</span> Some <span class=bound>m</span> <span class=main>⟹</span>
    table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=bound>m</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=bound>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
      tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>cur</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span> <span class=main>(</span>isl <span class=bound>tstp</span> <span class=main>⟷</span> left <span class=skolem>I</span> <span class=main>&gt;</span> <span class=main>0</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>1<span class=main>)</span> Mapping_keys_intro <span class=keyword1><span class=command>unfolding</span></span> I_def n_def R_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> lookup_a2_map'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tp'</span> <span class=bound>m</span> <span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>a2_map</span> <span class=bound>tp'</span> <span class=main>=</span> Some <span class=bound>m</span> <span class=main>⟹</span>
    Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span> tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>tp</span> <span class=main>∧</span>
    isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Mapping_keys_intro assms<span class=main>(</span>4<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tstp_lt_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> lookup_a2_map'_keys<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>tp'</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map'</span><span class=main>.</span>
    <span class=keyword1>case</span> Mapping.lookup <span class=skolem>a2_map'</span> <span class=bound>tp'</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span> table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=bound>m</span><span class=main>)</span> <span class=main>∧</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=bound>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
    tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> ballI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tp'</span>
    <span class=keyword3><span class=command>assume</span></span> tp'_assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map'</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>m'</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>m'</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>m'</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
      tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>=</span> <span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> m'_def <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def True Mapping.lookup_update
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tp'_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> Mapping.keys <span class=skolem>a2_map</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> tp'_assm <span class=keyword1><span class=command>unfolding</span></span> a2_map_keys a2_map'_keys <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> m_def m'_def <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class=main>[</span><span class=operator>OF</span> False<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>]</span>
          upd_nested_lookup
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=skolem>m'</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> lookup_a2_map<span class=main>[</span><span class=operator>OF</span> m_def<span class=main>]</span> snd_tmp <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_keys
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>m'</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=skolem>m'</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
        tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> ballI<span class=main>)</span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
        <span class=keyword3><span class=command>assume</span></span> xs_assm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> Mapping.keys <span class=skolem>m'</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> tstp_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"tstp_lt <span class=skolem>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> isl <span class=skolem>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> None
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> tstp_def<span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup<span class=main>]</span> new_tstp_lt_isl
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tstp_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> tstp_def<span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup<span class=main>]</span> Some
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> new_tstp_lt_isl
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tstp_lt_def tstp_eq <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> tstp_def<span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup<span class=main>]</span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> Some
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tstp_lt_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
          tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> tstp_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>case</span> Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp'</span> <span class=keyword1>of</span> Some <span class=bound>m</span> <span class=main>⇒</span> table <span class=skolem>n</span> <span class=skolem>R</span> <span class=main>(</span>Mapping.keys <span class=bound>m</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span> <span class=main>∈</span> Mapping.keys <span class=bound>m</span><span class=main>.</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=keyword1>of</span> Some <span class=bound>tstp</span> <span class=main>⇒</span>
      tstp_lt <span class=bound>tstp</span> <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=main>(</span>left <span class=skolem>I</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=main>∧</span> isl <span class=bound>tstp</span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> left <span class=skolem>I</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> m'_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> tp_upt_Suc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>]</span> <span class=main>=</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>tp</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> upt_Suc <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> map_eq<span class=main>:</span> <span class=quoted><span class=quoted>"map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free>rel1</span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free>rel1</span><span class=main>,</span>
      <span class=keyword1>if</span> mem <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=skolem>I</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>=</span>
    map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free>rel1</span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free>rel1</span><span class=main>,</span>
      <span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> set_drop_auxlist_cong <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>=</span>
    map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>x</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free>rel1</span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free>rel1</span><span class=main>,</span>
      <span class=keyword1>if</span> mem <span class=main>(</span><span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=skolem>I</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>@</span>
    <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=free>rel1</span><span class=main>,</span> <span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=free>rel2</span> <span class=keyword1>else</span> empty_table<span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> update_until_eq <span class=keyword1><span class=command>using</span></span> len_done_auxlist drop_map <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>note</span></span> drop_update_until <span class=main>=</span> this<span class=main>[</span><span class=operator>unfolded</span> map_eq<span class=main>]</span>
  <span class=keyword1><span class=command>have</span></span> list_all2_old<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map'</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map'</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free>rel1</span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free>rel1</span><span class=main>,</span>
      <span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>zip <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> list_all2_map1
    <span class=keyword1><span class=command>using</span></span> list_all2_triple
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> list.rel_mono_strong<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tri</span> <span class=skolem>pair</span>
    <span class=keyword3><span class=command>assume</span></span> tri_pair_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tri</span> <span class=main>∈</span> set <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>pair</span> <span class=main>∈</span> set <span class=main>(</span>zip <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=skolem><span class=skolem>a1</span></span> <span class=skolem><span class=skolem>a2</span></span> <span class=keyword2><span class=keyword>where</span></span> tri_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tri</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>t</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>tri</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ts'</span></span> <span class=skolem><span class=skolem>tp'</span></span> <span class=keyword2><span class=keyword>where</span></span> pair_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>pair</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>ts'</span><span class=main>,</span> <span class=skolem>tp'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>pair</span></span><span class=main>)</span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"triple_eq_pair <span class=skolem>tri</span> <span class=skolem>pair</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map</span><span class=main>)</span>
      <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> eqs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> <span class=skolem>ts'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span> <span class=main>=</span> filter_a1_map <span class=skolem>pos</span> <span class=skolem>tp'</span> <span class=skolem>a1_map</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>a2</span> <span class=main>=</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> tri_def pair_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> tp'_ge<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>≥</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tri_pair_in<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> pair_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> in_set_zipE<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> tp'_lt_tp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>&lt;</span> <span class=skolem>tp</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tri_pair_in<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> pair_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> in_set_zipE<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> ts'_in_lin_tss<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ts'</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tri_pair_in<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> pair_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> in_set_zipE<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> ts'_nt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ts'</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>1<span class=main>)</span> assms<span class=main>(</span>4<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> t_nt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>≤</span> <span class=free>nt</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> eqs<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>L</span> <span class=main>(</span>Mapping.keys <span class=skolem>a1_map</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>unfolding</span></span> n_def L_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a1_tab<span class=main>:</span> <span class=quoted><span class=quoted>"table <span class=skolem>n</span> <span class=skolem>L</span> <span class=skolem>a1</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> eqs<span class=main>(</span>2<span class=main>)</span> filter_a1_map_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> table_def<span class=main>)</span>
    <span class=keyword1><span class=command>note</span></span> tabR <span class=main>=</span> tabs<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> n_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> R_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>have</span></span> join_rel2_assms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>L</span> <span class=main>⊆</span> <span class=skolem>R</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>maskL</span> <span class=main>=</span> join_mask <span class=skolem>n</span> <span class=skolem>L</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>unfolding</span></span> n_def L_def R_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> join_rel2_eq<span class=main>:</span> <span class=quoted><span class=quoted>"join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=skolem>a1</span> <span class=main>=</span> <span class=main>{</span><span class=bound><span class=bound>xs</span></span> <span class=main>∈</span> <span class=free>rel2</span><span class=main>.</span> proj_tuple_in_join <span class=skolem>pos</span> <span class=skolem>maskL</span> <span class=bound>xs</span> <span class=skolem>a1</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> join_sub<span class=main>[</span><span class=operator>OF</span> join_rel2_assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> a1_tab tabR<span class=main>]</span> join_rel2_assms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> filter_sub_a2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span> <span class=bound>m'</span> <span class=bound>tp''</span> <span class=bound>tstp</span><span class=main>.</span> <span class=bound>tp''</span> <span class=main>≤</span> <span class=skolem>tp'</span> <span class=main>⟹</span>
      Mapping.lookup <span class=skolem>a2_map'</span> <span class=bound>tp''</span> <span class=main>=</span> Some <span class=bound>m'</span> <span class=main>⟹</span> Mapping.lookup <span class=bound>m'</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span>
      ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=bound>tstp</span> <span class=main>⟹</span> <span class=main>(</span><span class=bound>tstp</span> <span class=main>=</span> <span class=skolem>new_tstp</span> <span class=main>⟹</span> False<span class=main>)</span> <span class=main>⟹</span>
      <span class=bound>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span> <span class=main>⟹</span> <span class=bound>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span> <span class=skolem>m'</span> <span class=skolem>tp''</span> <span class=skolem>tstp</span>
      <span class=keyword3><span class=command>assume</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp''</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>tstp</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> tp''_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp''</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> le_less_trans<span class=main>[</span><span class=operator>OF</span> m'_def<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> tp'_lt_tp<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>assume</span></span> new_tstp_False<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>new_tstp</span> <span class=main>⟹</span> False"</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp''</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> None
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' Mapping.empty <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span>
          <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> tp''_neq<span class=main><span class=main>]</span></span>
            upd_nested_lookup<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> new_tstp_False m'_def<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup Mapping.lookup_empty<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>m</span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> tp''_neq<span class=main><span class=main>]</span></span>
            upd_nested_lookup<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>note</span></span> lookup_m <span class=main>=</span> Some
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> None
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> new_tstp_False m'_def<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup<span class=main>]</span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
          <span class=keyword1><span class=command>have</span></span> tstp_ok<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>tstp'</span> <span class=main>⟹</span> <span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>3<span class=main>)</span> lookup_m Some m'_def <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tstp_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup Some<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> lookup_m Some<span class=main>]</span> new_tstp_lt_isl<span class=main>(</span>2<span class=main>)</span>
                tstp_eq new_tstp_False tstp_ok
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max_tstpE<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>new_tstp</span></span> <span class=quoted><span class=skolem>tstp'</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>tstp'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup Some<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> tstp_ok <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>have</span></span> a2_sub_filter<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span> <span class=main>⊆</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> subsetI<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
      <span class=keyword3><span class=command>assume</span></span> xs_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp''</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp''</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
        <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>tstp</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a2_map_def<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> tp''_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> m_def<span class=main>(</span>2<span class=main>)</span> a2_map_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp''</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a2_map'_keys
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Mapping_keys_dest One_nat_def add_Suc_right add_diff_cancel_right'
            atLeastatMost_subset_iff diff_zero le_eq_less_or_eq le_less_Suc_eq subsetD<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> tp''_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp''</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> m_def<span class=main>(</span>1<span class=main>)</span> tp'_lt_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> tp''_neq<span class=main><span class=main>]</span></span> m_def<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span>
          upd_nested_lookup<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup m_def<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> new_tstp_lt_isl<span class=main>(</span>2<span class=main>)</span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def<span class=main><span class=main>(</span></span>2<span class=main><span class=main>,</span></span>3<span class=main><span class=main>)</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> max_tstp_intro''''<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ m_def<span class=main><span class=main><span class=main>(</span></span></span>4<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>using</span></span> m_def<span class=main>(</span>1<span class=main>)</span> m'_def m_def<span class=main>(</span>4<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup m_def<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>using</span></span> m_def<span class=main>(</span>1<span class=main>)</span> m'_def m_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>⟹</span> filter_a1_map <span class=skolem>pos</span> <span class=skolem>tp'</span> <span class=skolem>a1_map'</span> <span class=main>=</span> join <span class=skolem>a1</span> True <span class=free>rel1</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>assume</span></span> pos<span class=main>:</span> <span class=quoted><span class=skolem>pos</span></span>
      <span class=keyword1><span class=command>note</span></span> tabL <span class=main>=</span> tabs<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> n_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> L_def<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>have</span></span> join_eq<span class=main>:</span> <span class=quoted><span class=quoted>"join <span class=skolem>a1</span> True <span class=free>rel1</span> <span class=main>=</span> <span class=skolem>a1</span> <span class=main>∩</span> <span class=free>rel1</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> join_eq<span class=main>[</span><span class=operator>OF</span> tabL a1_tab<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"filter_a1_map <span class=skolem>pos</span> <span class=skolem>tp'</span> <span class=skolem>a1_map'</span> <span class=main>=</span> join <span class=skolem>a1</span> True <span class=free>rel1</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>2<span class=main>)</span> pos tp'_lt_tp <span class=keyword1><span class=command>unfolding</span></span> filter_a1_map_def a1_map'_def join_eq
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter Mapping_lookup_upd_set <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits
            <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest Mapping_keys_filterD<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>pos</span> <span class=main>⟹</span> filter_a1_map <span class=skolem>pos</span> <span class=skolem>tp'</span> <span class=skolem>a1_map'</span> <span class=main>=</span> <span class=skolem>a1</span> <span class=main>∪</span> <span class=free>rel1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>2<span class=main>)</span> tp'_lt_tp <span class=keyword1><span class=command>unfolding</span></span> filter_a1_map_def a1_map'_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_filter Mapping_lookup_upd_set <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro
          <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_filterD Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>⟹</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span> <span class=main>=</span> <span class=skolem>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=skolem>a1</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
      <span class=keyword3><span class=command>assume</span></span> in_int<span class=main>:</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span>"</span></span>
      <span class=keyword3><span class=command>assume</span></span> xs_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=skolem><span class=skolem>tp''</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp''</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>tstp</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=skolem>a1</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>new_tstp</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>note</span></span> tstp_new_tstp <span class=main>=</span> True
        <span class=keyword1><span class=command>have</span></span> tp''_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp''</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>1<span class=main>)</span> tp'_lt_tp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> tp''_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> tp'_lt_tp a2_map'_keys
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp''</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> tp''_neq<span class=main><span class=main>]</span></span>
            upd_nested_lookup<span class=main>]</span> tp''_in a2_map_keys
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>new_tstp</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>3<span class=main>)</span> m'_def<span class=main>(</span>1<span class=main>)</span> m_def<span class=main>(</span>1<span class=main>)</span> m'_def tstp_new_tstp
            <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> xs_in_snd_tmp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp''</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m_def<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> upd_set'_lookup True<span class=main>]</span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> xs_in_rel2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=free>rel2</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> tmp_def
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>pos</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp'''</span></span> <span class=keyword2><span class=keyword>where</span></span> tp'''_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a1_map</span> <span class=main>(</span>proj_tuple <span class=skolem>maskL</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>tp'''</span>"</span></span>
              <span class=quoted><span class=quoted>"<span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> <span class=skolem>tp''</span> <span class=main>=</span> max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>tp'''</span> <span class=keyword1>else</span> <span class=skolem>tp''</span> <span class=main>=</span> max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp'''</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> xs_in_snd_tmp m'_def<span class=main>(</span>1<span class=main>)</span> tp'_lt_tp True
              <span class=keyword1><span class=command>unfolding</span></span> tmp_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"proj_tuple <span class=skolem>maskL</span> <span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a1</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a1_map_def<span class=main>]</span> True m'_def<span class=main>(</span>1<span class=main>)</span> tp'''_def
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> True xs_in_rel2 <span class=keyword1><span class=command>unfolding</span></span> proj_tuple_in_join_def join_rel2_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a1_map</span> <span class=main>(</span>proj_tuple <span class=skolem>maskL</span> <span class=skolem>xs</span><span class=main>)</span>"</span></span><span class=main>)</span>
              <span class=keyword3><span class=command>case</span></span> None
              <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                <span class=keyword1><span class=command>using</span></span> xs_in_rel2 False eqs<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a1_map_def<span class=main>]</span>
                <span class=keyword1><span class=command>unfolding</span></span> proj_tuple_in_join_def join_rel2_eq
                <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
            <span class=keyword1><span class=command>next</span></span>
              <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tp'''</span><span class=main>)</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>=</span> max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp'''</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> xs_in_snd_tmp m'_def<span class=main>(</span>1<span class=main>)</span> tp'_lt_tp False
                <span class=keyword1><span class=command>unfolding</span></span> tmp_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tp'''</span> <span class=main>&lt;</span> <span class=skolem>tp'</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"proj_tuple <span class=skolem>maskL</span> <span class=skolem>xs</span> <span class=main>∉</span> <span class=skolem>a1</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a1_map_def<span class=main>]</span> True m'_def<span class=main>(</span>1<span class=main>)</span> Some False
                <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                <span class=keyword1><span class=command>using</span></span> xs_in_rel2 False <span class=keyword1><span class=command>unfolding</span></span> proj_tuple_in_join_def join_rel2_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>qed</span></span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> filter_sub_a2<span class=main>[</span><span class=operator>OF</span> m'_def _ xs_in<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
      <span class=keyword3><span class=command>assume</span></span> in_int<span class=main>:</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span>"</span></span>
      <span class=keyword3><span class=command>assume</span></span> xs_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=skolem>a1</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span> <span class=main>∪</span> <span class=main>(</span>join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=skolem>a1</span> <span class=main>-</span> <span class=skolem>a2</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> UnE<span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> a2_sub_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=skolem>a1</span> <span class=main>-</span> <span class=skolem>a2</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> xs_props<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=free>rel2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∉</span> <span class=skolem>a2</span>"</span></span> <span class=quoted><span class=quoted>"proj_tuple_in_join <span class=skolem>pos</span> <span class=skolem>maskL</span> <span class=skolem>xs</span> <span class=skolem>a1</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> join_rel2_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> ts_tp_lt'_new_tstp<span class=main>:</span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>new_tstp</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> tp'_lt_tp in_int t_nt eqs<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> new_tstp_def
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def<span class=main>)</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>pos</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp'''</span></span> <span class=keyword2><span class=keyword>where</span></span> tp'''_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'''</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span>
            <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a1_map</span> <span class=main>(</span>proj_tuple <span class=skolem>maskL</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>tp'''</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> eqs<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a1_map_def<span class=main>]</span> xs_props<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> proj_tuple_in_join_def<span class=main>]</span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
          <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>wtp</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>wtp</span> <span class=main>≡</span> max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=skolem>tp'''</span>"</span></span>
          <span class=keyword1><span class=command>have</span></span> wtp_xs_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>wtp</span><span class=main>,</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> wtp_def <span class=keyword1><span class=command>using</span></span> tp'''_def tmp_def xs_props<span class=main>(</span>1<span class=main>)</span> True <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
          <span class=keyword1><span class=command>have</span></span> wtp_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>wtp</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> tp'''_def<span class=main>(</span>1<span class=main>)</span> tp'_ge <span class=keyword1><span class=command>unfolding</span></span> wtp_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>have</span></span> wtp_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>wtp</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> tp'''_def<span class=main>(</span>1<span class=main>)</span> tp'_lt_tp <span class=keyword1><span class=command>unfolding</span></span> wtp_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>have</span></span> wtp_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>wtp</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> wtp_in <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>wtp</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> wtp_in a2_map_keys Mapping_keys_dest <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
          <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>wtp</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> wtp_in a2_map'_keys Mapping_keys_dest <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
          <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>wtp</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> wtp_neq<span class=main><span class=main>]</span></span>
              upd_nested_lookup m_def<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> None
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>new_tstp</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> wtp_xs_in <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup None <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>using</span></span> wtp_le m'_def ts_tp_lt'_new_tstp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> wtp_xs_in <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup Some <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> max_tstp_intro''' ts_tp_lt'_new_tstp lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> new_tstp_lt_isl
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> wtp_le m'_def
              <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a1_map</span> <span class=main>(</span>proj_tuple <span class=skolem>maskL</span> <span class=skolem>xs</span><span class=main>)</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> None
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> in_tmp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> tmp_def False xs_props<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> a2_map_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
            <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> a2_map'_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
            <span class=keyword1><span class=command>have</span></span> tp_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> tp_neq<span class=main><span class=main>]</span></span>
                upd_nested_lookup m_def<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
              <span class=keyword3><span class=command>case</span></span> None
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>new_tstp</span>"</span></span>
                <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup None <span class=keyword1><span class=command>using</span></span> in_tmp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>using</span></span> tp'_ge m'_def ts_tp_lt'_new_tstp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>next</span></span>
              <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
                <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup Some <span class=keyword1><span class=command>using</span></span> in_tmp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> max_tstp_intro''' ts_tp_lt'_new_tstp lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> new_tstp_lt_isl
                <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>using</span></span> tp'_ge m'_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>qed</span></span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tp'''</span><span class=main>)</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tp'_gt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>&gt;</span> <span class=skolem>tp'''</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> xs_props<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> proj_tuple_in_join_def<span class=main>]</span> eqs<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> filter_a1_map_def<span class=main>]</span>
                False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
            <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>wtp</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>wtp</span> <span class=main>≡</span> max <span class=main>(</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>)</span> <span class=main>(</span><span class=skolem>tp'''</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>have</span></span> wtp_xs_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>wtp</span><span class=main>,</span> <span class=skolem>xs</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span>"</span></span>
              <span class=keyword1><span class=command>unfolding</span></span> wtp_def tmp_def <span class=keyword1><span class=command>using</span></span> xs_props<span class=main>(</span>1<span class=main>)</span> Some False <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword1><span class=command>have</span></span> wtp_le<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>wtp</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> tp'_ge tp'_gt <span class=keyword1><span class=command>unfolding</span></span> wtp_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>have</span></span> wtp_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>wtp</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> tp'_lt_tp tp'_gt <span class=keyword1><span class=command>unfolding</span></span> wtp_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>have</span></span> wtp_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>wtp</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> wtp_in <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>wtp</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> wtp_in a2_map_keys Mapping_keys_dest <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>wtp</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> wtp_in a2_map'_keys Mapping_keys_dest <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>wtp</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> m'_def<span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> wtp_neq<span class=main><span class=main>]</span></span>
                upd_nested_lookup m_def<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
              <span class=keyword3><span class=command>case</span></span> None
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>new_tstp</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> wtp_xs_in <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup None <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>using</span></span> wtp_le m'_def ts_tp_lt'_new_tstp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>next</span></span>
              <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> wtp_xs_in <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup Some <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> max_tstp_intro''' ts_tp_lt'_new_tstp lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> new_tstp_lt_isl
                <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                <span class=keyword1><span class=command>using</span></span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def Some<span class=main>]</span> wtp_le m'_def
                <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>qed</span></span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>&lt;</span> left <span class=skolem>I</span> <span class=main>⟹</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span> <span class=main>=</span> <span class=skolem>a2</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> set_eqI<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> iffI<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
      <span class=keyword3><span class=command>assume</span></span> out<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>-</span> <span class=skolem>t</span> <span class=main>&lt;</span> left <span class=skolem>I</span>"</span></span>
      <span class=keyword3><span class=command>assume</span></span> xs_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=skolem><span class=skolem>tp''</span></span> <span class=skolem><span class=skolem>tstp</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp''</span> <span class=main>≤</span> <span class=skolem>tp'</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp''</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>tstp</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> filter_a2_map_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> new_tstp_False<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>new_tstp</span> <span class=main>⟹</span> False"</span></span>
        <span class=keyword1><span class=command>using</span></span> m'_def t_nt out tp'_lt_tp <span class=keyword1><span class=command>unfolding</span></span> eqs<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def new_tstp_def<span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> filter_sub_a2<span class=main>[</span><span class=operator>OF</span> m'_def new_tstp_False xs_in<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=skolem>a2</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> filter_a2_map <span class=skolem>I</span> <span class=skolem>ts'</span> <span class=skolem>tp'</span> <span class=skolem>a2_map'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a2_sub_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"triple_eq_pair <span class=main>(</span><span class=keyword1>case</span> <span class=skolem>tri</span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a2</span><span class=main>)</span> <span class=main>⇒</span>
      <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=keyword1>if</span> <span class=skolem>pos</span> <span class=keyword1>then</span> join <span class=bound>a1</span> True <span class=free>rel1</span> <span class=keyword1>else</span> <span class=bound>a1</span> <span class=main>∪</span> <span class=free>rel1</span><span class=main>,</span>
      <span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>≤</span> <span class=free>nt</span> <span class=main>-</span> <span class=bound>t</span> <span class=keyword1>then</span> <span class=bound>a2</span> <span class=main>∪</span> join <span class=free>rel2</span> <span class=skolem>pos</span> <span class=bound>a1</span> <span class=keyword1>else</span> <span class=bound>a2</span><span class=main>)</span><span class=main>)</span>
      <span class=skolem>pair</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map'</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> eqs <span class=keyword1><span class=command>unfolding</span></span> tri_def pair_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> filter_a1_map_rel1<span class=main>:</span> <span class=quoted><span class=quoted>"filter_a1_map <span class=skolem>pos</span> <span class=skolem>tp</span> <span class=skolem>a1_map'</span> <span class=main>=</span> <span class=free>rel1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> filter_a1_map_def a1_map'_def <span class=keyword1><span class=command>using</span></span> leD lookup_a1_map_keys
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> a1_map_lookup less_imp_le_nat Mapping.lookup_filter
        Mapping_lookup_upd_set keys_is_none_rep <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_filterD
        <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> filter_a1_map_rel2<span class=main>:</span> <span class=quoted><span class=quoted>"filter_a2_map <span class=skolem>I</span> <span class=free>nt</span> <span class=skolem>tp</span> <span class=skolem>a2_map'</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>if</span> left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=free>rel2</span> <span class=keyword1>else</span> empty_table<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"left <span class=skolem>I</span> <span class=main>=</span> <span class=main>0</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>note</span></span> left_I_zero <span class=main>=</span> True
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tp'</span> <span class=bound>m'</span> <span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> <span class=bound>tp'</span> <span class=main>≤</span> <span class=skolem>tp</span> <span class=main>⟹</span> Mapping.lookup <span class=skolem>a2_map'</span> <span class=bound>tp'</span> <span class=main>=</span> Some <span class=bound>m'</span> <span class=main>⟹</span>
      Mapping.lookup <span class=bound>m'</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span> ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=bound>tstp</span> <span class=main>⟹</span> <span class=bound>xs</span> <span class=main>∈</span> <span class=free>rel2</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tp'</span> <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=skolem>tstp</span>
      <span class=keyword3><span class=command>assume</span></span> lassms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>≤</span> <span class=skolem>tp</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=skolem>tstp</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> tp'_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>have</span></span> tp'_in<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..</span><span class=skolem>tp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> a2_map'_keys tp'_neq <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> Mapping_keys_intro<span class=main>)</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class=main><span class=main>[</span></span><span class=operator>OF</span> tp'_neq<span class=main><span class=main>]</span></span>
          upd_nested_lookup<span class=main>]</span> tp'_in a2_map_keys
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Mapping_keys_intro <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> ccontr<span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∉</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> Some<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m_def<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> upd_set'_lookup<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"False"</span></span>
          <span class=keyword1><span class=command>using</span></span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> Some<span class=main>]</span> lassms<span class=main>(</span>4<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tstp_lt_def ts_tp_lt'_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=free>rel2</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> tmp_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>xs</span><span class=main>.</span> <span class=bound>xs</span> <span class=main>∈</span> <span class=free>rel2</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>m'</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp</span> <span class=main>=</span> Some <span class=bound>m'</span> <span class=main>∧</span>
      Mapping.lookup <span class=bound>m'</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>∧</span> ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=bound>tstp</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>xs</span>
      <span class=keyword3><span class=command>assume</span></span> lassms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=free>rel2</span>"</span></span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m'</span></span> <span class=keyword2><span class=keyword>where</span></span> m'_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a2_map'_keys <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> tp_neq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> m_def<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp</span> <span class=main>=</span> Some <span class=skolem>m</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> m'_def a2_map_keys <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class=main>[</span><span class=operator>OF</span> tp_neq<span class=main>]</span>
          upd_nested_lookup
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> Mapping_keys_dest <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits if_splits<span class=main>)</span>
           <span class=main>(</span><span class=operator>metis</span> Mapping_keys_dest atLeastAtMost_iff diff_le_self le_eq_less_or_eq
            option.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> xs_in_tmp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> lassms left_I_zero <span class=keyword1><span class=command>unfolding</span></span> tmp_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>m'</span> <span class=bound>tstp</span><span class=main>.</span> Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp</span> <span class=main>=</span> Some <span class=bound>m'</span> <span class=main>∧</span>
        Mapping.lookup <span class=bound>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>∧</span> ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=bound>tstp</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> None
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>new_tstp</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> xs_in_tmp <span class=keyword1><span class=command>unfolding</span></span> m_def<span class=main>(</span>2<span class=main>)</span> upd_set'_lookup None <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=skolem>new_tstp</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> left_I_zero new_tstp_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def<span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> xs_in_tmp m_def
          <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class=main>[</span><span class=operator>OF</span> tp_neq<span class=main>]</span> upd_nested_lookup <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> xs_in_tmp <span class=keyword1><span class=command>unfolding</span></span> m_def<span class=main>(</span>2<span class=main>)</span> upd_set'_lookup Some <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> max_tstpE<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>new_tstp</span></span> <span class=quoted><span class=skolem>tstp'</span></span><span class=main>]</span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> m_def<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> Some<span class=main>]</span> new_tstp_lt_isl left_I_zero
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sum.discI<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> new_tstp_def ts_tp_lt'_def tstp_lt_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> xs_in_tmp m_def
          <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class=main>[</span><span class=operator>OF</span> tp_neq<span class=main>]</span> upd_nested_lookup <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> True <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>note</span></span> left_I_pos <span class=main>=</span> False
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>tp'</span> <span class=bound>m</span> <span class=bound>xs</span> <span class=bound>tstp</span><span class=main>.</span> <span class=bound>tp'</span> <span class=main>≤</span> <span class=skolem>tp</span> <span class=main>⟹</span> Mapping.lookup <span class=skolem>a2_map'</span> <span class=bound>tp'</span> <span class=main>=</span> Some <span class=bound>m</span> <span class=main>⟹</span>
      Mapping.lookup <span class=bound>m</span> <span class=bound>xs</span> <span class=main>=</span> Some <span class=bound>tstp</span> <span class=main>⟹</span> <span class=main>¬</span><span class=main>(</span>ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=bound>tstp</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>tp'</span> <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=skolem>tstp</span>
      <span class=keyword3><span class=command>assume</span></span> lassms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>≤</span> <span class=skolem>tp</span>"</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map'</span> <span class=skolem>tp'</span> <span class=main>=</span> Some <span class=skolem>m'</span>"</span></span>
        <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m'</span> <span class=skolem>xs</span> <span class=main>=</span> Some <span class=skolem>tstp</span>"</span></span>
      <span class=keyword1><span class=command>from</span></span> lassms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> tp'_neq_Suc_tp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>≠</span> <span class=skolem>tp'</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>ts_tp_lt' <span class=free>nt</span> <span class=skolem>tp</span> <span class=skolem>tstp</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>a2_map</span> <span class=skolem>tp'</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> None
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tp'_in_tmp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tp'</span> <span class=main>∈</span> fst <span class=main>`</span> <span class=skolem>tmp</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
          m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' Mapping.empty <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class=main>[</span><span class=operator>OF</span> tp'_neq_Suc_tp<span class=main>]</span>
            upd_nested_lookup <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>new_tstp</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>3<span class=main>)</span><span class=main>[</span><span class=operator>unfolded</span> m'_alt upd_set'_lookup<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.lookup_empty <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def new_tstp_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits sum.splits<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>m</span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> m'_alt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>m'</span> <span class=main>=</span> upd_set' <span class=skolem>m</span> <span class=skolem>new_tstp</span> <span class=main>(</span>max_tstp <span class=skolem>new_tstp</span><span class=main>)</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class=main>[</span><span class=operator>OF</span> tp'_neq_Suc_tp<span class=main>]</span>
            upd_nested_lookup <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>note</span></span> lookup_a2_map_tp' <span class=main>=</span> Some
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=skolem>m</span> <span class=skolem>xs</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> None
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> <span class=skolem>new_tstp</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def new_tstp_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits sum.splits<span class=main>)</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>tstp'</span><span class=main>)</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>xs</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=skolem>tp'</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>tmp</span><span class=main>}</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> tstp_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>tstp</span> <span class=main>=</span> max_tstp <span class=skolem>new_tstp</span> <span class=skolem>tstp'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>3<span class=main>)</span>
              <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup Some <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> max_tstpE<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>new_tstp</span></span> <span class=quoted><span class=skolem>tstp'</span></span><span class=main>]</span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> lookup_a2_map_tp' Some<span class=main>]</span> new_tstp_lt_isl left_I_pos
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tstp_eq tstp_lt_def ts_tp_lt'_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> lassms<span class=main>(</span>3<span class=main>)</span> lookup_a2_map'<span class=main>[</span><span class=operator>OF</span> lookup_a2_map_tp' Some<span class=main>]</span>
              <span class=keyword1><span class=command>unfolding</span></span> m'_alt upd_set'_lookup Some
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ts_tp_lt'_def tstp_lt_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> sum.splits<span class=main>)</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> False <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_a2_map_def empty_table_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> zip_dist<span class=main>:</span> <span class=quoted><span class=quoted>"zip <span class=main>(</span>linearize <span class=skolem>tss</span> <span class=main>@</span> <span class=main>[</span><span class=free>nt</span><span class=main>]</span><span class=main>)</span> <span class=main>(</span><span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>tp</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span>
    zip <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>-</span> <span class=skolem>len</span><span class=main>..&lt;</span><span class=skolem>tp</span><span class=main>]</span> <span class=main>@</span> <span class=main>[</span><span class=main>(</span><span class=free>nt</span><span class=main>,</span> <span class=skolem>tp</span><span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> list_all2'<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=main>(</span><span class=main>λ</span><span class=bound>tp'</span><span class=main>.</span> filter_a1_map <span class=skolem>pos</span> <span class=bound>tp'</span> <span class=skolem>a1_map'</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>ts'</span> <span class=bound>tp'</span><span class=main>.</span> filter_a2_map <span class=skolem>I</span> <span class=bound>ts'</span> <span class=bound>tp'</span> <span class=skolem>a2_map'</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=main>(</span>update_until <span class=free>args</span> <span class=free>rel1</span> <span class=free>rel2</span> <span class=free>nt</span> <span class=free>auxlist</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>zip <span class=main>(</span>linearize <span class=skolem>tss'</span><span class=main>)</span> <span class=main>[</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span> <span class=main>-</span> <span class=main>(</span><span class=skolem>len</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span><span class=main>..&lt;</span><span class=skolem>tp</span> <span class=main>+</span> <span class=main>1</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> lin_tss' tp_upt_Suc drop_update_until zip_dist
    <span class=keyword1><span class=command>using</span></span> filter_a1_map_rel1 filter_a1_map_rel2 list_all2_appendI<span class=main>[</span><span class=operator>OF</span> list_all2_old<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux len_lin_tss' sorted_lin_tss' set_lin_tss' tab_a1_map'_keys a2_map'_keys'
      len_upd_until sorted_upd_until lookup_a1_map_keys' rev_done' set_take_auxlist'
      lookup_a2_map'_keys list_all2'
    <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux_def add_new_mmuaux_eq valid_mmuaux'.simps
      I_def n_def L_def R_def pos_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> list_all2_check_before<span class=main>:</span> <span class=quoted><span class=quoted>"list_all2 <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> triple_eq_pair <span class=bound>x</span> <span class=bound>y</span> <span class=free>f</span> <span class=free>g</span><span class=main>)</span> <span class=free>xs</span> <span class=main>(</span>zip <span class=free>ys</span> <span class=free>zs</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> set <span class=free>ys</span> <span class=main>⟹</span> <span class=main>¬</span>enat <span class=bound>y</span> <span class=main>+</span> right <span class=free>I</span> <span class=main>&lt;</span> <span class=free>nt</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> set <span class=free>xs</span> <span class=main>⟹</span> <span class=main>¬</span>check_before <span class=free>I</span> <span class=free>nt</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_zip <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> list_all2_in_setE triple_eq_pair.elims<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>eval_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> ts <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux <span class=main>⇒</span> <span class=tfree>'a</span> table list <span class=main>×</span> <span class=tfree>'a</span> mmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_mmuaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>tp</span><span class=main>,</span> <span class=bound>tss</span><span class=main>,</span> <span class=bound>len</span><span class=main>,</span> <span class=bound>maskL</span><span class=main>,</span> <span class=bound>maskR</span><span class=main>,</span> <span class=bound>a1_map</span><span class=main>,</span> <span class=bound>a2_map</span><span class=main>,</span> <span class=bound>done</span><span class=main>,</span> <span class=bound>done_length</span><span class=main>)</span> <span class=main>=</span>
    shift_mmuaux <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=free><span class=bound><span class=entity>nt</span></span></span> <span class=free><span class=bound><span class=entity>aux</span></span></span> <span class=keyword1>in</span>
    <span class=main>(</span>rev <span class=bound>done</span><span class=main>,</span> <span class=main>(</span><span class=bound>tp</span><span class=main>,</span> <span class=bound>tss</span><span class=main>,</span> <span class=bound>len</span><span class=main>,</span> <span class=bound>maskL</span><span class=main>,</span> <span class=bound>maskR</span><span class=main>,</span> <span class=bound>a1_map</span><span class=main>,</span> <span class=bound>a2_map</span><span class=main>,</span> <span class=main>[]</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_eval_mmuaux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmuaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>nt</span> <span class=main>≥</span> <span class=free>cur</span>"</span></span>
    <span class=quoted><span class=quoted>"eval_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=free>res</span><span class=main>,</span> <span class=free>aux'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"eval_until <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=free>nt</span> <span class=free>auxlist</span> <span class=main>=</span> <span class=main>(</span><span class=free>res'</span><span class=main>,</span> <span class=free>auxlist'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>res</span> <span class=main>=</span> <span class=free>res'</span> <span class=main>∧</span> valid_mmuaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux'</span> <span class=free>auxlist'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span> <span class=main>=</span> args_ivl <span class=free>args</span>"</span></span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pos</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pos</span> <span class=main>=</span> args_pos <span class=free>args</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> valid_folded<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span>2<span class=main>)</span> valid_mmuaux'_mono <span class=keyword1><span class=command>unfolding</span></span> valid_mmuaux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>tp</span></span> <span class=skolem><span class=skolem>len</span></span> <span class=skolem><span class=skolem>tss</span></span> <span class=skolem><span class=skolem>maskL</span></span> <span class=skolem><span class=skolem>maskR</span></span> <span class=skolem><span class=skolem>a1_map</span></span> <span class=skolem><span class=skolem>a2_map</span></span> <span class=quoted>"<span class=skolem><span class=skolem>done</span></span>"</span> <span class=skolem><span class=skolem>done_length</span></span> <span class=keyword2><span class=keyword>where</span></span> shift_aux_def<span class=main>:</span>
    <span class=quoted><span class=quoted>"shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span> <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"shift_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span>"</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> valid_shift_aux<span class=main>:</span> <span class=quoted><span class=quoted>"valid_mmuaux' <span class=free>args</span> <span class=free>cur</span> <span class=free>nt</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span>
    <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=skolem>done</span><span class=main>,</span> <span class=skolem>done_length</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>ts</span><span class=main>.</span> <span class=bound>ts</span> <span class=main>∈</span> set <span class=main>(</span>linearize <span class=skolem>tss</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span>enat <span class=bound>ts</span> <span class=main>+</span> right <span class=main>(</span>args_ivl <span class=free>args</span><span class=main>)</span> <span class=main>&lt;</span> enat <span class=free>nt</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_mmuaux'<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>unfolded</span> valid_mmuaux_def<span class=main><span class=main>]</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> shift_aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> len_done_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>done</span> <span class=main>≤</span> length <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> list_all<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>⟹</span> check_before <span class=skolem>I</span> <span class=free>nt</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> set_drop_auxlist<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> set <span class=main>(</span>drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span>check_before <span class=skolem>I</span> <span class=free>nt</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux<span class=main>[</span><span class=operator>unfolded</span> valid_mmuaux'.simps<span class=main>]</span>
      list_all2_check_before<span class=main>[</span><span class=operator>OF</span> _ valid_shift_aux<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>have</span></span> take_auxlist_takeWhile<span class=main>:</span> <span class=quoted><span class=quoted>"take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span> <span class=main>=</span> takeWhile <span class=main>(</span>check_before <span class=skolem>I</span> <span class=free>nt</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> len_done_auxlist list_all set_drop_auxlist
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> take_takeWhile<span class=main>)</span> <span class=operator>assumption</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> rev_done<span class=main>:</span> <span class=quoted><span class=quoted>"rev <span class=skolem>done</span> <span class=main>=</span> map proj_thd <span class=main>(</span>take <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_shift_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> res'_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>res'</span> <span class=main>=</span> rev <span class=skolem>done</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> eval_until_res<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> take_auxlist_takeWhile I_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> auxlist'_def<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>auxlist'</span> <span class=main>=</span> drop <span class=main>(</span>length <span class=skolem>done</span><span class=main>)</span> <span class=free>auxlist</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> eval_until_auxlist'<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> eval_mmuaux_eq<span class=main>:</span> <span class=quoted><span class=quoted>"eval_mmuaux <span class=free>args</span> <span class=free>nt</span> <span class=free>aux</span> <span class=main>=</span> <span class=main>(</span>rev <span class=skolem>done</span><span class=main>,</span> <span class=main>(</span><span class=skolem>tp</span><span class=main>,</span> <span class=skolem>tss</span><span class=main>,</span> <span class=skolem>len</span><span class=main>,</span> <span class=skolem>maskL</span><span class=main>,</span> <span class=skolem>maskR</span><span class=main>,</span>
    <span class=skolem>a1_map</span><span class=main>,</span> <span class=skolem>a2_map</span><span class=main>,</span> <span class=main>[]</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> shift_aux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> done_empty_valid_mmuaux'_intro<span class=main>[</span><span class=operator>OF</span> valid_shift_aux<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> shift_aux_def eval_mmuaux_eq pos_def auxlist'_def res'_def valid_mmuaux_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>init_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>init_mmuaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=main>0</span><span class=main>,</span> empty_queue<span class=main>,</span> <span class=main>0</span><span class=main>,</span>
  join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_L <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>,</span> join_mask <span class=main>(</span>args_n <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span> <span class=main>(</span>args_R <span class=free><span class=bound><span class=entity>args</span></span></span><span class=main>)</span><span class=main>,</span>
  Mapping.empty<span class=main>,</span> Mapping.update <span class=main>0</span> Mapping.empty Mapping.empty<span class=main>,</span> <span class=main>[]</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_init_mmuaux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>L</span> <span class=main>⊆</span> <span class=free>R</span> <span class=main>⟹</span> valid_mmuaux <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>b</span><span class=main>)</span> <span class=main>0</span>
  <span class=main>(</span>init_mmuaux <span class=main>(</span>init_args <span class=free>I</span> <span class=free>n</span> <span class=free>L</span> <span class=free>R</span> <span class=free>b</span><span class=main>)</span><span class=main>)</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> init_mmuaux_def valid_mmuaux_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> init_args_def empty_queue_rep table_def Mapping.lookup_update<span class=main>)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>length_mmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> <span class=tfree>'a</span> mmuaux <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>length_mmuaux</span> <span class=free><span class=bound><span class=entity>args</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>tp</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>tss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>len</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskL</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>maskR</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a1_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>a2_map</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span><span class=main>)</span> <span class=main>=</span>
    <span class=free><span class=bound><span class=entity>len</span></span></span> <span class=main>+</span> <span class=free><span class=bound><span class=entity>done_length</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> valid_length_mmuaux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"valid_mmuaux <span class=free>args</span> <span class=free>cur</span> <span class=free>aux</span> <span class=free>auxlist</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length_mmuaux <span class=free>args</span> <span class=free>aux</span> <span class=main>=</span> length <span class=free>auxlist</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>aux</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_mmuaux_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> list_all2_lengthD<span class=main>)</span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Monitor_Impl><div class=head><h1>Theory Monitor_Impl</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Monitor_Impl
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Monitor.html>Monitor</a>
    <a href=Optimized_MTL.html>Optimized_MTL</a>
    <span class=quoted>"<a href=../../HOL/HOL-Library/Code_Target_Nat.html>HOL-Library.Code_Target_Nat</a>"</span>
    <a href=../Containers/Containers.html>Containers.Containers</a>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Instantiation of the generic algorithm and code setup›</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>code_unfold</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span><span class=main>,</span> <span class=operator>symmetric</span><span class=main>,</span> <span class=operator>code_post</span> <span class=quasi_keyword><span class=quasi_keyword><span class=quasi_keyword>del</span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"card <span class=main>≡</span> Cardinality.card'"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span> <span class=quoted>card</span><span class=main>]</span><span class=main>]</span> Set_Impl.card_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span>

<span class=keyword1><span class=command>instantiation</span></span> enat <span class=main>::</span> <span class=quoted>set_impl</span> <span class=keyword2><span class=keyword>begin</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity><span class=class_parameter>set_impl_enat</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>enat<span class=main>,</span> set_impl<span class=main>)</span> phantom"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>set_impl_enat</span> <span class=main>=</span> phantom set_RBT"</span></span>

<span class=keyword1><span class=command>instance</span></span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>derive</span></span> ccompare <span class=quoted>Formula.trm</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>eq<span class=main>)</span> ceq <span class=quoted>Formula.trm</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>rbt<span class=main>)</span> set_impl <span class=quoted>Formula.trm</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>eq<span class=main>)</span> ceq <span class=quoted>Monitor.mregex</span>
<span class=keyword1><span class=command>derive</span></span> ccompare <span class=quoted>Monitor.mregex</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>rbt<span class=main>)</span> set_impl <span class=quoted>Monitor.mregex</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>rbt<span class=main>)</span> mapping_impl <span class=quoted>Monitor.mregex</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>no<span class=main>)</span> cenum <span class=quoted>Monitor.mregex</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>rbt<span class=main>)</span> set_impl <span class=quoted>event_data</span>
<span class=keyword1><span class=command>derive</span></span> <span class=main>(</span>rbt<span class=main>)</span> mapping_impl <span class=quoted>event_data</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>add_new_mmuaux'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> ts <span class=main>⇒</span> event_data mmuaux <span class=main>⇒</span>
  event_data mmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_mmuaux'</span> <span class=main>=</span> add_new_mmuaux"</span></span>

<span class=keyword1><span class=command>interpretation</span></span> muaux <span class=quoted>valid_mmuaux</span> <span class=quoted>init_mmuaux</span> <span class=quoted>add_new_mmuaux'</span> <span class=quoted>length_mmuaux</span> <span class=quoted>eval_mmuaux</span>
  <span class=keyword1><span class=command>using</span></span> valid_init_mmuaux valid_add_new_mmuaux valid_length_mmuaux valid_eval_mmuaux
  <span class=keyword1><span class=command>unfolding</span></span> add_new_mmuaux'_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>assumption</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> vmsaux <span class=main>=</span> <span class=quoted><span class=quoted>"nat <span class=main>×</span> <span class=main>(</span>nat <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> list"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valid_vmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> nat <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span>
  <span class=main>(</span>nat <span class=main>×</span> event_data table<span class=main>)</span> list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_vmsaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=bound>cur</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=bound>auxlist</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> <span class=bound>cur</span> <span class=main>∧</span> <span class=bound>aux</span> <span class=main>=</span> <span class=bound>auxlist</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>init_vmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data vmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>init_vmsaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>add_new_ts_vmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> nat <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> event_data vmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_ts_vmsaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>args</span> <span class=bound>nt</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>nt</span><span class=main>,</span> filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span>
    enat <span class=main>(</span><span class=bound>nt</span> <span class=main>-</span> <span class=bound>t</span><span class=main>)</span> <span class=main>≤</span> right <span class=main>(</span>args_ivl <span class=bound>args</span><span class=main>)</span><span class=main>)</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>join_vmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> event_data vmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>join_vmsaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>args</span> <span class=bound>rel1</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>rel</span><span class=main>)</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>t</span><span class=main>,</span> join <span class=bound>rel</span> <span class=main>(</span>args_pos <span class=bound>args</span><span class=main>)</span> <span class=bound>rel1</span><span class=main>)</span><span class=main>)</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>add_new_table_vmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span>
  event_data vmsaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_table_vmsaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>args</span> <span class=bound>rel2</span> <span class=main>(</span><span class=bound>cur</span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>cur</span><span class=main>,</span> <span class=main>(</span><span class=keyword1>case</span> <span class=bound>auxlist</span> <span class=keyword1>of</span>
    <span class=main>[]</span> <span class=main>=&gt;</span> <span class=main>[</span><span class=main>(</span><span class=bound>cur</span><span class=main>,</span> <span class=bound>rel2</span><span class=main>)</span><span class=main>]</span>
  <span class=main>|</span> <span class=main>(</span><span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=bound>cur</span> <span class=keyword1>then</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>y</span> <span class=main>∪</span> <span class=bound>rel2</span><span class=main>)</span> <span class=main>#</span> <span class=bound>ts</span> <span class=keyword1>else</span> <span class=main>(</span><span class=bound>cur</span><span class=main>,</span> <span class=bound>rel2</span><span class=main>)</span> <span class=main>#</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>result_vmsaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> event_data table"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>result_vmsaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>args</span> <span class=main>(</span><span class=bound>cur</span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span>
    foldr <span class=main>(∪)</span> <span class=main>[</span><span class=bound>rel</span><span class=main>.</span> <span class=main>(</span>t<span class=main>,</span> rel<span class=main>)</span> <span class=main>←</span> <span class=bound>auxlist</span><span class=main>,</span> left <span class=main>(</span>args_ivl <span class=bound>args</span><span class=main>)</span> <span class=main>≤</span> <span class=bound>cur</span> <span class=main>-</span> <span class=bound>t</span><span class=main>]</span> <span class=main>{}</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=tfree>'a</span> vmuaux <span class=main>=</span> <span class=quoted><span class=quoted>"nat <span class=main>×</span> <span class=main>(</span>nat <span class=main>×</span> <span class=tfree>'a</span> table <span class=main>×</span> <span class=tfree>'a</span> table<span class=main>)</span> list"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valid_vmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> nat <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span>
  <span class=main>(</span>nat <span class=main>×</span> event_data table <span class=main>×</span> event_data table<span class=main>)</span> list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_vmuaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=bound>cur</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>aux</span><span class=main>)</span> <span class=bound>auxlist</span><span class=main>.</span> <span class=bound>t</span> <span class=main>=</span> <span class=bound>cur</span> <span class=main>∧</span> <span class=bound>aux</span> <span class=main>=</span> <span class=bound>auxlist</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>init_vmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data vmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>init_vmuaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>add_new_vmuaux</span> <span class=main>::</span>  <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data table <span class=main>⇒</span> event_data table <span class=main>⇒</span> nat <span class=main>⇒</span>
  event_data vmuaux <span class=main>⇒</span> event_data vmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>add_new_vmuaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>args</span> <span class=bound>rel1</span> <span class=bound>rel2</span> <span class=bound>nt</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>nt</span><span class=main>,</span> update_until <span class=bound>args</span> <span class=bound>rel1</span> <span class=bound>rel2</span> <span class=bound>nt</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>length_vmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>length_vmuaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=main>(</span><span class=main><span class=bound>_</span></span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span> length <span class=bound>auxlist</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>eval_vmuaux</span> <span class=main>::</span> <span class=quoted><span class=quoted>"args <span class=main>⇒</span> nat <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span>
  event_data table list <span class=main>×</span> event_data vmuaux"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eval_vmuaux</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>args</span> <span class=bound>nt</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>auxlist</span><span class=main>)</span><span class=main>.</span>
    <span class=main>(</span><span class=keyword1>let</span> <span class=main>(</span><span class=bound>res</span><span class=main>,</span> <span class=bound>auxlist'</span><span class=main>)</span> <span class=main>=</span> eval_until <span class=main>(</span>args_ivl <span class=bound>args</span><span class=main>)</span> <span class=bound>nt</span> <span class=bound>auxlist</span> <span class=keyword1>in</span> <span class=main>(</span><span class=bound>res</span><span class=main>,</span> <span class=main>(</span><span class=bound>t</span><span class=main>,</span> <span class=bound>auxlist'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>global_interpretation</span></span> verimon_maux<span class=main>:</span> maux <span class=quoted>valid_vmsaux</span> <span class=quoted>init_vmsaux</span> <span class=quoted>add_new_ts_vmsaux</span> <span class=quoted>join_vmsaux</span>
  <span class=quoted>add_new_table_vmsaux</span> <span class=quoted>result_vmsaux</span> <span class=quoted>valid_vmuaux</span> <span class=quoted>init_vmuaux</span> <span class=quoted>add_new_vmuaux</span> <span class=quoted>length_vmuaux</span>
  <span class=quoted>eval_vmuaux</span>
  <span class=keyword2><span class=keyword>defines</span></span> vminit0 <span class=main>=</span> <span class=quoted><span class=quoted>"maux.minit0 <span class=main>(</span>init_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux<span class=main>)</span> <span class=main>(</span>init_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux<span class=main>)</span> <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> <span class=main>_</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vminit <span class=main>=</span> <span class=quoted><span class=quoted>"maux.minit <span class=main>(</span>init_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux<span class=main>)</span> <span class=main>(</span>init_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux<span class=main>)</span> <span class=main>::</span> Formula.formula <span class=main>⇒</span> <span class=main>_</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vminit_safe <span class=main>=</span> <span class=quoted><span class=quoted>"maux.minit_safe <span class=main>(</span>init_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux<span class=main>)</span> <span class=main>(</span>init_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux<span class=main>)</span> <span class=main>::</span> Formula.formula <span class=main>⇒</span> <span class=main>_</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vmupdate_since <span class=main>=</span> <span class=quoted><span class=quoted>"maux.update_since add_new_ts_vmsaux join_vmsaux add_new_table_vmsaux <span class=main>(</span>result_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> event_data table<span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vmeval <span class=main>=</span> <span class=quoted><span class=quoted>"maux.meval add_new_ts_vmsaux join_vmsaux add_new_table_vmsaux <span class=main>(</span>result_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_vmuaux <span class=main>(</span>eval_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vmstep <span class=main>=</span> <span class=quoted><span class=quoted>"maux.mstep add_new_ts_vmsaux join_vmsaux add_new_table_vmsaux <span class=main>(</span>result_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_vmuaux <span class=main>(</span>eval_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vmsteps0_stateless <span class=main>=</span> <span class=quoted><span class=quoted>"maux.msteps0_stateless add_new_ts_vmsaux join_vmsaux add_new_table_vmsaux <span class=main>(</span>result_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_vmuaux <span class=main>(</span>eval_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vmsteps_stateless <span class=main>=</span> <span class=quoted><span class=quoted>"maux.msteps_stateless add_new_ts_vmsaux join_vmsaux add_new_table_vmsaux <span class=main>(</span>result_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_vmuaux <span class=main>(</span>eval_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> vmonitor <span class=main>=</span> <span class=quoted><span class=quoted>"maux.monitor init_vmsaux add_new_ts_vmsaux join_vmsaux add_new_table_vmsaux <span class=main>(</span>result_vmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> init_vmuaux add_new_vmuaux <span class=main>(</span>eval_vmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data vmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valid_vmsaux_def init_vmsaux_def add_new_ts_vmsaux_def join_vmsaux_def
    add_new_table_vmsaux_def result_vmsaux_def valid_vmuaux_def init_vmuaux_def add_new_vmuaux_def
    length_vmuaux_def eval_vmuaux_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>global_interpretation</span></span> default_maux<span class=main>:</span> maux <span class=quoted>valid_mmsaux</span> <span class=quoted><span class=quoted>"init_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux"</span></span> <span class=quoted>add_new_ts_mmsaux</span> <span class=quoted>gc_join_mmsaux</span> <span class=quoted>add_new_table_mmsaux</span> <span class=quoted>result_mmsaux</span>
  <span class=quoted>valid_mmuaux</span> <span class=quoted><span class=quoted>"init_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux"</span></span> <span class=quoted>add_new_mmuaux'</span> <span class=quoted>length_mmuaux</span> <span class=quoted>eval_mmuaux</span>
  <span class=keyword2><span class=keyword>defines</span></span> minit0 <span class=main>=</span> <span class=quoted><span class=quoted>"maux.minit0 <span class=main>(</span>init_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux<span class=main>)</span> <span class=main>(</span>init_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux<span class=main>)</span> <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> Formula.formula <span class=main>⇒</span> <span class=main>_</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> minit <span class=main>=</span> <span class=quoted><span class=quoted>"maux.minit <span class=main>(</span>init_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux<span class=main>)</span> <span class=main>(</span>init_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux<span class=main>)</span> <span class=main>::</span> Formula.formula <span class=main>⇒</span> <span class=main>_</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> minit_safe <span class=main>=</span> <span class=quoted><span class=quoted>"maux.minit_safe <span class=main>(</span>init_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux<span class=main>)</span> <span class=main>(</span>init_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux<span class=main>)</span> <span class=main>::</span> Formula.formula <span class=main>⇒</span> <span class=main>_</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> mupdate_since <span class=main>=</span> <span class=quoted><span class=quoted>"maux.update_since add_new_ts_mmsaux gc_join_mmsaux add_new_table_mmsaux <span class=main>(</span>result_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux <span class=main>⇒</span> event_data table<span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> meval <span class=main>=</span> <span class=quoted><span class=quoted>"maux.meval add_new_ts_mmsaux gc_join_mmsaux add_new_table_mmsaux <span class=main>(</span>result_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_mmuaux' <span class=main>(</span>eval_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> mstep <span class=main>=</span> <span class=quoted><span class=quoted>"maux.mstep add_new_ts_mmsaux gc_join_mmsaux add_new_table_mmsaux <span class=main>(</span>result_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_mmuaux' <span class=main>(</span>eval_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> msteps0_stateless <span class=main>=</span> <span class=quoted><span class=quoted>"maux.msteps0_stateless add_new_ts_mmsaux gc_join_mmsaux add_new_table_mmsaux <span class=main>(</span>result_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_mmuaux' <span class=main>(</span>eval_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> msteps_stateless <span class=main>=</span> <span class=quoted><span class=quoted>"maux.msteps_stateless add_new_ts_mmsaux gc_join_mmsaux add_new_table_mmsaux <span class=main>(</span>result_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> add_new_mmuaux' <span class=main>(</span>eval_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> monitor <span class=main>=</span> <span class=quoted><span class=quoted>"maux.monitor init_mmsaux add_new_ts_mmsaux gc_join_mmsaux add_new_table_mmsaux <span class=main>(</span>result_mmsaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmsaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span> init_mmuaux add_new_mmuaux' <span class=main>(</span>eval_mmuaux <span class=main>::</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data mmuaux <span class=main>⇒</span> <span class=main>_</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span>

<span class=keyword1><span class=command>lemma</span></span> image_these<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>`</span> Option.these <span class=free>X</span> <span class=main>=</span> Option.these <span class=main>(</span>map_option <span class=free>f</span> <span class=main>`</span> <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_these_eq Bex_def image_iff map_option_case <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>thm</span></span> default_maux.meval.simps<span class=main>(</span>2<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> meval_MPred<span class=main>:</span> <span class=quoted><span class=quoted>"meval <span class=free>n</span> <span class=free>t</span> <span class=free>db</span> <span class=main>(</span>MPred <span class=free>e</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free>db</span> <span class=free>e</span> <span class=keyword1>of</span> None <span class=main>⇒</span> <span class=main>[</span><span class=main>{}</span><span class=main>]</span> <span class=main>|</span> Some <span class=bound>Xs</span> <span class=main>⇒</span> map <span class=main>(</span><span class=main>λ</span><span class=bound>X</span><span class=main>.</span> <span class=main>⋃</span><span class=bound>v</span> <span class=main>∈</span> <span class=bound>X</span><span class=main>.</span>
  <span class=main>(</span>set_option <span class=main>(</span>map_option <span class=main>(</span><span class=main>λ</span><span class=bound>f</span><span class=main>.</span> Table.tabulate <span class=bound>f</span> <span class=main>0</span> <span class=free>n</span><span class=main>)</span> <span class=main>(</span>match <span class=free>ts</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=bound>Xs</span><span class=main>,</span> MPred <span class=free>e</span> <span class=free>ts</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Option.these_def image_iff<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> meval_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span> <span class=main>=</span> default_maux.meval.simps<span class=main>(</span>1<span class=main>)</span> meval_MPred default_maux.meval.simps<span class=main>(</span>3-<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>mk_db</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Formula.name <span class=main>×</span> event_data list set<span class=main>)</span> list <span class=main>⇒</span> <span class=main>_</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mk_db</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span> Monitor.mk_db <span class=main>(</span><span class=main>⋃</span><span class=bound>n</span> <span class=main>∈</span> set <span class=main>(</span>map fst <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=bound>n</span><span class=main>,</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> the <span class=main>(</span>map_of <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>rbt_fold</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>⇒</span> event_data tuple set_rbt <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rbt_fold</span> <span class=main>=</span> RBT_Set2.fold"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>rbt_empty</span> <span class=main>::</span> <span class=quoted><span class=quoted>"event_data list set_rbt"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rbt_empty</span> <span class=main>=</span> RBT_Set2.empty"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>rbt_insert</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>⇒</span> <span class=main>_</span> <span class=main>⇒</span> event_data list set_rbt"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rbt_insert</span> <span class=main>=</span> RBT_Set2.insert"</span></span>

<span class=keyword1><span class=command>lemma</span></span> saturate_commute<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span><span class=main>.</span> <span class=free>r</span> <span class=main>∈</span> <span class=free>g</span> <span class=bound>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span><span class=main>.</span> <span class=free>g</span> <span class=main>(</span>insert <span class=free>r</span> <span class=bound>s</span><span class=main>)</span> <span class=main>=</span> <span class=free>g</span> <span class=bound>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span><span class=main>.</span> <span class=free>r</span> <span class=main>∈</span> <span class=bound>s</span> <span class=main>⟹</span> <span class=free>h</span> <span class=bound>s</span> <span class=main>=</span> <span class=free>g</span> <span class=bound>s</span>"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> terminates<span class=main>:</span> <span class=quoted><span class=quoted>"mono <span class=free>g</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>⊆</span> <span class=free>C</span> <span class=main>⟹</span> <span class=free>g</span> <span class=bound>X</span> <span class=main>⊆</span> <span class=free>C</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=free>C</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"saturate <span class=free>g</span> <span class=main>{}</span> <span class=main>=</span> saturate <span class=free>h</span> <span class=main>{</span><span class=free>r</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>g</span> <span class=main>{}</span> <span class=main>=</span> <span class=main>{</span><span class=free>r</span><span class=main>}</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>with</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span> <span class=main>{</span><span class=free>r</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=free>r</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>{</span><span class=free>r</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=free>r</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> True <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> saturate_code<span class=main><span class=keyword3>;</span></span> <span class=operator>subst</span> saturate_code<span class=main>)</span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> saturate_def while_def
    <span class=keyword1><span class=command>using</span></span> while_option_finite_subset_Some<span class=main>[</span><span class=operator>OF</span> terminates<span class=main>]</span> assms<span class=main>(</span>1-3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> while_option_commute_invariant<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=bound>S</span> <span class=main>=</span> <span class=main>{}</span> <span class=main>∨</span> <span class=free>r</span> <span class=main>∈</span> <span class=bound>S</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=free>g</span> <span class=bound>S</span> <span class=main>≠</span> <span class=bound>S</span>"</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=free>h</span> <span class=bound>S</span> <span class=main>≠</span> <span class=bound>S</span>"</span></span> <span class=quoted><span class=quoted>"insert <span class=free>r</span>"</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=quoted>"<span class=main>{}</span>"</span></span><span class=main><span class=main>,</span></span> <span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> 4 4 <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> while_option_stop<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=free>g</span> <span class=bound>S</span> <span class=main>≠</span> <span class=bound>S</span>"</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=quoted>"<span class=main>{}</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>RPDs_aux</span> <span class=main>=</span> saturate <span class=main>(</span><span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=bound>S</span> <span class=main>∪</span> <span class=main>⋃</span> <span class=main>(</span>RPD <span class=main>`</span> <span class=bound>S</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> RPDs_aux_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"RPDs_aux <span class=free>S</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>S'</span> <span class=main>=</span> <span class=free>S</span> <span class=main>∪</span> Set.bind <span class=free>S</span> RPD <span class=keyword1>in</span> <span class=keyword1>if</span> <span class=bound>S'</span> <span class=main>⊆</span> <span class=free>S</span> <span class=keyword1>then</span> <span class=free>S</span> <span class=keyword1>else</span> RPDs_aux <span class=bound>S'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_aux_def bind_UNION
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> saturate_code<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>declare</span></span> RPDs_code<span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>del</span><span class=main>]</span>
<span class=keyword1><span class=command>lemma</span></span> RPDs_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"RPDs <span class=free>r</span> <span class=main>=</span> RPDs_aux <span class=main>{</span><span class=free>r</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> RPDs_aux_def RPDs_code
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> saturate_commute<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> C<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"RPDs <span class=free>r</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
     <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> mono_def subset_singleton_iff RPDs_refl RPDs_trans finite_RPDs<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>LPDs_aux</span> <span class=main>=</span> saturate <span class=main>(</span><span class=main>λ</span><span class=bound>S</span><span class=main>.</span> <span class=bound>S</span> <span class=main>∪</span> <span class=main>⋃</span> <span class=main>(</span>LPD <span class=main>`</span> <span class=bound>S</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> LPDs_aux_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"LPDs_aux <span class=free>S</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>S'</span> <span class=main>=</span> <span class=free>S</span> <span class=main>∪</span> Set.bind <span class=free>S</span> LPD <span class=keyword1>in</span> <span class=keyword1>if</span> <span class=bound>S'</span> <span class=main>⊆</span> <span class=free>S</span> <span class=keyword1>then</span> <span class=free>S</span> <span class=keyword1>else</span> LPDs_aux <span class=bound>S'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_aux_def bind_UNION
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> saturate_code<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>declare</span></span> LPDs_code<span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>del</span><span class=main>]</span>
<span class=keyword1><span class=command>lemma</span></span> LPDs_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"LPDs <span class=free>r</span> <span class=main>=</span> LPDs_aux <span class=main>{</span><span class=free>r</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> LPDs_aux_def LPDs_code
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> saturate_commute<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> C<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"LPDs <span class=free>r</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
     <span class=main>(</span><span class=operator>auto</span> 0 3 <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> mono_def subset_singleton_iff LPDs_refl LPDs_trans finite_LPDs<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> is_empty_table_unfold <span class=main>[</span><span class=operator>code_unfold</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>X</span> <span class=main>=</span> empty_table <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"empty_table <span class=main>=</span> <span class=free>X</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"Cardinality.eq_set <span class=free>X</span> empty_table <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"Cardinality.eq_set empty_table <span class=free>X</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"set_eq <span class=free>X</span> empty_table <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"set_eq empty_table <span class=free>X</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>X</span> <span class=main>=</span> <span class=main>(</span>set_empty <span class=free>impl</span><span class=main>)</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span>set_empty <span class=free>impl</span><span class=main>)</span> <span class=main>=</span> <span class=free>X</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"Cardinality.eq_set <span class=free>X</span> <span class=main>(</span>set_empty <span class=free>impl</span><span class=main>)</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"Cardinality.eq_set <span class=main>(</span>set_empty <span class=free>impl</span><span class=main>)</span> <span class=free>X</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"set_eq <span class=free>X</span> <span class=main>(</span>set_empty <span class=free>impl</span><span class=main>)</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=quoted><span class=quoted>"set_eq <span class=main>(</span>set_empty <span class=free>impl</span><span class=main>)</span> <span class=free>X</span> <span class=main>⟷</span> Set.is_empty <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> set_eq_def set_empty_def empty_table_def Set.is_empty_def Cardinality.eq_set_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> tabulate_rbt_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"Monitor.mrtabulate <span class=main>(</span><span class=free>xs</span> <span class=main>::</span> mregex list<span class=main>)</span> <span class=free>f</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>case</span> ID <span class=keyword1>CCOMPARE</span><span class=main>(</span>mregex<span class=main>)</span> <span class=keyword1>of</span> None <span class=main>⇒</span> Code.abort <span class=main>(</span><span class=keyword1>STR</span> <span class=inner_quoted>''tabulate RBT_Mapping: ccompare = None''</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> Monitor.mrtabulate <span class=main>(</span><span class=free>xs</span> <span class=main>::</span> mregex list<span class=main>)</span> <span class=free>f</span><span class=main>)</span>
  <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> RBT_Mapping <span class=main>(</span>RBT_Mapping2.bulkload <span class=main>(</span>List.map_filter <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> <span class=keyword1>let</span> <span class=bound>fk</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>k</span> <span class=keyword1>in</span> <span class=keyword1>if</span> <span class=bound>fk</span> <span class=main>=</span> empty_table <span class=keyword1>then</span> None <span class=keyword1>else</span> Some <span class=main>(</span><span class=bound>k</span><span class=main>,</span> <span class=bound>fk</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mrtabulate.abs_eq RBT_Mapping_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> combine_Mapping<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>::</span> ccompare<span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping_rbt"</span></span> <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"Mapping.combine <span class=free>f</span> <span class=main>(</span>RBT_Mapping <span class=free>t</span><span class=main>)</span> <span class=main>(</span>RBT_Mapping <span class=free>u</span><span class=main>)</span> <span class=main>=</span> 
  <span class=main>(</span><span class=keyword1>case</span> ID <span class=keyword1>CCOMPARE</span><span class=main>(</span><span class=tfree>'a</span><span class=main>)</span> <span class=keyword1>of</span> None <span class=main>⇒</span> Code.abort <span class=main>(</span><span class=keyword1>STR</span> <span class=inner_quoted>''combine RBT_Mapping: ccompare = None''</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> Mapping.combine <span class=free>f</span> <span class=main>(</span>RBT_Mapping <span class=free>t</span><span class=main>)</span> <span class=main>(</span>RBT_Mapping <span class=free>u</span><span class=main>)</span><span class=main>)</span>
                     <span class=main>|</span> Some <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> RBT_Mapping <span class=main>(</span>RBT_Mapping2.join <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=free>f</span><span class=main>)</span> <span class=free>t</span> <span class=free>u</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.combine.abs_eq Mapping_inject lookup_join <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.split<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set_empty<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"upd_set <span class=free>m</span> <span class=free>f</span> <span class=main>{}</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set_insert<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"upd_set <span class=free>m</span> <span class=free>f</span> <span class=main>(</span>insert <span class=free>x</span> <span class=free>A</span><span class=main>)</span> <span class=main>=</span> Mapping.update <span class=free>x</span> <span class=main>(</span><span class=free>f</span> <span class=free>x</span><span class=main>)</span> <span class=main>(</span>upd_set <span class=free>m</span> <span class=free>f</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Mapping_lookup_upd_set Mapping.lookup_update'<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set_fold<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"upd_set <span class=free>m</span> <span class=free>f</span> <span class=free>A</span> <span class=main>=</span> Finite_Set.fold <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> Mapping.update <span class=bound>a</span> <span class=main>(</span><span class=free>f</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=free>m</span> <span class=free>A</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> comp_fun_idem <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>a</span><span class=main>.</span> Mapping.update <span class=bound>a</span> <span class=main>(</span><span class=free>f</span> <span class=bound>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_eq_iff<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>A</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> upd_cfi <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping<span class=main>)</span> comp_fun_idem"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>f</span> <span class=bound>a</span> <span class=bound>m</span><span class=main>.</span> Mapping.update <span class=bound>a</span> <span class=main>(</span><span class=bound>f</span> <span class=bound>a</span><span class=main>)</span> <span class=bound>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_eq_iff<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> upd_set_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"upd_set <span class=free>m</span> <span class=free>f</span> <span class=free>A</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> finite <span class=free>A</span> <span class=keyword1>then</span> set_fold_cfi <span class=main>(</span>upd_cfi <span class=free>f</span><span class=main>)</span> <span class=free>m</span> <span class=free>A</span> <span class=keyword1>else</span> Code.abort <span class=main>(</span><span class=keyword1>STR</span> <span class=inner_quoted>''upd_set: infinite''</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> upd_set <span class=free>m</span> <span class=free>f</span> <span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> upd_set_fold<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> lexordp_eq_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"lexordp_eq <span class=free>xs</span> <span class=free>ys</span> <span class=main>⟷</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>xs</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> True
  <span class=main>|</span> <span class=bound>x</span> <span class=main>#</span> <span class=bound>xs</span> <span class=main>⇒</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free>ys</span> <span class=keyword1>of</span> <span class=main>[]</span> <span class=main>⇒</span> False
    <span class=main>|</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>ys</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=bound>y</span> <span class=keyword1>then</span> True <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>x</span> <span class=main>&gt;</span> <span class=bound>y</span> <span class=keyword1>then</span> False <span class=keyword1>else</span> lexordp_eq <span class=bound>xs</span> <span class=bound>ys</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> lexordp_eq.simps<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> list.split<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>filter_set</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span> Mapping.filter <span class=main>(</span>filter_cond <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>m</span></span></span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span> <span class=quoted>shift_end</span><span class=main>]</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> shift_end.simps<span class=main>[</span><span class=operator>folded</span> filter_set_def<span class=main>,</span> <span class=operator>code</span><span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_empty<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{}</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_set'_lookup<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_insert<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>d</span> <span class=main>=</span> <span class=free>f</span> <span class=free>d</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>f</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>(</span>insert <span class=free>x</span> <span class=free>A</span><span class=main>)</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>let</span> <span class=bound>m'</span> <span class=main>=</span> <span class=main>(</span>upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=free>A</span><span class=main>)</span> <span class=keyword1>in</span> <span class=keyword1>case</span> Mapping.lookup <span class=bound>m'</span> <span class=free>x</span> <span class=keyword1>of</span> None <span class=main>⇒</span> Mapping.update <span class=free>x</span> <span class=free>d</span> <span class=bound>m'</span>
  <span class=main>|</span> Some <span class=bound>v</span> <span class=main>⇒</span> Mapping.update <span class=free>x</span> <span class=main>(</span><span class=free>f</span> <span class=bound>v</span><span class=main>)</span> <span class=bound>m'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> upd_set'_lookup Mapping.lookup_update' <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_aux1<span class=main>:</span> <span class=quoted><span class=quoted>"upd_set' Mapping.empty <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=bound>b</span> <span class=main>=</span> <span class=free>k</span> <span class=main>∨</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span> <span class=main>=</span>
  Mapping.update <span class=free>k</span> <span class=free>d</span> <span class=main>(</span>upd_set' Mapping.empty <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def upd_set'_lookup Mapping.lookup_update'
      Mapping.lookup_empty <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_aux2<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>m</span> <span class=free>k</span> <span class=main>=</span> None <span class=main>⟹</span> upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=bound>b</span> <span class=main>=</span> <span class=free>k</span> <span class=main>∨</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span> <span class=main>=</span>
  Mapping.update <span class=free>k</span> <span class=free>d</span> <span class=main>(</span>upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_set'_lookup Mapping.lookup_update' <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_aux3<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=free>m</span> <span class=free>k</span> <span class=main>=</span> Some <span class=free>v</span> <span class=main>⟹</span> upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=bound>b</span> <span class=main>=</span> <span class=free>k</span> <span class=main>∨</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span> <span class=main>=</span>
  Mapping.update <span class=free>k</span> <span class=main>(</span><span class=free>f</span> <span class=free>v</span><span class=main>)</span> <span class=main>(</span>upd_set' <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_set'_lookup Mapping.lookup_update' <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_set'_aux4<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>∉</span> fst <span class=main>`</span> <span class=free>A</span> <span class=main>⟹</span> upd_set' Mapping.empty <span class=free>d</span> <span class=free>f</span> <span class=main>{</span><span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=free>k</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span> <span class=main>=</span> Mapping.empty"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_set'_lookup Mapping.lookup_update' Domain.DomainI fst_eq_Domain
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_nested_empty<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"upd_nested <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>{}</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mapping_eqI<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_nested_lookup <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>upd_nested_step</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'c</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'c</span> <span class=main>⇒</span> <span class=tfree>'c</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'b</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'b</span><span class=main>,</span> <span class=tfree>'c</span><span class=main>)</span> mapping<span class=main>)</span> mapping <span class=main>⇒</span>
  <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'b</span><span class=main>,</span> <span class=tfree>'c</span><span class=main>)</span> mapping<span class=main>)</span> mapping"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>upd_nested_step</span> <span class=free><span class=bound><span class=entity>d</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>case</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>of</span> <span class=main>(</span><span class=bound>k</span><span class=main>,</span> <span class=bound>k'</span><span class=main>)</span> <span class=main>⇒</span>
    <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=bound>k</span> <span class=keyword1>of</span> Some <span class=bound>m'</span> <span class=main>⇒</span>
      <span class=main>(</span><span class=keyword1>case</span> Mapping.lookup <span class=bound>m'</span> <span class=bound>k'</span> <span class=keyword1>of</span> Some <span class=bound>v</span> <span class=main>⇒</span> Mapping.update <span class=bound>k</span> <span class=main>(</span>Mapping.update <span class=bound>k'</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>v</span><span class=main>)</span> <span class=bound>m'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>m</span></span></span>
      <span class=main>|</span> None <span class=main>⇒</span> Mapping.update <span class=bound>k</span> <span class=main>(</span>Mapping.update <span class=bound>k'</span> <span class=free><span class=bound><span class=entity>d</span></span></span> <span class=bound>m'</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span>
    <span class=main>|</span> None <span class=main>⇒</span> Mapping.update <span class=bound>k</span> <span class=main>(</span>Mapping.update <span class=bound>k'</span> <span class=free><span class=bound><span class=entity>d</span></span></span> Mapping.empty<span class=main>)</span> <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> upd_nested_insert<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>d</span> <span class=main>=</span> <span class=free>f</span> <span class=free>d</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>f</span> <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> upd_nested <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=main>(</span>insert <span class=free>x</span> <span class=free>A</span><span class=main>)</span> <span class=main>=</span>
  upd_nested_step <span class=free>d</span> <span class=free>f</span> <span class=free>x</span> <span class=main>(</span>upd_nested <span class=free>m</span> <span class=free>d</span> <span class=free>f</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> upd_nested_step_def
  <span class=keyword1><span class=command>using</span></span> upd_set'_aux1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>d</span></span> <span class=quoted><span class=free>f</span></span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> upd_set'_aux2<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>d</span></span> <span class=quoted><span class=free>f</span></span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> upd_set'_aux3<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>d</span></span> <span class=quoted><span class=free>f</span></span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span>
    upd_set'_aux4<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>d</span></span> <span class=quoted><span class=free>f</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Let_def upd_nested_lookup upd_set'_lookup Mapping.lookup_update'
      Mapping.lookup_empty <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits prod.splits if_splits <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> mapping_eqI<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>upd_nested_max_tstp</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>upd_nested_max_tstp</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>d</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>=</span> upd_nested <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=free><span class=bound><span class=entity>d</span></span></span> <span class=main>(</span>max_tstp <span class=free><span class=bound><span class=entity>d</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>X</span></span></span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> upd_nested_max_tstp_fold<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"upd_nested_max_tstp <span class=free>m</span> <span class=free>d</span> <span class=free>X</span> <span class=main>=</span> Finite_Set.fold <span class=main>(</span>upd_nested_step <span class=free>d</span> <span class=main>(</span>max_tstp <span class=free>d</span><span class=main>)</span><span class=main>)</span> <span class=free>m</span> <span class=free>X</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> comp_fun_idem <span class=quoted><span class=quoted>"upd_nested_step <span class=free>d</span> <span class=main>(</span>max_tstp <span class=free>d</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>;</span></span> <span class=operator>rule</span> ext<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> comp_def upd_nested_step_def Mapping.lookup_update' Mapping.lookup_empty
       update_update max_tstp_d_d max_tstp_idem' <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> upd_nested_insert' <span class=main>=</span> upd_nested_insert<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>d</span></span> <span class=quoted><span class=quoted>"max_tstp <span class=free>d</span>"</span></span><span class=main>,</span>
    <span class=operator>OF</span> max_tstp_d_d<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> max_tstp_idem'<span class=main>]</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>X</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span>
       <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_nested_max_tstp_def upd_nested_insert'<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> upd_nested_max_tstp_cfi <span class=main>::</span>
  <span class=quoted><span class=quoted>"ts <span class=main>+</span> tp <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span> <span class=main>×</span> <span class=tfree>'b</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'b</span><span class=main>,</span> ts <span class=main>+</span> tp<span class=main>)</span> mapping<span class=main>)</span> mapping<span class=main>)</span> comp_fun_idem"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>d</span><span class=main>.</span> upd_nested_step <span class=bound>d</span> <span class=main>(</span>max_tstp <span class=bound>d</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>;</span></span> <span class=operator>rule</span> ext<span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> comp_def upd_nested_step_def Mapping.lookup_update' Mapping.lookup_empty
      update_update max_tstp_d_d max_tstp_idem' <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> upd_nested_max_tstp_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"upd_nested_max_tstp <span class=free>m</span> <span class=free>d</span> <span class=free>X</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> finite <span class=free>X</span> <span class=keyword1>then</span> set_fold_cfi <span class=main>(</span>upd_nested_max_tstp_cfi <span class=free>d</span><span class=main>)</span> <span class=free>m</span> <span class=free>X</span>
    <span class=keyword1>else</span> Code.abort <span class=main>(</span><span class=keyword1>STR</span> <span class=inner_quoted>''upd_nested_max_tstp: infinite''</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> upd_nested_max_tstp <span class=free>m</span> <span class=free>d</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> upd_nested_max_tstp_fold<span class=main>)</span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span> <span class=quoted>add_new_mmuaux'</span><span class=main>]</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> add_new_mmuaux'_def<span class=main>[</span><span class=operator>unfolded</span> add_new_mmuaux.simps<span class=main>,</span> <span class=operator>folded</span> upd_nested_max_tstp_def<span class=main>,</span> <span class=operator>code</span><span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> filter_set_empty<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"filter_set <span class=free>m</span> <span class=main>{}</span> <span class=free>t</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> filter_set_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_eq_iff <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> filter_set_insert<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"filter_set <span class=free>m</span> <span class=main>(</span>insert <span class=free>x</span> <span class=free>A</span><span class=main>)</span> <span class=free>t</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>let</span> <span class=bound>m'</span> <span class=main>=</span> filter_set <span class=free>m</span> <span class=free>A</span> <span class=free>t</span> <span class=keyword1>in</span>
  <span class=keyword1>case</span> Mapping.lookup <span class=bound>m'</span> <span class=free>x</span> <span class=keyword1>of</span> Some <span class=bound>u</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free>t</span> <span class=main>=</span> <span class=bound>u</span> <span class=keyword1>then</span> Mapping.delete <span class=free>x</span> <span class=bound>m'</span> <span class=keyword1>else</span> <span class=bound>m'</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>m'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> filter_set_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_eq_iff Let_def Map_To_Mapping.map_apply_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> filter_set_fold<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"filter_set <span class=free>m</span> <span class=free>A</span> <span class=free>t</span> <span class=main>=</span> Finite_Set.fold <span class=main>(</span><span class=main>λ</span><span class=bound>a</span> <span class=bound>m</span><span class=main>.</span>
    <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span> <span class=keyword1>of</span> Some <span class=bound>u</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free>t</span> <span class=main>=</span> <span class=bound>u</span> <span class=keyword1>then</span> Mapping.delete <span class=bound>a</span> <span class=bound>m</span> <span class=keyword1>else</span> <span class=bound>m</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>m</span><span class=main>)</span> <span class=free>m</span> <span class=free>A</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> comp_fun_idem <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>a</span> <span class=bound>m</span><span class=main>.</span>
    <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span> <span class=keyword1>of</span> Some <span class=bound>u</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=free>t</span> <span class=main>=</span> <span class=bound>u</span> <span class=keyword1>then</span> Mapping.delete <span class=bound>a</span> <span class=bound>m</span> <span class=keyword1>else</span> <span class=bound>m</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>m</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span>
      <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_eq_iff Map_To_Mapping.map_apply_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>A</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> Let_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> filter_cfi <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'b</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping<span class=main>)</span> comp_fun_idem"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>t</span> <span class=bound>a</span> <span class=bound>m</span><span class=main>.</span>
    <span class=keyword1>case</span> Mapping.lookup <span class=bound>m</span> <span class=bound>a</span> <span class=keyword1>of</span> Some <span class=bound>u</span> <span class=main>⇒</span> <span class=keyword1>if</span> <span class=bound>t</span> <span class=main>=</span> <span class=bound>u</span> <span class=keyword1>then</span> Mapping.delete <span class=bound>a</span> <span class=bound>m</span> <span class=keyword1>else</span> <span class=bound>m</span> <span class=main>|</span> <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> <span class=bound>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span>
    <span class=main>(</span><span class=operator>transfer</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fun_eq_iff Map_To_Mapping.map_apply_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> filter_set_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"filter_set <span class=free>m</span> <span class=free>A</span> <span class=free>t</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> finite <span class=free>A</span> <span class=keyword1>then</span> set_fold_cfi <span class=main>(</span>filter_cfi <span class=free>t</span><span class=main>)</span> <span class=free>m</span> <span class=free>A</span> <span class=keyword1>else</span> Code.abort <span class=main>(</span><span class=keyword1>STR</span> <span class=inner_quoted>''upd_set: infinite''</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> filter_set <span class=free>m</span> <span class=free>A</span> <span class=free>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> filter_set_fold<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> filter_Mapping<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>t</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>::</span> ccompare<span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping_rbt"</span></span> <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"Mapping.filter <span class=free>P</span> <span class=main>(</span>RBT_Mapping <span class=free>t</span><span class=main>)</span> <span class=main>=</span> 
  <span class=main>(</span><span class=keyword1>case</span> ID <span class=keyword1>CCOMPARE</span><span class=main>(</span><span class=tfree>'a</span><span class=main>)</span> <span class=keyword1>of</span> None <span class=main>⇒</span> Code.abort <span class=main>(</span><span class=keyword1>STR</span> <span class=inner_quoted>''filter RBT_Mapping: ccompare = None''</span><span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> Mapping.filter <span class=free>P</span> <span class=main>(</span>RBT_Mapping <span class=free>t</span><span class=main>)</span><span class=main>)</span>
                     <span class=main>|</span> Some <span class=main><span class=bound>_</span></span> <span class=main>⇒</span> RBT_Mapping <span class=main>(</span>RBT_Mapping2.filter <span class=main>(</span>case_prod <span class=free>P</span><span class=main>)</span> <span class=free>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Mapping.filter.abs_eq Mapping_inject <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.split<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>filter_join</span> <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>=</span> Mapping.filter <span class=main>(</span>join_filter_cond <span class=free><span class=bound><span class=entity>pos</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>m</span></span></span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span> <span class=quoted>join_mmsaux</span><span class=main>]</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> join_mmsaux.simps<span class=main>[</span><span class=operator>folded</span> filter_join_def<span class=main>,</span> <span class=operator>code</span><span class=main>]</span>

<span class=keyword1><span class=command>lemma</span></span> filter_join_False_empty<span class=main>:</span> <span class=quoted><span class=quoted>"filter_join False <span class=main>{}</span> <span class=free>m</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> filter_join_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> filter_join_False_insert<span class=main>:</span> <span class=quoted><span class=quoted>"filter_join False <span class=main>(</span>insert <span class=free>a</span> <span class=free>A</span><span class=main>)</span> <span class=free>m</span> <span class=main>=</span>
  filter_join False <span class=free>A</span> <span class=main>(</span>Mapping.delete <span class=free>a</span> <span class=free>m</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Mapping.lookup <span class=main>(</span>filter_join False <span class=main>(</span>insert <span class=free>a</span> <span class=free>A</span><span class=main>)</span> <span class=free>m</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span>
      Mapping.lookup <span class=main>(</span>filter_join False <span class=free>A</span> <span class=main>(</span>Mapping.delete <span class=free>a</span> <span class=free>m</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_join_def Mapping.lookup_filter Mapping_lookup_delete
          <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> option.splits<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> mapping_eqI<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> filter_join_False<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"filter_join False <span class=free>A</span> <span class=free>m</span> <span class=main>=</span> Finite_Set.fold Mapping.delete <span class=free>m</span> <span class=free>A</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> comp_fun_idem <span class=quoted><span class=quoted>"Mapping.delete"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>;</span></span> <span class=operator>transfer</span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> comp_def<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>A</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span>
       <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_join_False_empty filter_join_False_insert fold_fun_left_comm<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> filter_not_in_cfi <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> mapping<span class=main>)</span> comp_fun_idem"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"Mapping.delete"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>;</span></span> <span class=operator>transfer</span><span class=main>)</span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> comp_def<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>lemma</span></span> filter_join_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"filter_join <span class=free>pos</span> <span class=free>A</span> <span class=free>m</span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>if</span> <span class=main>¬</span><span class=free>pos</span> <span class=main>∧</span> finite <span class=free>A</span> <span class=main>∧</span> card <span class=free>A</span> <span class=main>&lt;</span> Mapping.size <span class=free>m</span> <span class=keyword1>then</span> set_fold_cfi filter_not_in_cfi <span class=free>m</span> <span class=free>A</span>
    <span class=keyword1>else</span> Mapping.filter <span class=main>(</span>join_filter_cond <span class=free>pos</span> <span class=free>A</span><span class=main>)</span> <span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> filter_join_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>use</span> filter_join_False <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> <span class=quoted>‹<span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main>:</span> filter_join_def›</span><span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>set_minus</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set <span class=main>⇒</span> <span class=tfree>'a</span> set <span class=main>⇒</span> <span class=tfree>'a</span> set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>set_minus</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>Y</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>-</span> <span class=free><span class=bound><span class=entity>Y</span></span></span>"</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> remove_cfi <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'a</span> set<span class=main>)</span> comp_fun_idem"</span></span>
  <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>b</span> <span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>-</span> <span class=main>{</span><span class=bound>b</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> set_minus_finite<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> fin<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=free>Y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"set_minus <span class=free>X</span> <span class=free>Y</span> <span class=main>=</span> Finite_Set.fold <span class=main>(</span><span class=main>λ</span><span class=bound>a</span> <span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>-</span> <span class=main>{</span><span class=bound>a</span><span class=main>}</span><span class=main>)</span> <span class=free>X</span> <span class=free>Y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> comp_fun_idem <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>a</span> <span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>-</span> <span class=main>{</span><span class=bound>a</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>Y</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>X</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> set_minus_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> set_minus_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"set_minus <span class=free>X</span> <span class=free>Y</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>if</span> finite <span class=free>Y</span> <span class=main>∧</span> card <span class=free>Y</span> <span class=main>&lt;</span> card <span class=free>X</span> <span class=keyword1>then</span> set_fold_cfi remove_cfi <span class=free>X</span> <span class=free>Y</span> <span class=keyword1>else</span> <span class=free>X</span> <span class=main>-</span> <span class=free>Y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>transfer</span> <span class=main>(</span><span class=operator>use</span> set_minus_finite <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> <span class=quoted>‹<span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main>:</span> set_minus_def›</span><span class=main>)</span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span> <span class=quoted>bin_join</span><span class=main>]</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> bin_join.simps<span class=main>[</span><span class=operator>folded</span> set_minus_def<span class=main>,</span> <span class=operator>code</span><span class=main>]</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>remove_Union</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>remove_Union</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=free><span class=bound><span class=entity>B</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>-</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>.</span> <span class=free><span class=bound><span class=entity>B</span></span></span> <span class=bound>x</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> remove_Union_finite<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"remove_Union <span class=free>A</span> <span class=free>X</span> <span class=free>B</span> <span class=main>=</span> Finite_Set.fold <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>A</span><span class=main>.</span> <span class=bound>A</span> <span class=main>-</span> <span class=free>B</span> <span class=bound>x</span><span class=main>)</span> <span class=free>A</span> <span class=free>X</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> comp_fun_idem <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>A</span><span class=main>.</span> <span class=bound>A</span> <span class=main>-</span> <span class=free>B</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>X</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>A</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite_induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> remove_Union_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lift_definition</span></span> remove_Union_cfi <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span> set<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span> set<span class=main>)</span> comp_fun_idem"</span></span> <span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>B</span> <span class=bound>x</span> <span class=bound>A</span><span class=main>.</span> <span class=bound>A</span> <span class=main>-</span> <span class=bound>B</span> <span class=bound>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> remove_Union_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"remove_Union <span class=free>A</span> <span class=free>X</span> <span class=free>B</span> <span class=main>=</span>
  <span class=main>(</span><span class=keyword1>if</span> finite <span class=free>X</span> <span class=keyword1>then</span> set_fold_cfi <span class=main>(</span>remove_Union_cfi <span class=free>B</span><span class=main>)</span> <span class=free>A</span> <span class=free>X</span> <span class=keyword1>else</span> <span class=free>A</span> <span class=main>-</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>X</span><span class=main>.</span> <span class=free>B</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>X</span></span> <span class=quoted><span class=free>B</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>use</span> remove_Union_finite<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>X</span></span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>B</span></span><span class=main><span class=main>]</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> <span class=quoted>‹<span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main>:</span> remove_Union_def›</span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> tabulate_remdups<span class=main>:</span> <span class=quoted><span class=quoted>"Mapping.tabulate <span class=free>xs</span> <span class=free>f</span> <span class=main>=</span> Mapping.tabulate <span class=main>(</span>remdups <span class=free>xs</span><span class=main>)</span> <span class=free>f</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>xs</span></span> <span class=quoted><span class=free>f</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_of_map_restrict<span class=main>)</span>

<span class=keyword1><span class=command>lift_definition</span></span> clearjunk <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>String.literal <span class=main>×</span> event_data list set<span class=main>)</span> list <span class=main>⇒</span> <span class=main>(</span>String.literal<span class=main>,</span> event_data list set list<span class=main>)</span> alist"</span></span> <span class=keyword2><span class=keyword>is</span></span>
  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>t</span><span class=main>.</span> List.map_filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>X</span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> None <span class=keyword1>else</span> Some <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=main>[</span><span class=bound>X</span><span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>AList.clearjunk <span class=bound>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> map_filter_def o_def list.map_comp
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> map_cong<span class=main><span class=main>[</span></span><span class=operator>OF</span> refl<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted>fst</span><span class=main><span class=main>]</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_filter_def distinct_map_fst_filter <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> map_filter_snd_map_filter<span class=main>:</span> <span class=quoted><span class=quoted>"List.map_filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>b</span> <span class=keyword1>then</span> None <span class=keyword1>else</span> Some <span class=main>(</span><span class=free>f</span> <span class=bound>a</span> <span class=bound>b</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span> <span class=main>=</span>
    map <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span><span class=main>.</span> <span class=free>f</span> <span class=bound>a</span> <span class=bound>b</span><span class=main>)</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span> <span class=free>P</span> <span class=main>(</span>snd <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>xs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> map_filter_def prod.case_eq_if<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mk_db_code_alist<span class=main>:</span>
  <span class=quoted><span class=quoted>"mk_db <span class=free>t</span> <span class=main>=</span> Assoc_List_Mapping <span class=main>(</span>clearjunk <span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mk_db_def Assoc_List_Mapping_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer'</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_filter_snd_map_filter fun_eq_iff map_of_map image_iff map_of_clearjunk
      map_of_filter_apply <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> weak_map_of_SomeI <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> map_of_SomeD<span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> mk_db_code<span class=main>[</span><span class=operator>code</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"mk_db <span class=free>t</span> <span class=main>=</span> Mapping.of_alist <span class=main>(</span>List.map_filter <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>X</span><span class=main>)</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>X</span> <span class=main>=</span> <span class=main>{}</span> <span class=keyword1>then</span> None <span class=keyword1>else</span> Some <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=main>[</span><span class=bound>X</span><span class=main>]</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>AList.clearjunk <span class=free>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mk_db_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>transfer'</span> <span class=quasi_keyword>fixing</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> map_filter_snd_map_filter fun_eq_iff map_of_map image_iff
      map_of_clearjunk map_of_filter_apply <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> weak_map_of_SomeI <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> bexI<span class=main><span class=main>[</span></span><span class=operator>rotated</span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> map_of_SomeD<span class=main><span class=main>]</span></span>
      <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span> if_splits option.splits<span class=main>)</span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>code</span> <span class=quasi_keyword>drop</span><span class=main><span class=main>:</span></span> <span class=quoted>New_max_getIJ_genericJoin</span> <span class=quoted>New_max_getIJ_wrapperGenericJoin</span><span class=main>]</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> New_max.genericJoin.simps<span class=main>[</span><span class=operator>folded</span> remove_Union_def<span class=main>,</span> <span class=operator>code</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> New_max.wrapperGenericJoin.simps<span class=main>[</span><span class=operator>folded</span> remove_Union_def<span class=main>,</span> <span class=operator>code</span><span class=main>]</span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div><div id=Monitor_Code><div class=head><h1>Theory Monitor_Code</h1></div><pre class=source><span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> Monitor_Code
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Monitor_Impl.html>Monitor_Impl</a>
<span class=keyword2><span class=keyword>begin</span></span>
<span class=comment1>(*&gt;*)</span>

<span class=keyword1><span class=command>export_code</span></span> <span class=quoted><span class=quoted>convert_multiway</span></span> <span class=quoted><span class=quoted>vminit_safe</span></span> <span class=quoted><span class=quoted>minit_safe</span></span> <span class=quoted><span class=quoted>vmstep</span></span> <span class=quoted><span class=quoted>mstep</span></span> <span class=quoted><span class=quoted>mmonitorable_exec</span></span>
   <span class=keyword2><span class=keyword>checking</span></span> OCaml<span class=main>?</span>

<span class=keyword1><span class=command>export_code</span></span>
  <span class=comment1>(*basic types*)</span>
  <span class=quoted><span class=quoted>nat_of_integer</span></span> <span class=quoted><span class=quoted>integer_of_nat</span></span> <span class=quoted><span class=quoted>int_of_integer</span></span> <span class=quoted><span class=quoted>integer_of_int</span></span> <span class=quoted><span class=quoted>enat</span></span>
  <span class=quoted><span class=quoted>interval</span></span> <span class=quoted><span class=quoted>mk_db</span></span> <span class=quoted><span class=quoted>RBT_set</span></span> <span class=quoted><span class=quoted>rbt_empty</span></span> <span class=quoted><span class=quoted>rbt_insert</span></span> <span class=quoted><span class=quoted>rbt_fold</span></span>
  <span class=comment1>(*term, formula, and regex constructors*)</span>
  <span class=quoted><span class=quoted>EInt</span></span> <span class=quoted><span class=quoted>Formula.Var</span></span> <span class=quoted><span class=quoted>Formula.Agg_Cnt</span></span> <span class=quoted><span class=quoted>Formula.Pred</span></span> <span class=quoted><span class=quoted>Regex.Skip</span></span> <span class=quoted><span class=quoted>Regex.Wild</span></span>
  <span class=comment1>(*main functions*)</span>
  <span class=quoted><span class=quoted>convert_multiway</span></span> <span class=quoted><span class=quoted>vminit_safe</span></span> <span class=quoted><span class=quoted>minit_safe</span></span> <span class=quoted><span class=quoted>vmstep</span></span> <span class=quoted><span class=quoted>mstep</span></span> <span class=quoted><span class=quoted>mmonitorable_exec</span></span>
  <span class=keyword2><span class=keyword>in</span></span> OCaml <span class=keyword2><span class=keyword>module_name</span></span> Monitor <span class=keyword2><span class=keyword>file_prefix</span></span> <span class=quoted>"verified"</span>

<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span></pre></div></main></div></div></body></html>
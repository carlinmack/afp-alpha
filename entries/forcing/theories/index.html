<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Session Forcing - Archive of Formal Proofs</title><meta name=description content="A collection of proof libraries, examples, and larger scientific developments, mechanically checked in the theorem prover Isabelle."><meta property="og:title" content="Session Forcing"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="/entries/forcing/theories/"><meta property="og:image" content="/images/afp.png"><meta property="article:section" content="theories"><meta property="og:site_name" content="Archive of Formal Proofs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/afp.png"><meta name=twitter:title content="Session Forcing"><meta name=twitter:description content><link rel=stylesheet type=text/css href=/css/front.min.css><link rel=stylesheet type=text/css href=/css/isabelle.css><link rel=icon href=/images/favicon.ico type=image/icon><script src=/js/flexsearch.min.js></script><script src=/js/banner.js></script><script src=/js/header-search.js></script></head><body class=mathjax_ignore><aside><div><div><a href=/><img src=/images/afp.png alt="Logo of the Archive of Formal Proofs" class=logo></a><ul><li><a href=/entries/forcing>Return to entry</a></li></ul><hr><ul><li><a href=#Utils>Utils</a></li><li><a href=#files%2futils.ML>files/utils.ML</a></li><li><a href=#Forcing_Notions>Forcing_Notions</a><ul><li><a href=#Forcing_Notions-compat_inI>compat_inI</a></li><li><a href=#Forcing_Notions-refl_compat>refl_compat</a></li><li><a href=#Forcing_Notions-chain_compat>chain_compat</a></li><li><a href=#Forcing_Notions-subset_fun_image>subset_fun_image</a></li><li><a href=#Forcing_Notions-refl_monot_domain>refl_monot_domain</a></li><li><a href=#Forcing_Notions-refl_leq>refl_leq</a></li><li><a href=#Forcing_Notions-P_dense>P_dense</a></li><li><a href=#Forcing_Notions-leq_transD>leq_transD</a></li><li><a href=#Forcing_Notions-leq_transD%27>leq_transD'</a></li><li><a href=#Forcing_Notions-leq_reflI>leq_reflI</a></li><li><a href=#Forcing_Notions-compatD>compatD</a></li><li><a href=#Forcing_Notions-compatI>compatI</a></li><li><a href=#Forcing_Notions-denseD>denseD</a></li><li><a href=#Forcing_Notions-denseI>denseI</a></li><li><a href=#Forcing_Notions-dense_belowD>dense_belowD</a></li><li><a href=#Forcing_Notions-dense_belowI>dense_belowI</a></li><li><a href=#Forcing_Notions-dense_below_cong>dense_below_cong</a></li><li><a href=#Forcing_Notions-dense_below_cong%27>dense_below_cong'</a></li><li><a href=#Forcing_Notions-dense_below_mono>dense_below_mono</a></li><li><a href=#Forcing_Notions-dense_below_under>dense_below_under</a></li><li><a href=#Forcing_Notions-ideal_dense_below>ideal_dense_below</a></li><li><a href=#Forcing_Notions-dense_below_dense_below>dense_below_dense_below</a></li><li><a href=#Forcing_Notions-filterD>filterD</a></li><li><a href=#Forcing_Notions-filter_leqD>filter_leqD</a></li><li><a href=#Forcing_Notions-filter_imp_compat>filter_imp_compat</a></li><li><a href=#Forcing_Notions-low_bound_filter>low_bound_filter</a></li><li><a href=#Forcing_Notions-upclosureI>upclosureI</a></li><li><a href=#Forcing_Notions-upclosureE>upclosureE</a></li><li><a href=#Forcing_Notions-upclosureD>upclosureD</a></li><li><a href=#Forcing_Notions-upclosure_increasing>upclosure_increasing</a></li><li><a href=#Forcing_Notions-upclosure_in_P>upclosure_in_P</a></li><li><a href=#Forcing_Notions-A_sub_upclosure>A_sub_upclosure</a></li><li><a href=#Forcing_Notions-elem_upclosure>elem_upclosure</a></li><li><a href=#Forcing_Notions-closure_compat_filter>closure_compat_filter</a></li><li><a href=#Forcing_Notions-aux_RS1>aux_RS1</a></li><li><a href=#Forcing_Notions-decr_succ_decr>decr_succ_decr</a></li><li><a href=#Forcing_Notions-decr_seq_linear>decr_seq_linear</a></li><li><a href=#Forcing_Notions-RS_sequence_imp_rasiowa_sikorski>RS_sequence_imp_rasiowa_sikorski</a></li><li><a href=#Forcing_Notions-preimage_rangeD>preimage_rangeD</a></li><li><a href=#Forcing_Notions-countable_RS_sequence_aux>countable_RS_sequence_aux</a></li><li><a href=#Forcing_Notions-countable_RS_sequence>countable_RS_sequence</a></li><li><a href=#Forcing_Notions-RS_seq_type>RS_seq_type</a></li><li><a href=#Forcing_Notions-RS_seq_funtype>RS_seq_funtype</a></li></ul></li><li><a href=#Pointed_DC>Pointed_DC</a><ul><li><a href=#Pointed_DC-witness_into_A>witness_into_A</a></li><li><a href=#Pointed_DC-witness_related>witness_related</a></li><li><a href=#Pointed_DC-witness_funtype>witness_funtype</a></li><li><a href=#Pointed_DC-witness_to_fun>witness_to_fun</a></li><li><a href=#Pointed_DC-aux_DC_on_AxNat2>aux_DC_on_AxNat2</a></li><li><a href=#Pointed_DC-infer_snd>infer_snd</a></li><li><a href=#Pointed_DC-aux_sequence_DC>aux_sequence_DC</a></li><li><a href=#Pointed_DC-aux_sequence_DC2>aux_sequence_DC2</a></li><li><a href=#Pointed_DC-sequence_DC>sequence_DC</a></li></ul></li><li><a href=#Rasiowa_Sikorski>Rasiowa_Sikorski</a><ul><li><a href=#Rasiowa_Sikorski-RS_relation>RS_relation</a></li><li><a href=#Rasiowa_Sikorski-DC_imp_RS_sequence>DC_imp_RS_sequence</a></li></ul></li><li><a href=#Nat_Miscellanea>Nat_Miscellanea</a><ul><li><a href=#Nat_Miscellanea-nat_succD>nat_succD</a></li><li><a href=#Nat_Miscellanea-in_n_in_nat>in_n_in_nat</a></li><li><a href=#Nat_Miscellanea-in_succ_in_nat>in_succ_in_nat</a></li><li><a href=#Nat_Miscellanea-ltI_neg>ltI_neg</a></li><li><a href=#Nat_Miscellanea-succ_pred_eq>succ_pred_eq</a></li><li><a href=#Nat_Miscellanea-succ_ltI>succ_ltI</a></li><li><a href=#Nat_Miscellanea-succ_In>succ_In</a></li><li><a href=#Nat_Miscellanea-succpred_leI>succpred_leI</a></li><li><a href=#Nat_Miscellanea-succpred_n0>succpred_n0</a></li><li><a href=#Nat_Miscellanea-funcI>funcI</a></li><li><a href=#Nat_Miscellanea-succ_in>succ_in</a></li><li><a href=#Nat_Miscellanea-pred_le2>pred_le2</a></li><li><a href=#Nat_Miscellanea-pred_le>pred_le</a></li><li><a href=#Nat_Miscellanea-Un_leD1>Un_leD1</a></li><li><a href=#Nat_Miscellanea-Un_leD2>Un_leD2</a></li><li><a href=#Nat_Miscellanea-gt1>gt1</a></li><li><a href=#Nat_Miscellanea-pred_mono>pred_mono</a></li><li><a href=#Nat_Miscellanea-succ_mono>succ_mono</a></li><li><a href=#Nat_Miscellanea-pred2_Un>pred2_Un</a></li><li><a href=#Nat_Miscellanea-nat_union_abs1>nat_union_abs1</a></li><li><a href=#Nat_Miscellanea-nat_union_abs2>nat_union_abs2</a></li><li><a href=#Nat_Miscellanea-nat_un_max>nat_un_max</a></li><li><a href=#Nat_Miscellanea-nat_max_ty>nat_max_ty</a></li><li><a href=#Nat_Miscellanea-le_not_lt_nat>le_not_lt_nat</a></li><li><a href=#Nat_Miscellanea-le_succ>le_succ</a></li><li><a href=#Nat_Miscellanea-le_pred>le_pred</a></li><li><a href=#Nat_Miscellanea-Un_le_compat>Un_le_compat</a></li><li><a href=#Nat_Miscellanea-Un_le>Un_le</a></li><li><a href=#Nat_Miscellanea-Un_leI3>Un_leI3</a></li><li><a href=#Nat_Miscellanea-diff_mono>diff_mono</a></li><li><a href=#Nat_Miscellanea-pred_Un>pred_Un</a></li><li><a href=#Nat_Miscellanea-le_natI>le_natI</a></li><li><a href=#Nat_Miscellanea-le_natE>le_natE</a></li><li><a href=#Nat_Miscellanea-diff_cancel>diff_cancel</a></li><li><a href=#Nat_Miscellanea-leD>leD</a></li><li><a href=#Nat_Miscellanea-max_cong>max_cong</a></li><li><a href=#Nat_Miscellanea-max_commutes>max_commutes</a></li><li><a href=#Nat_Miscellanea-max_cong2>max_cong2</a></li><li><a href=#Nat_Miscellanea-max_D1>max_D1</a></li><li><a href=#Nat_Miscellanea-max_D2>max_D2</a></li><li><a href=#Nat_Miscellanea-oadd_lt_mono2>oadd_lt_mono2</a></li></ul></li><li><a href=#Internalizations>Internalizations</a><ul><li><a href=#Internalizations-nth_closed>nth_closed</a></li><li><a href=#Internalizations-nth_ConsI>nth_ConsI</a></li></ul></li><li><a href=#Recursion_Thms>Recursion_Thms</a><ul><li><a href=#Recursion_Thms-fld_restrict_eq>fld_restrict_eq</a></li><li><a href=#Recursion_Thms-fld_restrict_mono>fld_restrict_mono</a></li><li><a href=#Recursion_Thms-fld_restrict_dom>fld_restrict_dom</a></li><li><a href=#Recursion_Thms-tr_downD>tr_downD</a></li><li><a href=#Recursion_Thms-pred_down>pred_down</a></li><li><a href=#Recursion_Thms-tr_down_mono>tr_down_mono</a></li><li><a href=#Recursion_Thms-rest_eq>rest_eq</a></li><li><a href=#Recursion_Thms-wfrec_restr_eq>wfrec_restr_eq</a></li><li><a href=#Recursion_Thms-wfrec_restr>wfrec_restr</a></li><li><a href=#Recursion_Thms-wfrec_trans_restr>wfrec_trans_restr</a></li><li><a href=#Recursion_Thms-field_trancl>field_trancl</a></li><li><a href=#Recursion_Thms-RrelI>RrelI</a></li><li><a href=#Recursion_Thms-Rrel_mem>Rrel_mem</a></li><li><a href=#Recursion_Thms-relation_Rrel>relation_Rrel</a></li><li><a href=#Recursion_Thms-field_Rrel>field_Rrel</a></li><li><a href=#Recursion_Thms-Rrel_mono>Rrel_mono</a></li><li><a href=#Recursion_Thms-Rrel_restr_eq>Rrel_restr_eq</a></li><li><a href=#Recursion_Thms-field_Memrel>field_Memrel</a></li><li><a href=#Recursion_Thms-restrict_trancl_Rrel>restrict_trancl_Rrel</a></li><li><a href=#Recursion_Thms-restrict_trans_eq>restrict_trans_eq</a></li><li><a href=#Recursion_Thms-wf_eq_trancl>wf_eq_trancl</a></li></ul></li><li><a href=#Relative_Univ>Relative_Univ</a><ul><li><a href=#Relative_Univ-Collect_inter_Transset>Collect_inter_Transset</a></li><li><a href=#Relative_Univ-is_powapply_closed>is_powapply_closed</a></li><li><a href=#Relative_Univ-is_powapply_abs>is_powapply_abs</a></li><li><a href=#Relative_Univ-Replace_is_powapply>Replace_is_powapply</a></li><li><a href=#Relative_Univ-powapply_closed>powapply_closed</a></li><li><a href=#Relative_Univ-RepFun_is_powapply>RepFun_is_powapply</a></li><li><a href=#Relative_Univ-RepFun_powapply_closed>RepFun_powapply_closed</a></li><li><a href=#Relative_Univ-Union_powapply_closed>Union_powapply_closed</a></li><li><a href=#Relative_Univ-relation2_HVfrom>relation2_HVfrom</a></li><li><a href=#Relative_Univ-HVfrom_closed>HVfrom_closed</a></li><li><a href=#Relative_Univ-transrec_HVfrom>transrec_HVfrom</a></li><li><a href=#Relative_Univ-Vfrom_abs>Vfrom_abs</a></li><li><a href=#Relative_Univ-Vfrom_closed>Vfrom_closed</a></li><li><a href=#Relative_Univ-Vset_abs>Vset_abs</a></li><li><a href=#Relative_Univ-Vset_closed>Vset_closed</a></li><li><a href=#Relative_Univ-Hrank_trancl>Hrank_trancl</a></li><li><a href=#Relative_Univ-rank_trancl>rank_trancl</a></li><li><a href=#Relative_Univ-univ_PHrank>univ_PHrank</a></li><li><a href=#Relative_Univ-PHrank_abs>PHrank_abs</a></li><li><a href=#Relative_Univ-PHrank_closed>PHrank_closed</a></li><li><a href=#Relative_Univ-Replace_PHrank_abs>Replace_PHrank_abs</a></li><li><a href=#Relative_Univ-RepFun_PHrank>RepFun_PHrank</a></li><li><a href=#Relative_Univ-RepFun_PHrank_closed>RepFun_PHrank_closed</a></li><li><a href=#Relative_Univ-relation2_Hrank>relation2_Hrank</a></li><li><a href=#Relative_Univ-Union_PHrank_closed>Union_PHrank_closed</a></li><li><a href=#Relative_Univ-is_Hrank_closed>is_Hrank_closed</a></li><li><a href=#Relative_Univ-rank_closed>rank_closed</a></li><li><a href=#Relative_Univ-M_into_Vset>M_into_Vset</a></li></ul></li><li><a href=#Synthetic_Definition>Synthetic_Definition</a></li><li><a href=#Interface>Interface</a><ul><li><a href=#Interface-choice_ax_abs>choice_ax_abs</a></li><li><a href=#Interface-empty_intf>empty_intf</a></li><li><a href=#Interface-Transset_intf>Transset_intf</a></li><li><a href=#Interface-TranssetI>TranssetI</a></li><li><a href=#Interface-zero_in_M>zero_in_M</a></li><li><a href=#Interface-mtrans>mtrans</a></li><li><a href=#Interface-mtriv>mtriv</a></li><li><a href=#Interface-inter_sep_intf>inter_sep_intf</a></li><li><a href=#Interface-diff_sep_intf>diff_sep_intf</a></li><li><a href=#Interface-cartprod_sep_intf>cartprod_sep_intf</a></li><li><a href=#Interface-image_sep_intf>image_sep_intf</a></li><li><a href=#Interface-converse_sep_intf>converse_sep_intf</a></li><li><a href=#Interface-restrict_sep_intf>restrict_sep_intf</a></li><li><a href=#Interface-comp_sep_intf>comp_sep_intf</a></li><li><a href=#Interface-pred_sep_intf>pred_sep_intf</a></li><li><a href=#Interface-memrel_sep_intf>memrel_sep_intf</a></li><li><a href=#Interface-is_recfun_sep_intf>is_recfun_sep_intf</a></li><li><a href=#Interface-funspace_succ_rep_intf>funspace_succ_rep_intf</a></li><li><a href=#Interface-mbasic>mbasic</a></li><li><a href=#Interface-repl_sats>repl_sats</a></li><li><a href=#Interface-powerset_type>powerset_type</a></li><li><a href=#Interface-is_powapply_type>is_powapply_type</a></li><li><a href=#Interface-sats_is_powapply_fm>sats_is_powapply_fm</a></li><li><a href=#Interface-PHrank_type>PHrank_type</a></li><li><a href=#Interface-is_Hrank_type>is_Hrank_type</a></li><li><a href=#Interface-is_HVfrom_type>is_HVfrom_type</a></li><li><a href=#Interface-sats_is_HVfrom_fm>sats_is_HVfrom_fm</a></li><li><a href=#Interface-is_HVfrom_iff_sats>is_HVfrom_iff_sats</a></li></ul></li><li><a href=#Forcing_Data>Forcing_Data</a><ul><li><a href=#Forcing_Data-Transset_M>Transset_M</a></li><li><a href=#Forcing_Data-zero_in_M>zero_in_M</a></li><li><a href=#Forcing_Data-tuples_in_M>tuples_in_M</a></li><li><a href=#Forcing_Data-nat_in_M>nat_in_M</a></li><li><a href=#Forcing_Data-n_in_M>n_in_M</a></li><li><a href=#Forcing_Data-mtriv>mtriv</a></li><li><a href=#Forcing_Data-mtrans>mtrans</a></li><li><a href=#Forcing_Data-mbasic>mbasic</a></li><li><a href=#Forcing_Data-mtrancl>mtrancl</a></li><li><a href=#Forcing_Data-mdatatypes>mdatatypes</a></li><li><a href=#Forcing_Data-meclose>meclose</a></li><li><a href=#Forcing_Data-meclose_pow>meclose_pow</a></li><li><a href=#Forcing_Data-Collect_in_M_0p>Collect_in_M_0p</a></li><li><a href=#Forcing_Data-Collect_in_M_2p>Collect_in_M_2p</a></li><li><a href=#Forcing_Data-Collect_in_M_4p>Collect_in_M_4p</a></li><li><a href=#Forcing_Data-Repl_in_M>Repl_in_M</a></li><li><a href=#Forcing_Data-transD>transD</a></li><li><a href=#Forcing_Data-M_genericD>M_genericD</a></li><li><a href=#Forcing_Data-M_generic_leqD>M_generic_leqD</a></li><li><a href=#Forcing_Data-M_generic_compatD>M_generic_compatD</a></li><li><a href=#Forcing_Data-M_generic_denseD>M_generic_denseD</a></li><li><a href=#Forcing_Data-G_nonempty>G_nonempty</a></li><li><a href=#Forcing_Data-one_in_G>one_in_G</a></li><li><a href=#Forcing_Data-G_subset_M>G_subset_M</a></li><li><a href=#Forcing_Data-generic_filter_existence>generic_filter_existence</a></li><li><a href=#Forcing_Data-compat_in_abs>compat_in_abs</a></li><li><a href=#Forcing_Data-compat_in_fm_type>compat_in_fm_type</a></li><li><a href=#Forcing_Data-sats_compat_in_fm>sats_compat_in_fm</a></li></ul></li><li><a href=#Internal_ZFC_Axioms>Internal_ZFC_Axioms</a><ul><li><a href=#Internal_ZFC_Axioms-ZFC_fin_type>ZFC_fin_type</a></li><li><a href=#Internal_ZFC_Axioms-iterates_Forall_type>iterates_Forall_type</a></li><li><a href=#Internal_ZFC_Axioms-last_init_eq>last_init_eq</a></li><li><a href=#Internal_ZFC_Axioms-take_drop_eq>take_drop_eq</a></li><li><a href=#Internal_ZFC_Axioms-list_split>list_split</a></li><li><a href=#Internal_ZFC_Axioms-sats_nForall>sats_nForall</a></li><li><a href=#Internal_ZFC_Axioms-sep_body_fm_type>sep_body_fm_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_sep_body_fm>sats_sep_body_fm</a></li><li><a href=#Internal_ZFC_Axioms-ZF_separation_fm_type>ZF_separation_fm_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_ZF_separation_fm_iff>sats_ZF_separation_fm_iff</a></li><li><a href=#Internal_ZFC_Axioms-univalent_fm_type>univalent_fm_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_univalent_fm>sats_univalent_fm</a></li><li><a href=#Internal_ZFC_Axioms-swap_vars_type>swap_vars_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_swap_vars>sats_swap_vars</a></li><li><a href=#Internal_ZFC_Axioms-univalent_Qs_type>univalent_Qs_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_univalent_fm_assm>sats_univalent_fm_assm</a></li><li><a href=#Internal_ZFC_Axioms-rep_body_fm_type>rep_body_fm_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_rep_body_fm>sats_rep_body_fm</a></li><li><a href=#Internal_ZFC_Axioms-ZF_replacement_fm_type>ZF_replacement_fm_type</a></li><li><a href=#Internal_ZFC_Axioms-sats_ZF_replacement_fm_iff>sats_ZF_replacement_fm_iff</a></li><li><a href=#Internal_ZFC_Axioms-Un_subset_formula>Un_subset_formula</a></li><li><a href=#Internal_ZFC_Axioms-ZF_inf_subset_formula>ZF_inf_subset_formula</a></li><li><a href=#Internal_ZFC_Axioms-ZFC_subset_formula>ZFC_subset_formula</a></li><li><a href=#Internal_ZFC_Axioms-satTI>satTI</a></li><li><a href=#Internal_ZFC_Axioms-satTD>satTD</a></li><li><a href=#Internal_ZFC_Axioms-sats_ZFC_iff_sats_ZF_AC>sats_ZFC_iff_sats_ZF_AC</a></li><li><a href=#Internal_ZFC_Axioms-M_ZF_iff_M_satT>M_ZF_iff_M_satT</a></li></ul></li><li><a href=#Renaming>Renaming</a><ul><li><a href=#Renaming-app_nm>app_nm</a></li><li><a href=#Renaming-union_fun_type>union_fun_type</a></li><li><a href=#Renaming-union_fun_action>union_fun_action</a></li><li><a href=#Renaming-id_fn_type>id_fn_type</a></li><li><a href=#Renaming-id_fn_action>id_fn_action</a></li><li><a href=#Renaming-sum_inl>sum_inl</a></li><li><a href=#Renaming-sum_inr>sum_inr</a></li><li><a href=#Renaming-sum_action>sum_action</a></li><li><a href=#Renaming-sum_type>sum_type</a></li><li><a href=#Renaming-sum_type_id>sum_type_id</a></li><li><a href=#Renaming-sum_type_id_aux2>sum_type_id_aux2</a></li><li><a href=#Renaming-sum_action_id>sum_action_id</a></li><li><a href=#Renaming-sum_action_id_aux>sum_action_id_aux</a></li><li><a href=#Renaming-sum_id0>sum_id0</a></li><li><a href=#Renaming-sum_idS>sum_idS</a></li><li><a href=#Renaming-sum_id_tc_aux>sum_id_tc_aux</a></li><li><a href=#Renaming-sum_id_tc>sum_id_tc</a></li><li><a href=#Renaming-arity_meml>arity_meml</a></li><li><a href=#Renaming-arity_memr>arity_memr</a></li><li><a href=#Renaming-arity_eql>arity_eql</a></li><li><a href=#Renaming-arity_eqr>arity_eqr</a></li><li><a href=#Renaming-nand_ar1>nand_ar1</a></li><li><a href=#Renaming-nand_ar2>nand_ar2</a></li><li><a href=#Renaming-nand_ar1D>nand_ar1D</a></li><li><a href=#Renaming-nand_ar2D>nand_ar2D</a></li><li><a href=#Renaming-ren_tc>ren_tc</a></li><li><a href=#Renaming-arity_ren>arity_ren</a></li><li><a href=#Renaming-arity_forallE>arity_forallE</a></li><li><a href=#Renaming-env_coincidence_sum_id>env_coincidence_sum_id</a></li><li><a href=#Renaming-sats_iff_sats_ren>sats_iff_sats_ren</a></li></ul></li><li><a href=#Renaming_Auto>Renaming_Auto</a></li><li><a href=#files%2frenaming.ML>files/renaming.ML</a></li><li><a href=#Names>Names</a><ul><li><a href=#Names-Sep_and_Replace>Sep_and_Replace</a></li><li><a href=#Names-SepReplace_subset>SepReplace_subset</a></li><li><a href=#Names-SepReplace_iff>SepReplace_iff</a></li><li><a href=#Names-SepReplace_dom_implies>SepReplace_dom_implies</a></li><li><a href=#Names-SepReplace_pred_implies>SepReplace_pred_implies</a></li><li><a href=#Names-eclose_sing>eclose_sing</a></li><li><a href=#Names-ecloseE>ecloseE</a></li><li><a href=#Names-eclose_singE>eclose_singE</a></li><li><a href=#Names-in_eclose_sing>in_eclose_sing</a></li><li><a href=#Names-in_dom_in_eclose>in_dom_in_eclose</a></li><li><a href=#Names-edI>edI</a></li><li><a href=#Names-edD>edD</a></li><li><a href=#Names-rank_ed>rank_ed</a></li><li><a href=#Names-edrel_dest>edrel_dest</a></li><li><a href=#Names-edrelD>edrelD</a></li><li><a href=#Names-edrelI>edrelI</a></li><li><a href=#Names-edrel_trans>edrel_trans</a></li><li><a href=#Names-domain_trans>domain_trans</a></li><li><a href=#Names-relation_edrel>relation_edrel</a></li><li><a href=#Names-field_edrel>field_edrel</a></li><li><a href=#Names-edrel_sub_memrel>edrel_sub_memrel</a></li><li><a href=#Names-wf_edrel>wf_edrel</a></li><li><a href=#Names-ed_induction>ed_induction</a></li><li><a href=#Names-dom_under_edrel_eclose>dom_under_edrel_eclose</a></li><li><a href=#Names-ed_eclose>ed_eclose</a></li><li><a href=#Names-tr_edrel_eclose>tr_edrel_eclose</a></li><li><a href=#Names-restrict_edrel_eq>restrict_edrel_eq</a></li><li><a href=#Names-tr_edrel_subset>tr_edrel_subset</a></li><li><a href=#Names-upairM>upairM</a></li><li><a href=#Names-singletonM>singletonM</a></li><li><a href=#Names-Rep_simp>Rep_simp</a></li><li><a href=#Names-checkD>checkD</a></li><li><a href=#Names-Hcheck_trancl>Hcheck_trancl</a></li><li><a href=#Names-check_trancl>check_trancl</a></li><li><a href=#Names-rcheck_in_M>rcheck_in_M</a></li><li><a href=#Names-aux_def_check>aux_def_check</a></li><li><a href=#Names-def_check>def_check</a></li><li><a href=#Names-def_checkS>def_checkS</a></li><li><a href=#Names-field_Memrel2>field_Memrel2</a></li><li><a href=#Names-aux_def_val>aux_def_val</a></li><li><a href=#Names-def_val>def_val</a></li><li><a href=#Names-val_mono>val_mono</a></li><li><a href=#Names-valcheck>valcheck</a></li><li><a href=#Names-val_of_name>val_of_name</a></li><li><a href=#Names-val_of_name_alt>val_of_name_alt</a></li><li><a href=#Names-val_only_names>val_only_names</a></li><li><a href=#Names-val_only_pairs>val_only_pairs</a></li><li><a href=#Names-val_subset_domain_times_range>val_subset_domain_times_range</a></li><li><a href=#Names-val_subset_domain_times_P>val_subset_domain_times_P</a></li><li><a href=#Names-val_of_elem>val_of_elem</a></li><li><a href=#Names-elem_of_val>elem_of_val</a></li><li><a href=#Names-elem_of_val_pair>elem_of_val_pair</a></li><li><a href=#Names-elem_of_val_pair%27>elem_of_val_pair'</a></li><li><a href=#Names-GenExtD>GenExtD</a></li><li><a href=#Names-GenExtI>GenExtI</a></li><li><a href=#Names-Transset_MG>Transset_MG</a></li><li><a href=#Names-check_n_M>check_n_M</a></li><li><a href=#Names-one_in_M>one_in_M</a></li><li><a href=#Names-def_PHcheck>def_PHcheck</a></li><li><a href=#Names-PHcheck_type>PHcheck_type</a></li><li><a href=#Names-sats_PHcheck_fm>sats_PHcheck_fm</a></li><li><a href=#Names-is_Hcheck_type>is_Hcheck_type</a></li><li><a href=#Names-sats_is_Hcheck_fm>sats_is_Hcheck_fm</a></li><li><a href=#Names-wfrec_Hcheck>wfrec_Hcheck</a></li><li><a href=#Names-repl_PHcheck>repl_PHcheck</a></li><li><a href=#Names-univ_PHcheck>univ_PHcheck</a></li><li><a href=#Names-relation2_Hcheck>relation2_Hcheck</a></li><li><a href=#Names-PHcheck_closed>PHcheck_closed</a></li><li><a href=#Names-Hcheck_closed>Hcheck_closed</a></li><li><a href=#Names-wf_rcheck>wf_rcheck</a></li><li><a href=#Names-trans_rcheck>trans_rcheck</a></li><li><a href=#Names-relation_rcheck>relation_rcheck</a></li><li><a href=#Names-check_in_M>check_in_M</a></li><li><a href=#Names-singleton_type>singleton_type</a></li><li><a href=#Names-is_singleton_iff_sats>is_singleton_iff_sats</a></li><li><a href=#Names-rcheck_abs>rcheck_abs</a></li><li><a href=#Names-check_abs>check_abs</a></li><li><a href=#Names-check_fm_type>check_fm_type</a></li><li><a href=#Names-sats_check_fm>sats_check_fm</a></li><li><a href=#Names-check_replacement>check_replacement</a></li><li><a href=#Names-pair_check>pair_check</a></li><li><a href=#Names-M_subset_MG>M_subset_MG</a></li><li><a href=#Names-G_dot_in_M>G_dot_in_M</a></li><li><a href=#Names-val_G_dot>val_G_dot</a></li><li><a href=#Names-G_in_Gen_Ext>G_in_Gen_Ext</a></li><li><a href=#Names-fst_snd_closed>fst_snd_closed</a></li><li><a href=#Names-zero_in_MG>zero_in_MG</a></li><li><a href=#Names-G_nonempty>G_nonempty</a></li></ul></li><li><a href=#FrecR>FrecR</a><ul><li><a href=#FrecR-sats_hcomp_fm>sats_hcomp_fm</a></li><li><a href=#FrecR-components_simp>components_simp</a></li><li><a href=#FrecR-components_in_eclose>components_in_eclose</a></li><li><a href=#FrecR-ecloseNI1>ecloseNI1</a></li><li><a href=#FrecR-ecloseN_mono>ecloseN_mono</a></li><li><a href=#FrecR-sats_fst_fm>sats_fst_fm</a></li><li><a href=#FrecR-sats_ftype_fm>sats_ftype_fm</a></li><li><a href=#FrecR-is_ftype_iff_sats>is_ftype_iff_sats</a></li><li><a href=#FrecR-sats_snd_fm>sats_snd_fm</a></li><li><a href=#FrecR-sats_name1_fm>sats_name1_fm</a></li><li><a href=#FrecR-is_name1_iff_sats>is_name1_iff_sats</a></li><li><a href=#FrecR-sats_snd2_fm>sats_snd2_fm</a></li><li><a href=#FrecR-sats_name2_fm>sats_name2_fm</a></li><li><a href=#FrecR-is_name2_iff_sats>is_name2_iff_sats</a></li><li><a href=#FrecR-sats_cond_of_fm>sats_cond_of_fm</a></li><li><a href=#FrecR-is_cond_of_iff_sats>is_cond_of_iff_sats</a></li><li><a href=#FrecR-components_type>components_type</a></li><li><a href=#FrecR-ecloseN_fm_type>ecloseN_fm_type</a></li><li><a href=#FrecR-sats_ecloseN_fm>sats_ecloseN_fm</a></li><li><a href=#FrecR-frecR_ftypeD>frecR_ftypeD</a></li><li><a href=#FrecR-frecRI1>frecRI1</a></li><li><a href=#FrecR-frecRI1%27>frecRI1'</a></li><li><a href=#FrecR-frecRI2>frecRI2</a></li><li><a href=#FrecR-frecRI2%27>frecRI2'</a></li><li><a href=#FrecR-frecRI3>frecRI3</a></li><li><a href=#FrecR-frecRI3%27>frecRI3'</a></li><li><a href=#FrecR-frecR_iff>frecR_iff</a></li><li><a href=#FrecR-frecR_D1>frecR_D1</a></li><li><a href=#FrecR-frecR_D2>frecR_D2</a></li><li><a href=#FrecR-frecR_DI>frecR_DI</a></li><li><a href=#FrecR-eq_ftypep_not_frecrR>eq_ftypep_not_frecrR</a></li><li><a href=#FrecR-rank_names_types>rank_names_types</a></li><li><a href=#FrecR-type_form_tc>type_form_tc</a></li><li><a href=#FrecR-frecR_le_rnk_names>frecR_le_rnk_names</a></li><li><a href=#FrecR-%ce%93_type>Γ_type</a></li><li><a href=#FrecR-%ce%93_mono>Γ_mono</a></li><li><a href=#FrecR-frecrelI>frecrelI</a></li><li><a href=#FrecR-frecrelD>frecrelD</a></li><li><a href=#FrecR-wf_frecrel>wf_frecrel</a></li><li><a href=#FrecR-core_induction_aux>core_induction_aux</a></li><li><a href=#FrecR-def_frecrel>def_frecrel</a></li><li><a href=#FrecR-frecrel_fst_snd>frecrel_fst_snd</a></li></ul></li><li><a href=#Arities>Arities</a><ul><li><a href=#Arities-arity_upair_fm>arity_upair_fm</a></li><li><a href=#Arities-arity_pair_fm>arity_pair_fm</a></li><li><a href=#Arities-arity_composition_fm>arity_composition_fm</a></li><li><a href=#Arities-arity_domain_fm>arity_domain_fm</a></li><li><a href=#Arities-arity_range_fm>arity_range_fm</a></li><li><a href=#Arities-arity_union_fm>arity_union_fm</a></li><li><a href=#Arities-arity_image_fm>arity_image_fm</a></li><li><a href=#Arities-arity_pre_image_fm>arity_pre_image_fm</a></li><li><a href=#Arities-arity_big_union_fm>arity_big_union_fm</a></li><li><a href=#Arities-arity_fun_apply_fm>arity_fun_apply_fm</a></li><li><a href=#Arities-arity_field_fm>arity_field_fm</a></li><li><a href=#Arities-arity_empty_fm>arity_empty_fm</a></li><li><a href=#Arities-arity_succ_fm>arity_succ_fm</a></li><li><a href=#Arities-number1arity__fm>number1arity__fm</a></li><li><a href=#Arities-arity_function_fm>arity_function_fm</a></li><li><a href=#Arities-arity_relation_fm>arity_relation_fm</a></li><li><a href=#Arities-arity_restriction_fm>arity_restriction_fm</a></li><li><a href=#Arities-arity_typed_function_fm>arity_typed_function_fm</a></li><li><a href=#Arities-arity_subset_fm>arity_subset_fm</a></li><li><a href=#Arities-arity_transset_fm>arity_transset_fm</a></li><li><a href=#Arities-arity_ordinal_fm>arity_ordinal_fm</a></li><li><a href=#Arities-arity_limit_ordinal_fm>arity_limit_ordinal_fm</a></li><li><a href=#Arities-arity_finite_ordinal_fm>arity_finite_ordinal_fm</a></li><li><a href=#Arities-arity_omega_fm>arity_omega_fm</a></li><li><a href=#Arities-arity_cartprod_fm>arity_cartprod_fm</a></li><li><a href=#Arities-arity_fst_fm>arity_fst_fm</a></li><li><a href=#Arities-arity_snd_fm>arity_snd_fm</a></li><li><a href=#Arities-arity_snd_snd_fm>arity_snd_snd_fm</a></li><li><a href=#Arities-arity_ftype_fm>arity_ftype_fm</a></li><li><a href=#Arities-name1arity__fm>name1arity__fm</a></li><li><a href=#Arities-name2arity__fm>name2arity__fm</a></li><li><a href=#Arities-arity_cond_of_fm>arity_cond_of_fm</a></li><li><a href=#Arities-arity_singleton_fm>arity_singleton_fm</a></li><li><a href=#Arities-arity_Memrel_fm>arity_Memrel_fm</a></li><li><a href=#Arities-arity_quasinat_fm>arity_quasinat_fm</a></li><li><a href=#Arities-arity_is_recfun_fm>arity_is_recfun_fm</a></li><li><a href=#Arities-arity_is_wfrec_fm>arity_is_wfrec_fm</a></li><li><a href=#Arities-arity_is_nat_case_fm>arity_is_nat_case_fm</a></li><li><a href=#Arities-arity_iterates_MH_fm>arity_iterates_MH_fm</a></li><li><a href=#Arities-arity_is_iterates_fm>arity_is_iterates_fm</a></li><li><a href=#Arities-arity_eclose_n_fm>arity_eclose_n_fm</a></li><li><a href=#Arities-arity_mem_eclose_fm>arity_mem_eclose_fm</a></li><li><a href=#Arities-arity_is_eclose_fm>arity_is_eclose_fm</a></li><li><a href=#Arities-eclose_n1arity__fm>eclose_n1arity__fm</a></li><li><a href=#Arities-eclose_n2arity__fm>eclose_n2arity__fm</a></li><li><a href=#Arities-arity_ecloseN_fm>arity_ecloseN_fm</a></li><li><a href=#Arities-arity_frecR_fm>arity_frecR_fm</a></li><li><a href=#Arities-arity_Collect_fm>arity_Collect_fm</a></li></ul></li><li><a href=#Forces_Definition>Forces_Definition</a><ul><li><a href=#Forces_Definition-arity_frecrelP_fm>arity_frecrelP_fm</a></li><li><a href=#Forces_Definition-frecrelP_fm_type>frecrelP_fm_type</a></li><li><a href=#Forces_Definition-sats_frecrelP_fm>sats_frecrelP_fm</a></li><li><a href=#Forces_Definition-frecrelP_iff_sats>frecrelP_iff_sats</a></li><li><a href=#Forces_Definition-frecrel_fm_type>frecrel_fm_type</a></li><li><a href=#Forces_Definition-arity_frecrel_fm>arity_frecrel_fm</a></li><li><a href=#Forces_Definition-sats_frecrel_fm>sats_frecrel_fm</a></li><li><a href=#Forces_Definition-is_frecrel_iff_sats>is_frecrel_iff_sats</a></li><li><a href=#Forces_Definition-names_belowsD>names_belowsD</a></li><li><a href=#Forces_Definition-number2_fm_type>number2_fm_type</a></li><li><a href=#Forces_Definition-number2arity__fm>number2arity__fm</a></li><li><a href=#Forces_Definition-sats_number2_fm>sats_number2_fm</a></li><li><a href=#Forces_Definition-arity_is_names_below_fm>arity_is_names_below_fm</a></li><li><a href=#Forces_Definition-is_names_below_fm_type>is_names_below_fm_type</a></li><li><a href=#Forces_Definition-sats_is_names_below_fm>sats_is_names_below_fm</a></li><li><a href=#Forces_Definition-arity_is_tuple_fm>arity_is_tuple_fm</a></li><li><a href=#Forces_Definition-is_tuple_fm_type>is_tuple_fm_type</a></li><li><a href=#Forces_Definition-sats_is_tuple_fm>sats_is_tuple_fm</a></li><li><a href=#Forces_Definition-is_tuple_iff_sats>is_tuple_iff_sats</a></li><li><a href=#Forces_Definition-arity_mem_case_fm>arity_mem_case_fm</a></li><li><a href=#Forces_Definition-arity_eq_case_fm>arity_eq_case_fm</a></li><li><a href=#Forces_Definition-Hfrc_fm_type>Hfrc_fm_type</a></li><li><a href=#Forces_Definition-arity_Hfrc_fm>arity_Hfrc_fm</a></li><li><a href=#Forces_Definition-sats_Hfrc_fm>sats_Hfrc_fm</a></li><li><a href=#Forces_Definition-Hfrc_iff_sats>Hfrc_iff_sats</a></li><li><a href=#Forces_Definition-arity_Hfrc_at_fm>arity_Hfrc_at_fm</a></li><li><a href=#Forces_Definition-Hfrc_at_fm_type>Hfrc_at_fm_type</a></li><li><a href=#Forces_Definition-sats_Hfrc_at_fm>sats_Hfrc_at_fm</a></li><li><a href=#Forces_Definition-is_Hfrc_at_iff_sats>is_Hfrc_at_iff_sats</a></li><li><a href=#Forces_Definition-arity_tran_closure_fm>arity_tran_closure_fm</a></li><li><a href=#Forces_Definition-arity_forcerel_fm>arity_forcerel_fm</a></li><li><a href=#Forces_Definition-forcerel_fm_type>forcerel_fm_type</a></li><li><a href=#Forces_Definition-sats_forcerel_fm>sats_forcerel_fm</a></li><li><a href=#Forces_Definition-frc_at_fm_type>frc_at_fm_type</a></li><li><a href=#Forces_Definition-arity_frc_at_fm>arity_frc_at_fm</a></li><li><a href=#Forces_Definition-sats_frc_at_fm>sats_frc_at_fm</a></li><li><a href=#Forces_Definition-forces_eq_fm_type>forces_eq_fm_type</a></li><li><a href=#Forces_Definition-forces_mem_fm_type>forces_mem_fm_type</a></li><li><a href=#Forces_Definition-forces_neq_fm_type>forces_neq_fm_type</a></li><li><a href=#Forces_Definition-forces_nmem_fm_type>forces_nmem_fm_type</a></li><li><a href=#Forces_Definition-arity_forces_eq_fm>arity_forces_eq_fm</a></li><li><a href=#Forces_Definition-arity_forces_mem_fm>arity_forces_mem_fm</a></li><li><a href=#Forces_Definition-sats_forces_eq%27_fm>sats_forces_eq'_fm</a></li><li><a href=#Forces_Definition-sats_forces_mem%27_fm>sats_forces_mem'_fm</a></li><li><a href=#Forces_Definition-sats_forces_neq%27_fm>sats_forces_neq'_fm</a></li><li><a href=#Forces_Definition-sats_forces_nmem%27_fm>sats_forces_nmem'_fm</a></li><li><a href=#Forces_Definition-fst_abs>fst_abs</a></li><li><a href=#Forces_Definition-snd_abs>snd_abs</a></li><li><a href=#Forces_Definition-ftype_abs>ftype_abs</a></li><li><a href=#Forces_Definition-name1_abs>name1_abs</a></li><li><a href=#Forces_Definition-snd_snd_abs>snd_snd_abs</a></li><li><a href=#Forces_Definition-name2_abs>name2_abs</a></li><li><a href=#Forces_Definition-cond_of_abs>cond_of_abs</a></li><li><a href=#Forces_Definition-tuple_abs>tuple_abs</a></li><li><a href=#Forces_Definition-oneN_in_M>oneN_in_M</a></li><li><a href=#Forces_Definition-twoN_in_M>twoN_in_M</a></li><li><a href=#Forces_Definition-comp_in_M>comp_in_M</a></li><li><a href=#Forces_Definition-eq_case_abs>eq_case_abs</a></li><li><a href=#Forces_Definition-mem_case_abs>mem_case_abs</a></li><li><a href=#Forces_Definition-Hfrc_abs>Hfrc_abs</a></li><li><a href=#Forces_Definition-Hfrc_at_abs>Hfrc_at_abs</a></li><li><a href=#Forces_Definition-components_closed>components_closed</a></li><li><a href=#Forces_Definition-ecloseN_closed>ecloseN_closed</a></li><li><a href=#Forces_Definition-is_eclose_n_abs>is_eclose_n_abs</a></li><li><a href=#Forces_Definition-is_ecloseN_abs>is_ecloseN_abs</a></li><li><a href=#Forces_Definition-frecR_abs>frecR_abs</a></li><li><a href=#Forces_Definition-frecrelP_abs>frecrelP_abs</a></li><li><a href=#Forces_Definition-frecrel_abs>frecrel_abs</a></li><li><a href=#Forces_Definition-frecrel_closed>frecrel_closed</a></li><li><a href=#Forces_Definition-field_frecrel>field_frecrel</a></li><li><a href=#Forces_Definition-forcerelD>forcerelD</a></li><li><a href=#Forces_Definition-wf_forcerel>wf_forcerel</a></li><li><a href=#Forces_Definition-restrict_trancl_forcerel>restrict_trancl_forcerel</a></li><li><a href=#Forces_Definition-names_belowI>names_belowI</a></li><li><a href=#Forces_Definition-names_below_tr>names_below_tr</a></li><li><a href=#Forces_Definition-arg_into_names_below2>arg_into_names_below2</a></li><li><a href=#Forces_Definition-arg_into_names_below>arg_into_names_below</a></li><li><a href=#Forces_Definition-forcerel_arg_into_names_below>forcerel_arg_into_names_below</a></li><li><a href=#Forces_Definition-names_below_mono>names_below_mono</a></li><li><a href=#Forces_Definition-frecrel_mono>frecrel_mono</a></li><li><a href=#Forces_Definition-forcerel_mono2>forcerel_mono2</a></li><li><a href=#Forces_Definition-forcerel_mono_aux>forcerel_mono_aux</a></li><li><a href=#Forces_Definition-forcerel_mono>forcerel_mono</a></li><li><a href=#Forces_Definition-aux>aux</a></li><li><a href=#Forces_Definition-forcerel_eq>forcerel_eq</a></li><li><a href=#Forces_Definition-forcerel_below_aux>forcerel_below_aux</a></li><li><a href=#Forces_Definition-forcerel_below>forcerel_below</a></li><li><a href=#Forces_Definition-relation_forcerel>relation_forcerel</a></li><li><a href=#Forces_Definition-Hfrc_restrict_trancl>Hfrc_restrict_trancl</a></li><li><a href=#Forces_Definition-frc_at_trancl>frc_at_trancl</a></li><li><a href=#Forces_Definition-forcerelI1>forcerelI1</a></li><li><a href=#Forces_Definition-forcerelI2>forcerelI2</a></li><li><a href=#Forces_Definition-forcerelI3>forcerelI3</a></li><li><a href=#Forces_Definition-aux_def_frc_at>aux_def_frc_at</a></li><li><a href=#Forces_Definition-def_frc_at>def_frc_at</a></li><li><a href=#Forces_Definition-trans_forcerel_t>trans_forcerel_t</a></li><li><a href=#Forces_Definition-relation_forcerel_t>relation_forcerel_t</a></li><li><a href=#Forces_Definition-forcerel_in_M>forcerel_in_M</a></li><li><a href=#Forces_Definition-relation2_Hfrc_at_abs>relation2_Hfrc_at_abs</a></li><li><a href=#Forces_Definition-Hfrc_at_closed>Hfrc_at_closed</a></li><li><a href=#Forces_Definition-wfrec_Hfrc_at>wfrec_Hfrc_at</a></li><li><a href=#Forces_Definition-names_below_abs>names_below_abs</a></li><li><a href=#Forces_Definition-names_below_closed>names_below_closed</a></li><li><a href=#Forces_Definition-forcerel_abs>forcerel_abs</a></li><li><a href=#Forces_Definition-frc_at_abs>frc_at_abs</a></li><li><a href=#Forces_Definition-forces_eq%27_abs>forces_eq'_abs</a></li><li><a href=#Forces_Definition-forces_mem%27_abs>forces_mem'_abs</a></li><li><a href=#Forces_Definition-forces_neq%27_abs>forces_neq'_abs</a></li><li><a href=#Forces_Definition-forces_nmem%27_abs>forces_nmem'_abs</a></li><li><a href=#Forces_Definition-ren_forces_nand_type>ren_forces_nand_type</a></li><li><a href=#Forces_Definition-arity_ren_forces_nand>arity_ren_forces_nand</a></li><li><a href=#Forces_Definition-sats_ren_forces_nand>sats_ren_forces_nand</a></li><li><a href=#Forces_Definition-arity_ren_forces_all>arity_ren_forces_all</a></li><li><a href=#Forces_Definition-ren_forces_forall_type>ren_forces_forall_type</a></li><li><a href=#Forces_Definition-sats_ren_forces_forall>sats_ren_forces_forall</a></li><li><a href=#Forces_Definition-arity_leq_fm>arity_leq_fm</a></li><li><a href=#Forces_Definition-leq_fm_type>leq_fm_type</a></li><li><a href=#Forces_Definition-sats_leq_fm>sats_leq_fm</a></li><li><a href=#Forces_Definition-forces%27_type>forces'_type</a></li><li><a href=#Forces_Definition-forces_type>forces_type</a></li><li><a href=#Forces_Definition-def_forces_eq>def_forces_eq</a></li><li><a href=#Forces_Definition-def_forces_mem>def_forces_mem</a></li><li><a href=#Forces_Definition-forces_eq_abs>forces_eq_abs</a></li><li><a href=#Forces_Definition-forces_mem_abs>forces_mem_abs</a></li><li><a href=#Forces_Definition-sats_forces_eq_fm>sats_forces_eq_fm</a></li><li><a href=#Forces_Definition-sats_forces_mem_fm>sats_forces_mem_fm</a></li><li><a href=#Forces_Definition-forces_neq>forces_neq</a></li><li><a href=#Forces_Definition-forces_nmem>forces_nmem</a></li><li><a href=#Forces_Definition-sats_forces_Member>sats_forces_Member</a></li><li><a href=#Forces_Definition-sats_forces_Equal>sats_forces_Equal</a></li><li><a href=#Forces_Definition-sats_forces_Nand>sats_forces_Nand</a></li><li><a href=#Forces_Definition-sats_forces_Neg>sats_forces_Neg</a></li><li><a href=#Forces_Definition-sats_forces_Forall>sats_forces_Forall</a></li><li><a href=#Forces_Definition-arity_forces_at>arity_forces_at</a></li><li><a href=#Forces_Definition-arity_forces%27>arity_forces'</a></li><li><a href=#Forces_Definition-arity_forces>arity_forces</a></li><li><a href=#Forces_Definition-arity_forces_le>arity_forces_le</a></li></ul></li><li><a href=#Forcing_Theorems>Forcing_Theorems</a><ul><li><a href=#Forcing_Theorems-Collect_forces>Collect_forces</a></li><li><a href=#Forcing_Theorems-forces_mem_iff_dense_below>forces_mem_iff_dense_below</a></li><li><a href=#Forcing_Theorems-strengthening_eq>strengthening_eq</a></li><li><a href=#Forcing_Theorems-strengthening_mem>strengthening_mem</a></li><li><a href=#Forcing_Theorems-density_mem>density_mem</a></li><li><a href=#Forcing_Theorems-aux_density_eq>aux_density_eq</a></li><li><a href=#Forcing_Theorems-density_eq>density_eq</a></li><li><a href=#Forcing_Theorems-not_forces_neq>not_forces_neq</a></li><li><a href=#Forcing_Theorems-not_forces_nmem>not_forces_nmem</a></li><li><a href=#Forcing_Theorems-sats_forces_Nand%27>sats_forces_Nand'</a></li><li><a href=#Forcing_Theorems-sats_forces_Neg%27>sats_forces_Neg'</a></li><li><a href=#Forcing_Theorems-sats_forces_Forall%27>sats_forces_Forall'</a></li><li><a href=#Forcing_Theorems-Forces_Equal>Forces_Equal</a></li><li><a href=#Forcing_Theorems-Forces_Member>Forces_Member</a></li><li><a href=#Forcing_Theorems-Forces_Neg>Forces_Neg</a></li><li><a href=#Forcing_Theorems-Forces_Nand>Forces_Nand</a></li><li><a href=#Forcing_Theorems-Forces_And_aux>Forces_And_aux</a></li><li><a href=#Forcing_Theorems-Forces_And_iff_dense_below>Forces_And_iff_dense_below</a></li><li><a href=#Forcing_Theorems-Forces_Forall>Forces_Forall</a></li><li><a href=#Forcing_Theorems-elem_of_valI>elem_of_valI</a></li><li><a href=#Forcing_Theorems-GenExtD>GenExtD</a></li><li><a href=#Forcing_Theorems-left_in_M>left_in_M</a></li><li><a href=#Forcing_Theorems-generic_inter_dense_below>generic_inter_dense_below</a></li><li><a href=#Forcing_Theorems-IV240a_mem_Collect>IV240a_mem_Collect</a></li><li><a href=#Forcing_Theorems-IV240a_mem>IV240a_mem</a></li><li><a href=#Forcing_Theorems-refl_forces_eq>refl_forces_eq</a></li><li><a href=#Forcing_Theorems-forces_memI>forces_memI</a></li><li><a href=#Forcing_Theorems-IV240a_eq_1st_incl>IV240a_eq_1st_incl</a></li><li><a href=#Forcing_Theorems-IV240a_eq_2nd_incl>IV240a_eq_2nd_incl</a></li><li><a href=#Forcing_Theorems-IV240a_eq>IV240a_eq</a></li><li><a href=#Forcing_Theorems-core_induction>core_induction</a></li><li><a href=#Forcing_Theorems-forces_induction_with_conds>forces_induction_with_conds</a></li><li><a href=#Forcing_Theorems-forces_induction>forces_induction</a></li><li><a href=#Forcing_Theorems-IV240a>IV240a</a></li><li><a href=#Forcing_Theorems-IV240b_mem>IV240b_mem</a></li><li><a href=#Forcing_Theorems-Collect_forces_eq_in_M>Collect_forces_eq_in_M</a></li><li><a href=#Forcing_Theorems-IV240b_eq_Collects>IV240b_eq_Collects</a></li><li><a href=#Forcing_Theorems-IV240b_eq>IV240b_eq</a></li><li><a href=#Forcing_Theorems-IV240b>IV240b</a></li><li><a href=#Forcing_Theorems-map_val_in_MG>map_val_in_MG</a></li><li><a href=#Forcing_Theorems-truth_lemma_mem>truth_lemma_mem</a></li><li><a href=#Forcing_Theorems-truth_lemma_eq>truth_lemma_eq</a></li><li><a href=#Forcing_Theorems-arities_at_aux>arities_at_aux</a></li><li><a href=#Forcing_Theorems-strengthening_lemma>strengthening_lemma</a></li><li><a href=#Forcing_Theorems-arity_Nand_le>arity_Nand_le</a></li><li><a href=#Forcing_Theorems-dense_below_imp_forces>dense_below_imp_forces</a></li><li><a href=#Forcing_Theorems-density_lemma>density_lemma</a></li><li><a href=#Forcing_Theorems-Forces_And>Forces_And</a></li><li><a href=#Forcing_Theorems-Forces_Nand_alt>Forces_Nand_alt</a></li><li><a href=#Forcing_Theorems-truth_lemma_Neg>truth_lemma_Neg</a></li><li><a href=#Forcing_Theorems-truth_lemma_And>truth_lemma_And</a></li><li><a href=#Forcing_Theorems-ren_truth_lemma_type>ren_truth_lemma_type</a></li><li><a href=#Forcing_Theorems-arity_ren_truth>arity_ren_truth</a></li><li><a href=#Forcing_Theorems-sats_ren_truth_lemma>sats_ren_truth_lemma</a></li><li><a href=#Forcing_Theorems-truth_lemma%27>truth_lemma'</a></li><li><a href=#Forcing_Theorems-truth_lemma>truth_lemma</a></li><li><a href=#Forcing_Theorems-definition_of_forcing>definition_of_forcing</a></li></ul></li><li><a href=#Separation_Rename>Separation_Rename</a><ul><li><a href=#Separation_Rename-nth_concat>nth_concat</a></li><li><a href=#Separation_Rename-nth_concat2>nth_concat2</a></li><li><a href=#Separation_Rename-nth_concat3>nth_concat3</a></li><li><a href=#Separation_Rename-weakD>weakD</a></li><li><a href=#Separation_Rename-weak_equal>weak_equal</a></li><li><a href=#Separation_Rename-weak_zero>weak_zero</a></li><li><a href=#Separation_Rename-weakening_diff>weakening_diff</a></li><li><a href=#Separation_Rename-in_add_del>in_add_del</a></li><li><a href=#Separation_Rename-sep_env_action>sep_env_action</a></li><li><a href=#Separation_Rename-sep_env_type>sep_env_type</a></li><li><a href=#Separation_Rename-sep_var_fin_type>sep_var_fin_type</a></li><li><a href=#Separation_Rename-sep_var_domain>sep_var_domain</a></li><li><a href=#Separation_Rename-sep_var_type>sep_var_type</a></li><li><a href=#Separation_Rename-sep_var_action>sep_var_action</a></li><li><a href=#Separation_Rename-rensep_aux>rensep_aux</a></li><li><a href=#Separation_Rename-rensep_type>rensep_type</a></li><li><a href=#Separation_Rename-rensep_action>rensep_action</a></li><li><a href=#Separation_Rename-arity_rensep>arity_rensep</a></li><li><a href=#Separation_Rename-type_rensep>type_rensep</a></li><li><a href=#Separation_Rename-sepren_action>sepren_action</a></li></ul></li><li><a href=#Separation_Axiom>Separation_Axiom</a><ul><li><a href=#Separation_Axiom-map_val>map_val</a></li><li><a href=#Separation_Axiom-Collect_sats_in_MG>Collect_sats_in_MG</a></li></ul></li><li><a href=#Pairing_Axiom>Pairing_Axiom</a><ul><li><a href=#Pairing_Axiom-val_Upair>val_Upair</a></li><li><a href=#Pairing_Axiom-pairing_in_MG>pairing_in_MG</a></li></ul></li><li><a href=#Union_Axiom>Union_Axiom</a><ul><li><a href=#Union_Axiom-Union_name_fm_type>Union_name_fm_type</a></li><li><a href=#Union_Axiom-arity_Union_name_fm>arity_Union_name_fm</a></li><li><a href=#Union_Axiom-sats_Union_name_fm>sats_Union_name_fm</a></li><li><a href=#Union_Axiom-domD>domD</a></li><li><a href=#Union_Axiom-Union_name_M>Union_name_M</a></li><li><a href=#Union_Axiom-Union_MG_Eq>Union_MG_Eq</a></li><li><a href=#Union_Axiom-union_in_MG>union_in_MG</a></li></ul></li><li><a href=#Powerset_Axiom>Powerset_Axiom</a><ul><li><a href=#Powerset_Axiom-Collect_inter_Transset>Collect_inter_Transset</a></li><li><a href=#Powerset_Axiom-name_components_in_M>name_components_in_M</a></li><li><a href=#Powerset_Axiom-sats_fst_snd_in_M>sats_fst_snd_in_M</a></li><li><a href=#Powerset_Axiom-Pow_inter_MG>Pow_inter_MG</a></li></ul></li><li><a href=#Extensionality_Axiom>Extensionality_Axiom</a><ul><li><a href=#Extensionality_Axiom-extensionality_in_MG>extensionality_in_MG</a></li></ul></li><li><a href=#Foundation_Axiom>Foundation_Axiom</a><ul><li><a href=#Foundation_Axiom-foundation_in_MG>foundation_in_MG</a></li></ul></li><li><a href=#Least>Least</a><ul><li><a href=#Least-Least_Ord>Least_Ord</a></li><li><a href=#Least-Ord_Least_cong>Ord_Least_cong</a></li><li><a href=#Least-least_fm_type>least_fm_type</a></li><li><a href=#Least-sats_least_fm>sats_least_fm</a></li><li><a href=#Least-least_iff_sats>least_iff_sats</a></li><li><a href=#Least-least_conj>least_conj</a></li><li><a href=#Least-least_abs>least_abs</a></li><li><a href=#Least-Least_closed>Least_closed</a></li></ul></li><li><a href=#Replacement_Axiom>Replacement_Axiom</a><ul><li><a href=#Replacement_Axiom-renrep_type>renrep_type</a></li><li><a href=#Replacement_Axiom-arity_renrep>arity_renrep</a></li><li><a href=#Replacement_Axiom-renrep_sats>renrep_sats</a></li><li><a href=#Replacement_Axiom-renpbdy_type>renpbdy_type</a></li><li><a href=#Replacement_Axiom-arity_renpbdy>arity_renpbdy</a></li><li><a href=#Replacement_Axiom-sats_renpbdy>sats_renpbdy</a></li><li><a href=#Replacement_Axiom-renbody_type>renbody_type</a></li><li><a href=#Replacement_Axiom-arity_renbody>arity_renbody</a></li><li><a href=#Replacement_Axiom-sats_renbody>sats_renbody</a></li><li><a href=#Replacement_Axiom-pow_inter_M>pow_inter_M</a></li><li><a href=#Replacement_Axiom-prebody_fm_type>prebody_fm_type</a></li><li><a href=#Replacement_Axiom-sats_prebody_fm>sats_prebody_fm</a></li><li><a href=#Replacement_Axiom-arity_prebody_fm>arity_prebody_fm</a></li><li><a href=#Replacement_Axiom-body_fm%27_type>body_fm'_type</a></li><li><a href=#Replacement_Axiom-arity_body_fm%27>arity_body_fm'</a></li><li><a href=#Replacement_Axiom-sats_body_fm%27>sats_body_fm'</a></li><li><a href=#Replacement_Axiom-body_fm_type>body_fm_type</a></li><li><a href=#Replacement_Axiom-sats_body_fm>sats_body_fm</a></li><li><a href=#Replacement_Axiom-sats_renpbdy_prebody_fm>sats_renpbdy_prebody_fm</a></li><li><a href=#Replacement_Axiom-body_lemma>body_lemma</a></li><li><a href=#Replacement_Axiom-Replace_sats_in_MG>Replace_sats_in_MG</a></li></ul></li><li><a href=#Infinity_Axiom>Infinity_Axiom</a><ul><li><a href=#Infinity_Axiom-infinity_in_MG>infinity_in_MG</a></li></ul></li><li><a href=#Choice_Axiom>Choice_Axiom</a><ul><li><a href=#Choice_Axiom-domain_induced_surj>domain_induced_surj</a></li><li><a href=#Choice_Axiom-range_restrict_vimage>range_restrict_vimage</a></li><li><a href=#Choice_Axiom-induced_surj_type>induced_surj_type</a></li><li><a href=#Choice_Axiom-induced_surj_is_surj>induced_surj_is_surj</a></li><li><a href=#Choice_Axiom-upair_name_abs>upair_name_abs</a></li><li><a href=#Choice_Axiom-upair_name_closed>upair_name_closed</a></li><li><a href=#Choice_Axiom-upair_name_fm_type>upair_name_fm_type</a></li><li><a href=#Choice_Axiom-sats_upair_name_fm>sats_upair_name_fm</a></li><li><a href=#Choice_Axiom-opair_name_abs>opair_name_abs</a></li><li><a href=#Choice_Axiom-opair_name_closed>opair_name_closed</a></li><li><a href=#Choice_Axiom-opair_name_fm_type>opair_name_fm_type</a></li><li><a href=#Choice_Axiom-sats_opair_name_fm>sats_opair_name_fm</a></li><li><a href=#Choice_Axiom-val_upair_name>val_upair_name</a></li><li><a href=#Choice_Axiom-val_opair_name>val_opair_name</a></li><li><a href=#Choice_Axiom-val_RepFun_one>val_RepFun_one</a></li><li><a href=#Choice_Axiom-opname_check_fm_type>opname_check_fm_type</a></li><li><a href=#Choice_Axiom-sats_opname_check_fm>sats_opname_check_fm</a></li><li><a href=#Choice_Axiom-opname_check_abs>opname_check_abs</a></li><li><a href=#Choice_Axiom-repl_opname_check>repl_opname_check</a></li></ul></li><li><a href=#Ordinals_In_MG>Ordinals_In_MG</a><ul><li><a href=#Ordinals_In_MG-rank_val>rank_val</a></li><li><a href=#Ordinals_In_MG-Ord_MG_iff>Ord_MG_iff</a></li></ul></li><li><a href=#Proper_Extension>Proper_Extension</a><ul><li><a href=#Proper_Extension-filter_complement_dense>filter_complement_dense</a></li><li><a href=#Proper_Extension-generic_not_in_M>generic_not_in_M</a></li></ul></li><li><a href=#Succession_Poset>Succession_Poset</a><ul><li><a href=#Succession_Poset-seqspaceI>seqspaceI</a></li><li><a href=#Succession_Poset-seqspaceD>seqspaceD</a></li><li><a href=#Succession_Poset-seqspace_type>seqspace_type</a></li><li><a href=#Succession_Poset-seqspace_closed>seqspace_closed</a></li><li><a href=#Succession_Poset-seq_upd_succ_type>seq_upd_succ_type</a></li><li><a href=#Succession_Poset-seq_upd_type>seq_upd_type</a></li><li><a href=#Succession_Poset-seq_upd_apply_domain>seq_upd_apply_domain</a></li><li><a href=#Succession_Poset-zero_in_seqspace>zero_in_seqspace</a></li><li><a href=#Succession_Poset-seqleI>seqleI</a></li><li><a href=#Succession_Poset-seqleD>seqleD</a></li><li><a href=#Succession_Poset-upd_leI>upd_leI</a></li><li><a href=#Succession_Poset-preorder_on_seqle>preorder_on_seqle</a></li><li><a href=#Succession_Poset-zero_seqle_max>zero_seqle_max</a></li><li><a href=#Succession_Poset-seqspace_separative>seqspace_separative</a></li><li><a href=#Succession_Poset-type_seqleR_fm>type_seqleR_fm</a></li><li><a href=#Succession_Poset-arity_seqleR_fm>arity_seqleR_fm</a></li><li><a href=#Succession_Poset-Rrel_eq>Rrel_eq</a></li><li><a href=#Succession_Poset-Rrel_closed>Rrel_closed</a></li><li><a href=#Succession_Poset-seqle_in_M>seqle_in_M</a></li><li><a href=#Succession_Poset-cohen_extension_is_proper>cohen_extension_is_proper</a></li></ul></li><li><a href=#Forcing_Main>Forcing_Main</a><ul><li><a href=#Forcing_Main-well_ord_imp_min>well_ord_imp_min</a></li><li><a href=#Forcing_Main-well_ord_surj_imp_lepoll>well_ord_surj_imp_lepoll</a></li></ul></li></ul></div><ul><li><a href=https://www.isa-afp.org/browser_info/current/AFP/Forcing/outline.pdf>Proof
outline</a></li><li><a href=https://www.isa-afp.org/browser_info/current/AFP/Forcing/document.pdf>Proof
document</a></li><li><a href=https://www.isa-afp.org/browser_info/current/AFP/Forcing/session_graph.pdf>Theory dependencies</a></li></ul></div></aside><div class="content theories"><header><form action=/%20search><div class=form-container><input id=searchInput type=search size=31 maxlength=255 aria-label="Search the AFP" list=autocomplete><button id=searchButton type=button><img src=/images/search.svg alt=Search></button>
<datalist id=autocomplete></datalist></div></form><h1><span class=first>S</span>ession <span class=first>F</span>orcing</h1><div></div></header><div id=banner data-id=0><p>This is an unofficial reimagining of the <a href=https://isa-afp.org target=_blank rel="noreferrer noopener">Archive of Formal Proofs</a></p><button style=display:none id=close title=close><svg viewBox="0 0 6.718 6.718" aria-hidden="true" focusable="false"><rect transform="rotate(45)" x="4" y="-4" width="1.5" height="8"/><rect transform="rotate(45)" x=".75" y="-.75" width="8" height="1.5"/></svg></button></div><div><main><div id=Utils><div class=head><h1>Theory Utils</h1></div><pre class=source><span class=keyword1><span class=command>theory</span></span> Utils
  <span class=keyword2><span class=keyword>imports</span></span> <span class=quoted>"<a href=../../ZF/ZF-Constructible/Formula.html>ZF-Constructible.Formula</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>ML_file</span></span> <span class=quoted>‹utils.ML›</span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=files/utils.ML><div class=head><h1>File ‹utils.ML›</h1></div><pre class=source><span class=keyword1><span class=keyword>signature</span></span> <span class=entity>UTILS</span> <span class=main>=</span>
 <span class=keyword2><span class=keyword>sig</span></span>
    <span class=keyword1><span class=keyword>val</span></span> binop <span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> add_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> app_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> concat_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> dest_apply<span class=main>:</span> term <span class=main>-&gt;</span> term * term
    <span class=keyword1><span class=keyword>val</span></span> dest_iff_lhs<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> dest_iff_rhs<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> dest_iff_tms<span class=main>:</span> term <span class=main>-&gt;</span> term * term
    <span class=keyword1><span class=keyword>val</span></span> dest_lhs_def<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> dest_rhs_def<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> dest_satisfies_tms<span class=main>:</span> term <span class=main>-&gt;</span> term * term
    <span class=keyword1><span class=keyword>val</span></span> dest_satisfies_frm<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> dest_eq_tms<span class=main>:</span> term <span class=main>-&gt;</span> term * term
    <span class=keyword1><span class=keyword>val</span></span> dest_sats_frm<span class=main>:</span> term <span class=main>-&gt;</span> <span class=main>(</span>term * term<span class=main>)</span> * term
    <span class=keyword1><span class=keyword>val</span></span> dest_trueprop<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> eq_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> fix_vars<span class=main>:</span> thm <span class=main>-&gt;</span> string list <span class=main>-&gt;</span> <span class=entity>Proof.context</span> <span class=main>-&gt;</span> thm
    <span class=keyword1><span class=keyword>val</span></span> formula_<span class=main>:</span> term
    <span class=keyword1><span class=keyword>val</span></span> freeName<span class=main>:</span> term <span class=main>-&gt;</span> string
    <span class=keyword1><span class=keyword>val</span></span> inList<span class=main>:</span> ''a <span class=main>-&gt;</span> ''a list <span class=main>-&gt;</span> bool
    <span class=keyword1><span class=keyword>val</span></span> isFree<span class=main>:</span> term <span class=main>-&gt;</span> bool
    <span class=keyword1><span class=keyword>val</span></span> length_<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> list_<span class=main>:</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> lt_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> mem_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> mk_FinSet<span class=main>:</span> term list <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> mk_Pair<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> mk_ZFlist<span class=main>:</span> <span class=main>(</span>'a <span class=main>-&gt;</span> term<span class=main>)</span> <span class=main>-&gt;</span> 'a list <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> mk_ZFnat<span class=main>:</span> int <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> nat_<span class=main>:</span> term
    <span class=keyword1><span class=keyword>val</span></span> nth_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> subset_<span class=main>:</span> term <span class=main>-&gt;</span> term <span class=main>-&gt;</span> term
    <span class=keyword1><span class=keyword>val</span></span> thm_concl_tm <span class=main>:</span>  <span class=entity>Proof.context</span> <span class=main>-&gt;</span> xstring <span class=main>-&gt;</span> 
        <span class=main>(</span><span class=main>(</span>indexname * typ<span class=main>)</span> * cterm<span class=main>)</span> list * term * <span class=entity>Proof.context</span>
    <span class=keyword1><span class=keyword>val</span></span> to_ML_list<span class=main>:</span> term <span class=main>-&gt;</span> term list
    <span class=keyword1><span class=keyword>val</span></span> tp<span class=main>:</span> term <span class=main>-&gt;</span> term
  <span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>structure</span></span> <span class=entity>Utils</span> <span class=main>:</span> <span class=entity>UTILS</span> <span class=main>=</span>
<span class=keyword2><span class=keyword>struct</span></span> 
<span class=comment1>(* Smart constructors for ZF-terms *)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>inList</span> <span class=entity>a</span> <span class=main>=</span> exists <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=entity>b</span> <span class=main>=&gt;</span> <span class=entity>a</span> <span class=main>=</span> <span class=entity>b</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>binop</span> <span class=entity>h</span> <span class=entity>t</span> <span class=entity>u</span> <span class=main>=</span> <span class=entity>h</span> $ <span class=entity>t</span> $ <span class=entity>u</span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>mk_Pair</span>  <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Pair<span class=antiquote>}</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>mk_FinSet</span> nil <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> zero<span class=antiquote>}</span></span>
  <span class=main>|</span> <span class=entity>mk_FinSet</span> <span class=main>(</span><span class=entity>e</span> :: <span class=entity>es</span><span class=main>)</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> cons<span class=antiquote>}</span></span> $ <span class=entity>e</span> $ <span class=entity>mk_FinSet</span> <span class=entity>es</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>mk_ZFnat</span> <span class=inner_numeral>0</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> zero<span class=antiquote>}</span></span>
  <span class=main>|</span> <span class=entity>mk_ZFnat</span> <span class=entity>n</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> succ<span class=antiquote>}</span></span> $ <span class=entity>mk_ZFnat</span> <span class=main>(</span><span class=entity>n</span>-<span class=inner_numeral>1</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>mk_ZFlist</span> <span class=main>_</span> nil <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> "Nil"<span class=antiquote>}</span></span>
  <span class=main>|</span> <span class=entity>mk_ZFlist</span> <span class=entity>f</span> <span class=main>(</span><span class=entity>t</span> :: <span class=entity>ts</span><span class=main>)</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> "Cons"<span class=antiquote>}</span></span> $ <span class=entity>f</span> <span class=entity>t</span> $ <span class=entity>mk_ZFlist</span> <span class=entity>f</span> <span class=entity>ts</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>to_ML_list</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Nil<span class=antiquote>}</span></span><span class=main>)</span> <span class=main>=</span> nil
  <span class=main>|</span> <span class=entity>to_ML_list</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Cons<span class=antiquote>}</span></span> $ <span class=entity>t</span> $ <span class=entity>ts</span><span class=main>)</span> <span class=main>=</span> <span class=entity>t</span> :: <span class=entity>to_ML_list</span> <span class=entity>ts</span>
<span class=main>|</span>   <span class=entity>to_ML_list</span> <span class=main>_</span> <span class=main>=</span> nil

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>isFree</span> <span class=main>(</span>Free <span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> true
  <span class=main>|</span> <span class=entity>isFree</span> <span class=main>_</span> <span class=main>=</span> false

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>freeName</span> <span class=main>(</span>Free <span class=main>(</span><span class=entity>n</span><span class=main>,</span><span class=main>_</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=entity>n</span>
  <span class=main>|</span> <span class=entity>freeName</span> <span class=main>_</span> <span class=main>=</span> error <span class=inner_quoted>"Not a free variable"</span>

<span class=keyword1><span class=keyword>val</span></span> <span class=entity>app_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> apply<span class=antiquote>}</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>tp</span> <span class=entity>x</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Trueprop<span class=antiquote>}</span></span> $ <span class=entity>x</span>
<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>length_</span> <span class=entity>env</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> length<span class=antiquote>}</span></span> $ <span class=entity>env</span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>nth_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> nth<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>add_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> add<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>mem_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> mem<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>subset_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Subset<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>lt_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> lt<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>concat_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> app<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>eq_</span> <span class=main>=</span> <span class=entity>binop</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> IFOL.eq<span class=main>(</span><span class=quoted>i</span><span class=main>)</span><span class=antiquote>}</span></span>

<span class=comment1>(* Abbreviation for sets *)</span>
<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>list_</span> <span class=entity>set</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> list<span class=antiquote>}</span></span> $ <span class=entity>set</span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>nat_</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> nat<span class=antiquote>}</span></span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>formula_</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> formula<span class=antiquote>}</span></span>

<span class=comment1>(** Destructors of terms **)</span>
<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_eq_tms</span> <span class=main>(</span>Const <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const_name</span> IFOL.eq<span class=antiquote>}</span></span><span class=main>,</span><span class=main>_</span><span class=main>)</span> $ <span class=entity>t</span> $ <span class=entity>u</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=entity>t</span><span class=main>,</span> <span class=entity>u</span><span class=main>)</span>
  <span class=main>|</span> <span class=entity>dest_eq_tms</span> <span class=entity>t</span> <span class=main>=</span> <span class=keyword3><span class=keyword>raise</span></span> TERM <span class=main>(</span><span class=inner_quoted>"dest_eq_tms"</span><span class=main>,</span> <span class=main>[</span><span class=entity>t</span><span class=main>]</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_lhs_def</span> <span class=main>(</span>Const <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const_name</span> Pure.eq<span class=antiquote>}</span></span><span class=main>,</span><span class=main>_</span><span class=main>)</span> $ <span class=entity>x</span> $ <span class=main>_</span><span class=main>)</span> <span class=main>=</span> <span class=entity>x</span>
  <span class=main>|</span> <span class=entity>dest_lhs_def</span> <span class=entity>t</span> <span class=main>=</span> <span class=keyword3><span class=keyword>raise</span></span> TERM <span class=main>(</span><span class=inner_quoted>"dest_lhs_def"</span><span class=main>,</span> <span class=main>[</span><span class=entity>t</span><span class=main>]</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_rhs_def</span> <span class=main>(</span>Const <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const_name</span> Pure.eq<span class=antiquote>}</span></span><span class=main>,</span><span class=main>_</span><span class=main>)</span> $ <span class=main>_</span> $ <span class=entity>y</span><span class=main>)</span> <span class=main>=</span> <span class=entity>y</span>
  <span class=main>|</span> <span class=entity>dest_rhs_def</span> <span class=entity>t</span> <span class=main>=</span> <span class=keyword3><span class=keyword>raise</span></span> TERM <span class=main>(</span><span class=inner_quoted>"dest_rhs_def"</span><span class=main>,</span> <span class=main>[</span><span class=entity>t</span><span class=main>]</span><span class=main>)</span>


<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_apply</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> apply<span class=antiquote>}</span></span> $ <span class=entity>t</span> $ <span class=entity>u</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=entity>t</span><span class=main>,</span><span class=entity>u</span><span class=main>)</span>
  <span class=main>|</span> <span class=entity>dest_apply</span> <span class=entity>t</span> <span class=main>=</span> <span class=keyword3><span class=keyword>raise</span></span> TERM <span class=main>(</span><span class=inner_quoted>"dest_applies_op"</span><span class=main>,</span> <span class=main>[</span><span class=entity>t</span><span class=main>]</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_satisfies_tms</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Formula.satisfies<span class=antiquote>}</span></span> $ <span class=entity>A</span> $ <span class=entity>f</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=entity>A</span><span class=main>,</span><span class=entity>f</span><span class=main>)</span>
  <span class=main>|</span> <span class=entity>dest_satisfies_tms</span> <span class=entity>t</span> <span class=main>=</span> <span class=keyword3><span class=keyword>raise</span></span> TERM <span class=main>(</span><span class=inner_quoted>"dest_satisfies_tms"</span><span class=main>,</span> <span class=main>[</span><span class=entity>t</span><span class=main>]</span><span class=main>)</span><span class=main>;</span>

<span class=keyword1><span class=keyword>val</span></span> <span class=entity>dest_satisfies_frm</span> <span class=main>=</span> <span class=main>#</span><span class=inner_numeral>2</span> o <span class=entity>dest_satisfies_tms</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_sats_frm</span> <span class=entity>t</span> <span class=main>=</span> <span class=entity>t</span> |&gt; <span class=entity>dest_eq_tms</span> |&gt; <span class=main>#</span><span class=inner_numeral>1</span> |&gt; <span class=entity>dest_apply</span> |&gt;&gt; <span class=entity>dest_satisfies_tms</span> <span class=main>;</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_trueprop</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> IFOL.Trueprop<span class=antiquote>}</span></span> $ <span class=entity>t</span><span class=main>)</span> <span class=main>=</span> <span class=entity>t</span>
  <span class=main>|</span> <span class=entity>dest_trueprop</span> <span class=entity>t</span> <span class=main>=</span> <span class=entity>t</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>dest_iff_tms</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> IFOL.iff<span class=antiquote>}</span></span> $ <span class=entity>t</span> $ <span class=entity>u</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=entity>t</span><span class=main>,</span> <span class=entity>u</span><span class=main>)</span>
  <span class=main>|</span> <span class=entity>dest_iff_tms</span> <span class=entity>t</span> <span class=main>=</span> <span class=keyword3><span class=keyword>raise</span></span> TERM <span class=main>(</span><span class=inner_quoted>"dest_iff_tms"</span><span class=main>,</span> <span class=main>[</span><span class=entity>t</span><span class=main>]</span><span class=main>)</span>

<span class=keyword1><span class=keyword>val</span></span> <span class=entity>dest_iff_lhs</span> <span class=main>=</span> <span class=main>#</span><span class=inner_numeral>1</span> o <span class=entity>dest_iff_tms</span>
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>dest_iff_rhs</span> <span class=main>=</span> <span class=main>#</span><span class=inner_numeral>2</span> o <span class=entity>dest_iff_tms</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>thm_concl_tm</span> <span class=entity>ctxt</span> <span class=entity>thm_ref</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=entity>vars</span><span class=main>)</span><span class=main>,</span><span class=entity>thm_tms</span><span class=main>)</span><span class=main>,</span><span class=entity>ctxt1</span><span class=main>)</span> <span class=main>=</span> Variable.import true <span class=main>[</span>Proof_Context.get_thm <span class=entity>ctxt</span> <span class=entity>thm_ref</span><span class=main>]</span> <span class=entity>ctxt</span>
  <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span><span class=entity>vars</span><span class=main>,</span> <span class=entity>thm_tms</span> |&gt; hd |&gt; Thm.concl_of<span class=main>,</span> <span class=entity>ctxt1</span><span class=main>)</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>fix_vars</span> <span class=entity>thm</span> <span class=entity>vars</span> <span class=entity>ctxt</span> <span class=main>=</span> <span class=keyword2><span class=keyword>let</span></span>
  <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>_</span><span class=main>,</span> <span class=entity>ctxt1</span><span class=main>)</span> <span class=main>=</span> Variable.add_fixes <span class=entity>vars</span> <span class=entity>ctxt</span>
  <span class=keyword2><span class=keyword>in</span></span> singleton <span class=main>(</span>Proof_Context.export <span class=entity>ctxt1</span> <span class=entity>ctxt</span><span class=main>)</span> <span class=entity>thm</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=main>;</span>
</pre></div><div id=Forcing_Notions><div class=head><h1>Theory Forcing_Notions</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Forcing notions›</span></span>
<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹This theory defines a locale for forcing notions, that is,
 preorders with a distinguished maximum element.›</span></span>

<span class=keyword1><span class=command>theory</span></span> Forcing_Notions
  <span class=keyword2><span class=keyword>imports</span></span> <span class=quoted>"<a href=../../ZF/ZF-Constructible/Relative.html>ZF-Constructible.Relative</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Basic concepts›</span></span>
<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We say that two elements $p,q$ are
  <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator>∗</span></span>‹compatible›</span></span> if they have a lower bound in $P$›</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>compat_in</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>compat_in</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>d</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>d</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>r</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_compat_in</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_compat_in</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>d</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=bound>d</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>dp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>d</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>dp</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>dp</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> 
                                   <span class=main>(</span><span class=main>∃</span><span class=bound>dq</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>d</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=bound>dq</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>dq</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-compat_inI><span class=command>lemma</span></span> compat_inI <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>d</span><span class=main>∈</span><span class=free>A</span> <span class=main>;</span> <span class=main>⟨</span><span class=free>d</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>r</span> <span class=main>;</span> <span class=main>⟨</span><span class=free>d</span><span class=main>,</span><span class=free>g</span><span class=main>⟩</span><span class=main>∈</span><span class=free>r</span> <span class=main>⟧</span> <span class=main>⟹</span> compat_in<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>g</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> compat_in_def<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-refl_compat><span class=command>lemma</span></span> refl_compat<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> refl<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>;</span> <span class=main>⟨</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>|</span> <span class=free>p</span><span class=main>=</span><span class=free>q</span> <span class=main>|</span> <span class=main>⟨</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>;</span> <span class=free>p</span><span class=main>∈</span><span class=free>A</span> <span class=main>;</span> <span class=free>q</span><span class=main>∈</span><span class=free>A</span><span class=main>⟧</span> <span class=main>⟹</span> compat_in<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> refl_def compat_inI<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-chain_compat><span class=command>lemma</span></span>  chain_compat<span class=main>:</span>
  <span class=quoted><span class=quoted>"refl<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> linear<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span>  <span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> compat_in<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> refl_compat linear_def<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-subset_fun_image><span class=command>lemma</span></span> subset_fun_image<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>:</span><span class=free>N</span><span class=main>→</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>f</span><span class=main>``</span><span class=free>N</span><span class=main>⊆</span><span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> image_fun apply_funtype<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-refl_monot_domain><span class=command>lemma</span></span> refl_monot_domain<span class=main>:</span> <span class=quoted><span class=quoted>"refl<span class=main>(</span><span class=free>B</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>A</span><span class=main>⊆</span><span class=free>B</span> <span class=main>⟹</span> refl<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span>"</span></span>  
  <span class=keyword1><span class=command>unfolding</span></span> refl_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>antichain</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>antichain</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>⊆</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span><span class=main>(</span><span class=main>¬</span> compat_in<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>ccc</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ccc</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>A</span><span class=main>.</span> antichain<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=bound>A</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>|</span><span class=bound>A</span><span class=main>|</span> <span class=main>≤</span> nat"</span></span>

<span class=keyword1><span class=command>locale</span></span> forcing_notion <span class=main>=</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>leq</span> <span class=free>one</span>
  <span class=keyword2><span class=keyword>assumes</span></span> one_in_P<span class=main>:</span>         <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> leq_preord<span class=main>:</span>       <span class=quoted><span class=quoted>"preorder_on<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> one_max<span class=main>:</span>          <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>p</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>∈</span><span class=free>leq</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>Leq</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>≼</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main><span class=free>≼</span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>≡</span> <span class=main>⟨</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free>leq</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-refl_leq><span class=command>lemma</span></span> refl_leq<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>r</span><span class=main>≼</span><span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> leq_preord <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def refl_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹A set $D$ is <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator>∗</span></span>‹dense›</span></span> if every element $p\in P$ has a lower 
bound in $D$.›</span></span>
<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>dense</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dense</span><span class=main>(</span><span class=free><span class=bound><span class=entity>D</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>D</span></span></span> <span class=main>.</span> <span class=bound>d</span><span class=main>≼</span><span class=bound>p</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹There is also a weaker definition which asks for 
a lower bound in $D$ only for the elements below some fixed 
element $q$.›</span></span>
<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>dense_below</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dense_below</span><span class=main>(</span><span class=free><span class=bound><span class=entity>D</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>p</span><span class=main>≼</span><span class=free><span class=bound><span class=entity>q</span></span></span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>D</span></span></span><span class=main>.</span> <span class=bound>d</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>d</span><span class=main>≼</span><span class=bound>p</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-P_dense><span class=command>lemma</span></span> P_dense<span class=main>:</span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=free>P</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> leq_preord<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> preorder_on_def refl_def dense_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>increasing</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>increasing</span><span class=main>(</span><span class=free><span class=bound><span class=entity>F</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>F</span></span></span><span class=main>.</span> <span class=main>∀</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=bound>x</span><span class=main>≼</span><span class=bound>p</span> <span class=main>⟶</span> <span class=bound>p</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>F</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>compat</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>compat</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span> <span class=main>≡</span> compat_in<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-leq_transD><span class=command>lemma</span></span> leq_transD<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>≼</span><span class=free>b</span> <span class=main>⟹</span> <span class=free>b</span><span class=main>≼</span><span class=free>c</span> <span class=main>⟹</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>P</span><span class=main>⟹</span> <span class=free>b</span> <span class=main>∈</span> <span class=free>P</span><span class=main>⟹</span> <span class=free>c</span> <span class=main>∈</span> <span class=free>P</span><span class=main>⟹</span> <span class=free>a</span><span class=main>≼</span><span class=free>c</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> leq_preord trans_onD <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id="Forcing_Notions-leq_transD'"><span class=command>lemma</span></span> leq_transD'<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>⊆</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>a</span><span class=main>≼</span><span class=free>b</span> <span class=main>⟹</span> <span class=free>b</span><span class=main>≼</span><span class=free>c</span> <span class=main>⟹</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>b</span> <span class=main>∈</span> <span class=free>P</span><span class=main>⟹</span> <span class=free>c</span> <span class=main>∈</span> <span class=free>P</span><span class=main>⟹</span> <span class=free>a</span><span class=main>≼</span><span class=free>c</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> leq_preord trans_onD subsetD <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=Forcing_Notions-leq_reflI><span class=command>lemma</span></span> leq_reflI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>≼</span><span class=free>p</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> leq_preord <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def refl_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-compatD><span class=command>lemma</span></span> compatD<span class=main>[</span><span class=operator>dest</span><span class=main><span class=main><span class=main>!</span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"compat<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>d</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> <span class=bound>d</span><span class=main>≼</span><span class=free>q</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> compat_def compat_in_def <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>Incompatible</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⊥</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main><span class=free>⊥</span></span> <span class=free><span class=bound><span class=entity>q</span></span></span> <span class=main>≡</span> <span class=main>¬</span> compat<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-compatI><span class=command>lemma</span></span> compatI<span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main>!</span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>d</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>d</span><span class=main>≼</span><span class=free>p</span> <span class=main>⟹</span> <span class=free>d</span><span class=main>≼</span><span class=free>q</span> <span class=main>⟹</span> compat<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> compat_def compat_in_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-denseD><span class=command>lemma</span></span> denseD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=free>D</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span>  <span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>D</span><span class=main>.</span> <span class=bound>d</span><span class=main>≼</span> <span class=free>p</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> dense_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-denseI><span class=command>lemma</span></span> denseI <span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main>!</span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=main>⋀</span><span class=bound>p</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>D</span><span class=main>.</span> <span class=bound>d</span><span class=main>≼</span> <span class=bound>p</span> <span class=main>⟧</span> <span class=main>⟹</span> dense<span class=main>(</span><span class=free>D</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> dense_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-dense_belowD><span class=command>lemma</span></span> dense_belowD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>≼</span><span class=free>p</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>D</span><span class=main>.</span> <span class=bound>d</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>d</span><span class=main>≼</span><span class=free>q</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> dense_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=comment1>(*obtains d where "d∈D" "d∈P" "d≼q"
  using assms unfolding dense_below_def by blast *)</span>

<span class=keyword1 id=Forcing_Notions-dense_belowI><span class=command>lemma</span></span> dense_belowI <span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main>!</span></span></span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>D</span><span class=main>.</span> <span class=bound>d</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>d</span><span class=main>≼</span><span class=bound>q</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> dense_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Notions-dense_below_cong><span class=command>lemma</span></span> dense_below_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>D</span> <span class=main>=</span> <span class=free>D'</span> <span class=main>⟹</span> dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟷</span> dense_below<span class=main>(</span><span class=free>D'</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id="Forcing_Notions-dense_below_cong'"><span class=command>lemma</span></span> dense_below_cong'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>Q'</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> 
           dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>q</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟷</span> dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=free>Q'</span><span class=main>(</span><span class=bound>q</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-dense_below_mono><span class=command>lemma</span></span> dense_below_mono<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>D</span> <span class=main>⊆</span> <span class=free>D'</span> <span class=main>⟹</span> dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟹</span> dense_below<span class=main>(</span><span class=free>D'</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-dense_below_under><span class=command>lemma</span></span> dense_below_under<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>≼</span><span class=free>p</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms leq_transD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-ideal_dense_below><span class=command>lemma</span></span> ideal_dense_below<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>∈</span><span class=free>D</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-dense_below_dense_below><span class=command>lemma</span></span> dense_below_dense_below<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>  
  <span class=keyword1><span class=command>using</span></span> assms leq_transD leq_reflI  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=comment1>(* Long proof *)</span>
    <span class=comment1>(*  unfolding dense_below_def
proof (intro ballI impI)
  fix r
  assume "r∈P" ‹r≼p›
  with assms
  obtain q where "q∈P" "q≼r" "dense_below(D,q)"
    using assms by auto
  moreover from this
  obtain d where "d∈P" "d≼q" "d∈D"
    using assms leq_preord unfolding preorder_on_def refl_def by blast
  moreover
  note ‹r∈P›
  ultimately
  show "∃d∈D. d ∈ P ∧ d≼ r"
    using leq_preord trans_onD unfolding preorder_on_def by blast
qed *)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>antichain</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>antichain</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>⊆</span><span class=free>P</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span><span class=main>(</span><span class=main>¬</span>compat<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹A filter is an increasing set $G$ with all its elements 
being compatible in $G$.›</span></span>
<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>filter</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>filter</span><span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>⊆</span><span class=free>P</span> <span class=main>∧</span> increasing<span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>.</span> compat_in<span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-filterD><span class=command>lemma</span></span> filterD <span class=main>:</span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span> <span class=main><span class=main>:</span></span> subsetD filter_def<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-filter_leqD><span class=command>lemma</span></span> filter_leqD <span class=main>:</span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=free>x</span><span class=main>≼</span><span class=free>y</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>G</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> filter_def increasing_def<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-filter_imp_compat><span class=command>lemma</span></span> filter_imp_compat<span class=main>:</span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> compat<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> filter_def compat_in_def compat_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Notions-low_bound_filter><span class=command>lemma</span></span> low_bound_filter<span class=main>:</span> <span class=comment1>― ‹says the compatibility is attained inside G›</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>G</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>r</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> <span class=bound>r</span><span class=main>≼</span><span class=free>q</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>unfolding</span></span> compat_in_def filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We finally introduce the upward closure of a set
and prove that the closure of $A$ is a filter if its elements are
compatible in $A$.›</span></span>
<span class=keyword1><span class=command>definition</span></span>  
  <span class=entity>upclosure</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>upclosure</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span><span class=main>∃</span><span class=bound>a</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span> <span class=bound>a</span><span class=main>≼</span><span class=bound>p</span><span class=main>}</span>"</span></span>

<span class=keyword1 id=Forcing_Notions-upclosureI><span class=command>lemma</span></span>  upclosureI <span class=main>[</span><span class=operator>intro</span><span class=main>]</span> <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>a</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>a</span><span class=main>≼</span><span class=free>p</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>upclosure_def<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-upclosureE><span class=command>lemma</span></span>  upclosureE <span class=main>[</span><span class=operator>elim</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>⋀</span><span class=bound>x</span> <span class=bound>a</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>a</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=bound>a</span><span class=main>≼</span><span class=bound>x</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>R</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>upclosure_def<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-upclosureD><span class=command>lemma</span></span>  upclosureD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span><span class=main>(</span><span class=bound>a</span><span class=main>≼</span><span class=free>p</span><span class=main>)</span> <span class=main>∧</span> <span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>upclosure_def<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-upclosure_increasing><span class=command>lemma</span></span> upclosure_increasing <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>⊆</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"increasing<span class=main>(</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> increasing_def upclosure_def
  <span class=keyword1><span class=command>using</span></span> leq_transD'<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>⊆</span><span class=free>P</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forcing_Notions-upclosure_in_P><span class=command>lemma</span></span>  upclosure_in_P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>⊆</span> <span class=free>P</span> <span class=main>⟹</span> upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> subsetI upclosure_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Notions-A_sub_upclosure><span class=command>lemma</span></span>  A_sub_upclosure<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>⊆</span> <span class=free>P</span> <span class=main>⟹</span> <span class=free>A</span><span class=main>⊆</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> subsetI leq_preord 
  <span class=keyword1><span class=command>unfolding</span></span> upclosure_def preorder_on_def refl_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forcing_Notions-elem_upclosure><span class=command>lemma</span></span>  elem_upclosure<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>⊆</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>x</span><span class=main>∈</span><span class=free>A</span>  <span class=main>⟹</span> <span class=free>x</span><span class=main>∈</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>A_sub_upclosure<span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-closure_compat_filter><span class=command>lemma</span></span>  closure_compat_filter<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>⊆</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> compat_in<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> filter_def
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"increasing<span class=main>(</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms upclosure_increasing <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?UA</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"compat_in<span class=main>(</span>upclosure<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=skolem>p</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=var>?UA</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=var>?UA</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span> <span class=skolem>q</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> that
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>≼</span><span class=skolem>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> upclosureD<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=var>?UA</span>›</span></span><span class=main>]</span> upclosureD<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=var>?UA</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>d</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>≼</span><span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>≼</span><span class=skolem>b</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> compat_in_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> 1
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>≼</span><span class=skolem>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=var>?UA</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> A_sub_upclosure<span class=main>[</span><span class=operator>THEN</span> subsetD<span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>⊆</span><span class=free>P</span>›</span></span>
        leq_transD'<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=skolem>d</span></span> <span class=quoted><span class=skolem>a</span></span><span class=main>]</span> leq_transD'<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=skolem>d</span></span> <span class=quoted><span class=skolem>b</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> compat_in_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Notions-aux_RS1><span class=command>lemma</span></span>  aux_RS1<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>N</span> <span class=main>→</span> <span class=free>P</span> <span class=main>⟹</span> <span class=free>n</span><span class=main>∈</span><span class=free>N</span> <span class=main>⟹</span> <span class=free>f</span><span class=main>`</span><span class=free>n</span> <span class=main>∈</span> upclosure<span class=main>(</span><span class=free>f</span> <span class=main>``</span><span class=free>N</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> elem_upclosure<span class=main>[</span><span class=operator>OF</span> subset_fun_image<span class=main>]</span> image_fun
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span><span class=main>)</span>

<span class=keyword1 id=Forcing_Notions-decr_succ_decr><span class=command>lemma</span></span> decr_succ_decr<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> nat <span class=main>→</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"preorder_on<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span>  <span class=main>⟨</span><span class=free>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>,</span> <span class=free>f</span> <span class=main>`</span> <span class=bound>n</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>n</span><span class=main>≤</span><span class=free>m</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>f</span> <span class=main>`</span> <span class=free>m</span><span class=main>,</span> <span class=free>f</span> <span class=main>`</span> <span class=free>n</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span><span class=main>_</span>›</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>m</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> assms leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>succ <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>≼</span> <span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=free>n</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>&lt;</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=main>|</span> <span class=main>(</span>eq<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>=</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> succ le_succ_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> lt
    <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leI succ leq_transD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> eq
    <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Notions-decr_seq_linear><span class=command>lemma</span></span> decr_seq_linear<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"refl<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> nat <span class=main>→</span> <span class=free>P</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span>  <span class=main>⟨</span><span class=free>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>,</span> <span class=free>f</span> <span class=main>`</span> <span class=bound>n</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=keyword1>trans[</span><span class=free>P</span><span class=main>](</span><span class=free>leq</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"linear<span class=main>(</span><span class=free>f</span> <span class=main>``</span> nat<span class=main>,</span> <span class=free>leq</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"preorder_on<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span> <span class=skolem>m</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>m</span> <span class=main>≼</span> <span class=free>f</span><span class=main>`</span><span class=skolem>n</span> <span class=main>∨</span> <span class=free>f</span><span class=main>`</span><span class=skolem>n</span> <span class=main>≼</span> <span class=free>f</span><span class=main>`</span><span class=skolem>m</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>≤</span><span class=skolem>n</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>m</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> decr_succ_decr<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span> assms leI <span class=quoted><span class=quoted>‹preorder_on<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>m</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> decr_succ_decr<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=skolem>m</span></span> <span class=quoted><span class=skolem>n</span></span><span class=main>]</span> assms leI not_le_iff_lt <span class=quoted><span class=quoted>‹preorder_on<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> linear_def <span class=keyword1><span class=command>using</span></span> ball_image_simp assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_notion *)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Towards Rasiowa-Sikorski Lemma (RSL)›</span></span>
<span class=keyword1><span class=command>locale</span></span> countable_generic <span class=main>=</span> forcing_notion <span class=main>+</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>𝒟</span>
  <span class=keyword2><span class=keyword>assumes</span></span> countable_subs_of_P<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>𝒟</span> <span class=main>∈</span> nat<span class=main>→</span>Pow<span class=main>(</span><span class=free>P</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>     seq_of_denses<span class=main>:</span>        <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span> <span class=main>∈</span> nat<span class=main>.</span> dense<span class=main>(</span><span class=free>𝒟</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>D_generic</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>D_generic</span><span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span> <span class=main>≡</span> filter<span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span><span class=main>(</span><span class=free>𝒟</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span><span class=main>∩</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>≠</span><span class=main>0</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The next lemma identifies a sufficient condition for obtaining
RSL.›</span></span>
<span class=keyword1 id=Forcing_Notions-RS_sequence_imp_rasiowa_sikorski><span class=command>lemma</span></span> RS_sequence_imp_rasiowa_sikorski<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>:</span> nat<span class=main>→</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>`</span> <span class=main>0</span> <span class=main>=</span> <span class=free>p</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>n</span><span class=main>.</span> <span class=bound>n</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>≼</span> <span class=free>f</span> <span class=main>`</span> <span class=bound>n</span> <span class=main>∧</span> <span class=free>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=bound>n</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>G</span><span class=main>.</span> <span class=free>p</span><span class=main>∈</span><span class=bound>G</span> <span class=main>∧</span> D_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>``</span>nat  <span class=main>⊆</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>subset_fun_image<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"refl<span class=main>(</span><span class=free>f</span><span class=main>``</span>nat<span class=main>,</span> <span class=free>leq</span><span class=main>)</span> <span class=main>∧</span> <span class=keyword1>trans[</span><span class=free>P</span><span class=main>](</span><span class=free>leq</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> leq_preord <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>refl_monot_domain<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span>  <span class=free>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>≼</span> <span class=free>f</span> <span class=main>`</span> <span class=bound>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"linear<span class=main>(</span><span class=free>f</span><span class=main>``</span>nat<span class=main>,</span> <span class=free>leq</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> leq_preord <span class=keyword2><span class=keyword>and</span></span> decr_seq_linear <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>f</span><span class=main>``</span>nat<span class=main>.</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>f</span><span class=main>``</span>nat<span class=main>.</span> compat_in<span class=main>(</span><span class=free>f</span><span class=main>``</span>nat<span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span>             
    <span class=keyword1><span class=command>using</span></span> chain_compat <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>  
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span>upclosure<span class=main>(</span><span class=free>f</span><span class=main>``</span>nat<span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=var>?G</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> closure_compat_filter <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=bound>n</span> <span class=main>∩</span> <span class=var>?G</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>with</span></span> assms 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?G</span> <span class=main>∧</span> <span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=skolem>n</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> aux_RS1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>𝒟</span> <span class=main>`</span> <span class=skolem>n</span> <span class=main>∩</span> <span class=var>?G</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> <span class=var>?G</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> aux_RS1 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> D_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* countable_generic *)</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Now, the following recursive definition will fulfill the 
requirements of lemma <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>RS_sequence_imp_rasiowa_sikorski</span></span>›</span></span></span></span> ›</span></span>

<span class=keyword1><span class=command>consts</span></span> RS_seq <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span>
<span class=keyword1><span class=command>primrec</span></span>
  <span class=quoted><span class=quoted>"RS_seq<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span>
  <span class=quoted><span class=quoted>"RS_seq<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span> <span class=main>=</span> 
    <span class=free>enum</span><span class=main>`</span><span class=main>(</span><span class=keyword1>μ</span> <span class=bound>m</span><span class=main>.</span> <span class=main>⟨</span><span class=free>enum</span><span class=main>`</span><span class=bound>m</span><span class=main>,</span> RS_seq<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span> <span class=main>∧</span> <span class=free>enum</span><span class=main>`</span><span class=bound>m</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=free>n</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>context</span></span> countable_generic
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Forcing_Notions-preimage_rangeD><span class=command>lemma</span></span> preimage_rangeD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>Pi<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span> <span class=main>∈</span> range<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>f</span><span class=main>`</span><span class=bound>a</span> <span class=main>=</span> <span class=free>b</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms apply_equality<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>b</span></span><span class=main>]</span> domain_type<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forcing_Notions-countable_RS_sequence_aux><span class=command>lemma</span></span> countable_RS_sequence_aux<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>enum</span>
  <span class=keyword2><span class=keyword>defines</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≡</span> RS_seq<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>   <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>k</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=main>≡</span> <span class=free>enum</span><span class=main>`</span><span class=free>m</span><span class=main>≼</span> <span class=free>q</span> <span class=main>∧</span> <span class=free>enum</span><span class=main>`</span><span class=free>m</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=free>k</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>⊆</span> range<span class=main>(</span><span class=free>enum</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>:</span>nat<span class=main>→</span><span class=free>M</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>k</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>k</span><span class=main>∈</span>nat <span class=main>⟹</span>  <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span> <span class=bound>x</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=bound>k</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=free>f</span><span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span><span class=main>≼</span> <span class=free>f</span><span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∧</span> <span class=free>f</span><span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=main>0</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>P</span> <span class=main>⊆</span> range<span class=main>(</span><span class=free>enum</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>`</span><span class=skolem>m</span> <span class=main>=</span> <span class=skolem>q</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> preimage_rangeD<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>enum</span><span class=main>:</span>nat<span class=main>→</span><span class=free>M</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>𝒟</span><span class=main>`</span><span class=main>0</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> apply_funtype<span class=main>[</span><span class=operator>OF</span> countable_subs_of_P<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> LeastI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> Q_def f_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>succ <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> assms 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span> <span class=free>f</span><span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>P</span> <span class=main>⊆</span> range<span class=main>(</span><span class=free>enum</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>`</span><span class=skolem>m</span><span class=main>≼</span> <span class=free>f</span><span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>`</span><span class=skolem>m</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> preimage_rangeD<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>enum</span><span class=main>:</span>nat<span class=main>→</span><span class=free>M</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> succ
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>𝒟</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> apply_funtype<span class=main>[</span><span class=operator>OF</span> countable_subs_of_P<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> LeastI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>f</span><span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> Q_def f_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Notions-countable_RS_sequence><span class=command>lemma</span></span> countable_RS_sequence<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>enum</span>
  <span class=keyword2><span class=keyword>defines</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> RS_seq<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>   <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>k</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=main>≡</span> <span class=free>enum</span><span class=main>`</span><span class=free>m</span><span class=main>≼</span> <span class=free>q</span> <span class=main>∧</span> <span class=free>enum</span><span class=main>`</span><span class=free>m</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=free>k</span>"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>⊆</span> range<span class=main>(</span><span class=free>enum</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>:</span>nat<span class=main>→</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>≼</span> <span class=free>f</span><span class=main>`</span><span class=free>n</span> <span class=main>∧</span> <span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=free>p</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>k</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span> <span class=skolem>x</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=skolem>k</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> seq_of_denses apply_funtype<span class=main>[</span><span class=operator>OF</span> countable_subs_of_P<span class=main>]</span> 
      <span class=keyword1><span class=command>unfolding</span></span> dense_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>≼</span> <span class=free>f</span><span class=main>`</span><span class=free>n</span> <span class=main>∧</span> <span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>using</span></span> countable_RS_sequence_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Notions-RS_seq_type><span class=command>lemma</span></span> RS_seq_type<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>⊆</span> range<span class=main>(</span><span class=free>enum</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>:</span>nat<span class=main>→</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"RS_seq<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms countable_RS_sequence<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span>  
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span><span class=main><span class=keyword3>;</span></span><span class=operator>simp</span><span class=main>)</span> 

<span class=keyword1 id=Forcing_Notions-RS_seq_funtype><span class=command>lemma</span></span> RS_seq_funtype<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>⊆</span> range<span class=main>(</span><span class=free>enum</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>:</span>nat<span class=main>→</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> RS_seq<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>enum</span><span class=main>,</span><span class=free>𝒟</span><span class=main>)</span><span class=main>)</span><span class=main>:</span> nat <span class=main>→</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms lam_type RS_seq_type <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemmas</span></span> countable_rasiowa_sikorski <span class=main>=</span> 
  RS_sequence_imp_rasiowa_sikorski<span class=main>[</span><span class=operator>OF</span> _ RS_seq_funtype countable_RS_sequence<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* countable_generic *)</span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Pointed_DC><div class=head><h1>Theory Pointed_DC</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹A pointed version of DC›</span></span>
<span class=keyword1><span class=command>theory</span></span> Pointed_DC <span class=keyword2><span class=keyword>imports</span></span> <a href=../../ZF/ZF/AC.html>ZF.AC</a>

<span class=keyword2><span class=keyword>begin</span></span>
<span class=keyword1><span class=command>txt</span></span><span class=quoted><span class=plain_text>‹This proof of DC is from Moschovakis "Notes on Set Theory"›</span></span>

<span class=keyword1><span class=command>consts</span></span> dc_witness <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i <span class=main>⇒</span> i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span>
<span class=keyword1><span class=command>primrec</span></span>
  wit0   <span class=main>:</span> <span class=quoted><span class=quoted>"dc_witness<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>R</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span>"</span></span>
  witrec <span class=main>:</span><span class=quoted><span class=quoted>"dc_witness<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>R</span><span class=main>)</span> <span class=main>=</span> <span class=free>s</span><span class=main>`</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span>dc_witness<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>R</span><span class=main>)</span><span class=main>,</span><span class=bound>x</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span> <span class=main>}</span>"</span></span>

<span class=keyword1 id=Pointed_DC-witness_into_A><span class=command>lemma</span></span> witness_into_A <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>X</span> <span class=main>.</span> <span class=bound>X</span><span class=main>≠</span><span class=main>0</span> <span class=main>∧</span> <span class=bound>X</span><span class=main>⊆</span><span class=free>A</span> <span class=main>⟶</span> <span class=free>s</span><span class=main>`</span><span class=bound>X</span><span class=main>∈</span><span class=bound>X</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span> <span class=main>}</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dc_witness<span class=main>(</span><span class=free>n</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=free>A</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>succ <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Pointed_DC-witness_related><span class=command>lemma</span></span> witness_related <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>X</span> <span class=main>.</span> <span class=bound>X</span><span class=main>≠</span><span class=main>0</span> <span class=main>∧</span> <span class=bound>X</span><span class=main>⊆</span><span class=free>A</span> <span class=main>⟶</span> <span class=free>s</span><span class=main>`</span><span class=bound>X</span><span class=main>∈</span><span class=bound>X</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span> <span class=main>}</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span>dc_witness<span class=main>(</span><span class=free>n</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span><span class=main>,</span>dc_witness<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dc_witness<span class=main>(</span><span class=free>n</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>∈</span> <span class=free>A</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> witness_into_A<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>n</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Pointed_DC-witness_funtype><span class=command>lemma</span></span> witness_funtype<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>X</span> <span class=main>.</span> <span class=bound>X</span><span class=main>≠</span><span class=main>0</span> <span class=main>∧</span> <span class=bound>X</span><span class=main>⊆</span><span class=free>A</span> <span class=main>⟶</span> <span class=free>s</span><span class=main>`</span><span class=bound>X</span><span class=main>∈</span><span class=bound>X</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span> <span class=main>}</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> dc_witness<span class=main>(</span><span class=bound>n</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> nat <span class=main>→</span> <span class=free>A</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>∈</span> <span class=main>_</span> <span class=main>→</span> <span class=main>_</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>∈</span> nat <span class=main>→</span> <span class=main>{</span>dc_witness<span class=main>(</span><span class=bound>n</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span><span class=main>.</span> <span class=bound>n</span><span class=main>∈</span>nat<span class=main>}</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>∈</span> <span class=main>_</span> <span class=main>→</span> <span class=var>?B</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> lam_funtype assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> witness_into_A assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?f</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fun_weaken_type
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Pointed_DC-witness_to_fun><span class=command>lemma</span></span> witness_to_fun<span class=main>:</span>   <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>X</span> <span class=main>.</span> <span class=bound>X</span><span class=main>≠</span><span class=main>0</span> <span class=main>∧</span> <span class=bound>X</span><span class=main>⊆</span><span class=free>A</span> <span class=main>⟶</span> <span class=free>s</span><span class=main>`</span><span class=bound>X</span><span class=main>∈</span><span class=bound>X</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span> <span class=main>}</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>f</span> <span class=main>∈</span> nat<span class=main>→</span><span class=free>A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=bound>f</span><span class=main>`</span><span class=bound>n</span> <span class=main>=</span>dc_witness<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>R</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms bexI<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> dc_witness<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>R</span><span class=main>)</span>"</span></span><span class=main>]</span> witness_funtype
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>theorem</span></span> pointed_DC  <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span><span class=main>∈</span> <span class=free>R</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>f</span> <span class=main>∈</span> nat<span class=main>→</span><span class=free>A</span><span class=main>.</span> <span class=bound>f</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=bound>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>⟨</span><span class=bound>f</span><span class=main>`</span><span class=bound>n</span><span class=main>,</span><span class=bound>f</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 0<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span> <span class=bound>x</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span><span class=main>}</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> AC_func_Pow<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>g</span></span>
    <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>g</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>-</span> <span class=main>{</span><span class=main>0</span><span class=main>}</span> <span class=main>→</span> <span class=free>A</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>X</span><span class=main>.</span> <span class=bound>X</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>∧</span> <span class=bound>X</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟶</span> <span class=skolem>g</span> <span class=main>`</span> <span class=bound>X</span> <span class=main>∈</span> <span class=bound>X</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>a</span><span class=main>.</span><span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> dc_witness<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=bound>a</span><span class=main>,</span><span class=skolem>g</span><span class=main>,</span><span class=free>R</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=free>A</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> f0<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?f</span><span class=main>(</span><span class=skolem>a</span><span class=main>)</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=skolem>a</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=free>A</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=var>?f</span><span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>n</span><span class=main>,</span> <span class=var>?f</span><span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>`</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span>
      <span class=keyword1><span class=command>using</span></span> witness_related<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=free>A</span>›</span></span> 1<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> 0<span class=main>]</span> beta that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>f</span><span class=main>∈</span>nat <span class=main>→</span> <span class=free>A</span><span class=main>.</span> <span class=bound>f</span> <span class=main>`</span> <span class=main>0</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>⟨</span><span class=bound>f</span> <span class=main>`</span> <span class=bound>n</span><span class=main>,</span> <span class=bound>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=main>_</span> <span class=main>.</span><span class=var>?P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> f0 witness_funtype 0 1 <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Pointed_DC-aux_DC_on_AxNat2><span class=command>lemma</span></span> aux_DC_on_AxNat2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=main>⟨</span><span class=bound>y</span><span class=main>,</span>succ<span class=main>(</span>snd<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span> <span class=main>⟹</span>
                  <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>{</span><span class=main>⟨</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span><span class=main>.</span> snd<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span>snd<span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> ballI<span class=main><span class=keyword3>,</span></span> <span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>x</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> ballE<span class=main><span class=keyword3>,</span></span> <span class=operator>simp_all</span><span class=main>)</span>

<span class=keyword1 id=Pointed_DC-infer_snd><span class=command>lemma</span></span> infer_snd <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>c</span><span class=main>∈</span> <span class=free>A</span><span class=main>×</span><span class=free>B</span> <span class=main>⟹</span> snd<span class=main>(</span><span class=free>c</span><span class=main>)</span> <span class=main>=</span> <span class=free>k</span> <span class=main>⟹</span> <span class=free>c</span><span class=main>=</span><span class=main>⟨</span>fst<span class=main>(</span><span class=free>c</span><span class=main>)</span><span class=main>,</span><span class=free>k</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>corollary</span></span> DC_on_A_x_nat <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=main>⟨</span><span class=bound>y</span><span class=main>,</span>succ<span class=main>(</span>snd<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>f</span> <span class=main>∈</span> nat<span class=main>→</span><span class=free>A</span><span class=main>.</span> <span class=bound>f</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=free>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>⟨</span><span class=main>⟨</span><span class=bound>f</span><span class=main>`</span><span class=bound>n</span><span class=main>,</span><span class=bound>n</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=bound>f</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>⟩</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=main>_</span><span class=main>.</span><span class=var>?P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?R'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>⟨</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>⟩</span><span class=main>∈</span><span class=free>R</span><span class=main>.</span> snd<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span>snd<span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> aux_DC_on_AxNat2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=keyword2><span class=keyword>where</span></span>
    F<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span>nat<span class=main>→</span><span class=free>A</span><span class=main>×</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>`</span> <span class=main>0</span> <span class=main>=</span> <span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=main>0</span><span class=main>⟩</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>⟨</span><span class=skolem>f</span> <span class=main>`</span> <span class=bound>n</span><span class=main>,</span> <span class=skolem>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pointed_DC<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span>nat"</span></span> <span class=var><span class=quoted><span class=var>?R'</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>∈</span>nat<span class=main>.</span> fst<span class=main>(</span><span class=skolem>f</span><span class=main>`</span><span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> F
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span><span class=main>∈</span>nat<span class=main>→</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>`</span> <span class=main>0</span> <span class=main>=</span> <span class=free>a</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span> nat <span class=main>⟹</span> <span class=skolem>f</span><span class=main>`</span><span class=skolem>n</span><span class=main>=</span> <span class=main>⟨</span><span class=var>?f</span><span class=main>`</span><span class=skolem>n</span><span class=main>,</span> <span class=skolem>n</span><span class=main>⟩</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span>
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=skolem>n</span></span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>nat<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> 0
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> F <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>succ <span class=skolem>x</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span> <span class=skolem>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>A</span><span class=main>×</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat"</span></span>
      <span class=keyword1><span class=command>using</span></span> F <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"snd<span class=main>(</span><span class=skolem>f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span>snd<span class=main>(</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> succ <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> infer_snd<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>`</span>succ<span class=main>(</span><span class=main>_</span><span class=main>)</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>⟨</span><span class=var>?f</span><span class=main>`</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>n</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=var>?f</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span>
    <span class=keyword1><span class=command>using</span></span> that 1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span>"</span></span><span class=main>]</span> 1<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> F<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>`</span><span class=main>0</span><span class=main>=</span><span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=main>0</span><span class=main>⟩</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> rev_bexI<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?f</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Pointed_DC-aux_sequence_DC><span class=command>lemma</span></span> aux_sequence_DC <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>S</span><span class=main>`</span><span class=bound>n</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>=</span><span class=main>{</span><span class=main>⟨</span><span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>n</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>m</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>(</span><span class=free>A</span><span class=main>×</span>nat<span class=main>)</span><span class=main>×</span><span class=main>(</span><span class=free>A</span><span class=main>×</span>nat<span class=main>)</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span><span class=main>∈</span><span class=free>S</span><span class=main>`</span><span class=bound>m</span> <span class=main>}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat <span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=main>⟨</span><span class=bound>y</span><span class=main>,</span>succ<span class=main>(</span>snd<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>R</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms Pair_fst_snd_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Pointed_DC-aux_sequence_DC2><span class=command>lemma</span></span> aux_sequence_DC2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>S</span><span class=main>`</span><span class=bound>n</span> <span class=main>⟹</span>
        <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=main>⟨</span><span class=bound>y</span><span class=main>,</span>succ<span class=main>(</span>snd<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>{</span><span class=main>⟨</span><span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>n</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>m</span><span class=main>⟩</span><span class=main>⟩</span><span class=main>∈</span><span class=main>(</span><span class=free>A</span><span class=main>×</span>nat<span class=main>)</span><span class=main>×</span><span class=main>(</span><span class=free>A</span><span class=main>×</span>nat<span class=main>)</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span><span class=main>∈</span><span class=free>S</span><span class=main>`</span><span class=bound>m</span> <span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Pointed_DC-sequence_DC><span class=command>lemma</span></span> sequence_DC<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>S</span><span class=main>`</span><span class=bound>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>f</span> <span class=main>∈</span> nat<span class=main>→</span><span class=free>A</span><span class=main>.</span> <span class=bound>f</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=bound>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>⟨</span><span class=bound>f</span><span class=main>`</span><span class=bound>n</span><span class=main>,</span><span class=bound>f</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>⟩</span><span class=main>∈</span><span class=free>S</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> ballI<span class=main><span class=keyword3>,</span></span><span class=operator>insert</span> assms<span class=main><span class=keyword3>,</span></span><span class=operator>drule</span> aux_sequence_DC2<span class=main><span class=keyword3>,</span></span> <span class=operator>drule</span> DC_on_A_x_nat<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Rasiowa_Sikorski><div class=head><h1>Theory Rasiowa_Sikorski</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The general Rasiowa-Sikorski lemma›</span></span>
<span class=keyword1><span class=command>theory</span></span> Rasiowa_Sikorski <span class=keyword2><span class=keyword>imports</span></span> <a href=Forcing_Notions.html>Forcing_Notions</a> <a href=Pointed_DC.html>Pointed_DC</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> countable_generic
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Rasiowa_Sikorski-RS_relation><span class=command>lemma</span></span> RS_relation<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=free>p</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>(</span><span class=main>λ</span><span class=bound>m</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>{</span><span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span><span class=main>∈</span><span class=free>P</span><span class=main>×</span><span class=free>P</span><span class=main>.</span> <span class=bound>y</span><span class=main>≼</span><span class=bound>x</span> <span class=main>∧</span> <span class=bound>y</span><span class=main>∈</span><span class=free>𝒟</span><span class=main>`</span><span class=main>(</span>pred<span class=main>(</span><span class=bound>m</span><span class=main>)</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>n</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> seq_of_denses <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=free>𝒟</span> <span class=main>`</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>𝒟</span> <span class=main>`</span> Arith.pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>.</span> <span class=bound>d</span><span class=main>≼</span> <span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> dense_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>d</span></span> <span class=keyword2><span class=keyword>where</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> Arith.pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>d</span><span class=main>≼</span> <span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>from</span></span> countable_subs_of_P <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>𝒟</span> <span class=main>`</span> Arith.pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>P</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>apply_funtype <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>pred_type<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>𝒟</span> <span class=main>`</span> Arith.pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> PowD<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> 3
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=skolem>d</span><span class=main>≼</span> <span class=free>p</span> <span class=main>∧</span> <span class=skolem>d</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> Arith.pred<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Rasiowa_Sikorski-DC_imp_RS_sequence><span class=command>lemma</span></span> DC_imp_RS_sequence<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>f</span><span class=main>.</span> <span class=bound>f</span><span class=main>:</span> nat<span class=main>→</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>f</span> <span class=main>`</span> <span class=main>0</span> <span class=main>=</span> <span class=free>p</span> <span class=main>∧</span> 
     <span class=main>(</span><span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=bound>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>≼</span> <span class=bound>f</span> <span class=main>`</span> <span class=bound>n</span> <span class=main>∧</span> <span class=bound>f</span> <span class=main>`</span> succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>𝒟</span> <span class=main>`</span> <span class=bound>n</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>m</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>{</span><span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span><span class=main>∈</span><span class=free>P</span><span class=main>×</span><span class=free>P</span><span class=main>.</span> <span class=bound>y</span><span class=main>≼</span><span class=bound>x</span> <span class=main>∧</span> <span class=bound>y</span><span class=main>∈</span><span class=free>𝒟</span><span class=main>`</span><span class=main>(</span>pred<span class=main>(</span><span class=bound>m</span><span class=main>)</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?S</span><span class=main>`</span><span class=bound>n</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> RS_relation <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>f</span> <span class=main>∈</span> nat<span class=main>→</span><span class=free>P</span><span class=main>.</span> <span class=bound>f</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=bound>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>⟨</span><span class=bound>f</span><span class=main>`</span><span class=bound>n</span><span class=main>,</span><span class=bound>f</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?S</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sequence_DC <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>
  
<span class=keyword1><span class=command>theorem</span></span> rasiowa_sikorski<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>G</span><span class=main>.</span> <span class=free>p</span><span class=main>∈</span><span class=bound>G</span> <span class=main>∧</span> D_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> RS_sequence_imp_rasiowa_sikorski <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>DC_imp_RS_sequence<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* countable_generic *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Nat_Miscellanea><div class=head><h1>Theory Nat_Miscellanea</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Auxiliary results on arithmetic›</span></span>
<span class=keyword1><span class=command>theory</span></span> Nat_Miscellanea <span class=keyword2><span class=keyword>imports</span></span> <a href=../../ZF/ZF/ZF.html>ZF</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Most of these results will get used at some point for the
calculation of arities.›</span></span>
<span class=keyword1><span class=command>lemmas</span></span> nat_succI <span class=main>=</span>  Ord_succ_mem_iff <span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>,</span><span class=operator>OF</span> nat_into_Ord<span class=main>]</span>

<span class=keyword1 id=Nat_Miscellanea-nat_succD><span class=command>lemma</span></span> nat_succD <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span>  succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>n</span> <span class=main>∈</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>drule_tac</span> j<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> ltI<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span>ltD<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> zero_in <span class=main>=</span>  ltD <span class=main>[</span><span class=operator>OF</span> nat_0_le<span class=main>]</span>

<span class=keyword1 id=Nat_Miscellanea-in_n_in_nat><span class=command>lemma</span></span> in_n_in_nat <span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>n</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>⟹</span> <span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>drule</span> ltI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted><span class=quoted><span class=quoted>"<span class=free><span class=free><span class=free>n</span></span></span>"</span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lt_nat_in_nat<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-in_succ_in_nat><span class=command>lemma</span></span> in_succ_in_nat <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>n</span> <span class=main>∈</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>in_n_in_nat<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-ltI_neg><span class=command>lemma</span></span> ltI_neg <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>x</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>≠</span> <span class=free>x</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>&lt;</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> le_iff<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-succ_pred_eq><span class=command>lemma</span></span> succ_pred_eq  <span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>m</span> <span class=main>≠</span> <span class=main>0</span>  <span class=main>⟹</span> succ<span class=main>(</span>pred<span class=main>(</span><span class=free>m</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> natE<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-succ_ltI><span class=command>lemma</span></span> succ_ltI <span class=main>:</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>j</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> succ_leE<span class=main><span class=main>[</span></span><span class=operator>OF</span> leI<span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-succ_In><span class=command>lemma</span></span> succ_In <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> succ<span class=main>(</span><span class=free>j</span><span class=main>)</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>∈</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> succ_ltI<span class=main><span class=main>[</span></span><span class=operator>THEN</span> ltD<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> ltI<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> succ_leD <span class=main>=</span> succ_leE<span class=main>[</span><span class=operator>OF</span> leI<span class=main>]</span>

<span class=keyword1 id=Nat_Miscellanea-succpred_leI><span class=command>lemma</span></span> succpred_leI <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat <span class=main>⟹</span>  <span class=free>n</span> <span class=main>≤</span> succ<span class=main>(</span>pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> natE<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-succpred_n0><span class=command>lemma</span></span> succpred_n0 <span class=main>:</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>p</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>≠</span><span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>


<span class=keyword1 id=Nat_Miscellanea-funcI><span class=command>lemma</span></span> funcI <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>→</span> <span class=free>B</span> <span class=main>⟹</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>b</span><span class=main>=</span> <span class=free>f</span> <span class=main>`</span> <span class=free>a</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>a</span><span class=main>,</span> <span class=free>b</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>f</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> apply_Pair<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> natEin <span class=main>=</span> natE <span class=main>[</span><span class=operator>OF</span> lt_nat_in_nat<span class=main>]</span>

<span class=keyword1 id=Nat_Miscellanea-succ_in><span class=command>lemma</span></span> succ_in <span class=main>:</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>≤</span> <span class=free>y</span>  <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>ltD<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> Un_least_lt_iffn <span class=main>=</span>  Un_least_lt_iff <span class=main>[</span><span class=operator>OF</span> nat_into_Ord nat_into_Ord<span class=main>]</span>

<span class=keyword1 id=Nat_Miscellanea-pred_le2><span class=command>lemma</span></span> pred_le2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≤</span> <span class=free>m</span> <span class=main>⟹</span> <span class=free>n</span> <span class=main>≤</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>rule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-pred_le><span class=command>lemma</span></span> pred_le <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>n</span> <span class=main>≤</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span> <span class=main>⟹</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≤</span> <span class=free>m</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>∈</span>nat"</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>rule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-Un_leD1><span class=command>lemma</span></span> Un_leD1 <span class=main>:</span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>⟹</span> Ord<span class=main>(</span><span class=free>j</span><span class=main>)</span><span class=main>⟹</span> Ord<span class=main>(</span><span class=free>k</span><span class=main>)</span><span class=main>⟹</span>  <span class=free>i</span> <span class=main>∪</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>k</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>k</span>"</span></span>   
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> Un_least_lt_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>[</span></span><span class=operator>THEN</span> conjunct1<span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-Un_leD2><span class=command>lemma</span></span> Un_leD2 <span class=main>:</span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>⟹</span> Ord<span class=main>(</span><span class=free>j</span><span class=main>)</span><span class=main>⟹</span> Ord<span class=main>(</span><span class=free>k</span><span class=main>)</span><span class=main>⟹</span>  <span class=free>i</span> <span class=main>∪</span> <span class=free>j</span> <span class=main>≤</span><span class=free>k</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>≤</span> <span class=free>k</span>"</span></span>   
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> Un_least_lt_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>[</span></span><span class=operator>THEN</span> conjunct2<span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-gt1><span class=command>lemma</span></span> gt1 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>i</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≠</span> <span class=main>0</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>≠</span> <span class=main>1</span> <span class=main>⟹</span> <span class=main>1</span><span class=main>&lt;</span><span class=free>i</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=free>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>erule</span> in_n_in_nat<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Ord_0_lt<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-pred_mono><span class=command>lemma</span></span> pred_mono <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>n</span> <span class=main>≤</span> <span class=free>m</span> <span class=main>⟹</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≤</span> pred<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>le_in_nat<span class=main><span class=keyword3>,</span></span><span class=operator>erule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=free>m</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-succ_mono><span class=command>lemma</span></span> succ_mono <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>n</span> <span class=main>≤</span> <span class=free>m</span> <span class=main>⟹</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Nat_Miscellanea-pred2_Un><span class=command>lemma</span></span> pred2_Un<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>≤</span> <span class=free>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>≤</span> <span class=free>j</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span>pred<span class=main>(</span><span class=free>m</span> <span class=main>∪</span> <span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> pred<span class=main>(</span>pred<span class=main>(</span><span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms pred_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>j</span>"</span></span><span class=main>]</span> le_in_nat Un_least_lt pred_mono <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Nat_Miscellanea-nat_union_abs1><span class=command>lemma</span></span> nat_union_abs1 <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>;</span> Ord<span class=main>(</span><span class=free>j</span><span class=main>)</span> <span class=main>;</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>j</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>∪</span> <span class=free>j</span> <span class=main>=</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> Un_absorb1<span class=main><span class=keyword3>,</span></span><span class=operator>erule</span> le_imp_subset<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-nat_union_abs2><span class=command>lemma</span></span> nat_union_abs2 <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>;</span> Ord<span class=main>(</span><span class=free>j</span><span class=main>)</span> <span class=main>;</span> <span class=free>i</span> <span class=main>≤</span> <span class=free>j</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>j</span> <span class=main>∪</span> <span class=free>i</span> <span class=main>=</span> <span class=free>j</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> Un_absorb2<span class=main><span class=keyword3>,</span></span><span class=operator>erule</span> le_imp_subset<span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-nat_un_max><span class=command>lemma</span></span> nat_un_max <span class=main>:</span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>j</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>∪</span> <span class=free>j</span> <span class=main>=</span> max<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> max_def nat_union_abs1 not_lt_iff_le leI nat_union_abs2
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Nat_Miscellanea-nat_max_ty><span class=command>lemma</span></span> nat_max_ty <span class=main>:</span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟹</span>Ord<span class=main>(</span><span class=free>j</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span>max<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> max_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Nat_Miscellanea-le_not_lt_nat><span class=command>lemma</span></span> le_not_lt_nat <span class=main>:</span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span> <span class=free>p</span><span class=main>≤</span> <span class=free>q</span> <span class=main>⟹</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>p</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> ltE<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> not_le_iff_lt<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD1<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span><span class=operator>drule</span> ltI<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>q</span></span></span></span></span></span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>p</span></span></span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span><span class=operator>erule</span> leI<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> nat_simp_union <span class=main>=</span> nat_un_max nat_max_ty max_def 

<span class=keyword1 id=Nat_Miscellanea-le_succ><span class=command>lemma</span></span> le_succ <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>x</span><span class=main>≤</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1 id=Nat_Miscellanea-le_pred><span class=command>lemma</span></span> le_pred <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat <span class=main>⟹</span> pred<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>≤</span><span class=free>x</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> pred_le<span class=main>[</span><span class=operator>OF</span> _ _ le_succ<span class=main>]</span> pred_succ_eq 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Nat_Miscellanea-Un_le_compat><span class=command>lemma</span></span> Un_le_compat <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>o</span> <span class=main>≤</span> <span class=free>p</span> <span class=main>⟹</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>r</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>o</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>o</span> <span class=main>∪</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>p</span> <span class=main>∪</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>q</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∪</span><span class=free>r</span>"</span></span><span class=main>,</span><span class=operator>OF</span> _ Un_upper2_le<span class=main>]</span> le_trans<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>o</span></span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∪</span><span class=free>r</span>"</span></span><span class=main>,</span><span class=operator>OF</span> _ Un_upper1_le<span class=main>]</span>
    nat_simp_union 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Nat_Miscellanea-Un_le><span class=command>lemma</span></span> Un_le <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>≤</span> <span class=free>r</span> <span class=main>⟹</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>r</span> <span class=main>⟹</span>
               Ord<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> 
                <span class=free>p</span> <span class=main>∪</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Nat_Miscellanea-Un_leI3><span class=command>lemma</span></span> Un_leI3 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>o</span> <span class=main>≤</span> <span class=free>r</span> <span class=main>⟹</span> <span class=free>p</span> <span class=main>≤</span> <span class=free>r</span> <span class=main>⟹</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>r</span> <span class=main>⟹</span> 
                Ord<span class=main>(</span><span class=free>o</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>⟹</span> Ord<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> 
                <span class=free>o</span> <span class=main>∪</span> <span class=free>p</span> <span class=main>∪</span> <span class=free>q</span> <span class=main>≤</span> <span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Nat_Miscellanea-diff_mono><span class=command>lemma</span></span> diff_mono <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>≤</span><span class=free>m</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#-</span><span class=free>p</span> <span class=main>&lt;</span> <span class=free>n</span><span class=main>#-</span><span class=free>p</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#-</span><span class=free>p</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#-</span><span class=free>p</span> <span class=main>#+</span><span class=free>p</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> add_diff_inverse2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> less_diff_conv<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>#-</span> <span class=free>p</span>"</span></span><span class=main>,</span><span class=operator>THEN</span> iffD2<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Nat_Miscellanea-pred_Un><span class=command>lemma</span></span> pred_Un<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> nat <span class=main>⟹</span> Arith.pred<span class=main>(</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> <span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span> <span class=main>∪</span> Arith.pred<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> nat <span class=main>⟹</span> Arith.pred<span class=main>(</span><span class=free>x</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Arith.pred<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pred_Un_distrib pred_succ_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1 id=Nat_Miscellanea-le_natI><span class=command>lemma</span></span> le_natI <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>n</span> <span class=main>⟹</span> <span class=free>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>j</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>drule</span> ltD<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> in_n_in_nat<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> nat_succ_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>,</span></span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>n</span></span></span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-le_natE><span class=command>lemma</span></span> le_natE <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>j</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span>  <span class=free>j</span><span class=main>∈</span><span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ltE<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>j</span></span></span></span></span></span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>n</span></span></span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Nat_Miscellanea-diff_cancel><span class=command>lemma</span></span> diff_cancel <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#-</span><span class=free>n</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms diff_is_0_lemma leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Nat_Miscellanea-leD><span class=command>lemma</span></span> leD <span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>|</span> <span class=free>j</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> leE<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>≤</span><span class=free>n</span>›</span></span><span class=main>,</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>&lt;</span><span class=free>n</span> <span class=main>|</span> <span class=free>j</span> <span class=main>=</span> <span class=free>n</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Some results in ordinal arithmetic›</span></span>
<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The following results are auxiliary to the proof of 
wellfoundedness of the relation <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>frecR</span></span>›</span></span></span></span>›</span></span>

<span class=keyword1 id=Nat_Miscellanea-max_cong><span class=command>lemma</span></span> max_cong <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"max<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>≤</span> max<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>≤</span> <span class=free>z</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> max_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>≤</span> <span class=free>y</span>"</span></span>  <span class=keyword1><span class=command>using</span></span> assms not_le_iff_lt leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> max_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Nat_Miscellanea-max_commutes><span class=command>lemma</span></span> max_commutes <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"max<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> max<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms Un_commute nat_simp_union<span class=main>(</span>1<span class=main>)</span> nat_simp_union<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Nat_Miscellanea-max_cong2><span class=command>lemma</span></span> max_cong2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"max<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>≤</span> max<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=free>x</span> <span class=main>∪</span> <span class=free>z</span> <span class=main>≤</span> <span class=free>y</span> <span class=main>∪</span> <span class=free>z</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lt_Ord Ord_Un Un_mono<span class=main>[</span><span class=operator>OF</span>  le_imp_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>≤</span><span class=free>y</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>  subset_imp_le <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span>  nat_simp_union <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>x</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>z</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>y</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Nat_Miscellanea-max_D1><span class=command>lemma</span></span> max_D1 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>&lt;</span> <span class=free>z</span>"</span></span>  <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"max<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>w</span><span class=main>)</span> <span class=main>=</span> max<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>≤</span><span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>&lt;</span>  <span class=free>x</span> <span class=main>∪</span> <span class=free>w</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Un_upper2_lt<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>w</span><span class=main>&lt;</span><span class=free>z</span>›</span></span><span class=main>]</span> assms nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>&lt;</span> <span class=free>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms lt_Un_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>w</span></span> <span class=quoted><span class=free>w</span></span><span class=main>]</span> lt_not_refl <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>=</span> <span class=free>y</span> <span class=main>∪</span> <span class=free>z</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms max_commutes nat_simp_union assms leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Un_leD2 assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Nat_Miscellanea-max_D2><span class=command>lemma</span></span> max_D2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>=</span> <span class=free>y</span> <span class=main>∨</span> <span class=free>w</span> <span class=main>=</span> <span class=free>z</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>y</span>"</span></span>  <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"max<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>w</span><span class=main>)</span> <span class=main>=</span> max<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>&lt;</span><span class=free>w</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>z</span> <span class=main>∪</span> <span class=free>y</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Un_upper2_lt<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>&lt;</span><span class=free>y</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>y</span>"</span></span> <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>w</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> a
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>c<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>=</span> <span class=free>y</span>"</span></span> <span class=main>|</span> <span class=main>(</span>d<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>=</span> <span class=free>z</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> c
      <span class=keyword1><span class=command>with</span></span> a <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> d
      <span class=keyword1><span class=command>with</span></span> a
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>&lt;</span><span class=free>w</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True       
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> lt_trans<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>&lt;</span><span class=free>y</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>≤</span> <span class=free>y</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> not_lt_iff_le<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>w</span><span class=main>=</span><span class=free>z</span>›</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"max<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=free>y</span>"</span></span>  <span class=keyword1><span class=command>unfolding</span></span> max_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>with</span></span> assms
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>x</span> <span class=main>∪</span> <span class=free>w</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nat_simp_union max_commutes  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> le_Un_iff assms <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> b
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Nat_Miscellanea-oadd_lt_mono2><span class=command>lemma</span></span> oadd_lt_mono2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>α</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>β</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>&lt;</span> <span class=free>β</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>&lt;</span><span class=free>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>**</span><span class=free>β</span> <span class=main>++</span> <span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>0<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>β</span><span class=main>=</span><span class=main>0</span>"</span></span> <span class=main>|</span> <span class=main>(</span>s<span class=main>)</span> <span class=skolem>γ</span> <span class=keyword2><span class=keyword>where</span></span>  <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=skolem>γ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>β</span> <span class=main>=</span> succ<span class=main>(</span><span class=skolem>γ</span><span class=main>)</span>"</span></span> <span class=main>|</span> <span class=main>(</span>l<span class=main>)</span> <span class=quoted><span class=quoted>"Limit<span class=main>(</span><span class=free>β</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Ord_cases<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>β</span><span class=main>)</span>›</span></span><span class=main>,</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> 0
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>α</span><span class=main>&lt;</span><span class=free>β</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> s
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span><span class=main>≤</span><span class=skolem>γ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>α</span><span class=main>&lt;</span><span class=free>β</span>›</span></span> <span class=keyword1><span class=command>using</span></span> leI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>≤</span> <span class=free>n</span> <span class=main>**</span> <span class=skolem>γ</span>"</span></span> <span class=keyword1><span class=command>using</span></span> omult_le_mono<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>α</span><span class=main>≤</span><span class=skolem>γ</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>**</span> <span class=skolem>γ</span> <span class=main>++</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> oadd_lt_mono<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>&lt;</span><span class=free>n</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>n</span> <span class=main>**</span> <span class=free>β</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>β</span><span class=main>=</span>succ<span class=main>(</span><span class=main>_</span><span class=main>)</span>›</span></span> omult_succ <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>β</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>**</span> <span class=free>β</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> oadd_le_self <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>β</span><span class=main>)</span>›</span></span> lt_trans2 <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> l
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>&lt;</span><span class=free>n</span>›</span></span> lt_Ord <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> l
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>α</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>β</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Limit_has_succ <span class=quoted><span class=quoted>‹<span class=free>α</span><span class=main>&lt;</span><span class=free>β</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>n</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> oadd_lt_mono<span class=main>[</span><span class=operator>OF</span> le_refl<span class=main><span class=main>[</span></span><span class=operator>OF</span> Ord_omult<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>α</span><span class=main>)</span>›</span></span><span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>&lt;</span><span class=free>n</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>n</span> <span class=main>**</span> succ<span class=main>(</span><span class=free>α</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> omult_succ <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>α</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>**</span> succ<span class=main>(</span><span class=free>α</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹succ<span class=main>(</span><span class=free>α</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>β</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>**</span> <span class=free>α</span> <span class=main>++</span> <span class=free>x</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>**</span> <span class=free>β</span>"</span></span> <span class=keyword1><span class=command>using</span></span> lt_trans omult_lt_mono <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>&lt;</span><span class=free>n</span>›</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>      
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> oadd_le_self <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>β</span><span class=main>)</span>›</span></span> lt_trans2 <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Internalizations><div class=head><h1>Theory Internalizations</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Aids to internalize formulas›</span></span>
<span class=keyword1><span class=command>theory</span></span> Internalizations
  <span class=keyword2><span class=keyword>imports</span></span> 
    <span class=quoted>"<a href=../../ZF/ZF-Constructible/DPow_absolute.html>ZF-Constructible.DPow_absolute</a>"</span> 
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We found it useful to have slightly different versions of some 
results in ZF-Constructible:›</span></span>
<span class=keyword1 id=Internalizations-nth_closed><span class=command>lemma</span></span> nth_closed <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span><span class=free>A</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span>1<span class=main>)</span> <span class=keyword1><span class=command>unfolding</span></span> nth_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>env</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span><span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> FOL_sats_iff <span class=main>=</span> sats_Nand_iff sats_Forall_iff sats_Neg_iff sats_And_iff
  sats_Or_iff sats_Implies_iff sats_Iff_iff sats_Exists_iff 

<span class=keyword1 id=Internalizations-nth_ConsI><span class=command>lemma</span></span> nth_ConsI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span>nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>l</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span><span class=main>;</span> <span class=free>n</span> <span class=main>∈</span> nat<span class=main>⟧</span> <span class=main>⟹</span> nth<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>l</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemmas</span></span> nth_rules <span class=main>=</span> nth_0 nth_ConsI nat_0I nat_succI
<span class=keyword1><span class=command>lemmas</span></span> sep_rules <span class=main>=</span> nth_0 nth_ConsI FOL_iff_sats function_iff_sats
                   fun_plus_iff_sats successor_iff_sats
                    omega_iff_sats FOL_sats_iff Replace_iff_sats

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Also a different compilation of lemmas (term<span class=antiquoted><span class=raw_text><span class=antiquoted><span class=raw_text><span class=operator><span class=operator>‹</span></span>sep_rules›</span></span></span></span>) used in formula
 synthesis›</span></span>
<span class=keyword1><span class=command>lemmas</span></span> fm_defs <span class=main>=</span> omega_fm_def limit_ordinal_fm_def empty_fm_def typed_function_fm_def
                 pair_fm_def upair_fm_def domain_fm_def function_fm_def succ_fm_def
                 cons_fm_def fun_apply_fm_def image_fm_def big_union_fm_def union_fm_def
                 relation_fm_def composition_fm_def field_fm_def ordinal_fm_def range_fm_def
                 transset_fm_def subset_fm_def Replace_fm_def


<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Recursion_Thms><div class=head><h1>Theory Recursion_Thms</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Some enhanced theorems on recursion›</span></span>

<span class=keyword1><span class=command>theory</span></span> Recursion_Thms <span class=keyword2><span class=keyword>imports</span></span> <a href=../../ZF/ZF/Epsilon.html>ZF.Epsilon</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We prove results concerning definitions by well-founded
recursion on some relation <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>R</span></span>›</span></span></span></span> and its transitive closure
<span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>R</span></span><span class=main><span class=main>^*</span></span>›</span></span></span></span>›</span></span>
  <span class=comment1>(* Restrict the relation r to the field A*A *)</span>

<span class=keyword1 id=Recursion_Thms-fld_restrict_eq><span class=command>lemma</span></span> fld_restrict_eq <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>r</span> <span class=main>∩</span> <span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>=</span> <span class=main>(</span><span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>∩</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>force</span><span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-fld_restrict_mono><span class=command>lemma</span></span> fld_restrict_mono <span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>A</span> <span class=main>⊆</span> <span class=free>B</span> <span class=main>⟹</span> <span class=free>r</span> <span class=main>∩</span> <span class=free>A</span><span class=main>×</span><span class=free>A</span> <span class=main>⊆</span> <span class=free>r</span> <span class=main>∩</span> <span class=free>B</span><span class=main>×</span><span class=free>B</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-fld_restrict_dom><span class=command>lemma</span></span> fld_restrict_dom <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"range<span class=main>(</span><span class=free>r</span><span class=main>)</span><span class=main>⊆</span> <span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∩</span> <span class=free>A</span><span class=main>×</span><span class=free>A</span> <span class=main>=</span> <span class=free>r</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>rule</span> equalityI<span class=main><span class=keyword3>,</span></span><span class=operator>blast</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> subsetI<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> xr<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>r</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> xr assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span> <span class=bound>a</span> <span class=bound>b</span> <span class=main>.</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>⟩</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> relation_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>∩</span><span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>∩</span><span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms xr
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span> <span class=free>r</span> <span class=main>∩</span> <span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>⟹</span> <span class=skolem>x</span><span class=main>∈</span> <span class=free>r</span><span class=main>∩</span><span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>tr_down</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>tr_down</span><span class=main>(</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1 id=Recursion_Thms-tr_downD><span class=command>lemma</span></span> tr_downD <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>a</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>^+</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tr_down_def vimage_singleton_iff<span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-pred_down><span class=command>lemma</span></span> pred_down <span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>⊆</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> tr_down_def vimage_mono r_subset_trancl<span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-tr_down_mono><span class=command>lemma</span></span> tr_down_mono <span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>⟹</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> subsetI<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>tr_down_def<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> underD<span class=main><span class=keyword3>,</span></span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> underI r_into_trancl trancl_trans<span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-rest_eq><span class=command>lemma</span></span> rest_eq <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>⊆</span> <span class=free>B</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>B</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>=</span> <span class=main>(</span><span class=free>r</span><span class=main>∩</span><span class=free>B</span><span class=main>×</span><span class=free>B</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> equalityI subsetI<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>B</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> subsetD<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=free>a</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span>"</span></span> <span class=keyword1><span class=command>using</span></span> underD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=free>r</span><span class=main>∩</span><span class=free>B</span><span class=main>×</span><span class=free>B</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>B</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=free>B</span>›</span></span> underI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>-``</span> <span class=main>{</span><span class=free>a</span><span class=main>}</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=free>r</span> <span class=main>∩</span> <span class=free>B</span><span class=main>×</span><span class=free>B</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>a</span><span class=main>}</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> vimage_mono that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Recursion_Thms-wfrec_restr_eq><span class=command>lemma</span></span> wfrec_restr_eq <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>r'</span> <span class=main>=</span> <span class=free>r</span> <span class=main>∩</span> <span class=free>A</span><span class=main>×</span><span class=free>A</span> <span class=main>⟹</span> <span class=keyword1>wfrec[</span><span class=free>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>H</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span><span class=free>r'</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>H</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>wfrec_on_def<span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-wfrec_restr><span class=command>lemma</span></span> wfrec_restr <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> rr<span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> wfr<span class=main>:</span><span class=quoted><span class=quoted>"wf<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span> <span class=main>⟹</span> wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>H</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>wfrec[</span><span class=free>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>H</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>a</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>A</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>wf_induct_raw<span class=main><span class=main>[</span></span><span class=operator>OF</span> wfr<span class=main><span class=main>]</span></span> <span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>a</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> wfRa <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>wf[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wf_subset wfr wf_on_def Int_lower1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> pred_down rr
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>-``</span> <span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>⊆</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>with</span></span> 1
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>⊆</span> <span class=skolem>A</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> subset_trans<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> x_a <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>⊆</span> <span class=skolem>A</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>A</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
    <span class=keyword1><span class=command>from</span></span> pred_down rr
    <span class=keyword1><span class=command>have</span></span> b <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>-``</span><span class=main>{</span><span class=skolem>x</span><span class=main>}</span> <span class=main>⊆</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span> <span class=main>⊆</span> tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tr_down_mono x_a rr <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> 1
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=skolem>A</span>"</span></span> <span class=keyword1><span class=command>using</span></span> subset_trans <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span>"</span></span> <span class=keyword1><span class=command>using</span></span> x_a  underD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> 1 <span class=quoted><span class=quoted>‹tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span> <span class=main>⊆</span> <span class=skolem>A</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>A</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>⟹</span> wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span> <span class=main>=</span>  <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>  <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> Eq1 <span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>.</span> wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>.</span> <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lam_cong <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=free>H</span><span class=main>)</span> <span class=main>=</span> <span class=free>H</span><span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=main>λ</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>.</span> wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>wfrec<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>H</span><span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=main>λ</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>.</span> <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms Eq1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> 1 <span class=quoted><span class=quoted>‹<span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>⊆</span> <span class=skolem>A</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>H</span><span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=main>λ</span> <span class=bound>x</span> <span class=main>∈</span> <span class=main>(</span><span class=free>r</span><span class=main>∩</span><span class=skolem>A</span><span class=main>×</span><span class=skolem>A</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span> <span class=main>.</span> <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms rest_eq  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=skolem>A</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>H</span><span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=main>λ</span> <span class=bound>x</span> <span class=main>∈</span> <span class=main>(</span><span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=skolem>a</span><span class=main>}</span><span class=main>)</span><span class=main>∩</span><span class=skolem>A</span> <span class=main>.</span> <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>H</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fld_restrict_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=skolem>A</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=keyword1>wf[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=keyword1>wfrec[</span><span class=skolem>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=free>H</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> wfrec_on <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> wfrec_tr_down <span class=main>=</span> wfrec_restr<span class=main>[</span><span class=operator>OF</span> _ _ _ subset_refl<span class=main>]</span>

<span class=keyword1 id=Recursion_Thms-wfrec_trans_restr><span class=command>lemma</span></span> wfrec_trans_restr <span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> wf<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> trans<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>r</span><span class=main>-``</span><span class=main>{</span><span class=free>a</span><span class=main>}</span><span class=main>⊆</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span>
  wfrec<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>wfrec[</span><span class=free>A</span><span class=main>](</span><span class=free>r</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"tr_down<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span> <span class=main><span class=main>:</span></span> wfrec_restr tr_down_def trancl_eq_r<span class=main>)</span>


<span class=keyword1 id=Recursion_Thms-field_trancl><span class=command>lemma</span></span> field_trancl <span class=main>:</span> <span class=quoted><span class=quoted>"field<span class=main>(</span><span class=free>r</span><span class=main>^+</span><span class=main>)</span> <span class=main>=</span> field<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> r_into_trancl <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> trancl_type <span class=main><span class=main>[</span></span><span class=operator>THEN</span> subsetD<span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Rrel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Rrel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=bound>z</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>×</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span>"</span></span>

<span class=keyword1 id=Recursion_Thms-RrelI><span class=command>lemma</span></span> RrelI <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Recursion_Thms-Rrel_mem><span class=command>lemma</span></span> Rrel_mem<span class=main>:</span> <span class=quoted><span class=quoted>"Rrel<span class=main>(</span>mem<span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> Memrel<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def Memrel_def <span class=keyword1><span class=command>..</span></span>

<span class=keyword1 id=Recursion_Thms-relation_Rrel><span class=command>lemma</span></span> relation_Rrel<span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span>Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def relation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Recursion_Thms-field_Rrel><span class=command>lemma</span></span> field_Rrel<span class=main>:</span> <span class=quoted><span class=quoted>"field<span class=main>(</span>Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span>  <span class=free>d</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Recursion_Thms-Rrel_mono><span class=command>lemma</span></span> Rrel_mono <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>⊆</span> <span class=free>B</span> <span class=main>⟹</span> Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>A</span><span class=main>)</span> <span class=main>⊆</span> Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>B</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Recursion_Thms-Rrel_restr_eq><span class=command>lemma</span></span> Rrel_restr_eq <span class=main>:</span> <span class=quoted><span class=quoted>"Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>A</span><span class=main>)</span> <span class=main>∩</span> <span class=free>B</span><span class=main>×</span><span class=free>B</span> <span class=main>=</span> Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>A</span><span class=main>∩</span><span class=free>B</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=comment1>(* now a consequence of the previous lemmas *)</span>
<span class=keyword1 id=Recursion_Thms-field_Memrel><span class=command>lemma</span></span> field_Memrel <span class=main>:</span> <span class=quoted><span class=quoted>"field<span class=main>(</span>Memrel<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span>
  <span class=comment1>(* unfolding field_def using Ordinal.Memrel_type by blast *)</span>
  <span class=keyword1><span class=command>using</span></span> Rrel_mem field_Rrel <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Recursion_Thms-restrict_trancl_Rrel><span class=command>lemma</span></span> restrict_trancl_Rrel<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>(</span><span class=free>w</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span>
       <span class=main>=</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>(</span>Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>d</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∈</span><span class=free>d</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>y</span><span class=main>∈</span><span class=free>d</span>›</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>w</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?r</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>w</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> r_subset_trancl<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>]</span> relation_Rrel<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>d</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=free>w</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?r</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∈</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∈</span><span class=var>?s</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> vimage_singleton_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∉</span>domain<span class=main>(</span>restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> field_Rrel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>d</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>w</span><span class=main>∉</span><span class=free>d</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∉</span>domain<span class=main>(</span>restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=var>?s</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> field_Rrel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>d</span></span><span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>w</span></span><span class=main>]</span> field_trancl<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>]</span>
        fieldI1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>w</span></span> <span class=quoted><span class=free>y</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span> <span class=main>=</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=var>?s</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> apply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>d</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=var>?r</span><span class=main>^+</span>"</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>=</span><span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∉</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>y</span><span class=main>∉</span><span class=free>d</span>›</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∉</span>field<span class=main>(</span><span class=var>?s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> field_trancl subsetD<span class=main>[</span><span class=operator>OF</span> field_Rrel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>d</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∉</span><span class=var>?s</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> vimage_singleton_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>w</span><span class=main>∉</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Recursion_Thms-restrict_trans_eq><span class=command>lemma</span></span> restrict_trans_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span> <span class=main>∈</span> <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span>
       <span class=main>=</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms restrict_trancl_Rrel<span class=main>[</span><span class=operator>of</span> <span class=quoted>mem</span> <span class=main>]</span> Rrel_mem <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>

<span class=keyword1 id=Recursion_Thms-wf_eq_trancl><span class=command>lemma</span></span> wf_eq_trancl<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>f</span> <span class=bound>y</span> <span class=main>.</span> <span class=free>H</span><span class=main>(</span><span class=bound>y</span><span class=main>,</span>restrict<span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=free>R</span><span class=main>-``</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>H</span><span class=main>(</span><span class=bound>y</span><span class=main>,</span>restrict<span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=free>R</span><span class=main>^+</span><span class=main>-``</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"wfrec<span class=main>(</span><span class=free>R</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span><span class=free>R</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span><span class=var>?r</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span><span class=var>?r'</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span><span class=free>R</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span> <span class=main>=</span> wftrec<span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span> <span class=bound>f</span><span class=main>.</span> <span class=free>H</span><span class=main>(</span><span class=bound>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wfrec_def <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> wftrec<span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span> <span class=bound>f</span><span class=main>.</span> <span class=free>H</span><span class=main>(</span><span class=bound>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span>  wfrec<span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wfrec_def <span class=keyword1><span class=command>using</span></span> trancl_eq_r<span class=main>[</span><span class=operator>OF</span> relation_trancl trans_trancl<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Relative_Univ><div class=head><h1>Theory Relative_Univ</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Relativization of the cumulative hierarchy›</span></span>
<span class=keyword1><span class=command>theory</span></span> Relative_Univ
  <span class=keyword2><span class=keyword>imports</span></span>
    <span class=quoted>"<a href=../../ZF/ZF-Constructible/Rank.html>ZF-Constructible.Rank</a>"</span>
    <a href=Internalizations.html>Internalizations</a>
    <a href=Recursion_Thms.html>Recursion_Thms</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_trivial<span class=main>)</span> powerset_abs' <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"powerset<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> powerset_abs assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-Collect_inter_Transset><span class=command>lemma</span></span> Collect_inter_Transset<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>b</span> <span class=main>.</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>b</span> <span class=main>.</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>∩</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> Transset_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>  

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_trivial<span class=main>)</span> family_union_closed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span>strong_replacement<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>;</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>⟧</span>
      <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=main>⋃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> RepFun_closed <span class=keyword1><span class=command>..</span></span>

<span class=comment1>(* "Vfrom(A,i) ≡ transrec(i, %x f. A ∪ (⋃y∈x. Pow(f`y)))" *)</span>
<span class=comment1>(* HVfrom is *not* the recursive step for Vfrom. It is the
   relativized version *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>HVfrom</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>HVfrom</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>.</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>

<span class=comment1>(* z = Pow(f`y) *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_powapply</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_powapply</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>fy</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> fun_apply<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>fy</span><span class=main>)</span> <span class=main>∧</span> powerset<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>fy</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=comment1>(* Trivial lemma *)</span>
<span class=keyword1 id=Relative_Univ-is_powapply_closed><span class=command>lemma</span></span> is_powapply_closed<span class=main>:</span> <span class=quoted><span class=quoted>"is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_powapply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* is_Replace(M,A,P,z) ≡ ∀u[M]. u ∈ z ⟷ (∃x[M]. x∈A &amp; P(x,u)) *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_HVfrom</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_HVfrom</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>h</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>U</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>R</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>  union<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=bound>U</span><span class=main>,</span><span class=free><span class=bound><span class=entity>h</span></span></span><span class=main>)</span> 
        <span class=main>∧</span> big_union<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>R</span><span class=main>,</span><span class=bound>U</span><span class=main>)</span> <span class=main>∧</span> is_Replace<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>,</span><span class=bound>R</span><span class=main>)</span>"</span></span> 


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Vfrom</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Vfrom</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>V</span></span></span><span class=main>)</span> <span class=main>≡</span> is_transrec<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_HVfrom<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>V</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Vset</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Vset</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>V</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>∧</span> is_Vfrom<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>V</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Formula synthesis›</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> sats_is_powapply_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_powapply<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?ipa_fm</span><span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_powapply_def is_Collect_def powerset_def subset_def
  <span class=keyword1><span class=command>using</span></span> nth_closed assms
   <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span> <span class=main>(</span><span class=operator>rule</span> sep_rules  <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> is_powapply_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ff</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>yy</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>zz</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
       <span class=quoted><span class=quoted>"is_powapply<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>ff</span><span class=main>,</span><span class=free>yy</span><span class=main>,</span><span class=free>zz</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=var>?is_one_fm</span><span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>r</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ff</span>›</span></span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=quoted><span class=quoted>‹nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>yy</span>›</span></span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=quoted><span class=quoted>‹nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>zz</span>›</span></span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sats_is_powapply_fm_auto<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>assms<span class=main>)</span>

<span class=comment1>(* rank *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Hrank</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Hrank</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>.</span> succ<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>PHrank</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PHrank</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>fy</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> fun_apply<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>fy</span><span class=main>)</span> <span class=main>∧</span> successor<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>fy</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Hrank</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Hrank</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span><span class=bound>R</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> big_union<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>R</span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span> <span class=main>∧</span>is_Replace<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span>PHrank<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>,</span><span class=bound>R</span><span class=main>)</span><span class=main>)</span> "</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>rrank</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rrank</span><span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≡</span> Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span> 

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_eclose<span class=main>)</span> wf_rrank <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> wf<span class=main>(</span>rrank<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> rrank_def <span class=keyword1><span class=command>using</span></span> wf_trancl<span class=main>[</span><span class=operator>OF</span> wf_Memrel<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_eclose<span class=main>)</span> trans_rrank <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> trans<span class=main>(</span>rrank<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rrank_def <span class=keyword1><span class=command>using</span></span> trans_trancl <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_eclose<span class=main>)</span> relation_rrank <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> relation<span class=main>(</span>rrank<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> rrank_def <span class=keyword1><span class=command>using</span></span> relation_trancl <span class=keyword1><span class=command>.</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_eclose<span class=main>)</span> rrank_in_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span>rrank<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> rrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Absoluteness results›</span></span>

<span class=keyword1><span class=command>locale</span></span> M_eclose_pow <span class=main>=</span> M_eclose <span class=main>+</span> 
  <span class=keyword2><span class=keyword>assumes</span></span>
    power_ax <span class=main>:</span> <span class=quoted><span class=quoted>"power_ax<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    powapply_replacement <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>⟹</span> strong_replacement<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    HVfrom_replacement <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> 
                          transrec_replacement<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=free>i</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    PHrank_replacement <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>⟹</span> strong_replacement<span class=main>(</span><span class=free>M</span><span class=main>,</span>PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    is_Hrank_replacement <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> wfrec_replacement<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_Hrank<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>,</span>rrank<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Relative_Univ-is_powapply_abs><span class=command>lemma</span></span> is_powapply_abs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span> <span class=main>∧</span> <span class=free>z</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=free>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_powapply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>h</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> 
      is_HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>h</span><span class=main>)</span> <span class=main>⟷</span> 
      <span class=main>(</span><span class=main>∃</span><span class=bound>R</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> <span class=free>h</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=main>⋃</span><span class=bound>R</span> <span class=main>∧</span> is_Replace<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=bound>x</span><span class=main>)</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>,</span> <span class=bound>R</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> is_powapply_abs <span class=keyword1><span class=command>unfolding</span></span> is_HVfrom_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Relative_Univ-Replace_is_powapply><span class=command>lemma</span></span> Replace_is_powapply<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>R</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"is_Replace<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>f</span><span class=main>)</span><span class=main>,</span> <span class=free>R</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>R</span> <span class=main>=</span> Replace<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> univalent_def is_powapply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>⟦</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>;</span> is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> is_powapply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>R</span><span class=main>)</span>›</span></span> Replace_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-powapply_closed><span class=command>lemma</span></span> powapply_closed<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=free>y</span><span class=main>)</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> apply_closed power_ax <span class=keyword1><span class=command>unfolding</span></span> power_ax_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-RepFun_is_powapply><span class=command>lemma</span></span> RepFun_is_powapply<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>R</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"Replace<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> RepFun<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span><span class=main>,</span> <span class=free>M</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>y</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=bound>x</span><span class=main>)</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span><span class=main>,</span> <span class=bound>y</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=bound>x</span><span class=main>)</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms powapply_closed transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=bound>y</span><span class=main>)</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>finally</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms is_powapply_abs transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-RepFun_powapply_closed><span class=command>lemma</span></span> RepFun_powapply_closed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span>Replace<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> univalent_def is_powapply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=skolem>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>;</span> is_powapply<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> is_powapply_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms powapply_replacement <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-Union_powapply_closed><span class=command>lemma</span></span> Union_powapply_closed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=free>x</span><span class=main>.</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=main>{</span><span class=bound>a</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=skolem>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>x</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that assms transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> powapply_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=main>{</span><span class=main>{</span><span class=bound>a</span><span class=main>∈</span>Pow<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>}</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=free>x</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span>  RepFun_powapply_closed RepFun_is_powapply <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-relation2_HVfrom><span class=command>lemma</span></span> relation2_HVfrom<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> relation2<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span>HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_HVfrom_def HVfrom_def relation2_def
    <span class=keyword1><span class=command>using</span></span> Replace_is_powapply RepFun_is_powapply 
          Union_powapply_closed RepFun_powapply_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Relative_Univ-HVfrom_closed><span class=command>lemma</span></span> HVfrom_closed <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>x</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> <span class=main>∀</span><span class=bound>g</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> function<span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟶</span> <span class=free>M</span><span class=main>(</span>HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> HVfrom_def <span class=keyword1><span class=command>using</span></span> Union_powapply_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-transrec_HVfrom><span class=command>lemma</span></span> transrec_HVfrom<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> transrec<span class=main>(</span><span class=free>i</span><span class=main>,</span>HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>trans_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>step <span class=skolem>i</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> Pow<span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_transrec<span class=main>[</span><span class=operator>OF</span> Vfrom_def<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> Pow<span class=main>(</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=skolem>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=skolem>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>transM<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=main>{</span><span class=bound>z</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=main>{</span><span class=bound>z</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>}</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=skolem>i</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>transM<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> step 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=free>A</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>i</span><span class=main>.</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span>transrec<span class=main>(</span><span class=bound>y</span><span class=main>,</span> HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>A</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> transrec<span class=main>(</span><span class=skolem>i</span><span class=main>,</span> HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_transrec<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> transrec<span class=main>(</span><span class=bound>y</span><span class=main>,</span> HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>,</span><span class=operator>symmetric</span><span class=main>]</span> 
    <span class=keyword1><span class=command>unfolding</span></span> HVfrom_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-Vfrom_abs><span class=command>lemma</span></span> Vfrom_abs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>V</span><span class=main>)</span><span class=main>;</span> Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> is_Vfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>i</span><span class=main>,</span><span class=free>V</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>V</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Vfrom_def
  <span class=keyword1><span class=command>using</span></span> relation2_HVfrom HVfrom_closed HVfrom_replacement 
    transrec_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"is_HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=quoted>"HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> transrec_HVfrom <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-Vfrom_closed><span class=command>lemma</span></span> Vfrom_closed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>;</span> Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Vfrom_def
  <span class=keyword1><span class=command>using</span></span> relation2_HVfrom HVfrom_closed HVfrom_replacement 
    transrec_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"is_HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=quoted>"HVfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> transrec_HVfrom <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-Vset_abs><span class=command>lemma</span></span> Vset_abs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>V</span><span class=main>)</span><span class=main>;</span> Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> is_Vset<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>i</span><span class=main>,</span><span class=free>V</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>V</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vset<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Vfrom_abs <span class=keyword1><span class=command>unfolding</span></span> is_Vset_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-Vset_closed><span class=command>lemma</span></span> Vset_closed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>;</span> Ord<span class=main>(</span><span class=free>i</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vset<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Vfrom_closed <span class=keyword1><span class=command>unfolding</span></span> is_Vset_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-Hrank_trancl><span class=command>lemma</span></span> Hrank_trancl<span class=main>:</span><span class=quoted><span class=quoted>"Hrank<span class=main>(</span><span class=free>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
                  <span class=main>=</span> Hrank<span class=main>(</span><span class=free>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hrank_def
  <span class=keyword1><span class=command>using</span></span> restrict_trans_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-rank_trancl><span class=command>lemma</span></span> rank_trancl<span class=main>:</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span>rrank<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hrank<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span>  wfrec<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hrank<span class=main>)</span>"</span></span>
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>unfolding</span></span> rank_def transrec_def Hrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> wftrec<span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span> <span class=bound>f</span><span class=main>.</span> Hrank<span class=main>(</span><span class=bound>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=var>?r</span><span class=main>-``</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wfrec_def <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> wftrec<span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span> <span class=bound>f</span><span class=main>.</span> Hrank<span class=main>(</span><span class=bound>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Hrank_trancl <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span>  wfrec<span class=main>(</span><span class=var>?r</span><span class=main>^+</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hrank<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wfrec_def <span class=keyword1><span class=command>using</span></span> trancl_eq_r<span class=main>[</span><span class=operator>OF</span> relation_trancl trans_trancl<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rrank_def <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-univ_PHrank><span class=command>lemma</span></span> univ_PHrank <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span> <span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> univalent<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> univalent_def PHrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Relative_Univ-PHrank_abs><span class=command>lemma</span></span> PHrank_abs <span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span> <span class=main>∧</span> <span class=free>z</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> PHrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-PHrank_closed><span class=command>lemma</span></span> PHrank_closed <span class=main>:</span> <span class=quoted><span class=quoted>"PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> PHrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-Replace_PHrank_abs><span class=command>lemma</span></span> Replace_PHrank_abs<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>hr</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_Replace<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>,</span><span class=free>hr</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>hr</span> <span class=main>=</span> Replace<span class=main>(</span><span class=free>z</span><span class=main>,</span>PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>x</span><span class=main>∈</span><span class=free>z</span><span class=main>;</span> PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>unfolding</span></span> PHrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>hr</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span> univ_PHrank Replace_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-RepFun_PHrank><span class=command>lemma</span></span> RepFun_PHrank<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>R</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"Replace<span class=main>(</span><span class=free>A</span><span class=main>,</span>PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> RepFun<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>z</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span><span class=main>,</span> <span class=free>M</span><span class=main>(</span><span class=bound>z</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>z</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>z</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span><span class=main>,</span> <span class=bound>z</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms PHrank_closed transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>finally</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms PHrank_abs transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-RepFun_PHrank_closed><span class=command>lemma</span></span> RepFun_PHrank_closed <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span>Replace<span class=main>(</span><span class=free>A</span><span class=main>,</span>PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=skolem>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>;</span> PHrank<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> PHrank_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> univ_PHrank
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms PHrank_replacement <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-relation2_Hrank><span class=command>lemma</span></span> relation2_Hrank <span class=main>:</span>
  <span class=quoted><span class=quoted>"relation2<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_Hrank<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>,</span>Hrank<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Hrank_def Hrank_def relation2_def
  <span class=keyword1><span class=command>using</span></span> Replace_PHrank_abs RepFun_PHrank RepFun_PHrank_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Relative_Univ-Union_PHrank_closed><span class=command>lemma</span></span> Union_PHrank_closed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=main>⋃</span><span class=bound>y</span><span class=main>∈</span><span class=free>x</span><span class=main>.</span> succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span>succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>x</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that assms transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=main>{</span>succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>y</span><span class=main>)</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=free>x</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms transM<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span>  RepFun_PHrank_closed RepFun_PHrank <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Relative_Univ-is_Hrank_closed><span class=command>lemma</span></span> is_Hrank_closed <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>x</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> <span class=main>∀</span><span class=bound>g</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> function<span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟶</span> <span class=free>M</span><span class=main>(</span>Hrank<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hrank_def <span class=keyword1><span class=command>using</span></span> RepFun_PHrank_closed Union_PHrank_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Relative_Univ-rank_closed><span class=command>lemma</span></span> rank_closed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span>rank<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rank_trancl 
  <span class=keyword1><span class=command>using</span></span> relation2_Hrank is_Hrank_closed is_Hrank_replacement 
        wf_rrank relation_rrank trans_rrank rrank_in_M 
         trans_wfrec_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"rrank<span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>a</span></span> <span class=quoted><span class=quoted>"is_Hrank<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Relative_Univ-M_into_Vset><span class=command>lemma</span></span> M_into_Vset<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>i</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>V</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> ordinal<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=bound>i</span><span class=main>)</span> <span class=main>∧</span> is_Vfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=bound>i</span><span class=main>,</span><span class=bound>V</span><span class=main>)</span> <span class=main>∧</span> <span class=free>a</span><span class=main>∈</span><span class=bound>V</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?i</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"succ<span class=main>(</span>rank<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vfrom<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=var>?i</span><span class=main>)</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=var>?V</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> Vset_Ord_rank_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=var>?i</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rank_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=var>?V</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Vfrom_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ordinal<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?i</span><span class=main>)</span> <span class=main>∧</span> is_Vfrom<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=var>?i</span><span class=main>,</span> <span class=var>?V</span><span class=main>)</span> <span class=main>∧</span> <span class=free>a</span> <span class=main>∈</span> <span class=var>?V</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Ord_rank Vfrom_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Synthetic_Definition><div class=head><h1>Theory Synthetic_Definition</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Automatic synthesis of formulas›</span></span>

<span class=keyword1><span class=command>theory</span></span> Synthetic_Definition
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Utils.html>Utils</a>
  <span class=keyword2><span class=keyword>keywords</span></span> <span class=quoted>"synthesize"</span> <span class=main>::</span> thy_decl <span class=main>%</span> <span class=quoted>"ML"</span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted>"synthesize_notc"</span> <span class=main>::</span> thy_decl <span class=main>%</span> <span class=quoted>"ML"</span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted>"from_schematic"</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>ML</span></span><span class=quoted>‹
<span class=keyword1><span class=keyword>val</span></span> <span class=entity>$`</span> <span class=main>=</span> curry <span class=main>(</span><span class=main>(</span><span class=keyword1><span class=keyword>op</span></span> $<span class=main>)</span> o swap<span class=main>)</span>
<span class=keyword1><span class=keyword>infix</span></span> $`

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>pair</span> <span class=entity>f</span> <span class=entity>g</span> <span class=entity>x</span> <span class=main>=</span> <span class=main>(</span><span class=entity>f</span> <span class=entity>x</span><span class=main>,</span> <span class=entity>g</span> <span class=entity>x</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>display</span> <span class=entity>kind</span> <span class=entity>pos</span> <span class=main>(</span><span class=entity>thms</span><span class=main>,</span><span class=entity>thy</span><span class=main>)</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=main>_</span> <span class=main>=</span> <span class=entity>Proof_Display.print_results</span> true <span class=entity>pos</span> <span class=entity>thy</span> <span class=main>(</span><span class=main>(</span><span class=entity>kind</span><span class=main>,</span><span class=inner_quoted>""</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=entity>thms</span><span class=main>]</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>in</span></span> <span class=entity>thy</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>prove_tc_form</span> <span class=entity>goal</span> <span class=entity>thms</span> <span class=entity>ctxt</span> <span class=main>=</span>
  Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>goal</span>
     <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span> rewrite_goal_tac <span class=entity>ctxt</span> <span class=entity>thms</span> <span class=inner_numeral>1</span>
              THEN <span class=entity>TypeCheck.typecheck_tac</span> <span class=entity>ctxt</span><span class=main>)</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>prove_sats</span> <span class=entity>goal</span> <span class=entity>thms</span> <span class=entity>thm_auto</span> <span class=entity>ctxt</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ctxt'</span> <span class=main>=</span> <span class=entity>ctxt</span> |&gt; <span class=entity>Simplifier.add_simp</span> <span class=main>(</span><span class=entity>thm_auto</span> |&gt; hd<span class=main>)</span>
  <span class=keyword2><span class=keyword>in</span></span>
  Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>goal</span>
     <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span> rewrite_goal_tac <span class=entity>ctxt</span> <span class=entity>thms</span> <span class=inner_numeral>1</span>
              THEN <span class=entity>PARALLEL_ALLGOALS</span> <span class=main>(</span><span class=entity>asm_simp_tac</span> <span class=entity>ctxt'</span><span class=main>)</span>
              THEN <span class=entity>TypeCheck.typecheck_tac</span> <span class=entity>ctxt'</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>is_mem</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> mem<span class=antiquote>}</span></span> $ <span class=main>_</span> $  <span class=main>_</span><span class=main>)</span> <span class=main>=</span> true
  <span class=main>|</span> <span class=entity>is_mem</span> <span class=main>_</span> <span class=main>=</span> false

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>synth_thm_sats</span> <span class=entity>def_name</span> <span class=entity>term</span> <span class=entity>lhs</span> <span class=entity>set</span> <span class=entity>env</span> <span class=entity>hyps</span> <span class=entity>vars</span> <span class=entity>vs</span> <span class=entity>pos</span> <span class=entity>thm_auto</span> <span class=entity>lthy</span> <span class=main>=</span>
<span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=entity>tm</span><span class=main>,</span><span class=entity>ctxt1</span><span class=main>)</span> <span class=main>=</span> <span class=entity>Utils.thm_concl_tm</span> <span class=entity>lthy</span> <span class=entity>term</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>thm_refs</span><span class=main>,</span><span class=entity>ctxt2</span><span class=main>)</span> <span class=main>=</span> Variable.import true <span class=main>[</span>Proof_Context.get_thm <span class=entity>lthy</span> <span class=entity>term</span><span class=main>]</span> <span class=entity>ctxt1</span> |&gt;&gt; <span class=main>#</span><span class=inner_numeral>2</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>vs'</span> <span class=main>=</span> map <span class=main>(</span>Thm.term_of o <span class=main>#</span><span class=inner_numeral>2</span><span class=main>)</span> <span class=entity>vs</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>vars'</span> <span class=main>=</span> map <span class=main>(</span>Thm.term_of o <span class=main>#</span><span class=inner_numeral>2</span><span class=main>)</span> <span class=entity>vars</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>r_tm</span> <span class=main>=</span> <span class=entity>tm</span> |&gt; <span class=entity>Utils.dest_lhs_def</span> |&gt; fold <span class=main>(</span><span class=keyword1><span class=keyword>op</span></span> <span class=entity>$`</span><span class=main>)</span> <span class=entity>vs'</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>sats</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> apply<span class=antiquote>}</span></span> $ <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> satisfies<span class=antiquote>}</span></span> $ <span class=entity>set</span> $ <span class=entity>r_tm</span><span class=main>)</span> $ <span class=entity>env</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>rhs</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> IFOL.eq<span class=main>(</span><span class=quoted>i</span><span class=main>)</span><span class=antiquote>}</span></span> $ <span class=entity>sats</span> $ <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> succ<span class=antiquote>}</span></span> $ <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> zero<span class=antiquote>}</span></span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>concl</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> IFOL.iff<span class=antiquote>}</span></span> $ <span class=entity>lhs</span> $ <span class=entity>rhs</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>g_iff</span> <span class=main>=</span> Logic.list_implies<span class=main>(</span><span class=entity>hyps</span><span class=main>,</span> <span class=entity>Utils.tp</span> <span class=entity>concl</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>thm</span> <span class=main>=</span> <span class=entity>prove_sats</span> <span class=entity>g_iff</span> <span class=entity>thm_refs</span> <span class=entity>thm_auto</span> <span class=entity>ctxt2</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>name</span> <span class=main>=</span> Binding.name <span class=main>(</span><span class=entity>def_name</span> ^ <span class=inner_quoted>"_iff_sats"</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>thm</span> <span class=main>=</span> <span class=entity>Utils.fix_vars</span> <span class=entity>thm</span> <span class=main>(</span>map <span class=main>(</span><span class=main>#</span><span class=inner_numeral>1</span> o dest_Free<span class=main>)</span> <span class=entity>vars'</span><span class=main>)</span> <span class=entity>lthy</span>
 <span class=keyword2><span class=keyword>in</span></span>
   Local_Theory.note <span class=main>(</span><span class=main>(</span><span class=entity>name</span><span class=main>,</span> <span class=main>[</span><span class=main>]</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=entity>thm</span><span class=main>]</span><span class=main>)</span> <span class=entity>lthy</span> |&gt; <span class=entity>display</span> <span class=inner_quoted>"theorem"</span> <span class=entity>pos</span>
 <span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>synth_thm_tc</span> <span class=entity>def_name</span> <span class=entity>term</span> <span class=entity>hyps</span> <span class=entity>vars</span> <span class=entity>pos</span> <span class=entity>lthy</span> <span class=main>=</span>
<span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=entity>tm</span><span class=main>,</span><span class=entity>ctxt1</span><span class=main>)</span> <span class=main>=</span> <span class=entity>Utils.thm_concl_tm</span> <span class=entity>lthy</span> <span class=entity>term</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>thm_refs</span><span class=main>,</span><span class=entity>ctxt2</span><span class=main>)</span> <span class=main>=</span> Variable.import true <span class=main>[</span>Proof_Context.get_thm <span class=entity>lthy</span> <span class=entity>term</span><span class=main>]</span> <span class=entity>ctxt1</span>
                    |&gt;&gt; <span class=main>#</span><span class=inner_numeral>2</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>vars'</span> <span class=main>=</span> map <span class=main>(</span>Thm.term_of o <span class=main>#</span><span class=inner_numeral>2</span><span class=main>)</span> <span class=entity>vars</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>tc_attrib</span> <span class=main>=</span> <span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>attributes</span> <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=antiquote>}</span></span></span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>r_tm</span> <span class=main>=</span> <span class=entity>tm</span> |&gt; <span class=entity>Utils.dest_lhs_def</span> |&gt; fold <span class=main>(</span><span class=keyword1><span class=keyword>op</span></span> <span class=entity>$`</span><span class=main>)</span> <span class=entity>vars'</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>concl</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> mem<span class=antiquote>}</span></span> $ <span class=entity>r_tm</span> $ <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> formula<span class=antiquote>}</span></span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>g</span> <span class=main>=</span> Logic.list_implies<span class=main>(</span><span class=entity>hyps</span><span class=main>,</span> <span class=entity>Utils.tp</span> <span class=entity>concl</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>thm</span> <span class=main>=</span> <span class=entity>prove_tc_form</span> <span class=entity>g</span> <span class=entity>thm_refs</span> <span class=entity>ctxt2</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>name</span> <span class=main>=</span> Binding.name <span class=main>(</span><span class=entity>def_name</span> ^ <span class=inner_quoted>"_type"</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>thm</span> <span class=main>=</span> <span class=entity>Utils.fix_vars</span> <span class=entity>thm</span> <span class=main>(</span>map <span class=main>(</span><span class=main>#</span><span class=inner_numeral>1</span> o dest_Free<span class=main>)</span> <span class=entity>vars'</span><span class=main>)</span> <span class=entity>ctxt2</span>
 <span class=keyword2><span class=keyword>in</span></span>
   Local_Theory.note <span class=main>(</span><span class=main>(</span><span class=entity>name</span><span class=main>,</span> <span class=entity>tc_attrib</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=entity>thm</span><span class=main>]</span><span class=main>)</span> <span class=entity>lthy</span> |&gt; <span class=entity>display</span> <span class=inner_quoted>"theorem"</span> <span class=entity>pos</span>
 <span class=keyword2><span class=keyword>end</span></span>


<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>synthetic_def</span> <span class=entity>def_name</span> <span class=entity>thmref</span> <span class=entity>pos</span> <span class=entity>tc</span> <span class=entity>auto</span> <span class=entity>thy</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>thm_ref</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>=</span> <span class=entity>thmref</span> |&gt;&gt; Facts.ref_name
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=entity>vars</span><span class=main>)</span><span class=main>,</span><span class=entity>thm_tms</span><span class=main>)</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>=</span> Variable.import true <span class=main>[</span>Proof_Context.get_thm <span class=entity>thy</span> <span class=entity>thm_ref</span><span class=main>]</span> <span class=entity>thy</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>tm</span><span class=main>,</span><span class=entity>hyps</span><span class=main>)</span> <span class=main>=</span> <span class=entity>thm_tms</span> |&gt; hd |&gt; <span class=entity>pair</span> Thm.concl_of Thm.prems_of
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>lhs</span><span class=main>,</span><span class=entity>rhs</span><span class=main>)</span> <span class=main>=</span> <span class=entity>tm</span> |&gt; <span class=entity>Utils.dest_iff_tms</span> o <span class=entity>Utils.dest_trueprop</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>(</span><span class=entity>set</span><span class=main>,</span><span class=entity>t</span><span class=main>)</span><span class=main>,</span><span class=entity>env</span><span class=main>)</span> <span class=main>=</span> <span class=entity>rhs</span> |&gt; <span class=entity>Utils.dest_sats_frm</span>
    <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>olist</span> <span class=entity>t</span> <span class=main>=</span> Ord_List.make String.compare <span class=main>(</span>Term.add_free_names <span class=entity>t</span> <span class=main>[</span><span class=main>]</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>relevant</span> <span class=entity>ts</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> mem<span class=antiquote>}</span></span> $ <span class=entity>t</span> $ <span class=main>_</span><span class=main>)</span> <span class=main>=</span> not <span class=main>(</span>Term.is_Free <span class=entity>t</span><span class=main>)</span> <span class=keyword1><span class=keyword>orelse</span></span>
        Ord_List.member String.compare <span class=entity>ts</span> <span class=main>(</span><span class=entity>t</span> |&gt; Term.dest_Free |&gt; <span class=main>#</span><span class=inner_numeral>1</span><span class=main>)</span>
      <span class=main>|</span> <span class=entity>relevant</span> <span class=main>_</span> <span class=main>_</span> <span class=main>=</span> false
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>t_vars</span> <span class=main>=</span> <span class=entity>olist</span> <span class=entity>t</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>vs</span> <span class=main>=</span> List.filter <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=entity>v</span><span class=main>,</span><span class=main>_</span><span class=main>)</span><span class=main>,</span><span class=main>_</span><span class=main>)</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>=&gt;</span> <span class=entity>Utils.inList</span> <span class=entity>v</span> <span class=entity>t_vars</span><span class=main>)</span> <span class=entity>vars</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>at</span> <span class=main>=</span> List.foldr <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>(</span><span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=entity>var</span><span class=main>)</span><span class=main>,</span><span class=entity>t'</span><span class=main>)</span> <span class=main>=&gt;</span> lambda <span class=main>(</span>Thm.term_of <span class=entity>var</span><span class=main>)</span> <span class=entity>t'</span><span class=main>)</span> <span class=entity>t</span> <span class=entity>vs</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>hyps'</span> <span class=main>=</span> List.filter <span class=main>(</span><span class=entity>relevant</span> <span class=entity>t_vars</span> o <span class=entity>Utils.dest_trueprop</span><span class=main>)</span> <span class=entity>hyps</span>
  <span class=keyword2><span class=keyword>in</span></span>
    Local_Theory.define <span class=main>(</span><span class=main>(</span>Binding.name <span class=entity>def_name</span><span class=main>,</span> NoSyn<span class=main>)</span><span class=main>,</span>
                        <span class=main>(</span><span class=main>(</span>Binding.name <span class=main>(</span><span class=entity>def_name</span> ^ <span class=inner_quoted>"_def"</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=main>]</span><span class=main>)</span><span class=main>,</span> <span class=entity>at</span><span class=main>)</span><span class=main>)</span> <span class=entity>thy</span> |&gt; <span class=main>#</span><span class=inner_numeral>2</span> |&gt;
    <span class=main>(</span><span class=keyword2><span class=keyword>if</span></span> <span class=entity>tc</span> <span class=keyword2><span class=keyword>then</span></span> <span class=entity>synth_thm_tc</span> <span class=entity>def_name</span> <span class=main>(</span><span class=entity>def_name</span> ^ <span class=inner_quoted>"_def"</span><span class=main>)</span> <span class=entity>hyps'</span> <span class=entity>vs</span> <span class=entity>pos</span> <span class=keyword2><span class=keyword>else</span></span> I<span class=main>)</span> |&gt;
    <span class=main>(</span><span class=keyword2><span class=keyword>if</span></span> <span class=entity>auto</span> <span class=keyword2><span class=keyword>then</span></span> <span class=entity>synth_thm_sats</span> <span class=entity>def_name</span> <span class=main>(</span><span class=entity>def_name</span> ^ <span class=inner_quoted>"_def"</span><span class=main>)</span> <span class=entity>lhs</span> <span class=entity>set</span> <span class=entity>env</span> <span class=entity>hyps</span> <span class=entity>vars</span> <span class=entity>vs</span> <span class=entity>pos</span> <span class=entity>thm_tms</span> <span class=keyword2><span class=keyword>else</span></span> I<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span>
›</span>
<span class=keyword1><span class=command>ML</span></span><span class=quoted>‹

<span class=keyword2><span class=keyword>local</span></span>
  <span class=keyword1><span class=keyword>val</span></span> <span class=entity>synth_constdecl</span> <span class=main>=</span>
       Parse.position <span class=main>(</span>Parse.string -- <span class=main>(</span><span class=main>(</span>Parse.$$$ <span class=inner_quoted>"from_schematic"</span> |-- Parse.thm<span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>;</span>

  <span class=keyword1><span class=keyword>val</span></span> <span class=main>_</span> <span class=main>=</span>
     <span class=entity>Outer_Syntax.local_theory</span> <span class=antiquoted><span class=entity><span class=operator><span class=hidden>\&lt;^</span><span class=control>command_keyword</span><span class=hidden>&gt;</span></span>‹<span class=keyword1>synthesize</span>›</span></span> <span class=inner_quoted>"ML setup for synthetic definitions"</span>
       <span class=main>(</span><span class=entity>synth_constdecl</span> &gt;&gt; <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>(</span><span class=main>(</span><span class=entity>bndg</span><span class=main>,</span><span class=entity>thm</span><span class=main>)</span><span class=main>,</span><span class=entity>p</span><span class=main>)</span> <span class=main>=&gt;</span> <span class=entity>synthetic_def</span> <span class=entity>bndg</span> <span class=entity>thm</span> <span class=entity>p</span> true true<span class=main>)</span><span class=main>)</span>

  <span class=keyword1><span class=keyword>val</span></span> <span class=main>_</span> <span class=main>=</span>
     <span class=entity>Outer_Syntax.local_theory</span> <span class=antiquoted><span class=entity><span class=operator><span class=hidden>\&lt;^</span><span class=control>command_keyword</span><span class=hidden>&gt;</span></span>‹<span class=keyword1>synthesize_notc</span>›</span></span> <span class=inner_quoted>"ML setup for synthetic definitions"</span>
       <span class=main>(</span><span class=entity>synth_constdecl</span> &gt;&gt; <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>(</span><span class=main>(</span><span class=entity>bndg</span><span class=main>,</span><span class=entity>thm</span><span class=main>)</span><span class=main>,</span><span class=entity>p</span><span class=main>)</span> <span class=main>=&gt;</span> <span class=entity>synthetic_def</span> <span class=entity>bndg</span> <span class=entity>thm</span> <span class=entity>p</span> false false<span class=main>)</span><span class=main>)</span>

<span class=keyword2><span class=keyword>in</span></span>

<span class=keyword2><span class=keyword>end</span></span>
›</span>
<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>ML</span><span class=hidden>&gt;</span></span></span>‹<span class=entity><span class=entity>synthetic_def</span></span>›</span></span> function extracts definitions from
schematic goals. A new definition is added to the context. ›</span></span>

<span class=comment1>(* example of use *)</span>
<span class=comment1>(*
schematic_goal mem_formula_ex :
  assumes "m∈nat" "n∈ nat" "env ∈ list(M)"
  shows "nth(m,env) ∈ nth(n,env) ⟷ sats(M,?frm,env)"
  by (insert assms ; (rule sep_rules empty_iff_sats cartprod_iff_sats | simp del:sats_cartprod_fm)+)

synthesize "φ" from_schematic mem_formula_ex
*)</span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Interface><div class=head><h1>Theory Interface</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Interface between set models and Constructibility›</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹This theory provides an interface between Paulson's
relativization results and set models of ZFC. In particular,
it is used to prove that the locale <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>forcing_data</span></span>›</span></span></span></span> is
a sublocale of all relevant locales in ZF-Constructibility
(<span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>M_trivial</span></span>›</span></span></span></span>, <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>M_basic</span></span>›</span></span></span></span>, <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>M_eclose</span></span>›</span></span></span></span>, etc).›</span></span>

<span class=keyword1><span class=command>theory</span></span> Interface
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Nat_Miscellanea.html>Nat_Miscellanea</a>
    <a href=Relative_Univ.html>Relative_Univ</a>
    <a href=Synthetic_Definition.html>Synthetic_Definition</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>syntax</span></span>
  <span class=quoted>"_sats"</span>  <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=quoted>"<span class=keyword3>(</span>_<span class=keyword1>,</span> _ <span class=keyword1>⊨</span> _<span class=keyword3>)</span>"</span> <span class=main>[</span>36<span class=main>,</span>36<span class=main>,</span>36<span class=main>]</span> 60<span class=main>)</span>
<span class=keyword1><span class=command>translations</span></span>
  <span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span> <span class=main>⇌</span> <span class=quoted>"<span class=keyword1>CONST</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>dec10</span>  <span class=main>::</span> <span class=quoted>i</span>   <span class=main>(</span><span class=quoted>"<span class=keyword1>10</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=free>10</span></span> <span class=main>≡</span> succ<span class=main>(</span><span class=main>9</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>dec11</span>  <span class=main>::</span> <span class=quoted>i</span>   <span class=main>(</span><span class=quoted>"<span class=keyword1>11</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=free>11</span></span> <span class=main>≡</span> succ<span class=main>(</span><span class=main>10</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>dec12</span>  <span class=main>::</span> <span class=quoted>i</span>   <span class=main>(</span><span class=quoted>"<span class=keyword1>12</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=free>12</span></span> <span class=main>≡</span> succ<span class=main>(</span><span class=main>11</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>dec13</span>  <span class=main>::</span> <span class=quoted>i</span>   <span class=main>(</span><span class=quoted>"<span class=keyword1>13</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=free>13</span></span> <span class=main>≡</span> succ<span class=main>(</span><span class=main>12</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>dec14</span>  <span class=main>::</span> <span class=quoted>i</span>   <span class=main>(</span><span class=quoted>"<span class=keyword1>14</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=free>14</span></span> <span class=main>≡</span> succ<span class=main>(</span><span class=main>13</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>infinity_ax</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i <span class=main>⇒</span> o<span class=main>)</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>infinity_ax</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span> <span class=main>≡</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>I</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>z</span><span class=main>∈</span><span class=bound>I</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=bound>y</span><span class=main>∈</span><span class=bound>I</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>sy</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> successor<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>sy</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>sy</span><span class=main>∈</span><span class=bound>I</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>choice_ax</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>choice_ax</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>x</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>a</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>f</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> ordinal<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> surjection<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>a</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>context</span></span> M_basic <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Interface-choice_ax_abs><span class=command>lemma</span></span> choice_ax_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"choice_ax<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>a</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>f</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>f</span> <span class=main>∈</span> surj<span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> choice_ax_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_basic *)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>wellfounded_trancl</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>=&gt;</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>=&gt;</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wellfounded_trancl</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>Z</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span>
      <span class=main>∃</span><span class=bound>w</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>wx</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>rp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>
               <span class=bound>w</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>Z</span></span></span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>w</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>wx</span><span class=main>)</span> <span class=main>&amp;</span> tran_closure<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=bound>rp</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>wx</span> <span class=main>∈</span> <span class=bound>rp</span>"</span></span>

<span class=keyword1 id=Interface-empty_intf><span class=command>lemma</span></span> empty_intf <span class=main>:</span>
  <span class=quoted><span class=quoted>"infinity_ax<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> empty<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> empty_def infinity_ax_def<span class=main>)</span>

<span class=keyword1 id=Interface-Transset_intf><span class=command>lemma</span></span> Transset_intf <span class=main>:</span>
  <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>  <span class=free>y</span><span class=main>∈</span><span class=free>x</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Transset_def<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1><span class=command>locale</span></span> M_ZF_trans <span class=main>=</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>M</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    upair_ax<span class=main>:</span>         <span class=quoted><span class=quoted>"upair_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Union_ax<span class=main>:</span>         <span class=quoted><span class=quoted>"Union_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> power_ax<span class=main>:</span>         <span class=quoted><span class=quoted>"power_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> extensionality<span class=main>:</span>   <span class=quoted><span class=quoted>"extensionality<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> foundation_ax<span class=main>:</span>    <span class=quoted><span class=quoted>"foundation_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> infinity_ax<span class=main>:</span>      <span class=quoted><span class=quoted>"infinity_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> separation_ax<span class=main>:</span>    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span>
                    separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> replacement_ax<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span>
                    strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> trans_M<span class=main>:</span>          <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>


<span class=keyword1 id=Interface-TranssetI><span class=command>lemma</span></span> TranssetI <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span><span class=bound>y</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=bound>x</span> <span class=main>⟹</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Transset_def<span class=main>)</span>

<span class=keyword1 id=Interface-zero_in_M><span class=command>lemma</span></span> zero_in_M<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> infinity_ax <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=main>##</span><span class=free>M</span><span class=main>].</span> empty<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> empty_intf<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>z</span></span> <span class=keyword2><span class=keyword>where</span></span>
    zm<span class=main>:</span> <span class=quoted><span class=quoted>"empty<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> trans_M <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>=</span><span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span>  <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> empty_def<span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Transset_intf <span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> zm <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Interface with <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹M_trivial›</span></span></span></span>›</span></span>
<span class=keyword1 id=Interface-mtrans><span class=command>lemma</span></span> mtrans <span class=main>:</span>
  <span class=quoted><span class=quoted>"M_trans<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Transset_intf<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>]</span> zero_in_M exI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>


<span class=keyword1 id=Interface-mtriv><span class=command>lemma</span></span> mtriv <span class=main>:</span>
  <span class=quoted><span class=quoted>"M_trivial<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> trans_M M_trivial.intro mtrans M_trivial_axioms.intro upair_ax Union_ax
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>sublocale</span></span> M_ZF_trans <span class=main>⊆</span> M_trivial <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mtriv<span class=main>)</span>

<span class=keyword1><span class=command>context</span></span> M_ZF_trans
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Interface with <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹M_basic›</span></span></span></span>›</span></span>

<span class=comment1>(* Inter_separation: "M(A) ⟹ separation(M, λx. ∀ y[M]. y∈A ⟹ x∈y)" *)</span>
<span class=keyword1><span class=command>schematic_goal</span></span> inter_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span> <span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=free>B</span> <span class=main>⟶</span> <span class=free>x</span><span class=main>∈</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?ifm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Interface-inter_sep_intf><span class=command>lemma</span></span> inter_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=main>.</span> <span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟶</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ifm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=main>(</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>∈</span><span class=bound>y</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>ifm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>ifm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>ifm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> inter_fm_auto
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>ifm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>a</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=skolem>a</span> <span class=main>⟶</span> <span class=skolem>x</span><span class=main>∈</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>ifm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=main>.</span> <span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=bound>a</span> <span class=main>⟶</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(* Diff_separation: "M(B) ⟹ separation(M, λx. x ∉ B)" *)</span>
<span class=keyword1><span class=command>schematic_goal</span></span> diff_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∉</span><span class=free>B</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?dfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Interface-diff_sep_intf><span class=command>lemma</span></span> diff_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>B</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∉</span><span class=free>B</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>dfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>∉</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>dfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>dfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>dfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> diff_fm_auto
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>dfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>b</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=skolem>b</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>dfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>b</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>b</span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>b</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∉</span><span class=bound>b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> cprod_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>z</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>C</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=free>C</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?cpfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-cartprod_sep_intf><span class=command>lemma</span></span> cartprod_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>B</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>cpfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cpfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>cpfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>cpfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> cprod_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cpfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>z</span><span class=main>,</span> <span class=bound>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=skolem>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=skolem>b</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cpfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span> <span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>a</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=bound>b</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> im_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>r</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>B</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?imfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Interface-image_sep_intf><span class=command>lemma</span></span> image_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>r</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>imfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>imfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>imfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>imfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> im_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>imfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>y</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=bound>a</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=skolem>k</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=skolem>a</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>imfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>k</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>k</span> <span class=skolem>a</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>k</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>k</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=bound>k</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>a</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>r</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> con_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>z</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>R</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>R</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?cfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-converse_sep_intf><span class=command>lemma</span></span> converse_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>R</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>cfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> con_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>z</span><span class=main>,</span><span class=bound>r</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=skolem>r</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
          sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=bound>r</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>R</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>schematic_goal</span></span> rest_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>z</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>C</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>C</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?rfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-restrict_sep_intf><span class=command>lemma</span></span> restrict_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>rfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>rfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>rfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rest_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>z</span><span class=main>,</span><span class=bound>a</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=skolem>a</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
          sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span> <span class=skolem>a</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>a</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> comp_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>xz</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>S</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>R</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>z</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xy</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>yz</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span>
              pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free>xz</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>xy</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>yz</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xy</span><span class=main>∈</span><span class=free>S</span> <span class=main>&amp;</span> <span class=bound>yz</span><span class=main>∈</span><span class=free>R</span><span class=main>)</span>
  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?cfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-comp_sep_intf><span class=command>lemma</span></span> comp_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>S</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>xz</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>z</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xy</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>yz</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
              pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>xz</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>xy</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>yz</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xy</span><span class=main>∈</span><span class=free>S</span> <span class=main>&amp;</span> <span class=bound>yz</span><span class=main>∈</span><span class=free>R</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>cfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>z</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xy</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>yz</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span> <span class=main>&amp;</span>
            pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>xy</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>yz</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xy</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>yz</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> comp_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>s</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>y</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>z</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xy</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>yz</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
              pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=skolem>xz</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>xy</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>yz</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xy</span><span class=main>∈</span><span class=skolem>s</span> <span class=main>&amp;</span> <span class=bound>yz</span><span class=main>∈</span><span class=skolem>r</span><span class=main>)</span>
          <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>cfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>xz</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>xz</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>xz</span> <span class=skolem>s</span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>xz</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>s</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>xz</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>z</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xy</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>yz</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
              pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>xz</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>xy</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>yz</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xy</span><span class=main>∈</span><span class=bound>s</span> <span class=main>&amp;</span> <span class=bound>yz</span><span class=main>∈</span><span class=bound>r</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>S</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>R</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>schematic_goal</span></span> pred_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>y</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>R</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>X</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>R</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>X</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?pfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-pred_sep_intf><span class=command>lemma</span></span> pred_sep_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>X</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>R</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>X</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>pfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>pfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>pfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pred_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>pfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>y</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=bound>x</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=skolem>r</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span>
          <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>pfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>r</span><span class=main>,</span><span class=skolem>x</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span> <span class=bound>y</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=bound>r</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>R</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Memrel_separation:
     "separation(M, λz. ∃x[M]. ∃y[M]. pair(M,x,y,z) &amp; x ∈ y)"
*)</span>
<span class=keyword1><span class=command>schematic_goal</span></span> mem_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>z</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?mfm</span><span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Interface-memrel_sep_intf><span class=command>lemma</span></span> memrel_sep_intf<span class=main>:</span>
  <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>mfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>mfm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>mfm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>mfm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> mem_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>mfm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>z</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>mfm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>z</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>z</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> recfun_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i3</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i4</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>g</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i5</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i6</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>b</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i2</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i3</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i4</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i5</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i6</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>xa</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xb</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=bound>xa</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xa</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=bound>xb</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xb</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>&amp;</span>
                  <span class=main>(</span><span class=main>∃</span><span class=bound>fx</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>gx</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=bound>fx</span><span class=main>)</span> <span class=main>&amp;</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=bound>gx</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>fx</span> <span class=main>≠</span> <span class=bound>gx</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?rffm</span><span class=main>(</span><span class=free>i1</span><span class=main>,</span><span class=free>i2</span><span class=main>,</span><span class=free>i3</span><span class=main>,</span><span class=free>i4</span><span class=main>,</span><span class=free>i5</span><span class=main>,</span><span class=free>i6</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-is_recfun_sep_intf><span class=command>lemma</span></span> is_recfun_sep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
                    pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=bound>xa</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xa</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=bound>xb</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xb</span> <span class=main>∈</span> <span class=free>r</span> <span class=main>&amp;</span>
                    <span class=main>(</span><span class=main>∃</span><span class=bound>fx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>gx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>fx</span><span class=main>)</span> <span class=main>&amp;</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>gx</span><span class=main>)</span> <span class=main>&amp;</span>
                                     <span class=bound>fx</span> <span class=main>≠</span> <span class=bound>gx</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>rffm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>xa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>4</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span><span class=bound>xa</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xa</span> <span class=main>∈</span> nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span>
    pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>5</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span><span class=bound>xb</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xb</span> <span class=main>∈</span> nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∃</span><span class=bound>fx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>gx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
    fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span><span class=bound>fx</span><span class=main>)</span> <span class=main>&amp;</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span><span class=bound>gx</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>fx</span> <span class=main>≠</span> <span class=bound>gx</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rffm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>rffm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>rffm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>6</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> recfun_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a1</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a2</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a3</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a4</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a5</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
        separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rffm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>a4</span><span class=main>,</span><span class=bound>a5</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>xa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=bound>xa</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xa</span> <span class=main>∈</span> <span class=skolem>a1</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a5</span><span class=main>,</span><span class=bound>xb</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xb</span> <span class=main>∈</span> <span class=skolem>a1</span> <span class=main>&amp;</span>
          <span class=main>(</span><span class=main>∃</span><span class=bound>fx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>gx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>fx</span><span class=main>)</span> <span class=main>&amp;</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>gx</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>fx</span> <span class=main>≠</span> <span class=bound>gx</span><span class=main>)</span><span class=main>)</span>
          <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rffm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>a5</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a5</span><span class=main>∈</span><span class=free>M</span>"</span></span>  <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>a1</span> <span class=skolem>a2</span> <span class=skolem>a3</span> <span class=skolem>a4</span> <span class=skolem>a5</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>a5</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a1</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a2</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a3</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a4</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a5</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span> <span class=bound>x</span> <span class=main>.</span>
          <span class=main>∃</span><span class=bound>xa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>xb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>a4</span><span class=main>,</span><span class=bound>xa</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xa</span> <span class=main>∈</span> <span class=bound>a1</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>a5</span><span class=main>,</span><span class=bound>xb</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>xb</span> <span class=main>∈</span> <span class=bound>a1</span> <span class=main>&amp;</span>
          <span class=main>(</span><span class=main>∃</span><span class=bound>fx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>gx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>fx</span><span class=main>)</span> <span class=main>&amp;</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>gx</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>fx</span> <span class=main>≠</span> <span class=bound>gx</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>r</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>g</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>b</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(* Instance of Replacement for M_basic *)</span>

<span class=keyword1><span class=command>schematic_goal</span></span> funsp_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>z</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>f</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>nb</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>cnbf</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>nb</span><span class=main>)</span> <span class=main>&amp;</span> is_cons<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>nb</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>)</span> <span class=main>&amp;</span>
    upair<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?fsfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Interface-funspace_succ_rep_intf><span class=command>lemma</span></span> funspace_succ_rep_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>
          <span class=main>λ</span><span class=bound>p</span> <span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>f</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>nb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>cnbf</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
                pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>nb</span><span class=main>)</span> <span class=main>&amp;</span> is_cons<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>nb</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>)</span> <span class=main>&amp;</span>
                upair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>fsfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>f</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>nb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>cnbf</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>nb</span><span class=main>)</span>
      <span class=main>&amp;</span> is_cons<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>nb</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>)</span> <span class=main>&amp;</span> upair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>fsfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=skolem>fsfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>fsfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>env</span>
    <span class=keyword1><span class=command>using</span></span> funsp_fm_auto<span class=main>[</span><span class=operator>of</span> <span class=quasi_keyword>concl</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>M</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n0</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>p</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>fsfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>p</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>n0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>f</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>nb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>cnbf</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=skolem>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>n0</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>nb</span><span class=main>)</span> <span class=main>&amp;</span>
          is_cons<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>nb</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>)</span> <span class=main>&amp;</span> upair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span><span class=main>)</span>
          <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>fsfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>n0</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span> <span class=skolem>z</span> <span class=skolem>n0</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>n0</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n0</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span> <span class=bound>p</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>f</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>nb</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>cnbf</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span> <span class=main>&amp;</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>n0</span><span class=main>,</span><span class=bound>b</span><span class=main>,</span><span class=bound>nb</span><span class=main>)</span> <span class=main>&amp;</span>
          is_cons<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>nb</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>)</span> <span class=main>&amp;</span> upair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>cnbf</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> strong_replacement_def univalent_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(* Interface with M_basic *)</span>

<span class=keyword1><span class=command>lemmas</span></span> M_basic_sep_instances <span class=main>=</span>
  inter_sep_intf diff_sep_intf cartprod_sep_intf
  image_sep_intf converse_sep_intf restrict_sep_intf
  pred_sep_intf memrel_sep_intf comp_sep_intf is_recfun_sep_intf

<span class=keyword1 id=Interface-mbasic><span class=command>lemma</span></span> mbasic <span class=main>:</span> <span class=quoted><span class=quoted>"M_basic<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> trans_M zero_in_M power_ax M_basic_sep_instances funspace_succ_rep_intf mtriv
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=command>sublocale</span></span> M_ZF_trans <span class=main>⊆</span> M_basic <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mbasic<span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Interface with <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹M_trancl›</span></span></span></span>›</span></span>

<span class=comment1>(* rtran_closure_mem *)</span>
<span class=keyword1><span class=command>schematic_goal</span></span> rtran_closure_mem_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>k</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"rtran_closure_mem<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?rcfm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>k</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rtran_closure_mem_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> rtrancl_separation_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> rtran_closure_mem<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>rcfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span>rtran_closure_mem<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rtran_closure_mem_auto <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>a</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>rtran_closure_mem<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span>
          <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>a</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> rtran_closure_mem<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>a</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>r</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> rtran_closure_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>rp</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"rtran_closure<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>rp</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?rtc</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rtran_closure_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules rtran_closure_mem_auto <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>schematic_goal</span></span> trans_closure_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>rp</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"tran_closure<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>rp</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?tc</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> tran_closure_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules rtran_closure_fm_auto <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"trans_closure_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> trans_closure_fm_auto

<span class=keyword1><span class=command>schematic_goal</span></span> wellfounded_trancl_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>r</span>"</span></span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>k</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"wellfounded_trancl<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?wtf</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>k</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span>  wellfounded_trancl_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules trans_closure_fm_iff_sats <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> wftrancl_separation_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>Z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> wellfounded_trancl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>Z</span><span class=main>,</span><span class=free>r</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>rcfm</span></span> <span class=keyword2><span class=keyword>where</span></span>
    fmsats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=main>(</span>wellfounded_trancl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wellfounded_trancl_fm_auto<span class=main>[</span><span class=operator>of</span> <span class=quasi_keyword>concl</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> fm_defs trans_closure_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>z</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>wellfounded_trancl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span>
          <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>rcfm</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that fmsats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>z</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> wellfounded_trancl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>r</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>Z</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* nat ∈ M *)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> finite_sep_intf<span class=main>:</span>
  <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>nat<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>finite_ordinal_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> "</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> finite_ordinal_fm_def limit_ordinal_fm_def empty_fm_def succ_fm_def cons_fm_def
      union_fm_def upair_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_union_abs1 Un_commute<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> separation_ax
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>v</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>finite_ordinal_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>v</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>finite_ordinal<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>finite_ordinal<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> zero_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> nat_subset_I' <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>I</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=main>0</span><span class=main>∈</span><span class=free>I</span> <span class=main>;</span> <span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>I</span> <span class=main>⟹</span> succ<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>∈</span><span class=free>I</span> <span class=main>⟧</span> <span class=main>⟹</span> nat <span class=main>⊆</span> <span class=free>I</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> subsetI<span class=main><span class=keyword3>,</span></span><span class=operator>induct_tac</span> x<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> nat_subset_I <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>I</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> nat <span class=main>⊆</span> <span class=bound>I</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>I</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>0</span><span class=main>∈</span><span class=bound>I</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>I</span> <span class=main>⟶</span> succ<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>∈</span><span class=bound>I</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> infinity_ax <span class=keyword1><span class=command>unfolding</span></span> infinity_ax_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=skolem>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=skolem>I</span> <span class=main>⟶</span> succ<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>∈</span><span class=skolem>I</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=skolem>I</span> <span class=main>⟹</span> succ<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>∈</span><span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Transset_intf<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>]</span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nat<span class=main>⊆</span><span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=skolem>I</span>›</span></span> nat_subset_I' <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> nat_in_M <span class=main>:</span>
  <span class=quoted><span class=quoted>"nat <span class=main>∈</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=skolem>B</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=skolem>A</span><span class=main>}</span><span class=main>=</span><span class=skolem>A</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>A</span><span class=main>⊆</span><span class=skolem>B</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>A</span> <span class=skolem>B</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"nat<span class=main>⊆</span><span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nat_subset_I <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=skolem>I</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>nat<span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> finite_sep_intf separation_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span>nat"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹nat<span class=main>⊆</span><span class=skolem>I</span>›</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>
  <span class=comment1>(* end nat ∈ M *)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> mtrancl <span class=main>:</span> <span class=quoted><span class=quoted>"M_trancl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span>  mbasic rtrancl_separation_intf wftrancl_separation_intf nat_in_M
    wellfounded_trancl_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ZF_trans <span class=main>⊆</span> M_trancl <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mtrancl<span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Interface with <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹M_eclose›</span></span></span></span>›</span></span>

<span class=keyword1 id=Interface-repl_sats><span class=command>lemma</span></span> repl_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    sat<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
   strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> strong_replacement_cong<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sat<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> nat_trans_M <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=free>n</span>
  <span class=keyword1><span class=command>using</span></span> that nat_in_M Transset_intf<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> list_repl1_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"iterates_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span>nat›</span></span> nat_trans_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span>nat›</span></span> Memrel_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  nat_0I nat_trans_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=skolem>a</span><span class=main>,</span> <span class=skolem>b</span><span class=main>)</span>
       <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span> <span class=skolem>a0</span> <span class=skolem>a1</span> <span class=skolem>a2</span> <span class=skolem>a3</span> <span class=skolem>a4</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that 1 <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> list_functor_iff_sats <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> iterates_MH_fm<span class=main>(</span>list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>10</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>
        <span class=main>⟷</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a0</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a0</span> <span class=skolem>a1</span> <span class=skolem>a2</span> <span class=skolem>a3</span> <span class=skolem>a4</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that sats_iterates_MH_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=main>_</span><span class=main>]</span> 1 <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_wfrec_fm<span class=main>(</span>iterates_MH_fm<span class=main>(</span>list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>10</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
                            <span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>
        <span class=main>⟷</span>
        is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span> <span class=main>,</span> Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span>  that sats_is_wfrec_fm 1 <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>let</span></span>
      <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
               is_wfrec_fm<span class=main>(</span>iterates_MH_fm<span class=main>(</span>list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>10</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>
        <span class=main>⟷</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span>
        is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span> <span class=main>,</span> Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that 2 1 <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> iterates_MH_fm_def is_wfrec_fm_def is_recfun_fm_def is_nat_case_fm_def
        restriction_fm_def list_functor_fm_def number1_fm_def cartprod_fm_def
        sum_fm_def quasinat_fm_def pre_image_fm_def fm_defs
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> replacement_ax 1 <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span> <span class=main>,</span>
                Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>]</span>"</span></span><span class=main>]</span>  satsf <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> iterates_replacement_def wfrec_replacement_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>



<span class=comment1>(* Iterates_replacement para predicados sin parámetros *)</span>
<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> iterates_repl_intf <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>v</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    isfm<span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>is_F_fm</span> <span class=main>∈</span> formula"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    arty<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>is_F_fm</span><span class=main>)</span><span class=main>=</span><span class=main>2</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    satsf<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span> <span class=bound>b</span> <span class=bound>env'</span><span class=main>.</span> <span class=main>⟦</span> <span class=bound>a</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=bound>b</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=bound>env'</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟧</span>
              <span class=main>⟹</span> <span class=free>is_F</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>is_F_fm</span><span class=main>,</span> <span class=main>[</span><span class=bound>b</span><span class=main>,</span><span class=bound>a</span><span class=main>]</span><span class=main>@</span><span class=bound>env'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"iterates_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_F</span><span class=main>,</span><span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span>nat›</span></span> nat_trans_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span>nat›</span></span> Memrel_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a0</span> <span class=skolem>a1</span> <span class=skolem>a2</span> <span class=skolem>a3</span> <span class=skolem>a4</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword3><span class=command>assume</span></span> as<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>a0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>is_F_fm</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>b</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>c</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>d</span><span class=main>,</span><span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
          <span class=main>⟷</span> <span class=free>is_F</span><span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span>
        <span class=keyword1><span class=command>using</span></span> as that 1 satsf<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>a</span></span> <span class=quoted><span class=skolem>b</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=free>v</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> iterates_MH_fm<span class=main>(</span><span class=free>is_F_fm</span><span class=main>,</span><span class=main>9</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span><span class=main>)</span>
          <span class=main>⟷</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_F</span><span class=main>,</span><span class=free>v</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a0</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> as
          sats_iterates_MH_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"<span class=free>is_F</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>is_F_fm</span>"</span></span><span class=main>]</span> 1 <span class=quoted><span class=quoted>‹<span class=free>v</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_wfrec_fm<span class=main>(</span>iterates_MH_fm<span class=main>(</span><span class=free>is_F_fm</span><span class=main>,</span><span class=main>9</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
                            <span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span><span class=main>)</span>
        <span class=main>⟷</span>
        is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_F</span><span class=main>,</span><span class=free>v</span><span class=main>)</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span>  that sats_is_wfrec_fm 1 <span class=quoted><span class=quoted>‹<span class=free>v</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>let</span></span>
      <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
               is_wfrec_fm<span class=main>(</span>iterates_MH_fm<span class=main>(</span><span class=free>is_F_fm</span><span class=main>,</span><span class=main>9</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span><span class=main>)</span>
        <span class=main>⟷</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span>
        is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_F</span><span class=main>,</span><span class=free>v</span><span class=main>)</span> <span class=main>,</span> Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that 2 1 <span class=quoted><span class=quoted>‹<span class=free>v</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> iterates_MH_fm_def is_wfrec_fm_def is_recfun_fm_def is_nat_case_fm_def
        restriction_fm_def pre_image_fm_def quasinat_fm_def fm_defs
      <span class=keyword1><span class=command>using</span></span> arty <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> replacement_ax 1 <span class=quoted><span class=quoted>‹<span class=free>v</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>is_F_fm</span><span class=main>∈</span>formula›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> iterates_MH<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_F</span><span class=main>,</span><span class=free>v</span><span class=main>)</span> <span class=main>,</span>
                Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span>Memrel<span class=main>(</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>v</span><span class=main>]</span>"</span></span><span class=main>]</span>  satsf <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> iterates_replacement_def wfrec_replacement_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> formula_repl1_intf <span class=main>:</span>
  <span class=quoted><span class=quoted>"iterates_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  nat_0I nat_trans_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span>formula_functor_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> formula_functor_fm_def fm_defs sum_fm_def cartprod_fm_def number1_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"formula_functor_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟷</span>
        sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> formula_functor_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span>  <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> 1 2 iterates_repl_intf <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> nth_repl_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"iterates_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>l'</span> <span class=bound>t</span><span class=main>.</span> is_tl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>l'</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span><span class=main>,</span><span class=free>l</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span>tl_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> tl_fm_def fm_defs quasilist_fm_def Cons_fm_def Nil_fm_def Inr_fm_def number1_fm_def
      Inl_fm_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"tl_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_tl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> tl_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>l</span><span class=main>∈</span><span class=free>M</span>›</span></span> 1 2 iterates_repl_intf <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> eclose_repl1_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"iterates_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=free>A</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span>big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> big_union_fm_def fm_defs <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> 1 2 iterates_repl_intf <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(*
    and list_replacement2:
   "M(A) ⟹ strong_replacement(M,
         λn y. n∈nat &amp; is_iterates(M, is_list_functor(M,A), 0, n, y))"

*)</span>
<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> list_repl2_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>n</span><span class=main>∈</span>nat <span class=main>&amp;</span> is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=bound>n</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  nat_0I nat_trans_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟷</span>
        sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>e</span><span class=main>,</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>g</span><span class=main>,</span><span class=skolem>h</span><span class=main>,</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>j</span><span class=main>,</span><span class=skolem>k</span><span class=main>,</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>g</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>h</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span> <span class=skolem>e</span> <span class=skolem>f</span> <span class=skolem>g</span> <span class=skolem>h</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=skolem>k</span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_iterates_fm<span class=main>(</span>list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span> <span class=main>)</span> <span class=main>⟷</span>
           is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=skolem>n</span> <span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M
      sats_is_iterates_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>4</span><span class=main>)</span><span class=main>,</span>is_iterates_fm<span class=main>(</span>list_functor_fm<span class=main>(</span><span class=main>13</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span> <span class=main>)</span> <span class=main>⟷</span>
        <span class=skolem>n</span><span class=main>∈</span>nat <span class=main>&amp;</span> is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_list_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=skolem>n</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_iterates_fm_def restriction_fm_def list_functor_fm_def number1_fm_def Memrel_fm_def
      cartprod_fm_def sum_fm_def quasinat_fm_def pre_image_fm_def fm_defs is_wfrec_fm_def
      is_recfun_fm_def iterates_MH_fm_def is_nat_case_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>n</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax 1 nat_in_M <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>A</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span>"</span></span><span class=main>]</span>  satsf  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> formula_repl2_intf<span class=main>:</span>
  <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>n</span><span class=main>∈</span>nat <span class=main>&amp;</span> is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=bound>n</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  nat_0I nat_trans_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟷</span>
        sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>formula_functor_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>e</span><span class=main>,</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>g</span><span class=main>,</span><span class=skolem>h</span><span class=main>,</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>j</span><span class=main>,</span><span class=skolem>k</span><span class=main>,</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>g</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>h</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span> <span class=skolem>e</span> <span class=skolem>f</span> <span class=skolem>g</span> <span class=skolem>h</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=skolem>k</span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_iterates_fm<span class=main>(</span>formula_functor_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span> <span class=main>)</span> <span class=main>⟷</span>
           is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=skolem>n</span> <span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M
      sats_is_iterates_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>is_iterates_fm<span class=main>(</span>formula_functor_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span> <span class=main>)</span> <span class=main>⟷</span>
        <span class=skolem>n</span><span class=main>∈</span>nat <span class=main>&amp;</span> is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_formula_functor<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=skolem>n</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> artyf<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_iterates_fm_def formula_functor_fm_def fm_defs sum_fm_def quasinat_fm_def
      cartprod_fm_def number1_fm_def Memrel_fm_def ordinal_fm_def transset_fm_def
      is_wfrec_fm_def is_recfun_fm_def iterates_MH_fm_def is_nat_case_fm_def subset_fm_def
      pre_image_fm_def restriction_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>n</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax 1 artyf <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>0</span><span class=main>,</span>nat<span class=main>]</span>"</span></span><span class=main>]</span>  satsf  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(*
   "M(A) ⟹ strong_replacement(M,
         λn y. n∈nat &amp; is_iterates(M, big_union(M), A, n, y))"
*)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> eclose_repl2_intf<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>n</span><span class=main>∈</span>nat <span class=main>&amp;</span> is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=bound>n</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟷</span>
        sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>e</span><span class=main>,</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>g</span><span class=main>,</span><span class=skolem>h</span><span class=main>,</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>j</span><span class=main>,</span><span class=skolem>k</span><span class=main>,</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span>nat<span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>g</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>h</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span> <span class=skolem>e</span> <span class=skolem>f</span> <span class=skolem>g</span> <span class=skolem>h</span> <span class=skolem>i</span> <span class=skolem>j</span> <span class=skolem>k</span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_iterates_fm<span class=main>(</span>big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span>nat<span class=main>]</span> <span class=main>)</span> <span class=main>⟷</span>
           is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=skolem>n</span> <span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M
      sats_is_iterates_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>is_iterates_fm<span class=main>(</span>big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span>nat<span class=main>]</span> <span class=main>)</span> <span class=main>⟷</span>
        <span class=skolem>n</span><span class=main>∈</span>nat <span class=main>&amp;</span> is_iterates<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> big_union<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span> <span class=free>A</span><span class=main>,</span> <span class=skolem>n</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> artyf<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_iterates_fm_def formula_functor_fm_def fm_defs sum_fm_def quasinat_fm_def
      cartprod_fm_def number1_fm_def Memrel_fm_def ordinal_fm_def transset_fm_def
      is_wfrec_fm_def is_recfun_fm_def iterates_MH_fm_def is_nat_case_fm_def subset_fm_def
      pre_image_fm_def restriction_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>n</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>A</span><span class=main>,</span>nat<span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax 1 artyf <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> nat_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>A</span><span class=main>,</span>nat<span class=main>]</span>"</span></span><span class=main>]</span>  satsf  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> mdatatypes <span class=main>:</span> <span class=quoted><span class=quoted>"M_datatypes<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span>  mtrancl list_repl1_intf list_repl2_intf formula_repl1_intf
    formula_repl2_intf nth_repl_intf
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ZF_trans <span class=main>⊆</span> M_datatypes <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> mdatatypes<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> meclose <span class=main>:</span> <span class=quoted><span class=quoted>"M_eclose<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> mdatatypes eclose_repl1_intf eclose_repl2_intf
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ZF_trans <span class=main>⊆</span> M_eclose <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> meclose<span class=main>)</span>

<span class=comment1>(* Interface with locale M_eclose_pow *)</span>

<span class=comment1>(* "powerset(M,A,z) ≡ ∀x[M]. x ∈ z ⟷ subset(M,x,A)" *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>powerset_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>powerset_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Forall<span class=main>(</span>Iff<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span>subset_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Interface-powerset_type><span class=command>lemma</span></span> powerset_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> powerset_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>powerset_fm_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_powapply_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_powapply_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span>
      Exists<span class=main>(</span>And<span class=main>(</span>fun_apply_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>,</span>
            Forall<span class=main>(</span>Iff<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span> succ<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
            Forall<span class=main>(</span>Implies<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>1</span><span class=main>)</span><span class=main>,</span> Member<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Interface-is_powapply_type><span class=command>lemma</span></span> is_powapply_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>f</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> is_powapply_fm<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_powapply_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Interface-sats_is_powapply_fm><span class=command>lemma</span></span> sats_is_powapply_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_powapply<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_powapply_fm<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_powapply_def is_powapply_fm_def is_Collect_def powerset_def subset_def
  <span class=keyword1><span class=command>using</span></span> nth_closed assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> powapply_repl <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_powapply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>is_powapply_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_powapply_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f0</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>p</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_powapply_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>p</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>f0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_powapply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>f0</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_powapply_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>f0</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span> <span class=skolem>z</span> <span class=skolem>f0</span>
    <span class=keyword1><span class=command>using</span></span> that zero_in_M sats_is_powapply_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>2</span></span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>f0</span><span class=main>]</span>"</span></span> <span class=quoted><span class=free>M</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f0</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_powapply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f0</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> strong_replacement_def univalent_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(*"PHrank(M,f,y,z) ≡ M(z) ∧ (∃fy[M]. fun_apply(M,f,y,fy) ∧ successor(M,fy,z))"*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>PHrank_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PHrank_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>fun_apply_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>
                                 <span class=main>,</span>succ_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Interface-PHrank_type><span class=command>lemma</span></span> PHrank_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> PHrank_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>PHrank_fm_def<span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> sats_PHrank_fm <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat<span class=main>;</span>  <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>PHrank_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        PHrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> zero_in_M Internalizations.nth_closed <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> PHrank_def PHrank_fm_def<span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> phrank_repl <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>PHrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>PHrank_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> PHrank_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f0</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>p</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>PHrank_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>p</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>f0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f0</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> PHrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f0</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> strong_replacement_def univalent_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(*"is_Hrank(M,x,f,hc) ≡ (∃R[M]. big_union(M,R,hc) ∧is_Replace(M,x,PHrank(M,f),R)) "*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Hrank_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Hrank_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>big_union_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                                Replace_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>,</span>PHrank_fm<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Interface-is_Hrank_type><span class=command>lemma</span></span> is_Hrank_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> is_Hrank_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>is_Hrank_fm_def<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> sats_is_Hrank_fm <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_Hrank_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_Hrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> zero_in_M is_Hrank_def is_Hrank_fm_def sats_Replace_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* M(x) ⟹ wfrec_replacement(M,is_Hrank(M),rrank(x)) *)</span>
<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> wfrec_rank <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>X</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"wfrec_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>,</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"is_Hrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a0</span><span class=main>)</span> <span class=main>⟷</span>
             sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_Hrank_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a4</span> <span class=skolem>a3</span> <span class=skolem>a2</span> <span class=skolem>a1</span> <span class=skolem>a0</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that rrank_in_M <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span>
    1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_wfrec_fm<span class=main>(</span>is_Hrank_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>
  <span class=main>⟷</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span> <span class=main>,</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rrank_in_M sats_is_wfrec_fm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>is_wfrec_fm<span class=main>(</span>is_Hrank_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>
              <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span> <span class=main>,</span> rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that 1 <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rrank_in_M <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_wfrec_fm_def is_recfun_fm_def is_nat_case_fm_def is_Hrank_fm_def PHrank_fm_def
      restriction_fm_def list_functor_fm_def number1_fm_def cartprod_fm_def
      sum_fm_def quasinat_fm_def pre_image_fm_def fm_defs
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax 1 <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rrank_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hrank<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span> <span class=main>,</span> rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span>rrank<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span>"</span></span><span class=main>]</span>  satsf <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> wfrec_replacement_def  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(*"is_HVfrom(M,A,x,f,h) ≡ ∃U[M]. ∃R[M].  union(M,A,U,h)
        ∧ big_union(M,R,U) ∧ is_Replace(M,x,is_powapply(M,f),R)"*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_HVfrom_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_HVfrom_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>h</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>union_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>h</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>)</span><span class=main>,</span>
                            And<span class=main>(</span>big_union_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
                            Replace_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span>is_powapply_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Interface-is_HVfrom_type><span class=command>lemma</span></span> is_HVfrom_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>A</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>f</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>h</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> is_HVfrom_fm<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>h</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>is_HVfrom_fm_def<span class=main>)</span>

<span class=keyword1 id=Interface-sats_is_HVfrom_fm><span class=command>lemma</span></span> sats_is_HVfrom_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>a</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>f</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>h</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>;</span> <span class=main>0</span><span class=main>∈</span><span class=free>A</span><span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_HVfrom_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> is_HVfrom_def is_HVfrom_fm_def sats_Replace_fm<span class=main>[</span><span class=operator>OF</span> sats_is_powapply_fm<span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Interface-is_HVfrom_iff_sats><span class=command>lemma</span></span> is_HVfrom_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>xx</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ff</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>hh</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>,</span><span class=free>xx</span><span class=main>,</span><span class=free>ff</span><span class=main>,</span><span class=free>hh</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> is_HVfrom_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sats_is_HVfrom_fm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* FIX US *)</span>
<span class=keyword1><span class=command>schematic_goal</span></span> sats_is_Vset_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_Vset<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>v</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?ivs_fm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>v</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Vset_def is_Vfrom_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules is_HVfrom_iff_sats is_transrec_iff_sats <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>schematic_goal</span></span> is_Vset_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ii</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>v</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>vv</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_Vset<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>ii</span><span class=main>,</span><span class=free>vv</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=var>?ivs_fm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>v</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ii</span>›</span></span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=quoted><span class=quoted>‹nth<span class=main>(</span><span class=free>v</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>vv</span>›</span></span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sats_is_Vset_fm_auto<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>assms<span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> memrel_eclose_sing <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>sa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>esa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>mesa</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
       upair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=bound>sa</span><span class=main>)</span> <span class=main>&amp;</span> is_eclose<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>sa</span><span class=main>,</span><span class=bound>esa</span><span class=main>)</span> <span class=main>&amp;</span> membership<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>esa</span><span class=main>,</span><span class=bound>mesa</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> upair_ax eclose_closed Memrel_closed <span class=keyword1><span class=command>unfolding</span></span> upair_ax_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>upair_abs<span class=main>)</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> trans_repl_HVFrom <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"transrec_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=free>i</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>mesa</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>mesa</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span>
      0<span class=main>:</span><span class=quoted><span class=quoted>"is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a0</span><span class=main>)</span> <span class=main>⟷</span>
      sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_HVfrom_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a0</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a4</span> <span class=skolem>a3</span> <span class=skolem>a2</span> <span class=skolem>a1</span> <span class=skolem>a0</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that zero_in_M sats_is_HVfrom_fm <span class=quoted><span class=quoted>‹<span class=skolem>mesa</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span>
      1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_wfrec_fm<span class=main>(</span>is_HVfrom_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>]</span><span class=main>)</span>
        <span class=main>⟷</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>mesa</span><span class=main>∈</span><span class=free>M</span>›</span></span> sats_is_wfrec_fm<span class=main>[</span><span class=operator>OF</span> 0<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>let</span></span>
      <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>is_wfrec_fm<span class=main>(</span>is_HVfrom_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>]</span><span class=main>)</span>
              <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span> <span class=main>,</span> <span class=skolem>mesa</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that 1 <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>mesa</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> is_HVfrom_fm_def is_wfrec_fm_def is_recfun_fm_def is_nat_case_fm_def
        restriction_fm_def list_functor_fm_def number1_fm_def cartprod_fm_def
        is_powapply_fm_def sum_fm_def quasinat_fm_def pre_image_fm_def fm_defs
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> replacement_ax 1 <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>mesa</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span> <span class=main>,</span> <span class=skolem>mesa</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>A</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>]</span>"</span></span><span class=main>]</span>  satsf <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wfrec_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_HVfrom<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>,</span><span class=skolem>mesa</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> wfrec_replacement_def  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> transrec_replacement_def
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>i</span><span class=main>∈</span><span class=free>M</span>›</span></span> memrel_eclose_sing <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> meclose_pow <span class=main>:</span> <span class=quoted><span class=quoted>"M_eclose_pow<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> meclose power_ax powapply_repl phrank_repl trans_repl_HVFrom wfrec_rank
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ZF_trans <span class=main>⊆</span> M_eclose_pow <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> meclose_pow<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> repl_gen <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    f_abs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>⟦</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>is_F</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    f_sats<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span>
             sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_F</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    f_form<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>f_fm</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    f_arty<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>f_fm</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_F</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that f_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=skolem>y</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> f_form f_arty
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> replacement_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>is_F</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> strong_replacement_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>is_F</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> f_abs <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> strong_replacement_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>is_F</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Proof Scheme for instances of separation *)</span>
<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ZF_trans<span class=main>)</span> sep_in_M <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    satsQ<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span> <span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span>
      <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> satsQ trans_M
      separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span>"</span></span><span class=main>]</span>
      separation_closed  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Forcing_Data><div class=head><h1>Theory Forcing_Data</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Transitive set models of ZF›</span></span>
<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹This theory defines the locale <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>M_ZF_trans</span></span>›</span></span></span></span> for
transitive models of ZF, and the associated <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>forcing_data</span></span>›</span></span></span></span>
 that adds a forcing notion›</span></span>
<span class=keyword1><span class=command>theory</span></span> Forcing_Data
  <span class=keyword2><span class=keyword>imports</span></span>  
    <a href=Forcing_Notions.html>Forcing_Notions</a> 
    <a href=Interface.html>Interface</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Forcing_Data-Transset_M><span class=command>lemma</span></span> Transset_M <span class=main>:</span>
  <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>  <span class=free>y</span><span class=main>∈</span><span class=free>x</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Transset_def<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>  


<span class=keyword1><span class=command>locale</span></span> M_ZF <span class=main>=</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>M</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> 
    upair_ax<span class=main>:</span>         <span class=quoted><span class=quoted>"upair_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> Union_ax<span class=main>:</span>         <span class=quoted><span class=quoted>"Union_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> power_ax<span class=main>:</span>         <span class=quoted><span class=quoted>"power_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> extensionality<span class=main>:</span>   <span class=quoted><span class=quoted>"extensionality<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> foundation_ax<span class=main>:</span>    <span class=quoted><span class=quoted>"foundation_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> infinity_ax<span class=main>:</span>      <span class=quoted><span class=quoted>"infinity_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> separation_ax<span class=main>:</span>    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span>
                    separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword2><span class=keyword>and</span></span> replacement_ax<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span> 
                    strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 

<span class=keyword1><span class=command>locale</span></span> M_ctm <span class=main>=</span> M_ZF <span class=main>+</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>enum</span>
  <span class=keyword2><span class=keyword>assumes</span></span> M_countable<span class=main>:</span>      <span class=quoted><span class=quoted>"<span class=free>enum</span><span class=main>∈</span>bij<span class=main>(</span>nat<span class=main>,</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> trans_M<span class=main>:</span>          <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>begin</span></span>
<span class=keyword1><span class=command>interpretation</span></span> intf<span class=main>:</span> M_ZF_trans <span class=quoted><span class=quoted>"<span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> M_ZF_trans.intro
    trans_M upair_ax Union_ax power_ax extensionality
    foundation_ax infinity_ax separation_ax<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span> 
    replacement_ax<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>lemmas</span></span> transitivity <span class=main>=</span> Transset_intf<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>]</span>

<span class=keyword1 id=Forcing_Data-zero_in_M><span class=command>lemma</span></span> zero_in_M<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.zero_in_M<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-tuples_in_M><span class=command>lemma</span></span> tuples_in_M<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>B</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>⟩</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span>setclass_iff<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-nat_in_M><span class=command>lemma</span></span> nat_in_M <span class=main>:</span> <span class=quoted><span class=quoted>"nat <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.nat_in_M<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-n_in_M><span class=command>lemma</span></span> n_in_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>n</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> nat_in_M transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Data-mtriv><span class=command>lemma</span></span> mtriv<span class=main>:</span> <span class=quoted><span class=quoted>"M_trivial<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.mtriv<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-mtrans><span class=command>lemma</span></span> mtrans<span class=main>:</span> <span class=quoted><span class=quoted>"M_trans<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.mtrans<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-mbasic><span class=command>lemma</span></span> mbasic<span class=main>:</span> <span class=quoted><span class=quoted>"M_basic<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.mbasic<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-mtrancl><span class=command>lemma</span></span> mtrancl<span class=main>:</span> <span class=quoted><span class=quoted>"M_trancl<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.mtrancl<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-mdatatypes><span class=command>lemma</span></span> mdatatypes<span class=main>:</span> <span class=quoted><span class=quoted>"M_datatypes<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.mdatatypes<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-meclose><span class=command>lemma</span></span> meclose<span class=main>:</span> <span class=quoted><span class=quoted>"M_eclose<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.meclose<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-meclose_pow><span class=command>lemma</span></span> meclose_pow<span class=main>:</span> <span class=quoted><span class=quoted>"M_eclose_pow<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> intf.meclose_pow<span class=main>)</span>



<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_ctm *)</span>

<span class=comment1>(* M_ctm interface *)</span>
<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_trivial <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> mtriv<span class=main>)</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_trans <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> mtrans<span class=main>)</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_basic <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> mbasic<span class=main>)</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_trancl <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> mtrancl<span class=main>)</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_datatypes <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> mdatatypes<span class=main>)</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_eclose <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> meclose<span class=main>)</span>

<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_eclose_pow <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>rule</span> meclose_pow<span class=main>)</span>

<span class=comment1>(* end interface *)</span>

<span class=keyword1><span class=command>context</span></span> M_ctm
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹<span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>Collects</span></span>›</span></span></span></span> in $M$›</span></span>
<span class=keyword1 id=Forcing_Data-Collect_in_M_0p><span class=command>lemma</span></span> Collect_in_M_0p <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    Qfm <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>Q_fm</span> <span class=main>∈</span> formula"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qarty <span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>Q_fm</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qsats <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qabs  <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>Q</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>Q</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Qabs Collect_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax Qsats Qarty Qfm
      separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>y</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_closed <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Data-Collect_in_M_2p><span class=command>lemma</span></span> Collect_in_M_2p <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    Qfm <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>Q_fm</span> <span class=main>∈</span> formula"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qarty <span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>Q_fm</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    params_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qsats <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qabs  <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Qabs Collect_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax Qsats Qarty Qfm params_M
      separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_closed <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Data-Collect_in_M_4p><span class=command>lemma</span></span> Collect_in_M_4p <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    Qfm <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>Q_fm</span> <span class=main>∈</span> formula"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qarty <span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>Q_fm</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    params_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a4</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qsats <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    Qabs  <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span> <span class=quoted><span class=free>A</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Qabs Collect_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax Qsats Qarty Qfm params_M
      separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>]</span><span class=main>)</span>"</span></span> 
        <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>is_Q</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>a4</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_closed <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Data-Repl_in_M><span class=command>lemma</span></span> Repl_in_M <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    f_fm<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>f_fm</span> <span class=main>∈</span> formula"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    f_ar<span class=main>:</span>  <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>f_fm</span><span class=main>)</span><span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    fsats<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_f</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    fabs<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>is_f</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    fclosed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>  <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax f_fm f_ar <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fsats fabs 
      strong_replacement_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f_fm</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span> <span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>,</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> fclosed strong_replacement_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span> <span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>,</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_ctm *)</span>      

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹A forcing locale and generic filters›</span></span>
<span class=keyword1><span class=command>locale</span></span> forcing_data <span class=main>=</span> forcing_notion <span class=main>+</span> M_ctm <span class=main>+</span>
  <span class=keyword2><span class=keyword>assumes</span></span> P_in_M<span class=main>:</span>           <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> leq_in_M<span class=main>:</span>         <span class=quoted><span class=quoted>"<span class=free>leq</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Forcing_Data-transD><span class=command>lemma</span></span> transD <span class=main>:</span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>⊆</span> <span class=free>M</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold</span> Transset_def<span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span><span class=main>)</span> 

<span class=comment1>(* P ⊆ M *)</span>
<span class=keyword1><span class=command>lemmas</span></span> P_sub_M <span class=main>=</span> transD<span class=main>[</span><span class=operator>OF</span> trans_M P_in_M<span class=main>]</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>M_generic</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>M_generic</span><span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span> <span class=main>≡</span> filter<span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>D</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>D</span><span class=main>⊆</span><span class=free>P</span> <span class=main>∧</span> dense<span class=main>(</span><span class=bound>D</span><span class=main>)</span><span class=main>⟶</span><span class=bound>D</span><span class=main>∩</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>≠</span><span class=main>0</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Data-M_genericD><span class=command>lemma</span></span> M_genericD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=free>x</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>filterD<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-M_generic_leqD><span class=command>lemma</span></span> M_generic_leqD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>≼</span><span class=free>q</span> <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span><span class=free>G</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>filter_leqD<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-M_generic_compatD><span class=command>lemma</span></span> M_generic_compatD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=free>r</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=free>r</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>low_bound_filter<span class=main>)</span>

<span class=keyword1 id=Forcing_Data-M_generic_denseD><span class=command>lemma</span></span> M_generic_denseD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> dense<span class=main>(</span><span class=free>D</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>D</span><span class=main>⊆</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>D</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>D</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forcing_Data-G_nonempty><span class=command>lemma</span></span> G_nonempty<span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>G</span><span class=main>≠</span><span class=main>0</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>⊆</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword3><span class=command>assume</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> P_in_M P_dense <span class=quoted><span class=quoted>‹<span class=free>P</span><span class=main>⊆</span><span class=free>P</span>›</span></span> <span class=keyword3><span class=command>show</span></span>
    <span class=quoted><span class=quoted>"<span class=free>G</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Data-one_in_G><span class=command>lemma</span></span> one_in_G <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword2><span class=keyword>and</span></span> filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"increasing<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword2><span class=keyword>and</span></span> filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> G_nonempty <span class=keyword2><span class=keyword>and</span></span> one_in_P <span class=keyword2><span class=keyword>and</span></span> one_max 
    <span class=keyword1><span class=command>unfolding</span></span> increasing_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Data-G_subset_M><span class=command>lemma</span></span> G_subset_M<span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>G</span> <span class=main>⊆</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>declare</span></span> iff_trans <span class=main>[</span><span class=operator>trans</span><span class=main>]</span>

<span class=keyword1 id=Forcing_Data-generic_filter_existence><span class=command>lemma</span></span> generic_filter_existence<span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>G</span><span class=main>.</span> <span class=free>p</span><span class=main>∈</span><span class=bound>G</span> <span class=main>∧</span> M_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=free>enum</span><span class=main>`</span><span class=bound>n</span><span class=main>⊆</span><span class=free>P</span> <span class=main>∧</span> dense<span class=main>(</span><span class=free>enum</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span><span class=main>)</span>  <span class=keyword1>then</span> <span class=free>enum</span><span class=main>`</span><span class=bound>n</span> <span class=keyword1>else</span> <span class=free>P</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=var>?D</span><span class=main>`</span><span class=bound>n</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>P</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span><span class=main>:</span>nat<span class=main>→</span>Pow<span class=main>(</span><span class=free>P</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lam_type <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> Eq4<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> dense<span class=main>(</span><span class=var>?D</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>intro</span> ballI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=var>?D</span><span class=main>`</span><span class=skolem>n</span><span class=main>)</span> <span class=main>⟷</span> dense<span class=main>(</span><span class=keyword1>if</span> <span class=free>enum</span><span class=main>`</span><span class=skolem>n</span> <span class=main>⊆</span> <span class=free>P</span> <span class=main>∧</span> dense<span class=main>(</span><span class=free>enum</span><span class=main>`</span><span class=skolem>n</span><span class=main>)</span> <span class=keyword1>then</span> <span class=free>enum</span><span class=main>`</span><span class=skolem>n</span> <span class=keyword1>else</span> <span class=free>P</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span>  <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=free>enum</span><span class=main>`</span><span class=skolem>n</span> <span class=main>⊆</span> <span class=free>P</span> <span class=main>∧</span> dense<span class=main>(</span><span class=free>enum</span><span class=main>`</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> dense<span class=main>(</span><span class=free>P</span><span class=main>)</span><span class=main>)</span> "</span></span>
      <span class=keyword1><span class=command>using</span></span> split_if <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=var>?D</span><span class=main>`</span><span class=skolem>n</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P_dense <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?D</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> Eq4 
  <span class=keyword1><span class=command>interpret</span></span> cg<span class=main>:</span> countable_generic <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>leq</span></span> <span class=quoted><span class=free>one</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>G</span></span> <span class=keyword2><span class=keyword>where</span></span> Eq6<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=skolem>G</span> <span class=main>∧</span> filter<span class=main>(</span><span class=skolem>G</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span><span class=main>(</span><span class=var>?D</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span><span class=main>∩</span><span class=skolem>G</span><span class=main>≠</span><span class=main>0</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> cg.countable_rasiowa_sikorski<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> M<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=free>M</span>"</span></span><span class=main>]</span>  P_sub_M
      M_countable<span class=main>[</span><span class=operator>THEN</span> bij_is_fun<span class=main>]</span> M_countable<span class=main>[</span><span class=operator>THEN</span> bij_is_surj<span class=main>,</span> <span class=operator>THEN</span> surj_range<span class=main>]</span> 
    <span class=keyword1><span class=command>unfolding</span></span> cg.D_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> Eq7<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>D</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>D</span><span class=main>⊆</span><span class=free>P</span> <span class=main>∧</span> dense<span class=main>(</span><span class=bound>D</span><span class=main>)</span><span class=main>⟶</span><span class=bound>D</span><span class=main>∩</span><span class=skolem>G</span><span class=main>≠</span><span class=main>0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> ballI impI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>D</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>D</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> Eq9<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>D</span> <span class=main>⊆</span> <span class=free>P</span> <span class=main>∧</span> dense<span class=main>(</span><span class=skolem>D</span><span class=main>)</span> "</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span>nat<span class=main>.</span> <span class=free>enum</span><span class=main>`</span><span class=bound>x</span><span class=main>=</span> <span class=bound>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> M_countable <span class=keyword2><span class=keyword>and</span></span>  bij_is_surj <span class=keyword1><span class=command>unfolding</span></span> surj_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>D</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> Eq10<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat <span class=main>∧</span> <span class=free>enum</span><span class=main>`</span><span class=skolem>n</span> <span class=main>=</span> <span class=skolem>D</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> Eq9 <span class=keyword2><span class=keyword>and</span></span> if_P
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span><span class=main>`</span><span class=skolem>n</span> <span class=main>=</span> <span class=skolem>D</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> Eq6 <span class=keyword2><span class=keyword>and</span></span> Eq10 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>D</span><span class=main>∩</span><span class=skolem>G</span><span class=main>≠</span><span class=main>0</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>with</span></span> Eq6 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Compatibility lemmas *)</span>
<span class=keyword1 id=Forcing_Data-compat_in_abs><span class=command>lemma</span></span> compat_in_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_compat_in<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span> <span class=main>⟷</span> compat_in<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>d</span>
    <span class=keyword1><span class=command>using</span></span> transitivity <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=skolem>d</span><span class=main>,</span> <span class=skolem>t</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span> <span class=skolem>d</span>
    <span class=keyword1><span class=command>using</span></span> that pair_in_M_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_compat_in_def compat_in_def 
    <span class=keyword1><span class=command>using</span></span> assms pair_in_M_iff transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>compat_in_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>compat_in_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span> <span class=main>≡</span> 
    Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
                                        And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
                                 Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 

<span class=keyword1 id=Forcing_Data-compat_in_fm_type><span class=command>lemma</span></span> compat_in_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>A</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>r</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> compat_in_fm<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> compat_in_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Data-sats_compat_in_fm><span class=command>lemma</span></span> sats_compat_in_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>  
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>compat_in_fm<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> 
            is_compat_in<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> compat_in_fm_def is_compat_in_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Internal_ZFC_Axioms><div class=head><h1>Theory Internal_ZFC_Axioms</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The ZFC axioms, internalized›</span></span>
<span class=keyword1><span class=command>theory</span></span> Internal_ZFC_Axioms
  <span class=keyword2><span class=keyword>imports</span></span> 
  <a href=Forcing_Data.html>Forcing_Data</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_union_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"Union_ax<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=var>?zfunion</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Union_ax_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_union_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_union_auto

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_power_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"power_ax<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=var>?zfpow</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> power_ax_def powerset_def subset_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_power_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_power_auto

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_pairing_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"upair_ax<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=var>?zfpair</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> upair_ax_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_pairing_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_pairing_auto

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_foundation_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"foundation_ax<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=var>?zfpow</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> foundation_ax_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_foundation_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_foundation_auto

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_extensionality_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"extensionality<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=var>?zfpow</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> extensionality_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_extensionality_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_extensionality_auto

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_infinity_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"infinity_ax<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span><span class=var>?φ</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> infinity_ax_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_infinity_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_infinity_auto

<span class=keyword1><span class=command>schematic_goal</span></span> ZF_choice_auto<span class=main>:</span>
    <span class=quoted><span class=quoted>"choice_ax<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span><span class=var>?φ</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> choice_ax_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"ZF_choice_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> ZF_choice_auto

<span class=keyword1><span class=command>syntax</span></span>
  <span class=quoted>"_choice"</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span>  <span class=main>(</span><span class=quoted>"<span class=keyword1>AC</span>"</span><span class=main>)</span>
<span class=keyword1><span class=command>translations</span></span>
  <span class=quoted>"<span class=keyword1>AC</span>"</span> <span class=main>⇀</span> <span class=quoted>"<span class=keyword1>CONST</span> ZF_choice_fm"</span>

<span class=keyword1><span class=command>lemmas</span></span> ZFC_fm_defs <span class=main>=</span> ZF_extensionality_fm_def ZF_foundation_fm_def ZF_pairing_fm_def
              ZF_union_fm_def ZF_infinity_fm_def ZF_power_fm_def ZF_choice_fm_def

<span class=keyword1><span class=command>lemmas</span></span> ZFC_fm_sats <span class=main>=</span> ZF_extensionality_auto ZF_foundation_auto ZF_pairing_auto
              ZF_union_auto ZF_infinity_auto ZF_power_auto ZF_choice_auto

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZF_fin</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZF_fin</span> <span class=main>≡</span> <span class=main>{</span> ZF_extensionality_fm<span class=main>,</span> ZF_foundation_fm<span class=main>,</span> ZF_pairing_fm<span class=main>,</span>
              ZF_union_fm<span class=main>,</span> ZF_infinity_fm<span class=main>,</span> ZF_power_fm <span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZFC_fin</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZFC_fin</span> <span class=main>≡</span> ZF_fin <span class=main>∪</span> <span class=main>{</span>ZF_choice_fm<span class=main>}</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-ZFC_fin_type><span class=command>lemma</span></span> ZFC_fin_type <span class=main>:</span> <span class=quoted><span class=quoted>"ZFC_fin <span class=main>⊆</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ZFC_fin_def ZF_fin_def ZFC_fm_defs <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The Axiom of Separation, internalized›</span></span>
<span class=keyword1 id=Internal_ZFC_Axioms-iterates_Forall_type><span class=command>lemma</span></span> iterates_Forall_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>n</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟧</span> <span class=main>⟹</span> Forall<span class=main>^</span><span class=free>n</span><span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>nat<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Internal_ZFC_Axioms-last_init_eq><span class=command>lemma</span></span> last_init_eq <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>l</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span> <span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>l'</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>.</span> <span class=free>l</span> <span class=main>=</span> <span class=bound>l'</span><span class=main>@</span><span class=main>[</span><span class=bound>a</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>l</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rev<span class=main>(</span><span class=free>l</span><span class=main>)</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span>rev<span class=main>(</span><span class=free>l</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>l'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l'</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"rev<span class=main>(</span><span class=free>l</span><span class=main>)</span> <span class=main>=</span> Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>l'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main><span class=keyword3>;</span></span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>=</span> rev<span class=main>(</span><span class=skolem>l'</span><span class=main>)</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"rev<span class=main>(</span><span class=skolem>l'</span><span class=main>)</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rev_rev_ident<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>l</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-take_drop_eq><span class=command>lemma</span></span> take_drop_eq <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>n</span> <span class=main>.</span> <span class=bound>n</span> <span class=main>&lt;</span> succ<span class=main>(</span>length<span class=main>(</span><span class=free>l</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>l</span> <span class=main>=</span> take<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>l</span><span class=main>)</span> <span class=main>@</span> drop<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>l</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>induct</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>&lt;</span>succ<span class=main>(</span>succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>l</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>l</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>=</span> <span class=main>0</span>"</span></span> <span class=main>|</span> <span class=main>(</span>eq<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>k</span><span class=main>∈</span>nat<span class=main>.</span> <span class=skolem>i</span> <span class=main>=</span> succ<span class=main>(</span><span class=bound>k</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>k</span> <span class=main>&lt;</span> succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>l</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>l</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>  le_natI nat_imp_quasinat
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>nat_cases<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem><span class=quoted><span class=skolem>i</span></span></span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span><span class=operator>auto</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"take<span class=main>(</span><span class=skolem>i</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>l</span><span class=main>)</span><span class=main>)</span> <span class=main>@</span> drop<span class=main>(</span><span class=skolem>i</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>l</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>l</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main><span class=keyword3>;</span></span><span class=operator>auto</span><span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Cons <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-list_split><span class=command>lemma</span></span> list_split <span class=main>:</span>
<span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>≤</span> succ<span class=main>(</span>length<span class=main>(</span><span class=free>rest</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>rest</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>re</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>st</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> <span class=free>rest</span> <span class=main>=</span> <span class=bound>re</span> <span class=main>@</span> <span class=bound>st</span> <span class=main>∧</span> length<span class=main>(</span><span class=bound>re</span><span class=main>)</span> <span class=main>=</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>rest</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pred_mono<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>≤</span><span class=main>_</span>›</span></span><span class=main>]</span> pred_succ_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>rest</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>rest</span> <span class=main>=</span> take<span class=main>(</span>pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>rest</span><span class=main>)</span> <span class=main>@</span> drop<span class=main>(</span>pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>rest</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> <span class=var>?re</span> <span class=main>@</span> <span class=var>?st</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> take_drop_eq<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>rest</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> le_natI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=var>?re</span><span class=main>)</span> <span class=main>=</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?re</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?st</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> length_take<span class=main>[</span><span class=operator>rule_format</span><span class=main>,</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹pred<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹pred<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>rest</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> min_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> rev_bexI<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>re</span><span class=main>.</span> <span class=main>∃</span><span class=bound>st</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> <span class=free>rest</span> <span class=main>=</span> <span class=bound>re</span> <span class=main>@</span> <span class=bound>st</span> <span class=main>∧</span> length<span class=main>(</span><span class=bound>re</span><span class=main>)</span> <span class=main>=</span> pred<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=var>?re</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>rest</span> <span class=main>=</span> <span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_nForall><span class=command>lemma</span></span> sats_nForall<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>ms</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
       <span class=free>M</span><span class=main>,</span> <span class=free>ms</span> <span class=main>⊨</span> <span class=main>(</span>Forall<span class=main>^</span><span class=free>n</span><span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
       <span class=main>(</span><span class=main>∀</span><span class=bound>rest</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> length<span class=main>(</span><span class=bound>rest</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span> <span class=main>⟶</span> <span class=free>M</span><span class=main>,</span> <span class=bound>rest</span> <span class=main>@</span> <span class=free>ms</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>ms</span></span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>nat<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>succ <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>rest</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> length<span class=main>(</span><span class=bound>rest</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>⟶</span> <span class=skolem>P</span><span class=main>(</span><span class=bound>rest</span><span class=main>,</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
        <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>res</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> length<span class=main>(</span><span class=bound>res</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>n</span> <span class=main>⟶</span> <span class=skolem>P</span><span class=main>(</span><span class=bound>res</span> <span class=main>@</span> <span class=main>[</span><span class=bound>t</span><span class=main>]</span><span class=main>,</span><span class=skolem>n</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=skolem>P</span>
    <span class=keyword1><span class=command>using</span></span> that last_init_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>from</span></span> this<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>rest</span> <span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=bound>rest</span> <span class=main>@</span> <span class=skolem>ms</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>rest</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> length<span class=main>(</span><span class=bound>rest</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>⟶</span> <span class=free>M</span><span class=main>,</span> <span class=bound>rest</span> <span class=main>@</span> <span class=skolem>ms</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span>
        <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>res</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> length<span class=main>(</span><span class=bound>res</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>n</span> <span class=main>⟶</span>  <span class=free>M</span><span class=main>,</span> <span class=main>(</span><span class=bound>res</span> <span class=main>@</span> <span class=main>[</span><span class=bound>t</span><span class=main>]</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>ms</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> assms succ<span class=main>(</span>1<span class=main>,</span>3<span class=main>)</span> succ<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=skolem>ms</span><span class=main>)</span>"</span></span><span class=main>]</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=main>_</span><span class=main>,</span> <span class=skolem>ms</span> <span class=main>@</span> <span class=main>_</span><span class=main>)</span>"</span></span><span class=main>]</span> app_assoc
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>sep_body_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sep_body_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> Forall<span class=main>(</span>Exists<span class=main>(</span>Forall<span class=main>(</span>
                           Iff<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
                                    incr_bv1<span class=main>^</span><span class=main>2</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-sep_body_fm_type><span class=command>lemma</span></span> sep_body_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> sep_body_fm<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sep_body_fm_def<span class=main>)</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_sep_body_fm><span class=command>lemma</span></span> sats_sep_body_fm<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ms</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>rest</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=free>rest</span> <span class=main>@</span> <span class=free>ms</span> <span class=main>⊨</span> sep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> 
     separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>rest</span> <span class=main>@</span> <span class=free>ms</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms formula_add_params1<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=main>2</span></span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>]</span>"</span></span> <span class=main>]</span>
  <span class=keyword1><span class=command>unfolding</span></span> sep_body_fm_def separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZF_separation_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZF_separation_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> Forall<span class=main>^</span><span class=main>(</span>pred<span class=main>(</span>arity<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>(</span>sep_body_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-ZF_separation_fm_type><span class=command>lemma</span></span> ZF_separation_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> ZF_separation_fm<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ZF_separation_fm_def<span class=main>)</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_ZF_separation_fm_iff><span class=command>lemma</span></span> sats_ZF_separation_fm_iff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span>ZF_separation_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
   <span class=main>⟷</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟶</span> 
      separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI ballI impI<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>env</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> ZF_separation_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>some</span></span> <span class=skolem><span class=skolem>rest</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>some</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rest</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=skolem>env</span> <span class=main>=</span> <span class=skolem>some</span> <span class=main>@</span> <span class=skolem>rest</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=skolem>some</span><span class=main>)</span> <span class=main>=</span> Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> list_split<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span><span class=main>_</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
   <span class=keyword1><span class=command>using</span></span> succpred_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> ZF_separation_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>⊨</span> sep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sats_nForall<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"sep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_separation_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_separation_fm_def
    <span class=keyword1><span class=command>using</span></span> sats_sep_body_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>some</span></span><span class=main>]</span>
      arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=skolem>rest</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>some</span>"</span></span><span class=main>]</span>
      separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>@</span> <span class=skolem>rest</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=main>_</span> <span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span> <span class=comment1>― ‹almost equal to the previous implication›</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> asm<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟶</span> 
    separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>some</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>some</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=skolem>some</span><span class=main>)</span> <span class=main>=</span> Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>some</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> succpred_leI<span class=main>]</span> succpred_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=keyword2><span class=keyword>and</span></span> asm
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>some</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>⊨</span> sep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> sats_sep_body_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>some</span></span><span class=main>]</span>
      arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>some</span>"</span></span><span class=main>]</span>
      strong_replacement_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>@</span> <span class=main>_</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=main>_</span> <span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> ZF_separation_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sats_nForall<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"sep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_separation_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The Axiom of Replacement, internalized›</span></span>
<span class=keyword1><span class=command>schematic_goal</span></span> sats_univalent_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=comment1>(*    Q_iff_sats:"⋀a b z env aa bb. nth(a,Cons(z,env)) = aa ⟹ nth(b,Cons(z,env)) = bb ⟹ z∈A 
          ⟹ aa ∈ A ⟹ bb ∈ A ⟹ env∈ list(A) ⟹ 
                 Q(aa,bb) ⟷ (A, Cons(z,env) ⊨ (Q_fm(a,b)))" ― ‹using only one formula› *)</span>
    Q_iff_sats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> 
                 <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>Q1_fm</span><span class=main>)</span>"</span></span>
       <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> 
                 <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>Q2_fm</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> 
    asms<span class=main>:</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>,</span><span class=free>Q</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>A</span><span class=main>,</span><span class=free>env</span> <span class=main>⊨</span> <span class=var>?ufm</span><span class=main>(</span><span class=free>i</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> univalent_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> asms<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules Q_iff_sats <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>
  
<span class=keyword1><span class=command>synthesize_notc</span></span> <span class=quoted>"univalent_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> sats_univalent_fm_auto

<span class=keyword1 id=Internal_ZFC_Axioms-univalent_fm_type><span class=command>lemma</span></span> univalent_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>q1</span><span class=main>∈</span> formula <span class=main>⟹</span> <span class=free>q2</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>i</span><span class=main>∈</span>nat <span class=main>⟹</span> 
  univalent_fm<span class=main>(</span><span class=free>q2</span><span class=main>,</span><span class=free>q1</span><span class=main>,</span><span class=free>i</span><span class=main>)</span> <span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>univalent_fm_def<span class=main>)</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_univalent_fm><span class=command>lemma</span></span> sats_univalent_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    Q_iff_sats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> 
                 <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>Q1_fm</span><span class=main>)</span>"</span></span>
       <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> 
                 <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>Q2_fm</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> 
    asms<span class=main>:</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>,</span><span class=free>env</span> <span class=main>⊨</span> univalent_fm<span class=main>(</span><span class=free>Q1_fm</span><span class=main>,</span><span class=free>Q2_fm</span><span class=main>,</span><span class=free>i</span><span class=main>)</span> <span class=main>⟷</span> univalent<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>,</span><span class=free>Q</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> univalent_fm_def <span class=keyword1><span class=command>using</span></span> asms sats_univalent_fm_auto<span class=main>[</span><span class=operator>OF</span> Q_iff_sats<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>swap_vars</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>swap_vars</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> 
      Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>2</span> <span class=main>,</span> <span class=main>2</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 

<span class=keyword1 id=Internal_ZFC_Axioms-swap_vars_type><span class=command>lemma</span></span> swap_vars_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> swap_vars<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span>formula"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> swap_vars_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_swap_vars><span class=command>lemma</span></span> sats_swap_vars <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> 
    <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> swap_vars<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>⟷</span> <span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=free>y</span><span class=main>,</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> swap_vars_def
  <span class=keyword1><span class=command>using</span></span> sats_incr_bv_iff <span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>y</span><span class=main>,</span><span class=free>x</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>univalent_Q1</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>univalent_Q1</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> incr_bv1<span class=main>(</span>swap_vars<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>univalent_Q2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>univalent_Q2</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> incr_bv<span class=main>(</span>swap_vars<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=main>0</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-univalent_Qs_type><span class=command>lemma</span></span> univalent_Qs_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"univalent_Q1<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"univalent_Q2<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> univalent_Q1_def univalent_Q2_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_univalent_fm_assm><span class=command>lemma</span></span> sats_univalent_fm_assm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∈</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>(</span><span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>z</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>y</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=main>(</span>univalent_Q1<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>(</span><span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>z</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>y</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=main>(</span>univalent_Q2<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> univalent_Q1_def univalent_Q2_def
  <span class=keyword1><span class=command>using</span></span> 
    sats_incr_bv_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>A</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span><span class=main>]</span> <span class=comment1>― ‹simplifies iterates of <span class=antiquoted><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span><span class=quoted>‹<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>`</span><span class=main>0</span>›</span></span>›</span>
    sats_incr_bv1_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>y</span></span><span class=main>]</span> 
    sats_swap_vars  assms 
   <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>rep_body_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rep_body_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> Forall<span class=main>(</span>Implies<span class=main>(</span>
        univalent_fm<span class=main>(</span>univalent_Q1<span class=main>(</span>incr_bv<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>univalent_Q2<span class=main>(</span>incr_bv<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
        Exists<span class=main>(</span>Forall<span class=main>(</span>
          Iff<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>incr_bv<span class=main>(</span>incr_bv<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>2</span><span class=main>)</span><span class=main>`</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-rep_body_fm_type><span class=command>lemma</span></span> rep_body_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> rep_body_fm<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rep_body_fm_def<span class=main>)</span>

<span class=keyword1><span class=command>lemmas</span></span> ZF_replacement_simps <span class=main>=</span> formula_add_params1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=main>2</span></span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>]</span>"</span></span> <span class=main>]</span>
  sats_incr_bv_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span><span class=main>]</span> <span class=comment1>― ‹simplifies iterates of <span class=antiquoted><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span><span class=quoted>‹<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>`</span><span class=main>0</span>›</span></span>›</span>
  sats_incr_bv_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>]</span>"</span></span><span class=main>]</span><span class=comment1>― ‹simplifies <span class=antiquoted><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span><span class=quoted>‹<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>`</span><span class=main>2</span>›</span></span>›</span>
  sats_incr_bv1_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span><span class=main>]</span> sats_swap_vars <span class=keyword2><span class=keyword>for</span></span> <span class=free>φ</span> <span class=free>M</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_rep_body_fm><span class=command>lemma</span></span> sats_rep_body_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ms</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>rest</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=free>rest</span> <span class=main>@</span> <span class=free>ms</span> <span class=main>⊨</span> rep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> 
     strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>rest</span> <span class=main>@</span> <span class=free>ms</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms ZF_replacement_simps 
  <span class=keyword1><span class=command>unfolding</span></span> rep_body_fm_def strong_replacement_def univalent_def
  <span class=keyword1><span class=command>unfolding</span></span> univalent_fm_def univalent_Q1_def univalent_Q2_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZF_replacement_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZF_replacement_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> Forall<span class=main>^</span><span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>arity<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>(</span>rep_body_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-ZF_replacement_fm_type><span class=command>lemma</span></span> ZF_replacement_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> ZF_replacement_fm<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ZF_replacement_fm_def<span class=main>)</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_ZF_replacement_fm_iff><span class=command>lemma</span></span> sats_ZF_replacement_fm_iff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span>ZF_replacement_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
   <span class=main>⟷</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟶</span> 
      strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=bound>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI ballI impI<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Arith.pred<span class=main>(</span>Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>env</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> ZF_replacement_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pred_mono<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>succ<span class=main>(</span><span class=main>_</span><span class=main>)</span>›</span></span><span class=main>]</span> pred_succ_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>some</span></span> <span class=skolem><span class=skolem>rest</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>some</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rest</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=skolem>env</span> <span class=main>=</span> <span class=skolem>some</span> <span class=main>@</span> <span class=skolem>rest</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=skolem>some</span><span class=main>)</span> <span class=main>=</span> Arith.pred<span class=main>(</span>Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> list_split<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹pred<span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>succ<span class=main>(</span>Arith.pred<span class=main>(</span>Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> succpred_leI<span class=main>]</span> succpred_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>⊨</span> rep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sats_nForall<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"rep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_replacement_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sats_rep_body_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>some</span></span><span class=main>]</span>
      arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=skolem>rest</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>some</span>"</span></span><span class=main>]</span>
      strong_replacement_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>@</span> <span class=skolem>rest</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=main>_</span> <span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span> <span class=comment1>― ‹almost equal to the previous implication›</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Arith.pred<span class=main>(</span>Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> asm<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟶</span> 
    strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=bound>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>some</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>some</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=skolem>some</span><span class=main>)</span> <span class=main>=</span> Arith.pred<span class=main>(</span>Arith.pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>some</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> succpred_leI<span class=main>]</span> succpred_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=keyword2><span class=keyword>and</span></span> asm
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>some</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>⊨</span> rep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> sats_rep_body_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>some</span></span><span class=main>]</span>
      arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>some</span>"</span></span><span class=main>]</span>
      strong_replacement_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=skolem>some</span> <span class=main>@</span> <span class=main>_</span><span class=main>)</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=main>_</span> <span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> ZF_replacement_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sats_nForall<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"rep_body_fm<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_replacement_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZF_inf</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZF_inf</span> <span class=main>≡</span> <span class=main>{</span>ZF_separation_fm<span class=main>(</span><span class=bound>p</span><span class=main>)</span> <span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> formula <span class=main>}</span> <span class=main>∪</span> <span class=main>{</span>ZF_replacement_fm<span class=main>(</span><span class=bound>p</span><span class=main>)</span> <span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> formula <span class=main>}</span>"</span></span>
              
<span class=keyword1 id=Internal_ZFC_Axioms-Un_subset_formula><span class=command>lemma</span></span> Un_subset_formula<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>⊆</span>formula <span class=main>∧</span> <span class=free>B</span><span class=main>⊆</span>formula <span class=main>⟹</span> <span class=free>A</span><span class=main>∪</span><span class=free>B</span> <span class=main>⊆</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  
<span class=keyword1 id=Internal_ZFC_Axioms-ZF_inf_subset_formula><span class=command>lemma</span></span> ZF_inf_subset_formula <span class=main>:</span> <span class=quoted><span class=quoted>"ZF_inf <span class=main>⊆</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ZF_inf_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZFC</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZFC</span> <span class=main>≡</span> ZF_inf <span class=main>∪</span> ZFC_fin"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ZF</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZF</span> <span class=main>≡</span> ZF_inf <span class=main>∪</span> ZF_fin"</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>ZF_minus_P</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ZF_minus_P</span> <span class=main>≡</span> ZF <span class=main>-</span> <span class=main>{</span> ZF_power_fm <span class=main>}</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-ZFC_subset_formula><span class=command>lemma</span></span> ZFC_subset_formula<span class=main>:</span> <span class=quoted><span class=quoted>"ZFC <span class=main>⊆</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>ZFC_def Un_subset_formula ZF_inf_subset_formula ZFC_fin_type<span class=main>)</span>
  
<span class=keyword1><span class=command>txt</span></span><span class=quoted><span class=plain_text>‹Satisfaction of a set of sentences›</span></span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>satT</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=quoted>"_ <span class=keyword1>⊨</span> _"</span> <span class=main>[</span>36<span class=main>,</span>36<span class=main>]</span> 60<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main><span class=free>⊨</span></span> <span class=free><span class=bound><span class=entity>Φ</span></span></span>  <span class=main>≡</span>  <span class=main>∀</span><span class=bound>φ</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>Φ</span></span></span><span class=main>.</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=main>[]</span> <span class=main>⊨</span> <span class=bound>φ</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Internal_ZFC_Axioms-satTI><span class=command>lemma</span></span> satTI <span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main><span class=main>!</span></span></span></span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>φ</span><span class=main>.</span> <span class=bound>φ</span><span class=main>∈</span><span class=free>Φ</span> <span class=main>⟹</span> <span class=free>A</span><span class=main>,</span><span class=main>[]</span> <span class=main>⊨</span> <span class=bound>φ</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>⊨</span> <span class=free>Φ</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> satT_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Internal_ZFC_Axioms-satTD><span class=command>lemma</span></span> satTD <span class=main>[</span><span class=operator>dest</span><span class=main>]</span> <span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>⊨</span> <span class=free>Φ</span> <span class=main>⟹</span>  <span class=free>φ</span><span class=main>∈</span><span class=free>Φ</span> <span class=main>⟹</span> <span class=free>A</span><span class=main>,</span><span class=main>[]</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> satT_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Internal_ZFC_Axioms-sats_ZFC_iff_sats_ZF_AC><span class=command>lemma</span></span> sats_ZFC_iff_sats_ZF_AC<span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>N</span> <span class=main>⊨</span> ZFC<span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>N</span> <span class=main>⊨</span> ZF<span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>N</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=keyword1>AC</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> ZFC_def ZFC_fin_def ZF_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Internal_ZFC_Axioms-M_ZF_iff_M_satT><span class=command>lemma</span></span> M_ZF_iff_M_satT<span class=main>:</span> <span class=quoted><span class=quoted>"M_ZF<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>M</span> <span class=main>⊨</span> ZF<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>⊨</span> ZF"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> fin<span class=main>:</span> <span class=quoted><span class=quoted>"upair_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Union_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"power_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"extensionality<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"foundation_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"infinity_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_def ZF_fin_def ZFC_fm_defs satT_def
    <span class=keyword1><span class=command>using</span></span> ZFC_fm_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>M</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>φ</span> <span class=skolem>env</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span> <span class=main>⊨</span> ZF›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span>formula<span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span>ZF_separation_fm<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
         <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span>formula<span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span>ZF_replacement_fm<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ZF_def ZF_inf_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=skolem>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=skolem>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>φ</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>x</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>y</span><span class=main>,</span> <span class=skolem>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> sats_ZF_separation_fm_iff sats_ZF_replacement_fm_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>  
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> fin
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"M_ZF<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> M_ZF_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>‹M_ZF<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>⊨</span> ZF_fin"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> M_ZF_def ZF_fin_def ZFC_fm_defs satT_def
    <span class=keyword1><span class=command>using</span></span> ZFC_fm_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>M</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹M_ZF<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span>formula<span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span>ZF_separation_fm<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
       <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span>formula<span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=main>(</span>ZF_replacement_fm<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> M_ZF_def <span class=keyword1><span class=command>using</span></span> sats_ZF_separation_fm_iff 
      sats_ZF_replacement_fm_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>⊨</span> ZF"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> ZF_def ZF_inf_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Renaming><div class=head><h1>Theory Renaming</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Renaming of variables in internalized formulas›</span></span>

<span class=keyword1><span class=command>theory</span></span> Renaming
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Nat_Miscellanea.html>Nat_Miscellanea</a>
    <span class=quoted>"<a href=../../ZF/ZF-Constructible/Formula.html>ZF-Constructible.Formula</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Renaming-app_nm><span class=command>lemma</span></span> app_nm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>n</span><span class=main>→</span><span class=free>m</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=free>x</span> <span class=main>∈</span> nat"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>n</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms in_n_in_nat apply_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms apply_0 domain_of_fun <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Renaming of free variables›</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>union_fun</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>union_fun</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>g</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>j</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>∪</span> <span class=free><span class=bound><span class=entity>p</span></span></span>  <span class=main>.</span> <span class=keyword1>if</span> <span class=bound>j</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>m</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>j</span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>g</span></span></span><span class=main>`</span><span class=bound>j</span>"</span></span>

<span class=keyword1 id=Renaming-union_fun_type><span class=command>lemma</span></span> union_fun_type<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>→</span> <span class=free>n</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>g</span> <span class=main>∈</span> <span class=free>p</span> <span class=main>→</span> <span class=free>q</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"union_fun<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span> <span class=main>→</span> <span class=free>n</span> <span class=main>∪</span> <span class=free>q</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?h</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"union_fun<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span>
    D<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>∪</span> <span class=free>q</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>m</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> union_fun_def  beta <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>→</span> <span class=free>n</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>p</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∉</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=free>g</span><span class=main>`</span><span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> union_fun_def <span class=keyword1><span class=command>using</span></span> beta <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>g</span> <span class=main>∈</span> <span class=free>p</span> <span class=main>→</span> <span class=free>q</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>p</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>q</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"function<span class=main>(</span><span class=var>?h</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> union_fun_def <span class=keyword1><span class=command>using</span></span> function_lam <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=skolem>x</span><span class=main>∈</span> <span class=main>(</span><span class=free>m</span> <span class=main>∪</span> <span class=free>p</span><span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=free>n</span> <span class=main>∪</span> <span class=free>q</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span> <span class=var>?h</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that lamE<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=free>m</span> <span class=main>∪</span> <span class=free>p</span><span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=free>n</span> <span class=main>∪</span> <span class=free>q</span><span class=main>)</span>"</span></span><span class=main>]</span> D <span class=keyword1><span class=command>unfolding</span></span> union_fun_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?h</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>m</span> <span class=main>∪</span> <span class=free>p</span><span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=free>n</span> <span class=main>∪</span> <span class=free>q</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∪</span> <span class=free>p</span> <span class=main>⊆</span> domain<span class=main>(</span><span class=var>?h</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> union_fun_def <span class=keyword1><span class=command>using</span></span> domain_lam <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> A B
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span>  Pi_iff <span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-union_fun_action><span class=command>lemma</span></span> union_fun_action <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>⟶</span>  nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>j</span> <span class=main>.</span> <span class=bound>j</span> <span class=main>∈</span> <span class=free>p</span> <span class=main>⟶</span> nth<span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=bound>j</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=bound>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span> <span class=main>⟶</span>
          nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>union_fun<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?h</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"union_fun<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> union_fun_def  beta <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>m</span> <span class=main>∪</span> <span class=free>p</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=free>m</span>"</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=free>g</span><span class=main>`</span><span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> union_fun_def beta <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>p</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Renaming-id_fn_type><span class=command>lemma</span></span> id_fn_type <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"id<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>→</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> id_def <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Renaming-id_fn_action><span class=command>lemma</span></span> id_fn_action<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>j</span> <span class=main>.</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>id<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>`</span><span class=bound>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>id<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>`</span><span class=skolem>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>j</span> <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>sum</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sum</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>g</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>j</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>#+</span><span class=free><span class=bound><span class=entity>p</span></span></span>  <span class=main>.</span> <span class=keyword1>if</span> <span class=bound>j</span><span class=main>&lt;</span><span class=free><span class=bound><span class=entity>m</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>j</span> <span class=keyword1>else</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>g</span></span></span><span class=main>`</span><span class=main>(</span><span class=bound>j</span><span class=main>#-</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>

<span class=keyword1 id=Renaming-sum_inl><span class=command>lemma</span></span> sum_inl<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span><span class=main>→</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>m</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=free>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=free>x</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> add_le_self<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ltI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>m</span></span><span class=main>]</span> lt_trans2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span><span class=main>]</span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sum_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-sum_inr><span class=command>lemma</span></span> sum_inr<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>∈</span><span class=free>p</span><span class=main>→</span><span class=free>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>≤</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=free>x</span> <span class=main>=</span> <span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=free>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>using</span></span> in_n_in_nat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span><span class=main>]</span> ltD
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=free>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> not_lt_iff_le<span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>¬</span> <span class=free>x</span><span class=main>&lt;</span><span class=free>m</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sum_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Renaming-sum_action><span class=command>lemma</span></span> sum_action <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span><span class=main>→</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>∈</span><span class=free>p</span><span class=main>→</span><span class=free>q</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env1</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env2</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>m</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>j</span><span class=main>.</span> <span class=bound>j</span> <span class=main>&lt;</span> <span class=free>p</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>j</span><span class=main>,</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=bound>j</span><span class=main>,</span><span class=free>env2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>m</span><span class=main>#+</span><span class=free>p</span> <span class=main>⟶</span>
          nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>sum<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?h</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>≤</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>≤</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> add_le_self<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span><span class=main>]</span>  add_le_self2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>q</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>=</span> <span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span><span class=main>)</span><span class=main>#-</span><span class=free>m</span>"</span></span> <span class=keyword1><span class=command>using</span></span> diff_add_inverse2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=free>env</span> <span class=main>@</span> <span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>nat"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms sum_inl ltD apply_type<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>m</span></span> <span class=main>_</span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> in_n_in_nat <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>›</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>∈</span>nat"</span></span>
      <span class=keyword1><span class=command>using</span></span> ltI in_n_in_nat <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> 2 <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>›</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nth_append<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2 <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>›</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nth_append<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env'</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=free>env</span> <span class=main>@</span> <span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>nat"</span></span>
      <span class=keyword1><span class=command>using</span></span> that in_n_in_nat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> ltD <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=main>¬</span><span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>¬</span><span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> 2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>=</span> <span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>x</span> <span class=main>&lt;</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> sum_def
      <span class=keyword1><span class=command>using</span></span>  sum_inr that beta ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>=</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span><span class=main>#-</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span> <span class=main>&lt;</span> <span class=free>p</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> diff_mono<span class=main>[</span><span class=operator>OF</span> _ _ _ <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>∈</span><span class=free>p</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>g</span><span class=main>∈</span><span class=free>p</span><span class=main>→</span><span class=free>q</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span> <span class=main>∈</span> <span class=free>q</span>"</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=keyword1><span class=command>using</span></span> ltI in_n_in_nat <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span> <span class=main>&lt;</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>≤</span> <span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> add_lt_mono1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=free>n</span></span><span class=main>,</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span><span class=main>]</span>
        add_le_self2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=main>¬</span> <span class=skolem>x</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=free>env</span> <span class=main>@</span> <span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>,</span><span class=free>env1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nth_append<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>,</span><span class=free>env2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span> <span class=main>&lt;</span> <span class=free>p</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>#-</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span><span class=main>,</span><span class=free>env2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>›</span></span>
        diff_add_inverse2 <span class=quoted><span class=quoted>‹<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>∈</span>nat›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  nth_append<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env'</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=main>¬</span> <span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env'</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=free>env</span> <span class=main>@</span> <span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env2</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-sum_type><span class=command>lemma</span></span> sum_type  <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span><span class=main>→</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>∈</span><span class=free>p</span><span class=main>→</span><span class=free>q</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> <span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span><span class=main>)</span> <span class=main>→</span> <span class=main>(</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?h</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>≤</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>≤</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> add_le_self<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span><span class=main>]</span>  add_le_self2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>q</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>=</span> <span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span><span class=main>)</span><span class=main>#-</span><span class=free>m</span>"</span></span> <span class=keyword1><span class=command>using</span></span> diff_add_inverse2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span><span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms sum_inl ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>m</span><span class=main>→</span><span class=free>n</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>≤</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=keyword1><span class=command>using</span></span> lt_trans2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span>  <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>{</span></span><span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>nat"</span></span> <span class=keyword1><span class=command>using</span></span> ltI in_n_in_nat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span><span class=main>]</span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> 1
    <span class=keyword1><span class=command>have</span></span> 2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span><span class=main>=</span> <span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms sum_inr ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>=</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span><span class=main>#-</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span> <span class=main>&lt;</span> <span class=free>p</span>"</span></span> <span class=keyword1><span class=command>using</span></span> diff_mono<span class=main>[</span><span class=operator>OF</span> _ _ _ <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>∈</span><span class=free>p</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>g</span><span class=main>∈</span><span class=free>p</span><span class=main>→</span><span class=free>q</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span> <span class=main>∈</span> <span class=free>q</span>"</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>q</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span><span class=main>)</span><span class=main>#+</span><span class=free>n</span> <span class=main>&lt;</span><span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=keyword1><span class=command>using</span></span> add_lt_mono1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>`</span><span class=main>(</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>)</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=free>n</span></span><span class=main>,</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> 2
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span>  <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>have</span></span>
    D<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>n</span><span class=main>#+</span><span class=free>q</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 1 that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> not_lt_iff_le that in_n_in_nat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 2 that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"function<span class=main>(</span><span class=var>?h</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> sum_def <span class=keyword1><span class=command>using</span></span> function_lam <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=skolem>x</span><span class=main>∈</span> <span class=main>(</span><span class=free>m</span> <span class=main>#+</span> <span class=free>p</span><span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=free>n</span> <span class=main>#+</span> <span class=free>q</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span> <span class=var>?h</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that lamE<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=free>m</span> <span class=main>#+</span> <span class=free>p</span><span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=free>n</span> <span class=main>#+</span> <span class=free>q</span><span class=main>)</span>"</span></span><span class=main>]</span> D <span class=keyword1><span class=command>unfolding</span></span> sum_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?h</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>m</span> <span class=main>#+</span> <span class=free>p</span><span class=main>)</span> <span class=main>×</span> <span class=main>(</span><span class=free>n</span> <span class=main>#+</span> <span class=free>q</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>#+</span> <span class=free>p</span> <span class=main>⊆</span> domain<span class=main>(</span><span class=var>?h</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> sum_def <span class=keyword1><span class=command>using</span></span> domain_lam <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> A B
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span>  Pi_iff <span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-sum_type_id><span class=command>lemma</span></span> sum_type_id <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>→</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env1</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span><span class=main>,</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span>
        <span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span> <span class=main>→</span> <span class=main>(</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms length_type id_fn_type sum_type
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Renaming-sum_type_id_aux2><span class=command>lemma</span></span> sum_type_id_aux2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span><span class=main>→</span><span class=free>n</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env1</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sum<span class=main>(</span><span class=free>f</span><span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span>
        <span class=main>(</span><span class=free>m</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span> <span class=main>→</span> <span class=main>(</span><span class=free>n</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms id_fn_type sum_type
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Renaming-sum_action_id><span class=command>lemma</span></span> sum_action_id <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>→</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env1</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span> <span class=main>⟹</span>
          nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>sum<span class=main>(</span><span class=free>f</span><span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>length<span class=main>(</span><span class=free>env'</span><span class=main>)</span><span class=main>,</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?m</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env'</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?n</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?p</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>note</span></span> lenv <span class=main>=</span> id_fn_action<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?p</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env1</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>note</span></span> lenv_ty <span class=main>=</span> id_fn_type<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?p</span><span class=main>∈</span>nat›</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>sum<span class=main>(</span><span class=free>f</span><span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=var>?m</span><span class=main>,</span><span class=var>?n</span><span class=main>,</span><span class=var>?p</span><span class=main>)</span><span class=main>`</span><span class=skolem>i</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> sum_action<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?p</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?p</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=var>?m</span><span class=main>→</span><span class=var>?n</span>›</span></span>
          lenv_ty <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env'</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
          <span class=quoted><span class=quoted>‹<span class=free>env1</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env1</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> _
          _ _  assms<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> lenv
          <span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>&lt;</span><span class=var>?m</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=var>?m</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span> <span class=main>⟹</span>
          nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>sum<span class=main>(</span><span class=free>f</span><span class=main>,</span>id<span class=main>(</span><span class=var>?p</span><span class=main>)</span><span class=main>,</span><span class=var>?m</span><span class=main>,</span><span class=var>?n</span><span class=main>,</span><span class=var>?p</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-sum_action_id_aux><span class=command>lemma</span></span> sum_action_id_aux <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>m</span><span class=main>→</span><span class=free>n</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env1</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>m</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env'</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span>
    <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>m</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>m</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span> <span class=main>⟹</span>
          nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>sum<span class=main>(</span><span class=free>f</span><span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>n</span><span class=main>,</span>length<span class=main>(</span><span class=free>env1</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>env'</span><span class=main>@</span><span class=free>env1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms length_type id_fn_type sum_action_id
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>sum_id</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sum_id</span><span class=main>(</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> sum<span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=main>1</span><span class=main>.</span><span class=bound>x</span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Renaming-sum_id0><span class=command>lemma</span></span> sum_id0 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat<span class=main>⟹</span>sum_id<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>`</span><span class=main>0</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>unfold</span> sum_id_def<span class=main><span class=keyword3>,</span></span><span class=operator>subst</span> sum_inl<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Renaming-sum_idS><span class=command>lemma</span></span> sum_idS <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>f</span><span class=main>∈</span><span class=free>p</span><span class=main>→</span><span class=free>q</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>p</span> <span class=main>⟹</span> sum_id<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>`</span><span class=main>(</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>unfold</span> sum_id_def<span class=main><span class=keyword3>,</span></span><span class=operator>subst</span> sum_inr<span class=main><span class=keyword3>,</span></span>
      <span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>ltI<span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> app_nm in_n_in_nat<span class=main>)</span>

<span class=keyword1 id=Renaming-sum_id_tc_aux><span class=command>lemma</span></span> sum_id_tc_aux <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> nat <span class=main>⟹</span>  <span class=free>q</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>f</span> <span class=main>∈</span> <span class=free>p</span> <span class=main>→</span> <span class=free>q</span> <span class=main>⟹</span> sum_id<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>f</span><span class=main>)</span> <span class=main>∈</span> <span class=main>1</span><span class=main>#+</span><span class=free>p</span> <span class=main>→</span> <span class=main>1</span><span class=main>#+</span><span class=free>q</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold</span> sum_id_def<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> sum_type<span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span><span class=main>)</span>

<span class=keyword1 id=Renaming-sum_id_tc><span class=command>lemma</span></span> sum_id_tc <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>f</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>→</span> <span class=free>m</span> <span class=main>⟹</span> sum_id<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>f</span><span class=main>)</span> <span class=main>∈</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>→</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ssubst<span class=main><span class=main>[</span></span><span class=operator>of</span>  <span class=quoted><span class=quoted><span class=quoted><span class=quoted>"succ<span class=main><span class=main><span class=main>(</span></span></span><span class=free><span class=free><span class=free>n</span></span></span><span class=main><span class=main><span class=main>)</span></span></span> <span class=main><span class=main><span class=main>→</span></span></span> succ<span class=main><span class=main><span class=main>(</span></span></span><span class=free><span class=free><span class=free>m</span></span></span><span class=main><span class=main><span class=main>)</span></span></span>"</span></span></span></span> <span class=quoted><span class=quoted><span class=quoted><span class=quoted>"<span class=main><span class=main><span class=main>1</span></span></span><span class=main><span class=main><span class=main>#+</span></span></span><span class=free><span class=free><span class=free>n</span></span></span> <span class=main><span class=main><span class=main>→</span></span></span> <span class=main><span class=main><span class=main>1</span></span></span><span class=main><span class=main><span class=main>#+</span></span></span><span class=free><span class=free><span class=free>m</span></span></span>"</span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span>
      <span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> sum_id_tc_aux<span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span><span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Renaming of formulas›</span></span>

<span class=keyword1><span class=command>consts</span></span>   ren <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span>
<span class=keyword1><span class=command>primrec</span></span>
  <span class=quoted><span class=quoted>"ren<span class=main>(</span>Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
      <span class=main>(</span><span class=main>λ</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>.</span> <span class=main>λ</span> <span class=bound>m</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>λ</span><span class=bound>f</span> <span class=main>∈</span> <span class=bound>n</span> <span class=main>→</span> <span class=bound>m</span><span class=main>.</span> Member <span class=main>(</span><span class=bound>f</span><span class=main>`</span><span class=free>x</span><span class=main>,</span> <span class=bound>f</span><span class=main>`</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=quoted><span class=quoted>"ren<span class=main>(</span>Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
      <span class=main>(</span><span class=main>λ</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>.</span> <span class=main>λ</span> <span class=bound>m</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>λ</span><span class=bound>f</span> <span class=main>∈</span> <span class=bound>n</span> <span class=main>→</span> <span class=bound>m</span><span class=main>.</span> Equal <span class=main>(</span><span class=bound>f</span><span class=main>`</span><span class=free>x</span><span class=main>,</span> <span class=bound>f</span><span class=main>`</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=quoted><span class=quoted>"ren<span class=main>(</span>Nand<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
      <span class=main>(</span><span class=main>λ</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>.</span> <span class=main>λ</span> <span class=bound>m</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>λ</span><span class=bound>f</span> <span class=main>∈</span> <span class=bound>n</span> <span class=main>→</span> <span class=bound>m</span><span class=main>.</span> Nand <span class=main>(</span>ren<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=bound>n</span><span class=main>`</span><span class=bound>m</span><span class=main>`</span><span class=bound>f</span><span class=main>,</span> ren<span class=main>(</span><span class=free>q</span><span class=main>)</span><span class=main>`</span><span class=bound>n</span><span class=main>`</span><span class=bound>m</span><span class=main>`</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=quoted><span class=quoted>"ren<span class=main>(</span>Forall<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
      <span class=main>(</span><span class=main>λ</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>.</span> <span class=main>λ</span> <span class=bound>m</span> <span class=main>∈</span> nat<span class=main>.</span> <span class=main>λ</span><span class=bound>f</span> <span class=main>∈</span> <span class=bound>n</span> <span class=main>→</span> <span class=bound>m</span><span class=main>.</span> Forall <span class=main>(</span>ren<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>n</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=bound>m</span><span class=main>)</span><span class=main>`</span>sum_id<span class=main>(</span><span class=bound>n</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Renaming-arity_meml><span class=command>lemma</span></span> arity_meml <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>∈</span> nat <span class=main>⟹</span> Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> formula <span class=main>⟹</span> arity<span class=main>(</span>Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>l</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> subsetD<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> le_imp_subset<span class=main><span class=keyword3>,</span></span><span class=operator>assumption</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1 id=Renaming-arity_memr><span class=command>lemma</span></span> arity_memr <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>∈</span> nat <span class=main>⟹</span> Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> formula <span class=main>⟹</span> arity<span class=main>(</span>Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>l</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> subsetD<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> le_imp_subset<span class=main><span class=keyword3>,</span></span><span class=operator>assumption</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1 id=Renaming-arity_eql><span class=command>lemma</span></span> arity_eql <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>∈</span> nat <span class=main>⟹</span> Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> formula <span class=main>⟹</span> arity<span class=main>(</span>Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>l</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> subsetD<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> le_imp_subset<span class=main><span class=keyword3>,</span></span><span class=operator>assumption</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1 id=Renaming-arity_eqr><span class=command>lemma</span></span> arity_eqr <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>∈</span> nat <span class=main>⟹</span> Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> formula <span class=main>⟹</span> arity<span class=main>(</span>Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>l</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> subsetD<span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> le_imp_subset<span class=main><span class=keyword3>,</span></span><span class=operator>assumption</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1 id=Renaming-nand_ar1><span class=command>lemma</span></span>  nand_ar1 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>formula <span class=main>⟹</span>arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span>Nand<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> Un_upper1_le<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>
<span class=keyword1 id=Renaming-nand_ar2><span class=command>lemma</span></span> nand_ar2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>formula <span class=main>⟹</span>arity<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span>Nand<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>rule</span> Un_upper2_le<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Renaming-nand_ar1D><span class=command>lemma</span></span> nand_ar1D <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>formula <span class=main>⟹</span> arity<span class=main>(</span>Nand<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>n</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>≤</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>  le_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> Un_upper1_le<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>q</span><span class=main>)</span>"</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1 id=Renaming-nand_ar2D><span class=command>lemma</span></span> nand_ar2D <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>formula <span class=main>⟹</span> arity<span class=main>(</span>Nand<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>n</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>≤</span> <span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>  le_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> Un_upper2_le<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>q</span><span class=main>)</span>"</span></span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>


<span class=keyword1 id=Renaming-ren_tc><span class=command>lemma</span></span> ren_tc <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span>
  <span class=main>(</span><span class=main>⋀</span> <span class=bound>n</span> <span class=bound>m</span> <span class=bound>f</span> <span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=bound>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=bound>f</span> <span class=main>∈</span> <span class=bound>n</span><span class=main>→</span><span class=bound>m</span> <span class=main>⟹</span>  ren<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=bound>n</span><span class=main>`</span><span class=bound>m</span><span class=main>`</span><span class=bound>f</span> <span class=main>∈</span> formula<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>formula<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> app_nm sum_id_tc<span class=main>)</span>


<span class=keyword1 id=Renaming-arity_ren><span class=command>lemma</span></span> arity_ren <span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=quoted>"<span class=free>p</span>"</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>n</span> <span class=bound>m</span> <span class=bound>f</span> <span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=bound>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=bound>f</span> <span class=main>∈</span> <span class=bound>n</span><span class=main>→</span><span class=bound>m</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>≤</span> <span class=bound>n</span> <span class=main>⟹</span> arity<span class=main>(</span>ren<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>`</span><span class=bound>n</span><span class=main>`</span><span class=bound>m</span><span class=main>`</span><span class=bound>f</span><span class=main>)</span><span class=main>≤</span><span class=bound>m</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>formula<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Member <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>m</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span><span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Member assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> arity_meml apply_funtype<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>arity_memr apply_funtype<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Member <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Un_least_lt ltI<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Equal <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>m</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span><span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Equal assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> arity_eql apply_funtype<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>arity_eqr apply_funtype<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Equal <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Un_least_lt ltI<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Nand <span class=skolem>p</span> <span class=skolem>q</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>≤</span>arity<span class=main>(</span>Nand<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>≤</span>arity<span class=main>(</span>Nand<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span>  nand_ar1<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>subst</span> nand_ar2<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>≤</span><span class=skolem>n</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>≤</span><span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Nand
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> j<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted><span class=quoted>"arity<span class=main><span class=main>(</span></span>Nand<span class=main><span class=main>(</span></span><span class=skolem><span class=skolem>p</span></span><span class=main><span class=main>,</span></span><span class=skolem><span class=skolem>q</span></span><span class=main><span class=main>)</span></span><span class=main><span class=main>)</span></span>"</span></span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> le_trans<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>m</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>  <span class=quoted><span class=quoted>"arity<span class=main>(</span>ren<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>m</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nand <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Nand <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>Un_least_lt<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Forall <span class=skolem>p</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Forall <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> Forall <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"sum_id<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span> <span class=main>∈</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>→</span>succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sum_id_tc<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> Forall <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>`</span>sum_id<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span><span class=main>)</span><span class=main>≤</span>succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span>
      Forall <span class=quoted><span class=quoted>‹succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>∈</span>nat›</span></span> 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Forall 2 3 ren_tc arity_type pred_le <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-arity_forallE><span class=command>lemma</span></span> arity_forallE <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> formula <span class=main>⟹</span> <span class=free>m</span> <span class=main>∈</span> nat <span class=main>⟹</span> arity<span class=main>(</span>Forall<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=free>m</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule_tac</span> n<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> natE<span class=main><span class=keyword3>,</span></span><span class=operator>erule</span> arity_type<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Renaming-env_coincidence_sum_id><span class=command>lemma</span></span> env_coincidence_sum_id <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>ρ</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>ρ'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>→</span> <span class=free>m</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>sum_id<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>`</span><span class=free>j</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"sum_id<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> nat"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>∈</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> in_n_in_nat <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?g</span><span class=main>`</span><span class=free>j</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>natE<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>∈</span>nat›</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> 1
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms sum_id0 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>2 <span class=skolem>i</span><span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>∈</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>∈</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nat_succD assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>i</span><span class=main>∈</span><span class=free>m</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>n</span><span class=main>→</span><span class=free>m</span>›</span></span> apply_type <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>i</span> <span class=main>∈</span> nat"</span></span> <span class=keyword1><span class=command>using</span></span> in_n_in_nat <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=skolem>i</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>›</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span>succ<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=skolem>i</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>`</span><span class=skolem>i</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?g</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms sum_idS<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span>  <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>n</span><span class=main>→</span><span class=free>m</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>∈</span> <span class=free>n</span>›</span></span><span class=main>]</span> cases <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?g</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>=</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Renaming-sats_iff_sats_ren><span class=command>lemma</span></span> sats_iff_sats_ren <span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=quoted>"<span class=free>φ</span>"</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=main>⟦</span>  <span class=free>n</span> <span class=main>∈</span> nat <span class=main>;</span> <span class=free>m</span> <span class=main>∈</span> nat <span class=main>;</span> <span class=free>ρ</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>;</span> <span class=free>ρ'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>;</span> <span class=free>f</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>→</span> <span class=free>m</span> <span class=main>;</span>
            arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=free>n</span> <span class=main>;</span>
            <span class=main>⋀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=free>f</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span>
         sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>ren<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>`</span><span class=free>n</span><span class=main>`</span><span class=free>m</span><span class=main>`</span><span class=free>f</span><span class=main>,</span><span class=free>ρ'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span> <span class=main>∈</span> formula›</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>ρ</span></span> <span class=quoted><span class=free>ρ'</span></span> <span class=quoted><span class=free>f</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Member <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ren<span class=main>(</span>Member<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span> <span class=main>=</span> Member<span class=main>(</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Member assms arity_type <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Member arity_meml <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Member arity_memr <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Member ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Equal <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ren<span class=main>(</span>Equal<span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span> <span class=main>=</span> Equal<span class=main>(</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Equal assms arity_type <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Equal arity_eql <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Equal arity_eqr <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Equal ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Nand <span class=skolem>p</span> <span class=skolem>q</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ren<span class=main>(</span>Nand<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span> <span class=main>=</span> Nand<span class=main>(</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span><span class=main>,</span>ren<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Nand <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Nand nand_ar1D <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>i</span> <span class=main>∈</span> <span class=skolem>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span> <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> le_imp_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>n</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span> <span class=keyword1><span class=command>using</span></span> Nand ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>≤</span><span class=skolem>n</span>›</span></span> Nand <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Nand nand_ar2D <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>i</span> <span class=main>∈</span> <span class=skolem>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span> <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> le_imp_subset<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>n</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>f</span><span class=main>`</span><span class=skolem>i</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span> <span class=keyword1><span class=command>using</span></span> Nand ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>ren<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>≤</span><span class=skolem>n</span>›</span></span> Nand <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Nand <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Forall <span class=skolem>p</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 0<span class=main>:</span><span class=quoted><span class=quoted>"ren<span class=main>(</span>Forall<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=skolem>n</span><span class=main>`</span><span class=skolem>m</span><span class=main>`</span><span class=skolem>f</span> <span class=main>=</span> Forall<span class=main>(</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>`</span>sum_id<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"sum_id<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span> <span class=main>∈</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>→</span> succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?g</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>using</span></span> sum_id_tc Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Forall le_trans<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>pred<span class=main>(</span>arity<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span> succpred_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=keyword1><span class=command>using</span></span> Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>j</span> <span class=main>.</span><span class=bound>j</span> <span class=main>&lt;</span> succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=bound>j</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span> <span class=skolem>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?g</span><span class=main>`</span><span class=bound>j</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span> <span class=skolem>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span>
    <span class=keyword1><span class=command>using</span></span> that env_coincidence_sum_id Forall ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>`</span><span class=var>?g</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> C<span class=main>:</span><span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Forall that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>ren<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>`</span>succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>`</span><span class=var>?g</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>ρ'</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Forall<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹succ<span class=main>(</span><span class=skolem>n</span><span class=main>)</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹succ<span class=main>(</span><span class=skolem>m</span><span class=main>)</span><span class=main>∈</span>nat›</span></span> C<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> C<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> 1 2 A<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Forall 0 1 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Renaming_Auto><div class=head><h1>Theory Renaming_Auto</h1></div><pre class=source><span class=keyword1><span class=command>theory</span></span> Renaming_Auto
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Renaming.html>Renaming</a>
    <a href=Utils.html>Utils</a>
    <a href=../../ZF/ZF/Finite.html>ZF.Finite</a>
    <a href=../../ZF/ZF/List.html>ZF.List</a>
  <span class=keyword2><span class=keyword>keywords</span></span> <span class=quoted>"rename"</span> <span class=main>::</span> thy_decl <span class=main>%</span> <span class=quoted>"ML"</span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted>"simple_rename"</span> <span class=main>::</span> thy_decl <span class=main>%</span> <span class=quoted>"ML"</span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted>"src"</span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted>"tgt"</span>
  <span class=keyword2><span class=keyword>abbrevs</span></span> <span class=quoted>"simple_rename"</span> <span class=main>=</span> <span class=quoted>""</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lemmas</span></span> app_fun <span class=main>=</span> apply_iff<span class=main>[</span><span class=operator>THEN</span> iffD1<span class=main>]</span>
<span class=keyword1><span class=command>lemmas</span></span> nat_succI <span class=main>=</span> nat_succ_iff<span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>]</span>

<span class=keyword1><span class=command>ML_file</span></span> <span class=quoted>‹renaming.ML›</span>
<span class=keyword1><span class=command>ML</span></span><span class=quoted>‹
  <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>renaming_def</span> <span class=entity>mk_ren</span> <span class=entity>name</span> <span class=entity>from</span> <span class=entity>to</span> <span class=entity>ctxt</span> <span class=main>=</span>
    <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>to</span> <span class=main>=</span> <span class=entity>to</span> |&gt; Syntax.read_term <span class=entity>ctxt</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>from</span> <span class=main>=</span> <span class=entity>from</span> |&gt; Syntax.read_term <span class=entity>ctxt</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>tc_lemma</span><span class=main>,</span><span class=entity>action_lemma</span><span class=main>,</span><span class=entity>fvs</span><span class=main>,</span><span class=entity>r</span><span class=main>)</span> <span class=main>=</span> <span class=entity>mk_ren</span> <span class=entity>from</span> <span class=entity>to</span> <span class=entity>ctxt</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>tc_lemma</span><span class=main>,</span><span class=entity>action_lemma</span><span class=main>)</span> <span class=main>=</span>
          <span class=main>(</span><span class=entity>Renaming.fix_vars</span> <span class=entity>tc_lemma</span> <span class=entity>fvs</span> <span class=entity>ctxt</span><span class=main>,</span> <span class=entity>Renaming.fix_vars</span> <span class=entity>action_lemma</span> <span class=entity>fvs</span> <span class=entity>ctxt</span><span class=main>)</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ren_fun_name</span> <span class=main>=</span> Binding.name <span class=main>(</span><span class=entity>name</span> ^ <span class=inner_quoted>"_fn"</span><span class=main>)</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ren_fun_def</span> <span class=main>=</span>  Binding.name <span class=main>(</span><span class=entity>name</span> ^ <span class=inner_quoted>"_fn_def"</span><span class=main>)</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ren_thm</span> <span class=main>=</span> Binding.name <span class=main>(</span><span class=entity>name</span> ^ <span class=inner_quoted>"_thm"</span><span class=main>)</span>
    <span class=keyword2><span class=keyword>in</span></span>
      Local_Theory.note   <span class=main>(</span><span class=main>(</span><span class=entity>ren_thm</span><span class=main>,</span> <span class=main>[</span><span class=main>]</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=entity>tc_lemma</span><span class=main>,</span><span class=entity>action_lemma</span><span class=main>]</span><span class=main>)</span> <span class=entity>ctxt</span> |&gt; snd |&gt;
      Local_Theory.define <span class=main>(</span><span class=main>(</span><span class=entity>ren_fun_name</span><span class=main>,</span> NoSyn<span class=main>)</span><span class=main>,</span> <span class=main>(</span><span class=main>(</span><span class=entity>ren_fun_def</span><span class=main>,</span> <span class=main>[</span><span class=main>]</span><span class=main>)</span><span class=main>,</span> <span class=entity>r</span><span class=main>)</span><span class=main>)</span> |&gt; snd      
  <span class=keyword2><span class=keyword>end</span></span><span class=main>;</span>
›</span>

<span class=keyword1><span class=command>ML</span></span><span class=quoted>‹
<span class=keyword2><span class=keyword>local</span></span>

  <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ren_parser</span> <span class=main>=</span> Parse.position <span class=main>(</span>Parse.string --
      <span class=main>(</span>Parse.$$$ <span class=inner_quoted>"src"</span> |-- Parse.string --| Parse.$$$ <span class=inner_quoted>"tgt"</span> -- Parse.string<span class=main>)</span><span class=main>)</span><span class=main>;</span>

  <span class=keyword1><span class=keyword>val</span></span> <span class=main>_</span> <span class=main>=</span>
   <span class=entity>Outer_Syntax.local_theory</span> <span class=antiquoted><span class=entity><span class=operator><span class=hidden>\&lt;^</span><span class=control>command_keyword</span><span class=hidden>&gt;</span></span>‹<span class=keyword1>rename</span>›</span></span> <span class=inner_quoted>"ML setup for synthetic definitions"</span>
     <span class=main>(</span><span class=entity>ren_parser</span> &gt;&gt; <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>(</span><span class=main>(</span><span class=entity>name</span><span class=main>,</span><span class=main>(</span><span class=entity>from</span><span class=main>,</span><span class=entity>to</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>=&gt;</span> <span class=entity>renaming_def</span> <span class=entity>Renaming.sum_rename</span> <span class=entity>name</span> <span class=entity>from</span> <span class=entity>to</span> <span class=main>)</span><span class=main>)</span>

  <span class=keyword1><span class=keyword>val</span></span> <span class=main>_</span> <span class=main>=</span>
   <span class=entity>Outer_Syntax.local_theory</span> <span class=antiquoted><span class=entity><span class=operator><span class=hidden>\&lt;^</span><span class=control>command_keyword</span><span class=hidden>&gt;</span></span>‹<span class=keyword1>simple_rename</span>›</span></span> <span class=inner_quoted>"ML setup for synthetic definitions"</span>
     <span class=main>(</span><span class=entity>ren_parser</span> &gt;&gt; <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>(</span><span class=main>(</span><span class=entity>name</span><span class=main>,</span><span class=main>(</span><span class=entity>from</span><span class=main>,</span><span class=entity>to</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>=&gt;</span> <span class=entity>renaming_def</span> <span class=entity>Renaming.ren_thm</span> <span class=entity>name</span> <span class=entity>from</span> <span class=entity>to</span> <span class=main>)</span><span class=main>)</span>

<span class=keyword2><span class=keyword>in</span></span>
<span class=keyword2><span class=keyword>end</span></span>
›</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=files/renaming.ML><div class=head><h1>File ‹renaming.ML›</h1></div><pre class=source><span class=comment1>(* Builds the finite mapping. *)</span>
<span class=keyword1><span class=keyword>structure</span></span> <span class=entity>Renaming</span> <span class=main>=</span> <span class=keyword2><span class=keyword>struct</span></span>
<span class=keyword3><span class=keyword>open</span></span> Utils

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>sum_</span> <span class=entity>f</span> <span class=entity>g</span> <span class=entity>m</span> <span class=entity>n</span> <span class=entity>p</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> Renaming.sum<span class=antiquote>}</span></span> $ <span class=entity>f</span> $ <span class=entity>g</span> $ <span class=entity>m</span> $ <span class=entity>n</span> $ <span class=entity>p</span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>mk_ren</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>rs</span>  <span class=main>=</span> <span class=entity>to_ML_list</span> <span class=entity>rho</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>rs'</span> <span class=main>=</span> <span class=entity>to_ML_list</span> <span class=entity>rho'</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ixs</span> <span class=main>=</span> <span class=inner_numeral>0</span> upto <span class=main>(</span>length <span class=entity>rs</span>-<span class=inner_numeral>1</span><span class=main>)</span>
      <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>err</span> <span class=entity>t</span> <span class=main>=</span> <span class=inner_quoted>"The element "</span> ^ Syntax.string_of_term <span class=entity>ctxt</span> <span class=entity>t</span> ^ <span class=inner_quoted>" is missing in the target environment"</span>
      <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>mkp</span> <span class=entity>i</span> <span class=main>=</span>
          <span class=keyword2><span class=keyword>case</span></span> find_index <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=entity>x</span> <span class=main>=&gt;</span> <span class=entity>x</span> <span class=main>=</span> nth <span class=entity>rs</span> <span class=entity>i</span><span class=main>)</span> <span class=entity>rs'</span> <span class=keyword2><span class=keyword>of</span></span>
            <span class=inner_numeral>~1</span> <span class=main>=&gt;</span> nth <span class=entity>rs</span> <span class=entity>i</span> |&gt; <span class=entity>err</span> |&gt; error
          <span class=main>|</span>  <span class=entity>j</span> <span class=main>=&gt;</span> <span class=entity>mk_Pair</span> <span class=main>(</span><span class=entity>mk_ZFnat</span> <span class=entity>i</span><span class=main>)</span> <span class=main>(</span><span class=entity>mk_ZFnat</span> <span class=entity>j</span><span class=main>)</span> 
  <span class=keyword2><span class=keyword>in</span></span>  map <span class=entity>mkp</span> <span class=entity>ixs</span> |&gt; <span class=entity>mk_FinSet</span>
  <span class=keyword2><span class=keyword>end</span></span>                           

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>mk_dom_lemma</span> <span class=entity>ren</span> <span class=entity>rho</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>n</span> <span class=main>=</span> <span class=entity>rho</span> |&gt; <span class=entity>to_ML_list</span> |&gt; length |&gt; <span class=entity>mk_ZFnat</span>
  <span class=keyword2><span class=keyword>in</span></span> <span class=entity>eq_</span> <span class=entity>n</span> <span class=main>(</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> domain<span class=antiquote>}</span></span> $ <span class=entity>ren</span><span class=main>)</span> |&gt; <span class=entity>tp</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>ren_tc_goal</span> <span class=entity>fin</span> <span class=entity>ren</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>n</span> <span class=main>=</span> <span class=entity>rho</span> |&gt; <span class=entity>to_ML_list</span> |&gt; length
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>m</span> <span class=main>=</span> <span class=entity>rho'</span> |&gt; <span class=entity>to_ML_list</span> |&gt; length
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>fun_ty</span> <span class=main>=</span> <span class=keyword2><span class=keyword>if</span></span> <span class=entity>fin</span> <span class=keyword2><span class=keyword>then</span></span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const_name</span> "FiniteFun"<span class=antiquote>}</span></span> <span class=keyword2><span class=keyword>else</span></span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const_abbrev</span> "function_space"<span class=antiquote>}</span></span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ty</span> <span class=main>=</span> Const <span class=main>(</span><span class=entity>fun_ty</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span><span class=antiquote>}</span></span><span class=main>)</span> $ <span class=entity>mk_ZFnat</span> <span class=entity>n</span> $ <span class=entity>mk_ZFnat</span> <span class=entity>m</span>
  <span class=keyword2><span class=keyword>in</span></span>  <span class=entity>mem_</span> <span class=entity>ren</span> <span class=entity>ty</span> |&gt; <span class=entity>tp</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>ren_action_goal</span> <span class=entity>ren</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>setV</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"A"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>j</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"j"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free 
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>vs</span> <span class=main>=</span> <span class=entity>rho</span>  |&gt; <span class=entity>to_ML_list</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ws</span> <span class=main>=</span> <span class=entity>rho'</span> |&gt; <span class=entity>to_ML_list</span> |&gt; filter <span class=entity>isFree</span> 
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>h1</span> <span class=main>=</span> <span class=entity>subset_</span> <span class=main>(</span><span class=entity>vs</span>|&gt; <span class=entity>mk_FinSet</span><span class=main>)</span> <span class=entity>setV</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>h2</span> <span class=main>=</span> <span class=entity>lt_</span> <span class=entity>j</span> <span class=main>(</span><span class=entity>mk_ZFnat</span> <span class=main>(</span>length <span class=entity>vs</span><span class=main>)</span><span class=main>)</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>fvs</span> <span class=main>=</span> <span class=main>(</span><span class=main>[</span><span class=entity>j</span><span class=main>,</span><span class=entity>setV</span> <span class=main>]</span> @ <span class=entity>ws</span> |&gt; filter <span class=entity>isFree</span><span class=main>)</span> |&gt; map <span class=entity>freeName</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>lhs</span> <span class=main>=</span> <span class=entity>nth_</span> <span class=entity>j</span> <span class=entity>rho</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>rhs</span> <span class=main>=</span> <span class=entity>nth_</span> <span class=main>(</span><span class=entity>app_</span> <span class=entity>ren</span> <span class=entity>j</span><span class=main>)</span>  <span class=entity>rho'</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>concl</span> <span class=main>=</span> <span class=entity>eq_</span> <span class=entity>lhs</span> <span class=entity>rhs</span>
   <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span>Logic.list_implies<span class=main>(</span><span class=main>[</span><span class=entity>tp</span> <span class=entity>h1</span><span class=main>,</span><span class=entity>tp</span> <span class=entity>h2</span><span class=main>]</span><span class=main>,</span><span class=entity>tp</span> <span class=entity>concl</span><span class=main>)</span><span class=main>,</span><span class=entity>fvs</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>end</span></span>

  <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>sum_tc_goal</span> <span class=entity>f</span> <span class=entity>m</span> <span class=entity>n</span> <span class=entity>p</span> <span class=main>=</span> 
    <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>m_length</span> <span class=main>=</span> <span class=entity>m</span> |&gt; <span class=entity>to_ML_list</span> |&gt; length |&gt; <span class=entity>mk_ZFnat</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>n_length</span> <span class=main>=</span> <span class=entity>n</span> |&gt; <span class=entity>to_ML_list</span> |&gt; length |&gt; <span class=entity>mk_ZFnat</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>p_length</span> <span class=main>=</span> <span class=entity>p</span> |&gt; <span class=entity>length_</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>id_fun</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const</span> id<span class=antiquote>}</span></span> $ <span class=entity>p_length</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>sum_fun</span> <span class=main>=</span> <span class=entity>sum_</span> <span class=entity>f</span> <span class=entity>id_fun</span> <span class=entity>m_length</span> <span class=entity>n_length</span> <span class=entity>p_length</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>dom</span> <span class=main>=</span> <span class=entity>add_</span> <span class=entity>m_length</span> <span class=entity>p_length</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>codom</span> <span class=main>=</span> <span class=entity>add_</span> <span class=entity>n_length</span> <span class=entity>p_length</span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>fun_ty</span> <span class=main>=</span> <span class=antiquoted><span class=antiquote>@{</span><span class=operator>const_abbrev</span> "function_space"<span class=antiquote>}</span></span>
        <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ty</span> <span class=main>=</span> Const <span class=main>(</span><span class=entity>fun_ty</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span><span class=antiquote>}</span></span><span class=main>)</span> $ <span class=entity>dom</span> $ <span class=entity>codom</span>
  <span class=keyword2><span class=keyword>in</span></span>  <span class=main>(</span><span class=entity>sum_fun</span><span class=main>,</span> <span class=entity>mem_</span> <span class=entity>sum_fun</span> <span class=entity>ty</span> |&gt; <span class=entity>tp</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>sum_action_goal</span> <span class=entity>ren</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>setV</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"A"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>envV</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"env"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>j</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"j"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free 
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>vs</span> <span class=main>=</span> <span class=entity>rho</span>  |&gt; <span class=entity>to_ML_list</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>ws</span> <span class=main>=</span> <span class=entity>rho'</span> |&gt; <span class=entity>to_ML_list</span> |&gt; filter <span class=entity>isFree</span> 
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>envL</span> <span class=main>=</span>  <span class=entity>envV</span> |&gt; <span class=entity>length_</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>rhoL</span> <span class=main>=</span> <span class=entity>vs</span> |&gt; length |&gt; <span class=entity>mk_ZFnat</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>h1</span> <span class=main>=</span> <span class=entity>subset_</span> <span class=main>(</span>append <span class=entity>vs</span> <span class=entity>ws</span> |&gt; <span class=entity>mk_FinSet</span><span class=main>)</span> <span class=entity>setV</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>h2</span> <span class=main>=</span> <span class=entity>lt_</span> <span class=entity>j</span> <span class=main>(</span><span class=entity>add_</span> <span class=entity>rhoL</span> <span class=entity>envL</span><span class=main>)</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>h3</span> <span class=main>=</span> <span class=entity>mem_</span> <span class=entity>envV</span> <span class=main>(</span><span class=entity>list_</span> <span class=entity>setV</span><span class=main>)</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>fvs</span> <span class=main>=</span> <span class=main>(</span><span class=main>[</span><span class=entity>j</span><span class=main>,</span><span class=entity>setV</span><span class=main>,</span><span class=entity>envV</span><span class=main>]</span> @ <span class=entity>ws</span> |&gt; filter <span class=entity>isFree</span><span class=main>)</span> |&gt; map <span class=entity>freeName</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>lhs</span> <span class=main>=</span> <span class=entity>nth_</span> <span class=entity>j</span> <span class=main>(</span><span class=entity>concat_</span> <span class=entity>rho</span> <span class=entity>envV</span><span class=main>)</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>rhs</span> <span class=main>=</span> <span class=entity>nth_</span> <span class=main>(</span><span class=entity>app_</span> <span class=entity>ren</span> <span class=entity>j</span><span class=main>)</span> <span class=main>(</span><span class=entity>concat_</span> <span class=entity>rho'</span> <span class=entity>envV</span><span class=main>)</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>concl</span> <span class=main>=</span> <span class=entity>eq_</span> <span class=entity>lhs</span> <span class=entity>rhs</span>
   <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span>Logic.list_implies<span class=main>(</span><span class=main>[</span><span class=entity>tp</span> <span class=entity>h1</span><span class=main>,</span><span class=entity>tp</span> <span class=entity>h2</span><span class=main>,</span><span class=entity>tp</span> <span class=entity>h3</span><span class=main>]</span><span class=main>,</span><span class=entity>tp</span> <span class=entity>concl</span><span class=main>)</span><span class=main>,</span><span class=entity>fvs</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>end</span></span>

  <span class=comment1>(* Tactics *)</span>
  <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>fin</span> <span class=entity>ctxt</span> <span class=main>=</span> 
         REPEAT <span class=main>(</span>resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> nat_succI<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span><span class=main>)</span>
         THEN   resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> nat_0I<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>

  <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>step</span> <span class=entity>ctxt</span> <span class=entity>thm</span> <span class=main>=</span> 
    <span class=entity>asm_full_simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span>
    THEN <span class=entity>asm_full_simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span>
    THEN <span class=entity>EqSubst.eqsubst_tac</span> <span class=entity>ctxt</span> <span class=main>[</span><span class=inner_numeral>1</span><span class=main>]</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> app_fun<span class=antiquote>}</span></span></span> OF <span class=main>[</span><span class=entity>thm</span><span class=main>]</span><span class=main>]</span> <span class=inner_numeral>1</span>
    THEN <span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span>
    THEN <span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span>

  <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>fin_fun_tac</span> <span class=entity>ctxt</span> <span class=main>=</span> 
    REPEAT <span class=main>(</span>
      resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> consI<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
      THEN resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> ltD<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
      THEN <span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span>
      THEN resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> ltD<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
      THEN <span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
    THEN resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> emptyI<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
  THEN REPEAT <span class=main>(</span><span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>

  <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>ren_thm</span> <span class=entity>e</span> <span class=entity>e'</span> <span class=entity>ctxt</span> <span class=main>=</span> 
   <span class=keyword2><span class=keyword>let</span></span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>r</span> <span class=main>=</span> <span class=entity>mk_ren</span> <span class=entity>e</span> <span class=entity>e'</span> <span class=entity>ctxt</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>fin_tc_goal</span> <span class=main>=</span> <span class=entity>ren_tc_goal</span> true <span class=entity>r</span> <span class=entity>e</span> <span class=entity>e'</span> 
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>dom_goal</span> <span class=main>=</span>  <span class=entity>mk_dom_lemma</span> <span class=entity>r</span> <span class=entity>e</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>tc_goal</span> <span class=main>=</span> <span class=entity>ren_tc_goal</span> false <span class=entity>r</span> <span class=entity>e</span> <span class=entity>e'</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>action_goal</span><span class=main>,</span><span class=entity>fvs</span><span class=main>)</span> <span class=main>=</span> <span class=entity>ren_action_goal</span> <span class=entity>r</span> <span class=entity>e</span> <span class=entity>e'</span> <span class=entity>ctxt</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>fin_tc_lemma</span> <span class=main>=</span> Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>fin_tc_goal</span> <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span> <span class=entity>fin_fun_tac</span> <span class=entity>ctxt</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>dom_lemma</span> <span class=main>=</span> Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>dom_goal</span> <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span> <span class=entity>blast_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span> 
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>tc_lemma</span> <span class=main>=</span>  Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>tc_goal</span>
            <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span>  <span class=entity>EqSubst.eqsubst_tac</span> <span class=entity>ctxt</span> <span class=main>[</span><span class=inner_numeral>1</span><span class=main>]</span> <span class=main>[</span><span class=entity>dom_lemma</span><span class=main>]</span> <span class=inner_numeral>1</span>
              THEN resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> FiniteFun_is_fun<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
              THEN resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=entity>fin_tc_lemma</span><span class=main>]</span> <span class=inner_numeral>1</span><span class=main>)</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>action_lemma</span> <span class=main>=</span> Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>action_goal</span>
              <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span> 
                  forward_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> le_natI<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
                  THEN <span class=entity>fin</span> <span class=entity>ctxt</span>
                  THEN REPEAT <span class=main>(</span>resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> natE<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
                               THEN <span class=entity>step</span> <span class=entity>ctxt</span> <span class=entity>tc_lemma</span><span class=main>)</span>
                  THEN <span class=main>(</span><span class=entity>step</span> <span class=entity>ctxt</span> <span class=entity>tc_lemma</span><span class=main>)</span>
              <span class=main>)</span>
    <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span><span class=entity>action_lemma</span><span class=main>,</span> <span class=entity>tc_lemma</span><span class=main>,</span> <span class=entity>fvs</span><span class=main>,</span> <span class=entity>r</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>end</span></span>

<span class=comment1>(* 
Returns the sum renaming, the goal for type_checking, and the actual lemmas 
for the left part of the sum.
*)</span>
 <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>sum_ren_aux</span> <span class=entity>e</span> <span class=entity>e'</span> <span class=entity>ctxt</span> <span class=main>=</span> 
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=entity>env</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"env"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free
      <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>left_action_lemma</span><span class=main>,</span><span class=entity>left_tc_lemma</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=entity>r</span><span class=main>)</span> <span class=main>=</span> <span class=entity>ren_thm</span> <span class=entity>e</span> <span class=entity>e'</span> <span class=entity>ctxt</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>sum_ren</span><span class=main>,</span><span class=entity>sum_goal_tc</span><span class=main>)</span> <span class=main>=</span> <span class=entity>sum_tc_goal</span> <span class=entity>r</span> <span class=entity>e</span> <span class=entity>e'</span> <span class=entity>env</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>setV</span> <span class=main>=</span> Variable.variant_frees <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>(</span><span class=inner_quoted>"A"</span><span class=main>,</span><span class=antiquoted><span class=antiquote>@{</span><span class=operator>typ</span> <span class=quoted>i</span><span class=antiquote>}</span></span><span class=main>)</span><span class=main>]</span> |&gt; hd |&gt; Free      
      <span class=keyword1><span class=keyword>fun</span></span> <span class=entity>hyp</span> <span class=entity>en</span> <span class=main>=</span> <span class=entity>mem_</span> <span class=entity>en</span> <span class=main>(</span><span class=entity>list_</span> <span class=entity>setV</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span><span class=entity>sum_ren</span><span class=main>,</span>
      <span class=entity>freeName</span> <span class=entity>env</span><span class=main>,</span>
      Logic.list_implies <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=entity>e</span> <span class=main>=&gt;</span> <span class=entity>e</span> |&gt; <span class=entity>hyp</span> |&gt; <span class=entity>tp</span><span class=main>)</span> <span class=main>[</span><span class=entity>env</span><span class=main>]</span><span class=main>,</span> <span class=entity>sum_goal_tc</span><span class=main>)</span><span class=main>,</span>
      <span class=entity>left_tc_lemma</span><span class=main>,</span>
      <span class=entity>left_action_lemma</span><span class=main>)</span>
<span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>sum_tc_lemma</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span> <span class=main>=</span>
  <span class=keyword2><span class=keyword>let</span></span> <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>sum_ren</span><span class=main>,</span> <span class=entity>envVar</span><span class=main>,</span> <span class=entity>tc_goal</span><span class=main>,</span> <span class=entity>left_tc_lemma</span><span class=main>,</span> <span class=entity>left_action_lemma</span><span class=main>)</span> <span class=main>=</span> <span class=entity>sum_ren_aux</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=entity>goal</span><span class=main>,</span><span class=entity>fvs</span><span class=main>)</span> <span class=main>=</span> <span class=entity>sum_action_goal</span> <span class=entity>sum_ren</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span>
      <span class=keyword1><span class=keyword>val</span></span> <span class=entity>r</span> <span class=main>=</span> <span class=entity>mk_ren</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span>
  <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span><span class=entity>sum_ren</span><span class=main>,</span> <span class=entity>goal</span><span class=main>,</span><span class=entity>envVar</span><span class=main>,</span> <span class=entity>r</span><span class=main>,</span><span class=entity>left_tc_lemma</span><span class=main>,</span> <span class=entity>left_action_lemma</span> <span class=main>,</span><span class=entity>fvs</span><span class=main>,</span> Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>tc_goal</span>
               <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span>
            resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> sum_type_id_aux2<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
            THEN <span class=entity>asm_simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>4</span>
            THEN <span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span>
            THEN resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=entity>left_tc_lemma</span><span class=main>]</span> <span class=inner_numeral>1</span>            
            THEN <span class=main>(</span><span class=entity>fin</span> <span class=entity>ctxt</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>fin</span> <span class=entity>ctxt</span><span class=main>)</span>
  <span class=main>)</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>end</span></span>

<span class=keyword1><span class=keyword>fun</span></span> <span class=entity>sum_rename</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span> <span class=main>=</span> 
  <span class=keyword2><span class=keyword>let</span></span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=main>(</span><span class=main>_</span><span class=main>,</span> <span class=entity>goal</span><span class=main>,</span> <span class=main>_</span><span class=main>,</span> <span class=entity>left_rename</span><span class=main>,</span> <span class=entity>left_tc_lemma</span><span class=main>,</span> <span class=entity>left_action_lemma</span><span class=main>,</span> <span class=entity>fvs</span><span class=main>,</span> <span class=entity>sum_tc_lemma</span><span class=main>)</span> <span class=main>=</span> <span class=entity>sum_tc_lemma</span> <span class=entity>rho</span> <span class=entity>rho'</span> <span class=entity>ctxt</span>
    <span class=keyword1><span class=keyword>val</span></span> <span class=entity>action_lemma</span> <span class=main>=</span> <span class=entity>fix_vars</span> <span class=entity>left_action_lemma</span> <span class=entity>fvs</span> <span class=entity>ctxt</span>
  <span class=keyword2><span class=keyword>in</span></span> <span class=main>(</span><span class=entity>sum_tc_lemma</span><span class=main>,</span> Goal.prove <span class=entity>ctxt</span> <span class=main>[</span><span class=main>]</span> <span class=main>[</span><span class=main>]</span> <span class=entity>goal</span>
    <span class=main>(</span><span class=keyword1><span class=keyword>fn</span></span> <span class=main>_</span> <span class=main>=&gt;</span> resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=antiquoted><span class=entity><span class=antiquote>@{</span><span class=operator>thm</span> sum_action_id_aux<span class=antiquote>}</span></span></span><span class=main>]</span> <span class=inner_numeral>1</span>
            THEN <span class=main>(</span><span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>4</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span>resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=entity>left_tc_lemma</span><span class=main>]</span>  <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>asm_full_simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span> 
            THEN <span class=main>(</span><span class=entity>asm_full_simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>full_simp_tac</span> <span class=entity>ctxt</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span>resolve_tac <span class=entity>ctxt</span> <span class=main>[</span><span class=entity>action_lemma</span><span class=main>]</span> <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>blast_tac</span> <span class=entity>ctxt</span>  <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>full_simp_tac</span> <span class=entity>ctxt</span>  <span class=inner_numeral>1</span><span class=main>)</span>
            THEN <span class=main>(</span><span class=entity>full_simp_tac</span> <span class=entity>ctxt</span>  <span class=inner_numeral>1</span><span class=main>)</span>
    
   <span class=main>)</span><span class=main>,</span> <span class=entity>fvs</span><span class=main>,</span> <span class=entity>left_rename</span>
   <span class=main>)</span>
<span class=keyword2><span class=keyword>end</span></span> <span class=main>;</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Names><div class=head><h1>Theory Names</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Names and generic extensions›</span></span>

<span class=keyword1><span class=command>theory</span></span> Names
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Forcing_Data.html>Forcing_Data</a>
    <a href=Interface.html>Interface</a>
    <a href=Recursion_Thms.html>Recursion_Thms</a>
    <a href=Synthetic_Definition.html>Synthetic_Definition</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>SepReplace</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>⇒</span>i<span class=main>,</span> i<span class=main>⇒</span> o<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>SepReplace</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span> <span class=bound>y</span><span class=main>=</span><span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>syntax</span></span>
  <span class=quoted>"_SepReplace"</span>  <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> pttrn<span class=main>,</span> i<span class=main>,</span> o<span class=main>]</span> <span class=main>⇒</span> i"</span></span>  <span class=main>(</span><span class=quoted>"<span class=keyword3>(1</span><span class=keyword1>{</span>_ <span class=keyword1>..</span><span class=keyword3>/ </span>_ <span class=keyword1>∈</span> _<span class=keyword1>,</span> _<span class=keyword1>}</span><span class=keyword3>)</span>"</span><span class=main>)</span>
<span class=keyword1><span class=command>translations</span></span>
  <span class=quoted>"<span class=main>{</span><span class=free>b</span> <span class=main>..</span> <span class=free>x</span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>Q</span><span class=main>}</span>"</span> <span class=main>=&gt;</span> <span class=quoted>"<span class=keyword1>CONST</span> SepReplace<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=main>λ</span><span class=free>x</span><span class=main>.</span> <span class=free>b</span><span class=main>,</span> <span class=main>λ</span><span class=free>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>)</span>"</span>

<span class=keyword1 id=Names-Sep_and_Replace><span class=command>lemma</span></span> Sep_and_Replace<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=main>{</span><span class=bound>y</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>P</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>SepReplace_def<span class=main>)</span>

<span class=keyword1 id=Names-SepReplace_subset><span class=command>lemma</span></span> SepReplace_subset <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>⊆</span><span class=free>A'</span><span class=main>⟹</span> <span class=main>{</span><span class=free>b</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>Q</span><span class=main>}</span><span class=main>⊆</span><span class=main>{</span><span class=free>b</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A'</span><span class=main>,</span> <span class=free>Q</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>SepReplace_def<span class=main>)</span>

<span class=keyword1 id=Names-SepReplace_iff><span class=command>lemma</span></span> SepReplace_iff <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=main>{</span><span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>y</span><span class=main>=</span><span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>&amp;</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>SepReplace_def<span class=main>)</span>

<span class=keyword1 id=Names-SepReplace_dom_implies><span class=command>lemma</span></span> SepReplace_dom_implies <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋀</span> <span class=bound>x</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>b'</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span><span class=main>⟹</span> <span class=main>{</span><span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>=</span><span class=main>{</span><span class=free>b'</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>SepReplace_def<span class=main>)</span>

<span class=keyword1 id=Names-SepReplace_pred_implies><span class=command>lemma</span></span> SepReplace_pred_implies <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>⟶</span> <span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>b'</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>⟹</span> <span class=main>{</span><span class=free>b</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>=</span><span class=main>{</span><span class=free>b'</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span>  <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>SepReplace_def<span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The well-founded relation <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>ed</span></span>›</span></span></span></span>›</span></span>

<span class=keyword1 id=Names-eclose_sing><span class=command>lemma</span></span> eclose_sing <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>a</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> subsetD<span class=main><span class=main>[</span></span><span class=operator>OF</span> mem_eclose_subset<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1 id=Names-ecloseE><span class=command>lemma</span></span> ecloseE <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span> <span class=bound>B</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=bound>B</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>eclose_induct_down<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>2 <span class=skolem>y</span> <span class=skolem>z</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>B</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=skolem>y</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=bound>B</span><span class=main>)</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>inA<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=free>A</span>"</span></span> <span class=main>|</span> <span class=main>(</span>exB<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>B</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=skolem>y</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=bound>B</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> inA
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 2 arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> exB
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>B</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=skolem>B</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>B</span><span class=main>∈</span><span class=free>A</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 2 ecloseD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>y</span></span> <span class=quoted><span class=skolem>B</span></span> <span class=quoted><span class=skolem>z</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-eclose_singE><span class=command>lemma</span></span> eclose_singE <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>a</span><span class=main>}</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>=</span> <span class=free>a</span> <span class=main>∨</span> <span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> ecloseE<span class=main>)</span>

<span class=keyword1 id=Names-in_eclose_sing><span class=command>lemma</span></span> in_eclose_sing <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>a</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>a</span><span class=main>}</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>eq<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>=</span><span class=free>a</span>"</span></span> <span class=main>|</span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> eclose_singE <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> eclose_sing mem_eclose_trans assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-in_dom_in_eclose><span class=command>lemma</span></span> in_dom_in_eclose <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>z</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> domain_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Pair_def
    <span class=keyword1><span class=command>using</span></span> ecloseD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>x</span><span class=main>,</span><span class=free>x</span><span class=main>}</span>"</span></span><span class=main>]</span> ecloseD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>{</span><span class=free>x</span><span class=main>,</span><span class=free>x</span><span class=main>}</span><span class=main>,</span><span class=main>{</span><span class=free>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>}</span><span class=main>}</span>"</span></span><span class=main>]</span> arg_into_eclose
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹term<span class=antiquoted><span class=raw_text><span class=antiquoted><span class=raw_text><span class=operator><span class=operator>‹</span></span>ed›</span></span></span></span> is the well-founded relation on which <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>val</span></span>›</span></span></span></span> is defined.›</span></span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ed</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ed</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∈</span> domain<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>edrel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>edrel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> Rrel<span class=main>(</span>ed<span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Names-edI><span class=command>lemma</span></span> edI<span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main><span class=main>!</span></span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> ed<span class=main>(</span><span class=free>t</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ed_def <span class=keyword1><span class=command>.</span></span>

<span class=keyword1 id=Names-edD><span class=command>lemma</span></span> edD<span class=main>[</span><span class=operator>dest</span><span class=main><span class=main><span class=main><span class=main>!</span></span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"ed<span class=main>(</span><span class=free>t</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ed_def <span class=keyword1><span class=command>.</span></span>


<span class=keyword1 id=Names-rank_ed><span class=command>lemma</span></span> rank_ed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"ed<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>rank<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> rank<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>y</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=main>⟨</span><span class=free>y</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> Pair_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=skolem>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>s</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=main>⟨</span><span class=free>y</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=main>⟨</span><span class=free>y</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rank_lt <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lt_trans <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-edrel_dest><span class=command>lemma</span></span> edrel_dest <span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span> <span class=bound>a</span><span class=main>∈</span> <span class=free>A</span><span class=main>.</span> <span class=main>∃</span> <span class=bound>b</span> <span class=main>∈</span> <span class=free>A</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>ed_def edrel_def Rrel_def<span class=main>)</span>

<span class=keyword1 id=Names-edrelD><span class=command>lemma</span></span> edrelD <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span> <span class=bound>a</span><span class=main>∈</span> <span class=free>A</span><span class=main>.</span> <span class=main>∃</span> <span class=bound>b</span> <span class=main>∈</span> <span class=free>A</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>⟩</span> <span class=main>∧</span> <span class=bound>a</span> <span class=main>∈</span> domain<span class=main>(</span><span class=bound>b</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>ed_def edrel_def Rrel_def<span class=main>)</span>

<span class=keyword1 id=Names-edrelI><span class=command>lemma</span></span> edrelI <span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main><span class=main>!</span></span></span></span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>y</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span>edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>ed_def edrel_def Rrel_def<span class=main>)</span>

<span class=keyword1 id=Names-edrel_trans><span class=command>lemma</span></span> edrel_trans<span class=main>:</span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>y</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span>edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> edrelI<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>Transset_def domain_def Pair_def<span class=main>)</span>

<span class=keyword1 id=Names-domain_trans><span class=command>lemma</span></span> domain_trans<span class=main>:</span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>y</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>x</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Transset_def domain_def Pair_def<span class=main>)</span>

<span class=keyword1 id=Names-relation_edrel><span class=command>lemma</span></span> relation_edrel <span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span>edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> relation_def<span class=main>)</span>

<span class=keyword1 id=Names-field_edrel><span class=command>lemma</span></span> field_edrel <span class=main>:</span> <span class=quoted><span class=quoted>"field<span class=main>(</span>edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span><span class=main>⊆</span><span class=free>A</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Names-edrel_sub_memrel><span class=command>lemma</span></span> edrel_sub_memrel<span class=main>:</span> <span class=quoted><span class=quoted>"edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⊆</span> trancl<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>z</span>
  <span class=keyword3><span class=command>assume</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span>edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span>
    Eq1<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>=</span><span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> edrelD
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>u</span></span> <span class=skolem><span class=skolem>v</span></span> <span class=keyword2><span class=keyword>where</span></span>
    Eq2<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=skolem>u</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span><span class=main>∈</span><span class=skolem>v</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=skolem>y</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> domain_def Pair_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> Eq1 <span class=keyword1><span class=command>have</span></span>
    Eq3<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span> <span class=operator>rule_tac</span> <span class=main><span class=improper>[</span></span>3<span class=main>-</span>4<span class=main><span class=improper>]</span></span> ecloseD<span class=main><span class=keyword3>,</span></span> <span class=operator>rule_tac</span> <span class=main><span class=improper>[</span></span>3<span class=main><span class=improper>]</span></span> ecloseD<span class=main><span class=keyword3>,</span></span> <span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>arg_into_eclose<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"trancl<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> Eq2 <span class=keyword2><span class=keyword>and</span></span> Eq3 <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>u</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span><span class=skolem>v</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>v</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> r_into_trancl<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> trancl_trans<span class=main><span class=keyword3>,</span></span> <span class=operator>rule_tac</span> <span class=main><span class=improper>[</span></span>2<span class=main><span class=improper>]</span></span> trancl_trans<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> Eq1 <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=var>?r</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-wf_edrel><span class=command>lemma</span></span> wf_edrel <span class=main>:</span> <span class=quoted><span class=quoted>"wf<span class=main>(</span>edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> wf_subset <span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"trancl<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span> edrel_sub_memrel
    wf_trancl wf_Memrel
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Names-ed_induction><span class=command>lemma</span></span> ed_induction<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>y</span><span class=main>.</span>  ed<span class=main>(</span><span class=bound>y</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> wf_induct2<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf_edrel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted><span class=quoted>"eclose<span class=main><span class=main>(</span></span><span class=main><span class=main>{</span></span><span class=free><span class=free>a</span></span><span class=main><span class=main>}</span></span><span class=main><span class=main>)</span></span>"</span></span></span><span class=main><span class=main>]</span></span> <span class=main><span class=main>,</span></span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free>a</span></span></span></span> <span class=quoted><span class=quoted><span class=quoted>"eclose<span class=main><span class=main>(</span></span><span class=main><span class=main>{</span></span><span class=free><span class=free>a</span></span><span class=main><span class=main>}</span></span><span class=main><span class=main>)</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 1
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> 2
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> field_edrel <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> edrelI domain_trans<span class=main>[</span><span class=operator>OF</span> Transset_eclose 3<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-dom_under_edrel_eclose><span class=command>lemma</span></span> dom_under_edrel_eclose<span class=main>:</span> <span class=quoted><span class=quoted>"edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>x</span><span class=main>}</span> <span class=main>=</span> domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>x</span><span class=main>}</span> <span class=main>⊆</span> domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> edrel_def Rrel_def ed_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>x</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> edrel_def Rrel_def
    <span class=keyword1><span class=command>using</span></span> in_dom_in_eclose eclose_sing arg_into_eclose
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-ed_eclose><span class=command>lemma</span></span> ed_eclose <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>⟩</span> <span class=main>∈</span> edrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>drule</span> edrelD<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>domain_def in_dom_in_eclose<span class=main>)</span>

<span class=keyword1 id=Names-tr_edrel_eclose><span class=command>lemma</span></span> tr_edrel_eclose <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>⟩</span> <span class=main>∈</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> trancl_induct<span class=main><span class=keyword3>,</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ed_eclose mem_eclose_trans<span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1 id=Names-restrict_edrel_eq><span class=command>lemma</span></span> restrict_edrel_eq <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span> <span class=main>∩</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span><span class=main>×</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>intro</span> equalityI subsetI<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ec</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>y</span> <span class=main>.</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ez</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rr</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=var>?ec</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∩</span> <span class=var>?ez</span> <span class=main>×</span> <span class=var>?ez</span>"</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
  <span class=keyword3><span class=command>assume</span></span> yr<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=var>?rr</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> yr <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?rr</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=var>?ez</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?ez</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?ec</span><span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>=</span><span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>b</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> edrelD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ec</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>y</span> <span class=main>.</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ez</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rr</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=var>?ec</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∩</span> <span class=var>?ez</span> <span class=main>×</span> <span class=var>?ez</span>"</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
  <span class=keyword3><span class=command>assume</span></span> yr<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> edrel<span class=main>(</span><span class=var>?ez</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=var>?ez</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?ez</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>=</span><span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> edrelD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> this assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> in_dom_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> assms calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> in_eclose_sing <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> this <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>b</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>⟩</span> <span class=main>∈</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=var>?rr</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-tr_edrel_subset><span class=command>lemma</span></span> tr_edrel_subset <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>   <span class=quoted><span class=quoted>"tr_down<span class=main>(</span>edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⊆</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>intro</span> subsetI<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=main>.</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
  <span class=keyword3><span class=command>assume</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> tr_down<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=free>z</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=keyword1><span class=command>using</span></span> tr_downD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> tr_edrel_eclose eclose_sing <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>context</span></span> M_ctm
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Names-upairM><span class=command>lemma</span></span> upairM <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=free>y</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=main>{</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>

<span class=keyword1 id=Names-singletonM><span class=command>lemma</span></span> singletonM <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=main>{</span><span class=free>a</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>

<span class=keyword1 id=Names-Rep_simp><span class=command>lemma</span></span> Rep_simp <span class=main>:</span> <span class=quoted><span class=quoted>"Replace<span class=main>(</span><span class=free>u</span><span class=main>,</span><span class=main>λ</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span> <span class=free>f</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>u</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_ctm *)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Values and check-names›</span></span>
<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Hcheck</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Hcheck</span><span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span>  <span class=main>≡</span> <span class=main>{</span> <span class=main>⟨</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>y</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>check</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>check</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> transrec<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>,</span> Hcheck<span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-checkD><span class=command>lemma</span></span> checkD<span class=main>:</span>
  <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span>  wfrec<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hcheck<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> check_def transrec_def <span class=keyword1><span class=command>..</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>rcheck</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rcheck</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span>


<span class=keyword1 id=Names-Hcheck_trancl><span class=command>lemma</span></span> Hcheck_trancl<span class=main>:</span><span class=quoted><span class=quoted>"Hcheck<span class=main>(</span><span class=free>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
                   <span class=main>=</span> Hcheck<span class=main>(</span><span class=free>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hcheck_def
  <span class=keyword1><span class=command>using</span></span> restrict_trans_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Names-check_trancl><span class=command>lemma</span></span> check_trancl<span class=main>:</span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span>rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hcheck<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> checkD wf_eq_trancl Hcheck_trancl <span class=keyword1><span class=command>unfolding</span></span> rcheck_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* relation of check is in M *)</span>
<span class=keyword1 id=Names-rcheck_in_M><span class=command>lemma</span></span> rcheck_in_M <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rcheck_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>


<span class=keyword1 id=Names-aux_def_check><span class=command>lemma</span></span>  aux_def_check<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>y</span> <span class=main>⟹</span>
  wfrec<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hcheck<span class=main>)</span> <span class=main>=</span>
  wfrec<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>x</span><span class=main>,</span> Hcheck<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> wfrec_eclose_eq<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> arg_into_eclose eclose_sing<span class=main>)</span>

<span class=keyword1 id=Names-def_check><span class=command>lemma</span></span> def_check <span class=main>:</span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span> <span class=main>⟨</span>check<span class=main>(</span><span class=bound>w</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>w</span> <span class=main>∈</span> <span class=free>y</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> wfr<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>w</span> <span class=main>.</span> wf<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=bound>w</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> wf_Memrel <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>=</span> Hcheck<span class=main>(</span> <span class=free>y</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>.</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> Hcheck<span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wfrec<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?r</span><span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>y</span></span> <span class=quoted><span class=quoted>"Hcheck"</span></span><span class=main>]</span> checkD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> Hcheck<span class=main>(</span> <span class=free>y</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=free>y</span><span class=main>.</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> Hcheck<span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> under_Memrel_eclose arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> Hcheck<span class=main>(</span> <span class=free>y</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=free>y</span><span class=main>.</span> check<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> aux_def_check checkD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Hcheck_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Names-def_checkS><span class=command>lemma</span></span> def_checkS <span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>n</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> check<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=bound>i</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>}</span> "</span></span>
    <span class=keyword1><span class=command>using</span></span> def_check <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=bound>i</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> <span class=free>n</span><span class=main>}</span> <span class=main>∪</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> check<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_check<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>n</span></span><span class=main>,</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-field_Memrel2><span class=command>lemma</span></span> field_Memrel2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"field<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"field<span class=main>(</span>Memrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Ordinal.Memrel_type field_rel_subset assms eclose_least<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> subset_trans <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Hv</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Hv</span><span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>y</span> <span class=main>..</span> <span class=bound><span class=bound>y</span></span><span class=main>∈</span> domain<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>G</span></span></span> <span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The funcion <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>val</span></span>›</span></span></span></span> interprets a name in <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>M</span></span>›</span></span></span></span>
according to a (generic) filter <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>G</span></span>›</span></span></span></span>. Note the definition
in terms of the well-founded recursor.›</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>val</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>val</span><span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>)</span> <span class=main>≡</span> wfrec<span class=main>(</span>edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>τ</span></span></span> <span class=main>,</span>Hv<span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-aux_def_val><span class=command>lemma</span></span> aux_def_val<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span>edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span>edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=main>.</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>x</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> arg_in_eclose_sing <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> relation_edrel <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wf<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> wf_edrel <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"tr_down<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⊆</span> eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> tr_edrel_subset <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>wfrec[</span>eclose<span class=main>(</span><span class=main>{</span><span class=free>z</span><span class=main>}</span><span class=main>)</span><span class=main>](</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wfrec_restr <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>z</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>x</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> restrict_edrel_eq wfrec_restr_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The next lemma provides the usual recursive expresion for the definition of term<span class=antiquoted><span class=raw_text><span class=antiquoted><span class=raw_text><span class=operator><span class=operator>‹</span></span>val›</span></span></span></span>.›</span></span>

<span class=keyword1 id=Names-def_val><span class=command>lemma</span></span> def_val<span class=main>:</span>  <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>x</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>τ</span> <span class=main>.</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>τ</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>z</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>x</span><span class=main>}</span><span class=main>.</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>τ</span><span class=main>.</span> wf<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=bound>τ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> wf_edrel <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> wfrec <span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> Hv<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=var>?f</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> val_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> Hv<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>.</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span>Hv<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> dom_under_edrel_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> Hv<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> aux_def_val val_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Hv_def SepReplace_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-val_mono><span class=command>lemma</span></span> val_mono <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>⊆</span><span class=free>y</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> def_val<span class=main><span class=keyword3>,</span></span> <span class=operator>force</span><span class=main>)</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Check-names are the canonical names for elements of the
ground model. Here we show that this is the case.›</span></span>

<span class=keyword1 id=Names-valcheck><span class=command>lemma</span></span> valcheck <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟹</span>  <span class=free>one</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>check<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>  <span class=main>=</span> <span class=free>y</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>eps_induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>    
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=skolem>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span> <span class=main>⟨</span>check<span class=main>(</span><span class=bound>w</span><span class=main>)</span><span class=main>,</span> <span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>w</span> <span class=main>∈</span> <span class=skolem>y</span><span class=main>}</span>"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> <span class=var>?C</span>"</span></span><span class=main>)</span> 
      <span class=keyword1><span class=command>using</span></span> def_check <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span>check<span class=main>(</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=bound>w</span><span class=main>)</span><span class=main>,</span> <span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>w</span> <span class=main>∈</span> <span class=skolem>y</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span>  <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?C</span><span class=main>)</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?C</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> def_val <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span>  <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?C</span><span class=main>)</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>w</span><span class=main>∈</span><span class=skolem>y</span><span class=main>.</span> <span class=bound>t</span><span class=main>=</span>check<span class=main>(</span><span class=bound>w</span><span class=main>)</span> <span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span>check<span class=main>(</span><span class=bound>w</span><span class=main>)</span><span class=main>)</span> <span class=main>.</span> <span class=bound>w</span><span class=main>∈</span><span class=skolem>y</span> <span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span>check<span class=main>(</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-val_of_name><span class=command>lemma</span></span> val_of_name <span class=main>:</span>
  <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>P</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span><span class=free>A</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=free>Q</span><span class=main>(</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>P</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>τ</span> <span class=main>.</span> edrel<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=bound>τ</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>z</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=var>?n</span><span class=main>}</span><span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span>
    wfR <span class=main>:</span> <span class=quoted><span class=quoted>"wf<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>τ</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> wf_edrel<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>t</span>
    <span class=keyword3><span class=command>assume</span></span> H<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> domain<span class=main>(</span><span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>`</span> <span class=skolem>t</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>t</span> <span class=main>∈</span> <span class=var>?r</span><span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=var>?n</span><span class=main>}</span> <span class=keyword1>then</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>t</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>0</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>t</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> dom_under_edrel_eclose H if_P <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> Eq1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> domain<span class=main>(</span><span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>t</span><span class=main>)</span> <span class=main>=</span> <span class=var>?f</span><span class=main>`</span> <span class=skolem>t</span>"</span></span>  <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> def_val<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=var>?f</span><span class=main>`</span><span class=bound>t</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Hv_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> SepReplace_dom_implies<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>Eq1<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>t</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=var>?n</span><span class=main>}</span> <span class=keyword1>then</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>0</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> Eq2<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span> <span class=main>⊆</span> <span class=var>?r</span><span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=var>?n</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> dom_under_edrel_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>t</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=var>?n</span><span class=main>}</span> <span class=keyword1>then</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>0</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span> <span class=main>(</span><span class=keyword1>if</span> <span class=bound>t</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=var>?n</span><span class=main>}</span> <span class=keyword1>then</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=keyword1>else</span> <span class=main>0</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span> <span class=main>=</span>
          <span class=main>{</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?n</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>" val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span>  <span class=main>=</span> <span class=main>{</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span><span class=free>A</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-val_of_name_alt><span class=command>lemma</span></span> val_of_name_alt <span class=main>:</span>
  <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>P</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span><span class=free>A</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>∩</span><span class=free>G</span> <span class=main>.</span>  <span class=free>Q</span><span class=main>(</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>)</span> <span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> val_of_name <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1 id=Names-val_only_names><span class=command>lemma</span></span> val_only_names<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=var>?name</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=var>?name</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>F</span><span class=main>,</span> <span class=bound>t</span><span class=main>)</span><span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?name</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?name</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>F</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_val <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>F</span><span class=main>,</span> <span class=bound>t</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span><span class=main>∈</span><span class=main>{</span><span class=bound>y</span><span class=main>∈</span>domain<span class=main>(</span><span class=var>?name</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?name</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>F</span><span class=main>}</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Sep_and_Replace <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>F</span><span class=main>,</span> <span class=bound>t</span><span class=main>)</span><span class=main>.</span> <span class=bound>t</span><span class=main>∈</span><span class=main>{</span><span class=bound>y</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>F</span><span class=main>}</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>F</span><span class=main>,</span> <span class=bound>t</span><span class=main>)</span><span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>F</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Sep_and_Replace <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_val<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-val_only_pairs><span class=command>lemma</span></span> val_only_pairs<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=var>?name</span><span class=main>)</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> val_only_names <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> val_mono<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?name</span></span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> val_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-val_subset_domain_times_range><span class=command>lemma</span></span> val_subset_domain_times_range<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>×</span>range<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> val_only_pairs<span class=main>[</span><span class=operator>THEN</span> equalityD1<span class=main>]</span>
    val_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>×</span>range<span class=main>(</span><span class=free>τ</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Names-val_subset_domain_times_P><span class=command>lemma</span></span> val_subset_domain_times_P<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>F</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>F</span><span class=main>,</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> val_only_names<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>F</span></span> <span class=quoted><span class=free>τ</span></span><span class=main>]</span> val_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>τ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span>"</span></span> <span class=quoted><span class=free>F</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>GenExt</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span>     <span class=main>(</span><span class=quoted>"<span class=keyword1>M[</span>_<span class=keyword1>]</span>"</span><span class=main>)</span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>GenExt</span><span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>)</span><span class=main>≡</span> <span class=main>{</span>val<span class=main>(</span><span class=free><span class=bound><span class=entity>G</span></span></span><span class=main>,</span><span class=bound>τ</span><span class=main>)</span><span class=main>.</span> <span class=bound>τ</span> <span class=main>∈</span> <span class=free>M</span><span class=main>}</span>"</span></span>


<span class=keyword1 id=Names-val_of_elem><span class=command>lemma</span></span> val_of_elem<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>π</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>π</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>θ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>π</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>θ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>π</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>π</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>∈</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=free>π</span><span class=main>)</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>π</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> def_val<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-elem_of_val><span class=command>lemma</span></span> elem_of_val<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>π</span><span class=main>)</span><span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> def_val<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Names-elem_of_val_pair><span class=command>lemma</span></span> elem_of_val_pair<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>θ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span>  <span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>π</span> <span class=main>∧</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> def_val<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id="Names-elem_of_val_pair'"><span class=command>lemma</span></span> elem_of_val_pair'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>π</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span>  <span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>π</span> <span class=main>∧</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>θ</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>π</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> elem_of_val_pair <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=quoted><span class=quoted>‹<span class=free>π</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> pair_in_M_iff<span class=main>[</span><span class=operator>THEN</span> iffD1<span class=main>,</span> <span class=operator>THEN</span> conjunct1<span class=main>,</span> <span class=operator>simplified</span><span class=main>]</span>
      transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Names-GenExtD><span class=command>lemma</span></span> GenExtD<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>τ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>GenExt_def<span class=main>)</span>

<span class=keyword1 id=Names-GenExtI><span class=command>lemma</span></span> GenExtI<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> GenExt_def<span class=main>)</span>

<span class=keyword1 id=Names-Transset_MG><span class=command>lemma</span></span> Transset_MG <span class=main>:</span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>vc</span> <span class=skolem>y</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vc</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>vc</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>c</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>c</span><span class=main>)</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>c</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>c</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>θ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>c</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem_of_val <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> trans_M <span class=quoted><span class=quoted>‹<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> domain_trans GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Transset_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> transitivity_MG <span class=main>=</span> Transset_intf<span class=main>[</span><span class=operator>OF</span> Transset_MG<span class=main>]</span>

<span class=keyword1 id=Names-check_n_M><span class=command>lemma</span></span> check_n_M <span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>n</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>n</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> zero_in_M <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> def_check<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>succ <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> one_in_P P_sub_M subsetD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span>check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> tuples_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> singletonM <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>∪</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> def_checkS <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>PHcheck</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PHcheck</span><span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>fy</span><span class=main>[</span><span class=main>##</span><span class=free>M</span><span class=main>].</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>fy</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>fy</span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Hcheck</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Hcheck</span><span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span>  <span class=main>≡</span> is_Replace<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-one_in_M><span class=command>lemma</span></span> one_in_M<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> one_in_P P_in_M<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> transitivity<span class=main>)</span>

<span class=keyword1 id=Names-def_PHcheck><span class=command>lemma</span></span> def_PHcheck<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"Hcheck<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>f</span><span class=main>)</span> <span class=main>=</span> Replace<span class=main>(</span><span class=free>z</span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>z</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> tuples_in_M one_in_M transitivity that apply_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>z</span><span class=main>,</span> <span class=bound>y</span> <span class=main>=</span> <span class=main>⟨</span><span class=free>f</span> <span class=main>`</span> <span class=bound>x</span><span class=main>,</span> <span class=free>one</span><span class=main>⟩</span><span class=main>}</span> <span class=main>=</span>  <span class=main>{</span><span class=bound>y</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>z</span><span class=main>,</span> <span class=bound>y</span> <span class=main>=</span> <span class=main>⟨</span><span class=free>f</span> <span class=main>`</span> <span class=bound>x</span><span class=main>,</span> <span class=free>one</span><span class=main>⟩</span> <span class=main>∧</span> <span class=bound>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=free>f</span><span class=main>`</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>z</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>M</span>›</span></span> transitivity
    <span class=keyword1><span class=command>unfolding</span></span> Hcheck_def PHcheck_def RepFun_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(*
  "PHcheck(o,f,y,p) ≡ ∃fy[##M]. fun_apply(##M,f,y,fy) ∧ pair(##M,fy,o,p)"
*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>PHcheck_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PHcheck_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>fun_apply_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>
                                 <span class=main>,</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-PHcheck_type><span class=command>lemma</span></span> PHcheck_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>u</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> PHcheck_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>u</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>PHcheck_fm_def<span class=main>)</span>

<span class=keyword1 id=Names-sats_PHcheck_fm><span class=command>lemma</span></span> sats_PHcheck_fm <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>u</span> <span class=main>∈</span> nat <span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>PHcheck_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>u</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        PHcheck<span class=main>(</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>u</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> zero_in_M Internalizations.nth_closed <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> PHcheck_def PHcheck_fm_def<span class=main>)</span>

<span class=comment1>(*
  "is_Hcheck(o,z,f,hc)  ≡ is_Replace(##M,z,PHcheck(o,f),hc)"
*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Hcheck_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Hcheck_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span> <span class=main>≡</span> Replace_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span>PHcheck_fm<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>hc</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-is_Hcheck_type><span class=command>lemma</span></span> is_Hcheck_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>u</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> is_Hcheck_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>u</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>is_Hcheck_fm_def<span class=main>)</span>

<span class=keyword1 id=Names-sats_is_Hcheck_fm><span class=command>lemma</span></span> sats_is_Hcheck_fm <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>z</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>u</span> <span class=main>∈</span> nat <span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_Hcheck_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>u</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_Hcheck<span class=main>(</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>u</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> sats_Replace_fm <span class=keyword1><span class=command>unfolding</span></span> is_Hcheck_def is_Hcheck_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=comment1>(* instance of replacement for hcheck *)</span>
<span class=keyword1 id=Names-wfrec_Hcheck><span class=command>lemma</span></span> wfrec_Hcheck <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>X</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"wfrec_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>c</span><span class=main>)</span> <span class=main>⟷</span>
        sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_Hcheck_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>e</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>one</span><span class=main>,</span>rcheck<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span> <span class=skolem>e</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that one_in_M <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rcheck_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_wfrec_fm<span class=main>(</span>is_Hcheck_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
                    <span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>one</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span>
            is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span>  that sats_is_wfrec_fm <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rcheck_in_M one_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
               is_wfrec_fm<span class=main>(</span>is_Hcheck_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>one</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span>
              <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that 1 <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rcheck_in_M one_in_M <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> artyf<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_wfrec_fm_def is_Hcheck_fm_def Replace_fm_def PHcheck_fm_def
      pair_fm_def upair_fm_def is_recfun_fm_def fun_apply_fm_def big_union_fm_def
      pre_image_fm_def restriction_fm_def image_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free>one</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax 1 artyf <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> rcheck_in_M one_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>one</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>X</span><span class=main>)</span><span class=main>]</span>"</span></span><span class=main>]</span> satsf <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> wfrec_replacement_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-repl_PHcheck><span class=command>lemma</span></span> repl_PHcheck <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>PHcheck_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> PHcheck_fm_def fun_apply_fm_def big_union_fm_def pair_fm_def image_fm_def
      upair_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>PHcheck_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=free>f</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax one_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> one_in_M <span class=keyword1><span class=command>unfolding</span></span> strong_replacement_def univalent_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-univ_PHcheck><span class=command>lemma</span></span> univ_PHcheck <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>z</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>f</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> univalent<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>z</span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> univalent_def PHcheck_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Names-relation2_Hcheck><span class=command>lemma</span></span> relation2_Hcheck <span class=main>:</span>
  <span class=quoted><span class=quoted>"relation2<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span>Hcheck<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=skolem>x</span><span class=main>∈</span><span class=skolem>z</span><span class=main>;</span> PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span> <span class=skolem>f</span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>unfolding</span></span> PHcheck_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"is_Replace<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span><span class=main>,</span><span class=skolem>hc</span><span class=main>)</span> <span class=main>⟷</span> <span class=skolem>hc</span> <span class=main>=</span> Replace<span class=main>(</span><span class=skolem>z</span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>hc</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span> <span class=skolem>f</span> <span class=skolem>hc</span>
    <span class=keyword1><span class=command>using</span></span> that Replace_abs<span class=main>[</span><span class=operator>OF</span> _ _ univ_PHcheck 1<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> def_PHcheck
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> relation2_def is_Hcheck_def Hcheck_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-PHcheck_closed><span class=command>lemma</span></span> PHcheck_closed <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>z</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>f</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>x</span><span class=main>∈</span><span class=free>z</span><span class=main>;</span> PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> PHcheck_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Names-Hcheck_closed><span class=command>lemma</span></span> Hcheck_closed <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>g</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> function<span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟶</span> Hcheck<span class=main>(</span><span class=bound>y</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Replace<span class=main>(</span><span class=skolem>y</span><span class=main>,</span>PHcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=skolem>f</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>f</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that repl_PHcheck  PHcheck_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>y</span></span> <span class=quoted><span class=skolem>f</span></span><span class=main>]</span> univ_PHcheck
      strong_replacement_closed
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> def_PHcheck <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-wf_rcheck><span class=command>lemma</span></span> wf_rcheck <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> wf<span class=main>(</span>rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rcheck_def <span class=keyword1><span class=command>using</span></span> wf_trancl<span class=main>[</span><span class=operator>OF</span> wf_Memrel<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>

<span class=keyword1 id=Names-trans_rcheck><span class=command>lemma</span></span> trans_rcheck <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> trans<span class=main>(</span>rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rcheck_def <span class=keyword1><span class=command>using</span></span> trans_trancl <span class=keyword1><span class=command>.</span></span>

<span class=keyword1 id=Names-relation_rcheck><span class=command>lemma</span></span> relation_rcheck <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> relation<span class=main>(</span>rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rcheck_def <span class=keyword1><span class=command>using</span></span> relation_trancl <span class=keyword1><span class=command>.</span></span>

<span class=keyword1 id=Names-check_in_M><span class=command>lemma</span></span> check_in_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> check<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> transrec_def
  <span class=keyword1><span class=command>using</span></span> wfrec_Hcheck<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> check_trancl wf_rcheck trans_rcheck relation_rcheck rcheck_in_M
    Hcheck_closed relation2_Hcheck trans_wfrec_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=quoted>"is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span>"</span></span> <span class=quoted>Hcheck</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>

<span class=comment1>(* check if this should go to Relative! *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_singleton</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_singleton</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>c</span><span class=main>[</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>].</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=bound>c</span><span class=main>)</span> <span class=main>∧</span> is_cons<span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>c</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_trivial<span class=main>)</span> singleton_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span> <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>M</span><span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>;</span> <span class=free>M</span><span class=main>(</span><span class=free>s</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span> is_singleton<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>s</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>s</span> <span class=main>=</span> <span class=main>{</span><span class=free>x</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_singleton_def <span class=keyword1><span class=command>using</span></span> nonempty <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>singleton_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>singleton_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>empty_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> cons_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>j</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-singleton_type><span class=command>lemma</span></span> singleton_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> singleton_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> singleton_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Names-is_singleton_iff_sats><span class=command>lemma</span></span> is_singleton_iff_sats<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span><span class=main>;</span> nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>y</span><span class=main>;</span>
          <span class=free>i</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>j</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>⟧</span>
       <span class=main>⟹</span> is_singleton<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> singleton_fm<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_singleton_def singleton_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>context</span></span> forcing_data <span class=keyword2><span class=keyword>begin</span></span>

<span class=comment1>(* Internalization and absoluteness of rcheck *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_rcheck</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_rcheck</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> tran_closure<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>ec</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> membership<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>ec</span><span class=main>,</span><span class=bound>r</span><span class=main>)</span> <span class=main>∧</span>
                           <span class=main>(</span><span class=main>∃</span><span class=bound>s</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_singleton<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>s</span><span class=main>)</span> <span class=main>∧</span>  is_eclose<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=bound>ec</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-rcheck_abs><span class=command>lemma</span></span> rcheck_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>r</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_rcheck<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>r</span> <span class=main>=</span> rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rcheck_def is_rcheck_def
  <span class=keyword1><span class=command>using</span></span> singletonM trancl_closed Memrel_closed eclose_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>schematic_goal</span></span> rcheck_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_rcheck<span class=main>(</span>nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?rch</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_rcheck_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules is_singleton_iff_sats is_eclose_iff_sats
        trans_closure_fm_iff_sats <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"rcheck_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> rcheck_fm_auto

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_check</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_check</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>rch</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_rcheck<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>rch</span><span class=main>)</span> <span class=main>∧</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span><span class=bound>rch</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-check_abs><span class=command>lemma</span></span> check_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_check<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>z</span> <span class=main>=</span> check<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"is_check<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span>rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_check_def <span class=keyword1><span class=command>using</span></span> assms rcheck_abs rcheck_in_M
    <span class=keyword1><span class=command>unfolding</span></span> check_trancl is_check_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> check_trancl
    <span class=keyword1><span class=command>using</span></span> assms wfrec_Hcheck<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> wf_rcheck trans_rcheck relation_rcheck rcheck_in_M
      Hcheck_closed relation2_Hcheck trans_wfrec_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"rcheck<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=quoted>"is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span>"</span></span> <span class=quoted>Hcheck</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* ∃rch∈M. is_rcheck(x,rch) ∧ is_wfrec(##M,is_Hcheck(one),rch,x,z) *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>check_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>check_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>rcheck_fm<span class=main>(</span><span class=main>1</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
                      is_wfrec_fm<span class=main>(</span>is_Hcheck_fm<span class=main>(</span><span class=main>6</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=main>1</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Names-check_fm_type><span class=command>lemma</span></span> check_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>o</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>z</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> check_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> check_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Names-sats_check_fm><span class=command>lemma</span></span> sats_check_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>o</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>one</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>o</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> check_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_check<span class=main>(</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> sats_is_Hcheck_fm<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a0</span> <span class=bound>a1</span> <span class=bound>a2</span> <span class=bound>a3</span> <span class=bound>a4</span><span class=main>.</span> <span class=main>⟦</span> <span class=bound>a0</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=bound>a1</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=bound>a2</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=bound>a3</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=bound>a4</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span>
         is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span> <span class=bound>a1</span><span class=main>,</span> <span class=bound>a0</span><span class=main>)</span> <span class=main>⟷</span>
         sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_Hcheck_fm<span class=main>(</span><span class=main>6</span><span class=main>#+</span><span class=free>o</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=bound>a0</span><span class=main>,</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>a4</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> that one_in_M assms  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> is_wfrec_fm<span class=main>(</span>is_Hcheck_fm<span class=main>(</span><span class=main>6</span><span class=main>#+</span><span class=free>o</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>#+</span><span class=free>x</span><span class=main>,</span><span class=main>1</span><span class=main>#+</span><span class=free>z</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>r</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>
        <span class=main>⟷</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hcheck<span class=main>(</span><span class=free>one</span><span class=main>)</span><span class=main>,</span><span class=skolem>r</span><span class=main>,</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> that assms one_in_M sats_is_wfrec_fm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> is_check_def check_fm_def
    <span class=keyword1><span class=command>using</span></span> assms rcheck_in_M one_in_M rcheck_fm_iff_sats<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Names-check_replacement><span class=command>lemma</span></span> check_replacement<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>{</span>check<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>P</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>check_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> check_fm_def rcheck_fm_def trans_closure_fm_def is_eclose_fm_def mem_eclose_fm_def
      is_Hcheck_fm_def Replace_fm_def PHcheck_fm_def finite_ordinal_fm_def is_iterates_fm_def
      is_wfrec_fm_def is_recfun_fm_def restriction_fm_def pre_image_fm_def eclose_n_fm_def
      is_nat_case_fm_def quasinat_fm_def Memrel_fm_def singleton_fm_def fm_defs iterates_MH_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that Transset_intf<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=free>P</span></span><span class=main>]</span> trans_M check_in_M P_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> sats_check_fm check_abs P_in_M check_in_M one_in_M
      Repl_in_M<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"check_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>one</span><span class=main>]</span>"</span></span> <span class=quoted>is_check</span> <span class=quoted>check</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-pair_check><span class=command>lemma</span></span> pair_check <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span>  <span class=main>⟹</span> <span class=main>(</span><span class=main>∃</span><span class=bound>c</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_check<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=bound>c</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>c</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> <span class=main>⟨</span>check<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> check_abs check_in_M tuples_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Names-M_subset_MG><span class=command>lemma</span></span> M_subset_MG <span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟹</span> <span class=free>M</span> <span class=main>⊆</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> check_in_M one_in_P GenExtI
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> subsetI<span class=main><span class=keyword3>,</span></span> <span class=operator>subst</span> valcheck <span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>G</span></span></span></span></span></span><span class=main><span class=main>,</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The name for the generic filter›</span></span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>G_dot</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>G_dot</span> <span class=main>≡</span> <span class=main>{</span><span class=main>⟨</span>check<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>}</span>"</span></span>

<span class=keyword1 id=Names-G_dot_in_M><span class=command>lemma</span></span> G_dot_in_M <span class=main>:</span>
  <span class=quoted><span class=quoted>"G_dot <span class=main>∈</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?is_pcheck</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>∃</span><span class=bound>ch</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_check<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>ch</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>ch</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?pcheck_fm</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>check_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?pcheck_fm</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?is_pcheck</span><span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> sats_check_fm that one_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?is_pcheck</span><span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=skolem>y</span> <span class=main>=</span> <span class=main>⟨</span>check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span><span class=skolem>x</span><span class=main>⟩</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that check_abs check_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?pcheck_fm</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?pcheck_fm</span><span class=main>)</span><span class=main>=</span><span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> check_fm_def rcheck_fm_def trans_closure_fm_def is_eclose_fm_def mem_eclose_fm_def
      is_Hcheck_fm_def Replace_fm_def PHcheck_fm_def finite_ordinal_fm_def is_iterates_fm_def
      is_wfrec_fm_def is_recfun_fm_def restriction_fm_def pre_image_fm_def eclose_n_fm_def
      is_nat_case_fm_def quasinat_fm_def Memrel_fm_def singleton_fm_def fm_defs iterates_MH_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>from</span></span> P_in_M check_in_M tuples_in_M P_sub_M
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span>check<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> G_dot_def
    <span class=keyword1><span class=command>using</span></span> one_in_M P_in_M Repl_in_M<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?pcheck_fm</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>one</span><span class=main>]</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Names-val_G_dot><span class=command>lemma</span></span> val_G_dot <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>G</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span>G_dot<span class=main>)</span> <span class=main>=</span> <span class=free>G</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> equalityI subsetI<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span>G_dot<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>θ</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span> <span class=main>∈</span> G_dot"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span> <span class=main>=</span> check<span class=main>(</span><span class=skolem>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> G_dot_def <span class=keyword1><span class=command>using</span></span> elem_of_val_pair G_dot_in_M
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>one</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>›</span></span> <span class=keyword3><span class=command>show</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>G</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valcheck P_sub_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span>check<span class=main>(</span><span class=skolem>q</span><span class=main>)</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> G_dot"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>unfolding</span></span> G_dot_def <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span>check<span class=main>(</span><span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>G_dot<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> val_of_elem G_dot_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>one</span><span class=main>∈</span><span class=free>G</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>G_dot<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> P_sub_M valcheck <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Names-G_in_Gen_Ext><span class=command>lemma</span></span> G_in_Gen_Ext <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>G</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>   <span class=quoted><span class=quoted>"<span class=free>G</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms val_G_dot GenExtI<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> G_dot_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=comment1>(* Move this to M_trivial *)</span>
<span class=keyword1 id=Names-fst_snd_closed><span class=command>lemma</span></span> fst_snd_closed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> fst<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> snd<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>∈</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>.</span> <span class=free>p</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>a</span><span class=main>,</span> <span class=bound>b</span><span class=main>⟩</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"fst<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> snd<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> fst_def snd_def <span class=keyword1><span class=command>using</span></span> zero_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>a</span><span class=main>,</span> <span class=skolem>b</span><span class=main>⟩</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> True
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"snd<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> fst_def snd_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span> <span class=main>=</span> <span class=main>_</span>›</span></span> Pair_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>Transset_M<span class=main><span class=main>[</span></span><span class=operator>OF</span> trans_M<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span>  <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Transset_M<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>}</span>"</span></span> <span class=quoted><span class=free>p</span></span><span class=main>]</span> Transset_M<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>b</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>}</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span> <span class=main>=</span> <span class=main>_</span>›</span></span> Pair_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>

<span class=keyword1><span class=command>locale</span></span> G_generic <span class=main>=</span> forcing_data <span class=main>+</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>G</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> generic <span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Names-zero_in_MG><span class=command>lemma</span></span> zero_in_MG <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> zero_in_M elem_of_val <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> GenExtI zero_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Names-G_nonempty><span class=command>lemma</span></span> G_nonempty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>G</span><span class=main>≠</span><span class=main>0</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>⊆</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>with</span></span> P_in_M P_dense <span class=quoted><span class=quoted>‹<span class=free>P</span><span class=main>⊆</span><span class=free>P</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> generic <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* context G_generic *)</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=FrecR><div class=head><h1>Theory FrecR</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Well-founded relation on names›</span></span>
<span class=keyword1><span class=command>theory</span></span> FrecR <span class=keyword2><span class=keyword>imports</span></span> <a href=Names.html>Names</a> <a href=Synthetic_Definition.html>Synthetic_Definition</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lemmas</span></span> sep_rules' <span class=main>=</span> nth_0 nth_ConsI FOL_iff_sats function_iff_sats
  fun_plus_iff_sats omega_iff_sats FOL_sats_iff 

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹<span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>frecR</span></span>›</span></span></span></span> is the well-founded relation on names that allows
us to define forcing for atomic formulas.›</span></span>

<span class=comment1>(* MOVE THIS. absoluteness of higher-order composition *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_hcomp</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_hcomp</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>is_f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>is_g</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=free><span class=bound><span class=entity>is_g</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>is_f</span></span></span><span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span>"</span></span> 

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_trivial<span class=main>)</span> hcomp_abs<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span>
    is_f_abs<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span> <span class=bound>z</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>is_f</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    is_g_abs<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span> <span class=bound>z</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>is_g</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>g</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    g_closed<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span><span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=free>g</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_hcomp<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>is_f</span><span class=main>,</span><span class=free>is_g</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>w</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>w</span> <span class=main>=</span> <span class=free>f</span><span class=main>(</span><span class=free>g</span><span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> is_hcomp_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>hcomp_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>,</span>i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>hcomp_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>pf</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>pg</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span><span class=free><span class=bound><span class=entity>pg</span></span></span><span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>pf</span></span></span><span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-sats_hcomp_fm><span class=command>lemma</span></span> sats_hcomp_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    f_iff_sats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span> <span class=bound>b</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>a</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=bound>b</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> 
                 <span class=free>is_f</span><span class=main>(</span>nth<span class=main>(</span><span class=bound>a</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=bound>b</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>pf</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    g_iff_sats<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span> <span class=bound>b</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>a</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=bound>b</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=bound>z</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> 
                <span class=free>is_g</span><span class=main>(</span>nth<span class=main>(</span><span class=bound>a</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=bound>b</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>pg</span><span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=bound>b</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=bound>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>w</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>hcomp_fm<span class=main>(</span><span class=free>pf</span><span class=main>,</span><span class=free>pg</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>w</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_hcomp<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_f</span><span class=main>,</span><span class=free>is_g</span><span class=main>,</span>nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>w</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>pf</span><span class=main>(</span><span class=main>0</span><span class=main>,</span> succ<span class=main>(</span><span class=skolem>w</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_f</span><span class=main>(</span><span class=skolem>x</span><span class=main>,</span>nth<span class=main>(</span><span class=skolem>w</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span><span class=main>∈</span>nat"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>w</span>
    <span class=keyword1><span class=command>using</span></span> f_iff_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>w</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>pg</span><span class=main>(</span>succ<span class=main>(</span><span class=skolem>a</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>x</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_g</span><span class=main>(</span>nth<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span>nat"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>a</span>
    <span class=keyword1><span class=command>using</span></span> g_iff_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> hcomp_fm_def is_hcomp_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(* Preliminary *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ftype</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ftype</span> <span class=main>≡</span> fst"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>name1</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>name1</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> fst<span class=main>(</span>snd<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>name2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>name2</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> fst<span class=main>(</span>snd<span class=main>(</span>snd<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>cond_of</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>cond_of</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> snd<span class=main>(</span>snd<span class=main>(</span>snd<span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-components_simp><span class=command>lemma</span></span> components_simp<span class=main>:</span>
  <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=free>f</span>"</span></span>
  <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=free>n1</span>"</span></span>
  <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=free>n2</span>"</span></span>
  <span class=quoted><span class=quoted>"cond_of<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ftype_def name1_def name2_def cond_of_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>eclose_n</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eclose_n</span><span class=main>(</span><span class=free><span class=bound><span class=entity>name</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> eclose<span class=main>(</span><span class=main>{</span><span class=free><span class=bound><span class=entity>name</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ecloseN</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ecloseN</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> eclose_n<span class=main>(</span>name1<span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>∪</span> eclose_n<span class=main>(</span>name2<span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-components_in_eclose><span class=command>lemma</span></span> components_in_eclose <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>n2</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ecloseN_def eclose_n_def
  <span class=keyword1><span class=command>using</span></span> components_simp arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemmas</span></span> names_simp <span class=main>=</span> components_simp<span class=main>(</span>2<span class=main>)</span> components_simp<span class=main>(</span>3<span class=main>)</span>

<span class=keyword1 id=FrecR-ecloseNI1><span class=command>lemma</span></span> ecloseNI1 <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∨</span> <span class=free>x</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>n2</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>c</span><span class=main>⟩</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> ecloseN_def eclose_n_def
  <span class=keyword1><span class=command>using</span></span> assms eclose_sing names_simp
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemmas</span></span> ecloseNI <span class=main>=</span> ecloseNI1

<span class=keyword1 id=FrecR-ecloseN_mono><span class=command>lemma</span></span> ecloseN_mono <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>u</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>u</span><span class=main>∈</span>eclose<span class=main>(</span><span class=main>{</span>name1<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span> <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=main>{</span>name2<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> ecloseN_def  eclose_n_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> a
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> ecloseN_def  eclose_n_def
      <span class=keyword1><span class=command>using</span></span> eclose_singE<span class=main>[</span><span class=operator>OF</span> a<span class=main>]</span> mem_eclose_trans<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>u</span></span> <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> b
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> ecloseN_def eclose_n_def
      <span class=keyword1><span class=command>using</span></span> eclose_singE<span class=main>[</span><span class=operator>OF</span> b<span class=main>]</span> mem_eclose_trans<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>u</span></span> <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>(* ftype(p) ≡ THE a. ∃b. p = ⟨a, b⟩ *)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_fst</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_fst</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> 
                       <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>w</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>w</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>fst_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>fst_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> Or<span class=main>(</span>Exists<span class=main>(</span>pair_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                   And<span class=main>(</span>Neg<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span> <span class=main>#+</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>empty_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-sats_fst_fm><span class=command>lemma</span></span> sats_fst_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> fst_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_fst<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fst_fm_def is_fst_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>is_ftype</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_ftype</span> <span class=main>≡</span> is_fst"</span></span> 

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ftype_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ftype_fm</span> <span class=main>≡</span> fst_fm"</span></span> 

<span class=keyword1 id=FrecR-sats_ftype_fm><span class=command>lemma</span></span> sats_ftype_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> ftype_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_ftype<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ftype_fm_def is_ftype_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_fst_fm<span class=main>)</span>

<span class=keyword1 id=FrecR-is_ftype_iff_sats><span class=command>lemma</span></span> is_ftype_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>b</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>bb</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_ftype<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>,</span><span class=free>bb</span><span class=main>)</span>  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>ftype_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_ftype_fm<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_snd</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_snd</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> 
                       <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>w</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=bound>w</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>snd_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>snd_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> Or<span class=main>(</span>Exists<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                   And<span class=main>(</span>Neg<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span> <span class=main>#+</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>empty_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-sats_snd_fm><span class=command>lemma</span></span> sats_snd_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> snd_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> snd_fm_def is_snd_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_name1</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_name1</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> is_hcomp<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_fst<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span>is_snd<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>name1_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>name1_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> hcomp_fm<span class=main>(</span>fst_fm<span class=main>,</span>snd_fm<span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> 

<span class=keyword1 id=FrecR-sats_name1_fm><span class=command>lemma</span></span> sats_name1_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> name1_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_name1<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> name1_fm_def is_name1_def <span class=keyword1><span class=command>using</span></span> sats_fst_fm sats_snd_fm 
    sats_hcomp_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=quoted>"is_fst<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=main>_</span> <span class=quoted>fst_fm</span> <span class=quoted><span class=quoted>"is_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=FrecR-is_name1_iff_sats><span class=command>lemma</span></span> is_name1_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>b</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>bb</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_name1<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>,</span><span class=free>bb</span><span class=main>)</span>  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>name1_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_name1_fm<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_snd_snd</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_snd_snd</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> is_hcomp<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_snd<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span>is_snd<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>snd_snd_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span><span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>snd_snd_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> hcomp_fm<span class=main>(</span>snd_fm<span class=main>,</span>snd_fm<span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-sats_snd2_fm><span class=command>lemma</span></span> sats_snd2_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>snd_snd_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_snd_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snd_snd_fm_def is_snd_snd_def <span class=keyword1><span class=command>using</span></span> sats_snd_fm 
    sats_hcomp_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=quoted>"is_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=main>_</span> <span class=quoted>snd_fm</span> <span class=quoted><span class=quoted>"is_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_name2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_name2</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t3</span></span></span><span class=main>)</span> <span class=main>≡</span> is_hcomp<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_fst<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span>is_snd_snd<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t3</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>name2_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>name2_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t3</span></span></span><span class=main>)</span> <span class=main>≡</span> hcomp_fm<span class=main>(</span>fst_fm<span class=main>,</span>snd_snd_fm<span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t3</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-sats_name2_fm><span class=command>lemma</span></span> sats_name2_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>name2_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_name2<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> name2_fm_def is_name2_def <span class=keyword1><span class=command>using</span></span> sats_fst_fm sats_snd2_fm
    sats_hcomp_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=quoted>"is_fst<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=main>_</span> <span class=quoted>fst_fm</span> <span class=quoted><span class=quoted>"is_snd_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=FrecR-is_name2_iff_sats><span class=command>lemma</span></span> is_name2_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>b</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>bb</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_name2<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>,</span><span class=free>bb</span><span class=main>)</span>  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>name2_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_name2_fm<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_cond_of</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>i<span class=main>⇒</span>o<span class=main>)</span><span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_cond_of</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t4</span></span></span><span class=main>)</span> <span class=main>≡</span> is_hcomp<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_snd<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span>is_snd_snd<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t4</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>cond_of_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>cond_of_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t4</span></span></span><span class=main>)</span> <span class=main>≡</span> hcomp_fm<span class=main>(</span>snd_fm<span class=main>,</span>snd_snd_fm<span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t4</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-sats_cond_of_fm><span class=command>lemma</span></span> sats_cond_of_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span><span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> 
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>cond_of_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        is_cond_of<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> cond_of_fm_def is_cond_of_def <span class=keyword1><span class=command>using</span></span> sats_snd_fm sats_snd2_fm
    sats_hcomp_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=quoted>"is_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=main>_</span> <span class=quoted>snd_fm</span> <span class=quoted><span class=quoted>"is_snd_snd<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=FrecR-is_cond_of_iff_sats><span class=command>lemma</span></span> is_cond_of_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>b</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>bb</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_cond_of<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>,</span><span class=free>bb</span><span class=main>)</span>  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>cond_of_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_cond_of_fm<span class=main>)</span>

<span class=keyword1 id=FrecR-components_type><span class=command>lemma</span></span> components_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"ftype_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> 
    <span class=quoted><span class=quoted>"name1_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
    <span class=quoted><span class=quoted>"name2_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
    <span class=quoted><span class=quoted>"cond_of_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> ftype_fm_def fst_fm_def snd_fm_def snd_snd_fm_def name1_fm_def name2_fm_def 
    cond_of_fm_def hcomp_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemmas</span></span> sats_components_fm<span class=main>[</span><span class=operator>simp</span><span class=main>]</span> <span class=main>=</span> sats_ftype_fm sats_name1_fm sats_name2_fm sats_cond_of_fm

<span class=keyword1><span class=command>lemmas</span></span> components_iff_sats <span class=main>=</span> is_ftype_iff_sats is_name1_iff_sats is_name2_iff_sats
  is_cond_of_iff_sats

<span class=keyword1><span class=command>lemmas</span></span> components_defs <span class=main>=</span> fst_fm_def ftype_fm_def snd_fm_def snd_snd_fm_def hcomp_fm_def
  name1_fm_def name2_fm_def cond_of_fm_def


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_eclose_n</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span><span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span><span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_eclose_n</span><span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>is_name</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>en</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> 
        <span class=main>∃</span><span class=bound>n1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>].</span><span class=main>∃</span><span class=bound>s1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>].</span> <span class=free><span class=bound><span class=entity>is_name</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>,</span><span class=bound>n1</span><span class=main>)</span> <span class=main>∧</span> is_singleton<span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span><span class=bound>n1</span><span class=main>,</span><span class=bound>s1</span><span class=main>)</span> <span class=main>∧</span> is_eclose<span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span><span class=bound>s1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>en</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>eclose_n1_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eclose_n1_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>And<span class=main>(</span>name1_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>singleton_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                                       is_eclose_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>eclose_n2_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eclose_n2_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>And<span class=main>(</span>name2_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>singleton_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                                       is_eclose_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_ecloseN</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_ecloseN</span><span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>en</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>en1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>].</span><span class=main>∃</span><span class=bound>en2</span><span class=main>[</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>].</span>
                is_eclose_n<span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span>is_name1<span class=main>,</span><span class=bound>en1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∧</span> is_eclose_n<span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span>is_name2<span class=main>,</span><span class=bound>en2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>∧</span>
                union<span class=main>(</span><span class=free><span class=bound><span class=entity>N</span></span></span><span class=main>,</span><span class=bound>en1</span><span class=main>,</span><span class=bound>en2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>en</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>ecloseN_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ecloseN_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>en</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>eclose_n1_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
                            And<span class=main>(</span>eclose_n2_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>en</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1 id=FrecR-ecloseN_fm_type><span class=command>lemma</span></span> ecloseN_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>en</span> <span class=main>∈</span> nat <span class=main>;</span> <span class=free>t</span> <span class=main>∈</span> nat <span class=main>⟧</span> <span class=main>⟹</span> ecloseN_fm<span class=main>(</span><span class=free>en</span><span class=main>,</span><span class=free>t</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ecloseN_fm_def eclose_n1_fm_def eclose_n2_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=FrecR-sats_ecloseN_fm><span class=command>lemma</span></span> sats_ecloseN_fm <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>en</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>t</span> <span class=main>∈</span> nat <span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> ecloseN_fm<span class=main>(</span><span class=free>en</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_ecloseN<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>en</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ecloseN_fm_def is_ecloseN_def eclose_n1_fm_def eclose_n2_fm_def is_eclose_n_def
  <span class=keyword1><span class=command>using</span></span>  nth_0 nth_ConsI sats_name1_fm sats_name2_fm 
    is_singleton_iff_sats<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>(* Relation of forces *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frecR</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frecR</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>≡</span>
    <span class=main>(</span>ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> 
      <span class=main>∧</span> <span class=main>(</span>name1<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name1<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>name2<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>∨</span> name2<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> name2<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
   <span class=main>∨</span> <span class=main>(</span>ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>=</span>  <span class=main>1</span> <span class=main>∧</span> name1<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>∧</span> name2<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-frecR_ftypeD><span class=command>lemma</span></span> frecR_ftypeD <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span>ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=FrecR-frecRI1><span class=command>lemma</span></span> frecRI1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∨</span> <span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>q</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q'</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=keyword1 id="FrecR-frecRI1'"><span class=command>lemma</span></span> frecRI1'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>q</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q'</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=keyword1 id=FrecR-frecRI2><span class=command>lemma</span></span> frecRI2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∨</span> <span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q'</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=keyword1 id="FrecR-frecRI2'"><span class=command>lemma</span></span> frecRI2'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q'</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>


<span class=keyword1 id=FrecR-frecRI3><span class=command>lemma</span></span> frecRI3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>s</span><span class=main>,</span> <span class=free>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>n2</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>q</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q'</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=keyword1 id="FrecR-frecRI3'"><span class=command>lemma</span></span> frecRI3'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>q</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>q'</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=keyword1 id=FrecR-frecR_iff><span class=command>lemma</span></span> frecR_iff <span class=main>:</span>
  <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span>
    <span class=main>(</span>ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> 
      <span class=main>∧</span> <span class=main>(</span>name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name1<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∨</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
   <span class=main>∨</span> <span class=main>(</span>ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span>  <span class=main>1</span> <span class=main>∧</span> name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∧</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>..</span></span>

<span class=keyword1 id=FrecR-frecR_D1><span class=command>lemma</span></span> frecR_D1 <span class=main>:</span>
  <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟹</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟹</span> ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> 
      <span class=main>(</span>name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name1<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∨</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> frecR_iff
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=FrecR-frecR_D2><span class=command>lemma</span></span> frecR_D2 <span class=main>:</span>
  <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟹</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>⟹</span> ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> 
      ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span>  <span class=main>1</span> <span class=main>∧</span> name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∧</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> frecR_iff
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=FrecR-frecR_DI><span class=command>lemma</span></span> frecR_DI <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span>ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span>name1<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span>cond_of<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=comment1>(*
name1(x) ∈ domain(name1(y)) ∪ domain(name2(y)) ∧ 
            (name2(x) = name1(y) ∨ name2(x) = name2(y)) 
          ∨ name1(x) = name1(y) ∧ name2(x) ∈ domain(name2(y))*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_frecR</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_frecR</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span> <span class=bound>ftx</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span> <span class=bound>n1x</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>n2x</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>fty</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>n1y</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>n2y</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>dn1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>dn2</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>
  is_ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>ftx</span><span class=main>)</span> <span class=main>∧</span> is_name1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>n1x</span><span class=main>)</span><span class=main>∧</span> is_name2<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>n2x</span><span class=main>)</span> <span class=main>∧</span>
  is_ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>fty</span><span class=main>)</span> <span class=main>∧</span> is_name1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>n1y</span><span class=main>)</span> <span class=main>∧</span> is_name2<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>n2y</span><span class=main>)</span>
          <span class=main>∧</span> is_domain<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>n1y</span><span class=main>,</span><span class=bound>dn1</span><span class=main>)</span> <span class=main>∧</span> is_domain<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>n2y</span><span class=main>,</span><span class=bound>dn2</span><span class=main>)</span> <span class=main>∧</span> 
          <span class=main>(</span>  <span class=main>(</span>number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ftx</span><span class=main>)</span> <span class=main>∧</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>fty</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>n1x</span> <span class=main>∈</span> <span class=bound>dn1</span> <span class=main>∨</span> <span class=bound>n1x</span> <span class=main>∈</span> <span class=bound>dn2</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>n2x</span> <span class=main>=</span> <span class=bound>n1y</span> <span class=main>∨</span> <span class=bound>n2x</span> <span class=main>=</span> <span class=bound>n2y</span><span class=main>)</span><span class=main>)</span>
           <span class=main>∨</span> <span class=main>(</span>empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ftx</span><span class=main>)</span> <span class=main>∧</span> number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>fty</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>n1x</span> <span class=main>=</span> <span class=bound>n1y</span> <span class=main>∧</span> <span class=bound>n2x</span> <span class=main>∈</span> <span class=bound>dn2</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>schematic_goal</span></span> sats_frecR_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>b</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_frecR<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?fr_fm</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span>  is_frecR_def is_Collect_def  
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules' cartprod_iff_sats  components_iff_sats
        <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>sats_cartprod_fm<span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"frecR_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> sats_frecR_fm_auto

<span class=comment1>(* Third item of Kunen observations about the trcl relation in p. 257. *)</span>
<span class=keyword1 id=FrecR-eq_ftypep_not_frecrR><span class=command>lemma</span></span> eq_ftypep_not_frecrR<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms frecR_ftypeD <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>rank_names</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rank_names</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> max<span class=main>(</span>rank<span class=main>(</span>name1<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span>rank<span class=main>(</span>name2<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-rank_names_types><span class=command>lemma</span></span> rank_names_types <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span>rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rank_names_def max_def <span class=keyword1><span class=command>using</span></span> Ord_rank Ord_Un <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>mtype_form</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mtype_form</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=keyword1>if</span> rank<span class=main>(</span>name1<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span>name2<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> <span class=main>2</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>type_form</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>type_form</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=keyword1>if</span> ftype<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>1</span> <span class=keyword1>else</span> mtype_form<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-type_form_tc><span class=command>lemma</span></span> type_form_tc <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=main>3</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> type_form_def mtype_form_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=FrecR-frecR_le_rnk_names><span class=command>lemma</span></span> frecR_le_rnk_names <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>≤</span>rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=skolem><span class=skolem>c</span></span> <span class=skolem><span class=skolem>d</span></span>  <span class=keyword2><span class=keyword>where</span></span>
    H<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>=</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>c</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>=</span> name2<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>a</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>c</span><span class=main>)</span><span class=main>∪</span>domain<span class=main>(</span><span class=skolem>d</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>b</span><span class=main>=</span><span class=skolem>c</span> <span class=main>∨</span> <span class=skolem>b</span> <span class=main>=</span> <span class=skolem>d</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>=</span> <span class=skolem>c</span> <span class=main>∧</span> <span class=skolem>b</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>d</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>consider</span></span>
    <span class=main>(</span>m<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>c</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>b</span> <span class=main>=</span> <span class=skolem>c</span> <span class=main>∨</span> <span class=skolem>b</span> <span class=main>=</span> <span class=skolem>d</span><span class=main>)</span> "</span></span>
    <span class=main>|</span> <span class=main>(</span>n<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>d</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>b</span> <span class=main>=</span> <span class=skolem>c</span> <span class=main>∨</span> <span class=skolem>b</span> <span class=main>=</span> <span class=skolem>d</span><span class=main>)</span>"</span></span> 
    <span class=main>|</span> <span class=main>(</span>o<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>d</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>a</span> <span class=main>=</span> <span class=skolem>c</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> m
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=skolem>c</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> eclose_rank_lt  in_dom_in_eclose  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=skolem>c</span><span class=main>)</span>›</span></span> H m
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rank_names_def <span class=keyword1><span class=command>using</span></span> Ord_rank max_cong max_cong2 leI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> n
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=skolem>d</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> eclose_rank_lt in_dom_in_eclose  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=skolem>d</span><span class=main>)</span>›</span></span> H n
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rank_names_def 
      <span class=keyword1><span class=command>using</span></span> Ord_rank max_cong2 max_cong max_commutes<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>c</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>d</span><span class=main>)</span>"</span></span><span class=main>]</span> leI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> o
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>b</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=skolem>d</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>&lt;</span> <span class=var>?d</span>"</span></span><span class=main>)</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> rank<span class=main>(</span><span class=skolem>c</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?a</span> <span class=main>=</span> <span class=main>_</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> eclose_rank_lt in_dom_in_eclose  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> H
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rank_names_def
      <span class=keyword1><span class=command>using</span></span> Ord_rank max_commutes max_cong2<span class=main>[</span><span class=operator>OF</span> leI<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?b</span> <span class=main>&lt;</span> <span class=var>?d</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>,</span> <span class=operator>of</span> <span class=var><span class=quoted><span class=var>?a</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>Γ</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Γ</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span> <span class=main>**</span> rank_names<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>++</span> type_form<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-Γ_type><span class=command>lemma</span></span> Γ_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span>Γ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Γ_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=FrecR-Γ_mono><span class=command>lemma</span></span> Γ_mono <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Γ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>&lt;</span> Γ<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> F<span class=main>:</span> <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>&lt;</span> <span class=main>3</span>"</span></span> <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>&lt;</span> <span class=main>3</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span> <span class=quoted><span class=quoted>"rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>≤</span> rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>≤</span> <span class=var>?y</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> frecR_le_rnk_names <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=var>?y</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> rank_names_def <span class=keyword1><span class=command>using</span></span> Ord_rank max_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>note</span></span> leE<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?x</span><span class=main>≤</span><span class=var>?y</span>›</span></span><span class=main>]</span> 
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> 1
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> Γ_def <span class=keyword1><span class=command>using</span></span> oadd_lt_mono2 <span class=quoted><span class=quoted>‹<span class=var>?x</span> <span class=main>&lt;</span> <span class=var>?y</span>›</span></span> F <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> 2
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span> <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> ftype<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  frecR_ftypeD<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> b
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> type_form_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>from</span></span> b
      <span class=keyword1><span class=command>have</span></span> H<span class=main>:</span> <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∨</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name2<span class=main>(</span><span class=free>y</span><span class=main>)</span> "</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?τ</span> <span class=main>=</span> <span class=var>?σ'</span> <span class=main>∨</span> <span class=var>?τ</span> <span class=main>=</span> <span class=var>?τ'</span>"</span></span><span class=main>)</span>
        <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name1<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span> 
        <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=var>?σ'</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=var>?τ'</span><span class=main>)</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> type_form_def frecR_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> E<span class=main>:</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?τ</span><span class=main>)</span> <span class=main>=</span> rank<span class=main>(</span><span class=var>?σ'</span><span class=main>)</span> <span class=main>∨</span> rank<span class=main>(</span><span class=var>?τ</span><span class=main>)</span> <span class=main>=</span> rank<span class=main>(</span><span class=var>?τ'</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>from</span></span> H
      <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?σ</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=var>?σ'</span><span class=main>)</span>"</span></span> <span class=main>|</span>  <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?σ</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=var>?τ'</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> eclose_rank_lt in_dom_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?σ</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=var>?τ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> a
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span> ›</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rank_names_def mtype_form_def type_form_def <span class=keyword1><span class=command>using</span></span> max_D2<span class=main>[</span><span class=operator>OF</span> E a<span class=main>]</span>
            E assms Ord_rank <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> b
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span> ›</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rank_names_def mtype_form_def type_form_def 
          <span class=keyword1><span class=command>using</span></span> max_D2<span class=main>[</span><span class=operator>OF</span> _ b<span class=main>]</span> max_commutes E assms Ord_rank disj_commute <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>with</span></span> b
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> type_form_def mtype_form_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span> ›</span></span> <span class=quoted><span class=quoted>‹type_form<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>›</span></span> <span class=quoted><span class=quoted>‹type_form<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>unfolding</span></span> Γ_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> a
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?σ</span> <span class=main>=</span> <span class=var>?σ'</span>"</span></span><span class=main>)</span> 
        <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name2<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?τ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=var>?τ'</span><span class=main>)</span>"</span></span><span class=main>)</span>
        <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> type_form_def frecR_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?σ</span><span class=main>)</span> <span class=main>=</span> rank<span class=main>(</span><span class=var>?σ'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?τ</span><span class=main>)</span> <span class=main>&lt;</span> rank<span class=main>(</span><span class=var>?τ'</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span>  eclose_rank_lt in_dom_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span> ›</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=var>?τ'</span><span class=main>)</span> <span class=main>≤</span> rank<span class=main>(</span><span class=var>?σ'</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>unfolding</span></span> rank_names_def <span class=keyword1><span class=command>using</span></span> Ord_rank max_D1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> a
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"type_form<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> type_form_def mtype_form_def <span class=keyword1><span class=command>using</span></span> not_lt_iff_le assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹rank_names<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> rank_names<span class=main>(</span><span class=free>y</span><span class=main>)</span> ›</span></span> <span class=quoted><span class=quoted>‹type_form<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>›</span></span> <span class=quoted><span class=quoted>‹type_form<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>unfolding</span></span> Γ_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frecrel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frecrel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> Rrel<span class=main>(</span>frecR<span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=FrecR-frecrelI><span class=command>lemma</span></span> frecrelI <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span>frecrel<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=FrecR-frecrelD><span class=command>lemma</span></span> frecrelD <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span><span class=free>A1</span><span class=main>×</span><span class=free>A2</span><span class=main>×</span><span class=free>A3</span><span class=main>×</span><span class=free>A4</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A1</span>"</span></span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A1</span>"</span></span>
    <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A2</span>"</span></span> <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A2</span>"</span></span> <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A3</span>"</span></span> <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A3</span>"</span></span> 
    <span class=quoted><span class=quoted>"cond_of<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A4</span>"</span></span> <span class=quoted><span class=quoted>"cond_of<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A4</span>"</span></span> 
    <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def ftype_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>

<span class=keyword1 id=FrecR-wf_frecrel><span class=command>lemma</span></span> wf_frecrel <span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wf<span class=main>(</span>frecrel<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⊆</span> measure<span class=main>(</span><span class=free>A</span><span class=main>,</span>Γ<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def measure_def
    <span class=keyword1><span class=command>using</span></span> Γ_mono <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> wf_subset wf_measure <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FrecR-core_induction_aux><span class=command>lemma</span></span> core_induction_aux<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>A1</span> <span class=free>A2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>A1</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span>  <span class=bound>p</span> <span class=main>∈</span> <span class=free>A2</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span> <span class=bound>q</span><span class=main>∈</span><span class=free>A2</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span>  <span class=bound>p</span> <span class=main>∈</span> <span class=free>A2</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span> <span class=bound>q</span><span class=main>∈</span><span class=free>A2</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=main>2</span><span class=main>×</span><span class=free>A1</span><span class=main>×</span><span class=free>A1</span><span class=main>×</span><span class=free>A2</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span>ftype<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>,</span>name1<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>,</span>name2<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>,</span>cond_of<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>a</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>wf_induct<span class=main><span class=main>[</span></span><span class=operator>OF</span> wf_frecrel<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted><span class=quoted>"<span class=main><span class=main>2</span></span><span class=main><span class=main>×</span></span><span class=free><span class=free>A1</span></span><span class=main><span class=main>×</span></span><span class=free><span class=free>A1</span></span><span class=main><span class=main>×</span></span><span class=free><span class=free>A2</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?τ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"name1<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?θ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"name2<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>2</span><span class=main>×</span><span class=free>A1</span><span class=main>×</span><span class=free>A1</span><span class=main>×</span><span class=free>A2</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?D</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"cond_of<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A2</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=var>?D</span>›</span></span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>eq<span class=main>)</span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>=</span><span class=main>0</span>"</span></span> <span class=main>|</span> <span class=main>(</span>mem<span class=main>)</span> <span class=quoted><span class=quoted>"ftype<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>=</span><span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> eq
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=var>?τ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=var>?θ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=var>?τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=var>?θ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=skolem>σ</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>from</span></span> 1
      <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?τ</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A1</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span>  arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span>  <span class=quoted><span class=quoted>‹Transset<span class=main>(</span><span class=free>A1</span><span class=main>)</span>›</span></span> that<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>eclose<span class=main>(</span><span class=var>?τ</span><span class=main>)</span> <span class=main>∪</span> eclose<span class=main>(</span><span class=var>?θ</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> in_dom_in_eclose  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> mem_eclose_subset<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span><span class=main>]</span> mem_eclose_subset<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>›</span></span><span class=main>]</span> 
          Transset_eclose_eq_arg<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹Transset<span class=main>(</span><span class=free>A1</span><span class=main>)</span>›</span></span><span class=main>]</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>         
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span> <span class=main>∈</span> <span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹cond_of<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=var>?τ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span><span class=main>,</span> <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=var>?T</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>"</span></span><span class=main>)</span>
        <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=var>?θ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span><span class=main>,</span> <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=var>?U</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span>  frecRI1'<span class=main>[</span><span class=operator>OF</span> that<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> frecR_DI  <span class=quoted><span class=quoted>‹ftype<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>›</span></span> 
          frecRI2'<span class=main>[</span><span class=operator>OF</span> that<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=var>?D</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=var>?T</span><span class=main>,</span><span class=skolem>x</span><span class=main>⟩</span><span class=main>∈</span> frecrel<span class=main>(</span><span class=var>?D</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=var>?U</span><span class=main>,</span><span class=skolem>x</span><span class=main>⟩</span><span class=main>∈</span> frecrel<span class=main>(</span><span class=var>?D</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> frecrelI<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?T</span></span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span>  frecrelI<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?U</span></span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=var>?τ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=var>?U</span><span class=main>,</span><span class=skolem>x</span><span class=main>⟩</span><span class=main>∈</span> frecrel<span class=main>(</span><span class=var>?D</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=var>?θ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>ultimately</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> A <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> <span class=quoted><span class=quoted>‹ftype<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>›</span></span> <span class=quoted><span class=quoted>‹cond_of<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> mem
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=var>?τ</span><span class=main>,</span>  <span class=skolem>σ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=var>?θ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=skolem>σ</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>from</span></span> 1 assms
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>"</span></span> <span class=quoted><span class=quoted>"cond_of<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?τ</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span><span class=main>∈</span>eclose<span class=main>(</span><span class=free>A1</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span>  arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span>  <span class=quoted><span class=quoted>‹Transset<span class=main>(</span><span class=free>A1</span><span class=main>)</span>›</span></span> that<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span> eclose<span class=main>(</span><span class=var>?θ</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> in_dom_in_eclose  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> mem_eclose_subset<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>›</span></span><span class=main>]</span> Transset_eclose_eq_arg<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹Transset<span class=main>(</span><span class=free>A1</span><span class=main>)</span>›</span></span><span class=main>]</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>         
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span> <span class=main>∈</span> <span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹cond_of<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=var>?τ</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span><span class=main>,</span> <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=var>?T</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span>  frecRI3'<span class=main>[</span><span class=operator>OF</span> that<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> frecR_DI  <span class=quoted><span class=quoted>‹ftype<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>›</span></span>                 
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=var>?D</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=var>?T</span><span class=main>,</span><span class=skolem>x</span><span class=main>⟩</span><span class=main>∈</span> frecrel<span class=main>(</span><span class=var>?D</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?T</span><span class=main>∈</span><span class=var>?D</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> frecrelI<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?T</span></span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>A2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?τ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span><span class=main>∈</span><span class=free>A1</span>›</span></span> 1
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> <span class=quoted><span class=quoted>‹ftype<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>›</span></span> <span class=quoted><span class=quoted>‹cond_of<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>A2</span>›</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FrecR-def_frecrel><span class=command>lemma</span></span> def_frecrel <span class=main>:</span> <span class=quoted><span class=quoted>"frecrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=bound>z</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def <span class=keyword1><span class=command>..</span></span>

<span class=keyword1 id=FrecR-frecrel_fst_snd><span class=command>lemma</span></span> frecrel_fst_snd<span class=main>:</span>
  <span class=quoted><span class=quoted>"frecrel<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=bound>z</span> <span class=main>∈</span> <span class=free>A</span><span class=main>×</span><span class=free>A</span> <span class=main>.</span> 
            ftype<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> 
        ftype<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> name1<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name1<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span>name2<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> 
            <span class=main>(</span>name2<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> name2<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> name2<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> 
          <span class=main>∨</span> <span class=main>(</span>ftype<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> 
        ftype<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span>  name1<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> name1<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> name2<span class=main>(</span>fst<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> domain<span class=main>(</span>name2<span class=main>(</span>snd<span class=main>(</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> def_frecrel frecR_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> equalityI subsetI CollectI<span class=main><span class=keyword3>;</span></span> <span class=operator>elim</span> CollectE<span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Arities><div class=head><h1>Theory Arities</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Arities of internalized formulas›</span></span>
<span class=keyword1><span class=command>theory</span></span> Arities
  <span class=keyword2><span class=keyword>imports</span></span> <a href=FrecR.html>FrecR</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Arities-arity_upair_fm><span class=command>lemma</span></span> arity_upair_fm <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span>  <span class=free>t1</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>up</span><span class=main>∈</span>nat  <span class=main>⟧</span> <span class=main>⟹</span> 
  arity<span class=main>(</span>upair_fm<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>up</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>t1</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>up</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span>  upair_fm_def
  <span class=keyword1><span class=command>using</span></span> nat_union_abs1 nat_union_abs2 pred_Un   
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Arities-arity_pair_fm><span class=command>lemma</span></span> arity_pair_fm <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span>  <span class=free>t1</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>p</span><span class=main>∈</span>nat  <span class=main>⟧</span> <span class=main>⟹</span> 
  arity<span class=main>(</span>pair_fm<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>t1</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> pair_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_upair_fm nat_union_abs1 nat_union_abs2 pred_Un
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_composition_fm><span class=command>lemma</span></span> arity_composition_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>s</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>composition_fm<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>r</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>s</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> composition_fm_def    
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_domain_fm><span class=command>lemma</span></span> arity_domain_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>domain_fm<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> domain_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_range_fm><span class=command>lemma</span></span> arity_range_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>range_fm<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> range_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_union_fm><span class=command>lemma</span></span> arity_union_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>union_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> union_fm_def
  <span class=keyword1><span class=command>using</span></span>  nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_image_fm><span class=command>lemma</span></span> arity_image_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>image_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> image_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm  nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_pre_image_fm><span class=command>lemma</span></span> arity_pre_image_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>pre_image_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> pre_image_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm  nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Arities-arity_big_union_fm><span class=command>lemma</span></span> arity_big_union_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>big_union_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> big_union_fm_def
  <span class=keyword1><span class=command>using</span></span> nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_fun_apply_fm><span class=command>lemma</span></span> arity_fun_apply_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>f</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> 
    arity<span class=main>(</span>fun_apply_fm<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>  succ<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fun_apply_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_upair_fm arity_image_fm arity_big_union_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_field_fm><span class=command>lemma</span></span> arity_field_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>field_fm<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> field_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm arity_domain_fm arity_range_fm arity_union_fm 
    nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_empty_fm><span class=command>lemma</span></span> arity_empty_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>empty_fm<span class=main>(</span><span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> empty_fm_def 
  <span class=keyword1><span class=command>using</span></span> nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Arities-arity_succ_fm><span class=command>lemma</span></span> arity_succ_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>y</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>succ_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> succ_fm_def cons_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_upair_fm arity_union_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Arities-number1arity__fm><span class=command>lemma</span></span> number1arity__fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>number1_fm<span class=main>(</span><span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> number1_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_empty_fm arity_succ_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Arities-arity_function_fm><span class=command>lemma</span></span> arity_function_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>function_fm<span class=main>(</span><span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> function_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Arities-arity_relation_fm><span class=command>lemma</span></span> arity_relation_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>relation_fm<span class=main>(</span><span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> relation_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Arities-arity_restriction_fm><span class=command>lemma</span></span> arity_restriction_fm <span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>r</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>A</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>restriction_fm<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>r</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>r</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> restriction_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_typed_function_fm><span class=command>lemma</span></span> arity_typed_function_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>f</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> 
    arity<span class=main>(</span>typed_function_fm<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> typed_function_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm arity_relation_fm arity_function_fm arity_domain_fm 
    nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Arities-arity_subset_fm><span class=command>lemma</span></span> arity_subset_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>y</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>subset_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> subset_fm_def 
  <span class=keyword1><span class=command>using</span></span> nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_transset_fm><span class=command>lemma</span></span> arity_transset_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>transset_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> transset_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_subset_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_ordinal_fm><span class=command>lemma</span></span> arity_ordinal_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>ordinal_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ordinal_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_transset_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_limit_ordinal_fm><span class=command>lemma</span></span> arity_limit_ordinal_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>limit_ordinal_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> limit_ordinal_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_ordinal_fm arity_succ_fm arity_empty_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_finite_ordinal_fm><span class=command>lemma</span></span> arity_finite_ordinal_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>finite_ordinal_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> finite_ordinal_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_ordinal_fm arity_limit_ordinal_fm arity_succ_fm arity_empty_fm 
    nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_omega_fm><span class=command>lemma</span></span> arity_omega_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>omega_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> omega_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_limit_ordinal_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_cartprod_fm><span class=command>lemma</span></span> arity_cartprod_fm <span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>A</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>B</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>cartprod_fm<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>B</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> cartprod_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_fst_fm><span class=command>lemma</span></span> arity_fst_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>fst_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fst_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm arity_empty_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_snd_fm><span class=command>lemma</span></span> arity_snd_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>snd_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snd_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm arity_empty_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_snd_snd_fm><span class=command>lemma</span></span> arity_snd_snd_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>snd_snd_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snd_snd_fm_def hcomp_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_snd_fm arity_empty_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_ftype_fm><span class=command>lemma</span></span> arity_ftype_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>ftype_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ftype_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_fst_fm 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-name1arity__fm><span class=command>lemma</span></span> name1arity__fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>name1_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> name1_fm_def hcomp_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_fst_fm arity_snd_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-name2arity__fm><span class=command>lemma</span></span> name2arity__fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>name2_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> name2_fm_def hcomp_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_fst_fm arity_snd_snd_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_cond_of_fm><span class=command>lemma</span></span> arity_cond_of_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>cond_of_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> cond_of_fm_def hcomp_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_snd_fm arity_snd_snd_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_singleton_fm><span class=command>lemma</span></span> arity_singleton_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>singleton_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> singleton_fm_def cons_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_union_fm arity_upair_fm arity_empty_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_Memrel_fm><span class=command>lemma</span></span> arity_Memrel_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>Memrel_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Memrel_fm_def 
  <span class=keyword1><span class=command>using</span></span>  arity_pair_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_quasinat_fm><span class=command>lemma</span></span> arity_quasinat_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>quasinat_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> quasinat_fm_def cons_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_succ_fm arity_empty_fm
    nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_is_recfun_fm><span class=command>lemma</span></span> arity_is_recfun_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span>formula <span class=main>;</span> <span class=free>v</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>n</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>Z</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>i</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span>  arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>=</span> <span class=free>i</span> <span class=main>⟹</span> 
  arity<span class=main>(</span>is_recfun_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>v</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>Z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>Z</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_recfun_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_upair_fm arity_pair_fm arity_pre_image_fm arity_restriction_fm
    nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_is_wfrec_fm><span class=command>lemma</span></span> arity_is_wfrec_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span>formula <span class=main>;</span> <span class=free>v</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>n</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>Z</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>i</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>=</span> <span class=free>i</span> <span class=main>⟹</span> 
    arity<span class=main>(</span>is_wfrec_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>v</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>Z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>Z</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_wfrec_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_succ_fm  arity_is_recfun_fm 
     nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_is_nat_case_fm><span class=command>lemma</span></span> arity_is_nat_case_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span>formula <span class=main>;</span> <span class=free>v</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>n</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>Z</span><span class=main>∈</span>nat<span class=main>;</span> <span class=free>i</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>=</span> <span class=free>i</span> <span class=main>⟹</span> 
    arity<span class=main>(</span>is_nat_case_fm<span class=main>(</span><span class=free>v</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>Z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>Z</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_nat_case_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_succ_fm arity_empty_fm arity_quasinat_fm 
    nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_iterates_MH_fm><span class=command>lemma</span></span> arity_iterates_MH_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>isF</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>g</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span>nat"</span></span> 
      <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>isF</span><span class=main>)</span> <span class=main>=</span> <span class=free>i</span>"</span></span>
    <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates_MH_fm<span class=main>(</span><span class=free>isF</span><span class=main>,</span><span class=free>v</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>g</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> 
           succ<span class=main>(</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>g</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>fun_apply_fm<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free>g</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=main>2</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>,</span> Forall<span class=main>(</span>Implies<span class=main>(</span>Equal<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>2</span><span class=main>)</span><span class=main>,</span> <span class=free>isF</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ar</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free>g</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span><span class=var>?ar</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?φ</span><span class=main>∈</span>formula"</span></span> 
    <span class=keyword1><span class=command>using</span></span> arity_fun_apply_fm
    nat_union_abs1 nat_union_abs2 pred_Un_distrib succ_Un_distrib Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> iterates_MH_fm_def
    <span class=keyword1><span class=command>using</span></span> arity_is_nat_case_fm<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> _ _ _ _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span><span class=main>]</span> assms pred_succ_eq pred_Un_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Arities-arity_is_iterates_fm><span class=command>lemma</span></span> arity_is_iterates_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>Z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span>nat"</span></span> 
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>=</span> <span class=free>i</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>is_iterates_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>v</span><span class=main>,</span><span class=free>n</span><span class=main>,</span><span class=free>Z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>Z</span><span class=main>)</span> <span class=main>∪</span> 
          pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"iterates_MH_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=main>7</span><span class=main>#+</span><span class=free>v</span><span class=main>,</span> <span class=main>2</span><span class=main>,</span> <span class=main>1</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"is_wfrec_fm<span class=main>(</span><span class=var>?φ</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> succ<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free>Z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>v</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>8</span><span class=main>#+</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?φ</span><span class=main>∈</span>formula"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms arity_iterates_MH_fm nat_union_abs2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free>Z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>3</span><span class=main>#+</span><span class=free>v</span><span class=main>)</span> <span class=main>∪</span> 
      pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms arity_is_wfrec_fm<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> _ _ _ _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span><span class=main>]</span> nat_union_abs1 pred_Un_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_iterates_fm_def 
    <span class=keyword1><span class=command>using</span></span> arity_Memrel_fm arity_succ_fm assms nat_union_abs1 pred_Un_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Arities-arity_eclose_n_fm><span class=command>lemma</span></span> arity_eclose_n_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t</span><span class=main>∈</span>nat"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>eclose_n_fm<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"big_union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?φ</span><span class=main>∈</span>formula"</span></span> 
    <span class=keyword1><span class=command>using</span></span> arity_big_union_fm nat_union_abs2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> eclose_n_fm_def
    <span class=keyword1><span class=command>using</span></span> arity_is_iterates_fm<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> _ _ _<span class=main>,</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=main>2</span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Arities-arity_mem_eclose_fm><span class=command>lemma</span></span> arity_mem_eclose_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>mem_eclose_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>  
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"eclose_n_fm<span class=main>(</span><span class=free>x</span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span> <span class=main>1</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span><span class=main>#+</span><span class=main>3</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> arity_eclose_n_fm nat_union_abs2 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mem_eclose_fm_def 
    <span class=keyword1><span class=command>using</span></span> arity_finite_ordinal_fm nat_union_abs2 pred_Un_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Arities-arity_is_eclose_fm><span class=command>lemma</span></span> arity_is_eclose_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>is_eclose_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_eclose_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_mem_eclose_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-eclose_n1arity__fm><span class=command>lemma</span></span> eclose_n1arity__fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>eclose_n1_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> eclose_n1_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_is_eclose_fm arity_singleton_fm name1arity__fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-eclose_n2arity__fm><span class=command>lemma</span></span> eclose_n2arity__fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>eclose_n2_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> eclose_n2_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_is_eclose_fm arity_singleton_fm name2arity__fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_ecloseN_fm><span class=command>lemma</span></span> arity_ecloseN_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>ecloseN_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>t</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ecloseN_fm_def 
  <span class=keyword1><span class=command>using</span></span> eclose_n1arity__fm eclose_n2arity__fm arity_union_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_frecR_fm><span class=command>lemma</span></span> arity_frecR_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>a</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>b</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>frecR_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>b</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_ftype_fm name1arity__fm name2arity__fm arity_domain_fm 
      number1arity__fm arity_empty_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Arities-arity_Collect_fm><span class=command>lemma</span></span> arity_Collect_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>formula"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>Collect_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span> <span class=main>∪</span> pred<span class=main>(</span>arity<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Collect_fm_def
  <span class=keyword1><span class=command>using</span></span> assms pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Forces_Definition><div class=head><h1>Theory Forces_Definition</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The definition of <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>forces</span></span>›</span></span></span></span>›</span></span>
<span class=keyword1><span class=command>theory</span></span> Forces_Definition <span class=keyword2><span class=keyword>imports</span></span> <a href=Arities.html>Arities</a> <a href=FrecR.html>FrecR</a> <a href=Synthetic_Definition.html>Synthetic_Definition</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹This is the core of our development.›</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The relation <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹frecrel›</span></span></span></span>›</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frecrelP</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frecrelP</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>xy</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>y</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free><span class=bound><span class=entity>xy</span></span></span><span class=main>)</span> <span class=main>∧</span> is_frecR<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frecrelP_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frecrelP_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>frecR_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-arity_frecrelP_fm><span class=command>lemma</span></span> arity_frecrelP_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat <span class=main>⟹</span> arity<span class=main>(</span>frecrelP_fm<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrelP_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_frecR_fm arity_pair_fm pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-frecrelP_fm_type><span class=command>lemma</span></span> frecrelP_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat <span class=main>⟹</span> frecrelP_fm<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrelP_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_frecrelP_fm><span class=command>lemma</span></span> sats_frecrelP_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>frecrelP_fm<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> frecrelP<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrelP_def frecrelP_fm_def
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>frecR_fm_iff_sats<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1 id=Forces_Definition-frecrelP_iff_sats><span class=command>lemma</span></span> frecrelP_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span> nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"frecrelP<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>)</span>  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> frecrelP_fm<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_frecrelP_fm<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_frecrel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_frecrel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>A2</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> cartprod<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=bound>A2</span><span class=main>)</span> <span class=main>∧</span> is_Collect<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>A2</span><span class=main>,</span> frecrelP<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>)</span> <span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frecrel_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frecrel_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>cartprod_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>#+</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>#+</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Collect_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>frecrelP_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>#+</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-frecrel_fm_type><span class=command>lemma</span></span> frecrel_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>a</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>b</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> frecrel_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrel_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-arity_frecrel_fm><span class=command>lemma</span></span> arity_frecrel_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>frecrel_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>b</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrel_fm_def
  <span class=keyword1><span class=command>using</span></span> assms arity_Collect_fm arity_cartprod_fm arity_frecrelP_fm pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-sats_frecrel_fm><span class=command>lemma</span></span> sats_frecrel_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>frecrel_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>r</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>
    <span class=main>⟷</span> is_frecrel<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>a</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_frecrel_def frecrel_fm_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_Collect_fm sats_frecrelP_fm<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-is_frecrel_iff_sats><span class=command>lemma</span></span> is_frecrel_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>rr</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span> nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span> nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_frecrel<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=free>aa</span><span class=main>,</span><span class=free>rr</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> frecrel_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>r</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_frecrel_fm<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>names_below</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>names_below</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>2</span><span class=main>×</span>ecloseN<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>×</span>ecloseN<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>×</span><span class=free><span class=bound><span class=entity>P</span></span></span>"</span></span>

<span class=keyword1 id=Forces_Definition-names_belowsD><span class=command>lemma</span></span> names_belowsD<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>obtains</span></span> <span class=free>f</span> <span class=free>n1</span> <span class=free>n2</span> <span class=free>p</span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_names_below</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_names_below</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>nb</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>p1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>p0</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>t</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>ec</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>
              is_ecloseN<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ec</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>∧</span> number2<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>∧</span> cartprod<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ec</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=bound>p0</span><span class=main>)</span> <span class=main>∧</span> cartprod<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ec</span><span class=main>,</span><span class=bound>p0</span><span class=main>,</span><span class=bound>p1</span><span class=main>)</span>
              <span class=main>∧</span> cartprod<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>t</span><span class=main>,</span><span class=bound>p1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>nb</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>number2_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>number2_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>number1_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> succ_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-number2_fm_type><span class=command>lemma</span></span> number2_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat <span class=main>⟹</span> number2_fm<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> number2_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-number2arity__fm><span class=command>lemma</span></span> number2arity__fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat <span class=main>⟹</span> arity<span class=main>(</span>number2_fm<span class=main>(</span><span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> number2_fm_def
  <span class=keyword1><span class=command>using</span></span> number1arity__fm arity_succ_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_number2_fm><span class=command>lemma</span></span> sats_number2_fm <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> number2_fm<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> number2<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> number2_fm_def number2_def<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_names_below_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_names_below_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>nb</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>
                    And<span class=main>(</span>ecloseN_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>number2_fm<span class=main>(</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
                    And<span class=main>(</span>cartprod_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>cartprod_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>cartprod_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=free><span class=bound><span class=entity>nb</span></span></span><span class=main>#+</span><span class=main>4</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-arity_is_names_below_fm><span class=command>lemma</span></span> arity_is_names_below_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>P</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>nb</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>is_names_below_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>nb</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>P</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>nb</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_names_below_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_cartprod_fm number2arity__fm arity_ecloseN_fm nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Forces_Definition-is_names_below_fm_type><span class=command>lemma</span></span> is_names_below_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>P</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>nb</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> is_names_below_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>nb</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_names_below_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_is_names_below_fm><span class=command>lemma</span></span> sats_is_names_below_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>nb</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_names_below_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>nb</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>
    <span class=main>⟷</span> is_names_below<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>nb</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_names_below_fm_def is_names_below_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_tuple</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_tuple</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>t1t2p</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>t2p</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>t2p</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=bound>t2p</span><span class=main>,</span><span class=bound>t1t2p</span><span class=main>)</span> <span class=main>∧</span>
                                                  pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span><span class=bound>t1t2p</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_tuple_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_tuple_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>tup</span></span></span><span class=main>)</span> <span class=main>=</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
                      And<span class=main>(</span>pair_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>pair_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>tup</span></span></span> <span class=main>#+</span> <span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Forces_Definition-arity_is_tuple_fm><span class=command>lemma</span></span> arity_is_tuple_fm <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>z</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t1</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>p</span><span class=main>∈</span>nat <span class=main>;</span> <span class=free>tup</span><span class=main>∈</span>nat <span class=main>⟧</span> <span class=main>⟹</span>
  arity<span class=main>(</span>is_tuple_fm<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>tup</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⋃</span> <span class=main>{</span>succ<span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>t1</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>tup</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_tuple_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm nat_union_abs1 nat_union_abs2 pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-is_tuple_fm_type><span class=command>lemma</span></span> is_tuple_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>t1</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>t2</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>tup</span><span class=main>∈</span>nat <span class=main>⟹</span> is_tuple_fm<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>tup</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_tuple_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_is_tuple_fm><span class=command>lemma</span></span> sats_is_tuple_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>tup</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_tuple_fm<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>tup</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>
    <span class=main>⟷</span> is_tuple<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>tup</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_tuple_def is_tuple_fm_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-is_tuple_iff_sats><span class=command>lemma</span></span> is_tuple_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>aa</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>b</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>bb</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>c</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>cc</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>d</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>dd</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>e</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ee</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>c</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>d</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>e</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_tuple<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=free>aa</span><span class=main>,</span><span class=free>bb</span><span class=main>,</span><span class=free>cc</span><span class=main>,</span><span class=free>dd</span><span class=main>,</span><span class=free>ee</span><span class=main>)</span>  <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> is_tuple_fm<span class=main>(</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sats_is_tuple_fm<span class=main>)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Definition of <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>forces</span></span>›</span></span></span></span> for equality and membership›</span></span>

<span class=comment1>(* p ||- τ = θ ≡
  ∀σ. σ∈domain(τ) ∪ domain(θ) ⟶ (∀q∈P. ⟨q,p⟩∈leq ⟶ ((q ||- σ∈τ) ⟷ (q ||- σ∈θ)) ) *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>eq_case</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>eq_case</span><span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>s</span><span class=main>.</span> <span class=bound>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>⟶</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>⟶</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span><span class=main>=</span><span class=main>1</span>  <span class=main>⟷</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span><span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_eq_case</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_eq_case</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span>
   <span class=main>∀</span><span class=bound>s</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>(</span><span class=main>∃</span><span class=bound>d</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> is_domain<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=bound>d</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>s</span><span class=main>∈</span><span class=bound>d</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>d</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> is_domain<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=bound>d</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>s</span><span class=main>∈</span><span class=bound>d</span><span class=main>)</span>
       <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>qp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>qp</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>qp</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>)</span> <span class=main>⟶</span>
            <span class=main>(</span><span class=main>∃</span><span class=bound>ost1q</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>ost2q</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>o</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>  <span class=main>∃</span><span class=bound>vf1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>vf2</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>
             is_tuple<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>ost1q</span><span class=main>)</span> <span class=main>∧</span>
             is_tuple<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>ost2q</span><span class=main>)</span> <span class=main>∧</span> number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>)</span> <span class=main>∧</span>
             fun_apply<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=bound>ost1q</span><span class=main>,</span><span class=bound>vf1</span><span class=main>)</span> <span class=main>∧</span> fun_apply<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=bound>ost2q</span><span class=main>,</span><span class=bound>vf2</span><span class=main>)</span> <span class=main>∧</span>
             <span class=main>(</span><span class=bound>vf1</span> <span class=main>=</span> <span class=bound>o</span> <span class=main>⟷</span> <span class=bound>vf2</span> <span class=main>=</span> <span class=bound>o</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=comment1>(* p ||-
   π ∈ τ ≡ ∀v∈P. ⟨v,p⟩∈leq ⟶ (∃q∈P. ⟨q,v⟩∈leq ∧ (∃σ. ∃r∈P. ⟨σ,r⟩∈τ ∧ ⟨q,r⟩∈leq ∧  q ||- π = σ)) *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>mem_case</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>mem_case</span><span class=main>(</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>v</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>.</span> <span class=main>⟨</span><span class=bound>v</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>⟶</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span><span class=bound>v</span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>∧</span>  <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>1</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_mem_case</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_mem_case</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>v</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∀</span><span class=bound>vp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=bound>v</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>v</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>vp</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>vp</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>⟶</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>s</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>r</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>qv</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>sr</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>qr</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>zt1sq</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>o</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>
     <span class=bound>r</span><span class=main>∈</span> <span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>v</span><span class=main>,</span><span class=bound>qv</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=bound>sr</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=bound>qr</span><span class=main>)</span> <span class=main>∧</span>
     empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>∧</span> is_tuple<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>zt1sq</span><span class=main>)</span> <span class=main>∧</span>
     number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>qv</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>∧</span> <span class=bound>sr</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>t2</span></span></span> <span class=main>∧</span> <span class=bound>qr</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>∧</span> fun_apply<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=bound>zt1sq</span><span class=main>,</span><span class=bound>o</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>schematic_goal</span></span> sats_is_mem_case_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_mem_case<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>n1</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>n2</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?imc_fm</span><span class=main>(</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_mem_case_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules'  is_tuple_iff_sats <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>


<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"mem_case_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> sats_is_mem_case_fm_auto

<span class=keyword1 id=Forces_Definition-arity_mem_case_fm><span class=command>lemma</span></span> arity_mem_case_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>mem_case_fm<span class=main>(</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
    succ<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>P</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>leq</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> mem_case_fm_def
  <span class=keyword1><span class=command>using</span></span> assms arity_pair_fm arity_is_tuple_fm number1arity__fm arity_fun_apply_fm arity_empty_fm
    pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>schematic_goal</span></span> sats_is_eq_case_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_eq_case<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>n1</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>n2</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=var>?iec_fm</span><span class=main>(</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_eq_case_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules'  is_tuple_iff_sats <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"eq_case_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> sats_is_eq_case_fm_auto

<span class=keyword1 id=Forces_Definition-arity_eq_case_fm><span class=command>lemma</span></span> arity_eq_case_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>eq_case_fm<span class=main>(</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
    succ<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>P</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>leq</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> eq_case_fm_def
  <span class=keyword1><span class=command>using</span></span> assms arity_pair_fm arity_is_tuple_fm number1arity__fm arity_fun_apply_fm arity_empty_fm
    arity_domain_fm pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Hfrc</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Hfrc</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>ft</span><span class=main>.</span> <span class=main>∃</span><span class=bound>n1</span><span class=main>.</span> <span class=main>∃</span><span class=bound>n2</span><span class=main>.</span> <span class=main>∃</span><span class=bound>c</span><span class=main>.</span> <span class=bound>c</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>fnnc</span></span></span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>ft</span><span class=main>,</span><span class=bound>n1</span><span class=main>,</span><span class=bound>n2</span><span class=main>,</span><span class=bound>c</span><span class=main>⟩</span> <span class=main>∧</span>
     <span class=main>(</span>  <span class=bound>ft</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span>  eq_case<span class=main>(</span><span class=bound>n1</span><span class=main>,</span><span class=bound>n2</span><span class=main>,</span><span class=bound>c</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span>
      <span class=main>∨</span> <span class=bound>ft</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> mem_case<span class=main>(</span><span class=bound>n1</span><span class=main>,</span><span class=bound>n2</span><span class=main>,</span><span class=bound>c</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Hfrc</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Hfrc</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span>
     <span class=main>∃</span><span class=bound>ft</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>n1</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>n2</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>co</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span>
      <span class=bound>co</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> is_tuple<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ft</span><span class=main>,</span><span class=bound>n1</span><span class=main>,</span><span class=bound>n2</span><span class=main>,</span><span class=bound>co</span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span>  <span class=main>(</span>empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ft</span><span class=main>)</span> <span class=main>∧</span> is_eq_case<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>n1</span><span class=main>,</span><span class=bound>n2</span><span class=main>,</span><span class=bound>co</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span>
       <span class=main>∨</span> <span class=main>(</span>number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>ft</span><span class=main>)</span> <span class=main>∧</span>  is_mem_case<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>n1</span><span class=main>,</span><span class=bound>n2</span><span class=main>,</span><span class=bound>co</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Hfrc_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Hfrc_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=main>≡</span>
    Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>
      And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>is_tuple_fm<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>)</span><span class=main>,</span>
      Or<span class=main>(</span>And<span class=main>(</span>empty_fm<span class=main>(</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>eq_case_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
         And<span class=main>(</span>number1_fm<span class=main>(</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>mem_case_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>#+</span> <span class=main>4</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-Hfrc_fm_type><span class=command>lemma</span></span> Hfrc_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>P</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>leq</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>fnnc</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>f</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> Hfrc_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hfrc_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-arity_Hfrc_fm><span class=command>lemma</span></span> arity_Hfrc_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>Hfrc_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>P</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>leq</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>fnnc</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hfrc_fm_def
  <span class=keyword1><span class=command>using</span></span> assms arity_is_tuple_fm arity_mem_case_fm arity_eq_case_fm
    arity_empty_fm number1arity__fm pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-sats_Hfrc_fm><span class=command>lemma</span></span> sats_Hfrc_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>Hfrc_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>
    <span class=main>⟷</span> is_Hfrc<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>fnnc</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Hfrc_def Hfrc_fm_def
  <span class=keyword1><span class=command>using</span></span> assms  
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sats_is_tuple_fm eq_case_fm_iff_sats<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> mem_case_fm_iff_sats<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1 id=Forces_Definition-Hfrc_iff_sats><span class=command>lemma</span></span> Hfrc_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>PP</span>"</span></span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>lleq</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>fnnc</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ffnnc</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ff</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_Hfrc<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=free>PP</span><span class=main>,</span> <span class=free>lleq</span><span class=main>,</span><span class=free>ffnnc</span><span class=main>,</span><span class=free>ff</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>Hfrc_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_Hfrc_fm<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_Hfrc_at</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_Hfrc_at</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span>
            <span class=main>(</span>empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span> is_Hfrc<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span>
          <span class=main>∨</span> <span class=main>(</span>number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>∧</span> is_Hfrc<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>Hfrc_at_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Hfrc_at_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Or<span class=main>(</span>And<span class=main>(</span>empty_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>,</span>Neg<span class=main>(</span>Hfrc_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                                      And<span class=main>(</span>number1_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>,</span>Hfrc_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-arity_Hfrc_at_fm><span class=command>lemma</span></span> arity_Hfrc_at_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>Hfrc_at_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>P</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>leq</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>fnnc</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hfrc_at_fm_def
  <span class=keyword1><span class=command>using</span></span> assms arity_Hfrc_fm arity_empty_fm number1arity__fm pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Forces_Definition-Hfrc_at_fm_type><span class=command>lemma</span></span> Hfrc_at_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>P</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>leq</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>fnnc</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>f</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>z</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> Hfrc_at_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hfrc_at_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_Hfrc_at_fm><span class=command>lemma</span></span> sats_Hfrc_at_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>Hfrc_at_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>
    <span class=main>⟷</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>fnnc</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Hfrc_at_def Hfrc_at_fm_def <span class=keyword1><span class=command>using</span></span> assms sats_Hfrc_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-is_Hfrc_at_iff_sats><span class=command>lemma</span></span> is_Hfrc_at_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>leq</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>PP</span>"</span></span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>lleq</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>fnnc</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ffnnc</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>ff</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>zz</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=free>PP</span><span class=main>,</span> <span class=free>lleq</span><span class=main>,</span><span class=free>ffnnc</span><span class=main>,</span><span class=free>ff</span><span class=main>,</span><span class=free>zz</span><span class=main>)</span>
    <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>Hfrc_at_fm<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sats_Hfrc_at_fm<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-arity_tran_closure_fm><span class=command>lemma</span></span> arity_tran_closure_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>f</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>trans_closure_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> trans_closure_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_omega_fm arity_field_fm arity_typed_function_fm arity_pair_fm arity_empty_fm arity_fun_apply_fm
    arity_composition_fm arity_succ_fm nat_union_abs2 pred_Un_distrib 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The well-founded relation <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>forcerel</span></span>›</span></span></span></span>›</span></span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forcerel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forcerel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>≡</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forcerel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forcerel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>r</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>nb</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> tran_closure<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>∧</span>
                        <span class=main>(</span>is_names_below<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>nb</span><span class=main>)</span> <span class=main>∧</span> is_frecrel<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>nb</span><span class=main>,</span><span class=bound>r</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forcerel_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span> i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forcerel_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>trans_closure_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
                                        And<span class=main>(</span>is_names_below_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>frecrel_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-arity_forcerel_fm><span class=command>lemma</span></span> arity_forcerel_fm<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>z</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>forcerel_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_frecrel_fm arity_tran_closure_fm arity_is_names_below_fm pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-forcerel_fm_type><span class=command>lemma</span></span> forcerel_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>z</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> forcerel_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Forces_Definition-sats_forcerel_fm><span class=command>lemma</span></span> sats_forcerel_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>forcerel_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_forcerel<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>trans_closure_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free>z</span> <span class=main>#+</span> <span class=main>2</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>nb</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>r</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
        tran_closure<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=skolem>r</span><span class=main>,</span> nth<span class=main>(</span><span class=free>z</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nb</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>r</span> <span class=skolem>nb</span>
    <span class=keyword1><span class=command>using</span></span> that assms trans_closure_fm_iff_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>nb</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>#+</span><span class=main>2</span>"</span></span><span class=main>,</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> is_names_below_fm<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>nb</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
        is_names_below<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>x</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> <span class=skolem>nb</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nb</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>nb</span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> assms that sats_is_names_below_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>#+</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>#+</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>nb</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> frecrel_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>1</span><span class=main>)</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>nb</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
        is_frecrel<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=skolem>nb</span><span class=main>,</span> <span class=skolem>r</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nb</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>r</span> <span class=skolem>nb</span>
    <span class=keyword1><span class=command>using</span></span> assms that sats_frecrel_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>nb</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> is_forcerel_def forcerel_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹<span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>frc_at</span></span>›</span></span></span></span>, forcing for atomic formulas›</span></span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frc_at</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frc_at</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>)</span> <span class=main>≡</span> wfrec<span class=main>(</span>frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>fnnc</span></span></span><span class=main>,</span>
                              <span class=main>λ</span><span class=bound>x</span> <span class=bound>f</span><span class=main>.</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_frc_at</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_frc_at</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>r</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> is_forcerel<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>r</span><span class=main>)</span> <span class=main>∧</span>
                                    is_wfrec<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_Hfrc_at<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>)</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>frc_at_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>frc_at_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>forcerel_fm<span class=main>(</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
          is_wfrec_fm<span class=main>(</span>Hfrc_at_fm<span class=main>(</span><span class=main>6</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=main>6</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-frc_at_fm_type><span class=command>lemma</span></span> frc_at_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>l</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>z</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> frc_at_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frc_at_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-arity_frc_at_fm><span class=command>lemma</span></span> arity_frc_at_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>frc_at_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>l</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Hfrc_at_fm<span class=main>(</span><span class=main>6</span> <span class=main>#+</span> <span class=free>p</span><span class=main>,</span> <span class=main>6</span> <span class=main>#+</span> <span class=free>l</span><span class=main>,</span> <span class=main>2</span><span class=main>,</span> <span class=main>1</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>l</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?φ</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword1><span class=command>using</span></span> arity_Hfrc_at_fm nat_simp_union
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> W<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>is_wfrec_fm<span class=main>(</span><span class=var>?φ</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span><span class=main>#+</span><span class=free>p</span> <span class=main>∪</span> <span class=main>(</span><span class=main>2</span><span class=main>#+</span><span class=free>l</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>2</span><span class=main>#+</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>2</span><span class=main>#+</span><span class=free>z</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arity_is_wfrec_fm<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> _ _ _ _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span><span class=main>]</span> pred_Un_distrib pred_succ_eq
      nat_union_abs1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forcerel_fm<span class=main>(</span>succ<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>,</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span>succ<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arity_forcerel_fm nat_simp_union
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> W assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> frc_at_fm_def
    <span class=keyword1><span class=command>using</span></span> arity_forcerel_fm pred_Un_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-sats_frc_at_fm><span class=command>lemma</span></span> sats_frc_at_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>frc_at_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
     is_frc_at<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>r</span> <span class=skolem>pp</span> <span class=skolem>ll</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> 0<span class=main>:</span><span class=quoted><span class=quoted>"is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span> <span class=skolem>a1</span><span class=main>,</span> <span class=skolem>a0</span><span class=main>)</span> <span class=main>⟷</span>
         sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> Hfrc_at_fm<span class=main>(</span><span class=main>6</span><span class=main>#+</span><span class=free>p</span><span class=main>,</span><span class=main>6</span><span class=main>#+</span><span class=free>l</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a0</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a1</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a2</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a3</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a4</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a0</span> <span class=skolem>a1</span> <span class=skolem>a2</span> <span class=skolem>a3</span> <span class=skolem>a4</span>
      <span class=keyword1><span class=command>using</span></span>  that assms <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>›</span></span>
        is_Hfrc_at_iff_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>6</span><span class=main>#+</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>6</span><span class=main>#+</span><span class=free>l</span>"</span></span> <span class=quoted><span class=main>2</span></span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>a0</span><span class=main>,</span><span class=skolem>a1</span><span class=main>,</span><span class=skolem>a2</span><span class=main>,</span><span class=skolem>a3</span><span class=main>,</span><span class=skolem>a4</span><span class=main>,</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span> <span class=quoted><span class=free>A</span></span><span class=main>]</span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>is_wfrec_fm<span class=main>(</span>Hfrc_at_fm<span class=main>(</span><span class=main>6</span> <span class=main>#+</span> <span class=free>p</span><span class=main>,</span> <span class=main>6</span> <span class=main>#+</span> <span class=free>l</span><span class=main>,</span> <span class=main>2</span><span class=main>,</span> <span class=main>1</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> succ<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>j</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>r</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
         is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=skolem>r</span><span class=main>,</span>nth<span class=main>(</span><span class=free>i</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>,</span> nth<span class=main>(</span><span class=free>j</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>›</span></span>
        sats_is_wfrec_fm<span class=main>[</span><span class=operator>OF</span> 0<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> forcerel_fm<span class=main>(</span>succ<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>,</span> succ<span class=main>(</span><span class=free>i</span><span class=main>)</span><span class=main>,</span> <span class=main>0</span><span class=main>)</span><span class=main>,</span> Cons<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
        is_forcerel<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=skolem>r</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> assms sats_forcerel_fm that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> is_frc_at_def frc_at_fm_def
    <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_eq'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_eq'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> frc_at<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_mem'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_mem'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> frc_at<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_neq'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_neq'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>.</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>∧</span> forces_eq'<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_nmem'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_nmem'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>.</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>⟩</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>∧</span> forces_mem'<span class=main>(</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forces_eq'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forces_eq'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>o</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>t</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>)</span> <span class=main>∧</span> empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>∧</span>
                                is_tuple<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>∧</span> is_frc_at<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=bound>t</span><span class=main>,</span><span class=bound>o</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forces_mem'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forces_mem'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>o</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>t</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> number1<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>)</span> <span class=main>∧</span>
                                is_tuple<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>o</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>∧</span> is_frc_at<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=bound>t</span><span class=main>,</span><span class=bound>o</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forces_neq'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forces_neq'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span>
      <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>qp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>qp</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>qp</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>∧</span> is_forces_eq'<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forces_nmem'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forces_nmem'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span>
      <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>qp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=bound>q</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P</span></span></span> <span class=main>∧</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>qp</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>qp</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>∧</span> is_forces_mem'<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>P</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_eq_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_eq_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span>
     Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>number1_fm<span class=main>(</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>empty_fm<span class=main>(</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
              And<span class=main>(</span>is_tuple_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>frc_at_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#+</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span> <span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_mem_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_mem_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>number1_fm<span class=main>(</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
                          And<span class=main>(</span>is_tuple_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>frc_at_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_neq_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_neq_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> Neg<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
     And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>forces_eq_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_nmem_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_nmem_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> Neg<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
     And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>forces_mem_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Forces_Definition-forces_eq_fm_type><span class=command>lemma</span></span> forces_eq_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>l</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t1</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t2</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> forces_eq_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_eq_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forces_mem_fm_type><span class=command>lemma</span></span> forces_mem_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>l</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t1</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t2</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> forces_mem_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_mem_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forces_neq_fm_type><span class=command>lemma</span></span> forces_neq_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>l</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t1</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t2</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> forces_neq_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_neq_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forces_nmem_fm_type><span class=command>lemma</span></span> forces_nmem_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>l</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t1</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>t2</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> forces_nmem_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-arity_forces_eq_fm><span class=command>lemma</span></span> arity_forces_eq_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>l</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>t1</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>t2</span> <span class=main>∈</span> nat <span class=main>⟹</span>
   arity<span class=main>(</span>forces_eq_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t2</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_eq_fm_def
  <span class=keyword1><span class=command>using</span></span> number1arity__fm arity_empty_fm arity_is_tuple_fm arity_frc_at_fm
    pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-arity_forces_mem_fm><span class=command>lemma</span></span> arity_forces_mem_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>l</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>t1</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>t2</span> <span class=main>∈</span> nat <span class=main>⟹</span>
   arity<span class=main>(</span>forces_mem_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>t2</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_mem_fm_def
  <span class=keyword1><span class=command>using</span></span> number1arity__fm arity_empty_fm arity_is_tuple_fm arity_frc_at_fm
    pred_Un_distrib
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id="Forces_Definition-sats_forces_eq'_fm"><span class=command>lemma</span></span> sats_forces_eq'_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces_eq_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
         is_forces_eq'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_eq_fm_def is_forces_eq'_def <span class=keyword1><span class=command>using</span></span> assms sats_is_tuple_fm  sats_frc_at_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id="Forces_Definition-sats_forces_mem'_fm"><span class=command>lemma</span></span> sats_forces_mem'_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces_mem_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
             is_forces_mem'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_mem_fm_def is_forces_mem'_def <span class=keyword1><span class=command>using</span></span> assms sats_is_tuple_fm sats_frc_at_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id="Forces_Definition-sats_forces_neq'_fm"><span class=command>lemma</span></span> sats_forces_neq'_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces_neq_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
             is_forces_neq'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_neq_fm_def is_forces_neq'_def
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_eq'_fm sats_is_tuple_fm sats_frc_at_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id="Forces_Definition-sats_forces_nmem'_fm"><span class=command>lemma</span></span> sats_forces_nmem'_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces_nmem_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
             is_forces_nmem'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_fm_def is_forces_nmem'_def
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_mem'_fm sats_is_tuple_fm sats_frc_at_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>

<span class=comment1>(* Absoluteness of components *)</span>
<span class=keyword1 id=Forces_Definition-fst_abs><span class=command>lemma</span></span> fst_abs <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_fst<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> fst<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fst_def is_fst_def <span class=keyword1><span class=command>using</span></span> pair_in_M_iff zero_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>;</span></span><span class=operator>rule_tac</span> the_0 the_0<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forces_Definition-snd_abs><span class=command>lemma</span></span> snd_abs <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_snd<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> snd<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snd_def is_snd_def <span class=keyword1><span class=command>using</span></span> pair_in_M_iff zero_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>;</span></span><span class=operator>rule_tac</span> the_0 the_0<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forces_Definition-ftype_abs><span class=command>lemma</span></span> ftype_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_ftype<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> ftype_def  is_ftype_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-name1_abs><span class=command>lemma</span></span> name1_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_name1<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> name1<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> name1_def is_name1_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> hcomp_abs<span class=main><span class=main>[</span></span><span class=operator>OF</span> fst_abs<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fst_snd_closed<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-snd_snd_abs><span class=command>lemma</span></span> snd_snd_abs<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_snd_snd<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> snd<span class=main>(</span>snd<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_snd_snd_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> hcomp_abs<span class=main><span class=main>[</span></span><span class=operator>OF</span> snd_abs<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fst_snd_closed<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-name2_abs><span class=command>lemma</span></span> name2_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_name2<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> name2_def is_name2_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> hcomp_abs<span class=main><span class=main>[</span></span><span class=operator>OF</span> fst_abs snd_snd_abs<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fst_snd_closed<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-cond_of_abs><span class=command>lemma</span></span> cond_of_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_cond_of<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> cond_of<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> cond_of_def is_cond_of_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> hcomp_abs<span class=main><span class=main>[</span></span><span class=operator>OF</span> snd_abs snd_snd_abs<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fst_snd_closed<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-tuple_abs><span class=command>lemma</span></span> tuple_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>z</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>t1</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>t2</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>p</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>t</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span>
   is_tuple<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>t</span> <span class=main>=</span> <span class=main>⟨</span><span class=free>z</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_tuple_def <span class=keyword1><span class=command>using</span></span> tuples_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-oneN_in_M><span class=command>lemma</span></span> oneN_in_M<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>1</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-twoN_in_M><span class=command>lemma</span></span> twoN_in_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>2</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-comp_in_M><span class=command>lemma</span></span> comp_in_M<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>≼</span> <span class=free>q</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>≼</span> <span class=free>q</span> <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> leq_in_M transitivity<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>leq</span></span><span class=main>]</span> pair_in_M_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>(* Absoluteness of Hfrc *)</span>

<span class=keyword1 id=Forces_Definition-eq_case_abs><span class=command>lemma</span></span> eq_case_abs <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_eq_case<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span> <span class=main>⟷</span> eq_case<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟹</span> <span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> comp_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>t</span> <span class=main>⟹</span> <span class=skolem>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>t</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>s</span> <span class=skolem>y</span> <span class=skolem>t</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>unfolding</span></span> domain_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>s</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟶</span>
                              <span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span><span class=main>1</span> <span class=main>⟷</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span><span class=main>=</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
    <span class=main>(</span><span class=main>∀</span><span class=bound>s</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>s</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟶</span>
                                  <span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span><span class=main>1</span> <span class=main>⟷</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span><span class=main>=</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms domain_trans<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>,</span><span class=operator>of</span> <span class=quoted><span class=free>t1</span></span><span class=main>]</span>
      domain_trans<span class=main>[</span><span class=operator>OF</span> trans_M<span class=main>,</span><span class=operator>of</span> <span class=quoted><span class=free>t2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> eq_case_def is_eq_case_def
    <span class=keyword1><span class=command>using</span></span> assms pair_in_M_iff n_in_M<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>1</span></span><span class=main>]</span> domain_closed tuples_in_M
      apply_closed leq_in_M
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-mem_case_abs><span class=command>lemma</span></span> mem_case_abs <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_mem_case<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span> <span class=main>⟷</span> mem_case<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>≼</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"is_mem_case<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> this
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>v</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=skolem>v</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>,</span><span class=operator>of</span> <span class=quoted><span class=skolem>v</span></span><span class=main>]</span> transitivity<span class=main>[</span><span class=operator>OF</span> _ leq_in_M<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> calculation assms
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>v</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>s</span><span class=main>,</span> <span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=main>0</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span>
       <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=skolem>s</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>s</span><span class=main>,</span> <span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>r</span> <span class=main>∧</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=skolem>s</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> is_mem_case_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span> <span class=bound>s</span> <span class=bound>r</span><span class=main>.</span> <span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=skolem>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span> <span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=bound>r</span> <span class=main>∧</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"mem_case<span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>f</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"is_mem_case<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> mem_case_def <span class=keyword1><span class=command>using</span></span> that assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>v</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>≼</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"mem_case<span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> this
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>s</span><span class=main>,</span> <span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>r</span> <span class=main>∧</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=skolem>s</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> mem_case_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> this <span class=quoted><span class=quoted>‹<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>s</span><span class=main>,</span> <span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>r</span> <span class=main>∧</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=skolem>s</span><span class=main>,</span> <span class=skolem>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> transitivity P_in_M domain_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>t2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>
         <span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span> <span class=skolem>v</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span> <span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>q</span><span class=main>,</span> <span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=main>0</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span>
         <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=skolem>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span> <span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=bound>r</span> <span class=main>∧</span> <span class=free>f</span> <span class=main>`</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=bound>s</span><span class=main>,</span> <span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> tuples_in_M zero_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"is_mem_case<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>f</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"mem_case<span class=main>(</span><span class=free>t1</span><span class=main>,</span> <span class=free>t2</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_mem_case_def <span class=keyword1><span class=command>using</span></span> assms that <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Forces_Definition-Hfrc_abs><span class=command>lemma</span></span> Hfrc_abs<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>fnnc</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>f</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span>
   is_Hfrc<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span> <span class=main>⟷</span> Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Hfrc_def Hfrc_def <span class=keyword1><span class=command>using</span></span> pair_in_M_iff
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-Hfrc_at_abs><span class=command>lemma</span></span> Hfrc_at_abs<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>fnnc</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>f</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>z</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span>
   is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span>  <span class=free>z</span> <span class=main>=</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>f</span><span class=main>)</span><span class=main>)</span> "</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_Hfrc_at_def <span class=keyword1><span class=command>using</span></span> Hfrc_abs
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-components_closed><span class=command>lemma</span></span> components_closed <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> ftype<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> name1<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> name2<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> cond_of<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ftype_def name1_def name2_def cond_of_def <span class=keyword1><span class=command>using</span></span> fst_snd_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1 id=Forces_Definition-ecloseN_closed><span class=command>lemma</span></span> ecloseN_closed<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span>ecloseN<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span>eclose_n<span class=main>(</span>name1<span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span>eclose_n<span class=main>(</span>name2<span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ecloseN_def eclose_n_def
  <span class=keyword1><span class=command>using</span></span> components_closed eclose_closed singletonM Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-is_eclose_n_abs><span class=command>lemma</span></span> is_eclose_n_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>ec</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_eclose_n<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_name1<span class=main>,</span><span class=free>ec</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>ec</span> <span class=main>=</span> eclose_n<span class=main>(</span>name1<span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"is_eclose_n<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_name2<span class=main>,</span><span class=free>ec</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>ec</span> <span class=main>=</span> eclose_n<span class=main>(</span>name2<span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_eclose_n_def eclose_n_def
  <span class=keyword1><span class=command>using</span></span> assms name1_abs name2_abs eclose_abs singletonM components_closed
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Forces_Definition-is_ecloseN_abs><span class=command>lemma</span></span> is_ecloseN_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>ec</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_ecloseN<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>ec</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>ec</span> <span class=main>=</span> ecloseN<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_ecloseN_def ecloseN_def
  <span class=keyword1><span class=command>using</span></span> is_eclose_n_abs Un_closed union_abs ecloseN_closed
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-frecR_abs><span class=command>lemma</span></span> frecR_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> is_frecR<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecR_def is_frecR_def <span class=keyword1><span class=command>using</span></span> components_closed domain_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-frecrelP_abs><span class=command>lemma</span></span> frecrelP_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> frecrelP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> pair_in_M_iff frecR_abs <span class=keyword1><span class=command>unfolding</span></span> frecrelP_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-frecrel_abs><span class=command>lemma</span></span> frecrel_abs<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_frecrel<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟷</span>  <span class=free>r</span> <span class=main>=</span> frecrel<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> cartprod_closed transitivity that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>,</span>frecrelP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Collect<span class=main>(</span><span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"frecrelP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=main>]</span> assms frecrelP_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> is_frecrel_def def_frecrel <span class=keyword1><span class=command>using</span></span> cartprod_closed
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-frecrel_closed><span class=command>lemma</span></span> frecrel_closed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"frecrel<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>x</span><span class=main>×</span><span class=free>x</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_in_M_0p<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"frecrelP_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span>"</span></span><span class=main>]</span> arity_frecrelP_fm sats_frecrelP_fm
      frecrelP_abs <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>M</span>›</span></span> cartprod_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def frecrelP_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-field_frecrel><span class=command>lemma</span></span> field_frecrel <span class=main>:</span> <span class=quoted><span class=quoted>"field<span class=main>(</span>frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrel_def
  <span class=keyword1><span class=command>using</span></span> field_Rrel <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forcerelD><span class=command>lemma</span></span> forcerelD <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>uv</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>uv</span><span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>×</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def
  <span class=keyword1><span class=command>using</span></span> trancl_type field_frecrel <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Forces_Definition-wf_forcerel><span class=command>lemma</span></span> wf_forcerel <span class=main>:</span>
  <span class=quoted><span class=quoted>"wf<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def <span class=keyword1><span class=command>using</span></span> wf_trancl wf_frecrel <span class=keyword1><span class=command>.</span></span>

<span class=keyword1 id=Forces_Definition-restrict_trancl_forcerel><span class=command>lemma</span></span> restrict_trancl_forcerel<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>w</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span>
       <span class=main>=</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>`</span><span class=free>w</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def frecrel_def <span class=keyword1><span class=command>using</span></span> assms restrict_trancl_Rrel<span class=main>[</span><span class=operator>of</span> <span class=quoted>frecR</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-names_belowI><span class=command>lemma</span></span> names_belowI <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=main>⟨</span><span class=free>ft</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>ft</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>ft</span> <span class=main>∈</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=main>2</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>e<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>b</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>c</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>n2</span> <span class=main>=</span> <span class=free>b</span> <span class=main>∨</span> <span class=free>n2</span> <span class=main>=</span><span class=free>c</span><span class=main>)</span>"</span></span>
    <span class=main>|</span> <span class=main>(</span>m<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>=</span> <span class=free>b</span> <span class=main>∧</span> <span class=free>n2</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>c</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> frecR_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> e
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>b</span><span class=main>)</span> <span class=main>∨</span> <span class=free>n1</span> <span class=main>∈</span> eclose<span class=main>(</span><span class=free>c</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Un_iff in_dom_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> e
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=var>?y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=var>?y</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> ecloseNI components_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>ft</span><span class=main>∈</span><span class=main>2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span>  <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> m
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=var>?y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n2</span> <span class=main>∈</span> ecloseN<span class=main>(</span><span class=var>?y</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mem_eclose_trans  ecloseNI
        in_dom_in_eclose components_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>ft</span><span class=main>∈</span><span class=main>2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> names_below_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-names_below_tr><span class=command>lemma</span></span> names_below_tr <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span> <span class=main>.</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>fx</span></span> <span class=skolem><span class=skolem>x1</span></span> <span class=skolem><span class=skolem>x2</span></span> <span class=skolem><span class=skolem>px</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>fx</span><span class=main>,</span><span class=skolem>x1</span><span class=main>,</span><span class=skolem>x2</span><span class=main>,</span><span class=skolem>px</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>fx</span><span class=main>∈</span><span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>px</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>fy</span></span> <span class=skolem><span class=skolem>y1</span></span> <span class=skolem><span class=skolem>y2</span></span> <span class=skolem><span class=skolem>py</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>fy</span><span class=main>,</span><span class=skolem>y1</span><span class=main>,</span><span class=skolem>y2</span><span class=main>,</span><span class=skolem>py</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>fy</span><span class=main>∈</span><span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>py</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x1</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x2</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y1</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y2</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>=</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>y</span><span class=main>=</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> ecloseN_mono names_simp <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>fx</span><span class=main>∈</span><span class=main>2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>px</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>=</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> subsetI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-arg_into_names_below2><span class=command>lemma</span></span> arg_into_names_below2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>from</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=skolem><span class=skolem>n1</span></span> <span class=skolem><span class=skolem>n2</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>n1</span><span class=main>,</span><span class=skolem>n2</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>fy</span></span> <span class=skolem><span class=skolem>m1</span></span> <span class=skolem><span class=skolem>m2</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>fy</span><span class=main>,</span><span class=skolem>m1</span><span class=main>,</span><span class=skolem>m2</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>y</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹frecR<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> names_belowI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-arg_into_names_below><span class=command>lemma</span></span> arg_into_names_below <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>from</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> frecrel_def Rrel_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=skolem><span class=skolem>n1</span></span> <span class=skolem><span class=skolem>n2</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>n1</span><span class=main>,</span><span class=skolem>n2</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>∈</span><span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n1</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n2</span><span class=main>∈</span>ecloseN<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> components_in_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>∈</span><span class=main>2</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span> <span class=main>=</span> <span class=main>⟨</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>n1</span><span class=main>,</span><span class=skolem>n2</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-forcerel_arg_into_names_below><span class=command>lemma</span></span> forcerel_arg_into_names_below <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> trancl_induct<span class=main><span class=keyword3>;</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> arg_into_names_below<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-names_below_mono><span class=command>lemma</span></span> names_below_mono <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arg_into_names_below2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> names_below_tr subsetI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-frecrel_mono><span class=command>lemma</span></span> frecrel_mono <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frecrel_def
  <span class=keyword1><span class=command>using</span></span> Rrel_mono names_below_mono assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forcerel_mono2><span class=command>lemma</span></span> forcerel_mono2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def
  <span class=keyword1><span class=command>using</span></span> trancl_mono frecrel_mono assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forcerel_mono_aux><span class=command>lemma</span></span> forcerel_mono_aux <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>w</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> trancl_induct<span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> subset_trans forcerel_mono2<span class=main>)</span>

<span class=keyword1 id=Forces_Definition-forcerel_mono><span class=command>lemma</span></span> forcerel_mono <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>⊆</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> forcerel_mono_aux assms <span class=keyword1><span class=command>unfolding</span></span> forcerel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-aux><span class=command>lemma</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>w</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟹</span>
  <span class=main>(</span><span class=free>y</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>w</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>w</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>rule_tac</span> a<span class=main><span class=main>=</span></span><span class=quoted><span class=free>x</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> b<span class=main><span class=main>=</span></span><span class=quoted><span class=free>y</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>y</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>w</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>w</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> trancl_induct<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>a</span> <span class=main>.</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=bound>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>a</span> <span class=main>.</span> frecrel<span class=main>(</span><span class=var>?A</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?fR</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>a</span> <span class=main>.</span>forcerel<span class=main>(</span><span class=bound>a</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span><span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=skolem>u</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=skolem>u</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>  <span class=keyword2><span class=keyword>for</span></span>  <span class=skolem>u</span>
    <span class=keyword1><span class=command>using</span></span> that frecrelD frecrelI r_into_trancl <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>u</span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>^+</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>u</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>^+</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span> <span class=skolem>v</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>u</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span><span class=skolem>v</span><span class=main>⟩</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span><span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=skolem>v</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> arg_into_names_below2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span> <span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span><span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> names_below_tr <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span><span class=skolem>v</span><span class=main>⟩</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span><span class=skolem>v</span><span class=main>⟩</span><span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> frecrelD frecrelI r_into_trancl <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>u</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>u</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>u</span><span class=main>∈</span><span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>u</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span><span class=skolem>v</span><span class=main>⟩</span><span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>⟩</span><span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=keyword1><span class=command>using</span></span> trancl_trans r_into_trancl
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=free>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>^+</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>u</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span><span class=main>^+</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>u</span><span class=main>,</span> <span class=skolem>v</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>z</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> <span class=var>?A</span><span class=main>(</span><span class=free>w</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span> <span class=skolem>u</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?R</span><span class=main>(</span><span class=free>w</span><span class=main>)</span><span class=main>^+</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>u</span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-forcerel_eq><span class=command>lemma</span></span> forcerel_eq <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>z</span><span class=main>,</span><span class=free>x</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>=</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>∩</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>×</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms aux forcerelD forcerel_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> subsetI
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-forcerel_below_aux><span class=command>lemma</span></span> forcerel_below_aux <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>z</span><span class=main>,</span><span class=free>x</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>u</span><span class=main>,</span><span class=free>z</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>rule</span> trancl_induct<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span>  <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>" <span class=main>⟨</span><span class=free>u</span><span class=main>,</span> <span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that vimage_singleton_iff arg_into_names_below2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>u</span><span class=main>,</span> <span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>x</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span> <span class=skolem>z</span><span class=main>⟩</span> <span class=main>∈</span> frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=free>u</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that arg_into_names_below2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>y</span></span> <span class=quoted><span class=skolem>z</span></span> <span class=quoted><span class=free>x</span></span><span class=main>]</span> names_below_tr <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-forcerel_below><span class=command>lemma</span></span> forcerel_below <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>z</span><span class=main>,</span><span class=free>x</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>z</span><span class=main>}</span> <span class=main>⊆</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> vimage_singleton_iff assms forcerel_below_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-relation_forcerel><span class=command>lemma</span></span> relation_forcerel <span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"relation<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"trans<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def <span class=keyword1><span class=command>using</span></span> relation_trancl trans_trancl <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>

<span class=keyword1 id=Forces_Definition-Hfrc_restrict_trancl><span class=command>lemma</span></span> Hfrc_restrict_trancl<span class=main>:</span> <span class=quoted><span class=quoted>"bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span>frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
         <span class=main>=</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>y</span><span class=main>,</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>(</span>frecrel<span class=main>(</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span><span class=main>^+</span><span class=main>)</span><span class=main>-``</span><span class=main>{</span><span class=free>y</span><span class=main>}</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Hfrc_def bool_of_o_def eq_case_def mem_case_def
  <span class=keyword1><span class=command>using</span></span> restrict_trancl_forcerel frecRI1 frecRI2 frecRI3
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* Recursive definition of forces for atomic formulas using a transitive relation *)</span>
<span class=keyword1 id=Forces_Definition-frc_at_trancl><span class=command>lemma</span></span> frc_at_trancl<span class=main>:</span> <span class=quoted><span class=quoted>"frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>=</span> wfrec<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>f</span><span class=main>.</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> frc_at_def forcerel_def <span class=keyword1><span class=command>using</span></span> wf_eq_trancl Hfrc_restrict_trancl <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Forces_Definition-forcerelI1><span class=command>lemma</span></span> forcerelI1 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>b</span><span class=main>)</span> <span class=main>∨</span> <span class=free>n1</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>c</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>d</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>b</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>⟩</span><span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?x</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>b</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?y</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=var>?x</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> frecRI1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=var>?y</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> names_belowI  assms components_in_eclose
    <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹frecR<span class=main>(</span><span class=var>?x</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> forcerel_def frecrel_def
    <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> r_subset_trancl<span class=main><span class=main>[</span></span><span class=operator>OF</span> relation_Rrel<span class=main><span class=main>]</span></span><span class=main>]</span> RrelI
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-forcerelI2><span class=command>lemma</span></span> forcerelI2 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n1</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>b</span><span class=main>)</span> <span class=main>∨</span> <span class=free>n1</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>c</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>d</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span><span class=main>,</span> <span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>⟩</span><span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?x</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>n1</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?y</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=var>?x</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> frecRI2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=var>?y</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> names_belowI  assms components_in_eclose
    <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹frecR<span class=main>(</span><span class=var>?x</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> forcerel_def frecrel_def
    <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> r_subset_trancl<span class=main><span class=main>[</span></span><span class=operator>OF</span> relation_Rrel<span class=main><span class=main>]</span></span><span class=main>]</span> RrelI
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-forcerelI3><span class=command>lemma</span></span> forcerelI3 <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>n2</span><span class=main>,</span> <span class=free>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>c</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>d</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>b</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>b</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>d</span><span class=main>⟩</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>c</span><span class=main>,</span><span class=free>d</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?x</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>0</span><span class=main>,</span> <span class=free>b</span><span class=main>,</span> <span class=free>n2</span><span class=main>,</span> <span class=free>p</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?y</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=main>1</span><span class=main>,</span> <span class=free>b</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=free>d</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecR<span class=main>(</span><span class=var>?x</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms frecRI3 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span><span class=main>∈</span>names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=var>?y</span> <span class=main>∈</span> names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> names_belowI  assms components_in_eclose
    <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹frecR<span class=main>(</span><span class=var>?x</span><span class=main>,</span><span class=var>?y</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> forcerel_def frecrel_def
    <span class=keyword1><span class=command>using</span></span> subsetD<span class=main>[</span><span class=operator>OF</span> r_subset_trancl<span class=main><span class=main>[</span></span><span class=operator>OF</span> relation_Rrel<span class=main><span class=main>]</span></span><span class=main>]</span> RrelI
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> forcerelI <span class=main>=</span> forcerelI1<span class=main>[</span><span class=operator>THEN</span> vimage_singleton_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span><span class=main>]</span>
  forcerelI2<span class=main>[</span><span class=operator>THEN</span> vimage_singleton_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span><span class=main>]</span>
  forcerelI3<span class=main>[</span><span class=operator>THEN</span> vimage_singleton_iff<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span><span class=main>]</span>

<span class=keyword1 id=Forces_Definition-aux_def_frc_at><span class=command>lemma</span></span>  aux_def_frc_at<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>x</span><span class=main>}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span> <span class=main>=</span>  wfrec<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"names_below<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>z</span><span class=main>,</span><span class=free>x</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> vimage_singleton_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forcerel_arg_into_names_below <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=free>z</span><span class=main>,</span><span class=free>x</span><span class=main>⟩</span> <span class=main>∈</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> E<span class=main>:</span><span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>=</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span><span class=var>?A</span><span class=main>×</span><span class=var>?A</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=free>z</span><span class=main>}</span> <span class=main>⊆</span> <span class=var>?A</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forcerel_eq forcerel_below
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>z</span><span class=main>∈</span><span class=var>?A</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wfrec<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>wfrec[</span><span class=var>?A</span><span class=main>](</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>,</span> <span class=free>z</span><span class=main>,</span> <span class=free>H</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> wfrec_trans_restr<span class=main>[</span><span class=operator>OF</span> relation_forcerel<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> wf_forcerel relation_forcerel<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>z</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> E wfrec_restr_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Recursive expression of <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹frc_at›</span></span></span></span>›</span></span>

<span class=keyword1 id=Forces_Definition-def_frc_at><span class=command>lemma</span></span> def_frc_at <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=main>⟨</span><span class=free>ft</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span>
   bool_of_o<span class=main>(</span> <span class=free>p</span> <span class=main>∈</span><span class=free>P</span> <span class=main>∧</span>
  <span class=main>(</span>  <span class=free>ft</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span>  <span class=main>(</span><span class=main>∀</span><span class=bound>s</span><span class=main>.</span> <span class=bound>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>n1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>n2</span><span class=main>)</span> <span class=main>⟶</span>
        <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟶</span> <span class=main>(</span>frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span><span class=main>1</span> <span class=main>⟷</span> frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
   <span class=main>∨</span> <span class=free>ft</span> <span class=main>=</span> <span class=main>1</span> <span class=main>∧</span> <span class=main>(</span> <span class=main>∀</span><span class=bound>v</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>v</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟶</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=bound>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>n2</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=bound>r</span> <span class=main>∧</span>  frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=var><span class=quoted><span class=var>?Hf</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>f</span><span class=main>.</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?t</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=var>?r</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=bound>y</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?arg</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>ft</span><span class=main>,</span><span class=free>n1</span><span class=main>,</span><span class=free>n2</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> wf_forcerel
  <span class=keyword1><span class=command>have</span></span> wfr<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>w</span> <span class=main>.</span> wf<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=bound>w</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
  <span class=keyword1><span class=command>with</span></span> wfrec <span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?r</span><span class=main>(</span><span class=var>?arg</span><span class=main>)</span>"</span></span> <span class=var><span class=quoted><span class=var>?arg</span></span></span> <span class=var><span class=quoted><span class=var>?Hf</span></span></span><span class=main>]</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=var>?arg</span><span class=main>)</span> <span class=main>=</span> <span class=var>?Hf</span><span class=main>(</span> <span class=var>?arg</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=var>?arg</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=var>?arg</span><span class=main>}</span><span class=main>.</span> wfrec<span class=main>(</span><span class=var>?r</span><span class=main>(</span><span class=var>?arg</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=var>?Hf</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> frc_at_trancl <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=var>?Hf</span><span class=main>(</span> <span class=var>?arg</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>∈</span><span class=var>?r</span><span class=main>(</span><span class=var>?arg</span><span class=main>)</span> <span class=main>-``</span> <span class=main>{</span><span class=var>?arg</span><span class=main>}</span><span class=main>.</span> frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> aux_def_frc_at frc_at_trancl <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Hfrc_def mem_case_def eq_case_def
    <span class=keyword1><span class=command>using</span></span> forcerelI  assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Absoluteness of <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹frc_at›</span></span></span></span>›</span></span>

<span class=keyword1 id=Forces_Definition-trans_forcerel_t><span class=command>lemma</span></span> trans_forcerel_t <span class=main>:</span> <span class=quoted><span class=quoted>"trans<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def <span class=keyword1><span class=command>using</span></span> trans_trancl <span class=keyword1><span class=command>.</span></span>

<span class=keyword1 id=Forces_Definition-relation_forcerel_t><span class=command>lemma</span></span> relation_forcerel_t <span class=main>:</span> <span class=quoted><span class=quoted>"relation<span class=main>(</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def <span class=keyword1><span class=command>using</span></span> relation_trancl <span class=keyword1><span class=command>.</span></span>


<span class=keyword1 id=Forces_Definition-forcerel_in_M><span class=command>lemma</span></span> forcerel_in_M <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forcerel_def def_frecrel names_below_def
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>2</span> <span class=main>×</span> ecloseN<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>×</span> ecloseN<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span> <span class=main>×</span> <span class=var>?Q</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>M</span>›</span></span> P_in_M twoN_in_M ecloseN_closed cartprod_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>frecrelP_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> number1_fm_def frecrelP_fm_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>FOL_sats_iff pair_abs empty_abs
          <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fm_defs frecR_fm_def number1_fm_def components_defs nat_simp_union<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>frecrelP_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span> <span class=main>,</span> <span class=main>[</span><span class=bound>z</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"frecrelP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>frecrelP_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>z</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> that sats_frecrelP_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>z</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>frecrelP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> separation_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> frecrelP_abs
        separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"frecrelP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>z</span> <span class=main>∈</span> <span class=var>?Q</span> <span class=main>×</span> <span class=var>?Q</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> frecR<span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>}</span><span class=main>^+</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_closed frecrelP_abs trancl_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-relation2_Hfrc_at_abs><span class=command>lemma</span></span> relation2_Hfrc_at_abs<span class=main>:</span>
  <span class=quoted><span class=quoted>"relation2<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>f</span><span class=main>.</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> relation2_def <span class=keyword1><span class=command>using</span></span> Hfrc_at_abs
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-Hfrc_at_closed><span class=command>lemma</span></span> Hfrc_at_closed <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>g</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> function<span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟶</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> bool_of_o_def <span class=keyword1><span class=command>using</span></span> zero_in_M n_in_M<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>1</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-wfrec_Hfrc_at><span class=command>lemma</span></span> wfrec_Hfrc_at <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>X</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"wfrec_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 0<span class=main>:</span><span class=quoted><span class=quoted>"is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>c</span><span class=main>)</span> <span class=main>⟷</span>
        sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>Hfrc_at_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>9</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>e</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span> <span class=skolem>d</span> <span class=skolem>e</span> <span class=skolem>y</span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that P_in_M leq_in_M <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> forcerel_in_M
      is_Hfrc_at_iff_sats<span class=main>[</span><span class=operator>of</span> <span class=quasi_keyword>concl</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>M</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>leq</span></span> <span class=quoted><span class=skolem>a</span></span> <span class=quoted><span class=skolem>b</span></span> <span class=quoted><span class=skolem>c</span></span> <span class=quoted><span class=main>8</span></span> <span class=quoted><span class=main>9</span></span> <span class=quoted><span class=main>2</span></span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=main>0</span></span>
        <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>c</span><span class=main>,</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=skolem>e</span><span class=main>,</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>is_wfrec_fm<span class=main>(</span>Hfrc_at_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>9</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span>
                   is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>y</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span>  that <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> forcerel_in_M P_in_M leq_in_M
      sats_is_wfrec_fm<span class=main>[</span><span class=operator>OF</span> 0<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>is_wfrec_fm<span class=main>(</span>Hfrc_at_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>9</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> satsf<span class=main>:</span><span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?f</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span>
              <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=skolem>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that 1 <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> forcerel_in_M P_in_M leq_in_M <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> artyf<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_wfrec_fm_def Hfrc_at_fm_def Hfrc_fm_def Replace_fm_def PHcheck_fm_def
      pair_fm_def upair_fm_def is_recfun_fm_def fun_apply_fm_def big_union_fm_def
      pre_image_fm_def restriction_fm_def image_fm_def fm_defs number1_fm_def
      eq_case_fm_def mem_case_fm_def is_tuple_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span><span class=main>∈</span>formula"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> fm_defs Hfrc_at_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?f</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax 1 artyf <span class=quoted><span class=quoted>‹<span class=free>X</span><span class=main>∈</span><span class=free>M</span>›</span></span> forcerel_in_M P_in_M leq_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span>
          <span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>&amp;</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>,</span> <span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> repl_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span>forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>X</span><span class=main>)</span><span class=main>]</span>"</span></span><span class=main>]</span> satsf <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>pair_abs<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> wfrec_replacement_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-names_below_abs><span class=command>lemma</span></span> names_below_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>Q</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>nb</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_names_below<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>Q</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>nb</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>nb</span> <span class=main>=</span> names_below<span class=main>(</span><span class=free>Q</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_names_below_def names_below_def
  <span class=keyword1><span class=command>using</span></span> succ_in_M_iff zero_in_M cartprod_closed is_ecloseN_abs ecloseN_closed
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-names_below_closed><span class=command>lemma</span></span> names_below_closed<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>Q</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> names_below<span class=main>(</span><span class=free>Q</span><span class=main>,</span><span class=free>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> names_below_def
  <span class=keyword1><span class=command>using</span></span> zero_in_M cartprod_closed ecloseN_closed succ_in_M_iff
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=quoted>"names_below_productE"</span> <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>A1</span> <span class=bound>A2</span> <span class=bound>A3</span> <span class=bound>A4</span><span class=main>.</span> <span class=bound>A1</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=bound>A2</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=bound>A3</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=bound>A4</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=bound>A1</span> <span class=main>×</span> <span class=bound>A2</span> <span class=main>×</span> <span class=bound>A3</span> <span class=main>×</span> <span class=bound>A4</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>(</span>names_below<span class=main>(</span><span class=free>Q</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> names_below_def <span class=keyword1><span class=command>using</span></span> assms zero_in_M ecloseN_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>x</span></span></span></span></span></span><span class=main>]</span> twoN_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-forcerel_abs><span class=command>lemma</span></span> forcerel_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span><span class=free>z</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_forcerel<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>z</span> <span class=main>=</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_forcerel_def forcerel_def
  <span class=keyword1><span class=command>using</span></span> frecrel_abs names_below_abs trancl_abs P_in_M twoN_in_M ecloseN_closed names_below_closed
    names_below_productE<span class=main>[</span><span class=operator>of</span> <span class=quasi_keyword>concl</span><span class=main><span class=main>:</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>p</span><span class=main>.</span> is_frecrel<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=main>_</span><span class=main>)</span> <span class=main>⟷</span>  <span class=main>_</span> <span class=main>=</span> frecrel<span class=main>(</span><span class=bound>p</span><span class=main>)</span>"</span></span><span class=main>]</span> frecrel_closed
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-frc_at_abs><span class=command>lemma</span></span> frc_at_abs<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>fnnc</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_frc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>z</span> <span class=main>=</span> frc_at<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>fnnc</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_forcerel<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>fnnc</span><span class=main>,</span> <span class=bound>r</span><span class=main>)</span> <span class=main>∧</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>)</span><span class=main>,</span> <span class=bound>r</span><span class=main>,</span> <span class=free>fnnc</span><span class=main>,</span> <span class=free>z</span><span class=main>)</span><span class=main>)</span>
        <span class=main>⟷</span> is_wfrec<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>)</span><span class=main>,</span> forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>fnnc</span><span class=main>)</span><span class=main>,</span> <span class=free>fnnc</span><span class=main>,</span> <span class=free>z</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forcerel_abs forcerel_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> frc_at_trancl is_frc_at_def
    <span class=keyword1><span class=command>using</span></span> assms wfrec_Hfrc_at<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>fnnc</span></span><span class=main>]</span> wf_forcerel trans_forcerel_t relation_forcerel_t forcerel_in_M
      Hfrc_at_closed relation2_Hfrc_at_abs
      trans_wfrec_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"forcerel<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>fnnc</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>fnnc</span></span> <span class=quoted><span class=free>z</span></span> <span class=quoted><span class=quoted>"is_Hfrc_at<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>f</span><span class=main>.</span> bool_of_o<span class=main>(</span>Hfrc<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>f</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span>setclass_iff<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id="Forces_Definition-forces_eq'_abs"><span class=command>lemma</span></span> forces_eq'_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t1</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_forces_eq'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_eq'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_forces_eq'_def forces_eq'_def
  <span class=keyword1><span class=command>using</span></span> frc_at_abs zero_in_M tuples_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id="Forces_Definition-forces_mem'_abs"><span class=command>lemma</span></span> forces_mem'_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t1</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_forces_mem'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_mem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_forces_mem'_def forces_mem'_def
  <span class=keyword1><span class=command>using</span></span> frc_at_abs zero_in_M tuples_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id="Forces_Definition-forces_neq'_abs"><span class=command>lemma</span></span> forces_neq'_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_forces_neq'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_neq'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> that transitivity P_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_forces_neq'_def forces_neq'_def
    <span class=keyword1><span class=command>using</span></span> assms forces_eq'_abs pair_in_M_iff
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span><span class=operator>blast</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id="Forces_Definition-forces_nmem'_abs"><span class=command>lemma</span></span> forces_nmem'_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"is_forces_nmem'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_nmem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> that transitivity P_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> is_forces_nmem'_def forces_nmem'_def
    <span class=keyword1><span class=command>using</span></span> assms forces_mem'_abs pair_in_M_iff
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span><span class=operator>blast</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Forcing for general formulas›</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ren_forces_nand</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ren_forces_nand</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>1</span> <span class=main>,</span> <span class=main>2</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-ren_forces_nand_type><span class=command>lemma</span></span> ren_forces_nand_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> ren_forces_nand<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ren_forces_nand_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-arity_ren_forces_nand><span class=command>lemma</span></span> arity_ren_forces_nand <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>ren_forces_nand<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>1</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ge<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>1</span> <span class=main>&lt;</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> lt
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>2</span> <span class=main>&lt;</span> succ<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>2</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> succ_ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>2</span><span class=main>#+</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma lt
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ren_forces_nand_def
      <span class=keyword1><span class=command>using</span></span> lt pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> Un_le_compat
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ge
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> not_lt_iff_le le_trans<span class=main>[</span><span class=operator>OF</span> le_pred<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma ge
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹pred<span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ren_forces_nand_def
      <span class=keyword1><span class=command>using</span></span>  pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> nat_union_abs2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-sats_ren_forces_nand><span class=command>lemma</span></span> sats_ren_forces_nand<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>p</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span>
   sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> ren_forces_nand<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ren_forces_nand_def
  <span class=keyword1><span class=command>using</span></span> sats_incr_bv_iff <span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>q</span><span class=main>]</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>ren_forces_forall</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ren_forces_forall</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span>
      Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>
        And<span class=main>(</span>Equal<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>6</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>7</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>8</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>9</span><span class=main>)</span><span class=main>,</span>
        And<span class=main>(</span>Equal<span class=main>(</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>,</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span> <span class=main>,</span> <span class=main>5</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-arity_ren_forces_all><span class=command>lemma</span></span> arity_ren_forces_all <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>ren_forces_forall<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span> <span class=main>∪</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ge<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>5</span> <span class=main>&lt;</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> lt
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span> <span class=main>&lt;</span> succ<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>2</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>3</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>4</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> succ_ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span><span class=main>#+</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma lt
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ren_forces_forall_def
      <span class=keyword1><span class=command>using</span></span> pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> nat_union_abs2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ge
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>"</span></span> <span class=quoted><span class=quoted>"pred<span class=main>^</span><span class=main>5</span><span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> not_lt_iff_le le_trans<span class=main>[</span><span class=operator>OF</span> le_pred<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma ge
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹pred<span class=main>^</span><span class=main>5</span><span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ren_forces_forall_def
      <span class=keyword1><span class=command>using</span></span>  pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> nat_union_abs2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-ren_forces_forall_type><span class=command>lemma</span></span> ren_forces_forall_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> ren_forces_forall<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ren_forces_forall_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_ren_forces_forall><span class=command>lemma</span></span> sats_ren_forces_forall <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>p</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span>
    sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> ren_forces_forall<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ren_forces_forall_def
  <span class=keyword1><span class=command>using</span></span> sats_incr_bv_iff <span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>M</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>x</span><span class=main>]</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_leq</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_leq</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>qp</span><span class=main>[</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>].</span> <span class=main>(</span>pair<span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=bound>qp</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>qp</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> forcing_data<span class=main>)</span> leq_abs<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>l</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>q</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> is_leq<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>⟨</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_leq_def <span class=keyword1><span class=command>using</span></span> pair_in_M_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>leq_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>leq_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>#+</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>#+</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq</span></span></span><span class=main>#+</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forces_Definition-arity_leq_fm><span class=command>lemma</span></span> arity_leq_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>leq</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> arity<span class=main>(</span>leq_fm<span class=main>(</span><span class=free>leq</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>q</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>p</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>leq</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> leq_fm_def
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm pred_Un_distrib nat_simp_union
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-leq_fm_type><span class=command>lemma</span></span> leq_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>leq</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> leq_fm<span class=main>(</span><span class=free>leq</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> leq_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_leq_fm><span class=command>lemma</span></span> sats_leq_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>leq</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>q</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>p</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟧</span> <span class=main>⟹</span>
     sats<span class=main>(</span><span class=free>A</span><span class=main>,</span>leq_fm<span class=main>(</span><span class=free>leq</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_leq<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span>nth<span class=main>(</span><span class=free>leq</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> leq_fm_def is_leq_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>subsubsection</span></span><span class=quoted><span class=plain_text>‹The primitive recursion›</span></span>

<span class=keyword1><span class=command>consts</span></span> forces' <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span>
<span class=keyword1><span class=command>primrec</span></span>
  <span class=quoted><span class=quoted>"forces'<span class=main>(</span>Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> forces_mem_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free>x</span><span class=main>#+</span><span class=main>4</span><span class=main>,</span><span class=free>y</span><span class=main>#+</span><span class=main>4</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"forces'<span class=main>(</span>Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span>  <span class=main>=</span> forces_eq_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free>x</span><span class=main>#+</span><span class=main>4</span><span class=main>,</span><span class=free>y</span><span class=main>#+</span><span class=main>4</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"forces'<span class=main>(</span>Nand<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>q</span><span class=main>)</span><span class=main>)</span>   <span class=main>=</span>
        Neg<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>leq_fm<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>ren_forces_nand<span class=main>(</span>forces'<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
                                         ren_forces_nand<span class=main>(</span>forces'<span class=main>(</span><span class=free>q</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"forces'<span class=main>(</span>Forall<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span>   <span class=main>=</span> Forall<span class=main>(</span>ren_forces_forall<span class=main>(</span>forces'<span class=main>(</span><span class=free>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>forces'<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id="Forces_Definition-forces'_type"><span class=command>lemma</span></span> forces'_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> forces'<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>φ</span></span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>formula<span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span><span class=main>)</span>

<span class=keyword1 id=Forces_Definition-forces_type><span class=command>lemma</span></span> forces_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Forcing for atomic formulas in context›</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_eq</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_eq</span> <span class=main>≡</span> forces_eq'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_mem</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_mem</span> <span class=main>≡</span> forces_mem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span>

<span class=comment1>(* frc_at(P,leq,⟨0,t1,t2,p⟩) = 1*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forces_eq</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forces_eq</span> <span class=main>≡</span> is_forces_eq'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span>

<span class=comment1>(* frc_at(P,leq,⟨1,t1,t2,p⟩) = 1*)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_forces_mem</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_forces_mem</span> <span class=main>≡</span> is_forces_mem'<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Forces_Definition-def_forces_eq><span class=command>lemma</span></span> def_forces_eq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>t2</span><span class=main>)</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟶</span>
      <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_eq_def forces_mem_def forces_eq'_def forces_mem'_def
  <span class=keyword1><span class=command>using</span></span> def_frc_at<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>t2</span></span> <span class=main>]</span>  <span class=keyword1><span class=command>unfolding</span></span> bool_of_o_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-def_forces_mem><span class=command>lemma</span></span> def_forces_mem<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span>
     <span class=main>(</span><span class=main>∀</span><span class=bound>v</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>v</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>⟶</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=bound>v</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=bound>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_eq'_def forces_mem'_def forces_eq_def forces_mem_def
  <span class=keyword1><span class=command>using</span></span> def_frc_at<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>t2</span></span><span class=main>]</span>  <span class=keyword1><span class=command>unfolding</span></span> bool_of_o_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-forces_eq_abs><span class=command>lemma</span></span> forces_eq_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t1</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_forces_eq_def forces_eq_def
  <span class=keyword1><span class=command>using</span></span> forces_eq'_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forces_mem_abs><span class=command>lemma</span></span> forces_mem_abs <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>p</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t1</span><span class=main>∈</span><span class=free>M</span> <span class=main>;</span> <span class=free>t2</span><span class=main>∈</span><span class=free>M</span><span class=main>⟧</span> <span class=main>⟹</span> is_forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_forces_mem_def forces_mem_def
  <span class=keyword1><span class=command>using</span></span> forces_mem'_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_forces_eq_fm><span class=command>lemma</span></span> sats_forces_eq_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>leq</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces_eq_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
         is_forces_eq<span class=main>(</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_eq_fm_def is_forces_eq_def is_forces_eq'_def
  <span class=keyword1><span class=command>using</span></span> assms sats_is_tuple_fm  sats_frc_at_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_forces_mem_fm><span class=command>lemma</span></span> sats_forces_mem_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span>nat"</span></span>  <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>l</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>leq</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces_mem_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
             is_forces_mem<span class=main>(</span>nth<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t1</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>t2</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_mem_fm_def is_forces_mem_def is_forces_mem'_def
  <span class=keyword1><span class=command>using</span></span> assms sats_is_tuple_fm sats_frc_at_fm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_neq</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_neq</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>forces_nmem</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>forces_nmem</span><span class=main>(</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free><span class=bound><span class=entity>t1</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t2</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Forces_Definition-forces_neq><span class=command>lemma</span></span> forces_neq <span class=main>:</span>
  <span class=quoted><span class=quoted>"forces_neq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_neq'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_neq_def forces_neq'_def forces_eq_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-forces_nmem><span class=command>lemma</span></span> forces_nmem <span class=main>:</span>
  <span class=quoted><span class=quoted>"forces_nmem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_nmem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_def forces_nmem'_def forces_mem_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Forces_Definition-sats_forces_Member><span class=command>lemma</span></span> sats_forces_Member <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>xx</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>yy</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span>Member<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
                <span class=main>(</span><span class=free>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> is_forces_mem<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>xx</span><span class=main>,</span><span class=free>yy</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_mem_fm P_in_M leq_in_M one_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_forces_Equal><span class=command>lemma</span></span> sats_forces_Equal <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>xx</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>yy</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span>Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
                <span class=main>(</span><span class=free>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> is_forces_eq<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>xx</span><span class=main>,</span><span class=free>yy</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_eq_fm P_in_M leq_in_M one_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_forces_Nand><span class=command>lemma</span></span> sats_forces_Nand <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span>Nand<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
         <span class=main>(</span><span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> is_leq<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>∧</span>
               <span class=main>(</span>sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces'<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>∧</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces'<span class=main>(</span><span class=free>ψ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def <span class=keyword1><span class=command>using</span></span> sats_leq_fm assms sats_ren_forces_nand P_in_M leq_in_M one_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_forces_Neg><span class=command>lemma</span></span> sats_forces_Neg <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span>Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
         <span class=main>(</span><span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> is_leq<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>∧</span>
               <span class=main>(</span>sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces'<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Neg_def <span class=keyword1><span class=command>using</span></span> assms sats_forces_Nand
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forces_Definition-sats_forces_Forall><span class=command>lemma</span></span> sats_forces_Forall <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span>Forall<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
         <span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces'<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=bound>x</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def <span class=keyword1><span class=command>using</span></span> assms sats_ren_forces_forall P_in_M leq_in_M one_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The arity of <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹forces›</span></span></span></span>›</span></span>

<span class=keyword1 id=Forces_Definition-arity_forces_at><span class=command>lemma</span></span> arity_forces_at<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span>Member<span class=main>(</span><span class=free>x</span><span class=main>,</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>#+</span> <span class=main>4</span>"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span>Equal<span class=main>(</span><span class=free>x</span><span class=main>,</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>succ<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>y</span><span class=main>)</span><span class=main>)</span> <span class=main>#+</span> <span class=main>4</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>using</span></span> assms arity_forces_mem_fm arity_forces_eq_fm succ_Un_distrib nat_simp_union
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id="Forces_Definition-arity_forces'"><span class=command>lemma</span></span> arity_forces'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces'<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>#+</span> <span class=main>4</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span>formula<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Member <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> arity_forces_mem_fm succ_Un_distrib nat_simp_union
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Equal <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> arity_forces_eq_fm succ_Un_distrib nat_simp_union
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Nand <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"ren_forces_nand<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ψ'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"ren_forces_nand<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>leq_fm<span class=main>(</span><span class=main>3</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arity_leq_fm succ_Un_distrib nat_simp_union
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>3</span> <span class=main>≤</span> <span class=main>(</span><span class=main>4</span><span class=main>#+</span>arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> <span class=main>(</span><span class=main>4</span><span class=main>#+</span>arity<span class=main>(</span><span class=skolem>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>≤</span> <span class=var>?rhs</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> Nand
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=var>?rhs</span>"</span></span>  <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?ψ'</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=var>?rhs</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>ψ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?ψ'</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> pred_mono<span class=main>[</span><span class=operator>OF</span> _  arity_ren_forces_nand<span class=main>]</span> pred_succ_eq
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>from</span></span> Nand
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>3</span> <span class=main>∪</span> arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=main>#+</span> <span class=main>4</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>3</span> <span class=main>∪</span> arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> arity<span class=main>(</span><span class=skolem>ψ</span><span class=main>)</span> <span class=main>#+</span> <span class=main>4</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Un_le <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> Nand
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=var>?rhs</span>"</span></span>
      <span class=quoted><span class=quoted>"pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?ψ'</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=var>?rhs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> A<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> le_trans<span class=main>[</span><span class=operator>OF</span> A<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> le_Un_iff
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>with</span></span> Nand <span class=quoted><span class=quoted>‹<span class=main>_</span><span class=main>=</span><span class=main>4</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> pred_Un_distrib Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> succ_Un_distrib nat_union_abs1 Un_leI3<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>3</span> <span class=main>≤</span> <span class=var>?rhs</span>›</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Forall <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"ren_forces_forall<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>with</span></span> Forall
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>from</span></span> Forall True
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=main>4</span></span> <span class=quoted><span class=main>5</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> arity_ren_forces_all<span class=main>[</span><span class=operator>OF</span> forces'_type<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> nat_union_abs2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> Forall True
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> pred_mono<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>›</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> Forall
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>from</span></span> Forall False
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span> <span class=main>∪</span> arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span> <span class=main>#+</span> arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>4</span> <span class=main>≤</span> succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Ord_0_lt arity_ren_forces_all
          le_trans<span class=main>[</span><span class=operator>OF</span> _ add_le_mono<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=main>4</span></span> <span class=quoted><span class=main>5</span></span><span class=main><span class=main>,</span></span> <span class=operator>OF</span> _ le_refl<span class=main><span class=main>]</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span> <span class=main>∪</span> arity<span class=main>(</span>forces'<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span><span class=main>#+</span>arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span> <span class=main>∪</span> <span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> pred_Un_distrib succ_pred_eq<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>≠</span><span class=main>0</span>›</span></span><span class=main>]</span>
          pred_mono<span class=main>[</span><span class=operator>OF</span> _ Forall<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span> Un_le<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>4</span><span class=main>≤</span>succ<span class=main>(</span><span class=main>_</span><span class=main>)</span>›</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forces_Definition-arity_forces><span class=command>lemma</span></span> arity_forces <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>4</span><span class=main>#+</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>using</span></span> assms arity_forces' le_trans nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forces_Definition-arity_forces_le><span class=command>lemma</span></span> arity_forces_le <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=free>n</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>4</span><span class=main>#+</span><span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms le_trans<span class=main>[</span><span class=operator>OF</span> _ add_le_mono<span class=main><span class=main>[</span></span><span class=operator>OF</span> le_refl<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=main>5</span></span><span class=main><span class=main>]</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>_</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> arity_forces
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Forcing_Theorems><div class=head><h1>Theory Forcing_Theorems</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Forcing Theorems›</span></span>

<span class=keyword1><span class=command>theory</span></span> Forcing_Theorems
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Forces_Definition.html>Forces_Definition</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The forcing relation in context›</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>Forces</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=quoted>"_ <span class=keyword1>⊩</span> _ _"</span> <span class=main>[</span>36<span class=main>,</span>36<span class=main>,</span>36<span class=main>]</span> 60<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>p</span></span></span> <span class=main><span class=free>⊩</span></span> <span class=free><span class=bound><span class=entity>φ</span></span></span> <span class=free><span class=bound><span class=entity>env</span></span></span>   <span class=main>≡</span>   <span class=free>M</span><span class=main>,</span> <span class=main>(</span><span class=main>[</span><span class=free><span class=bound><span class=entity>p</span></span></span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Theorems-Collect_forces><span class=command>lemma</span></span> Collect_forces <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    fty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    far<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    envty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> P_in_M transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span> <span class=quoted><span class=free>P</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> separation_ax arity_forces far fty P_in_M leq_in_M one_in_M envty arity_forces_le
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_closed P_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-forces_mem_iff_dense_below><span class=command>lemma</span></span> forces_mem_iff_dense_below<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> dense_below<span class=main>(</span>
    <span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>t2</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=bound>s</span><span class=main>)</span><span class=main>}</span>
    <span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> def_forces_mem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>t2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Kunen 2013, Lemma IV.2.37(a)›</span></span>

<span class=keyword1 id=Forcing_Theorems-strengthening_eq><span class=command>lemma</span></span> strengthening_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>≼</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms def_forces_eq<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>t2</span></span><span class=main>]</span> leq_transD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=comment1>(* Long proof *)</span>
<span class=comment1>(*
proof -
  {
    fix s q
    assume "q≼ r" "q∈P"
    with assms
    have "q≼p"
      using leq_preord unfolding preorder_on_def trans_on_def by blast
    moreover 
    note ‹q∈P› assms
    moreover
    assume "s∈domain(t1) ∪ domain(t2)" 
    ultimately
    have "forces_mem(q, s, t1) ⟷ forces_mem(q, s, t2)"
      using def_forces_eq[of p t1 t2] by simp
  }
  with ‹r∈P›
  show ?thesis using def_forces_eq[of r t1 t2] by blast
qed
*)</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Kunen 2013, Lemma IV.2.37(a)›</span></span>
<span class=keyword1 id=Forcing_Theorems-strengthening_mem><span class=command>lemma</span></span> strengthening_mem<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>≼</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms forces_mem_iff_dense_below dense_below_under <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Kunen 2013, Lemma IV.2.37(b)›</span></span>
<span class=keyword1 id=Forcing_Theorems-density_mem><span class=command>lemma</span></span> density_mem<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>  <span class=main>⟷</span> dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forces_mem_iff_dense_below strengthening_mem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span><span class=main>]</span> ideal_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span> <span class=free>t1</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span> <span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> 
    dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span> <span class=bound>r</span><span class=main>.</span> <span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>t2</span> <span class=main>∧</span> <span class=bound>q'</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q'</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=bound>s</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span>
    <span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forces_mem_iff_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> dense_below_dense_below forces_mem_iff_dense_below<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>t2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-aux_density_eq><span class=command>lemma</span></span> aux_density_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"dense_below<span class=main>(</span>
    <span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>q'</span> <span class=main>⟶</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span>
    <span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>q</span><span class=main>≼</span><span class=free>p</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>r</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>q</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>r</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=free>q</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>≼</span><span class=free>p</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> leq_transD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹forces_mem<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹dense_below<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>q</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q1</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q1</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q1</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q1</span><span class=main>,</span><span class=free>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> strengthening_mem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>q</span></span> <span class=main>_</span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>t1</span></span><span class=main>]</span> leq_reflI leq_transD<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=skolem>r</span></span> <span class=quoted><span class=free>q</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=main>{</span><span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>r</span><span class=main>,</span> <span class=free>s</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>.</span> <span class=bound>d</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>d</span><span class=main>≼</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Kunen 2013, Lemma IV.2.37(b) *)</span>
<span class=keyword1 id=Forcing_Theorems-density_eq><span class=command>lemma</span></span> density_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>  <span class=main>⟷</span> dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> strengthening_eq ideal_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span> <span class=skolem>q</span> 
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>t2</span><span class=main>)</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>q'</span> <span class=main>⟶</span>
           forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span><span class=main>⟷</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>q'</span> <span class=main>⟶</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>t2</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D1</span><span class=main>⊆</span><span class=var>?D2</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹dense_below<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>s</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>t1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>t2</span><span class=main>)</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>q'</span> <span class=main>⟶</span>
           forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span><span class=main>⟷</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> dense_below_cong'<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> def_forces_eq<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>t1</span></span> <span class=quoted><span class=free>t2</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?D1</span><span class=main>⊆</span><span class=var>?D2</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>q'</span> <span class=main>⟶</span> 
            forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> dense_below_mono <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=comment1>(* Automatic tools can't handle this symmetry 
                          in order to apply aux_density_eq below *)</span>
    <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>q'</span> <span class=main>⟶</span> 
            forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=comment1>(*We can omit the next step but it is slower *)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span> <span class=main>⟹</span> dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>r</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span>"</span></span>
         <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟹</span> dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>r</span><span class=main>,</span><span class=skolem>s</span><span class=main>,</span><span class=free>t1</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> aux_density_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>s</span><span class=main>,</span> <span class=free>t1</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>s</span><span class=main>,</span> <span class=free>t2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> density_mem<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> def_forces_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Kunen 2013, Lemma IV.2.38›</span></span>
<span class=keyword1 id=Forcing_Theorems-not_forces_neq><span class=command>lemma</span></span> not_forces_neq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> forces_neq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms density_eq <span class=keyword1><span class=command>unfolding</span></span> forces_neq_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=Forcing_Theorems-not_forces_nmem><span class=command>lemma</span></span> not_forces_nmem<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms density_mem <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>(* Use the newer versions in Forces_Definition! *)</span>
<span class=comment1>(* (and adequate the rest of the code to them)  *)</span>

<span class=keyword1 id="Forcing_Theorems-sats_forces_Nand'"><span class=command>lemma</span></span> sats_forces_Nand'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span>Nand<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> 
     <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> is_leq<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>∧</span> 
           <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> 
           <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=free>ψ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_Nand<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2-4<span class=main><span class=main>)</span></span> transitivity<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
  P_in_M leq_in_M one_in_M <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id="Forcing_Theorems-sats_forces_Neg'"><span class=command>lemma</span></span> sats_forces_Neg'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span>Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>   <span class=main>⟷</span> 
     <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> is_leq<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>∧</span> 
          <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_Neg transitivity 
  P_in_M leq_in_M one_in_M  <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span><span class=main>)</span>

<span class=keyword1 id="Forcing_Theorems-sats_forces_Forall'"><span class=command>lemma</span></span> sats_forces_Forall'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span>Forall<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> 
     <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span>   <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sats_forces_Forall transitivity 
  P_in_M leq_in_M one_in_M sats_ren_forces_forall <span class=keyword1><span class=command>unfolding</span></span> forces_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The relation of forcing and atomic formulas›</span></span>
<span class=keyword1 id=Forcing_Theorems-Forces_Equal><span class=command>lemma</span></span> Forces_Equal<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>t1</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>t2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Equal<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
   <span class=keyword1><span class=command>using</span></span> assms sats_forces_Equal forces_eq_abs transitivity P_in_M 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-Forces_Member><span class=command>lemma</span></span> Forces_Member<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>t2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>t1</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>t2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Member<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>t1</span><span class=main>,</span><span class=free>t2</span><span class=main>)</span>"</span></span>
   <span class=keyword1><span class=command>using</span></span> assms sats_forces_Member forces_mem_abs transitivity P_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-Forces_Neg><span class=command>lemma</span></span> Forces_Neg<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms sats_forces_Neg' transitivity 
  P_in_M pair_in_M_iff leq_in_M leq_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
 
<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The relation of forcing and connectives›</span></span>

<span class=keyword1 id=Forcing_Theorems-Forces_Nand><span class=command>lemma</span></span> Forces_Nand<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Nand<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
   <span class=keyword1><span class=command>using</span></span> assms sats_forces_Nand' transitivity 
  P_in_M pair_in_M_iff leq_in_M leq_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-Forces_And_aux><span class=command>lemma</span></span> Forces_And_aux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span>   <span class=main>⟷</span> 
    <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=free>p</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=bound>r</span><span class=main>≼</span><span class=bound>q</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> And_def <span class=keyword1><span class=command>using</span></span> assms Forces_Neg Forces_Nand <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span><span class=main>)</span>

<span class=keyword1 id=Forcing_Theorems-Forces_And_iff_dense_below><span class=command>lemma</span></span> Forces_And_iff_dense_below<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span> <span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> dense_below_def <span class=keyword1><span class=command>using</span></span> Forces_And_aux assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>transitivity<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ P_in_M<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>rename_tac</span> q<span class=main><span class=keyword3>;</span></span> <span class=operator>drule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>q</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> bspec<span class=main>)</span><span class=main><span class=keyword3>+</span></span>

<span class=keyword1 id=Forcing_Theorems-Forces_Forall><span class=command>lemma</span></span> Forces_Forall<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
   <span class=keyword1><span class=command>using</span></span> sats_forces_Forall' assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* "x∈val(G,π) ⟹ ∃θ. ∃p∈G.  ⟨θ,p⟩∈π ∧ val(G,θ) = x" *)</span>
<span class=keyword1><span class=command>bundle</span></span> some_rules <span class=main>=</span>  elem_of_val_pair <span class=main>[</span><span class=operator>dest</span><span class=main>]</span> SepReplace_iff <span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> SepReplace_iff<span class=main>[</span><span class=operator>iff</span><span class=main>]</span>

<span class=keyword1><span class=command>context</span></span> 
  <span class=keyword2><span class=keyword>includes</span></span> some_rules
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Forcing_Theorems-elem_of_valI><span class=command>lemma</span></span> elem_of_valI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>θ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>π</span> <span class=main>∧</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span> <span class=main>=</span> <span class=free>x</span> <span class=main>⟹</span> <span class=free>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> def_val<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forcing_Theorems-GenExtD><span class=command>lemma</span></span> GenExtD<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>τ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-left_in_M><span class=command>lemma</span></span> left_in_M <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>tau</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>⟩</span><span class=main>∈</span><span class=free>tau</span> <span class=main>⟹</span> <span class=free>a</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> fst_snd_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>⟩</span>"</span></span><span class=main>]</span> transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Kunen 2013, Lemma IV.2.29›</span></span>
<span class=keyword1 id=Forcing_Theorems-generic_inter_dense_below><span class=command>lemma</span></span> generic_inter_dense_below<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>D</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=free>D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>D</span> <span class=main>∩</span> <span class=free>G</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=free>p</span><span class=main>⊥</span><span class=bound>q</span> <span class=main>∨</span> <span class=bound>q</span><span class=main>∈</span><span class=free>D</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=var>?D</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>r</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=main>{</span><span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=free>p</span> <span class=main>⊥</span> <span class=bound>q</span> <span class=main>∨</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>D</span><span class=main>}</span><span class=main>.</span> <span class=bound>d</span> <span class=main>≼</span> <span class=skolem>r</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊥</span> <span class=skolem>r</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>›</span></span>
        <span class=comment1>(* Automatic tools can't handle this case for some reason... *)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leq_reflI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>r</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>intro</span> bexI<span class=main>)</span> <span class=main>(</span><span class=operator>blast</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>≼</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> dense_belowD<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>s</span></span><span class=main>]</span> leq_transD<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=skolem>s</span></span> <span class=quoted><span class=skolem>r</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span><span class=main>⊆</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=comment1>(* D∈M *)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?d_fm</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Or<span class=main>(</span>Neg<span class=main>(</span>compat_in_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>4</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> M_genericD transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span>
          <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?d_fm</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?d_fm</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> compat_in_fm_def pair_fm_def upair_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_union_abs1 Un_commute<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>D</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?d_fm</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>¬</span> is_compat_in<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span> <span class=main>∨</span> <span class=skolem>q</span><span class=main>∈</span><span class=free>D</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> that sats_compat_in_fm P_in_M leq_in_M 1 <span class=quoted><span class=quoted>‹<span class=free>D</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span> is_compat_in<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>)</span> <span class=main>∨</span> <span class=skolem>q</span><span class=main>∈</span><span class=free>D</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>p</span><span class=main>⊥</span><span class=skolem>q</span> <span class=main>∨</span> <span class=skolem>q</span><span class=main>∈</span><span class=free>D</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>unfolding</span></span> compat_def <span class=keyword1><span class=command>using</span></span> that compat_in_abs P_in_M leq_in_M 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Collect_in_M_4p<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?d_fm</span></span></span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span> <span class=bound>w</span> <span class=bound>h</span><span class=main>.</span> <span class=bound>w</span><span class=main>⊥</span><span class=bound>x</span> <span class=main>∨</span> <span class=bound>x</span><span class=main>∈</span><span class=bound>h</span>"</span></span><span class=main>]</span> 
                    P_in_M leq_in_M <span class=quoted><span class=quoted>‹<span class=free>D</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>note</span></span> asm <span class=main>=</span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹dense<span class=main>(</span><span class=var>?D</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?D</span><span class=main>⊆</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?D</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=var>?D</span>"</span></span> <span class=keyword1><span class=command>using</span></span> M_generic_denseD<span class=main>[</span><span class=operator>OF</span> asm<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span> <span class=comment1>(* by (erule bexE) does it, but the other automatic tools don't *)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>D</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> M_generic_compatD<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span>
      leq_reflI compatI<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Auxiliary results for Lemma IV.2.40(a)›</span></span>
<span class=keyword1 id=Forcing_Theorems-IV240a_mem_Collect><span class=command>lemma</span></span> IV240a_mem_Collect<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>π</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>σ</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rel_pred</span></span></span><span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>M</span> <span class=bound>x</span> <span class=bound>a1</span> <span class=bound>a2</span> <span class=bound>a3</span> <span class=bound>a4</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>r</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>σr</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> 
                <span class=bound>r</span><span class=main>∈</span><span class=bound>a1</span> <span class=main>∧</span> pair<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>r</span><span class=main>,</span><span class=bound>σr</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>σr</span><span class=main>∈</span><span class=bound>a4</span> <span class=main>∧</span> is_leq<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>r</span><span class=main>)</span> <span class=main>∧</span> is_forces_eq'<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>4</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
          And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>7</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>leq_fm<span class=main>(</span><span class=main>5</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>forces_eq_fm<span class=main>(</span><span class=main>4</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span> <span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span>"</span></span>  <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span> <span class=skolem>r</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span> pair_in_M_iff transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=free>τ</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?rel_pred</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>σ</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=skolem>q</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>unfolding</span></span> forces_eq_def <span class=keyword1><span class=command>using</span></span> assms that P_in_M leq_in_M leq_abs forces_eq'_abs pair_in_M_iff 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=free>τ</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?rel_pred</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>q</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> assms that sats_forces_eq'_fm sats_leq_fm P_in_M leq_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?φ</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span><span class=main>=</span><span class=main>5</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> leq_fm_def pair_fm_def upair_fm_def
    <span class=keyword1><span class=command>using</span></span> arity_forces_eq_fm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union Un_commute<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> forces_eq_def <span class=keyword1><span class=command>using</span></span> P_in_M leq_in_M assms 
        Collect_in_M_4p<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> 
            <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>q</span> <span class=bound>a1</span> <span class=bound>a2</span> <span class=bound>a3</span> <span class=bound>a4</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=bound>a1</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>σ</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq'<span class=main>(</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Lemma IV.2.40(a), membership *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240a_mem><span class=command>lemma</span></span> IV240a_mem<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>π</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟹</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>⟹</span> 
      val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span>"</span></span> <span class=comment1>(* inductive hypothesis *)</span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> elem_of_valI<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>σ</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> IV240a_mem_Collect <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=var>?D</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forces_mem_iff_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=var>?D</span>"</span></span> <span class=keyword1><span class=command>using</span></span> generic_inter_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>σ</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>σ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=free>π</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Example IV.2.36 (next two lemmas) *)</span>
<span class=keyword1 id=Forcing_Theorems-refl_forces_eq><span class=command>lemma</span></span> refl_forces_eq<span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> def_forces_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-forces_memI><span class=command>lemma</span></span> forces_memI<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>σ</span><span class=main>,</span><span class=free>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=free>p</span><span class=main>≼</span><span class=free>r</span> <span class=main>⟹</span> forces_mem<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> refl_forces_eq<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>σ</span></span><span class=main>]</span> leq_transD leq_reflI 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>forces_mem_iff_dense_below<span class=main><span class=main>[</span></span><span class=operator>THEN</span> iffD2<span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=comment1>(* Lemma IV.2.40(a), equality, first inclusion *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240a_eq_1st_incl><span class=command>lemma</span></span> IV240a_eq_1st_incl<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟹</span> 
        <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
        <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=comment1>(* Strong enough for this case: *)</span>
<span class=comment1>(*  IH:"⋀q σ. q∈P ⟹ σ∈domain(τ) ⟹ forces_mem(q,σ,θ) ⟹ 
      val(G,σ) ∈ val(G,θ)" *)</span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forces_memI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_forces_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>q</span></span> <span class=quoted><span class=skolem>σ</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span>›</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Lemma IV.2.40(a), equality, second inclusion--- COPY-PASTE *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240a_eq_2nd_incl><span class=command>lemma</span></span> IV240a_eq_2nd_incl<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟹</span> 
        <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
        <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>θ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> forces_memI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_forces_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>q</span></span> <span class=quoted><span class=skolem>σ</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>θ</span>›</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Lemma IV.2.40(a), equality, second inclusion--- COPY-PASTE *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240a_eq><span class=command>lemma</span></span> IV240a_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=bound>q</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟹</span> 
        <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
        <span class=main>(</span>forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> IV240a_eq_1st_incl<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> IV240a_eq_2nd_incl<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> IH <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Induction on names›</span></span>

<span class=keyword1 id=Forcing_Theorems-core_induction><span class=command>lemma</span></span> core_induction<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>ft</span> <span class=main>∈</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>ft</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ft</span> <span class=skolem>p</span> <span class=skolem>τ</span> <span class=skolem>θ</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span>eclose<span class=main>(</span><span class=main>{</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=var>?e</span><span class=main>)</span>"</span></span><span class=main>)</span> 
      <span class=keyword1><span class=command>using</span></span> Transset_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span> <span class=main>∈</span> <span class=var>?e</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span> <span class=main>∈</span> <span class=var>?e</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> arg_into_eclose <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ft</span> <span class=main>∈</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>ft</span><span class=main>,</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span> <span class=main>2</span><span class=main>×</span><span class=var>?e</span><span class=main>×</span><span class=var>?e</span><span class=main>×</span><span class=free>P</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?a</span><span class=main>∈</span><span class=main>2</span><span class=main>×</span><span class=var>?e</span><span class=main>×</span><span class=var>?e</span><span class=main>×</span><span class=free>P</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span>ftype<span class=main>(</span><span class=var>?a</span><span class=main>)</span><span class=main>,</span> name1<span class=main>(</span><span class=var>?a</span><span class=main>)</span><span class=main>,</span> name2<span class=main>(</span><span class=var>?a</span><span class=main>)</span><span class=main>,</span> cond_of<span class=main>(</span><span class=var>?a</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> core_induction_aux<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?e</span></span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>Q</span></span> <span class=var><span class=quoted><span class=var>?a</span></span></span><span class=main>,</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹Transset<span class=main>(</span><span class=var>?e</span><span class=main>)</span>›</span></span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=var>?a</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>clarify</span><span class=main>)</span> <span class=main>(</span><span class=operator>blast</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=skolem>ft</span><span class=main>,</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>components_simp<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-forces_induction_with_conds><span class=command>lemma</span></span> forces_induction_with_conds<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>ft</span> <span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=bound>ft</span> <span class=main>=</span> <span class=main>0</span> <span class=main>⟶</span> <span class=free>Q</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>ft</span> <span class=main>=</span> <span class=main>1</span> <span class=main>⟶</span> <span class=free>R</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=var>?Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=var>?Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>2<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span> <span class=bound>p</span><span class=main>.</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>q</span> <span class=bound>σ</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>;</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=var>?Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span> <span class=main>∧</span> <span class=var>?Q</span><span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>q</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=var>?Q</span><span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span><span class=main>(</span><span class=skolem>ft</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ft</span><span class=main>∈</span><span class=main>2</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ft</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> core_induction<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ that<span class=main><span class=main>,</span></span> <span class=operator>of</span> <span class=var><span class=quoted><span class=var><span class=quoted><span class=var><span class=quoted><span class=var>?Q</span></span></span></span></span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-forces_induction><span class=command>lemma</span></span> forces_induction<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span><span class=main>.</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>σ</span><span class=main>.</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>τ</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>τ</span> <span class=bound>θ</span><span class=main>.</span> <span class=main>⟦</span><span class=main>⋀</span><span class=bound>σ</span><span class=main>.</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=bound>σ</span><span class=main>,</span><span class=bound>τ</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=bound>σ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=bound>τ</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> forces_induction_with_conds<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ one_in_P <span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>τ</span> <span class=skolem>θ</span> <span class=skolem>p</span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>Q</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=skolem>σ</span>
  <span class=keyword1><span class=command>with</span></span> assms<span class=main>(</span>1<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> one_in_P <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>τ</span> <span class=skolem>θ</span> <span class=skolem>p</span> 
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=skolem>σ</span>
    <span class=keyword1><span class=command>with</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> one_in_P <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Lemma IV.2.40(a), in full›</span></span>
<span class=keyword1 id=Forcing_Theorems-IV240a><span class=command>lemma</span></span> IV240a<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>τ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟶</span> <span class=free>θ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> 
     <span class=main>(</span><span class=free>τ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟶</span> <span class=free>θ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span><span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> forces_induction<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=var><span class=quoted><span class=var><span class=quoted><span class=var>?Q</span></span></span></span></span> <span class=var><span class=quoted><span class=var><span class=quoted><span class=var>?R</span></span></span></span></span><span class=main><span class=main>]</span></span> impI<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>τ</span> <span class=skolem>θ</span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> forces_eq<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span>"</span></span> 
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=skolem>σ</span>
    <span class=keyword1><span class=command>using</span></span> that domain_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>θ</span></span><span class=main>]</span> transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> IV240a_mem domain_closed transitivity <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>τ</span> <span class=skolem>θ</span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=var>?R</span><span class=main>(</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> IH'<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>q</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟹</span>
            <span class=main>(</span>forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> 
            <span class=main>(</span>forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=skolem>σ</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>  transitivity<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ domain_closed<span class=main><span class=main><span class=main>[</span></span></span><span class=operator>simplified</span><span class=main><span class=main><span class=main>]</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> IV240a_eq<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> _ _ IH'<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Lemma IV.2.40(b)›</span></span>
<span class=comment1>(* Lemma IV.2.40(b), membership *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240b_mem><span class=command>lemma</span></span> IV240b_mem<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>π</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>σ</span><span class=main>.</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span> <span class=main>⟹</span> 
      <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span>"</span></span> <span class=comment1>(* inductive hypothesis *)</span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>π</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> IH
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=skolem>p'</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> M_generic_compatD strengthening_eq<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>p'</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> that strengthening_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=skolem>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span>
    <span class=keyword1><span class=command>using</span></span> that leq_transD<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=skolem>p</span></span> <span class=quoted><span class=skolem>r</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span> <span class=bound>r</span><span class=main>.</span> <span class=bound>r</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=main>⟨</span><span class=bound>s</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> <span class=main>∧</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>r</span> <span class=main>∧</span> forces_eq<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=bound>s</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=skolem>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=free>π</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> forces_mem_iff_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* includes *)</span>

<span class=keyword1 id=Forcing_Theorems-Collect_forces_eq_in_M><span class=command>lemma</span></span> Collect_forces_eq_in_M<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms Collect_in_M_4p<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"forces_eq_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>4</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>leq</span></span> <span class=quoted><span class=free>τ</span></span> <span class=quoted><span class=free>θ</span></span> 
                                  <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>A</span> <span class=bound>x</span> <span class=bound>p</span> <span class=bound>l</span> <span class=bound>t1</span> <span class=bound>t2</span><span class=main>.</span> is_forces_eq<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>t1</span><span class=main>,</span><span class=bound>t2</span><span class=main>)</span>"</span></span>
                                  <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=bound>p</span> <span class=bound>l</span> <span class=bound>t1</span> <span class=bound>t2</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>t1</span><span class=main>,</span><span class=bound>t2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>P</span></span><span class=main>]</span> 
        arity_forces_eq_fm P_in_M leq_in_M sats_forces_eq_fm forces_eq_abs forces_eq_fm_type 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_union_abs1 Un_commute<span class=main>)</span>

<span class=keyword1 id=Forcing_Theorems-IV240b_eq_Collects><span class=command>lemma</span></span> IV240b_eq_Collects<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
        <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_nmem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rel_pred</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>M</span> <span class=bound>x</span> <span class=bound>a1</span> <span class=bound>a2</span> <span class=bound>a3</span> <span class=bound>a4</span><span class=main>.</span> 
        <span class=main>∃</span><span class=bound>σ</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>u</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>da3</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> <span class=main>∃</span><span class=bound>da4</span><span class=main>[</span><span class=bound>M</span><span class=main>].</span> is_domain<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>da3</span><span class=main>)</span> <span class=main>∧</span> is_domain<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>a4</span><span class=main>,</span><span class=bound>da4</span><span class=main>)</span> <span class=main>∧</span> 
          union<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>da3</span><span class=main>,</span><span class=bound>da4</span><span class=main>,</span><span class=bound>u</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>σ</span><span class=main>∈</span><span class=bound>u</span> <span class=main>∧</span> is_forces_mem'<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>a3</span><span class=main>)</span> <span class=main>∧</span> 
          is_forces_nmem'<span class=main>(</span><span class=bound>M</span><span class=main>,</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>a4</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>domain_fm<span class=main>(</span><span class=main>7</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>domain_fm<span class=main>(</span><span class=main>8</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>
          And<span class=main>(</span>union_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>forces_mem_fm<span class=main>(</span><span class=main>5</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>7</span><span class=main>)</span><span class=main>,</span>
                              forces_nmem_fm<span class=main>(</span><span class=main>5</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=main>4</span><span class=main>,</span><span class=main>3</span><span class=main>,</span><span class=main>8</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>δ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>δ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span> <span class=skolem>δ</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that pair_in_M_iff transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=skolem>δ</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> abs1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?rel_pred</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟷</span> 
        <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_mem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span> 
        <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span>
    <span class=keyword1><span class=command>unfolding</span></span> forces_mem_def forces_nmem_def
    <span class=keyword1><span class=command>using</span></span> assms that forces_mem'_abs forces_nmem'_abs P_in_M leq_in_M 
      domain_closed Un_closed 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>τ</span></span><span class=main><span class=main>]</span></span> 1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>θ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> abs2<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?rel_pred</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>θ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> 
        forces_nmem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem'<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span>
    <span class=keyword1><span class=command>unfolding</span></span> forces_mem_def forces_nmem_def
    <span class=keyword1><span class=command>using</span></span> assms that forces_mem'_abs forces_nmem'_abs P_in_M leq_in_M 
      domain_closed Un_closed 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>τ</span></span><span class=main><span class=main>]</span></span> 1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>θ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> fsats1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?rel_pred</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span>
    <span class=keyword1><span class=command>using</span></span> that assms sats_forces_mem'_fm sats_forces_nmem'_fm P_in_M leq_in_M
      domain_closed Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> fsats2<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>θ</span><span class=main>,</span><span class=free>τ</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?rel_pred</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>θ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>p</span>
    <span class=keyword1><span class=command>using</span></span> that assms sats_forces_mem'_fm sats_forces_nmem'_fm P_in_M leq_in_M
      domain_closed Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> fty<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?φ</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> farit<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ</span><span class=main>)</span><span class=main>=</span><span class=main>5</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_fm_def domain_fm_def pair_fm_def upair_fm_def union_fm_def
    <span class=keyword1><span class=command>using</span></span> arity_forces_mem_fm <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union Un_commute<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_nmem<span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> forces_mem_def
    <span class=keyword1><span class=command>using</span></span> abs1 fty fsats1 farit P_in_M leq_in_M assms forces_nmem
          Collect_in_M_4p<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> 
          <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>p</span> <span class=bound>l</span> <span class=bound>a1</span> <span class=bound>a2</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>a1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>a2</span><span class=main>)</span><span class=main>.</span> forces_mem'<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>l</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>a1</span><span class=main>)</span> <span class=main>∧</span> 
                                                     forces_nmem'<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>l</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>a2</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>using</span></span> abs2 fty fsats2 farit P_in_M leq_in_M assms forces_nmem domain_closed Un_closed
          Collect_in_M_4p<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?φ</span></span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>leq</span></span> <span class=quoted><span class=free>θ</span></span> <span class=quoted><span class=free>τ</span></span> <span class=var><span class=quoted><span class=var>?rel_pred</span></span></span> 
          <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>p</span> <span class=bound>l</span> <span class=bound>a2</span> <span class=bound>a1</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=bound>a1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=bound>a2</span><span class=main>)</span><span class=main>.</span> forces_nmem'<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>l</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>a1</span><span class=main>)</span> <span class=main>∧</span> 
                                                     forces_mem'<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>l</span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=bound>a2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>P</span></span><span class=main>]</span>  
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Lemma IV.2.40(b), equality *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240b_eq><span class=command>lemma</span></span> IV240b_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>θ</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
    <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>σ</span><span class=main>.</span> <span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>∪</span>domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟹</span> 
      <span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> 
      <span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>σ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=comment1>(* inductive hypothesis *)</span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D3</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_nmem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=var>?D1</span> <span class=main>∪</span> <span class=var>?D2</span> <span class=main>∪</span> <span class=var>?D3</span>"</span></span>
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>using</span></span> domain_closed Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=var>?D3</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> IV240b_eq_Collects <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Collect_forces_eq_in_M Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=var>?D</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span>forces_eq<span class=main>(</span><span class=bound>d</span><span class=main>,</span> <span class=free>τ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span> <span class=main>∨</span>
            <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>d</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=bound>d</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span>
            <span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_nmem<span class=main>(</span><span class=bound>d</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=bound>d</span><span class=main>,</span> <span class=bound>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
           <span class=bound>d</span> <span class=main>≼</span> <span class=skolem>p</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=skolem>p</span><span class=main>,</span> <span class=free>τ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>∪</span>domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>p</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span>forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span> forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span>
         <span class=main>(</span><span class=main>¬</span> forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> def_forces_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=skolem>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span>forces_mem<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span>
         <span class=main>(</span>forces_nmem<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> not_forces_nmem strengthening_mem <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leq_transD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=var>?D1</span> <span class=main>∪</span> <span class=var>?D2</span> <span class=main>∪</span> <span class=var>?D3</span><span class=main>.</span> <span class=bound>d</span> <span class=main>≼</span> <span class=skolem>p</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=var>?D</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>consider</span></span> 
    <span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>"forces_eq<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=main>|</span> 
    <span class=main>(</span>2<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_nmem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=main>|</span> 
    <span class=main>(</span>3<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span><span class=main>.</span> forces_nmem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∧</span> forces_mem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=bound>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> 1
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> 2
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"forces_nmem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> IV240a<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span> <span class=quoted><span class=skolem>σ</span></span> <span class=quoted><span class=free>τ</span></span><span class=main>]</span> transitivity<span class=main>[</span><span class=operator>OF</span> _ domain_closed<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> IH <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=skolem>q</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>θ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> strengthening_mem <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>≼</span><span class=skolem>p</span>›</span></span> <span class=quoted><span class=quoted>‹forces_nmem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"False"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span> <span class=comment1>(* copy-paste from case 2 mutatis mutandis*)</span>
    <span class=keyword3><span class=command>case</span></span> 3
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"forces_nmem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> assms
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> IV240a<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span> <span class=quoted><span class=skolem>σ</span></span> <span class=quoted><span class=free>θ</span></span><span class=main>]</span> transitivity<span class=main>[</span><span class=operator>OF</span> _ domain_closed<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> IH <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=skolem>q</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces_mem<span class=main>(</span><span class=skolem>r</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=free>τ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> strengthening_mem <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>≼</span><span class=skolem>p</span>›</span></span> <span class=quoted><span class=quoted>‹forces_nmem<span class=main>(</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>σ</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"False"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> forces_nmem_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* Lemma IV.2.40(b), full *)</span>
<span class=keyword1 id=Forcing_Theorems-IV240b><span class=command>lemma</span></span> IV240b<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>⟶</span><span class=free>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>⟶</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_eq<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
     <span class=main>(</span><span class=free>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>⟶</span><span class=free>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>⟶</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>p</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span><span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>θ</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> forces_induction<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>τ</span> <span class=skolem>θ</span> <span class=skolem>p</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?R</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> IV240b_mem domain_closed transitivity <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>τ</span> <span class=skolem>θ</span> <span class=skolem>p</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span> <span class=var>?R</span><span class=main>(</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> IH'<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>⟹</span>
          <span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
          <span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> forces_mem<span class=main>(</span><span class=bound>q</span><span class=main>,</span> <span class=skolem>σ</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>σ</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>left_in_M<span class=main>)</span> 
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span><span class=main>(</span><span class=skolem>τ</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> IV240b_eq<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-map_val_in_MG><span class=command>lemma</span></span> map_val_in_MG<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> GenExt_def <span class=keyword1><span class=command>using</span></span> assms map_type2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-truth_lemma_mem><span class=command>lemma</span></span> truth_lemma_mem<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> Member<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>  <span class=main>⟷</span>  <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> Member<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms IV240a<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    IV240b<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    P_in_M leq_in_M one_in_M 
    Forces_Member<span class=main>[</span><span class=operator>of</span> <span class=main>_</span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>env</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>m</span></span><span class=main>]</span> map_val_in_MG
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forcing_Theorems-truth_lemma_eq><span class=command>lemma</span></span> truth_lemma_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> Equal<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>  <span class=main>⟷</span>  <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> Equal<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms IV240a<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    IV240b<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    P_in_M leq_in_M one_in_M 
    Forces_Equal<span class=main>[</span><span class=operator>of</span> <span class=main>_</span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>m</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>env</span></span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>m</span></span><span class=main>]</span> map_val_in_MG
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forcing_Theorems-arities_at_aux><span class=command>lemma</span></span> arities_at_aux<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∪</span> succ<span class=main>(</span><span class=free>m</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms succ_leE<span class=main>[</span><span class=operator>OF</span> Un_leD1<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>n</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>m</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span> 
   succ_leE<span class=main>[</span><span class=operator>OF</span> Un_leD2<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The Strenghtening Lemma›</span></span>

<span class=keyword1 id=Forcing_Theorems-strengthening_lemma><span class=command>lemma</span></span> strengthening_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span><span class=main>≼</span><span class=free>p</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=bound>env</span> <span class=main>⟹</span> <span class=free>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=bound>env</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Member <span class=skolem>n</span> <span class=skolem>m</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arities_at_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms Member
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_Member<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>env</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span>
      strengthening_mem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Equal <span class=skolem>n</span> <span class=skolem>m</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arities_at_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms Equal
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_Equal<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>env</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span>
      strengthening_eq<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=free>r</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Nand <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_Nand transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span> pair_in_M_iff 
      transitivity<span class=main>[</span><span class=operator>OF</span> _ leq_in_M<span class=main>]</span> leq_transD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Forall <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that Forces_Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> Forall 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that pred_le2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> assms Forall
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The Density Lemma›</span></span>
<span class=keyword1 id=Forcing_Theorems-arity_Nand_le><span class=command>lemma</span></span> arity_Nand_le<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>Nand<span class=main>(</span><span class=free>φ</span><span class=main>,</span> <span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>ψ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> Un_leD1<span class=main><span class=keyword3>,</span></span> <span class=operator>rule_tac</span> <span class=main><span class=improper>[</span></span>5<span class=main><span class=improper>]</span></span> Un_leD2<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword1 id=Forcing_Theorems-dense_below_imp_forces><span class=command>lemma</span></span> dense_below_imp_forces<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟹</span>
     dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=bound>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=bound>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Member <span class=skolem>n</span> <span class=skolem>m</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arities_at_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms Member
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_Member<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>env</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span>
      density_mem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Equal <span class=skolem>n</span> <span class=skolem>m</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>&lt;</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arities_at_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms Equal
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_Equal<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>env</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=skolem>m</span></span><span class=main>]</span>
      density_eq<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>p</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>n</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>m</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
<span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Nand <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>  
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>q</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span> <span class=free>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=skolem>env</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> 
    <span class=keyword1><span class=command>note</span></span> Nand
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>d</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>⊩</span> Nand<span class=main>(</span><span class=skolem>φ</span><span class=main>,</span> <span class=skolem>ψ</span><span class=main>)</span> <span class=skolem>env</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>≼</span> <span class=skolem>q</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> dense_belowI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=skolem>d</span><span class=main>⊩</span> <span class=skolem>ψ</span> <span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=skolem>env</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> that Forces_Nand leq_reflI transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=skolem>d</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> 
    <span class=keyword1><span class=command>note</span></span> arity_Nand_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>φ</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>ψ</span></span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=skolem>env</span>"</span></span> 
       <span class=keyword1><span class=command>using</span></span> strengthening_lemma<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>q</span></span> <span class=quoted><span class=skolem>φ</span></span> <span class=quoted><span class=skolem>d</span></span> <span class=quoted><span class=skolem>env</span></span><span class=main>]</span> Un_leD1 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>(</span><span class=skolem>q</span> <span class=main>⊩</span> <span class=skolem>ψ</span> <span class=skolem>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> strengthening_lemma<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>q</span></span> <span class=quoted><span class=skolem>ψ</span></span> <span class=quoted><span class=skolem>d</span></span> <span class=quoted><span class=skolem>env</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Forces_Nand<span class=main>[</span><span class=operator>symmetric</span><span class=main>,</span> <span class=operator>OF</span> _ Nand<span class=main><span class=main>(</span></span>5<span class=main><span class=main>,</span></span>1<span class=main><span class=main>,</span></span>3<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Forall <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>r</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹dense_below<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=skolem>env</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> Forall <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Forces_Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span><span class=main>}</span><span class=main>.</span> <span class=bound>d</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>d</span><span class=main>≼</span><span class=skolem>r</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> Forall<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> Forall<span class=main>(</span>1<span class=main>,</span>3-5<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>a</span>
    <span class=keyword1><span class=command>using</span></span> that pred_le2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> assms Forall
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Forces_Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-density_lemma><span class=command>lemma</span></span> density_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span>   <span class=main>⟷</span>   dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span>  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> dense_below_imp_forces <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> strengthening_lemma leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The Truth Lemma›</span></span>
<span class=keyword1 id=Forcing_Theorems-Forces_And><span class=command>lemma</span></span> Forces_And<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span> 
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>ψ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span>   <span class=main>⟷</span>  <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span> <span class=free>ψ</span><span class=main>)</span> <span class=free>env</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span> <span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Forces_And_iff_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span> <span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span> <span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> density_lemma<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span> <span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> dense_belowI bexI conjI<span class=main><span class=keyword3>,</span></span> <span class=operator>assumption</span><span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>q</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span> <span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=main>{</span><span class=bound>r</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span> <span class=skolem>q</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> strengthening_lemma leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Forces_And_iff_dense_below <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-Forces_Nand_alt><span class=command>lemma</span></span> Forces_Nand_alt<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span> 
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>ψ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Nand<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> Neg<span class=main>(</span>And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms Forces_Nand Forces_And Forces_Neg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Forcing_Theorems-truth_lemma_Neg><span class=command>lemma</span></span> truth_lemma_Neg<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>  <span class=main>⟷</span>  <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main><span class=keyword3>,</span></span> <span class=operator>elim</span> bexE<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> ccontr<span class=main>)</span> 
  <span class=comment1>(* Direct implication by contradiction *)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_val_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> IH
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> strengthening_lemma<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> φ<span class=main><span class=main>=</span></span><span class=quoted><span class=free>φ</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"False"</span></span>
    <span class=keyword1><span class=command>using</span></span> Forces_Neg<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> φ<span class=main><span class=main>=</span></span><span class=quoted><span class=free>φ</span></span><span class=main>]</span> transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_val_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> separation_ax arity_forces assms P_in_M leq_in_M one_in_M arity_forces_le
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> separation_ax arity_forces assms P_in_M leq_in_M one_in_M arity_forces_le
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> separation_disj <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> separation_closed P_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=var>?D</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>q</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=main>{</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>.</span> <span class=bound>d</span><span class=main>≼</span> <span class=skolem>q</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> assms
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Forces_Neg <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span>"</span></span> <span class=main>|</span> <span class=main>(</span>2<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Neg<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> 1
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>¬</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> IH
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> 2
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> 

<span class=keyword1 id=Forcing_Theorems-truth_lemma_And><span class=command>lemma</span></span> truth_lemma_And<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>ψ</span><span class=main>∈</span>formula"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>ψ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    IH<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span>  <span class=main>⟷</span>   <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span>  <span class=main>⟷</span>   <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>ψ</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms map_val_in_MG Forces_And<span class=main>[</span><span class=operator>OF</span> M_genericD assms<span class=main><span class=main>(</span></span>1-5<span class=main><span class=main>)</span></span><span class=main>]</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main><span class=keyword3>,</span></span> <span class=operator>elim</span> bexE<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Forces_And<span class=main>[</span><span class=operator>OF</span> M_genericD<span class=main>,</span> <span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=free>ψ</span></span><span class=main>]</span> map_val_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_val_in_MG Forces_And<span class=main>[</span><span class=operator>OF</span> M_genericD assms<span class=main><span class=main>(</span></span>1-5<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>≼</span><span class=skolem>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> <span class=free>ψ</span> <span class=free>env</span><span class=main>)</span>"</span></span> <span class=comment1>(* can't solve as separate goals *)</span>
    <span class=keyword1><span class=command>using</span></span> strengthening_lemma <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> And<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>ψ</span><span class=main>)</span> <span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Forces_And<span class=main>[</span><span class=operator>OF</span> M_genericD assms<span class=main><span class=main>(</span></span>1-5<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> 

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>ren_truth_lemma</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ren_truth_lemma</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> 
    Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>
    And<span class=main>(</span>Equal<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>8</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>9</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>10</span><span class=main>)</span><span class=main>,</span>And<span class=main>(</span>Equal<span class=main>(</span><span class=main>4</span><span class=main>,</span><span class=main>6</span><span class=main>)</span><span class=main>,</span>
    iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span> <span class=main>,</span> <span class=main>6</span><span class=main>,</span> <span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Theorems-ren_truth_lemma_type><span class=command>lemma</span></span> ren_truth_lemma_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> ren_truth_lemma<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span>formula"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> ren_truth_lemma_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Forcing_Theorems-arity_ren_truth><span class=command>lemma</span></span> arity_ren_truth <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>ren_truth_lemma<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>∪</span> succ<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>5</span> <span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ge<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>5</span> <span class=main>&lt;</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
    <span class=keyword3><span class=command>case</span></span> lt
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>5</span>"</span></span>  <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>5</span> <span class=main>≤</span> <span class=main>5</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
      <span class=keyword3><span class=command>case</span></span> a
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> lt
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span> <span class=main>&lt;</span> succ<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>2</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>3</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>4</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> succ_ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
       <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> 
      <span class=keyword1><span class=command>have</span></span> c<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span><span class=main>#+</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>"</span></span><span class=main>)</span> 
        <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma lt a
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>incr_bv<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span><span class=main>`</span><span class=main>5</span><span class=main>)</span> <span class=main>=</span> <span class=main>6</span><span class=main>#+</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?φ'</span></span></span> <span class=quoted><span class=main>5</span></span><span class=main>]</span> a <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> ren_truth_lemma_def
        <span class=keyword1><span class=command>using</span></span> pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> a c nat_union_abs2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> b
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> lt
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span> <span class=main>&lt;</span> succ<span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>2</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>3</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>4</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>&lt;</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>#+</span><span class=main>5</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> succ_ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>6</span><span class=main>#+</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>"</span></span><span class=main>)</span> 
        <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma lt 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>unfolding</span></span> ren_truth_lemma_def
        <span class=keyword1><span class=command>using</span></span> pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>  nat_union_abs2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ge
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>"</span></span> <span class=quoted><span class=quoted>"pred<span class=main>^</span><span class=main>5</span><span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> not_lt_iff_le le_trans<span class=main>[</span><span class=operator>OF</span> le_pred<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>iterates<span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> incr_bv<span class=main>(</span><span class=bound>p</span><span class=main>)</span><span class=main>`</span><span class=main>5</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>6</span>"</span></span> <span class=quoted><span class=quoted>"pred<span class=main>^</span><span class=main>5</span><span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_incr_bv_lemma ge le_trans<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>5</span>›</span></span><span class=main>]</span> le_trans<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹pred<span class=main>^</span><span class=main>5</span><span class=main>(</span>arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>≤</span><span class=main>5</span>›</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹pred<span class=main>^</span><span class=main>5</span><span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ren_truth_lemma_def
      <span class=keyword1><span class=command>using</span></span>  pred_Un_distrib nat_union_abs1 Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> nat_union_abs2 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Theorems-sats_ren_truth_lemma><span class=command>lemma</span></span> sats_ren_truth_lemma<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>d</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span> <span class=main>∈</span> formula <span class=main>⟹</span>
   <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>b</span><span class=main>,</span><span class=free>d</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> ren_truth_lemma<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>)</span> <span class=main>⟷</span>
   <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=free>q</span><span class=main>,</span><span class=free>a1</span><span class=main>,</span><span class=free>a2</span><span class=main>,</span><span class=free>a3</span><span class=main>,</span><span class=free>b</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ren_truth_lemma_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> sats_incr_bv_iff <span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free><span class=quoted><span class=free><span class=quoted><span class=free>M</span></span></span></span></span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted><span class=quoted><span class=quoted>"<span class=main><span class=main><span class=main>[</span></span></span><span class=free><span class=free><span class=free>q</span></span></span><span class=main><span class=main><span class=main>,</span></span></span><span class=free><span class=free><span class=free>a1</span></span></span><span class=main><span class=main><span class=main>,</span></span></span><span class=free><span class=free><span class=free>a2</span></span></span><span class=main><span class=main><span class=main>,</span></span></span><span class=free><span class=free><span class=free>a3</span></span></span><span class=main><span class=main><span class=main>,</span></span></span><span class=free><span class=free><span class=free>b</span></span></span><span class=main><span class=main><span class=main>]</span></span></span>"</span></span></span></span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>

<span class=keyword1 id="Forcing_Theorems-truth_lemma'"><span class=command>lemma</span></span> truth_lemma' <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>d</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>d</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=bound>b</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rel_pred</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>M</span> <span class=bound>x</span> <span class=bound>a1</span> <span class=bound>a2</span> <span class=bound>a3</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=bound>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=bound>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=bound>a1</span> <span class=main>∧</span> is_leq<span class=main>(</span><span class=main>##</span><span class=bound>M</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>q</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟶</span> 
                  <span class=main>¬</span><span class=main>(</span><span class=bound>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>q</span><span class=main>,</span><span class=bound>a1</span><span class=main>,</span><span class=bound>a2</span><span class=main>,</span><span class=bound>a3</span><span class=main>,</span><span class=bound>b</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ψ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>Forall<span class=main>(</span>Implies<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>3</span><span class=main>)</span><span class=main>,</span>leq_fm<span class=main>(</span><span class=main>4</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
          Neg<span class=main>(</span>ren_truth_lemma<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>q</span> <span class=keyword1><span class=command>using</span></span> that transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>∧</span> <span class=skolem>R</span><span class=main>(</span><span class=bound>q</span><span class=main>)</span> <span class=main>⟶</span> <span class=skolem>Q</span><span class=main>(</span><span class=bound>q</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>R</span><span class=main>(</span><span class=bound>q</span><span class=main>)</span> <span class=main>⟶</span> <span class=skolem>Q</span><span class=main>(</span><span class=bound>q</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>R</span> <span class=skolem>Q</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=skolem>b</span> <span class=main>∈</span> <span class=free>M</span><span class=main>;</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>≼</span> <span class=skolem>d</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>⟧</span> <span class=main>⟹</span>
         <span class=main>∃</span><span class=bound>c</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span> <span class=main>≼</span> <span class=skolem>d</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=bound>c</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>b</span> <span class=skolem>d</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> bexI<span class=main><span class=keyword3>,</span></span><span class=operator>simp_all</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?rel_pred</span><span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=skolem>d</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=bound>b</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>d</span>
    <span class=keyword1><span class=command>using</span></span> that leq_abs leq_in_M P_in_M one_in_M assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?ψ</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>d</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?rel_pred</span><span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=skolem>d</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>d</span>
    <span class=keyword1><span class=command>using</span></span> assms that P_in_M leq_in_M one_in_M sats_leq_fm sats_ren_truth_lemma
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>4</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> eq<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span>leq_fm<span class=main>(</span><span class=main>4</span><span class=main>,</span> <span class=main>0</span><span class=main>,</span> <span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_leq_fm succ_Un_distrib nat_simp_union
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span> <span class=main>∪</span> <span class=main>(</span>pred<span class=main>^</span><span class=main>2</span><span class=main>(</span>arity<span class=main>(</span>ren_truth_lemma<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nat_union_abs1 pred_Un_distrib <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>≤</span> <span class=main>3</span> <span class=main>∪</span> <span class=main>(</span>pred<span class=main>(</span>pred<span class=main>(</span><span class=main>6</span> <span class=main>∪</span> succ<span class=main>(</span>arity<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>≤</span> <span class=var>?r</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> Un_le_compat<span class=main>[</span><span class=operator>OF</span> le_refl<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=main>3</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> 
                  le_imp_subset arity_ren_truth<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span><span class=main>]</span>
                  pred_mono
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=var>?r</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> i<span class=main>:</span><span class=quoted><span class=quoted>"<span class=var>?r</span> <span class=main>≤</span> <span class=main>4</span> <span class=main>∪</span> pred<span class=main>(</span>arity<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> pred_Un_distrib pred_succ_eq <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> Un_assoc<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> nat_union_abs1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> h<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>4</span> <span class=main>∪</span> pred<span class=main>(</span>arity<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>4</span> <span class=main>∪</span> <span class=main>(</span><span class=main>4</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> add_commute <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
            Un_le_compat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>4</span></span> <span class=quoted><span class=main>4</span></span><span class=main>,</span><span class=operator>OF</span> _ pred_mono<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ arity_forces_le<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>_</span>›</span></span><span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span> <span class=main>]</span>
            <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span>  <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=var>?r</span>›</span></span>  le_trans<span class=main><span class=main>[</span></span><span class=operator>OF</span> i h<span class=main><span class=main>]</span></span><span class=main>]</span> nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms P_in_M leq_in_M one_in_M 
       separation_ax<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?ψ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span><span class=main>]</span> 
       separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>y</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span><span class=main>@</span><span class=free>env</span> <span class=main>⊨</span><span class=var>?ψ</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Forcing_Theorems-truth_lemma><span class=command>lemma</span></span> truth_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
     <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>env</span><span class=main>.</span> <span class=bound>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=bound>env</span><span class=main>)</span> <span class=main>⟹</span> 
      <span class=main>(</span><span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=bound>env</span><span class=main>)</span>   <span class=main>⟷</span>   <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=bound>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Member <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms truth_lemma_mem<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> 
      arities_at_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Equal <span class=skolem>x</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms truth_lemma_eq<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> 
      arities_at_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Nand <span class=skolem>φ</span> <span class=skolem>ψ</span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> truth_lemma_And truth_lemma_Neg Forces_Nand_alt 
      M_genericD map_val_in_MG arity_Nand_le<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>φ</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>ψ</span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Forall <span class=skolem>φ</span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main>)</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=skolem>env</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span>formula›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>x</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
      <span class=keyword1><span class=command>using</span></span> that Forces_Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span>Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>›</span></span>
      Forall<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span> <span class=main>⊨</span>  Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> pred_le2 map_val_in_MG
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>iff</span><span class=main><span class=main>:</span></span>GenExtD<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span> <span class=main>⊨</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>d</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>d</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=skolem>env</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?D2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>d</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>b</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=bound>d</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=bound>b</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>D</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>D</span> <span class=main>≡</span> <span class=var>?D1</span> <span class=main>∪</span> <span class=var>?D2</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> arφ<span class=main>:</span><span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>≤</span>succ<span class=main>(</span>length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> assms <span class=quoted><span class=quoted>‹arity<span class=main>(</span>Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> pred_le2 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=skolem>env</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> pred_le <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D1</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Collect_forces arφ <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?D2</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>φ</span><span class=main>∈</span>formula›</span></span>  truth_lemma' separation_closed arφ
                        P_in_M
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>D</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> D_def <span class=keyword1><span class=command>using</span></span> Un_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>D</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> D_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=skolem>D</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=skolem>D</span><span class=main>.</span> <span class=bound>d</span><span class=main>≼</span> <span class=skolem>p</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=skolem>env</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> 
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> D_def <span class=keyword1><span class=command>using</span></span> leq_reflI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>with</span></span> Forall <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Forces_Forall <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> Forall
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span><span class=main>@</span><span class=skolem>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=skolem>p</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> density_lemma pred_le2  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>d</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=skolem>d</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>ultimately</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> D_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>d</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>∈</span> <span class=skolem>D</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>d</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=var>?D1</span>"</span></span> <span class=main>|</span> <span class=main>(</span>2<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>d</span><span class=main>∈</span><span class=var>?D2</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> D_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span> <span class=main>⊩</span> Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span> <span class=skolem>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> 1
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>d</span><span class=main>∈</span><span class=free>G</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> 2
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=skolem>d</span> <span class=main>⟶</span><span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this<span class=main>(</span>1<span class=main>)</span> <span class=keyword2><span class=keyword>and</span></span>  <span class=quoted><span class=quoted>‹<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>_</span> <span class=main>⊨</span>  Forall<span class=main>(</span><span class=skolem>φ</span><span class=main>)</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> 
        Forall<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=skolem>b</span><span class=main>,</span><span class=skolem>env</span><span class=main>)</span>"</span></span><span class=main>]</span> Forall<span class=main>(</span>1<span class=main>,</span>3-4<span class=main>)</span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> pred_le2 <span class=keyword1><span class=command>using</span></span> map_val_in_MG <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>iff</span><span class=main><span class=main>:</span></span>GenExtD<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>d</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>ultimately</span></span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>d</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>p</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>p</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span>›</span></span> 
        Forall  <span class=quoted><span class=quoted>‹<span class=skolem>b</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> pred_le2 strengthening_lemma <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> 
      <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=main>∀</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=skolem>d</span> <span class=main>⟶</span><span class=main>¬</span><span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=skolem>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>b</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>env</span><span class=main>)</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>ultimately</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The ``Definition of forcing''›</span></span>
<span class=keyword1 id=Forcing_Theorems-definition_of_forcing><span class=command>lemma</span></span> definition_of_forcing<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
     <span class=main>(</span><span class=main>∀</span><span class=bound>G</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span> <span class=main>∧</span> <span class=free>p</span><span class=main>∈</span><span class=bound>G</span>  <span class=main>⟶</span>  <span class=keyword1>M[</span><span class=bound>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=bound>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI allI impI<span class=main><span class=keyword3>,</span></span> <span class=operator>elim</span> conjE<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>G</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> <span class=skolem>G</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=skolem>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=skolem>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> truth_lemma <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>G</span><span class=main>.</span><span class=main>(</span>M_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span><span class=main>∧</span> <span class=free>p</span><span class=main>∈</span><span class=bound>G</span><span class=main>)</span><span class=main>⟶</span> <span class=keyword1>M[</span><span class=bound>G</span><span class=main>]</span> <span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=bound>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>r</span> 
    <span class=keyword3><span class=command>assume</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>≼</span><span class=free>p</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>G</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=skolem>G</span>"</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> generic_filter_existence <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 2 <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=skolem>G</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword1><span class=command>using</span></span> filter_leqD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> 1
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=skolem>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=skolem>G</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>›</span></span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=skolem>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> truth_lemma <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span>  <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=skolem>G</span>›</span></span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=skolem>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>≼</span><span class=skolem>r</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=quoted><span class=quoted>‹<span class=skolem>s</span><span class=main>∈</span><span class=skolem>G</span>›</span></span> <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> M_generic_def filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> 
    <span class=keyword1><span class=command>note</span></span> assms
    <span class=keyword1><span class=command>ultimately</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span><span class=main>≼</span><span class=skolem>r</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> strengthening_lemma <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dense_below<span class=main>(</span><span class=main>{</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=bound>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span><span class=main>}</span><span class=main>,</span><span class=free>p</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> dense_below_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> density_lemma <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> definability <span class=main>=</span> forces_type 
<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Separation_Rename><div class=head><h1>Theory Separation_Rename</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Auxiliary renamings for Separation›</span></span>
<span class=keyword1><span class=command>theory</span></span> Separation_Rename
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Interface.html>Interface</a> <a href=Renaming.html>Renaming</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>lemmas</span></span> apply_fun <span class=main>=</span> apply_iff<span class=main>[</span><span class=operator>THEN</span> iffD1<span class=main>]</span>

<span class=keyword1 id=Separation_Rename-nth_concat><span class=command>lemma</span></span> nth_concat <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span><span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>]</span><span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>t</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_append<span class=main>)</span>

<span class=keyword1 id=Separation_Rename-nth_concat2><span class=command>lemma</span></span> nth_concat2 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> nth<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>t</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=free>p</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_append<span class=main>)</span>

<span class=keyword1 id=Separation_Rename-nth_concat3><span class=command>lemma</span></span> nth_concat3 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>u</span> <span class=main>=</span> nth<span class=main>(</span>succ<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span> <span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_append<span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>sep_var</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sep_var</span><span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=main>⟨</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>1</span><span class=main>,</span><span class=main>3</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>2</span><span class=main>,</span><span class=main>4</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>3</span><span class=main>,</span><span class=main>5</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>4</span><span class=main>,</span><span class=main>0</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>5</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=main>6</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=main>6</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=main>2</span><span class=main>⟩</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>sep_env</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sep_env</span><span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>λ</span> <span class=bound>i</span> <span class=main>∈</span> <span class=main>(</span><span class=main>5</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>-</span><span class=main>5</span> <span class=main>.</span> <span class=bound>i</span><span class=main>#+</span><span class=main>2</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>weak</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>weak</span><span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>m</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=bound>i</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>m</span></span></span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1 id=Separation_Rename-weakD><span class=command>lemma</span></span> weakD <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>k</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span> <span class=bound>i</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>.</span> <span class=free>x</span> <span class=main>=</span> <span class=bound>i</span><span class=main>#+</span><span class=free>k</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> weak_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Separation_Rename-weak_equal><span class=command>lemma</span></span> weak_equal <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span> <span class=main>-</span> <span class=free>m</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span><span class=main>⊆</span><span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=free>m</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>intro</span> subsetI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> assms 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>=</span><span class=skolem>i</span><span class=main>#+</span><span class=free>m</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> weakD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=skolem>i</span><span class=main>#+</span><span class=free>m</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>&lt;</span><span class=free>n</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> add_le_self2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=skolem>i</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> ltI<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>i</span><span class=main>#+</span><span class=free>m</span><span class=main>&lt;</span><span class=free>m</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> not_lt_iff_le in_n_in_nat<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>=</span><span class=skolem>i</span><span class=main>#+</span><span class=free>m</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=free>m</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ltI <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>=</span><span class=skolem>i</span><span class=main>#+</span><span class=free>m</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>&lt;</span><span class=free>n</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> add_lt_mono1<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>&lt;</span><span class=free>n</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=free>m</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ltD DiffI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=free>m</span><span class=main>⊆</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> subsetI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> 
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>(</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=free>m</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=free>m</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> DiffD1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>#+</span><span class=free>m</span>"</span></span> <span class=quoted><span class=free>m</span></span><span class=main>]</span> DiffD2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>#+</span><span class=free>m</span>"</span></span> <span class=quoted><span class=free>m</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>nat"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ltI in_n_in_nat<span class=main>[</span><span class=operator>OF</span> add_type<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>n</span></span><span class=main><span class=main>]</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>n</span> <span class=main>=</span> succ<span class=main>(</span><span class=skolem>x</span><span class=main>#+</span><span class=skolem>i</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> less_iff_succ_add<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span><span class=main>,</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>n</span>"</span></span><span class=main>]</span> add_type <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#+</span><span class=skolem>i</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> succ_le_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∉</span><span class=free>m</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> not_lt_iff_le <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>#-</span><span class=free>m</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> diff_mono<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> _ <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>#-</span><span class=free>m</span> <span class=main>=</span>  <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> diff_cancel2 <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>   
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>&lt;</span><span class=free>m</span><span class=main>#+</span><span class=free>n</span><span class=main>#-</span><span class=free>m</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#-</span><span class=free>m</span> <span class=main>∈</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>=</span><span class=skolem>x</span><span class=main>#-</span><span class=free>m</span><span class=main>#+</span><span class=free>m</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ltD add_diff_inverse2<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>m</span><span class=main>≤</span><span class=skolem>x</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>m</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> weak_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-weak_zero><span class=command>lemma</span></span> weak_zero<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=free>n</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> weak_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Separation_Rename-weakening_diff><span class=command>lemma</span></span> weakening_diff <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>7</span><span class=main>)</span> <span class=main>-</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>,</span> <span class=main>6</span><span class=main>#+</span><span class=free>n</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> weak_def <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>≠</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>w</span><span class=main>∈</span><span class=free>n</span><span class=main>.</span> succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> natify<span class=main>(</span><span class=bound>w</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>&lt;</span><span class=free>n</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ltI <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span><span class=free>n</span>›</span></span> <span class=quoted><span class=quoted>‹succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>≠</span><span class=free>n</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>≠</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> in_n_in_nat <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>&lt;</span><span class=free>n</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>≤</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> succ_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> leD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
      <span class=keyword3><span class=command>case</span></span> a
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> b
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>≤</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> succ_leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
      <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> leD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
        <span class=keyword3><span class=command>case</span></span> a
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>≠</span><span class=free>n</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> b
        <span class=keyword1><span class=command>then</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> natify<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=main>∀</span><span class=bound>w</span><span class=main>∈</span><span class=free>n</span><span class=main>.</span> succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> natify<span class=main>(</span><span class=bound>w</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"False"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>i</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat <span class=main>⟹</span> 
    succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=free>n</span> <span class=main>⟹</span> 
    <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>n</span><span class=main>.</span> succ<span class=main>(</span>succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> natify<span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
    <span class=skolem>y</span> <span class=main>∈</span> <span class=free>n</span> <span class=main>⟹</span> succ<span class=main>(</span>natify<span class=main>(</span><span class=skolem>y</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-in_add_del><span class=command>lemma</span></span> in_add_del <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>j</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>j</span> <span class=main>∨</span> <span class=free>x</span> <span class=main>∈</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>j</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>&lt;</span><span class=free>j</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span><span class=main>#+</span><span class=free>n</span><span class=main>∈</span>nat"</span></span>
    <span class=keyword1><span class=command>using</span></span> in_n_in_nat<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>j</span><span class=main>#+</span><span class=free>n</span>›</span></span><span class=main>]</span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>≤</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>j</span><span class=main>#+</span><span class=free>n</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> not_lt_iff_le False <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> ltI<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>j</span><span class=main>#+</span><span class=free>n</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>#-</span><span class=free>j</span> <span class=main>&lt;</span> <span class=main>(</span><span class=free>j</span> <span class=main>#+</span> <span class=free>n</span><span class=main>)</span> <span class=main>#-</span> <span class=free>j</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=free>j</span> <span class=main>#+</span> <span class=main>(</span><span class=free>x</span> <span class=main>#-</span><span class=free>j</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> diff_mono <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>#+</span><span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> 
      add_diff_inverse<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>j</span><span class=main>≤</span><span class=free>x</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>#-</span><span class=free>j</span> <span class=main>&lt;</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=main>(</span><span class=free>x</span> <span class=main>#-</span><span class=free>j</span> <span class=main>)</span> <span class=main>#+</span> <span class=free>j</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> diff_add_inverse <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> add_commute <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>#-</span><span class=free>j</span> <span class=main>∈</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=free>j</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> weak_def
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>=</span> <span class=main>(</span><span class=free>x</span><span class=main>#-</span><span class=free>j</span><span class=main>)</span> <span class=main>#+</span><span class=free>j</span>›</span></span> RepFunI<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>#-</span><span class=free>j</span><span class=main>∈</span><span class=free>n</span>›</span></span><span class=main>]</span> add_commute <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>  <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Separation_Rename-sep_env_action><span class=command>lemma</span></span> sep_env_action<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> weak<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>⟶</span> 
      nth<span class=main>(</span>sep_env<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>o</span><span class=main>,</span> <span class=free>t</span><span class=main>]</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"sep_env<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> EQ<span class=main>:</span> <span class=quoted><span class=quoted>"weak<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>=</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>-</span> <span class=main>5</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> weak_equal length_type<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?tgt</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?src</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=var>?f</span><span class=main>`</span><span class=skolem>i</span><span class=main>,</span><span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span> 
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> <span class=main>(</span><span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>-</span><span class=main>5</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> that 
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∉</span> <span class=main>5</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>#-</span><span class=main>5</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>#+</span><span class=main>2</span><span class=main>∈</span>nat"</span></span>
      <span class=keyword1><span class=command>using</span></span> in_n_in_nat<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>i</span> <span class=main>&lt;</span> <span class=main>5</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span> <span class=main>≤</span> <span class=skolem>i</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>2</span> <span class=main>≤</span> <span class=main>5</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span>  not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>2</span> <span class=main>≤</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>2</span><span class=main>≤</span><span class=main>5</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> A <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>∈</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=main>2</span><span class=main>≤</span><span class=skolem>i</span>›</span></span> A
    <span class=keyword1><span class=command>have</span></span> C<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>#+</span><span class=main>2</span> <span class=main>&lt;</span> <span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> that 
    <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?f</span><span class=main>`</span><span class=skolem>i</span> <span class=main>=</span> <span class=skolem>i</span><span class=main>#+</span><span class=main>2</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> sep_env_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> 3 assms<span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>i</span><span class=main>#+</span><span class=main>2</span> <span class=main>&lt;</span> <span class=main>7</span>"</span></span> <span class=keyword1><span class=command>using</span></span> not_lt_iff_le add_le_mono <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> 3 <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>#-</span><span class=main>5</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>#-</span> <span class=main>5</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> diff_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>i</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=main>5</span></span><span class=main>,</span><span class=operator>OF</span> _ _ _ <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span><span class=main>]</span> 
        not_lt_iff_le<span class=main>[</span><span class=operator>THEN</span> iffD1<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>with</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>#-</span><span class=main>5</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> diff_add_inverse length_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=var>?src</span><span class=main>)</span> <span class=main>=</span>nth<span class=main>(</span><span class=skolem>i</span><span class=main>#-</span><span class=main>5</span><span class=main>,</span><span class=free>env</span><span class=main>@</span><span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nth_append<span class=main>[</span><span class=operator>OF</span> A<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> 3 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>i</span><span class=main>#-</span><span class=main>5</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> nth_append<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>#-</span><span class=main>5</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>#-</span><span class=main>5</span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> nth<span class=main>(</span><span class=skolem>i</span><span class=main>#+</span><span class=main>2</span><span class=main>,</span> <span class=var>?tgt</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> nth_append<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>#+</span><span class=main>2</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=main>¬</span> <span class=skolem>i</span><span class=main>#+</span><span class=main>2</span> <span class=main>&lt;</span><span class=main>7</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span><span class=var>?src</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=var>?f</span><span class=main>`</span><span class=skolem>i</span><span class=main>,</span><span class=var>?tgt</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> B <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> EQ <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-sep_env_type><span class=command>lemma</span></span> sep_env_type <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sep_env<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>:</span> <span class=main>(</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=main>5</span> <span class=main>→</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=main>7</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?h</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"sep_env<span class=main>(</span><span class=free>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>#+</span><span class=main>2</span> <span class=main>=</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>have</span></span>
    D<span class=main>:</span> <span class=quoted><span class=quoted>"sep_env<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>`</span><span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=main>7</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span><span class=main>5</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>-</span><span class=main>5</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=skolem>x</span><span class=main>#+</span><span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>nat"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> sep_env_def <span class=keyword1><span class=command>using</span></span> ltI in_n_in_nat<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#+</span><span class=main>2</span> <span class=main>&lt;</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#+</span><span class=main>2</span> <span class=main>∈</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>-</span><span class=main>5</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=main>5</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>x</span><span class=main>&lt;</span><span class=main>5</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>≤</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>≤</span><span class=skolem>x</span><span class=main>#+</span><span class=main>2</span>"</span></span> <span class=keyword1><span class=command>using</span></span> add_le_mono <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>x</span><span class=main>#+</span><span class=main>2</span><span class=main>&lt;</span><span class=main>7</span>"</span></span> <span class=keyword1><span class=command>using</span></span> not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>#+</span><span class=main>2</span> <span class=main>∉</span> <span class=main>7</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltI <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>#+</span><span class=main>2</span> <span class=main>∈</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>›</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=var>?h</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=skolem>x</span><span class=main>#+</span><span class=main>2</span>›</span></span> DiffI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sep_env_def <span class=keyword1><span class=command>using</span></span> lam_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-sep_var_fin_type><span class=command>lemma</span></span> sep_var_fin_type <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>:</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>  <span class=main>-||&gt;</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> sep_var_def 
  <span class=keyword1><span class=command>using</span></span> consI ltD emptyI <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1 id=Separation_Rename-sep_var_domain><span class=command>lemma</span></span> sep_var_domain <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>  <span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>-</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span> 
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> sep_var_def 
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> le_natE<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>=</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span> <span class=main>∨</span> <span class=skolem>x</span><span class=main>=</span><span class=main>6</span><span class=main>#+</span><span class=free>n</span> <span class=main>∨</span> <span class=skolem>x</span> <span class=main>≤</span> <span class=main>4</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>unfolding</span></span> sep_var_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> D <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=free>n</span><span class=main>#+</span><span class=main>7</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>5</span><span class=main>#+</span><span class=free>n</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>  lt_irrefl<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted>False</span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>6</span><span class=main>#+</span><span class=free>n</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>have</span></span> R<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=var>?A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> that
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>&lt;</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>=</span><span class=main>5</span><span class=main>#+</span><span class=skolem>i</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> weak_def
      <span class=keyword1><span class=command>using</span></span> ltI <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> RepFun_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>#+</span><span class=skolem>i</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> add_lt_mono2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>=</span><span class=main>5</span><span class=main>#+</span><span class=skolem>i</span>›</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>x</span> <span class=main>&lt;</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>#+</span><span class=free>n</span> <span class=main>∉</span> <span class=var>?A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>6</span><span class=main>#+</span><span class=free>n</span><span class=main>∉</span><span class=var>?A</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>5</span><span class=main>#+</span><span class=free>n</span> <span class=main>∉</span> <span class=var>?A</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=quoted><span class=quoted>‹<span class=main>¬</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span><span class=main>&lt;</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>    
    <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>6</span><span class=main>#+</span><span class=free>n</span> <span class=main>∉</span> <span class=var>?A</span>"</span></span> <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=main>¬</span><span class=main>6</span><span class=main>#+</span><span class=free>n</span><span class=main>&lt;</span><span class=main>5</span><span class=main>#+</span><span class=free>n</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> E<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> 
    <span class=keyword1><span class=command>unfolding</span></span> weak_def
    <span class=keyword1><span class=command>using</span></span> C that <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> F<span class=main>:</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>-</span> <span class=var>?A</span>"</span></span> <span class=keyword1><span class=command>using</span></span> A <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=main>7</span> <span class=main>∨</span> <span class=skolem>x</span><span class=main>∈</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>7</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> in_add_del<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> asm<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>7</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>7</span><span class=main>)</span><span class=main>-</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>⊆</span><span class=main>{</span><span class=free>n</span><span class=main>#+</span><span class=main>5</span><span class=main>,</span><span class=free>n</span><span class=main>#+</span><span class=main>6</span><span class=main>}</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> weakening_diff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>›</span></span> asm
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>{</span><span class=free>n</span><span class=main>#+</span><span class=main>5</span><span class=main>,</span><span class=free>n</span><span class=main>#+</span><span class=main>6</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>using</span></span>  subsetD DiffI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sep_var_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> asm<span class=main>:</span><span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=main>7</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>2</span> <span class=main>≤</span> <span class=free>n</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>&lt;</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span>  leD<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=quoted><span class=quoted>‹<span class=main>2</span><span class=main>≤</span><span class=free>n</span>›</span></span><span class=main>]</span> lt_imp_0_lt <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>ultimately</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>&lt;</span><span class=main>5</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>&lt;</span><span class=main>7</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> in_n_in_nat
        <span class=keyword1><span class=command>unfolding</span></span> weak_def
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>not_lt_iff_le<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lt_def<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> sep_var_def 
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>not_lt_iff_le<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lt_def<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False 
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>=</span><span class=main>0</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>unfolding</span></span> sep_var_def <span class=keyword1><span class=command>using</span></span> ltD asm <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>&lt;</span> <span class=main>2</span>"</span></span> <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=main>¬</span> <span class=main>2</span> <span class=main>≤</span> <span class=free>n</span>›</span></span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
        <span class=keyword1><span class=command>then</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=free>n</span> <span class=main>&lt;</span><span class=main>1</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>≠</span><span class=main>0</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>=</span><span class=main>1</span>"</span></span> <span class=keyword1><span class=command>using</span></span> not_lt_iff_le <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>&lt;</span><span class=main>2</span>›</span></span> le_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∉</span><span class=var>?A</span>›</span></span> 
          <span class=keyword1><span class=command>unfolding</span></span> weak_def sep_var_def 
          <span class=keyword1><span class=command>using</span></span> ltD asm <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span><span class=main>∈</span>domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span><span class=main>∈</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>-</span> <span class=var>?A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>w</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>-</span> <span class=var>?A</span> <span class=main>⊆</span> domain<span class=main>(</span>sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> F 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-sep_var_type><span class=command>lemma</span></span> sep_var_type <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span> <span class=main>∈</span> nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sep_var<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>:</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>)</span><span class=main>-</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>→</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> FiniteFun_is_fun<span class=main>[</span><span class=operator>OF</span> sep_var_fin_type<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
    sep_var_domain<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Separation_Rename-sep_var_action><span class=command>lemma</span></span> sep_var_action <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>∈</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> weak<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>⟶</span> 
    nth<span class=main>(</span>sep_var<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>subst</span> sep_var_domain<span class=main><span class=main>[</span></span><span class=operator>OF</span> length_type<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main><span class=main>]</span></span><span class=main><span class=main>,</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span> <span class=skolem>y</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>i</span><span class=main>,</span> <span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> sep_var<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span>sep_var<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>i</span><span class=main>,</span>
               Cons<span class=main>(</span><span class=free>t</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>p</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>u</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>P</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>leq</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>o</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>pi</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
           nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>p</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>P</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>leq</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>o</span><span class=main>,</span> Cons<span class=main>(</span><span class=free>t</span><span class=main>,</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span> <span class=free>u</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>  
    <span class=keyword1><span class=command>using</span></span> apply_fun<span class=main>[</span><span class=operator>OF</span> sep_var_type<span class=main>]</span> assms
      <span class=keyword1><span class=command>unfolding</span></span> sep_var_def
      <span class=keyword1><span class=command>using</span></span> nth_concat2<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span>  nth_concat3<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>,</span><span class=operator>symmetric</span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>rensep</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rensep</span><span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>≡</span> union_fun<span class=main>(</span>sep_var<span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>,</span>sep_env<span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>,</span><span class=main>7</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>-</span>weak<span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>,</span>weak<span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Separation_Rename-rensep_aux><span class=command>lemma</span></span> rensep_aux <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>-</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>=</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>∪</span> <span class=main>(</span> <span class=main>7</span> <span class=main>#+</span> <span class=free>n</span> <span class=main>-</span> <span class=main>7</span><span class=main>)</span> <span class=main>=</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span><span class=main>#+</span><span class=main>5</span><span class=main>-</span><span class=main>5</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> weak_equal <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span>  <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>-</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>=</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>∪</span> <span class=main>(</span> <span class=main>7</span> <span class=main>#+</span> <span class=free>n</span> <span class=main>-</span> <span class=main>7</span><span class=main>)</span> <span class=main>=</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Diff_partition le_imp_subset <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-rensep_type><span class=command>lemma</span></span> rensep_type <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"rensep<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>→</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rensep<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>∈</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span><span class=main>-</span>weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=free>n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span> <span class=main>→</span> <span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>∪</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free>n</span> <span class=main>-</span> <span class=main>7</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> rensep_def 
    <span class=keyword1><span class=command>using</span></span> union_fun_type  sep_var_type <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> sep_env_type weak_equal
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> rensep_aux <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span>nat›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Separation_Rename-rensep_action><span class=command>lemma</span></span> rensep_action <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>i</span> <span class=main>.</span> <span class=bound>i</span> <span class=main>&lt;</span> <span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟶</span> nth<span class=main>(</span>rensep<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=bound>i</span><span class=main>,</span><span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span><span class=bound>i</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span> 
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?tgt</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?src</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?m</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>-</span> weak<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"weak<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"sep_var<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"sep_env<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> 1 <span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>" <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=var>?src</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?tgt</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>  
    <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>#+</span><span class=var>?n</span> <span class=main>=</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=var>?n</span><span class=main>-</span>weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>" length<span class=main>(</span><span class=var>?src</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=var>?n</span><span class=main>-</span>weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Diff_partition le_imp_subset rensep_aux <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=skolem>i</span><span class=main>,</span> <span class=var>?src</span><span class=main>)</span> <span class=main>=</span> nth<span class=main>(</span>union_fun<span class=main>(</span><span class=var>?f</span><span class=main>,</span> <span class=var>?g</span><span class=main>,</span> <span class=var>?m</span><span class=main>,</span> <span class=var>?p</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>i</span><span class=main>,</span> <span class=var>?tgt</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> <span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>i</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span><span class=main>&lt;</span><span class=main>7</span><span class=main>#+</span><span class=var>?n</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=var>?n</span><span class=main>-</span>weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> rensep_def <span class=keyword1><span class=command>using</span></span>  
        union_fun_action<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?src</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?tgt</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=var>?src</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=var>?n</span><span class=main>-</span>weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> weak<span class=main>(</span><span class=var>?n</span><span class=main>,</span><span class=main>5</span><span class=main>)</span>›</span></span>
          sep_var_action<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main><span class=main>]</span></span>      
          sep_env_action<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main><span class=main>]</span></span>
          <span class=main>]</span> that 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> rensep_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>sep_ren</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sep_ren</span><span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span> <span class=main>≡</span> ren<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>7</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>`</span>rensep<span class=main>(</span><span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Separation_Rename-arity_rensep><span class=command>lemma</span></span> arity_rensep<span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>sep_ren<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> sep_ren_def
  <span class=keyword1><span class=command>using</span></span> arity_ren rensep_type assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Separation_Rename-type_rensep><span class=command>lemma</span></span> type_rensep <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sep_ren<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> sep_ren_def
  <span class=keyword1><span class=command>using</span></span> ren_tc rensep_type assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Separation_Rename-sepren_action><span class=command>lemma</span></span> sepren_action<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> sep_ren<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>t</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>pi</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>" <span class=main>[</span><span class=free>t</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>u</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>o</span><span class=main>,</span> <span class=free>pi</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>    
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>t</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>pi</span><span class=main>,</span><span class=free>u</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> app_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> sep_ren_def
    <span class=keyword1><span class=command>using</span></span> sats_iff_sats_ren<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span>       
        add_type<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=main>7</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span>
        add_type<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=main>7</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main><span class=main>]</span></span>
        2 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> 
        rensep_type<span class=main><span class=main>[</span></span><span class=operator>OF</span> length_type<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span> 
        <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span><span class=main>]</span>
      rensep_action<span class=main>[</span><span class=operator>OF</span> 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>,</span><span class=operator>rule_format</span><span class=main>,</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Separation_Axiom><div class=head><h1>Theory Separation_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Separation in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Separation_Axiom
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Forcing_Theorems.html>Forcing_Theorems</a> <a href=Separation_Rename.html>Separation_Rename</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> G_generic
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Separation_Axiom-map_val><span class=command>lemma</span></span> map_val <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span><span class=main>.</span> <span class=free>env</span> <span class=main>=</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=bound>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>env</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span>Nil<span class=main>)</span> <span class=main>=</span> Nil"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a'</span></span> <span class=skolem><span class=skolem>l'</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>l'</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l</span><span class=main>=</span>map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>l'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>a'</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>l</span><span class=main>)</span> <span class=main>=</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span>Cons<span class=main>(</span><span class=skolem>a'</span><span class=main>,</span><span class=skolem>l'</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Cons<span class=main>(</span><span class=skolem>a'</span><span class=main>,</span><span class=skolem>l'</span><span class=main>)</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> GenExtD
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Separation_Axiom-Collect_sats_in_MG><span class=command>lemma</span></span> Collect_sats_in_MG <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>    
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span><span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>  
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>π</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>π</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?χ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=var><span class=quoted><span class=var>?Pl1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?new_form</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"sep_ren<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ψ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=var>?new_form</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>note</span></span> phi <span class=main>=</span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> 
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?χ</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> phi
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span> "</span></span> 
    <span class=keyword1><span class=command>using</span></span> nat_simp_union leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=main>_</span><span class=main>)</span>›</span></span> phi
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  arity_forces_le <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nat_simp_union arity_forces leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span><span class=main>7</span> <span class=main>#+</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span> <span class=main>∈</span> formula›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?new_form</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?new_form</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword1><span class=command>using</span></span> arity_rensep<span class=main>[</span><span class=operator>OF</span> definability<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?χ</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>  definability<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?χ</span>"</span></span><span class=main>]</span> type_rensep 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"pred<span class=main>(</span>pred<span class=main>(</span>arity<span class=main>(</span><span class=var>?new_form</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?ψ</span><span class=main>∈</span>formula"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> pair_fm_def upair_fm_def 
    <span class=keyword1><span class=command>using</span></span> nat_simp_union length_type<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>›</span></span><span class=main>]</span> 
        pred_mono<span class=main>[</span><span class=operator>OF</span> _ pred_mono<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?new_form</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?new_form</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?new_form</span> <span class=main>∈</span> formula›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> pair_fm_def upair_fm_def 
    <span class=keyword1><span class=command>using</span></span> nat_simp_union arity_forces
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
    <span class=keyword1><span class=command>using</span></span> definability <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> P_in_M 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span>setclass_iff<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>nenv</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>=</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_val <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span><span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> le_trans<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>_</span>›</span></span><span class=main>]</span> add_le_mono<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>1</span></span> <span class=quoted><span class=main>2</span></span><span class=main>,</span><span class=operator>OF</span> _ le_refl<span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>θ</span> 
    <span class=keyword1><span class=command>using</span></span> nat_union_abs2<span class=main>[</span><span class=operator>OF</span> _ _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span><span class=main>#+</span> <span class=main>_</span>›</span></span><span class=main>]</span> nat_simp_union 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>    
  <span class=keyword1><span class=command>note</span></span> in_M <span class=main>=</span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>›</span></span>  P_in_M one_in_M leq_in_M
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>u</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> in_M <span class=quoted><span class=quoted>‹<span class=var>?new_form</span> <span class=main>∈</span> formula›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?ψ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> Eq1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>)</span> <span class=main>⟷</span> 
                        <span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>u</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> 
                          <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>,</span><span class=skolem>u</span><span class=main>]</span><span class=main>@</span><span class=var>?Pl1</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?new_form</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> transitivity<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> Eq3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=skolem>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span>
       <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>u</span><span class=main>]</span><span class=main>@</span><span class=var>?Pl1</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>@</span><span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?new_form</span><span class=main>)</span> <span class=main>⟷</span>
          <span class=main>(</span><span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> <span class=main>(</span><span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>θ</span> <span class=skolem>p</span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span> <span class=skolem>θ</span> 
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> P_in_M <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> transitivity<span class=main>)</span>
      <span class=keyword1><span class=command>note</span></span> in_M' <span class=main>=</span> in_M <span class=quoted><span class=quoted>‹<span class=skolem>θ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>u</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>u</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?env</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>p</span><span class=main>]</span><span class=main>@</span><span class=var>?Pl1</span><span class=main>@</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>,</span><span class=skolem>u</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?new_env</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>" <span class=main>[</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>u</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span>"</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ψ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=var>?new_form</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>θ</span><span class=main>,</span> <span class=skolem>p</span><span class=main>,</span> <span class=skolem>u</span><span class=main>,</span> <span class=skolem>π</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>,</span> <span class=skolem>π</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> in_M' <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?χ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>∈</span> formula"</span></span>  
        <span class=keyword1><span class=command>using</span></span> phi <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
      <span class=keyword1><span class=command>from</span></span> in_M' 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Pl1</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>from</span></span> in_M' <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>have</span></span> Eq1'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?new_env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> in_M'  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>u</span><span class=main>]</span><span class=main>@</span><span class=var>?Pl1</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?new_form</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?new_env</span> <span class=main>⊨</span> <span class=var>?new_form</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>from</span></span> in_M' <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> Eq1' <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> 
        <span class=quoted><span class=quoted>‹arity<span class=main>(</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>∈</span> formula›</span></span>
        <span class=quoted><span class=quoted>‹<span class=main>[</span><span class=skolem>θ</span><span class=main>,</span> <span class=skolem>p</span><span class=main>,</span> <span class=skolem>u</span><span class=main>,</span> <span class=skolem>π</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>,</span> <span class=skolem>π</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span> <span class=free>M</span><span class=main>,</span> <span class=var>?env</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> sepren_action<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>nenv</span>"</span></span><span class=main>,</span><span class=operator>OF</span> _ _ <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span><span class=main>]</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> in_M'
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span> <span class=free>M</span><span class=main>,</span>  <span class=main>(</span><span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span><span class=main>@</span><span class=skolem>nenv</span><span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span><span class=main>@</span><span class=main>[</span><span class=skolem>u</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> app_assoc <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>also</span></span> 
      <span class=keyword1><span class=command>from</span></span> in_M' <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> phi <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span>
        <span class=quoted><span class=quoted>‹arity<span class=main>(</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>∈</span>formula›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span> <span class=free>M</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span><span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span>        
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> arity_sats_iff<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span><span class=main>)</span>
      <span class=keyword1><span class=command>also</span></span> 
      <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span>forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>∈</span>formula›</span></span> in_M' phi 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> 
                           <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span>  definition_of_forcing 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> iffI<span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> a1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span>  forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>note</span></span> definition_of_forcing <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span> <span class=main>1</span><span class=main>#+</span><span class=main>_</span>›</span></span>
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟹</span> <span class=var>?χ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>π</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
                  <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span><span class=main>@</span> <span class=skolem>nenv</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>⟹</span> 
              <span class=main>∀</span><span class=bound>G</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>G</span> <span class=main>⟶</span> <span class=keyword1>M[</span><span class=bound>G</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>G</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> 
                  <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=var>?χ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> a1 <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> 
                   <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span>"</span></span>
        <span class=keyword1><span class=command>with</span></span> definition_of_forcing <span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>]</span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span>›</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>p</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span>  forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=var>?χ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> in_M' 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>finally</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>u</span><span class=main>]</span><span class=main>@</span><span class=var>?Pl1</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>@</span><span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?new_form</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> 
                           <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>with</span></span> Eq1 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>)</span> <span class=main>⟷</span> 
         <span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>u</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> 
          <span class=main>(</span><span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>  map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=bound>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> Equivalence<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>u</span><span class=main>∈</span> domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span> <span class=main>⟹</span> <span class=skolem>u</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> 
       <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>)</span> <span class=main>⟷</span> 
         <span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>u</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> 
          <span class=main>(</span><span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>   map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=bound>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>u</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>=</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> map_nenv<span class=main>:</span><span class=quoted><span class=quoted>"map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span> <span class=skolem>nenv</span><span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_app_distrib append1_eq_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> aux<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>u</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟶</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?χ</span><span class=main>)</span><span class=main>)</span>"</span></span> 
   <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>_</span> <span class=main>(</span> <span class=main>_</span> <span class=main>⟶</span> <span class=main>_</span><span class=main>,</span> <span class=var>?vals</span><span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⊨</span> <span class=main>_</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
   <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>u</span><span class=main>]</span><span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>u</span>
    <span class=keyword1><span class=command>using</span></span> Equivalence<span class=main>[</span><span class=operator>THEN</span> iffD1<span class=main>,</span> <span class=operator>OF</span> that<span class=main>]</span> generic <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>θ</span>
    <span class=keyword1><span class=command>using</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π</span><span class=main>)</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>θ</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span><span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>u</span><span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>∈</span>nth<span class=main>(</span><span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=var>?vals</span><span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>u</span>
    <span class=keyword1><span class=command>using</span></span> aux<span class=main>[</span><span class=operator>OF</span> that<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> nth<span class=main>:</span><span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>,</span><span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span>"</span></span> 
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>θ</span>
    <span class=keyword1><span class=command>using</span></span> nth_concat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>using</span></span> that GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>u</span><span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>p</span><span class=main>∈</span><span class=free>G</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span> <span class=main>∧</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=var>?vals</span><span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>u</span>
    <span class=keyword1><span class=command>using</span></span> that <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>×</span><span class=free>P</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>u</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>u</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span>
        <span class=main>(</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π</span><span class=main>)</span> <span class=main>∧</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=var>?vals</span><span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>transitivity<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>u</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>.</span> <span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=bound>u</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>)</span> <span class=main>}</span> <span class=main>⊆</span>
     <span class=main>{</span><span class=bound>u</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>.</span> <span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>u</span> <span class=main>=</span><span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> 
       <span class=main>(</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=var>?vals</span><span class=main>(</span><span class=bound>θ</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?n</span><span class=main>⊆</span><span class=var>?m</span>"</span></span><span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> val_mono 
  <span class=keyword1><span class=command>have</span></span> first_incl<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?m</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>note</span></span>  <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span> <span class=comment1>(* from the assumptions *)</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?ψ</span><span class=main>∈</span>formula›</span></span>  <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> in_M <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?n</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> separation_ax leI separation_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>from</span></span> generic 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> M_generic_def filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?m</span><span class=main>)</span> <span class=main>=</span>
               <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  
                    <span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> 
            <span class=main>(</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> val_of_name <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span>  <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> 
                   val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>t</span><span class=main>)</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>t</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>}</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>

    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>θ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>⟨</span><span class=skolem>t</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span> <span class=bound>p</span><span class=main>⟩</span> <span class=main>∧</span> 
              <span class=main>(</span><span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟶</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=bound>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>)</span><span class=main>)</span> 
      <span class=main>⟷</span> 
      <span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>t</span><span class=main>)</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>t</span><span class=main>)</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>@</span><span class=main>[</span><span class=free>c</span><span class=main>]</span><span class=main>⊨</span> <span class=free>φ</span> <span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>t</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>transitivity<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span>  <span class=main>{</span><span class=bound>x</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>c</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>

    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⊆</span> <span class=main>{</span><span class=bound>x</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>c</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span> 
    <span class=comment1>(* Now we show the other inclusion:
      {x .. x∈c , ∃q∈P. x ∈ c ∧ (M[G],  [x, w, c] ⊨  φ) ∧ q ∈ G}
      ⊆
      {val(G,t)..t∈domain(π),∃q∈P.val(G,t)∈c∧(M[G], [val(G,t),w] ⊨ φ)∧q∈G}
    *)</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=main>{</span><span class=bound>x</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>c</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=skolem>x</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span>  
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>=</span><span class=skolem>x</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> Sep_and_Replace elem_of_val <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>" <span class=main>{</span><span class=bound>x</span> <span class=main>..</span> <span class=bound><span class=bound>x</span></span><span class=main>∈</span><span class=free>c</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>c</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>G</span><span class=main>}</span> <span class=main>⊆</span> <span class=main>...</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> SepReplace_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>›</span></span> G_nonempty <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>finally</span></span> 
  <span class=keyword1><span class=command>have</span></span> val_m<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?m</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?m</span><span class=main>)</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?m</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> val_m 
    <span class=keyword1><span class=command>have</span></span> Eq4<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>θ</span><span class=main>.</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>θ</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π</span> <span class=main>∧</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>θ</span><span class=main>)</span> <span class=main>=</span><span class=skolem>x</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> elem_of_val_pair <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>θ</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> domain_trans<span class=main>[</span><span class=operator>OF</span> trans_M <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>=</span> <span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>,</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span>list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span>  Eq4 <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>›</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span>›</span></span> nth <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> Eq5<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span><span class=main>[</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π</span><span class=main>)</span><span class=main>]</span> <span class=main>⊨</span> And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=comment1>(* Recall ?χ = And(Member(0,1 #+ length(env)),φ) *)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span>  Eq5 <span class=quoted><span class=quoted>‹M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span> <span class=main>∈</span> <span class=main>_</span> ›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>=</span> <span class=main>_</span> ›</span></span> map_nenv 
      <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span>  <span class=main>[</span><span class=bound>r</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> truth_lemma  
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span>      <span class=comment1>(* I can't "obtain" this directly *)</span>
      <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>r</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>≼</span><span class=skolem>q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>≼</span><span class=skolem>r</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> filter_def compat_in_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  P_in_M  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>transitivity<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>≼</span><span class=skolem>r</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span>›</span></span>
      <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>r</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>⊨</span> forces<span class=main>(</span><span class=var>?χ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> strengthening_lemma 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=var>?χ</span><span class=main>)</span> <span class=main>≤</span> length<span class=main>(</span><span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>p</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> 
                 <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>   map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=skolem>θ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span><span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> definition_of_forcing
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span>  
    <span class=keyword1><span class=command>have</span></span> Eq6<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>θ'</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p'</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span>  <span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span> <span class=main>=</span> <span class=main>&lt;</span><span class=bound>θ'</span><span class=main>,</span><span class=bound>p'</span><span class=main>&gt;</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>F</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>F</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>p'</span> <span class=main>∈</span> <span class=bound>F</span> <span class=main>⟶</span> 
                 <span class=keyword1>M[</span><span class=bound>F</span><span class=main>]</span><span class=main>,</span>   map<span class=main>(</span>val<span class=main>(</span><span class=bound>F</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=bound>θ'</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span><span class=main>)</span> <span class=main>⊨</span>  <span class=var>?χ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>transitivity<span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>×</span><span class=free>P</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> tuples_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span><span class=main>∈</span><span class=free>M</span>›</span></span> Eq6 <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>]</span> <span class=main>@</span> <span class=var>?Pl1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>π</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Equivalence  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>π</span><span class=main>)</span><span class=main>×</span><span class=free>P</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?n</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span>  val_of_elem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>θ</span></span> <span class=quoted><span class=skolem>p</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>›</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=comment1>(* proof of "val(G,?m) ⊆ val(G,?n)" *)</span>
  <span class=keyword1><span class=command>with</span></span> val_m first_incl 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?n</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>"</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>›</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> transitivity_MG
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>ultimately</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>(</span><span class=main>[</span><span class=skolem>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>@</span><span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>  <span class=main>[</span><span class=skolem>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span>  <span class=free>φ</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> phi <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> arity_sats_iff<span class=main><span class=keyword3>,</span></span> <span class=operator>simp_all</span><span class=main>)</span>   <span class=comment1>(* Enhance this *)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>      
  <span class=keyword1><span class=command>finally</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span><span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=var>?n</span><span class=main>∈</span><span class=free>M</span>›</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>theorem</span></span> separation_in_MG<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  
    <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> 
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>c</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> 
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>nenv</span></span> <span class=keyword2><span class=keyword>where</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
      <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>=</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> GenExt_def map_val<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>env</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> Eq1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=skolem>c</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Collect_sats_in_MG  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> separation_iff rev_bexI <span class=keyword1><span class=command>unfolding</span></span> is_Collect_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* context: G_generic *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Pairing_Axiom><div class=head><h1>Theory Pairing_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Pairing in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Pairing_Axiom <span class=keyword2><span class=keyword>imports</span></span> <a href=Names.html>Names</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Pairing_Axiom-val_Upair><span class=command>lemma</span></span> val_Upair <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=main>⟨</span><span class=free>τ</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=free>ρ</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> one_in_P<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> trans<span class=main><span class=keyword3>,</span></span> <span class=operator>subst</span> def_val<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Sep_and_Replace<span class=main>)</span>

<span class=keyword1 id=Pairing_Axiom-pairing_in_MG><span class=command>lemma</span></span> pairing_in_MG <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"upair_ax<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span> 
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>one</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms one_in_G <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> assms 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span><span class=main>⊆</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> M_generic_def <span class=keyword2><span class=keyword>and</span></span> filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>one</span><span class=main>∈</span><span class=free>G</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>one</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>using</span></span> subsetD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>one</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> transitivity<span class=main>[</span><span class=operator>OF</span> _ P_in_M<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>τ</span></span> <span class=skolem><span class=skolem>ρ</span></span> <span class=keyword2><span class=keyword>where</span></span>
      0 <span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>one</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>τ</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> pair_in_M_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>⟨</span><span class=skolem>τ</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?σ</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>using</span></span> upair_in_M_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?σ</span><span class=main>)</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> 1 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> val_Upair assms one_in_G <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> 0 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>}</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> upair_ax_def upair_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span>  <span class=comment1>(* context forcing_data *)</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Union_Axiom><div class=head><h1>Theory Union_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Unions in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Union_Axiom
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Names.html>Names</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>Union_name_body</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Union_name_body</span><span class=main>(</span><span class=free><span class=bound><span class=entity>P'</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>leq'</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>θp</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span> <span class=bound>σ</span><span class=main>[</span><span class=main>##</span><span class=free>M</span><span class=main>].</span>
           <span class=main>∃</span> <span class=bound>q</span><span class=main>[</span><span class=main>##</span><span class=free>M</span><span class=main>].</span> <span class=main>(</span><span class=bound>q</span><span class=main>∈</span> <span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>⟨</span><span class=bound>σ</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>τ</span></span></span> <span class=main>∧</span>
            <span class=main>(</span><span class=main>∃</span> <span class=bound>r</span><span class=main>[</span><span class=main>##</span><span class=free>M</span><span class=main>].</span><span class=bound>r</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>P'</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>⟨</span>fst<span class=main>(</span><span class=free><span class=bound><span class=entity>θp</span></span></span><span class=main>)</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=bound>σ</span> <span class=main>∧</span> <span class=main>⟨</span>snd<span class=main>(</span><span class=free><span class=bound><span class=entity>θp</span></span></span><span class=main>)</span><span class=main>,</span><span class=bound>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>leq'</span></span></span> <span class=main>∧</span> <span class=main>⟨</span>snd<span class=main>(</span><span class=free><span class=bound><span class=entity>θp</span></span></span><span class=main>)</span><span class=main>,</span><span class=bound>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>leq'</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>Union_name_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Union_name_fm</span> <span class=main>≡</span>
    Exists<span class=main>(</span>
    Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>
    Exists <span class=main>(</span>
    Exists <span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>7</span><span class=main>)</span><span class=main>,</span>
      Exists <span class=main>(</span>And<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>6</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
        Exists <span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>9</span><span class=main>)</span><span class=main>,</span>
         Exists <span class=main>(</span>And<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>6</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>4</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
          Exists <span class=main>(</span>And<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>6</span><span class=main>,</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>10</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
          Exists <span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>7</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>11</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Union_Axiom-Union_name_fm_type><span class=command>lemma</span></span> Union_name_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"Union_name_fm <span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Union_name_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Union_Axiom-arity_Union_name_fm><span class=command>lemma</span></span> arity_Union_name_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"arity<span class=main>(</span>Union_name_fm<span class=main>)</span> <span class=main>=</span> <span class=main>4</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Union_name_fm_def upair_fm_def pair_fm_def
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_simp_union<span class=main>)</span>

<span class=keyword1 id=Union_Axiom-sats_Union_name_fm><span class=command>lemma</span></span> sats_Union_name_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>a</span> <span class=main>∈</span> <span class=free>M</span><span class=main>;</span> <span class=free>b</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>;</span> <span class=free>P'</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>;</span> <span class=free>p</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>;</span> <span class=free>θ</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>;</span> <span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>;</span> <span class=free>leq'</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span>
     sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>Union_name_fm<span class=main>,</span><span class=main>[</span><span class=main>⟨</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>leq'</span><span class=main>,</span><span class=free>P'</span><span class=main>]</span><span class=main>@</span><span class=main>[</span><span class=free>a</span><span class=main>,</span><span class=free>b</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span>
     Union_name_body<span class=main>(</span><span class=free>P'</span><span class=main>,</span><span class=free>leq'</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=main>⟨</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Union_name_fm_def Union_name_body_def tuples_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>θ</span><span class=main>,</span><span class=free>p</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>M</span>"</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span> <span class=main><span class=main>:</span></span> tuples_in_M<span class=main>)</span>


<span class=keyword1 id=Union_Axiom-domD><span class=command>lemma</span></span> domD <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>σ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms Transset_M trans_M
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>Union_name</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>Union_name</span><span class=main>(</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>)</span> <span class=main>≡</span>
    <span class=main>{</span><span class=bound>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=main>⋃</span><span class=main>(</span>domain<span class=main>(</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> Union_name_body<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=bound>u</span><span class=main>)</span><span class=main>}</span>"</span></span>

<span class=keyword1 id=Union_Axiom-Union_name_M><span class=command>lemma</span></span> Union_name_M <span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>u</span> <span class=main>∈</span> domain<span class=main>(</span><span class=main>⋃</span><span class=main>(</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> Union_name_body<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=bound>u</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Union_name_def
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>Union_name_fm<span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>leq</span><span class=main>]</span><span class=main>@</span><span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>leq</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=main>.</span> Union_name_body<span class=main>(</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=main>⋃</span><span class=main>(</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?d</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>using</span></span> domain_closed Union_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?d</span> <span class=main>×</span> <span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> cartprod_closed P_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>Union_name_fm<span class=main>)</span><span class=main>≤</span><span class=main>6</span>"</span></span> <span class=keyword1><span class=command>using</span></span> arity_Union_name_fm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> assms P_in_M leq_in_M  arity_Union_name_fm
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>τ</span><span class=main>,</span><span class=free>leq</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>leq</span><span class=main>]</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> assms assms P_in_M leq_in_M  <span class=quoted><span class=quoted>‹arity<span class=main>(</span>Union_name_fm<span class=main>)</span><span class=main>≤</span><span class=main>6</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"separation<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=var>?P</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> separation_ax <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?d</span> <span class=main>×</span> <span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>{</span> <span class=bound>u</span> <span class=main>∈</span> <span class=var>?d</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> <span class=var>?P</span><span class=main>(</span><span class=bound>u</span><span class=main>)</span> <span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  separation_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>⟷</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span> <span class=var>?d</span><span class=main>×</span><span class=free>P</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span> <span class=var>?d</span><span class=main>×</span><span class=free>P</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=main>⟨</span>fst<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>⟩</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Pair_fst_snd_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=var>?d</span><span class=main>×</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?d</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"snd<span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mtrans fst_type snd_type P_in_M <span class=keyword1><span class=command>unfolding</span></span> M_trans_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span><span class=main>⟨</span>fst<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>⟩</span><span class=main>)</span> <span class=main>⟷</span>  <span class=var>?Q</span><span class=main>(</span><span class=main>⟨</span>fst<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P_in_M sats_Union_name_fm P_in_M <span class=quoted><span class=quoted>‹<span class=free>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span> leq_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>=</span> <span class=main>⟨</span>fst<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>⟩</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span><span class=skolem>x</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Collect_cong A <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>



<span class=keyword1 id=Union_Axiom-Union_MG_Eq><span class=command>lemma</span></span> Union_MG_Eq <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=free>a</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>⋃</span> <span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>τ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>i</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem_of_val_pair domD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>i</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>θ</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=skolem>σ</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem_of_val_pair domD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>θ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=main>⋃</span><span class=main>(</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span>
      A<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> low_bound_filter filterD  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> mtrans P_in_M <span class=keyword1><span class=command>unfolding</span></span> M_trans_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> A <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=skolem>σ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>θ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=main>⋃</span><span class=main>(</span>domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span> <span class=main>∈</span> Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> Union_name_def Union_name_body_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> val_of_elem <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>⋃</span> <span class=free>a</span> <span class=main>⟹</span> <span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span>Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>θ</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span> <span class=main>∈</span> Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem_of_val_pair <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=keyword1><span class=command>using</span></span> filterD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span> <span class=main>∈</span> Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> domain<span class=main>(</span><span class=free>τ</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>τ</span> "</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=skolem>σ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>p</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>leq</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> Union_name_def Union_name_body_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>∈</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>∈</span> <span class=free>G</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> filter_leqD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>θ</span><span class=main>,</span><span class=skolem>r</span><span class=main>⟩</span> <span class=main>∈</span> <span class=skolem>σ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=free>τ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> val_of_elem <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span> <span class=main>∈</span> <span class=main>⋃</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>θ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=main>⋃</span> <span class=free>a</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span>Union_name<span class=main>(</span><span class=free>τ</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>x</span> <span class=main>∈</span> <span class=main>⋃</span> <span class=free>a</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Union_Axiom-union_in_MG><span class=command>lemma</span></span> union_in_MG <span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Union_ax<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>interpret</span></span> mgtrans <span class=main>:</span> M_trans <span class=quoted><span class=quoted>"<span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span><span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>τ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Union_name<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?π</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>using</span></span> Union_name_M <span class=keyword1><span class=command>unfolding</span></span> Union_name_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?π</span><span class=main>)</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?U</span> <span class=main>∈</span> <span class=main>_</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>using</span></span> GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=var>?U</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?U</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"big_union<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=var>?U</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Union_MG_Eq Union_abs  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?U</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>z</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> big_union<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Union_ax<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> Union_ax_def <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>theorem</span></span> Union_MG <span class=main>:</span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span> <span class=main>⟹</span> Union_ax<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>M_generic_def union_in_MG<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* forcing_data *)</span>
<span class=keyword2><span class=keyword>end</span></span>
</pre></div><div id=Powerset_Axiom><div class=head><h1>Theory Powerset_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Powerset Axiom in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Powerset_Axiom
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Renaming_Auto.html>Renaming_Auto</a> <a href=Separation_Axiom.html>Separation_Axiom</a> <a href=Pairing_Axiom.html>Pairing_Axiom</a> <a href=Union_Axiom.html>Union_Axiom</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>simple_rename</span></span> <span class=quoted>"perm_pow"</span> <span class=keyword2><span class=keyword>src</span></span> <span class=quoted>"[ss,p,l,o,fs,χ]"</span> <span class=keyword2><span class=keyword>tgt</span></span> <span class=quoted>"[fs,ss,sp,p,l,o,χ]"</span>

<span class=keyword1 id=Powerset_Axiom-Collect_inter_Transset><span class=command>lemma</span></span> Collect_inter_Transset<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>b</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>b</span> <span class=main>.</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=free>b</span> <span class=main>.</span> <span class=free>P</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>}</span> <span class=main>∩</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>unfolding</span></span> Transset_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1><span class=command>context</span></span> G_generic  <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Powerset_Axiom-name_components_in_M><span class=command>lemma</span></span> name_components_in_M<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>&lt;</span><span class=free>σ</span><span class=main>,</span><span class=free>p</span><span class=main>&gt;</span><span class=main>∈</span><span class=free>θ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>   <span class=quoted><span class=quoted>"<span class=free>σ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=free>σ</span> <span class=main>∈</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span> <span class=main>∈</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=main>&lt;</span><span class=free>σ</span><span class=main>,</span><span class=free>p</span><span class=main>&gt;</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Pair_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>&lt;</span><span class=free>σ</span><span class=main>,</span><span class=free>p</span><span class=main>&gt;</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>σ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Powerset_Axiom-sats_fst_snd_in_M><span class=command>lemma</span></span> sats_fst_snd_in_M<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>B</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>o</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>χ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>sq</span> <span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>B</span> <span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span>snd<span class=main>(</span><span class=bound>sq</span><span class=main>)</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span>fst<span class=main>(</span><span class=bound>sq</span><span class=main>)</span><span class=main>,</span><span class=free>χ</span><span class=main>]</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>6</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=main>7</span><span class=main>∈</span>nat"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?φ'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"ren<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>`</span><span class=main>6</span><span class=main>`</span><span class=main>7</span><span class=main>`</span>perm_pow_fn"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span><span class=free>B</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> cartprod_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span> formula›</span></span> <span class=quoted><span class=quoted>‹<span class=main>6</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>7</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?φ'</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?φ'</span><span class=main>)</span><span class=main>≤</span><span class=main>7</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> perm_pow_fn_def
    <span class=keyword1><span class=command>using</span></span>  perm_pow_thm  arity_ren ren_tc Nil_type
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?φ'</span> <span class=main>∈</span> formula›</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span><span class=var>?φ'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>≤</span><span class=main>5</span>"</span></span>     <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span><span class=main>≤</span><span class=main>5</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>unfolding</span></span> pair_fm_def upair_fm_def
    <span class=keyword1><span class=command>using</span></span> nat_simp_union pred_le arity_type <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>sp</span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>×</span><span class=free>B</span> <span class=main>∈</span> <span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>sp</span> <span class=main>∈</span> <span class=free>A</span><span class=main>×</span><span class=free>B</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"snd<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span> <span class=main>∈</span> <span class=free>B</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fst_type snd_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>sp</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"fst<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"snd<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> transitivity
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>note</span></span> inM <span class=main>=</span> <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>p</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>l</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>o</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>χ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
      <span class=quoted><span class=quoted>‹<span class=skolem>sp</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹fst<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹snd<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>with</span></span> 1 <span class=quoted><span class=quoted>‹<span class=skolem>sp</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?φ'</span> <span class=main>∈</span> formula›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>sp</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>χ</span><span class=main>]</span><span class=main>@</span><span class=main>[</span><span class=free>p</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?ψ</span> <span class=main>⟷</span> <span class=free>M</span><span class=main>,</span><span class=main>[</span><span class=skolem>sp</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>χ</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span><span class=var>?env0</span><span class=main>@</span> <span class=main>_</span><span class=main>⊨</span><span class=main>_</span> <span class=main>⟷</span> <span class=main>_</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?ψ</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>p</span><span class=main>]</span>"</span></span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?env0</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> inM <span class=quoted><span class=quoted>‹<span class=skolem>sp</span> <span class=main>∈</span> <span class=free>A</span><span class=main>×</span><span class=free>B</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?φ'</span><span class=main>,</span><span class=main>[</span>fst<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>,</span><span class=skolem>sp</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>χ</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> inM <span class=quoted><span class=quoted>‹<span class=free>φ</span> <span class=main>∈</span> formula›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span>snd<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span>fst<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>,</span><span class=free>χ</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=var>?env1</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=var>?env2</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> sats_iff_sats_ren<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=main>6</span></span> <span class=quoted><span class=main>7</span></span> <span class=var><span class=quoted><span class=var>?env2</span></span></span> <span class=quoted><span class=free>M</span></span> <span class=var><span class=quoted><span class=var>?env1</span></span></span> <span class=quoted>perm_pow_fn</span><span class=main>]</span> perm_pow_thm
      <span class=keyword1><span class=command>unfolding</span></span> perm_pow_fn_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?ψ</span><span class=main>,</span><span class=main>[</span><span class=skolem>sp</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>χ</span><span class=main>,</span><span class=free>p</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span>snd<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span>fst<span class=main>(</span><span class=skolem>sp</span><span class=main>)</span><span class=main>,</span><span class=free>χ</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=var>?θ</span> <span class=main>=</span> <span class=main>{</span><span class=bound>sp</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>B</span> <span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?ψ</span><span class=main>,</span><span class=main>[</span><span class=bound>sp</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>l</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>χ</span><span class=main>,</span><span class=free>p</span><span class=main>]</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>×</span><span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> 1
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> leI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?φ'</span> <span class=main>∈</span> formula›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?ψ</span> <span class=main>∈</span> formula"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> assms <span class=quoted><span class=quoted>‹<span class=free>A</span><span class=main>×</span><span class=free>B</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>A</span><span class=main>×</span><span class=free>B</span> <span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=var>?ψ</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> <span class=free>l</span><span class=main>,</span> <span class=free>o</span><span class=main>,</span> <span class=free>χ</span><span class=main>,</span> <span class=free>p</span><span class=main>]</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> separation_ax separation_iff
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Powerset_Axiom-Pow_inter_MG><span class=command>lemma</span></span> Pow_inter_MG<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"Pow<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>τ</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>τ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Pow<span class=main>(</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span><span class=main>)</span> <span class=main>∩</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> domain_closed cartprod_closed P_in_M
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> power_ax <span class=quoted><span class=quoted>‹domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>Q</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"powerset<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span><span class=main>,</span><span class=skolem>Q</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>Q</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> power_ax_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=skolem>Q</span> <span class=main>⟹</span> <span class=skolem>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
      <span class=keyword1><span class=command>using</span></span> transitivity <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>Q</span> <span class=main>=</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span>Pow<span class=main>(</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span><span class=main>)</span> <span class=main>.</span> <span class=bound>a</span><span class=main>∈</span><span class=free>M</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> powerset_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span>"</span></span> <span class=quoted><span class=skolem>Q</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
    <span class=keyword1><span class=command>also</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=var>?Q</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>finally</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>Q</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?π</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=var>?Q</span><span class=main>×</span><span class=main>{</span><span class=free>one</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span>
    <span class=var><span class=quoted><span class=var>?b</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?π</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?Q</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> one_in_P P_in_M transitivity
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?b</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Pow<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>⊆</span> <span class=var>?b</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>c</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>χ</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>χ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>χ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>c</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?θ</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>sp</span> <span class=main>∈</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span> <span class=main>.</span> snd<span class=main>(</span><span class=bound>sp</span><span class=main>)</span> <span class=main>⊩</span> <span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>[</span>fst<span class=main>(</span><span class=bound>sp</span><span class=main>)</span><span class=main>,</span><span class=skolem>χ</span><span class=main>]</span> <span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>6</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> arity_forces_at <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>χ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P_in_M one_in_M leq_in_M sats_fst_snd_in_M
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?θ</span> <span class=main>∈</span> <span class=var>?Q</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?θ</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?b</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> one_in_G one_in_P generic val_of_elem <span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?θ</span></span></span> <span class=quoted><span class=free>one</span></span> <span class=var><span class=quoted><span class=var>?π</span></span></span> <span class=quoted><span class=free>G</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?θ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>c</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>intro</span> equalityI subsetI<span class=main>)</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?θ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span>
        1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>&lt;</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>p</span><span class=main>&gt;</span><span class=main>∈</span><span class=var>?θ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span>  <span class=skolem>x</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> elem_of_val_pair
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>&lt;</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>p</span><span class=main>&gt;</span><span class=main>∈</span><span class=var>?θ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?θ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> name_components_in_M<span class=main>[</span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=var><span class=quoted><span class=var><span class=quoted><span class=var>?θ</span></span></span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> 1 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> <span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>[</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>χ</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
      <span class=keyword1><span class=command>moreover</span></span> 
      <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>χ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>c</span>›</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>c</span><span class=main>]</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>χ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> generic definition_of_forcing nat_simp_union
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span>  <span class=skolem>x</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>χ</span><span class=main>∈</span><span class=free>M</span>›</span></span> GenExtI <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=skolem>c</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>c</span>"</span></span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>c</span> <span class=main>∈</span> Pow<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> transitivity_MG
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> <span class=free>a</span>›</span></span> 
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span>  <span class=skolem>x</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> elem_of_val
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=skolem>c</span>›</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>χ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>c</span>›</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>χ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>c</span><span class=main>]</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span>›</span></span> 
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>&lt;</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>p</span><span class=main>&gt;</span> <span class=main>∈</span> <span class=skolem>τ</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> name_components_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>χ</span> <span class=main>∈</span> <span class=free>M</span>›</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> 
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p</span> <span class=main>⊩</span> Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>χ</span><span class=main>]</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> generic truth_lemma<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>χ</span><span class=main>]</span>"</span></span> <span class=main>]</span> nat_simp_union
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> 
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> generic <span class=keyword1><span class=command>unfolding</span></span> M_generic_def filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>&lt;</span><span class=skolem>σ</span><span class=main>,</span><span class=skolem>p</span><span class=main>&gt;</span><span class=main>∈</span><span class=var>?θ</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span>  <span class=skolem>x</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>›</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?θ</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> val_of_elem <span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=var>?θ</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?θ</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?b</span>›</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>c</span><span class=main>∈</span><span class=var>?b</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Pow<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=var>?b</span> <span class=main>.</span> <span class=bound>x</span><span class=main>⊆</span><span class=free>a</span> <span class=main>&amp;</span> <span class=bound>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=var>?b</span> <span class=main>.</span> sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>subset_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>a</span><span class=main>]</span><span class=main>)</span> <span class=main>&amp;</span> <span class=bound>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Transset_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>also</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=var>?b</span> <span class=main>.</span> sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>subset_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>a</span><span class=main>]</span><span class=main>)</span><span class=main>}</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?b</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span><span class=var>?b</span> <span class=main>.</span> sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span>subset_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=free>a</span><span class=main>]</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_inter_Transset Transset_MG
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=var>?b</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_sats_in_MG GenExtI nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* context: G_generic *)</span>


<span class=keyword1><span class=command>context</span></span> G_generic <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>interpretation</span></span> mgtriv<span class=main>:</span> M_trivial <span class=quoted><span class=quoted>"<span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> generic Union_MG pairing_in_MG zero_in_MG transitivity_MG
  <span class=keyword1><span class=command>unfolding</span></span> M_trivial_def M_trans_def M_trivial_axioms_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>;</span></span> <span class=operator>blast</span><span class=main>)</span>


<span class=keyword1><span class=command>theorem</span></span> power_in_MG <span class=main>:</span> <span class=quoted><span class=quoted>"power_ax<span class=main>(</span><span class=main>##</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> power_ax_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> rallI<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span>setclass_iff rex_setclass_is_bex<span class=main>)</span>
  <span class=comment1>(* After simplification, we have to show that for every
     a∈M[G] there exists some x∈M[G] with powerset(##M[G],a,x)
  *)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>}</span> <span class=main>=</span> Pow<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>...</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Pow_inter_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>}</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>}</span> <span class=main>∈</span> <span class=main>_</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"powerset<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=skolem>a</span><span class=main>,</span> <span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Pow<span class=main>(</span><span class=skolem>a</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> mgtriv.powerset_abs<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>a</span><span class=main>)</span>›</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> powerset<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=skolem>a</span><span class=main>,</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* context: G_generic *)</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Extensionality_Axiom><div class=head><h1>Theory Extensionality_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Extensionality in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Extensionality_Axiom
<span class=keyword2><span class=keyword>imports</span></span>
  <a href=Names.html>Names</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>
  
<span class=keyword1 id=Extensionality_Axiom-extensionality_in_MG><span class=command>lemma</span></span> extensionality_in_MG <span class=main>:</span> <span class=quoted><span class=quoted>"extensionality<span class=main>(</span><span class=main>##</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span> <span class=skolem>z</span>
    <span class=keyword3><span class=command>assume</span></span> 
      asms<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>w</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=bound>w</span> <span class=main>∈</span> <span class=skolem>x</span> <span class=main>⟷</span> <span class=bound>w</span> <span class=main>∈</span> <span class=skolem>y</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=skolem>x</span> <span class=main>⟷</span> <span class=skolem>z</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=skolem>z</span><span class=main>∈</span><span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>⟷</span> <span class=skolem>z</span><span class=main>∈</span><span class=skolem>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> asms transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=skolem>x</span> <span class=main>⟷</span> <span class=skolem>z</span><span class=main>∈</span><span class=skolem>y</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>z</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=bound>z</span> <span class=main>∈</span> <span class=bound>x</span> <span class=main>⟷</span> <span class=bound>z</span> <span class=main>∈</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> extensionality_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>
 
<span class=keyword2><span class=keyword>end</span></span>  <span class=comment1>(* context forcing_data *)</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Foundation_Axiom><div class=head><h1>Theory Foundation_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Foundation in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Foundation_Axiom
<span class=keyword2><span class=keyword>imports</span></span>
  <a href=Names.html>Names</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> forcing_data
<span class=keyword2><span class=keyword>begin</span></span>
  
<span class=comment1>(* Slick proof essentially by Paulson (adapted from L) *)</span>  
<span class=keyword1 id=Foundation_Axiom-foundation_in_MG><span class=command>lemma</span></span> foundation_in_MG <span class=main>:</span> <span class=quoted><span class=quoted>"foundation_ax<span class=main>(</span><span class=main>##</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> foundation_ax_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> rallI<span class=main><span class=keyword3>,</span></span> <span class=operator>cut_tac</span> A<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>x</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> foundation<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> transitivity_MG<span class=main>)</span>

<span class=comment1>(* Same theorem as above, declarative proof, 
   without using transitivity *)</span>
<span class=keyword1><span class=command>lemma</span></span> <span class=quoted><span class=quoted>"foundation_ax<span class=main>(</span><span class=main>##</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>   
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> 
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=skolem>x</span><span class=main>∩</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=skolem>x</span><span class=main>∩</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>z</span><span class=main>∈</span><span class=skolem>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>∉</span> <span class=skolem>x</span><span class=main>∩</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> foundation<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∩</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span><span class=main>]</span>  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>y</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=skolem>x</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>z</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>.</span> <span class=bound>z</span> <span class=main>∉</span> <span class=skolem>x</span> <span class=main>∨</span> <span class=bound>z</span> <span class=main>∉</span> <span class=bound>y</span><span class=main>)</span>"</span></span><span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> foundation_ax_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>
    
<span class=keyword2><span class=keyword>end</span></span>  <span class=comment1>(* context forcing_data *)</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Least><div class=head><h1>Theory Least</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The binder <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹<span class=free><span class=free>Least</span></span>›</span></span></span></span>›</span></span>
<span class=keyword1><span class=command>theory</span></span> Least
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Names.html>Names</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We have some basic results on the least ordinal satisfying
a predicate.›</span></span>

<span class=keyword1 id=Least-Least_Ord><span class=command>lemma</span></span> Least_Ord<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=free>R</span><span class=main>(</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>α</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Least_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lt_Ord<span class=main>)</span>

<span class=keyword1 id=Least-Ord_Least_cong><span class=command>lemma</span></span> Ord_Least_cong<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>R</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>Q</span><span class=main>(</span><span class=bound>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=free>R</span><span class=main>(</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>α</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span><span class=main>(</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>α</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Least_Ord <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>least</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>least</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>≡</span> ordinal<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>
         <span class=main>(</span>empty<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> ordinal<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>b</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>(</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
       <span class=main>∨</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> ordinal<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>b</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>b</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>⟶</span> <span class=main>¬</span><span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>(</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>least_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>least_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=main>≡</span> And<span class=main>(</span>ordinal_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span><span class=main>,</span>
   Or<span class=main>(</span>And<span class=main>(</span>empty_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span><span class=main>,</span>Forall<span class=main>(</span>Implies<span class=main>(</span>ordinal_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Neg<span class=main>(</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> 
      And<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>,</span>Equal<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>
          Forall<span class=main>(</span>Implies<span class=main>(</span>And<span class=main>(</span>ordinal_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span>succ<span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>,</span>Neg<span class=main>(</span><span class=free><span class=bound><span class=entity>q</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Least-least_fm_type><span class=command>lemma</span></span> least_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>q</span><span class=main>∈</span>formula <span class=main>⟹</span> least_fm<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>i</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> least_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* Refactorize Formula and Relative to include the following three lemmas *)</span>
<span class=keyword1><span class=command>lemmas</span></span> basic_fm_simps <span class=main>=</span> sats_subset_fm' sats_transset_fm' sats_ordinal_fm'

<span class=keyword1 id=Least-sats_least_fm><span class=command>lemma</span></span> sats_least_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> p_iff_sats<span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>P</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=free>p</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>a</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>y</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span> <span class=main>;</span> <span class=main>0</span><span class=main>∈</span><span class=free>A</span><span class=main>⟧</span>
    <span class=main>⟹</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> least_fm<span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span>
        least<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> nth_closed p_iff_sats <span class=keyword1><span class=command>unfolding</span></span> least_def least_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>basic_fm_simps<span class=main>)</span>

<span class=keyword1 id=Least-least_iff_sats><span class=command>lemma</span></span> least_iff_sats<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> is_Q_iff_sats<span class=main>:</span> 
      <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>⟹</span> <span class=free>is_Q</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=free>q</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>a</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
  <span class=quoted><span class=quoted>"<span class=main>⟦</span>nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>y</span><span class=main>;</span> <span class=free>j</span> <span class=main>∈</span> nat<span class=main>;</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span><span class=main>;</span> <span class=main>0</span><span class=main>∈</span><span class=free>A</span><span class=main>⟧</span>
   <span class=main>⟹</span> least<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=free>is_Q</span><span class=main>,</span> <span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>A</span><span class=main>,</span> least_fm<span class=main>(</span><span class=free>q</span><span class=main>,</span><span class=free>j</span><span class=main>)</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> sats_least_fm <span class=main>[</span><span class=operator>OF</span> is_Q_iff_sats<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>j</span></span> <span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Least-least_conj><span class=command>lemma</span></span> least_conj<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>⟷</span> least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>Q</span><span class=main>,</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> least_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=comment1>(* Better to have this in M_basic or similar *)</span>
<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ctm<span class=main>)</span> unique_least<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> <span class=free>b</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟹</span> least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>Q</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>⟹</span> least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>Q</span><span class=main>,</span><span class=free>b</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>a</span><span class=main>=</span><span class=free>b</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> least_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span> <span class=operator>erule_tac</span> i<span class=main><span class=main>=</span></span><span class=quoted><span class=free>a</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> j<span class=main><span class=main>=</span></span><span class=quoted><span class=free>b</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> Ord_linear_lt<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>drule</span> ltD <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>Ord_in_Ord<span class=main>)</span>

<span class=keyword1><span class=command>context</span></span> M_trivial
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Absoluteness and closure under <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator><span class=hidden>\&lt;^</span><span class=control>term</span><span class=hidden>&gt;</span></span></span><span class=quoted><span class=quoted>‹Least›</span></span></span></span>›</span></span>

<span class=keyword1 id=Least-least_abs><span class=command>lemma</span></span> least_abs<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"least<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>Q</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>a</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> least_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span>"</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>intro</span> iffI<span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>assms<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>i</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=bound>i</span><span class=main>)</span><span class=main>)</span> "</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>=</span><span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Least_0 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"ordinal<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>empty<span class=main>(</span><span class=free>M</span><span class=main>,</span> Least<span class=main>(</span><span class=free>Q</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=free>Q</span><span class=main>(</span>Least<span class=main>(</span><span class=free>Q</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span>  <span class=quoted><span class=quoted>‹<span class=free>Q</span><span class=main>(</span><span class=skolem>i</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=skolem>i</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=var><span class=quoted><span class=var>?G</span></span></span><span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>LeastI<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>b</span> <span class=main>∈</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?H</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> less_LeastE<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>Q</span></span> <span class=main>_</span> <span class=quoted>False</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span> <span class=operator>drule_tac</span> ltI<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"ordinal<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>empty<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=var>?G</span> <span class=main>∧</span> <span class=var>?H</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>a</span> <span class=main>=</span> <span class=main>0</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=free>Q</span><span class=main>(</span><span class=free>a</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>b</span> <span class=main>∈</span> <span class=free>a</span> <span class=main>⟶</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> 1
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span><span class=main>(</span><span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=free>M</span><span class=main>].</span> Ord<span class=main>(</span><span class=bound>b</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>b</span> <span class=main>∈</span> <span class=free>a</span> <span class=main>⟶</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=bound>b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=skolem>b</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>b</span> <span class=main>∈</span> <span class=free>a</span> <span class=main>⟹</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=skolem>b</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=free>a</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>&lt;</span> <span class=free>a</span> <span class=main>⟹</span> <span class=main>¬</span> <span class=free>Q</span><span class=main>(</span><span class=skolem>b</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>unfolding</span></span> lt_def <span class=keyword1><span class=command>using</span></span> Ord_in_Ord <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Least_equality <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Least-Least_closed><span class=command>lemma</span></span> Least_closed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=keyword1>μ</span> <span class=bound>x</span><span class=main>.</span> <span class=free>Q</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms LeastI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>Q</span></span><span class=main>]</span> Least_0 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>i</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>i</span><span class=main>)</span> <span class=main>∧</span> <span class=free>Q</span><span class=main>(</span><span class=bound>i</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_trivial *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Replacement_Axiom><div class=head><h1>Theory Replacement_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Replacement in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Replacement_Axiom
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Least.html>Least</a> <a href=Relative_Univ.html>Relative_Univ</a> <a href=Separation_Axiom.html>Separation_Axiom</a> <a href=Renaming_Auto.html>Renaming_Auto</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>rename</span></span> <span class=quoted>"renrep1"</span> <span class=keyword2><span class=keyword>src</span></span> <span class=quoted>"[p,P,leq,o,ρ,τ]"</span> <span class=keyword2><span class=keyword>tgt</span></span> <span class=quoted>"[V,τ,ρ,p,α,P,leq,o]"</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>renrep_fn</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>renrep_fn</span><span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>≡</span> sum<span class=main>(</span>renrep1_fn<span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=main>8</span><span class=main>,</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>renrep</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>renrep</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>=</span> ren<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>6</span><span class=main>#+</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>8</span><span class=main>#+</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span>renrep_fn<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Replacement_Axiom-renrep_type><span class=command>lemma</span></span> renrep_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"renrep<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renrep_def renrep_fn_def renrep1_fn_def
  <span class=keyword1><span class=command>using</span></span> assms renrep1_thm<span class=main>(</span>1<span class=main>)</span> ren_tc
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-arity_renrep><span class=command>lemma</span></span> arity_renrep<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span> <span class=main>6</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>renrep<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>8</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span>  renrep_def renrep_fn_def renrep1_fn_def
  <span class=keyword1><span class=command>using</span></span> assms renrep1_thm<span class=main>(</span>1<span class=main>)</span> arity_ren
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-renrep_sats><span class=command>lemma</span></span> renrep_sats <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>ρ</span><span class=main>,</span><span class=free>τ</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>V</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span> <span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>ρ</span><span class=main>,</span><span class=free>τ</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> renrep<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=free>V</span><span class=main>,</span><span class=free>τ</span><span class=main>,</span><span class=free>ρ</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span>  renrep_def renrep_fn_def renrep1_fn_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sats_iff_sats_ren<span class=main><span class=keyword3>,</span></span><span class=operator>insert</span> assms<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>renrep1_thm<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>M</span></span><span class=main><span class=main>,</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span>
        renrep1_thm<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>,</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> p<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>p</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> α<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>α</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>rename</span></span> <span class=quoted>"renpbdy1"</span> <span class=keyword2><span class=keyword>src</span></span> <span class=quoted>"[ρ,p,α,P,leq,o]"</span> <span class=keyword2><span class=keyword>tgt</span></span> <span class=quoted>"[ρ,p,x,α,P,leq,o]"</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>renpbdy_fn</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>renpbdy_fn</span><span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>≡</span> sum<span class=main>(</span>renpbdy1_fn<span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>6</span><span class=main>,</span><span class=main>7</span><span class=main>,</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>renpbdy</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>renpbdy</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>=</span> ren<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>6</span><span class=main>#+</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>7</span><span class=main>#+</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span>renpbdy_fn<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Replacement_Axiom-renpbdy_type><span class=command>lemma</span></span>
  renpbdy_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> renpbdy<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renpbdy_def renpbdy_fn_def renpbdy1_fn_def
  <span class=keyword1><span class=command>using</span></span>  renpbdy1_thm<span class=main>(</span>1<span class=main>)</span> ren_tc
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-arity_renpbdy><span class=command>lemma</span></span>  arity_renpbdy<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> arity<span class=main>(</span>renpbdy<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>7</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renpbdy_def renpbdy_fn_def renpbdy1_fn_def
  <span class=keyword1><span class=command>using</span></span>  renpbdy1_thm<span class=main>(</span>1<span class=main>)</span> arity_ren
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-sats_renpbdy><span class=command>lemma</span></span>
  sats_renpbdy<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>[</span><span class=free>ρ</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>π</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span>
       sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span> <span class=main>[</span><span class=free>ρ</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> renpbdy<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=free>ρ</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renpbdy_def renpbdy_fn_def renpbdy1_fn_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sats_iff_sats_ren<span class=main><span class=keyword3>,</span></span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> renpbdy1_thm<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>M</span></span><span class=main><span class=main>,</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span>
                                            renpbdy1_thm<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>,</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> α<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>α</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> x<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>x</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>


<span class=keyword1><span class=command>rename</span></span> <span class=quoted>"renbody1"</span> <span class=keyword2><span class=keyword>src</span></span> <span class=quoted>"[x,α,P,leq,o]"</span> <span class=keyword2><span class=keyword>tgt</span></span> <span class=quoted>"[α,x,m,P,leq,o]"</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>renbody_fn</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>renbody_fn</span><span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>≡</span> sum<span class=main>(</span>renbody1_fn<span class=main>,</span>id<span class=main>(</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=main>5</span><span class=main>,</span><span class=main>6</span><span class=main>,</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>renbody</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>renbody</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>=</span> ren<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>5</span><span class=main>#+</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span><span class=main>(</span><span class=main>6</span><span class=main>#+</span>length<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>`</span>renbody_fn<span class=main>(</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Replacement_Axiom-renbody_type><span class=command>lemma</span></span>
  renbody_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> renbody<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renbody_def renbody_fn_def renbody1_fn_def
  <span class=keyword1><span class=command>using</span></span>  renbody1_thm<span class=main>(</span>1<span class=main>)</span> ren_tc
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-arity_renbody><span class=command>lemma</span></span>  arity_renbody<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span>
  arity<span class=main>(</span>renbody<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renbody_def renbody_fn_def renbody1_fn_def
  <span class=keyword1><span class=command>using</span></span>  renbody1_thm<span class=main>(</span>1<span class=main>)</span> arity_ren
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-sats_renbody><span class=command>lemma</span></span>
  sats_renbody<span class=main>:</span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span>
       sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span> <span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span> renbody<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span> <span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>o</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> renbody_def renbody_fn_def renbody1_fn_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> sats_iff_sats_ren<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>renbody1_thm<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>M</span></span><span class=main><span class=main>,</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span>
                                            renbody1_thm<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> α<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>α</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword><span class=quasi_keyword>and</span></span></span></span> m<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=free>m</span></span><span class=main><span class=main>,</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>context</span></span> G_generic
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Replacement_Axiom-pow_inter_M><span class=command>lemma</span></span> pow_inter_M<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"powerset<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> Pow<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>∩</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>schematic_goal</span></span> sats_prebody_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>ρ</span><span class=main>,</span><span class=free>π</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>α</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>V</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_Vset<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=bound>V</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>τ</span><span class=main>∈</span><span class=bound>V</span> <span class=main>∧</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=free>ρ</span><span class=main>,</span><span class=bound>τ</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span><span class=main>)</span>
   <span class=main>⟷</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=var>?prebody_fm</span><span class=main>,</span><span class=main>[</span><span class=free>ρ</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>insert</span> assms<span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules is_Vset_iff_sats<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ _ _ _ nonempty<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span> <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules is_Vset_iff_sats is_Vset_iff_sats<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ _ _ _ nonempty<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main><span class=main>]</span></span> <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>rule</span> nonempty<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
       <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>rule</span> length_type<span class=main><span class=main>[</span></span><span class=operator>THEN</span> nat_into_Ord<span class=main><span class=main>]</span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
       <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
     <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>rule</span> renrep_sats<span class=main><span class=main>[</span></span><span class=operator>simplified</span><span class=main><span class=main>]</span></span><span class=main>)</span>
       <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>insert</span> assms<span class=main>)</span>
       <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> renrep_type definability<span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>succ<span class=main>(</span>length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> arity_forces_le <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>(* The formula synthesized above *)</span>
<span class=keyword1><span class=command>synthesize_notc</span></span> <span class=quoted>"prebody_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> sats_prebody_fm_auto

<span class=keyword1 id=Replacement_Axiom-prebody_fm_type><span class=command>lemma</span></span> prebody_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"renrep<span class=main>(</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> prebody_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemmas</span></span> new_fm_defs <span class=main>=</span> fm_defs is_transrec_fm_def is_eclose_fm_def mem_eclose_fm_def
  finite_ordinal_fm_def is_wfrec_fm_def  Memrel_fm_def eclose_n_fm_def is_recfun_fm_def is_iterates_fm_def
  iterates_MH_fm_def is_nat_case_fm_def quasinat_fm_def pre_image_fm_def restriction_fm_def

<span class=keyword1 id=Replacement_Axiom-sats_prebody_fm><span class=command>lemma</span></span> sats_prebody_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>ρ</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>ρ</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span>
     <span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>V</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_Vset<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=bound>V</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>τ</span><span class=main>∈</span><span class=bound>V</span> <span class=main>∧</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>p</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=free>ρ</span><span class=main>,</span><span class=bound>τ</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> prebody_fm_def <span class=keyword1><span class=command>using</span></span> assms sats_prebody_fm_auto <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>


<span class=keyword1 id=Replacement_Axiom-arity_prebody_fm><span class=command>lemma</span></span> arity_prebody_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>≤</span><span class=main>6</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> prebody_fm_def is_HVfrom_fm_def is_powapply_fm_def
  <span class=keyword1><span class=command>using</span></span> assms new_fm_defs nat_simp_union
    arity_renrep<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"forces<span class=main>(</span><span class=free>φ</span><span class=main>)</span>"</span></span><span class=main>]</span> arity_forces_le<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span> pred_le <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>body_fm'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span><span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>body_fm'</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>renpbdy<span class=main>(</span>prebody_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id="Replacement_Axiom-body_fm'_type"><span class=command>lemma</span></span> body_fm'_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span> <span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> body_fm'<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> body_fm'_def <span class=keyword1><span class=command>using</span></span> prebody_fm_type
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id="Replacement_Axiom-arity_body_fm'"><span class=command>lemma</span></span> arity_body_fm'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span>body_fm'<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>≤</span><span class=main>5</span>  <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> body_fm'_def
  <span class=keyword1><span class=command>using</span></span> assms new_fm_defs nat_simp_union arity_prebody_fm pred_le  arity_renpbdy<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id="Replacement_Axiom-sats_body_fm'"><span class=command>lemma</span></span> sats_body_fm'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=free>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=free>p</span><span class=main>,</span><span class=free>ρ</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>body_fm'<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span>
     sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>renpbdy<span class=main>(</span>prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span>fst<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fst_snd_closed<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> body_fm'_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>body_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>]</span><span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>body_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span> <span class=main>≡</span> renbody<span class=main>(</span>body_fm'<span class=main>(</span><span class=free><span class=bound><span class=entity>φ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>env</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Replacement_Axiom-body_fm_type><span class=command>lemma</span></span> body_fm_type <span class=main>[</span><span class=operator>TC</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>φ</span><span class=main>∈</span>formula <span class=main>⟹</span>  body_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> body_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Replacement_Axiom-sats_body_fm><span class=command>lemma</span></span> sats_body_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=free>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>body_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span>
     sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>renpbdy<span class=main>(</span>prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span>fst<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sats_body_fm' sats_renbody<span class=main>[</span><span class=operator>OF</span> _ assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span> arity_body_fm'
  <span class=keyword1><span class=command>unfolding</span></span> body_fm_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Replacement_Axiom-sats_renpbdy_prebody_fm><span class=command>lemma</span></span> sats_renpbdy_prebody_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=free>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>renpbdy<span class=main>(</span>prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span>fst<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span>
     sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>prebody_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span>fst<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span>snd<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fst_snd_closed<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main>]</span>
    sats_renpbdy<span class=main>[</span><span class=operator>OF</span> arity_prebody_fm _ prebody_fm_type<span class=main>,</span> <span class=operator>of</span> <span class=quasi_keyword>concl</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>M</span></span><span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1 id=Replacement_Axiom-body_lemma><span class=command>lemma</span></span> body_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=free>x</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>x</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span> <span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>nenv</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>body_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=free>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=free>α</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=free>nenv</span><span class=main>)</span> <span class=main>⟷</span>
  <span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>V</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_Vset<span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>,</span><span class=free>α</span><span class=main>,</span><span class=bound>V</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>τ</span> <span class=main>∈</span> <span class=bound>V</span> <span class=main>∧</span> <span class=main>(</span>snd<span class=main>(</span><span class=free>x</span><span class=main>)</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span>fst<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=bound>τ</span><span class=main>]</span><span class=main>@</span><span class=free>nenv</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sats_body_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>α</span></span> <span class=quoted><span class=free>m</span></span> <span class=quoted><span class=free>nenv</span></span><span class=main>]</span> sats_renpbdy_prebody_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>α</span></span><span class=main>]</span>
    sats_prebody_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"snd<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fst<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span><span class=main>]</span> fst_snd_closed<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>x</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main><span class=keyword3>,</span></span><span class=operator>simp</span><span class=main>)</span>

<span class=keyword1 id=Replacement_Axiom-Replace_sats_in_MG><span class=command>lemma</span></span> Replace_sats_in_MG<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span> <span class=main>∈</span> formula"</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=free>c</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span> <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>v</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>,</span> <span class=bound>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=bound>v</span> <span class=main>.</span> <span class=bound>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>π'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π'</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>π'</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>π'</span><span class=main>)</span><span class=main>×</span><span class=free>P</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> cartprod_closed P_in_M domain_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>π'</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>c</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?π</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_val<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span> <span class=var><span class=quoted><span class=var>?π</span></span></span><span class=main>]</span> one_in_P one_in_G<span class=main>[</span><span class=operator>OF</span> generic<span class=main>]</span> elem_of_val
      domain_of_prod<span class=main>[</span><span class=operator>OF</span> one_in_P<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>π'</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>nenv</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>=</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_val <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span> <span class=main>≡</span> <span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=bound>α</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>τ</span> <span class=main>∈</span> Vset<span class=main>(</span><span class=bound>α</span><span class=main>)</span> <span class=main>∧</span>
        <span class=main>(</span>snd<span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span>fst<span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>,</span><span class=bound>τ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>≡</span> <span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=var>?P</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=bound>α</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>V</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_Vset<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>α</span><span class=main>,</span><span class=bound>V</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>τ</span><span class=main>∈</span><span class=bound>V</span> <span class=main>∧</span>
        <span class=main>(</span>snd<span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span>fst<span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>,</span><span class=bound>τ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=bound>α</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
    <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>using</span></span> Vset_abs Vset_closed Ord_Least_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>α</span><span class=main>.</span> <span class=bound>α</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>setclass_iff<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
    <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>using</span></span> Least_closed<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>α</span><span class=main>.</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span><span class=main>,</span><span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
    <span class=keyword1><span class=command>using</span></span> least_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>α</span><span class=main>.</span> <span class=bound>α</span><span class=main>∈</span><span class=free>M</span> <span class=main>∧</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span>"</span></span><span class=main>]</span> least_conj
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span> <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>QQ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>QQ</span><span class=main>≡</span><span class=var>?Q</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> 1
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>α</span><span class=main>.</span> <span class=skolem>QQ</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span><span class=main>,</span><span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
    <span class=keyword1><span class=command>unfolding</span></span> QQ_def <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=var>?π</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>t</span> <span class=bound>p</span><span class=main>.</span> <span class=skolem>ρp</span><span class=main>=</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> body<span class=main>:</span><span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>α</span><span class=main>,</span><span class=skolem>ρp</span><span class=main>,</span><span class=skolem>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> body_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span> <span class=main>⟷</span> <span class=var>?Q</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>,</span><span class=skolem>α</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=var>?π</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>α</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>α</span> <span class=skolem>ρp</span> <span class=skolem>m</span>
    <span class=keyword1><span class=command>using</span></span> that P_in_M leq_in_M one_in_M body_lemma<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>ρp</span></span> <span class=quoted><span class=skolem>α</span></span> <span class=quoted><span class=skolem>m</span></span> <span class=quoted><span class=skolem>nenv</span></span> <span class=quoted><span class=free>φ</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f_fm</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"least_fm<span class=main>(</span>body_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span><span class=main>,</span><span class=main>1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ρp</span> <span class=skolem>m</span>
    <span class=keyword3><span class=command>assume</span></span> asm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=var>?π</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>note</span></span> inM <span class=main>=</span> this P_in_M leq_in_M one_in_M <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>with</span></span> body
    <span class=keyword1><span class=command>have</span></span> body'<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>α</span><span class=main>.</span> <span class=bound>α</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∃</span><span class=bound>τ</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>V</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_Vset<span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>,</span> <span class=bound>α</span><span class=main>,</span> <span class=bound>V</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>τ</span> <span class=main>∈</span> <span class=bound>V</span> <span class=main>∧</span>
          <span class=main>(</span>snd<span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span>fst<span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>,</span><span class=bound>τ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span>
          <span class=free>M</span><span class=main>,</span> Cons<span class=main>(</span><span class=bound>α</span><span class=main>,</span> <span class=main>[</span><span class=skolem>ρp</span><span class=main>,</span> <span class=skolem>m</span><span class=main>,</span> <span class=free>P</span><span class=main>,</span> <span class=free>leq</span><span class=main>,</span> <span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span> <span class=main>⊨</span> body_fm<span class=main>(</span><span class=free>φ</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>from</span></span> inM
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>,</span> <span class=main>[</span><span class=skolem>ρp</span><span class=main>,</span><span class=skolem>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?f_fm</span> <span class=main>⟷</span> least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=skolem>QQ</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>,</span> <span class=skolem>m</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> sats_least_fm<span class=main>[</span><span class=operator>OF</span> body'<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=main>1</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> QQ_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=skolem>ρp</span><span class=main>,</span><span class=skolem>m</span><span class=main>,</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span> <span class=main>⊨</span> <span class=var>?f_fm</span> <span class=main>⟷</span> least<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=skolem>QQ</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>,</span> <span class=skolem>m</span><span class=main>)</span>"</span></span>
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=var>?π</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span> <span class=skolem>m</span> <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=var>?π</span><span class=main>,</span> <span class=main>λ</span><span class=bound>ρp</span> <span class=bound>m</span><span class=main>.</span> <span class=free>M</span> <span class=main>,</span> <span class=main>[</span><span class=bound>ρp</span><span class=main>,</span><span class=bound>m</span><span class=main>]</span> <span class=main>@</span> <span class=main>(</span><span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span> <span class=main>⊨</span> <span class=var>?f_fm</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> univalent_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>unique_least<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>=</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>∈</span> <span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length<span class=main>(</span><span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span> <span class=main>=</span> <span class=main>3</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span>›</span></span>
    <span class=quoted><span class=quoted>‹length<span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>=</span> length<span class=main>(</span><span class=main>_</span><span class=main>)</span>›</span></span><span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?f_fm</span><span class=main>)</span> <span class=main>≤</span> <span class=main>5</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> body_fm_def  new_fm_defs least_fm_def
    <span class=keyword1><span class=command>using</span></span> arity_forces arity_renrep arity_renbody arity_body_fm' nonempty
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> pred_Un Un_assoc<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Un_assoc<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> nat_union_abs1 pred_Un<span class=main>)</span>
      <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> nat_simp_union<span class=main><span class=keyword3>,</span></span> <span class=operator>rule</span> pred_le<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>leI<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span>formula›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f_fm</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> inM <span class=main>=</span> P_in_M leq_in_M one_in_M <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>Y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>Y</span><span class=main>∈</span><span class=free>M</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>m</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>m</span> <span class=main>∈</span> <span class=skolem>Y</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>ρp</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>ρp</span> <span class=main>∈</span> <span class=var>?π</span> <span class=main>∧</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>ρp</span><span class=main>,</span><span class=bound>m</span><span class=main>]</span> <span class=main>@</span> <span class=main>(</span><span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span> <span class=main>⊨</span> <span class=var>?f_fm</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?f_fm</span></span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>P</span><span class=main>,</span><span class=free>leq</span><span class=main>,</span><span class=free>one</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>unfolding</span></span> strong_replacement_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹least<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=skolem>QQ</span><span class=main>(</span><span class=main>_</span><span class=main>)</span><span class=main>,</span><span class=skolem>f</span><span class=main>(</span><span class=main>_</span><span class=main>)</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>(</span><span class=main>_</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=quoted><span class=quoted>‹<span class=main>_</span> <span class=main>⟹</span> <span class=main>_</span> <span class=main>⟹</span> <span class=main>_</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>,</span><span class=main>_</span> <span class=main>⊨</span> <span class=var>?f_fm</span> <span class=main>⟷</span> least<span class=main>(</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>(</span><span class=skolem>ρp</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Y</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρp</span><span class=main>∈</span><span class=var>?π</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>ρp</span>
    <span class=keyword1><span class=command>using</span></span> that transitivity<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=var>?π</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>clarsimp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=improper>x</span><span class=main>,</span><span class=improper>y</span><span class=main>⟩</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> bexI<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>Y</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>Y</span><span class=main>∈</span><span class=free>M</span>›</span></span> separation_ax sats_ordinal_fm trans_M
      separation_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>y</span><span class=main>.</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>ordinal_fm<span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>y</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord"</span></span><span class=main>]</span>
      separation_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=main>{</span><span class=bound>y</span><span class=main>∈</span><span class=skolem>Y</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?sup</span> <span class=main>∈</span> <span class=free>M</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> Union_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vset<span class=main>(</span><span class=var>?sup</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>M</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Vset_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>one</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> one_in_M singletonM <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vset<span class=main>(</span><span class=var>?sup</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>M</span><span class=main>}</span> <span class=main>×</span> <span class=main>{</span><span class=free>one</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?big_name</span> <span class=main>∈</span> <span class=free>M</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> cartprod_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?big_name</span><span class=main>)</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>GenExtI<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>π'</span><span class=main>)</span><span class=main>=</span><span class=free>c</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>π'</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ρ</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π'</span>"</span></span>  <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ρ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem_of_val_pair'<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>π'</span></span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>v</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>=</span> <span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>σ</span><span class=main>]</span><span class=main>@</span><span class=skolem>nenv</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> truth_lemma<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> generic<span class=main>,</span> <span class=operator>symmetric</span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>σ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>p</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>π'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>∈</span><span class=var>?π</span> <span class=main>⟹</span> <span class=skolem>f</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Y</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> generic <span class=keyword1><span class=command>unfolding</span></span> M_generic_def filter_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?α</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"succ<span class=main>(</span>rank<span class=main>(</span><span class=skolem>σ</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>σ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?α</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> rank_closed cons_closed <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>σ</span> <span class=main>∈</span> Vset<span class=main>(</span><span class=var>?α</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Vset_Ord_rank_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>σ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>,</span><span class=var>?α</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> Vset_rank_iff<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>μ</span> <span class=bound>α</span><span class=main>.</span> <span class=var>?P</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>f</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>τ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span> <span class=main>∈</span> Vset<span class=main>(</span><span class=skolem>f</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊩</span> <span class=free>φ</span> <span class=main>(</span><span class=main>[</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>τ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> LeastI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>α</span><span class=main>.</span> <span class=var>?P</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>,</span><span class=bound>α</span><span class=main>)</span>"</span></span> <span class=var><span class=quoted><span class=var>?α</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>q</span><span class=main>∈</span><span class=free>G</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>ρ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>nenv</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=skolem>nenv</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>τ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span><span class=main>)</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> truth_lemma<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> generic<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>τ</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>nenv</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>⊨</span> <span class=free>φ</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span> <span class=main>=</span> map<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>)</span><span class=main>,</span><span class=skolem>nenv</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>ρ</span><span class=main>)</span><span class=main>=</span><span class=skolem>x</span>›</span></span>
      <span class=quoted><span class=quoted>‹univalent<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> GenExtI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>τ</span></span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> univalent_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span> <span class=main>∈</span> Vset<span class=main>(</span><span class=skolem>f</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>)</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=skolem>f</span><span class=main>(</span><span class=main>_</span><span class=main>)</span><span class=main>)</span>›</span></span>  <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>(</span><span class=main>⟨</span><span class=skolem>ρ</span><span class=main>,</span><span class=skolem>q</span><span class=main>⟩</span><span class=main>)</span><span class=main>∈</span><span class=skolem>Y</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span> <span class=main>∈</span> Vset<span class=main>(</span><span class=var>?sup</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Vset_Ord_rank_iff lt_Union_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?big_name</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> domain_of_prod<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>one</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>one</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vset<span class=main>(</span><span class=var>?sup</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>M</span><span class=main>}</span>"</span></span> <span class=main>]</span> def_val<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span> <span class=var><span class=quoted><span class=var>?big_name</span></span></span><span class=main>]</span>
        one_in_G<span class=main>[</span><span class=operator>OF</span> generic<span class=main>]</span> one_in_P  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> Vset_rank_iff<span class=main>)</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span><span class=main>=</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=bound>x</span><span class=main>∈</span>Vset<span class=main>(</span><span class=var>?sup</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>M</span><span class=main>}</span> <span class=main>×</span> <span class=main>{</span><span class=free>one</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>v</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>,</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>)</span><span class=main>}</span> <span class=main>⊆</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?big_name</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?repl</span><span class=main>⊆</span><span class=var>?big</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?big_name</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?repl</span> <span class=main>=</span> <span class=main>{</span><span class=bound>v</span><span class=main>∈</span><span class=var>?big</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=free>φ</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>)</span><span class=main>}</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> <span class=var>?rhs</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>intro</span> equalityI subsetI<span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=var>?repl</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?repl</span><span class=main>⊆</span><span class=var>?big</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=var>?big</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> subsetD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹univalent<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?rhs</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> univalent_def
      <span class=keyword1><span class=command>using</span></span> transitivity_MG ReplaceI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=bound>v</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=var>?rhs</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=var>?big_name</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> transitivity_MG GenExtI<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=var>?big_name</span><span class=main>∈</span><span class=main>_</span>›</span></span><span class=main>,</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=quoted><span class=quoted>‹univalent<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?R</span><span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>y</span> <span class=main>=</span> <span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
      <span class=keyword1><span class=command>unfolding</span></span> univalent_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=var>?repl</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> ReplaceI<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?R</span></span></span> <span class=quoted><span class=skolem>x</span></span> <span class=quoted><span class=skolem>v</span></span> <span class=quoted><span class=free>c</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ψ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span><span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?ψ</span><span class=main>∈</span>formula"</span></span>
    <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>v</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>#+</span><span class=main>1</span><span class=main>,</span><span class=main>[</span><span class=skolem>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>@</span><span class=main>[</span><span class=free>c</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span>  <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span>nth_concat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>v</span></span> <span class=quoted><span class=free>c</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=free>env</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>note</span></span> inMG<span class=main>=</span> <span class=quoted><span class=quoted>‹nth<span class=main>(</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>#+</span><span class=main>1</span><span class=main>,</span><span class=main>[</span><span class=skolem>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>@</span><span class=main>[</span><span class=free>c</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=free>c</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>)</span> <span class=main>⟷</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?ψ</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> transitivity_MG<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>2</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> inMG
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>c</span><span class=main>]</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> Exists<span class=main>(</span>And<span class=main>(</span>Member<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span><span class=main>)</span><span class=main>,</span> <span class=free>φ</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>with</span></span> inMG
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>c</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span><span class=main>@</span><span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>2</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span> inMG
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=skolem>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>⊨</span> <span class=free>φ</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> arity_sats_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>φ</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>c</span><span class=main>]</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>v</span><span class=main>]</span><span class=main>@</span><span class=free>env</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=var>?ψ</span><span class=main>)</span><span class=main>≤</span><span class=main>2</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> pred_mono<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span><span class=main>≤</span><span class=main>2</span><span class=main>#+</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>›</span></span><span class=main>]</span> lt_trans<span class=main>[</span><span class=operator>OF</span> _ le_refl<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>φ</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?ψ</span><span class=main>∈</span>formula"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>v</span><span class=main>∈</span><span class=var>?big</span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>c</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>v</span><span class=main>∈</span><span class=var>?big</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span>  <span class=var>?ψ</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> transitivity_MG<span class=main>[</span><span class=operator>OF</span> _ GenExtI<span class=main>,</span> <span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=var>?big_name</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>‹<span class=free>env</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>c</span><span class=main>∈</span><span class=main>_</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?big</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>v</span><span class=main>∈</span><span class=var>?big</span><span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>,</span> <span class=main>[</span><span class=bound>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>@</span> <span class=main>[</span><span class=free>c</span><span class=main>]</span> <span class=main>⊨</span> <span class=var>?ψ</span><span class=main>}</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_sats_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>theorem</span></span> strong_replacement_in_MG<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>φ</span><span class=main>∈</span>formula"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>φ</span><span class=main>)</span> <span class=main>≤</span> <span class=main>2</span> <span class=main>#+</span> length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>v</span><span class=main>.</span> sats<span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span><span class=free>φ</span><span class=main>,</span><span class=main>[</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span> <span class=main>.</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>]</span> <span class=main>@</span> <span class=free>env</span> <span class=main>⊨</span> <span class=free>φ</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>A</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Y</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>v</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span><span class=main>,</span> <span class=bound>v</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>v</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>A</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=main>∀</span><span class=bound>z</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>=</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>,</span> <span class=skolem>A</span><span class=main>,</span> <span class=var>?R</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>A</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> univalent_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>with</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>A</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=var>?Y</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Replace_sats_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?Y</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>b</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>b</span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>rule</span><span class=main>)</span>
      <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>A</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?Y</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> that transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?Y</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>b</span><span class=main>)</span>›</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>with</span></span> that
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=skolem>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>b</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this 1 <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=skolem>b</span><span class=main>)</span>›</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>z</span><span class=main>)</span> <span class=main>⟹</span> <span class=skolem>b</span> <span class=main>=</span> <span class=skolem>z</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>ultimately</span></span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> ReplaceI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>b</span> <span class=main>∈</span> <span class=var>?Y</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>(</span><span class=var>?Y</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>(</span><span class=main>∃</span><span class=bound>Y</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=main>∀</span><span class=bound>b</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>b</span> <span class=main>∈</span> <span class=bound>Y</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>].</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>A</span> <span class=main>∧</span> <span class=var>?R</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>b</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> strong_replacement_def univalent_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* context G_generic *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Infinity_Axiom><div class=head><h1>Theory Infinity_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Infinity in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Infinity_Axiom
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Pairing_Axiom.html>Pairing_Axiom</a> <a href=Union_Axiom.html>Union_Axiom</a> <a href=Separation_Axiom.html>Separation_Axiom</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> G_generic <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>interpretation</span></span> mg_triv<span class=main>:</span> M_trivial<span class=quoted><span class=quoted>"<span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> transitivity_MG zero_in_MG generic Union_MG pairing_in_MG
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>auto</span>

<span class=keyword1 id=Infinity_Axiom-infinity_in_MG><span class=command>lemma</span></span> infinity_in_MG <span class=main>:</span> <span class=quoted><span class=quoted>"infinity_ax<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> infinity_ax <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>I</span></span> <span class=keyword2><span class=keyword>where</span></span>
    Eq1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∈</span> <span class=skolem>I</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=skolem>I</span> <span class=main>⟶</span> succ<span class=main>(</span><span class=bound>y</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>I</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> infinity_ax_def  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=skolem>I</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> check_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>I</span><span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valcheck generic one_in_G one_in_P GenExtI<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"check<span class=main>(</span><span class=skolem>I</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=skolem>I</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>I</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span>  transitivity<span class=main>[</span><span class=operator>OF</span> _ <span class=quoted><span class=quoted>‹<span class=skolem>I</span><span class=main>∈</span><span class=free>M</span>›</span></span><span class=main>]</span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>I</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span><span class=skolem>y</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>I</span> <span class=main>∩</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>I</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>using</span></span> that Eq1 transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> Eq1 <span class=quoted><span class=quoted>‹<span class=skolem>I</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=main>0</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> infinity_ax_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* G_generic' *)</span>
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Choice_Axiom><div class=head><h1>Theory Choice_Axiom</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The Axiom of Choice in $M[G]$›</span></span>
<span class=keyword1><span class=command>theory</span></span> Choice_Axiom
  <span class=keyword2><span class=keyword>imports</span></span> <a href=Powerset_Axiom.html>Powerset_Axiom</a> <a href=Pairing_Axiom.html>Pairing_Axiom</a> <a href=Union_Axiom.html>Union_Axiom</a> <a href=Extensionality_Axiom.html>Extensionality_Axiom</a> 
          <a href=Foundation_Axiom.html>Foundation_Axiom</a> <a href=Powerset_Axiom.html>Powerset_Axiom</a> <a href=Separation_Axiom.html>Separation_Axiom</a> 
          <a href=Replacement_Axiom.html>Replacement_Axiom</a> <a href=Interface.html>Interface</a> <a href=Infinity_Axiom.html>Infinity_Axiom</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span> 
  <span class=entity>induced_surj</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i<span class=main>⇒</span>i<span class=main>⇒</span>i<span class=main>⇒</span>i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>induced_surj</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>-``</span><span class=main>(</span>range<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>-</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>×</span><span class=main>{</span><span class=free><span class=bound><span class=entity>e</span></span></span><span class=main>}</span> <span class=main>∪</span> restrict<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>-``</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span>"</span></span>
  
<span class=keyword1 id=Choice_Axiom-domain_induced_surj><span class=command>lemma</span></span> domain_induced_surj<span class=main>:</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span>induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> domain<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> induced_surj_def <span class=keyword1><span class=command>using</span></span> domain_restrict domain_of_prod <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    
<span class=keyword1 id=Choice_Axiom-range_restrict_vimage><span class=command>lemma</span></span> range_restrict_vimage<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"function<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"range<span class=main>(</span>restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>a</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"function<span class=main>(</span>restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> function_restrictI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> range<span class=main>(</span>restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> domain_restrict domainI<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=main>_</span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹function<span class=main>(</span>restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span><span class=main>)</span>›</span></span> 
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>=</span> restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span><span class=main>`</span><span class=skolem>x</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> function_apply_equality <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span><span class=main>`</span><span class=skolem>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>=</span><span class=free>f</span><span class=main>`</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span>domain<span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>x</span><span class=main>,</span><span class=free>f</span><span class=main>`</span><span class=skolem>x</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>f</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> function_apply_Pair <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> assms <span class=quoted><span class=quoted>‹<span class=skolem>x</span> <span class=main>∈</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span>›</span></span> 
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> function_image_vimage<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>a</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>
  
<span class=keyword1 id=Choice_Axiom-induced_surj_type><span class=command>lemma</span></span> induced_surj_type<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"function<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> <span class=comment1>(* "relation(f)" (* a function can contain nonpairs *) *)</span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>:</span> domain<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>→</span> <span class=main>{</span><span class=free>e</span><span class=main>}</span> <span class=main>∪</span> <span class=free>a</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span> <span class=main>⟹</span> induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>`</span><span class=free>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=free>x</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>-``</span><span class=main>(</span>range<span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>-</span><span class=free>a</span><span class=main>)</span> <span class=main>×</span> <span class=main>{</span><span class=free>e</span><span class=main>}</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=var><span class=quoted><span class=var>?f2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=var>?f2</span><span class=main>)</span> <span class=main>=</span> domain<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>∩</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> domain_restrict <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=var>?f1</span><span class=main>)</span> <span class=main>=</span> <span class=free>f</span><span class=main>-``</span><span class=main>(</span>range<span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>)</span><span class=main>-</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> domain_of_prod function_vimage_Diff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=var>?f1</span><span class=main>)</span> <span class=main>∩</span> domain<span class=main>(</span><span class=var>?f2</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"function<span class=main>(</span><span class=var>?f1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"relation<span class=main>(</span><span class=var>?f1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"range<span class=main>(</span><span class=var>?f1</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span><span class=free>e</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> function_def relation_def range_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f1</span><span class=main>:</span> domain<span class=main>(</span><span class=var>?f1</span><span class=main>)</span> <span class=main>→</span> range<span class=main>(</span><span class=var>?f1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> function_imp_Pi <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f2</span><span class=main>:</span> domain<span class=main>(</span><span class=var>?f2</span><span class=main>)</span> <span class=main>→</span> range<span class=main>(</span><span class=var>?f2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> function_imp_Pi<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"restrict<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>f</span> <span class=main>-``</span> <span class=free>a</span><span class=main>)</span>"</span></span><span class=main>]</span> function_restrictI <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"range<span class=main>(</span><span class=var>?f2</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>a</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> range_restrict_vimage <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>:</span> domain<span class=main>(</span><span class=var>?f1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=var>?f2</span><span class=main>)</span> <span class=main>→</span> <span class=main>{</span><span class=free>e</span><span class=main>}</span> <span class=main>∪</span> <span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> induced_surj_def <span class=keyword1><span class=command>using</span></span> fun_is_function fun_disjoint_Un fun_weaken_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=var>?f1</span><span class=main>)</span> <span class=main>∪</span> domain<span class=main>(</span><span class=var>?f2</span><span class=main>)</span> <span class=main>=</span> domain<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> domain_restrict domain_of_prod <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>:</span> domain<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>→</span> <span class=main>{</span><span class=free>e</span><span class=main>}</span> <span class=main>∪</span> <span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f2</span><span class=main>`</span><span class=free>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=free>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> restrict <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>x</span> <span class=main>∈</span> <span class=free>f</span><span class=main>-``</span><span class=free>a</span>›</span></span> <span class=keyword2><span class=keyword>and</span></span> 1 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∉</span> domain<span class=main>(</span><span class=var>?f1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>`</span><span class=free>x</span> <span class=main>=</span> <span class=free>f</span><span class=main>`</span><span class=free>x</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> induced_surj_def <span class=keyword1><span class=command>using</span></span> fun_disjoint_apply2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>x</span></span> <span class=var><span class=quoted><span class=var>?f1</span></span></span> <span class=var><span class=quoted><span class=var>?f2</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>
  
<span class=keyword1 id=Choice_Axiom-induced_surj_is_surj><span class=command>lemma</span></span> induced_surj_is_surj <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>e</span><span class=main>∈</span><span class=free>a</span>"</span></span> <span class=quoted><span class=quoted>"function<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>=</span> <span class=free>α</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>a</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>α</span><span class=main>.</span> <span class=free>f</span> <span class=main>`</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span> <span class=main>∈</span> surj<span class=main>(</span><span class=free>α</span><span class=main>,</span><span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> surj_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>intro</span> CollectI ballI<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> assms 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>:</span> <span class=free>α</span> <span class=main>→</span> <span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> induced_surj_type<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free><span class=quoted><span class=free>f</span></span></span></span> <span class=quoted><span class=free><span class=quoted><span class=free>a</span></span></span></span> <span class=quoted><span class=free><span class=quoted><span class=free>e</span></span></span></span><span class=main>]</span> cons_eq cons_absorb <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=free>a</span>"</span></span>
  <span class=keyword1><span class=command>with</span></span> assms 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>α</span><span class=main>.</span> <span class=free>f</span> <span class=main>`</span> <span class=bound>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>α</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>`</span> <span class=skolem>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span><span class=main>∈</span><span class=free>a</span>›</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>f</span><span class=main>-``</span><span class=free>a</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> vimage_iff function_apply_Pair<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=skolem>x</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span> <span class=main>`</span> <span class=skolem>x</span> <span class=main>=</span> <span class=skolem>y</span>›</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> induced_surj_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>α</span>›</span></span> <span class=keyword3><span class=command>show</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=free>α</span><span class=main>.</span> induced_surj<span class=main>(</span><span class=free>f</span><span class=main>,</span> <span class=free>a</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>`</span> <span class=bound>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>
  
<span class=keyword1><span class=command>context</span></span> G_generic 
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>upair_name</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>upair_name</span><span class=main>(</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>ρ</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=main>⟨</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>,</span><span class=main>⟨</span><span class=free><span class=bound><span class=entity>ρ</span></span></span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_upair_name</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_upair_name</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>xo</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>yo</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=bound>xo</span><span class=main>)</span> <span class=main>∧</span> pair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free>one</span><span class=main>,</span><span class=bound>yo</span><span class=main>)</span> <span class=main>∧</span> 
                                       upair<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>xo</span><span class=main>,</span><span class=bound>yo</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Choice_Axiom-upair_name_abs><span class=command>lemma</span></span> upair_name_abs <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_upair_name<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>z</span> <span class=main>=</span> upair_name<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> is_upair_name_def upair_name_def <span class=keyword1><span class=command>using</span></span> assms one_in_M pair_in_M_iff <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-upair_name_closed><span class=command>lemma</span></span> upair_name_closed <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> upair_name<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> upair_name_def <span class=keyword1><span class=command>using</span></span> upair_in_M_iff pair_in_M_iff one_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>upair_name_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>upair_name_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
                                          And<span class=main>(</span>pair_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>upair_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 

<span class=keyword1 id=Choice_Axiom-upair_name_fm_type><span class=command>lemma</span></span> upair_name_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>s</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>y</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>o</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> upair_name_fm<span class=main>(</span><span class=free>s</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>o</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> upair_name_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-sats_upair_name_fm><span class=command>lemma</span></span> sats_upair_name_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>o</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>o</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>one</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>upair_name_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_upair_name<span class=main>(</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> upair_name_fm_def is_upair_name_def <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>opair_name</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>opair_name</span><span class=main>(</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>ρ</span></span></span><span class=main>)</span> <span class=main>≡</span> upair_name<span class=main>(</span>upair_name<span class=main>(</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>)</span><span class=main>,</span>upair_name<span class=main>(</span><span class=free><span class=bound><span class=entity>τ</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>ρ</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_opair_name</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_opair_name</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>upxx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>upxy</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_upair_name<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>upxx</span><span class=main>)</span> <span class=main>∧</span> is_upair_name<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=bound>upxy</span><span class=main>)</span>
                                          <span class=main>∧</span> is_upair_name<span class=main>(</span><span class=bound>upxx</span><span class=main>,</span><span class=bound>upxy</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span>"</span></span> 

<span class=keyword1 id=Choice_Axiom-opair_name_abs><span class=command>lemma</span></span> opair_name_abs <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_opair_name<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>z</span> <span class=main>=</span> opair_name<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> is_opair_name_def opair_name_def <span class=keyword1><span class=command>using</span></span> assms upair_name_abs upair_name_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-opair_name_closed><span class=command>lemma</span></span> opair_name_closed <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>x</span><span class=main>∈</span><span class=free>M</span><span class=main>;</span> <span class=free>y</span><span class=main>∈</span><span class=free>M</span> <span class=main>⟧</span> <span class=main>⟹</span> opair_name<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> opair_name_def <span class=keyword1><span class=command>using</span></span> upair_name_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>opair_name_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>opair_name_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>upair_name_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
                    And<span class=main>(</span>upair_name_fm<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>upair_name_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>,</span><span class=free><span class=bound><span class=entity>z</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 

<span class=keyword1 id=Choice_Axiom-opair_name_fm_type><span class=command>lemma</span></span> opair_name_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>s</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>y</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>o</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> opair_name_fm<span class=main>(</span><span class=free>s</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>o</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> opair_name_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-sats_opair_name_fm><span class=command>lemma</span></span> sats_opair_name_fm <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>o</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span><span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>o</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>one</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>opair_name_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>o</span><span class=main>,</span><span class=free>z</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_opair_name<span class=main>(</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> opair_name_fm_def is_opair_name_def <span class=keyword1><span class=command>using</span></span> assms sats_upair_name_fm <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-val_upair_name><span class=command>lemma</span></span> val_upair_name <span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span>upair_name<span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> upair_name_def <span class=keyword1><span class=command>using</span></span> val_Upair  generic one_in_G one_in_P <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    
<span class=keyword1 id=Choice_Axiom-val_opair_name><span class=command>lemma</span></span> val_opair_name <span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span>opair_name<span class=main>(</span><span class=free>τ</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>⟨</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>τ</span><span class=main>)</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>ρ</span><span class=main>)</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> opair_name_def Pair_def <span class=keyword1><span class=command>using</span></span> val_upair_name  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    
<span class=keyword1 id=Choice_Axiom-val_RepFun_one><span class=command>lemma</span></span> val_RepFun_one<span class=main>:</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=main>⟨</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>a</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>a</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>a</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>p</span> <span class=main>=</span> <span class=free>one</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>one</span> <span class=main>∈</span> <span class=free>P</span><span class=main>∩</span><span class=free>G</span>"</span></span> <span class=keyword1><span class=command>using</span></span> generic one_in_G one_in_P <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>⟨</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>a</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span><span class=bound>t</span> <span class=main>∈</span> <span class=var>?A</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> <span class=var>?Q</span><span class=main>(</span><span class=bound>t</span><span class=main>)</span><span class=main>}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> one_in_P <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=main>⟨</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span>  <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>a</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=main>{</span><span class=bound>t</span> <span class=main>∈</span> <span class=var>?A</span> <span class=main>×</span> <span class=free>P</span> <span class=main>.</span> <span class=var>?Q</span><span class=main>(</span><span class=bound>t</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>..</span> <span class=bound><span class=bound>t</span></span> <span class=main>∈</span> <span class=var>?A</span> <span class=main>,</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span><span class=main>∩</span><span class=free>G</span> <span class=main>.</span> <span class=var>?Q</span><span class=main>(</span><span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> val_of_name_alt <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span> <span class=main>.</span> <span class=bound>t</span> <span class=main>∈</span> <span class=var>?A</span> <span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>one</span><span class=main>∈</span><span class=free>P</span><span class=main>∩</span><span class=free>G</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>also</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>f</span><span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>a</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹$M[G]$ is a transitive model of ZF›</span></span>

<span class=keyword1><span class=command>interpretation</span></span> mgzf<span class=main>:</span> M_ZF_trans <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Transset_MG generic pairing_in_MG Union_MG 
    extensionality_in_MG power_in_MG foundation_in_MG  
    strong_replacement_in_MG separation_in_MG infinity_in_MG
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>simp_all</span>

<span class=comment1>(* y = opair_name(check(β),s`β) *)</span>
<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_opname_check</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_opname_check</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>chx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> <span class=main>∃</span><span class=bound>sx</span><span class=main>∈</span><span class=free>M</span><span class=main>.</span> is_check<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>chx</span><span class=main>)</span> <span class=main>∧</span> fun_apply<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=bound>sx</span><span class=main>)</span> <span class=main>∧</span> 
                             is_opair_name<span class=main>(</span><span class=bound>chx</span><span class=main>,</span><span class=bound>sx</span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span> 

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>opname_check_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>opname_check_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>check_fm<span class=main>(</span><span class=main>2</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=main>2</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=main>1</span><span class=main>)</span><span class=main>,</span>
                              And<span class=main>(</span>fun_apply_fm<span class=main>(</span><span class=main>2</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span><span class=main>2</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>,</span>opair_name_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>2</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>o</span></span></span><span class=main>,</span><span class=main>2</span><span class=main>#+</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Choice_Axiom-opname_check_fm_type><span class=command>lemma</span></span> opname_check_fm_type<span class=main>[</span><span class=operator>TC</span><span class=main>]</span> <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=free>s</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>x</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>y</span><span class=main>∈</span>nat<span class=main>;</span><span class=free>o</span><span class=main>∈</span>nat<span class=main>⟧</span> <span class=main>⟹</span> opname_check_fm<span class=main>(</span><span class=free>s</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>o</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> opname_check_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-sats_opname_check_fm><span class=command>lemma</span></span> sats_opname_check_fm<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>z</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>o</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>o</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>=</span><span class=free>one</span>"</span></span> 
          <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>&lt;</span>length<span class=main>(</span><span class=free>env</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>opname_check_fm<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>,</span><span class=free>z</span><span class=main>,</span><span class=free>o</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> is_opname_check<span class=main>(</span>nth<span class=main>(</span><span class=free>x</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>y</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>,</span>nth<span class=main>(</span><span class=free>z</span><span class=main>,</span><span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> opname_check_fm_def is_opname_check_def 
  <span class=keyword1><span class=command>using</span></span> assms sats_check_fm sats_opair_name_fm one_in_M <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=Choice_Axiom-opname_check_abs><span class=command>lemma</span></span> opname_check_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_opname_check<span class=main>(</span><span class=free>s</span><span class=main>,</span><span class=free>x</span><span class=main>,</span><span class=free>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>y</span> <span class=main>=</span> opair_name<span class=main>(</span>check<span class=main>(</span><span class=free>x</span><span class=main>)</span><span class=main>,</span><span class=free>s</span><span class=main>`</span><span class=free>x</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> is_opname_check_def  
  <span class=keyword1><span class=command>using</span></span> assms check_abs check_in_M opair_name_abs apply_abs apply_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Choice_Axiom-repl_opname_check><span class=command>lemma</span></span> repl_opname_check <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span>
   <span class=quoted><span class=quoted>"<span class=main>{</span>opair_name<span class=main>(</span>check<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>,</span><span class=free>f</span><span class=main>`</span><span class=bound>x</span><span class=main>)</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=free>A</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>opname_check_fm<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span><span class=main>=</span> <span class=main>4</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> opname_check_fm_def opair_name_fm_def upair_name_fm_def
          check_fm_def rcheck_fm_def trans_closure_fm_def is_eclose_fm_def mem_eclose_fm_def
         is_Hcheck_fm_def Replace_fm_def PHcheck_fm_def finite_ordinal_fm_def is_iterates_fm_def
             is_wfrec_fm_def is_recfun_fm_def restriction_fm_def pre_image_fm_def eclose_n_fm_def
        is_nat_case_fm_def quasinat_fm_def Memrel_fm_def singleton_fm_def fm_defs iterates_MH_fm_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nat_simp_union<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>A</span> <span class=main>⟹</span> opair_name<span class=main>(</span>check<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>,</span> <span class=free>f</span> <span class=main>`</span> <span class=skolem>x</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> assms opair_name_closed apply_closed transitivity check_in_M
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms opname_check_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span><span class=main>]</span> sats_opname_check_fm
        one_in_M
        Repl_in_M<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"opname_check_fm<span class=main>(</span><span class=main>3</span><span class=main>,</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>one</span><span class=main>,</span><span class=free>f</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"is_opname_check<span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> 
                    <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> opair_name<span class=main>(</span>check<span class=main>(</span><span class=bound>x</span><span class=main>)</span><span class=main>,</span><span class=free>f</span><span class=main>`</span><span class=bound>x</span><span class=main>)</span>"</span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>



<span class=keyword1><span class=command>theorem</span></span> choice_in_MG<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"choice_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"choice_ax<span class=main>(</span><span class=main>##</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>τ</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>a</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> GenExt_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>τ</span><span class=main>∈</span><span class=free>M</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> domain_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>α</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span>surj<span class=main>(</span><span class=skolem>α</span><span class=main>,</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=skolem>α</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>α</span><span class=main>∈</span><span class=free>M</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms choice_ax_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>α</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>         
      <span class=keyword1><span class=command>using</span></span> M_subset_MG generic one_in_G subsetD <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>×</span><span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span>opair_name<span class=main>(</span>check<span class=main>(</span><span class=bound>β</span><span class=main>)</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=bound>β</span><span class=main>)</span><span class=main>.</span> <span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?g</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>s</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>α</span><span class=main>∈</span><span class=free>M</span>›</span></span> repl_opname_check <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f_dot</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>⟨</span>opair_name<span class=main>(</span>check<span class=main>(</span><span class=bound>β</span><span class=main>)</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=bound>β</span><span class=main>)</span><span class=main>,</span><span class=free>one</span><span class=main>⟩</span><span class=main>.</span> <span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f_dot</span> <span class=main>=</span> <span class=var>?g</span> <span class=main>×</span> <span class=main>{</span><span class=free>one</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>from</span></span> one_in_M <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=free>one</span><span class=main>}</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> singletonM <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>≡</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=var>?f_dot</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>{</span><span class=free>one</span><span class=main>}</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?g</span><span class=main>∈</span><span class=free>M</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=var>?f_dot</span> <span class=main>=</span> <span class=var>?g</span><span class=main>×</span><span class=main>{</span><span class=free>one</span><span class=main>}</span>›</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f_dot</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> cartprod_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>GenExtI<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span>opair_name<span class=main>(</span>check<span class=main>(</span><span class=bound>β</span><span class=main>)</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=bound>β</span><span class=main>)</span><span class=main>)</span> <span class=main>.</span> <span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> f_def <span class=keyword1><span class=command>using</span></span> val_RepFun_one <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>=</span> <span class=main>{</span><span class=main>⟨</span><span class=bound>β</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=bound>β</span><span class=main>)</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> val_opair_name valcheck generic one_in_G one_in_P <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>=</span> <span class=main>{</span><span class=main>⟨</span><span class=bound>β</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=bound>β</span><span class=main>)</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>}</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=skolem>f</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>α</span>"</span></span> <span class=quoted><span class=quoted>"function<span class=main>(</span><span class=skolem>f</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> function_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>a</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>x</span><span class=main>∈</span><span class=skolem>α</span><span class=main>.</span> <span class=skolem>f</span> <span class=main>`</span> <span class=bound>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
      <span class=keyword3><span class=command>assume</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>τ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>a</span>›</span></span> 
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>σ</span></span> <span class=keyword2><span class=keyword>where</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>σ</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> elem_of_val<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>y</span></span> <span class=main>_</span> <span class=quoted><span class=skolem>τ</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>s</span><span class=main>∈</span>surj<span class=main>(</span><span class=skolem>α</span><span class=main>,</span>domain<span class=main>(</span><span class=skolem>τ</span><span class=main>)</span><span class=main>)</span>›</span></span> 
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>β</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>β</span><span class=main>∈</span><span class=skolem>α</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>`</span><span class=skolem>β</span> <span class=main>=</span> <span class=skolem>σ</span>"</span></span> 
        <span class=keyword1><span class=command>unfolding</span></span> surj_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>σ</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>y</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=skolem>β</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span> <span class=main>=</span> <span class=main>{</span><span class=main>⟨</span><span class=bound>β</span><span class=main>,</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>s</span><span class=main>`</span><span class=bound>β</span><span class=main>)</span><span class=main>⟩</span> <span class=main>.</span> <span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>}</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>β</span><span class=main>∈</span><span class=skolem>α</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>β</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>f</span>"</span></span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹function<span class=main>(</span><span class=skolem>f</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span><span class=main>`</span><span class=skolem>β</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> function_apply_equality <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>β</span><span class=main>∈</span><span class=skolem>α</span>›</span></span> <span class=keyword3><span class=command>show</span></span>
        <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>β</span><span class=main>∈</span><span class=skolem>α</span><span class=main>.</span> <span class=skolem>f</span> <span class=main>`</span> <span class=bound>β</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>α</span><span class=main>∈</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>f'</span><span class=main>∈</span><span class=main>(</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>α</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>f'</span> <span class=main>∈</span> surj<span class=main>(</span><span class=bound>α</span><span class=main>,</span><span class=skolem>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>=</span><span class=main>0</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span><span class=main>∈</span>surj<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=skolem>a</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>unfolding</span></span> surj_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> zero_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> 
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>e</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>e</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> transitivity_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>with</span></span> 1 <span class=keyword2><span class=keyword>and</span></span> 2
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>e</span><span class=main>)</span> <span class=main>∈</span> surj<span class=main>(</span><span class=skolem>α</span><span class=main>,</span><span class=skolem>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> induced_surj_is_surj <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>a</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>e</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"induced_surj<span class=main>(</span><span class=skolem>f</span><span class=main>,</span><span class=skolem>a</span><span class=main>,</span><span class=skolem>e</span><span class=main>)</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> induced_surj_def 
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>flip</span><span class=main><span class=main>:</span></span> setclass_iff<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>note</span></span>
        <span class=quoted><span class=quoted>‹<span class=skolem>α</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>›</span></span> <span class=quoted><span class=quoted>‹Ord<span class=main>(</span><span class=skolem>α</span><span class=main>)</span>›</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> mgzf.choice_ax_abs <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>
  
<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* G_generic_extra_repl *)</span>
  
<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Ordinals_In_MG><div class=head><h1>Theory Ordinals_In_MG</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Ordinals in generic extensions›</span></span>
<span class=keyword1><span class=command>theory</span></span> Ordinals_In_MG
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Forcing_Theorems.html>Forcing_Theorems</a> <a href=Relative_Univ.html>Relative_Univ</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>context</span></span> G_generic
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Ordinals_In_MG-rank_val><span class=command>lemma</span></span> rank_val<span class=main>:</span> <span class=quoted><span class=quoted>"rank<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>x</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> rank<span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span><span class=main>(</span><span class=free>x</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>ed_induction<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=var><span class=quoted><span class=var><span class=quoted><span class=var>?Q</span></span></span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>u</span><span class=main>)</span><span class=main>.</span> <span class=bound>u</span><span class=main>∈</span><span class=main>{</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>x</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> def_val <span class=keyword1><span class=command>unfolding</span></span> Sep_and_Replace <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>u</span><span class=main>∈</span><span class=main>{</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>x</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span><span class=main>.</span> succ<span class=main>(</span>rank<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>u</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rank<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>rank<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=skolem>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> rank<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"ed<span class=main>(</span><span class=skolem>y</span><span class=main>,</span> <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>y</span> 
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>[</span><span class=operator>OF</span> that<span class=main>]</span> rank_ed<span class=main>[</span><span class=operator>OF</span> that<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>lt_trans1<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>⋃</span><span class=bound>u</span><span class=main>∈</span><span class=main>{</span><span class=bound>t</span><span class=main>∈</span>domain<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>.</span> <span class=main>∃</span><span class=bound>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>.</span>  <span class=main>⟨</span><span class=bound>t</span><span class=main>,</span><span class=bound>p</span><span class=main>⟩</span><span class=main>∈</span><span class=skolem>x</span> <span class=main>∧</span> <span class=bound>p</span> <span class=main>∈</span> <span class=free>G</span> <span class=main>}</span><span class=main>.</span> succ<span class=main>(</span>rank<span class=main>(</span>val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=bound>u</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> rank<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> UN_least_le<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Ordinals_In_MG-Ord_MG_iff><span class=command>lemma</span></span> Ord_MG_iff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"Ord<span class=main>(</span><span class=free>α</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟷</span> <span class=free>α</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> <span class=free>α</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> generic<span class=main>[</span><span class=operator>THEN</span> one_in_G<span class=main>,</span> <span class=operator>THEN</span> M_subset_MG<span class=main>]</span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=quoted><span class=quoted>"val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=skolem>x</span><span class=main>)</span> <span class=main>=</span> <span class=free>α</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> GenExtD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rank<span class=main>(</span><span class=free>α</span><span class=main>)</span> <span class=main>≤</span> rank<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> rank_val <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>≤</span> rank<span class=main>(</span><span class=skolem>x</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rank_of_Ord <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>∈</span> succ<span class=main>(</span>rank<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltD <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>x</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>α</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> cons_closed transitivity<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>α</span></span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>rank<span class=main>(</span><span class=skolem>x</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span> 
      rank_closed <span class=keyword1><span class=command>unfolding</span></span> succ_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>  
<span class=keyword1><span class=command>qed</span></span>
  
<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* G_generic *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Proper_Extension><div class=head><h1>Theory Proper_Extension</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Separative notions and proper extensions›</span></span>
<span class=keyword1><span class=command>theory</span></span> Proper_Extension
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Names.html>Names</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The key ingredient to obtain a proper extension is to have
a <span class=antiquoted><span class=antiquoted><span class=operator><span class=operator>∗</span></span>‹separative preorder›</span></span>:›</span></span>

<span class=keyword1><span class=command>locale</span></span> separative_notion <span class=main>=</span> forcing_notion <span class=main>+</span>
  <span class=keyword2><span class=keyword>assumes</span></span> separative<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>p</span><span class=main>∈</span><span class=free>P</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=free>P</span><span class=main>.</span> <span class=bound>q</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>∧</span> <span class=bound>r</span> <span class=main>≼</span> <span class=free>p</span> <span class=main>∧</span> <span class=bound>q</span> <span class=main>⊥</span> <span class=bound>r</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹For separative preorders, the complement of every filter is
dense. Hence an $M$-generic filter can't belong to the ground model.›</span></span>

<span class=keyword1 id=Proper_Extension-filter_complement_dense><span class=command>lemma</span></span> filter_complement_dense<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dense<span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=free>G</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>d</span><span class=main>∈</span><span class=free>P</span> <span class=main>-</span> <span class=free>G</span><span class=main>.</span> <span class=bound>d</span> <span class=main>≼</span> <span class=skolem>p</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>p</span><span class=main>∈</span><span class=free>G</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> assms
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>q</span></span> <span class=skolem><span class=skolem>r</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>≼</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span> <span class=main>≼</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span> <span class=main>⊥</span> <span class=skolem>r</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>q</span><span class=main>∈</span><span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>r</span><span class=main>∈</span><span class=free>P</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> separative<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹filter<span class=main>(</span><span class=free>G</span><span class=main>)</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>≼</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∉</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> filter_imp_compat<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span> <span class=quoted><span class=skolem>q</span></span> <span class=quoted><span class=skolem>r</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>p</span><span class=main>∈</span><span class=free>P</span>›</span></span> 
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> leq_reflI <span class=keyword1><span class=command>unfolding</span></span> Diff_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* separative_notion *)</span>

<span class=keyword1><span class=command>locale</span></span> ctm_separative <span class=main>=</span> forcing_data <span class=main>+</span> separative_notion
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Proper_Extension-generic_not_in_M><span class=command>lemma</span></span> generic_not_in_M<span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span>  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span> <span class=main>∉</span> <span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>G</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>-</span> <span class=free>G</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> P_in_M Diff_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=free>G</span><span class=main>.</span> <span class=bound>q</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>-</span> <span class=free>G</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=free>G</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Diff_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> assms
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"False"</span></span>
    <span class=keyword1><span class=command>using</span></span> filter_complement_dense<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> M_generic_denseD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span><span class=main>-</span><span class=free>G</span>"</span></span><span class=main>]</span> 
      M_generic_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=comment1>― ‹need to put generic ==&gt; filter in claset›</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>theorem</span></span> proper_extension<span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=free>G</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>≠</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms G_in_Gen_Ext<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> one_in_G<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> generic_not_in_M
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* ctm_separative *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Succession_Poset><div class=head><h1>Theory Succession_Poset</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹A poset of successions›</span></span>
<span class=keyword1><span class=command>theory</span></span> Succession_Poset
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=Arities.html>Arities</a> <a href=Proper_Extension.html>Proper_Extension</a> <a href=Synthetic_Definition.html>Synthetic_Definition</a>
    <a href=Names.html>Names</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The set of finite binary sequences›</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We implement the poset for adding one Cohen real, the set 
$2^{&lt;\omega}$ of of finite binary sequences.›</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>seqspace</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=main>(</span><span class=quoted>"_<span class=keyword1>^&lt;ω</span>"</span> <span class=main>[</span>100<span class=main>]</span>100<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>seqspace</span><span class=main>(</span><span class=free><span class=bound><span class=entity>B</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>⋃</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=main>(</span><span class=bound>n</span><span class=main>→</span><span class=free><span class=bound><span class=entity>B</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Succession_Poset-seqspaceI><span class=command>lemma</span></span> seqspaceI<span class=main>[</span><span class=operator>intro</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat <span class=main>⟹</span> <span class=free>f</span><span class=main>:</span><span class=free>n</span><span class=main>→</span><span class=free>B</span> <span class=main>⟹</span> <span class=free>f</span><span class=main>∈</span>seqspace<span class=main>(</span><span class=free>B</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqspace_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Succession_Poset-seqspaceD><span class=command>lemma</span></span> seqspaceD<span class=main>[</span><span class=operator>dest</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span>seqspace<span class=main>(</span><span class=free>B</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=free>f</span><span class=main>:</span><span class=bound>n</span><span class=main>→</span><span class=free>B</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqspace_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Succession_Poset-seqspace_type><span class=command>lemma</span></span> seqspace_type<span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>∈</span> <span class=free>B</span><span class=keyword1>^&lt;ω</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=free>f</span><span class=main>:</span><span class=bound>n</span><span class=main>→</span><span class=free>B</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> seqspace_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>schematic_goal</span></span> seqspace_fm_auto<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>j</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>z</span>"</span></span>  <span class=quoted><span class=quoted>"nth<span class=main>(</span><span class=free>h</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>=</span> <span class=free>B</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>j</span> <span class=main>∈</span> nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span> <span class=main>∈</span> list<span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>om</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> omega<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span><span class=bound>om</span><span class=main>)</span> <span class=main>∧</span> <span class=free>n</span> <span class=main>∈</span> <span class=bound>om</span> <span class=main>∧</span> is_funspace<span class=main>(</span><span class=main>##</span><span class=free>A</span><span class=main>,</span> <span class=free>n</span><span class=main>,</span> <span class=free>B</span><span class=main>,</span> <span class=free>z</span><span class=main>)</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>A</span><span class=main>,</span> <span class=free>env</span> <span class=main>⊨</span> <span class=main>(</span><span class=var>?sqsprp</span><span class=main>(</span><span class=free>i</span><span class=main>,</span><span class=free>j</span><span class=main>,</span><span class=free>h</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_funspace_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>insert</span> assms <span class=main><span class=keyword3>;</span></span> <span class=main>(</span><span class=operator>rule</span> sep_rules <span class=main><span class=keyword3>|</span></span> <span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span>

<span class=keyword1><span class=command>synthesize</span></span> <span class=quoted>"seqspace_rep_fm"</span> <span class=keyword2><span class=keyword>from_schematic</span></span> seqspace_fm_auto
 
<span class=keyword1><span class=command>locale</span></span> M_seqspace <span class=main>=</span>  M_trancl <span class=main>+</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    seqspace_replacement<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>B</span><span class=main>)</span> <span class=main>⟹</span> strong_replacement<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=main>λ</span><span class=bound>n</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>n</span><span class=main>∈</span>nat <span class=main>∧</span> is_funspace<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=bound>n</span><span class=main>,</span><span class=free>B</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Succession_Poset-seqspace_closed><span class=command>lemma</span></span> seqspace_closed<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>B</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=free>B</span><span class=keyword1>^&lt;ω</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqspace_def <span class=keyword1><span class=command>using</span></span> seqspace_replacement<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>B</span></span><span class=main>]</span> RepFun_closed2 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_seqspace *)</span>


<span class=keyword1><span class=command>sublocale</span></span> M_ctm <span class=main>⊆</span> M_seqspace <span class=quoted><span class=quoted>"<span class=main>##</span><span class=free>M</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>B</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"arity<span class=main>(</span>seqspace_rep_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> <span class=main>3</span>"</span></span> <span class=quoted><span class=quoted>"seqspace_rep_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span><span class=main>∈</span>formula"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> seqspace_rep_fm_def 
    <span class=keyword1><span class=command>using</span></span> arity_pair_fm arity_omega_fm arity_typed_function_fm nat_simp_union 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>B</span><span class=main>∈</span><span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>,</span> <span class=skolem>B</span><span class=main>]</span> <span class=main>⊨</span> seqspace_rep_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>1</span><span class=main>,</span> <span class=main>2</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> replacement_ax<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"seqspace_rep_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=main>2</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>B</span><span class=main>∈</span><span class=free>M</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"univalent<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=skolem>A</span><span class=main>,</span> <span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>M</span><span class=main>,</span> <span class=main>[</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>,</span> <span class=skolem>B</span><span class=main>]</span> <span class=main>⊨</span> seqspace_rep_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span> <span class=main>1</span><span class=main>,</span> <span class=main>2</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>A</span> 
    <span class=keyword1><span class=command>using</span></span> that <span class=keyword1><span class=command>unfolding</span></span> univalent_def seqspace_rep_fm_def  
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main><span class=keyword3>,</span></span> <span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>transitivity<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>n</span> <span class=bound>z</span><span class=main>.</span> <span class=main>∃</span><span class=bound>om</span><span class=main>[</span><span class=main>##</span><span class=free>M</span><span class=main>].</span> omega<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>om</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>n</span> <span class=main>∈</span> <span class=bound>om</span> <span class=main>∧</span> is_funspace<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=bound>n</span><span class=main>,</span> <span class=skolem>B</span><span class=main>,</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> seqspace_fm_auto<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=main>_</span><span class=main>,</span><span class=main>_</span><span class=main>,</span><span class=skolem>B</span><span class=main>]</span>"</span></span> <span class=main>_</span> <span class=quoted><span class=main>1</span></span> <span class=main>_</span> <span class=quoted><span class=main>2</span></span> <span class=quoted><span class=skolem>B</span></span> <span class=quoted><span class=free>M</span></span><span class=main>]</span> <span class=keyword1><span class=command>unfolding</span></span> seqspace_rep_fm_def strong_replacement_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>B</span><span class=main>∈</span><span class=free>M</span>›</span></span> 
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"strong_replacement<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=main>λ</span><span class=bound>n</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> nat <span class=main>∧</span> is_funspace<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=bound>n</span><span class=main>,</span> <span class=skolem>B</span><span class=main>,</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> M_nat <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>seq_upd</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>seq_upd</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>λ</span> <span class=bound>j</span> <span class=main>∈</span> succ<span class=main>(</span>domain<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>.</span> <span class=keyword1>if</span> <span class=bound>j</span> <span class=main>&lt;</span> domain<span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>)</span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>`</span><span class=bound>j</span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>a</span></span></span>"</span></span>

<span class=keyword1 id=Succession_Poset-seq_upd_succ_type><span class=command>lemma</span></span> seq_upd_succ_type <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>n</span><span class=main>→</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span><span class=main>∈</span> succ<span class=main>(</span><span class=free>n</span><span class=main>)</span> <span class=main>→</span> <span class=free>A</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword1><span class=command>have</span></span> equ<span class=main>:</span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>=</span> <span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> domain_of_fun <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>j</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>∈</span>succ<span class=main>(</span>domain<span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> equ <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>≤</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ltI <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>n</span><span class=main>∈</span><span class=main>_</span>›</span></span>
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>lt<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>&lt;</span><span class=free>n</span>"</span></span> <span class=main>|</span> <span class=main>(</span>eq<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>=</span><span class=free>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> leD <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>if</span> <span class=skolem>j</span> <span class=main>&lt;</span> <span class=free>n</span> <span class=keyword1>then</span> <span class=free>f</span><span class=main>`</span><span class=skolem>j</span> <span class=keyword1>else</span> <span class=free>a</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
      <span class=keyword3><span class=command>case</span></span> lt
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=main>_</span>›</span></span> 
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> apply_type ltD<span class=main>[</span><span class=operator>OF</span> lt<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> eq
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=main>_</span>›</span></span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>with</span></span> equ
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> seq_upd_def
    <span class=keyword1><span class=command>using</span></span> lam_type<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"succ<span class=main>(</span>domain<span class=main>(</span><span class=free>f</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Succession_Poset-seq_upd_type><span class=command>lemma</span></span> seq_upd_type <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=free>A</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=free>A</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span> <span class=main>∈</span> <span class=free>A</span><span class=keyword1>^&lt;ω</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=skolem>y</span><span class=main>→</span><span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> seqspace_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span><span class=main>∈</span><span class=free>A</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span><span class=main>∈</span>succ<span class=main>(</span><span class=skolem>y</span><span class=main>)</span><span class=main>→</span><span class=free>A</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> seq_upd_succ_type <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> seqspace_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Succession_Poset-seq_upd_apply_domain><span class=command>lemma</span></span> seq_upd_apply_domain <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>:</span><span class=free>n</span><span class=main>→</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>n</span><span class=main>∈</span>nat"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span><span class=main>`</span><span class=free>n</span> <span class=main>=</span> <span class=free>a</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seq_upd_def <span class=keyword1><span class=command>using</span></span> assms domain_of_fun <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1 id=Succession_Poset-zero_in_seqspace><span class=command>lemma</span></span> zero_in_seqspace <span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span> <span class=main>∈</span> <span class=free>A</span><span class=keyword1>^&lt;ω</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqspace_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>seqleR</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>seqleR</span><span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>g</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>f</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>seqlerel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>seqlerel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> Rrel<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>⊆</span> <span class=bound>x</span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=keyword1>^&lt;ω</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>seqle</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>seqle</span> <span class=main>≡</span> seqlerel<span class=main>(</span><span class=main>2</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Succession_Poset-seqleI><span class=command>lemma</span></span> seqleI<span class=main>[</span><span class=operator>intro</span><span class=main><span class=main><span class=main><span class=main>!</span></span></span></span><span class=main>]</span><span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>×</span><span class=main>2</span><span class=keyword1>^&lt;ω</span> <span class=main>⟹</span> <span class=free>g</span> <span class=main>⊆</span> <span class=free>f</span>  <span class=main>⟹</span> <span class=main>⟨</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>⟩</span> <span class=main>∈</span> seqle"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span>  seqspace_def seqle_def seqlerel_def Rrel_def 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Succession_Poset-seqleD><span class=command>lemma</span></span> seqleD<span class=main>[</span><span class=operator>dest</span><span class=main><span class=main><span class=main><span class=main>!</span></span></span></span><span class=main>]</span><span class=main>:</span> 
  <span class=quoted><span class=quoted>"<span class=free>z</span> <span class=main>∈</span> seqle <span class=main>⟹</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>×</span><span class=main>2</span><span class=keyword1>^&lt;ω</span> <span class=main>∧</span> <span class=bound>y</span> <span class=main>⊆</span> <span class=bound>x</span> <span class=main>∧</span> <span class=free>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqle_def seqlerel_def Rrel_def 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Succession_Poset-upd_leI><span class=command>lemma</span></span> upd_leI <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span><span class=main>∈</span><span class=main>2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span>seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span><span class=main>,</span><span class=free>f</span><span class=main>⟩</span><span class=main>∈</span>seqle"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=var>?f</span><span class=main>,</span><span class=main>_</span><span class=main>⟩</span><span class=main>∈</span><span class=main>_</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>" <span class=main>⟨</span><span class=var>?f</span><span class=main>,</span> <span class=free>f</span><span class=main>⟩</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span> <span class=main>×</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms seq_upd_type <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>show</span></span>  <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>⊆</span> seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>proof</span></span> 
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>f</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>›</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>:</span> <span class=skolem>n</span> <span class=main>→</span> <span class=main>2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> seqspace_type <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=skolem>n</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>=</span><span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=free>f</span><span class=main>`</span><span class=skolem>y</span><span class=main>⟩</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Pi_memberD<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=main>.</span> <span class=main>2</span>"</span></span><span class=main>]</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>:</span><span class=skolem>n</span><span class=main>→</span><span class=main>2</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"domain<span class=main>(</span><span class=free>f</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>n</span>"</span></span> <span class=keyword1><span class=command>using</span></span> domain_of_fun <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> seq_upd_def lam_def  
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>ltI<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Succession_Poset-preorder_on_seqle><span class=command>lemma</span></span> preorder_on_seqle<span class=main>:</span> <span class=quoted><span class=quoted>"preorder_on<span class=main>(</span><span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>,</span>seqle<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> preorder_on_def refl_def trans_on_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=Succession_Poset-zero_seqle_max><span class=command>lemma</span></span> zero_seqle_max<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span> <span class=main>⟹</span> <span class=main>⟨</span><span class=free>x</span><span class=main>,</span><span class=main>0</span><span class=main>⟩</span> <span class=main>∈</span> seqle"</span></span>
  <span class=keyword1><span class=command>using</span></span> zero_in_seqspace 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>interpretation</span></span> forcing_notion <span class=quoted><span class=quoted>"<span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted><span class=quoted>"seqle"</span></span> <span class=quoted><span class=quoted>"<span class=main>0</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> preorder_on_seqle zero_seqle_max zero_in_seqspace 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>SEQle</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>≼s</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1><span class=free>≼s</span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>≡</span> Leq<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>SEQIncompatible</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>,</span> i<span class=main>]</span> <span class=main>⇒</span> o"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⊥s</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1><span class=free>⊥s</span></span> <span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>≡</span> Incompatible<span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Succession_Poset-seqspace_separative><span class=command>lemma</span></span> seqspace_separative<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>0</span><span class=main>)</span> <span class=keyword1>⊥s</span> seq_upd<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=keyword1>⊥s</span> <span class=var>?g</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>proof</span></span> 
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"compat<span class=main>(</span><span class=var>?f</span><span class=main>,</span> <span class=var>?g</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>h</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>h</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>⊆</span> <span class=skolem>h</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?g</span> <span class=main>⊆</span> <span class=skolem>h</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>f</span><span class=main>∈</span><span class=main>_</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span><span class=main>:</span><span class=skolem>y</span><span class=main>→</span><span class=main>2</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span><span class=main>:</span> succ<span class=main>(</span><span class=skolem>y</span><span class=main>)</span> <span class=main>→</span> <span class=main>2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?g</span><span class=main>:</span> succ<span class=main>(</span><span class=skolem>y</span><span class=main>)</span> <span class=main>→</span> <span class=main>2</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> seq_upd_succ_type <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=var>?f</span><span class=main>`</span><span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=var>?g</span><span class=main>`</span><span class=skolem>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=var>?g</span>"</span></span> <span class=keyword1><span class=command>using</span></span> apply_Pair <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=main>0</span><span class=main>⟩</span> <span class=main>∈</span> <span class=skolem>h</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=main>1</span><span class=main>⟩</span> <span class=main>∈</span> <span class=skolem>h</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>h</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>n</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>h</span><span class=main>:</span><span class=skolem>n</span><span class=main>→</span><span class=main>2</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"False"</span></span>
    <span class=keyword1><span class=command>using</span></span> fun_is_function<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>h</span></span> <span class=quoted><span class=skolem>n</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> <span class=main>2</span>"</span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>unfolding</span></span> seqspace_def function_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>is_seqleR</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_seqleR</span><span class=main>(</span><span class=free><span class=bound><span class=entity>Q</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>f</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>g</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>f</span></span></span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>seqleR_fm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>seqleR_fm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>fg</span></span></span><span class=main>)</span> <span class=main>≡</span> Exists<span class=main>(</span>Exists<span class=main>(</span>And<span class=main>(</span>pair_fm<span class=main>(</span><span class=main>0</span><span class=main>,</span><span class=main>1</span><span class=main>,</span><span class=free><span class=bound><span class=entity>fg</span></span></span><span class=main>#+</span><span class=main>2</span><span class=main>)</span><span class=main>,</span>subset_fm<span class=main>(</span><span class=main>1</span><span class=main>,</span><span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Succession_Poset-type_seqleR_fm><span class=command>lemma</span></span> type_seqleR_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>fg</span> <span class=main>∈</span> nat <span class=main>⟹</span> seqleR_fm<span class=main>(</span><span class=free>fg</span><span class=main>)</span> <span class=main>∈</span> formula"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqleR_fm_def 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=Succession_Poset-arity_seqleR_fm><span class=command>lemma</span></span> arity_seqleR_fm <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>fg</span> <span class=main>∈</span> nat <span class=main>⟹</span> arity<span class=main>(</span>seqleR_fm<span class=main>(</span><span class=free>fg</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> succ<span class=main>(</span><span class=free>fg</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqleR_fm_def 
  <span class=keyword1><span class=command>using</span></span> arity_pair_fm arity_subset_fm nat_simp_union <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_basic<span class=main>)</span> seqleR_abs<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>g</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"seqleR<span class=main>(</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>)</span> <span class=main>⟷</span> is_seqleR<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>f</span><span class=main>,</span><span class=free>g</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqleR_def is_seqleR_def 
  <span class=keyword1><span class=command>using</span></span> assms apply_abs domain_abs domain_closed<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>f</span><span class=main>)</span>›</span></span><span class=main>]</span>  domain_closed<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>g</span><span class=main>)</span>›</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>relP</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span><span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span><span class=main>⇒</span>o<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>relP</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>xy</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> <span class=main>∃</span><span class=bound>y</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> pair<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>,</span><span class=free><span class=bound><span class=entity>xy</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_ctm<span class=main>)</span> seqleR_fm_sats <span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>fg</span><span class=main>∈</span>nat"</span></span> <span class=quoted><span class=quoted>"<span class=free>env</span><span class=main>∈</span>list<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sats<span class=main>(</span><span class=free>M</span><span class=main>,</span>seqleR_fm<span class=main>(</span><span class=free>fg</span><span class=main>)</span><span class=main>,</span><span class=free>env</span><span class=main>)</span> <span class=main>⟷</span> relP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span>is_seqleR<span class=main>,</span>nth<span class=main>(</span><span class=free>fg</span><span class=main>,</span> <span class=free>env</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> seqleR_fm_def is_seqleR_def relP_def
  <span class=keyword1><span class=command>using</span></span> assms trans_M sats_subset_fm pair_iff_sats
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_basic<span class=main>)</span> is_related_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>f</span> <span class=bound>g</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>f</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>rel</span><span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_rel</span><span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>z</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟹</span> relP<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>is_rel</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free>rel</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> relP_def <span class=keyword1><span class=command>using</span></span> pair_in_M_iff assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_RRel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span><span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span><span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_RRel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>is_r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>A2</span><span class=main>[</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>].</span> cartprod<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=bound>A2</span><span class=main>)</span> <span class=main>∧</span> is_Collect<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=bound>A2</span><span class=main>,</span> relP<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>is_r</span></span></span><span class=main>)</span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_basic<span class=main>)</span> is_Rrel_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>f</span> <span class=bound>g</span> <span class=main>.</span> <span class=free>M</span><span class=main>(</span><span class=bound>f</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>M</span><span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>rel</span><span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_rel</span><span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_RRel<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>is_rel</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟷</span>  <span class=free>r</span> <span class=main>=</span> Rrel<span class=main>(</span><span class=free>rel</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=skolem>z</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> cartprod_closed transM<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>z</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span><span class=main>]</span> that <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span><span class=quoted><span class=quoted>"relP<span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=free>is_rel</span><span class=main>,</span> <span class=skolem>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=skolem>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free>rel</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=skolem>z</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> that is_related_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>rel</span></span> <span class=quoted><span class=free>is_rel</span></span><span class=main>,</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>,</span>relP<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>is_rel</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> Collect<span class=main>(</span><span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free>rel</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_cong<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>×</span><span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"relP<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>is_rel</span><span class=main>)</span>"</span></span><span class=main>,</span><span class=operator>OF</span> _ A<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> assms<span class=main>(</span>1<span class=main>)</span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> is_RRel_def Rrel_def <span class=keyword1><span class=command>using</span></span> cartprod_closed
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>is_seqlerel</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> o"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>is_seqlerel</span><span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span> <span class=main>≡</span> is_RRel<span class=main>(</span><span class=free><span class=bound><span class=entity>M</span></span></span><span class=main>,</span>is_seqleR<span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> M_basic<span class=main>)</span> seqlerel_abs <span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>(</span><span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"is_seqlerel<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>r</span> <span class=main>=</span> Rrel<span class=main>(</span>seqleR<span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> is_seqlerel_def
  <span class=keyword1><span class=command>using</span></span> is_Rrel_abs<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>A</span><span class=main>)</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span><span class=main>(</span><span class=free>r</span><span class=main>)</span>›</span></span><span class=main>,</span><span class=operator>of</span> <span class=quoted>seqleR</span> <span class=quoted>is_seqleR</span><span class=main>]</span> seqleR_abs
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>RrelP</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>i<span class=main>⇒</span>i<span class=main>⇒</span>o<span class=main>,</span>i<span class=main>]</span> <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>RrelP</span><span class=main>(</span><span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=main>{</span><span class=bound>z</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>×</span><span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span> <span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>R</span></span></span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>}</span>"</span></span>
  
<span class=keyword1 id=Succession_Poset-Rrel_eq><span class=command>lemma</span></span> Rrel_eq <span class=main>:</span> <span class=quoted><span class=quoted>"RrelP<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>A</span><span class=main>)</span> <span class=main>=</span> Rrel<span class=main>(</span><span class=free>R</span><span class=main>,</span><span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def RrelP_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>context</span></span> M_ctm
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=Succession_Poset-Rrel_closed><span class=command>lemma</span></span> Rrel_closed<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span><span class=main>∈</span><span class=free>M</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> nat <span class=main>⟹</span> <span class=free>rel_fm</span><span class=main>(</span><span class=bound>a</span><span class=main>)</span><span class=main>∈</span>formula"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>f</span> <span class=bound>g</span> <span class=main>.</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=bound>f</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>rel</span><span class=main>(</span><span class=bound>f</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span> <span class=main>⟷</span> <span class=free>is_rel</span><span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=bound>f</span><span class=main>,</span><span class=bound>g</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"arity<span class=main>(</span><span class=free>rel_fm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>⋀</span> <span class=bound>a</span> <span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> sats<span class=main>(</span><span class=free>M</span><span class=main>,</span><span class=free>rel_fm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span><span class=main>,</span><span class=main>[</span><span class=bound>a</span><span class=main>]</span><span class=main>)</span> <span class=main>⟷</span> relP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span><span class=free>is_rel</span><span class=main>,</span><span class=bound>a</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span><span class=main>(</span>Rrel<span class=main>(</span><span class=free>rel</span><span class=main>,</span><span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span> <span class=free>M</span> <span class=main>⟹</span> relP<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>,</span> <span class=free>is_rel</span><span class=main>,</span> <span class=skolem>z</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=skolem>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free>rel</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>z</span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> is_related_abs<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>rel</span></span> <span class=quoted><span class=free>is_rel</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Collect<span class=main>(</span><span class=free>A</span><span class=main>×</span><span class=free>A</span><span class=main>,</span><span class=main>λ</span><span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free>rel</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span><span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> <span class=free>M</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Collect_in_M_0p<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>rel_fm</span><span class=main>(</span><span class=main>0</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>A</span> <span class=bound>z</span> <span class=main>.</span> relP<span class=main>(</span><span class=bound>A</span><span class=main>,</span><span class=free>is_rel</span><span class=main>,</span><span class=bound>z</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span> <span class=bound>z</span><span class=main>.</span><span class=main>∃</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>z</span> <span class=main>=</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∧</span> <span class=free>rel</span><span class=main>(</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=main>]</span>
        cartprod_closed
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>unfolding</span></span> Rrel_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Succession_Poset-seqle_in_M><span class=command>lemma</span></span> seqle_in_M<span class=main>:</span> <span class=quoted><span class=quoted>"seqle <span class=main>∈</span> <span class=free>M</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> Rrel_closed seqspace_closed 
    transitivity<span class=main>[</span><span class=operator>OF</span> _ nat_in_M<span class=main>]</span> type_seqleR_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span><span class=main>]</span> arity_seqleR_fm<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span><span class=main>]</span>
    seqleR_fm_sats<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=main>0</span></span><span class=main>]</span> seqleR_abs seqlerel_abs 
  <span class=keyword1><span class=command>unfolding</span></span> seqle_def seqlerel_def seqleR_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹Cohen extension is proper›</span></span>

<span class=keyword1><span class=command>interpretation</span></span> ctm_separative <span class=quoted><span class=quoted>"<span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted>seqle</span> <span class=quoted><span class=main>0</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>f</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=skolem>f</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=skolem>f</span><span class=main>,</span><span class=main>1</span><span class=main>)</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?q</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=var>?r</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=var>?q</span> <span class=keyword1>⊥s</span> <span class=var>?r</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> upd_leI seqspace_separative <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?q</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=var>?r</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> seq_upd_type<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>f</span></span> <span class=quoted><span class=main>2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>.</span> <span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>.</span> <span class=bound>q</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=bound>r</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=bound>q</span> <span class=keyword1>⊥s</span> <span class=bound>r</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> bexI<span class=main>)</span><span class=main><span class=keyword3>+</span></span> <span class=comment1>― ‹why the heck auto-tools don't solve this?›</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>2</span><span class=keyword1>^&lt;ω</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nat_into_M seqspace_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"seqle <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> seqle_in_M <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Succession_Poset-cohen_extension_is_proper><span class=command>lemma</span></span> cohen_extension_is_proper<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>G</span><span class=main>.</span> M_generic<span class=main>(</span><span class=bound>G</span><span class=main>)</span> <span class=main>∧</span> <span class=free>M</span> <span class=main>≠</span> GenExt<span class=main>(</span><span class=bound>G</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> proper_extension generic_filter_existence zero_in_seqspace
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword2><span class=keyword>end</span></span> <span class=comment1>(* M_ctm *)</span>

<span class=keyword2><span class=keyword>end</span></span></pre></div><div id=Forcing_Main><div class=head><h1>Theory Forcing_Main</h1></div><pre class=source><span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹The main theorem›</span></span>
<span class=keyword1><span class=command>theory</span></span> Forcing_Main
  <span class=keyword2><span class=keyword>imports</span></span> 
  <a href=Internal_ZFC_Axioms.html>Internal_ZFC_Axioms</a>
  <a href=Choice_Axiom.html>Choice_Axiom</a>
  <a href=Ordinals_In_MG.html>Ordinals_In_MG</a>
  <a href=Succession_Poset.html>Succession_Poset</a>

<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The generic extension is countable›</span></span>
<span class=comment1>(*
― ‹Useful missing lemma›
lemma surj_imp_well_ord:
  assumes "well_ord(A,r)" "h ∈ surj(A,B)"
  shows "∃s. well_ord(B,r)" 
*)</span>

<span class=keyword1><span class=command>definition</span></span>
  <span class=entity>minimum</span> <span class=main>::</span> <span class=quoted><span class=quoted>"i <span class=main>⇒</span> i <span class=main>⇒</span> i"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>minimum</span><span class=main>(</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>B</span></span></span><span class=main>)</span> <span class=main>≡</span> <span class=keyword1>THE</span> <span class=bound>b</span><span class=main>.</span> <span class=bound>b</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>B</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free><span class=bound><span class=entity>B</span></span></span><span class=main>.</span> <span class=bound>y</span> <span class=main>≠</span> <span class=bound>b</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=bound>b</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=Forcing_Main-well_ord_imp_min><span class=command>lemma</span></span> well_ord_imp_min<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"well_ord<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>B</span> <span class=main>⊆</span> <span class=free>A</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>B</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=free>B</span><span class=main>)</span> <span class=main>∈</span> <span class=free>B</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹well_ord<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>wf[</span><span class=free>A</span><span class=main>](</span><span class=free>r</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> well_ord_is_wf<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹well_ord<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>⊆</span><span class=free>A</span>›</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>wf[</span><span class=free>B</span><span class=main>](</span><span class=free>r</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Sigma_mono Int_mono wf_subset <span class=keyword1><span class=command>unfolding</span></span> wf_on_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>B</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>∈</span><span class=free>B</span><span class=main>.</span> <span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span> <span class=bound>z</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>∩</span><span class=free>B</span><span class=main>×</span><span class=free>B</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>∉</span> <span class=free>B</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> wf_on_def <span class=keyword1><span class=command>using</span></span> wf_eq_minimal
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>≠</span><span class=main>0</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>z</span></span> <span class=keyword2><span class=keyword>where</span></span>
    B<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=main>⟨</span><span class=bound>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>⟩</span><span class=main>∈</span><span class=free>r</span><span class=main>∩</span><span class=free>B</span><span class=main>×</span><span class=free>B</span> <span class=main>⟶</span> <span class=bound>y</span><span class=main>∉</span><span class=free>B</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>z</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>B</span><span class=main>.</span> <span class=bound>y</span> <span class=main>≠</span> <span class=skolem>z</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=skolem>z</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>∈</span><span class=free>B</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span><span class=main>≠</span><span class=skolem>z</span>"</span></span>
      <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹well_ord<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span>›</span></span> B <span class=quoted><span class=quoted>‹<span class=free>B</span><span class=main>⊆</span><span class=free>A</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=free>r</span><span class=main>|</span><span class=main>⟨</span><span class=skolem>y</span><span class=main>,</span><span class=skolem>z</span><span class=main>⟩</span><span class=main>∈</span><span class=free>r</span><span class=main>|</span><span class=skolem>y</span><span class=main>=</span><span class=skolem>z</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> well_ord_def tot_ord_def linear_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>with</span></span> B <span class=quoted><span class=quoted>‹<span class=skolem>y</span><span class=main>∈</span><span class=free>B</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>y</span><span class=main>≠</span><span class=skolem>z</span>›</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⟨</span><span class=skolem>z</span><span class=main>,</span><span class=skolem>y</span><span class=main>⟩</span><span class=main>∈</span><span class=free>r</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main><span class=keyword3>;</span></span><span class=operator>auto</span><span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>with</span></span> B
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>=</span> <span class=skolem>z</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>B</span><span class=main>.</span> <span class=bound>y</span> <span class=main>≠</span> <span class=skolem>v</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=skolem>v</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>using</span></span> that B <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>z</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>B</span><span class=main>.</span> <span class=bound>y</span> <span class=main>≠</span> <span class=skolem>z</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=skolem>z</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>)</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> minimum_def 
    <span class=keyword1><span class=command>using</span></span> the_equality2<span class=main>[</span><span class=operator>OF</span> ex1I<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=main>.</span><span class=bound>x</span><span class=main>∈</span><span class=free>B</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=free>B</span><span class=main>.</span> <span class=bound>y</span> <span class=main>≠</span> <span class=bound>x</span> <span class=main>⟶</span> <span class=main>⟨</span><span class=bound>x</span><span class=main>,</span> <span class=bound>y</span><span class=main>⟩</span> <span class=main>∈</span> <span class=free>r</span><span class=main>)</span>"</span></span> <span class=quoted><span class=skolem>z</span></span><span class=main><span class=main>]</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Forcing_Main-well_ord_surj_imp_lepoll><span class=command>lemma</span></span> well_ord_surj_imp_lepoll<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"well_ord<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>r</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> surj<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>B</span> <span class=main>≲</span> <span class=free>A</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>b</span><span class=main>∈</span><span class=free>B</span><span class=main>.</span> minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>h</span><span class=main>`</span><span class=bound>a</span><span class=main>=</span><span class=bound>b</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=free>B</span> <span class=main>⟹</span> minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=main>{</span><span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=free>h</span> <span class=main>`</span> <span class=bound>a</span> <span class=main>=</span> <span class=skolem>b</span><span class=main>}</span><span class=main>)</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>h</span><span class=main>`</span><span class=bound>a</span><span class=main>=</span><span class=skolem>b</span><span class=main>}</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>b</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>b</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span><span class=main>∈</span><span class=free>B</span>"</span></span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=free>h</span> <span class=main>∈</span> surj<span class=main>(</span><span class=free>A</span><span class=main>,</span><span class=free>B</span><span class=main>)</span>›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>h</span><span class=main>`</span><span class=bound>a</span><span class=main>=</span><span class=skolem>b</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> surj_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>h</span><span class=main>`</span><span class=bound>a</span><span class=main>=</span><span class=skolem>b</span><span class=main>}</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>with</span></span> assms
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span><span class=main>{</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>h</span><span class=main>`</span><span class=bound>a</span><span class=main>=</span><span class=skolem>b</span><span class=main>}</span><span class=main>)</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>a</span><span class=main>∈</span><span class=free>A</span><span class=main>.</span> <span class=free>h</span><span class=main>`</span><span class=bound>a</span><span class=main>=</span><span class=skolem>b</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> well_ord_imp_min <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>:</span> <span class=free>B</span> <span class=main>→</span> <span class=free>A</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> lam_type<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>B</span></span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span><span class=free>A</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>`</span> <span class=skolem>w</span> <span class=main>=</span> <span class=var>?f</span> <span class=main>`</span> <span class=skolem>x</span> <span class=main>⟹</span> <span class=skolem>w</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span><span class=main>∈</span><span class=free>B</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=free>B</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>w</span> <span class=skolem>x</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>from</span></span> calculation<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> that<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> calculation<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> that<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>=</span> <span class=free>h</span> <span class=main>`</span> minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=main>{</span><span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=free>h</span> <span class=main>`</span> <span class=bound>a</span> <span class=main>=</span> <span class=skolem>w</span><span class=main>}</span><span class=main>)</span>"</span></span>
         <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=free>h</span> <span class=main>`</span> minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=main>{</span><span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=free>h</span> <span class=main>`</span> <span class=bound>a</span> <span class=main>=</span> <span class=skolem>x</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>  
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>`</span> <span class=skolem>w</span> <span class=main>=</span> <span class=var>?f</span> <span class=main>`</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> this <span class=keyword2><span class=keyword>and</span></span> that
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=main>{</span><span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=free>h</span> <span class=main>`</span> <span class=bound>a</span> <span class=main>=</span> <span class=skolem>w</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> minimum<span class=main>(</span><span class=free>r</span><span class=main>,</span> <span class=main>{</span><span class=bound>a</span> <span class=main>∈</span> <span class=free>A</span> <span class=main>.</span> <span class=free>h</span> <span class=main>`</span> <span class=bound>a</span> <span class=main>=</span> <span class=skolem>x</span><span class=main>}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation<span class=main>(</span>1<span class=main>,</span>2<span class=main>,</span>4<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span><span class=main>=</span><span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>unfolding</span></span> lepoll_def inj_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> forcing_data<span class=main>)</span> surj_nat_MG <span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>f</span><span class=main>.</span> <span class=bound>f</span> <span class=main>∈</span> surj<span class=main>(</span>nat<span class=main>,</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>enum</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> nat <span class=main>⟹</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span> <span class=free>enum</span> <span class=main>`</span> <span class=skolem>x</span><span class=main>)</span><span class=main>∈</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> GenExtD<span class=main>[</span><span class=operator>THEN</span> iffD2<span class=main>,</span> <span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> bij_is_fun<span class=main>[</span><span class=operator>OF</span> M_countable<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span><span class=main>:</span> nat <span class=main>→</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> lam_type<span class=main>[</span><span class=operator>of</span> <span class=quoted>nat</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>.</span> val<span class=main>(</span><span class=free>G</span><span class=main>,</span><span class=free>enum</span><span class=main>`</span><span class=bound>n</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>n</span><span class=main>∈</span>nat<span class=main>.</span> <span class=var>?f</span><span class=main>`</span><span class=bound>n</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span> <span class=keyword2><span class=keyword>if</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>x</span>
    <span class=keyword1><span class=command>using</span></span> that GenExtD<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=free>G</span></span><span class=main>]</span> bij_is_surj<span class=main>[</span><span class=operator>OF</span> M_countable<span class=main>]</span> 
    <span class=keyword1><span class=command>unfolding</span></span> surj_def <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> surj_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>in</span></span> G_generic<span class=main>)</span> MG_eqpoll_nat<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>≈</span> nat"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>interpret</span></span> MG<span class=main>:</span> M_ZF_trans <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Transset_MG generic pairing_in_MG 
      Union_MG  extensionality_in_MG power_in_MG
      foundation_in_MG  strong_replacement_in_MG<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span>
      separation_in_MG<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span> infinity_in_MG
    <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>simp_all</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>f</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>∈</span> surj<span class=main>(</span>nat<span class=main>,</span><span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> surj_nat_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span> <span class=main>≲</span> nat"</span></span> 
    <span class=keyword1><span class=command>using</span></span> well_ord_surj_imp_lepoll well_ord_Memrel<span class=main>[</span><span class=operator>of</span> <span class=quoted>nat</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"nat <span class=main>≲</span> <span class=keyword1>M[</span><span class=free>G</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> MG.nat_into_M subset_imp_lepoll <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> eqpollI 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span><span class=quoted><span class=plain_text>‹The main result›</span></span>

<span class=keyword1><span class=command>theorem</span></span> extensions_of_ctms<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>≈</span> nat"</span></span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=free>M</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>⊨</span> ZF"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>N</span><span class=main>.</span> 
      <span class=free>M</span> <span class=main>⊆</span> <span class=bound>N</span> <span class=main>∧</span> <span class=bound>N</span> <span class=main>≈</span> nat <span class=main>∧</span> Transset<span class=main>(</span><span class=bound>N</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>N</span> <span class=main>⊨</span> ZF <span class=main>∧</span> <span class=free>M</span><span class=main>≠</span><span class=bound>N</span> <span class=main>∧</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>α</span><span class=main>.</span> Ord<span class=main>(</span><span class=bound>α</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=bound>α</span> <span class=main>∈</span> <span class=free>M</span> <span class=main>⟷</span> <span class=bound>α</span> <span class=main>∈</span> <span class=bound>N</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
      <span class=main>(</span><span class=free>M</span><span class=main>,</span> <span class=main>[]</span><span class=main>⊨</span> <span class=keyword1>AC</span> <span class=main>⟶</span> <span class=bound>N</span> <span class=main>⊨</span> ZFC<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span> <span class=main>≈</span> nat›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>enum</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>enum</span> <span class=main>∈</span> bij<span class=main>(</span>nat<span class=main>,</span><span class=free>M</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> eqpoll_sym <span class=keyword1><span class=command>unfolding</span></span> eqpoll_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>with</span></span> assms
  <span class=keyword1><span class=command>interpret</span></span> M_ctm <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>enum</span></span>
    <span class=keyword1><span class=command>using</span></span> M_ZF_iff_M_satT
    <span class=keyword1><span class=command>by</span></span> <span class=operator>intro_locales</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>M_ctm_axioms_def<span class=main>)</span>
  <span class=keyword1><span class=command>interpret</span></span> ctm_separative <span class=quoted><span class=quoted>"<span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted>seqle</span> <span class=quoted><span class=main>0</span></span> <span class=quoted><span class=free>M</span></span> <span class=quoted><span class=skolem>enum</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>unfold_locales</span><span class=main>)</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>f</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=skolem>f</span><span class=main>,</span><span class=main>0</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=var><span class=quoted><span class=var>?r</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"seq_upd<span class=main>(</span><span class=skolem>f</span><span class=main>,</span><span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?q</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=var>?r</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=var>?q</span> <span class=keyword1>⊥s</span> <span class=var>?r</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> upd_leI seqspace_separative <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> calculation
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?q</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=var>?r</span> <span class=main>∈</span> <span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> seq_upd_type<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>f</span></span> <span class=quoted><span class=main>2</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>q</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>.</span>  <span class=main>∃</span><span class=bound>r</span><span class=main>∈</span><span class=main>2</span><span class=keyword1>^&lt;ω</span><span class=main>.</span> <span class=bound>q</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=bound>r</span> <span class=keyword1>≼s</span> <span class=skolem>f</span> <span class=main>∧</span> <span class=bound>q</span> <span class=keyword1>⊥s</span> <span class=bound>r</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> bexI<span class=main>)</span><span class=main><span class=keyword3>+</span></span> <span class=comment1>― ‹why the heck auto-tools don't solve this?›</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>2</span><span class=keyword1>^&lt;ω</span> <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nat_into_M seqspace_closed <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"seqle <span class=main>∈</span> <span class=free>M</span>"</span></span> <span class=keyword1><span class=command>using</span></span> seqle_in_M <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>from</span></span> cohen_extension_is_proper
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>G</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"M_generic<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>≠</span> GenExt<span class=main>(</span><span class=skolem>G</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>≠</span><span class=var>?N</span>"</span></span><span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> 
  <span class=keyword1><span class=command>interpret</span></span> G_generic <span class=quoted><span class=quoted>"<span class=main>2</span><span class=keyword1>^&lt;ω</span>"</span></span> <span class=quoted>seqle</span> <span class=quoted><span class=main>0</span></span> _ <span class=quoted><span class=skolem>enum</span></span> <span class=quoted><span class=skolem>G</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span>
  <span class=keyword1><span class=command>interpret</span></span> MG<span class=main>:</span> M_ZF <span class=quoted><span class=quoted>"<span class=var>?N</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> generic pairing_in_MG 
      Union_MG  extensionality_in_MG power_in_MG
      foundation_in_MG  strong_replacement_in_MG<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span>
      separation_in_MG<span class=main>[</span><span class=operator>simplified</span><span class=main>]</span> infinity_in_MG
    <span class=keyword1><span class=command>by</span></span> <span class=operator>unfold_locales</span> <span class=operator>simp_all</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?N</span> <span class=main>⊨</span> ZF"</span></span> 
    <span class=keyword1><span class=command>using</span></span> M_ZF_iff_M_satT<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?N</span></span></span><span class=main>]</span> MG.M_ZF_axioms <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span><span class=main>⊨</span> <span class=keyword1>AC</span> <span class=main>⟹</span> <span class=var>?N</span> <span class=main>⊨</span> ZFC"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span><span class=main>,</span> <span class=main>[]</span> <span class=main>⊨</span> <span class=keyword1>AC</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"choice_ax<span class=main>(</span><span class=main>##</span><span class=free>M</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ZF_choice_fm_def <span class=keyword1><span class=command>using</span></span> ZF_choice_auto <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"choice_ax<span class=main>(</span><span class=main>##</span><span class=var>?N</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> choice_in_MG <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>with</span></span> <span class=quoted><span class=quoted>‹<span class=var>?N</span> <span class=main>⊨</span> ZF›</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?N</span> <span class=main>⊨</span> ZFC"</span></span>
      <span class=keyword1><span class=command>using</span></span> ZF_choice_auto sats_ZFC_iff_sats_ZF_AC 
      <span class=keyword1><span class=command>unfolding</span></span> ZF_choice_fm_def <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>note</span></span> <span class=quoted><span class=quoted>‹<span class=free>M</span> <span class=main>≠</span> <span class=var>?N</span>›</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Transset<span class=main>(</span><span class=var>?N</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Transset_MG <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>M</span> <span class=main>⊆</span> <span class=var>?N</span>"</span></span> <span class=keyword1><span class=command>using</span></span> M_subset_MG<span class=main>[</span><span class=operator>OF</span> one_in_G<span class=main>]</span> generic <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Ord_MG_iff MG_eqpoll_nat
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=var>?N</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre></div></main></div></div></body></html>
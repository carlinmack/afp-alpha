<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Session NormByEval - Archive of Formal Proofs</title><meta name=description content="A collection of proof libraries, examples, and larger scientific developments, mechanically checked in the theorem prover Isabelle."><meta property="og:title" content="Session NormByEval"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="/entries/normbyeval/theories/"><meta property="og:image" content="/images/afp.png"><meta property="article:section" content="theories"><meta property="og:site_name" content="Archive of Formal Proofs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/afp.png"><meta name=twitter:title content="Session NormByEval"><meta name=twitter:description content><link rel=stylesheet type=text/css href=/css/front.min.css><link rel=stylesheet type=text/css href=/css/isabelle.css><link rel=icon href=/images/favicon.ico type=image/icon><script src=/js/flexsearch.min.js></script><script src=/js/banner.js></script><script src=/js/header-search.js></script></head><body class=mathjax_ignore><aside><div><div><a href=/><img src=/images/afp.png alt="Logo of the Archive of Formal Proofs" class=logo></a><ul><li><a href=/entries/normbyeval>Return to entry</a></li></ul><hr><ul><li><a href=#NBE>NBE</a><ul><li><a href=#NBE-pure_Lam>pure_Lam</a></li><li><a href=#NBE-depth_At_foldl>depth_At_foldl</a></li><li><a href=#NBE-foldl_At_eq_lemma>foldl_At_eq_lemma</a></li><li><a href=#NBE-foldl_At_eq_length>foldl_At_eq_length</a></li><li><a href=#NBE-foldl_At_eq>foldl_At_eq</a></li><li><a href=#NBE-term_eq_foldl_At>term_eq_foldl_At</a></li><li><a href=#NBE-At_eq_foldl_At>At_eq_foldl_At</a></li><li><a href=#NBE-foldl_At_eq_At>foldl_At_eq_At</a></li><li><a href=#NBE-Lam_eq_foldl_At>Lam_eq_foldl_At</a></li><li><a href=#NBE-foldl_At_eq_Lam>foldl_At_eq_Lam</a></li><li><a href=#NBE-head_tm_foldl_At>head_tm_foldl_At</a></li><li><a href=#NBE-args_tm_foldl_At>args_tm_foldl_At</a></li><li><a href=#NBE-tm_eq_iff>tm_eq_iff</a></li><li><a href=#NBE-atomic_tm_head_tm>atomic_tm_head_tm</a></li><li><a href=#NBE-head_tm_idem>head_tm_idem</a></li><li><a href=#NBE-args_tm_head_tm>args_tm_head_tm</a></li><li><a href=#NBE-eta_head_args>eta_head_args</a></li><li><a href=#NBE-tm_vector_cases>tm_vector_cases</a></li><li><a href=#NBE-fv_head_C>fv_head_C</a></li><li><a href=#NBE-apply_cons>apply_cons</a></li><li><a href=#NBE-apply_cons_ML>apply_cons_ML</a></li><li><a href=#NBE-lift_foldl_At>lift_foldl_At</a></li><li><a href=#NBE-lift_lift_ml>lift_lift_ml</a></li><li><a href=#NBE-lift_lift_tm>lift_lift_tm</a></li><li><a href=#NBE-lift_lift_ML>lift_lift_ML</a></li><li><a href=#NBE-lift_lift_ML_comm>lift_lift_ML_comm</a></li><li><a href=#NBE-V_ML_cons_ML_subst_decr>V_ML_cons_ML_subst_decr</a></li><li><a href=#NBE-shift_subst_decr>shift_subst_decr</a></li><li><a href=#NBE-lift_comp_subst_decr>lift_comp_subst_decr</a></li><li><a href=#NBE-subst_ML_ext>subst_ML_ext</a></li><li><a href=#NBE-subst_ext>subst_ext</a></li><li><a href=#NBE-lift_Pure_tms>lift_Pure_tms</a></li><li><a href=#NBE-cons_ML_V_ML>cons_ML_V_ML</a></li><li><a href=#NBE-cons_V>cons_V</a></li><li><a href=#NBE-lift_o_shift>lift_o_shift</a></li><li><a href=#NBE-lift_subst_ML>lift_subst_ML</a></li><li><a href=#NBE-lift_ML_subst_ML>lift_ML_subst_ML</a></li><li><a href=#NBE-lift_ML_id>lift_ML_id</a></li><li><a href=#NBE-subst_ML_id>subst_ML_id</a></li><li><a href=#NBE-subst_ML_coincidence>subst_ML_coincidence</a></li><li><a href=#NBE-subst_ML_comp>subst_ML_comp</a></li><li><a href=#NBE-subst_ML_comp2>subst_ML_comp2</a></li><li><a href=#NBE-closed_tm_ML_foldl_At>closed_tm_ML_foldl_At</a></li><li><a href=#NBE-closed_ML_lift>closed_ML_lift</a></li><li><a href=#NBE-closed_ML_Suc>closed_ML_Suc</a></li><li><a href=#NBE-closed_ML_subst_ML>closed_ML_subst_ML</a></li><li><a href=#NBE-closed_ML_subst_ML2>closed_ML_subst_ML2</a></li><li><a href=#NBE-subst_foldl>subst_foldl</a></li><li><a href=#NBE-subst_V>subst_V</a></li><li><a href=#NBE-lift_subst_aux>lift_subst_aux</a></li><li><a href=#NBE-subst_comp>subst_comp</a></li><li><a href=#NBE-pattern_Lam>pattern_Lam</a></li><li><a href=#NBE-pattern_At%27D12>pattern_At'D12</a></li><li><a href=#NBE-pattern_AtD12>pattern_AtD12</a></li><li><a href=#NBE-pattern_At_vecD>pattern_At_vecD</a></li><li><a href=#NBE-pattern_At_decomp>pattern_At_decomp</a></li><li><a href=#NBE-Reds_tm_list_refl>Reds_tm_list_refl</a></li><li><a href=#NBE-Red_tm_append>Red_tm_append</a></li><li><a href=#NBE-Red_tm_rev>Red_tm_rev</a></li><li><a href=#NBE-red_Lam>red_Lam</a></li><li><a href=#NBE-red_At1>red_At1</a></li><li><a href=#NBE-red_At2>red_At2</a></li><li><a href=#NBE-Reds_tm_list_foldl_At>Reds_tm_list_foldl_At</a></li><li><a href=#NBE-termination_no_match_ML>termination_no_match_ML</a></li><li><a href=#NBE-sum_list_size%27>sum_list_size'</a></li><li><a href=#NBE-size%27_lift_ML>size'_lift_ML</a></li><li><a href=#NBE-size%27_subst_ML>size'_subst_ML</a></li><li><a href=#NBE-size%27_lift>size'_lift</a></li><li><a href=#NBE-kernel_pure>kernel_pure</a></li><li><a href=#NBE-kernel_foldl_At>kernel_foldl_At</a></li><li><a href=#NBE-kernelt_o_term>kernelt_o_term</a></li><li><a href=#NBE-pure_foldl>pure_foldl</a></li><li><a href=#NBE-pure_kernel>pure_kernel</a></li><li><a href=#NBE-kernel_lift_tm>kernel_lift_tm</a></li><li><a href=#NBE-lift_ML_subst_ml>lift_ML_subst_ml</a></li><li><a href=#NBE-subst_ml_subst_ML>subst_ml_subst_ML</a></li><li><a href=#NBE-lift_is_subst_ml>lift_is_subst_ml</a></li><li><a href=#NBE-subst_ml_comp>subst_ml_comp</a></li><li><a href=#NBE-subst_kernel>subst_kernel</a></li><li><a href=#NBE-if_cong0>if_cong0</a></li><li><a href=#NBE-kernel_subst1>kernel_subst1</a></li><li><a href=#NBE-size_args_less_size_tm>size_args_less_size_tm</a></li><li><a href=#NBE-comp_pat_V>comp_pat_V</a></li><li><a href=#NBE-comp_pat_C>comp_pat_C</a></li><li><a href=#NBE-comp_pat_C_Nil>comp_pat_C_Nil</a></li><li><a href=#NBE-fv_ML_comp_open>fv_ML_comp_open</a></li><li><a href=#NBE-fv_ML_comp_pat>fv_ML_comp_pat</a></li><li><a href=#NBE-fv_compR_aux>fv_compR_aux</a></li><li><a href=#NBE-fv_compR>fv_compR</a></li><li><a href=#NBE-lift_compile>lift_compile</a></li><li><a href=#NBE-subst_ML_compile>subst_ML_compile</a></li><li><a href=#NBE-kernel_subst_ML_pat>kernel_subst_ML_pat</a></li><li><a href=#NBE-kernel_subst_ML>kernel_subst_ML</a></li><li><a href=#NBE-kernel_subst_ML_pat_map>kernel_subst_ML_pat_map</a></li><li><a href=#NBE-compR_Red_tm>compR_Red_tm</a></li><li><a href=#NBE-eq_Red_tm_trans>eq_Red_tm_trans</a></li><li><a href=#NBE-closed_ML_compile>closed_ML_compile</a></li><li><a href=#NBE-size_tm_foldl_At>size_tm_foldl_At</a></li><li><a href=#NBE-termination_no_match>termination_no_match</a></li><li><a href=#NBE-no_match>no_match</a></li><li><a href=#NBE-no_match_take>no_match_take</a></li><li><a href=#NBE-dterm_pure>dterm_pure</a></li><li><a href=#NBE-map_dterm_pure>map_dterm_pure</a></li><li><a href=#NBE-map_dterm_term>map_dterm_term</a></li><li><a href=#NBE-dterm_foldl_At>dterm_foldl_At</a></li><li><a href=#NBE-no_match_coincide>no_match_coincide</a></li><li><a href=#NBE-dterm_ML_comp_patD>dterm_ML_comp_patD</a></li><li><a href=#NBE-no_match_R_coincide_aux>no_match_R_coincide_aux</a></li><li><a href=#NBE-no_match_R_coincide>no_match_R_coincide</a></li><li><a href=#NBE-C_normal_term>C_normal_term</a></li><li><a href=#NBE-Red_ml_list_pres_no_match>Red_ml_list_pres_no_match</a></li><li><a href=#NBE-no_match_ML_subst_ML>no_match_ML_subst_ML</a></li><li><a href=#NBE-lift_is_CUD>lift_is_CUD</a></li><li><a href=#NBE-no_match_ML_lift_ML>no_match_ML_lift_ML</a></li><li><a href=#NBE-C_normal_ML_lift_ML>C_normal_ML_lift_ML</a></li><li><a href=#NBE-no_match_compR_Cons>no_match_compR_Cons</a></li><li><a href=#NBE-C_normal_ML_comp_open>C_normal_ML_comp_open</a></li><li><a href=#NBE-C_normal_compR_rhs>C_normal_compR_rhs</a></li><li><a href=#NBE-C_normal_ML_subst_ML>C_normal_ML_subst_ML</a></li><li><a href=#NBE-C_normal_ML_subst_ML_iff>C_normal_ML_subst_ML_iff</a></li><li><a href=#NBE-C_normal_ML_inv>C_normal_ML_inv</a></li><li><a href=#NBE-Red_term_hnf_induct>Red_term_hnf_induct</a></li><li><a href=#NBE-no_match_ML_lift>no_match_ML_lift</a></li><li><a href=#NBE-no_match_compR_lift>no_match_compR_lift</a></li><li><a href=#NBE-Red_term_pres_no_match>Red_term_pres_no_match</a></li><li><a href=#NBE-Red_term_pres_no_match_it>Red_term_pres_no_match_it</a></li><li><a href=#NBE-Red_term_pres_no_match_star>Red_term_pres_no_match_star</a></li><li><a href=#NBE-not_pure_term>not_pure_term</a></li><li><a href=#NBE-redts_term_cong>redts_term_cong</a></li><li><a href=#NBE-C_Red_term_ML>C_Red_term_ML</a></li><li><a href=#NBE-C_normal_subterm>C_normal_subterm</a></li><li><a href=#NBE-C_normal_subterms>C_normal_subterms</a></li><li><a href=#NBE-C_redt>C_redt</a></li><li><a href=#NBE-C_redts>C_redts</a></li><li><a href=#NBE-no_match_preserved>no_match_preserved</a></li><li><a href=#NBE-Lam_Red_term_itE>Lam_Red_term_itE</a></li><li><a href=#NBE-Red_term_it>Red_term_it</a></li><li><a href=#NBE-C_Red_term_it>C_Red_term_it</a></li><li><a href=#NBE-pure_At>pure_At</a></li><li><a href=#NBE-pure_foldl_At>pure_foldl_At</a></li><li><a href=#NBE-nbe_C_normal_ML>nbe_C_normal_ML</a></li><li><a href=#NBE-C_normal_ML_compile>C_normal_ML_compile</a></li><li><a href=#NBE-size_foldl_At>size_foldl_At</a></li><li><a href=#NBE-termination_linpats>termination_linpats</a></li><li><a href=#NBE-eq_lists_iff_eq_nth>eq_lists_iff_eq_nth</a></li><li><a href=#NBE-pattern_subst_ML_coincidence>pattern_subst_ML_coincidence</a></li><li><a href=#NBE-linpats_pattern>linpats_pattern</a></li><li><a href=#NBE-no_match_ML_swap_rev>no_match_ML_swap_rev</a></li><li><a href=#NBE-no_match_ML_aux>no_match_ML_aux</a></li></ul></li></ul></div><ul><li><a href=https://www.isa-afp.org/browser_info/current/AFP/NormByEval/outline.pdf>Proof
outline</a></li><li><a href=https://www.isa-afp.org/browser_info/current/AFP/NormByEval/document.pdf>Proof
document</a></li><li><a href=https://www.isa-afp.org/browser_info/current/AFP/NormByEval/session_graph.pdf>Theory dependencies</a></li></ul></div></aside><div class="content theories"><header><form action=/%20search><div class=form-container><input id=searchInput type=search size=31 maxlength=255 aria-label="Search the AFP" list=autocomplete><button id=searchButton type=button><img src=/images/search.svg alt=Search></button>
<datalist id=autocomplete></datalist></div></form><h1><span class=first>S</span>ession <span class=first>N</span>orm<span class=first>B</span>y<span class=first>E</span>val</h1><div></div></header><div id=banner data-id=0><p>This is an unofficial reimagining of the <a href=https://isa-afp.org target=_blank rel="noreferrer noopener">Archive of Formal Proofs</a></p><button style=display:none id=close title=close><svg viewBox="0 0 6.718 6.718" aria-hidden="true" focusable="false"><rect transform="rotate(45)" x="4" y="-4" width="1.5" height="8"/><rect transform="rotate(45)" x=".75" y="-.75" width="8" height="1.5"/></svg></button></div><div><main><div id=NBE><div class=head><h1>Theory NBE</h1></div><pre class=source><span class=comment1>(*  Author:     Klaus Aehlig, Tobias Nipkow

Normalization by Evaluation.
*)</span>
<span class=comment1>(*&lt;*)</span>
<span class=keyword1><span class=command>theory</span></span> NBE <span class=keyword2><span class=keyword>imports</span></span> <a href=../../HOL/HOL/Main.html>Main</a> <span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>syntax_ambiguity_warning</span> <span class=main><span class=main>=</span></span> <span class=quasi_keyword>false</span><span class=main>]</span><span class=main>]</span>

<span class=keyword1><span class=command>declare</span></span> Let_def<span class=main>[</span><span class=operator>simp</span><span class=main>]</span>
<span class=comment1>(*&gt;*)</span>
<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Terms"</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> vname <span class=main>=</span> <span class=quoted>nat</span>
<span class=keyword1><span class=command>type_synonym</span></span> ml_vname <span class=main>=</span> <span class=quoted>nat</span>

<span class=comment1>(* FIXME only for codegen*)</span>
<span class=keyword1><span class=command>type_synonym</span></span> cname <span class=main>=</span> <span class=quoted>int</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹ML terms:›</span></span>

<span class=keyword1><span class=command>datatype</span></span> ml <span class=main>=</span>
 <span class=comment1>― ‹ML›</span>
  C_ML <span class=quoted>cname</span> <span class=main>(</span><span class=quoted>"<span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class=main>)</span> <span class=comment1>(* ref to compiled code *)</span>
<span class=main>|</span> V_ML <span class=quoted>ml_vname</span> <span class=main>(</span><span class=quoted>"<span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class=main>)</span>
<span class=main>|</span> A_ML <span class=quoted>ml</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ml list<span class=main>)</span>"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class=main>)</span>
<span class=main>|</span> Lam_ML <span class=quoted>ml</span> <span class=main>(</span><span class=quoted>"<span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class=main>)</span>
 <span class=comment1>― ‹the universal datatype›</span>
<span class=main>|</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=quoted>cname</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ml list<span class=main>)</span>"</span></span>
<span class=main>|</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=quoted>vname</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ml list<span class=main>)</span>"</span></span>
<span class=main>|</span> Clo <span class=quoted>ml</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ml list<span class=main>)</span>"</span></span> <span class=quoted>nat</span>
 <span class=comment1>― ‹ML function \emph{apply}›</span>
<span class=main>|</span> <span class=quoted>"apply"</span> <span class=quoted>ml</span> <span class=quoted>ml</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Lambda-terms:›</span></span>

<span class=keyword1><span class=command>datatype</span></span> tm <span class=main>=</span> C <span class=quoted>cname</span> <span class=main>|</span> V <span class=quoted>vname</span> <span class=main>|</span> Λ <span class=quoted>tm</span> <span class=main>|</span> At <span class=quoted>tm</span> <span class=quoted>tm</span> <span class=main>(</span><span class=keyword2><span class=keyword>infix</span></span> <span class=quoted>"<span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1><span class=keyword1>∙</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 100<span class=main>)</span>
            <span class=main>|</span> <span class=quoted>"term"</span> <span class=quoted>ml</span>   <span class=comment1>― ‹ML function \texttt{term}›</span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹The following locale captures type conventions for variables.
  It is not actually used, merely a formal comment.›</span></span>

<span class=keyword1><span class=command>locale</span></span> Vars <span class=main>=</span>
 <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>r</span> <span class=free>s</span> <span class=free>t</span><span class=main>::</span> <span class=quoted>tm</span>
 <span class=keyword2><span class=keyword>and</span></span> <span class=free>rs</span> <span class=free>ss</span> <span class=free>ts</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list"</span></span>
 <span class=keyword2><span class=keyword>and</span></span> <span class=free>u</span> <span class=free>v</span> <span class=free>w</span> <span class=main>::</span> <span class=quoted>ml</span>
 <span class=keyword2><span class=keyword>and</span></span> <span class=free>us</span> <span class=free>vs</span> <span class=free>ws</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml list"</span></span>
 <span class=keyword2><span class=keyword>and</span></span> <span class=free>nm</span> <span class=main>::</span> <span class=quoted>cname</span>
 <span class=keyword2><span class=keyword>and</span></span> <span class=free>x</span> <span class=main>::</span> <span class=quoted>vname</span>
 <span class=keyword2><span class=keyword>and</span></span> <span class=free>X</span> <span class=main>::</span> <span class=quoted>ml_vname</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The subset of pure terms:›</span></span>

<span class=keyword1><span class=command>inductive</span></span> <span class=entity>pure</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>pure</span><span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>pure</span><span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
Lam<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>pure</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>⟹</span> <span class=free>pure</span><span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>pure</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>⟹</span> <span class=free>pure</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>⟹</span> <span class=free>pure</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>∙</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> pure.intros<span class=main>[</span><span class=operator>simp</span><span class=main>]</span>
<span class=keyword1><span class=command>declare</span></span> Lam<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>

<span class=keyword1 id=NBE-pure_Lam><span class=command>lemma</span></span> pure_Lam<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"pure<span class=main>(</span>Λ <span class=free>t</span><span class=main>)</span> <span class=main>=</span> pure <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"pure<span class=main>(</span>Λ <span class=free>t</span><span class=main>)</span>"</span></span> <span class=keyword3><span class=command>thus</span></span> <span class=quoted><span class=quoted>"pure <span class=free>t</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span> <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"pure <span class=free>t</span>"</span></span> <span class=keyword3><span class=command>thus</span></span> <span class=quoted><span class=quoted>"pure<span class=main>(</span>Λ <span class=free>t</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> Lam<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Closed terms w.r.t.\ ML variables:›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>closed_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ml <span class=main>⇒</span> bool"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>&lt;</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span>"</span></span>  <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>∧</span> <span class=keyword1><span class=free>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>closed_tm_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> tm <span class=main>⇒</span> bool"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>r</span></span></span><span class=main>∙</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>r</span></span></span> <span class=main>∧</span> <span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>term <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> closed_ML <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>closed_tm_ML</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>=</span> True"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Free variables:›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>fv_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> ml_vname set"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>}</span>"</span></span>  <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=bound>X</span><span class=main>.</span> Suc <span class=bound>X</span> <span class=main>:</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>}</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>∪</span> <span class=keyword1><span class=free>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span>"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>fv</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> vname set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>fv</span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>fv</span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>}</span>"</span></span>  <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>fv</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>fv</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∪</span> <span class=free>fv</span> <span class=free><span class=bound><span class=entity>t</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>fv</span> <span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=bound>X</span><span class=main>.</span> Suc <span class=bound>X</span> <span class=main>:</span> <span class=free>fv</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>}</span>"</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Iterated Term Application"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>foldl_At</span> <span class=main>(</span><span class=keyword2><span class=keyword>infix</span></span> <span class=quoted>"<span class=keyword1>∙∙</span>"</span> 90<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>∙∙</span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≡</span> foldl <span class=main>(∙)</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Auxiliary measure function:›</span></span>
<span class=keyword1><span class=command>primrec</span></span> <span class=entity>depth_At</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> nat"</span></span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>depth_At</span><span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>depth_At</span><span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>depth_At</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>depth_At</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>+</span> <span class=main>1</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>depth_At</span><span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>depth_At</span><span class=main>(</span>term <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>

<span class=keyword1 id=NBE-depth_At_foldl><span class=command>lemma</span></span> depth_At_foldl<span class=main>:</span>
 <span class=quoted><span class=quoted>"depth_At<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> depth_At <span class=free>s</span> <span class=main>+</span> size <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-foldl_At_eq_lemma><span class=command>lemma</span></span> foldl_At_eq_lemma<span class=main>:</span> <span class=quoted><span class=quoted>"size <span class=free>ts</span> <span class=main>=</span> size <span class=free>ts'</span> <span class=main>⟹</span>
 <span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>s'</span> <span class=main>∙∙</span> <span class=free>ts'</span> <span class=main>⟷</span> <span class=free>s</span> <span class=main>=</span> <span class=free>s'</span> <span class=main>∧</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>list_induct2<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-foldl_At_eq_length><span class=command>lemma</span></span> foldl_At_eq_length<span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts'</span> <span class=main>⟹</span> length <span class=free>ts</span> <span class=main>=</span> length <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"depth_At<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> depth_At<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts'</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> thin_rl<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>depth_At_foldl<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-foldl_At_eq><span class=command>lemma</span></span> foldl_At_eq<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts'</span> <span class=main>⟷</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>foldl_At_eq_lemma foldl_At_eq_length<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-term_eq_foldl_At><span class=command>lemma</span></span> term_eq_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"term <span class=free>v</span> <span class=main>=</span> <span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟷</span> <span class=free>t</span> <span class=main>=</span> term <span class=free>v</span> <span class=main>∧</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-At_eq_foldl_At><span class=command>lemma</span></span> At_eq_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>r</span> <span class=main>∙</span> <span class=free>s</span> <span class=main>=</span> <span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟷</span>
  <span class=main>(</span><span class=keyword1>if</span> <span class=free>ts</span><span class=main>=</span><span class=main>[]</span> <span class=keyword1>then</span> <span class=free>t</span> <span class=main>=</span> <span class=free>r</span> <span class=main>∙</span> <span class=free>s</span> <span class=keyword1>else</span> <span class=free>s</span> <span class=main>=</span> last <span class=free>ts</span> <span class=main>∧</span> <span class=free>r</span> <span class=main>=</span> <span class=free>t</span> <span class=main>∙∙</span> butlast <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>t</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>ts'</span> <span class=bound>t'</span><span class=main>.</span> <span class=improper>ts</span> <span class=main>=</span> <span class=bound>ts'</span> <span class=main>@</span> <span class=main>[</span><span class=bound>t'</span><span class=main>]</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>list.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> append_butlast_last_id<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-foldl_At_eq_At><span class=command>lemma</span></span> foldl_At_eq_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>=</span> <span class=free>r</span> <span class=main>∙</span> <span class=free>s</span> <span class=main>⟷</span>
  <span class=main>(</span><span class=keyword1>if</span> <span class=free>ts</span><span class=main>=</span><span class=main>[]</span> <span class=keyword1>then</span> <span class=free>t</span> <span class=main>=</span> <span class=free>r</span> <span class=main>∙</span> <span class=free>s</span> <span class=keyword1>else</span> <span class=free>s</span> <span class=main>=</span> last <span class=free>ts</span> <span class=main>∧</span> <span class=free>r</span> <span class=main>=</span> <span class=free>t</span> <span class=main>∙∙</span> butlast <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> At_eq_foldl_At<span class=main>)</span>

<span class=keyword1 id=NBE-Lam_eq_foldl_At><span class=command>lemma</span></span> Lam_eq_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"Λ <span class=free>s</span> <span class=main>=</span> <span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟷</span> <span class=free>t</span> <span class=main>=</span> Λ <span class=free>s</span> <span class=main>∧</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-foldl_At_eq_Lam><span class=command>lemma</span></span> foldl_At_eq_Lam<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>=</span> Λ <span class=free>s</span> <span class=main>⟷</span> <span class=free>t</span> <span class=main>=</span> Λ <span class=free>s</span> <span class=main>∧</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∙</span> <span class=free>t</span> <span class=main>≠</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"size<span class=main>(</span><span class=free>s</span> <span class=main>∙</span> <span class=free>t</span><span class=main>)</span> <span class=main>≠</span> size <span class=free>s</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=comment1>(* Better: a simproc for disproving "s = t"
   if s is a subterm of t or vice versa, by proving "size s ~= size t"
*)</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>atomic_tm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>atomic_tm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> False"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>atomic_tm</span><span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>head_tm</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>head_tm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>head_tm</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>head_tm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>args_tm</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>args_tm</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>args_tm</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>args_tm</span><span class=main>(</span><span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>

<span class=keyword1 id=NBE-head_tm_foldl_At><span class=command>lemma</span></span> head_tm_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"head_tm<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> head_tm <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-args_tm_foldl_At><span class=command>lemma</span></span> args_tm_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"args_tm<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> args_tm <span class=free>s</span> <span class=main>@</span> <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-tm_eq_iff><span class=command>lemma</span></span> tm_eq_iff<span class=main>:</span>
  <span class=quoted><span class=quoted>"atomic_tm<span class=main>(</span>head_tm <span class=free>s</span><span class=main>)</span> <span class=main>⟹</span> atomic_tm<span class=main>(</span>head_tm <span class=free>t</span><span class=main>)</span>
   <span class=main>⟹</span> <span class=free>s</span> <span class=main>=</span> <span class=free>t</span> <span class=main>⟷</span> head_tm <span class=free>s</span> <span class=main>=</span> head_tm <span class=free>t</span> <span class=main>∧</span> args_tm <span class=free>s</span> <span class=main>=</span> args_tm <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>s</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper><span class=quoted><span class=improper><span class=quoted><span class=improper><span class=quoted><span class=improper><span class=quoted><span class=improper>t</span></span></span></span></span></span></span></span></span></span><span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>declare</span></span>
  tm_eq_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∙∙</span> <span class=free>ts</span>"</span></span><span class=main>,</span> <span class=operator>simp</span><span class=main>]</span>
  tm_eq_iff<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∙∙</span> <span class=free>ts</span>"</span></span><span class=main>,</span> <span class=operator>simp</span><span class=main>]</span>
  <span class=keyword2><span class=keyword>for</span></span> <span class=free>h</span> <span class=free>ts</span>

<span class=keyword1 id=NBE-atomic_tm_head_tm><span class=command>lemma</span></span> atomic_tm_head_tm<span class=main>:</span> <span class=quoted><span class=quoted>"atomic_tm<span class=main>(</span>head_tm <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-head_tm_idem><span class=command>lemma</span></span> head_tm_idem<span class=main>:</span> <span class=quoted><span class=quoted>"head_tm<span class=main>(</span>head_tm <span class=free>t</span><span class=main>)</span> <span class=main>=</span> head_tm <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-args_tm_head_tm><span class=command>lemma</span></span> args_tm_head_tm<span class=main>:</span> <span class=quoted><span class=quoted>"args_tm<span class=main>(</span>head_tm <span class=free>t</span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-eta_head_args><span class=command>lemma</span></span> eta_head_args<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>=</span> head_tm <span class=free>t</span> <span class=main>∙∙</span> args_tm <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> tm_eq_iff<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> atomic_tm_head_tm head_tm_idem args_tm_head_tm<span class=main>)</span>


<span class=keyword1 id=NBE-tm_vector_cases><span class=command>lemma</span></span> tm_vector_cases<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>n</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> V <span class=bound>n</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∨</span>
   <span class=main>(</span><span class=main>∃</span><span class=bound>nm</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∨</span>
   <span class=main>(</span><span class=main>∃</span><span class=bound>t'</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> Λ <span class=bound>t'</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>∨</span>
   <span class=main>(</span><span class=main>∃</span><span class=bound>v</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> term <span class=bound>v</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> snoc_eq_iff_butlast<span class=main>)</span>

<span class=keyword1 id=NBE-fv_head_C><span class=command>lemma</span></span> fv_head_C<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"fv <span class=main>(</span><span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> fv <span class=free>t</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> fv <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Lifting and Substitution"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>lift_ml</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ml <span class=main>⇒</span> ml"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>lift</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> Clo <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>u</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> apply <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>u</span></span></span><span class=main>)</span> <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>lemmas</span></span> ml_induct <span class=main>=</span> lift_ml.induct<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>i</span> <span class=bound>v</span><span class=main>.</span> <span class=free>P</span> <span class=bound>v</span>"</span></span><span class=main>]</span> <span class=keyword2><span class=keyword>for</span></span> <span class=free>P</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>lift_tm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> tm <span class=main>⇒</span> tm"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>lift</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> C <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> V<span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>∙</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span><span class=main>∙</span><span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> Λ<span class=main>(</span><span class=keyword1><span class=free>lift</span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift</span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>term <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> term <span class=main>(</span><span class=keyword1>lift</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>lift_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ml <span class=main>⇒</span> ml"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=main>&lt;</span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>X</span></span></span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>+</span><span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> Clo <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>u</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> apply <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>u</span></span></span><span class=main>)</span> <span class=main>(</span><span class=keyword1><span class=free>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>i</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
 <span class=entity>cons</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> tm<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> tm<span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>infix</span></span> <span class=quoted>"<span class=keyword1>##</span>"</span> 65<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span><span class=main><span class=free>##</span></span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>i</span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>|</span> Suc <span class=bound>j</span> <span class=main>⇒</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span>
 <span class=entity>cons_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> ml<span class=main>)</span> <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> ml<span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>infix</span></span> <span class=quoted>"<span class=keyword1>##</span>"</span> 65<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>v</span></span></span><span class=main><span class=free>##</span></span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>i</span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>::</span>ml <span class=main>|</span> Suc <span class=bound>j</span> <span class=main>⇒</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>j</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Only for pure terms!›</span></span>
<span class=keyword1><span class=command>primrec</span></span> <span class=entity>subst</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>nat <span class=main>⇒</span> tm<span class=main>)</span> <span class=main>⇒</span> tm <span class=main>⇒</span> tm"</span></span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>subst</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> C <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>subst</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>subst</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> Λ<span class=main>(</span><span class=free>subst</span> <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>subst</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>∙</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>subst</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>∙</span> <span class=main>(</span><span class=free>subst</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>subst_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>nat <span class=main>⇒</span> ml<span class=main>)</span> <span class=main>⇒</span> ml <span class=main>⇒</span> ml"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>X</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> Clo <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>u</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> apply <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>u</span></span></span><span class=main>)</span> <span class=main>(</span><span class=keyword1><span class=free>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span>
<span class=comment1>(* FIXME currrently needed for code generator
lemmas [code] = lift_tm.simps lift_ml.simps
lemmas [code] = subst_ML.simps *)</span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>subst_decr</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> tm <span class=main>⇒</span> nat <span class=main>⇒</span> tm"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>subst_decr</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>&lt;</span><span class=free><span class=bound><span class=entity>k</span></span></span> <span class=keyword1>then</span> V <span class=bound>n</span> <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>=</span><span class=free><span class=bound><span class=entity>k</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=keyword1>else</span> V<span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>subst_decr_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ml <span class=main>⇒</span> nat <span class=main>⇒</span> ml"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>subst_decr_ML</span> <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>≡</span> <span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>&lt;</span><span class=free><span class=bound><span class=entity>k</span></span></span> <span class=keyword1>then</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>n</span> <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>=</span><span class=free><span class=bound><span class=entity>k</span></span></span> <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>subst1</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> tm <span class=main>⇒</span> nat <span class=main>⇒</span> tm"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword3>(</span>_<span class=keyword3>/</span><span class=keyword1>[</span>_<span class=keyword1>'/</span>_<span class=keyword1>]</span><span class=keyword3>)</span>"</span> <span class=main>[</span>300<span class=main>,</span> 0<span class=main>,</span> 0<span class=main>]</span> 300<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
 <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span><span class=main><span class=free>[</span></span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main><span class=free>/</span></span><span class=free><span class=bound><span class=entity>k</span></span></span><span class=main><span class=free>]</span></span> <span class=main>≡</span> subst <span class=main>(</span>subst_decr <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>subst1_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> ml <span class=main>⇒</span> nat <span class=main>⇒</span> ml"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword3>(</span>_<span class=keyword3>/</span><span class=keyword1>[</span>_<span class=keyword1>'/</span>_<span class=keyword1>]</span><span class=keyword3>)</span>"</span> <span class=main>[</span>300<span class=main>,</span> 0<span class=main>,</span> 0<span class=main>]</span> 300<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
 <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>u</span></span></span><span class=main><span class=free>[</span></span><span class=free><span class=bound><span class=entity>v</span></span></span><span class=main><span class=free>/</span></span><span class=free><span class=bound><span class=entity>k</span></span></span><span class=main><span class=free>]</span></span> <span class=main>≡</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>subst_decr_ML <span class=free><span class=bound><span class=entity>k</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>u</span></span></span>"</span></span>

<span class=keyword1 id=NBE-apply_cons><span class=command>lemma</span></span> apply_cons<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t</span><span class=main>##</span><span class=free>σ</span><span class=main>)</span> <span class=free>i</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>i</span><span class=main>=</span><span class=main>0</span> <span class=keyword1>then</span> <span class=free>t</span><span class=main>::</span>tm <span class=keyword1>else</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span><span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> cons_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>

<span class=keyword1 id=NBE-apply_cons_ML><span class=command>lemma</span></span> apply_cons_ML<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span><span class=main>##</span><span class=free>σ</span><span class=main>)</span> <span class=free>i</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>i</span><span class=main>=</span><span class=main>0</span> <span class=keyword1>then</span> <span class=free>v</span><span class=main>::</span>ml <span class=keyword1>else</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span><span class=main>(</span><span class=free>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> cons_ML_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>

<span class=keyword1 id=NBE-lift_foldl_At><span class=command>lemma</span></span> lift_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=free>k</span> <span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>s</span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span><span class=main>)</span> <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-lift_lift_ml><span class=command>lemma</span></span> lift_lift_ml<span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=main>::</span> <span class=quoted>ml</span> <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>+</span><span class=main>1</span> <span class=main>⟹</span> <span class=keyword1>lift</span> <span class=main>(</span>Suc <span class=free>k</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>i</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=free>i</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>lift_ml.induct<span class=main>)</span>
  <span class=operator>simp_all</span>
<span class=keyword1 id=NBE-lift_lift_tm><span class=command>lemma</span></span> lift_lift_tm<span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>t</span> <span class=main>::</span> <span class=quoted>tm</span> <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>+</span><span class=main>1</span> <span class=main>⟹</span> <span class=keyword1>lift</span> <span class=main>(</span>Suc <span class=free>k</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>i</span> <span class=free>t</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=free>i</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>lift_tm.induct<span class=main>)</span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_lift_ml<span class=main>)</span>

<span class=keyword1 id=NBE-lift_lift_ML><span class=command>lemma</span></span> lift_lift_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>+</span><span class=main>1</span> <span class=main>⟹</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=free>k</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>i</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>i</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>lift_ML.induct<span class=main>)</span>
  <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-lift_lift_ML_comm><span class=command>lemma</span></span> lift_lift_ML_comm<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=free>j</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>i</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>i</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>j</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>j</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>lift_ML.induct<span class=main>)</span>
  <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-V_ML_cons_ML_subst_decr><span class=command>lemma</span></span> V_ML_cons_ML_subst_decr<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> subst_decr_ML <span class=free>k</span> <span class=free>v</span> <span class=main>=</span> subst_decr_ML <span class=main>(</span>Suc <span class=free>k</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>cons_ML_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>

<span class=keyword1 id=NBE-shift_subst_decr><span class=command>lemma</span></span> shift_subst_decr<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
 <span class=quoted><span class=quoted>"V <span class=main>0</span> <span class=main>##</span> subst_decr <span class=free>k</span> <span class=free>t</span> <span class=main>=</span> subst_decr <span class=main>(</span>Suc <span class=free>k</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>cons_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>

<span class=keyword1 id=NBE-lift_comp_subst_decr><span class=command>lemma</span></span> lift_comp_subst_decr<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=main>0</span> <span class=keyword1>o</span> subst_decr_ML <span class=free>k</span> <span class=free>v</span> <span class=main>=</span> subst_decr_ML <span class=free>k</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span> <span class=operator>simp</span>

<span class=keyword1 id=NBE-subst_ML_ext><span class=command>lemma</span></span> subst_ML_ext<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=free>σ'</span> <span class=bound>i</span> <span class=main>⟹</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> ext<span class=main>)</span>

<span class=keyword1 id=NBE-subst_ext><span class=command>lemma</span></span> subst_ext<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=free>σ'</span> <span class=bound>i</span> <span class=main>⟹</span> subst <span class=free>σ</span> <span class=free>v</span> <span class=main>=</span> subst <span class=free>σ'</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> ext<span class=main>)</span>

<span class=keyword1 id=NBE-lift_Pure_tms><span class=command>lemma</span></span> lift_Pure_tms<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> pure<span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-cons_ML_V_ML><span class=command>lemma</span></span> cons_ML_V_ML<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span> <span class=operator>simp</span>

<span class=keyword1 id=NBE-cons_V><span class=command>lemma</span></span> cons_V<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> V<span class=main>)</span> <span class=main>=</span> V"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span> <span class=operator>simp</span>

<span class=keyword1 id=NBE-lift_o_shift><span class=command>lemma</span></span> lift_o_shift<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=free>k</span> <span class=main>∘</span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=free>σ</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=main>∘</span> <span class=free>σ</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lift_lift_ML_comm<span class=main>)</span>

<span class=keyword1 id=NBE-lift_subst_ML><span class=command>lemma</span></span> lift_subst_ML<span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=free>k</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=main>∘</span> <span class=free>σ</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>subst_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> o_assoc lift_o_shift <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>apply_cons_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>o_def<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>corollary</span></span> lift_subst_ML1<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>v</span> <span class=bound>k</span><span class=main>.</span> lift_ml <span class=main>0</span> <span class=main>(</span><span class=free>u</span><span class=main>[</span><span class=bound>v</span><span class=main>/</span><span class=bound>k</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=free>u</span><span class=main>)</span><span class=main>[</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=bound>v</span><span class=main>/</span><span class=bound>k</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>u</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>ml_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_lift_ml lift_subst_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> lift_lift_ML_comm<span class=main>)</span><span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-lift_ML_subst_ML><span class=command>lemma</span></span> lift_ML_subst_ML<span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span>
  <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>i</span><span class=main>&lt;</span><span class=free>k</span> <span class=keyword1>then</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>i</span><span class=main>=</span><span class=free>k</span> <span class=keyword1>then</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=keyword1>else</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=free>σ</span><span class=main>(</span><span class=bound>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
  <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=var>?insrt</span> <span class=free>k</span> <span class=free>σ</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> lift_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> o_assoc lift_o_shift<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=var>?insrt</span> <span class=improper>k</span> <span class=improper>σ</span> <span class=main>=</span> <span class=var>?insrt</span> <span class=main>(</span>Suc <span class=improper>k</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=improper>σ</span><span class=main>)</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fun_eq_iff lift_lift_ML cons_ML_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>corollary</span></span> subst_cons_lift<span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=free>σ</span><span class=main>)</span> <span class=keyword1>o</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=keyword1>o</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lift_ML_subst_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=free>σ</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>i</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=keyword1>else</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span> <span class=main>(</span><span class=bound>i</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-lift_ML_id><span class=command>lemma</span></span> lift_ML_id<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>=</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> lift_ML.induct<span class=main>)</span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>

<span class=keyword1 id=NBE-subst_ML_id><span class=command>lemma</span></span> subst_ML_id<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span><span class=free>k</span><span class=main>.</span> <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>i</span> <span class=main>⟹</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span> <span class=main>=</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> subst_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>Ball_def<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>vs</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>k</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>k</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>vs</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>k</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>vs</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>k</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>vs</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>k</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>k</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>corollary</span></span> subst_ML_id2<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span> <span class=main>=</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> subst_ML_id<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k<span class=main><span class=main>=</span></span><span class=quoted><span class=main>0</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=NBE-subst_ML_coincidence><span class=command>lemma</span></span> subst_ML_coincidence<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span><span class=free>k</span><span class=main>.</span> <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=free>σ'</span> <span class=bound>i</span> <span class=main>⟹</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>σ'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> subst_ML.induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-subst_ML_comp><span class=command>lemma</span></span> subst_ML_comp<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span>  <span class=main>∘</span> <span class=free>σ'</span><span class=main>)</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ'</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> subst_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_eq_iff_nth_eq<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> subst_ML_ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> o_apply subst_cons_lift<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-subst_ML_comp2><span class=command>lemma</span></span> subst_ML_comp2<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=free>σ''</span> <span class=bound>i</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=main>(</span><span class=free>σ'</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ''</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>subst_ML_comp subst_ML_ext<span class=main>)</span>

<span class=keyword1 id=NBE-closed_tm_ML_foldl_At><span class=command>lemma</span></span> closed_tm_ML_foldl_At<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟷</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>t</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=free>ts</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-closed_ML_lift><span class=command>lemma</span></span> closed_ML_lift<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=main>::</span> <span class=quoted>ml</span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>m</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> lift_ML.induct<span class=main>)</span>
  <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>

<span class=keyword1 id=NBE-closed_ML_Suc><span class=command>lemma</span></span> closed_ML_Suc<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>n</span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=free>n</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>n</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> lift_ML.induct<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-closed_ML_subst_ML><span class=command>lemma</span></span> closed_ML_subst_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> subst_ML.induct<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> closed_ML_Suc<span class=main>)</span>

<span class=keyword1 id=NBE-closed_ML_subst_ML2><span class=command>lemma</span></span> closed_ML_subst_ML2<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span><span class=free>k</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>l</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>l</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>l</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> subst_ML.induct<span class=main>)</span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> closed_ML_Suc<span class=main>)</span>


<span class=keyword1 id=NBE-subst_foldl><span class=command>lemma</span></span> subst_foldl<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
 <span class=quoted><span class=quoted>"subst <span class=free>σ</span> <span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>subst <span class=free>σ</span> <span class=free>s</span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=main>(</span>subst <span class=free>σ</span><span class=main>)</span> <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-subst_V><span class=command>lemma</span></span> subst_V<span class=main>:</span> <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> subst V <span class=free>t</span> <span class=main>=</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-lift_subst_aux><span class=command>lemma</span></span> lift_subst_aux<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span><span class=free>k</span><span class=main>.</span> <span class=free>σ'</span> <span class=bound>i</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=free>k</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
   <span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>≥</span><span class=free>k</span><span class=main>.</span> <span class=free>σ'</span><span class=main>(</span>Suc <span class=bound>i</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=free>k</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> 
  <span class=free>σ'</span> <span class=free>k</span> <span class=main>=</span> V <span class=free>k</span> <span class=main>⟹</span> <span class=keyword1>lift</span> <span class=free>k</span> <span class=main>(</span>subst <span class=free>σ</span> <span class=free>t</span><span class=main>)</span> <span class=main>=</span> subst <span class=free>σ'</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>σ'</span></span> <span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_allE<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_impE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_impE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_mp<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> cons_def lift_lift_ml lift_lift_tm <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>corollary</span></span> lift_subst<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>subst <span class=free>σ</span> <span class=free>t</span><span class=main>)</span> <span class=main>=</span> subst <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> <span class=free>σ</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lift_subst_aux lift_lift_ml<span class=main>)</span>

<span class=keyword1 id=NBE-subst_comp><span class=command>lemma</span></span> subst_comp<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> pure<span class=main>(</span><span class=free>σ'</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
   <span class=free>σ''</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> subst <span class=free>σ</span> <span class=main>(</span><span class=free>σ'</span> <span class=bound>i</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span> subst <span class=free>σ</span> <span class=main>(</span>subst <span class=free>σ'</span> <span class=free>t</span><span class=main>)</span> <span class=main>=</span> subst <span class=free>σ''</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>σ'</span></span> <span class=quoted><span class=free>σ''</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>no_asm</span><span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_allE<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_impE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_mp<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_subst<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Reduction"</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Patterns"</span></span>

<span class=keyword1><span class=command>inductive</span></span> <span class=entity>pattern</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> bool"</span></span>
      <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>patterns</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
       <span class=quoted><span class=quoted>"<span class=free>patterns</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=free>pattern</span> <span class=bound>t</span>"</span></span> <span class=main>|</span>
pat_V<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>pattern</span><span class=main>(</span>V <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
pat_C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>patterns</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>⟹</span> <span class=free>pattern</span><span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>∙∙</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=NBE-pattern_Lam><span class=command>lemma</span></span> pattern_Lam<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> pattern<span class=main>(</span>Λ <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> pattern.cases<span class=main>)</span>

<span class=keyword1 id="NBE-pattern_At'D12"><span class=command>lemma</span></span> pattern_At'D12<span class=main>:</span> <span class=quoted><span class=quoted>"pattern <span class=free>r</span> <span class=main>⟹</span> <span class=free>r</span> <span class=main>=</span> <span class=main>(</span><span class=free>s</span> <span class=main>∙</span> <span class=free>t</span><span class=main>)</span> <span class=main>⟹</span> pattern <span class=free>s</span> <span class=main>∧</span> pattern <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>t</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pattern<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> pat_V <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> pat_C <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> atomic_tm_head_tm <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>if_split_asm<span class=main>)</span>
       <span class=main>(</span><span class=operator>metis</span> eta_head_args in_set_butlastD pattern.pat_C<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-pattern_AtD12><span class=command>lemma</span></span> pattern_AtD12<span class=main>:</span> <span class=quoted><span class=quoted>"pattern<span class=main>(</span><span class=free>s</span> <span class=main>∙</span> <span class=free>t</span><span class=main>)</span> <span class=main>⟹</span> pattern <span class=free>s</span> <span class=main>∧</span> pattern <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> pattern_At'D12<span class=main>)</span>

<span class=keyword1 id=NBE-pattern_At_vecD><span class=command>lemma</span></span> pattern_At_vecD<span class=main>:</span> <span class=quoted><span class=quoted>"pattern<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟹</span> patterns <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rev_induct<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span>pattern_AtD12<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-pattern_At_decomp><span class=command>lemma</span></span> pattern_At_decomp<span class=main>:</span> <span class=quoted><span class=quoted>"pattern<span class=main>(</span><span class=free>s</span> <span class=main>∙</span> <span class=free>t</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>nm</span> <span class=bound>ss</span><span class=main>.</span> <span class=free>s</span> <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ss</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>s</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>At <span class=skolem>s1</span> <span class=skolem>s2</span><span class=main>)</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> At <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> foldl_Cons foldl_Nil foldl_append pattern_AtD12<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span> pattern.cases <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>if_split_asm<span class=main>)</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Reduction of <span class=antiquoted><span class=raw_text><span class=antiquoted><span class=raw_text><span class=operator><span class=operator>‹</span></span>λ›</span></span></span></span>-terms"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The source program:›</span></span>

<span class=keyword1><span class=command>axiomatization</span></span> <span class=free>R</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>cname <span class=main>*</span> tm list <span class=main>*</span> tm<span class=main>)</span>set"</span></span> <span class=keyword2><span class=keyword>where</span></span>
pure_R<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span><span class=free>ts</span><span class=main>,</span><span class=free>t</span><span class=main>)</span> <span class=main>:</span> <span class=free>R</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=free>ts</span><span class=main>.</span> pure <span class=bound>t</span><span class=main>)</span> <span class=main>∧</span> pure <span class=free>t</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
fv_R<span class=main>:</span>   <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span><span class=free>ts</span><span class=main>,</span><span class=free>t</span><span class=main>)</span> <span class=main>:</span> <span class=free>R</span> <span class=main>⟹</span> <span class=free>X</span> <span class=main>:</span> fv <span class=free>t</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>t'</span> <span class=main>∈</span> set <span class=free>ts</span><span class=main>.</span> <span class=free>X</span> <span class=main>:</span> fv <span class=bound>t'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
pattern_R<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span><span class=free>ts</span><span class=main>,</span><span class=free>t'</span><span class=main>)</span> <span class=main>:</span> <span class=free>R</span> <span class=main>⟹</span> patterns <span class=free>ts</span>"</span></span>

<span class=keyword1><span class=command>inductive_set</span></span>
  <span class=entity>Red_tm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>tm <span class=main>*</span> tm<span class=main>)</span>set"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>red_tm</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>tm<span class=main>,</span> tm<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>→</span>"</span> 50<span class=main>)</span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Red_tm</span>"</span></span>
 <span class=comment1>― ‹$\beta$-reduction›</span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>[</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
 <span class=comment1>― ‹$\eta$-expansion›</span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>→</span></span> Λ <span class=main>(</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∙</span> <span class=main>(</span>V <span class=main>0</span><span class=main>)</span><span class=main>)</span>"</span></span>
 <span class=comment1>― ‹Rewriting›</span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>:</span> R <span class=main>⟹</span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=main>(</span>subst <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main><span class=free>→</span></span> subst <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>⟹</span> Λ <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>→</span></span> Λ <span class=free><span class=bound><span class=entity>t'</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>s'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>s'</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>→</span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t'</span></span></span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>reds_tm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>tm<span class=main>,</span> tm<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>→*</span>"</span> 50<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>→*</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∈</span> Red_tm<span class=main>^*</span>"</span></span>

<span class=keyword1><span class=command>inductive_set</span></span>
  <span class=entity>Reds_tm_list</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>tm list <span class=main>*</span> tm list<span class=main>)</span> set"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>reds_tm_list</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>tm list<span class=main>,</span> tm list<span class=main>]</span> <span class=main>⇒</span> bool"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>→*</span>"</span> 50<span class=main>)</span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=main><span class=free>→*</span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Reds_tm_list</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main><span class=free>→*</span></span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main><span class=free>→*</span></span> <span class=free><span class=bound><span class=entity>ts'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>→*</span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main><span class=free>→*</span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>ts'</span></span></span>"</span></span>


<span class=keyword1><span class=command>declare</span></span> Reds_tm_list.intros<span class=main>[</span><span class=operator>simp</span><span class=main>]</span>

<span class=keyword1 id=NBE-Reds_tm_list_refl><span class=command>lemma</span></span> Reds_tm_list_refl<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ts</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>ts</span> <span class=main>→*</span> <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-Red_tm_append><span class=command>lemma</span></span> Red_tm_append<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>rs</span> <span class=main>→*</span> <span class=free>rs'</span> <span class=main>⟹</span> <span class=free>ts</span> <span class=main>→*</span> <span class=free>ts'</span> <span class=main>⟹</span> <span class=free>rs</span> <span class=main>@</span> <span class=free>ts</span> <span class=main>→*</span> <span class=free>rs'</span> <span class=main>@</span> <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span> Reds_tm_list<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-Red_tm_rev><span class=command>lemma</span></span> Red_tm_rev<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ts</span> <span class=main>→*</span> <span class=free>ts'</span> <span class=main>⟹</span> rev <span class=free>ts</span> <span class=main>→*</span> rev <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>set</span><span class=main><span class=main>:</span></span> Reds_tm_list<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>Red_tm_append<span class=main>)</span>

<span class=keyword1 id=NBE-red_Lam><span class=command>lemma</span></span> red_Lam<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>→*</span> <span class=free>t'</span> <span class=main>⟹</span> Λ <span class=free>t</span> <span class=main>→*</span> Λ <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rtrancl_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> rtrancl_into_rtrancl Red_tm.intros<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-red_At1><span class=command>lemma</span></span> red_At1<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>→*</span> <span class=free>t'</span> <span class=main>⟹</span> <span class=free>t</span> <span class=main>∙</span> <span class=free>s</span> <span class=main>→*</span> <span class=free>t'</span> <span class=main>∙</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rtrancl_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> rtrancl_into_rtrancl Red_tm.intros<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-red_At2><span class=command>lemma</span></span> red_At2<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>→*</span> <span class=free>t'</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∙</span> <span class=free>t</span> <span class=main>→*</span> <span class=free>s</span> <span class=main>∙</span> <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rtrancl_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>rtrancl_into_rtrancl Red_tm.intros<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-Reds_tm_list_foldl_At><span class=command>lemma</span></span> Reds_tm_list_foldl_At<span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=free>ts</span> <span class=main>→*</span> <span class=free>ts'</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>→*</span> <span class=free>s'</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>→*</span> <span class=free>s'</span> <span class=main>∙∙</span> <span class=free>ts'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Reds_tm_list.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> red_At1 red_At2 <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>rtrancl_trans<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Reduction of ML-terms"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹The compiled rule set:›</span></span>

<span class=keyword1><span class=command>consts</span></span> compR <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>cname <span class=main>*</span> ml list <span class=main>*</span> ml<span class=main>)</span>set"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹\noindent
The actual definition is given in \S\ref{sec:Compiler} below.›</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Now we characterize ML values that cannot possibly be rewritten by a
rule in <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>const</span></span> compR<span class=antiquote><span class=antiquote>}</span></span></span></span>.›</span></span>

<span class=keyword1 id=NBE-termination_no_match_ML><span class=command>lemma</span></span> termination_no_match_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length <span class=free>ps</span> <span class=main>⟹</span> rev <span class=free>ps</span> <span class=main>!</span> <span class=free>i</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free>nm</span> <span class=free>vs</span>
   <span class=main>⟹</span> sum_list <span class=main>(</span>map size <span class=free>vs</span><span class=main>)</span> <span class=main>&lt;</span> sum_list <span class=main>(</span>map size <span class=free>ps</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"C<span class=hidden>⇩</span><sub>U</sub> <span class=free>nm</span> <span class=free>vs</span> <span class=main>:</span> set <span class=free>ps</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> sum_list_map_remove1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>size</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>size_list_conv_sum_list<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth length_rev set_rev<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>declare</span></span> conj_cong<span class=main>[</span><span class=operator>fundef_cong</span><span class=main>]</span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>no_match_ML</span> <span class=main>(</span><span class=quoted>"<span class=keyword1>no'_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>ps</span></span></span> <span class=free><span class=bound><span class=entity>os</span></span></span> <span class=main>=</span>
  <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> min <span class=main>(</span>size <span class=free><span class=bound><span class=entity>os</span></span></span><span class=main>)</span> <span class=main>(</span>size <span class=free><span class=bound><span class=entity>ps</span></span></span><span class=main>)</span><span class=main>.</span>
   <span class=main>∃</span><span class=bound>nm</span> <span class=bound>nm'</span> <span class=bound>vs</span> <span class=bound>vs'</span><span class=main>.</span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>ps</span></span></span><span class=main>)</span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=bound>nm</span> <span class=bound>vs</span> <span class=main>∧</span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>os</span></span></span><span class=main>)</span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=bound>nm'</span> <span class=bound>vs'</span> <span class=main>∧</span>
      <span class=main>(</span><span class=bound>nm</span><span class=main>=</span><span class=bound>nm'</span> <span class=main>⟶</span> <span class=keyword1><span class=free>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>vs</span> <span class=bound>vs'</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure<span class=main>(</span><span class=main>%</span><span class=main>(</span><span class=bound>vs</span><span class=main>::</span>ml list<span class=main>,</span><span class=main><span class=bound>_</span></span><span class=main>)</span><span class=main>.</span> <span class=main>∑</span><span class=bound>v</span><span class=main>←</span><span class=bound>vs</span><span class=main>.</span> size <span class=bound>v</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>termination_no_match_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>abbreviation</span></span>
<span class=quoted><span class=quoted>"<span class=free>no_match_compR</span> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>os</span></span></span> <span class=main>≡</span>
  <span class=main>∀</span><span class=main>(</span><span class=bound>nm'</span><span class=main>,</span><span class=bound>ps</span><span class=main>,</span><span class=bound>v</span><span class=main>)</span><span class=main>∈</span> compR<span class=main>.</span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>=</span><span class=bound>nm'</span> <span class=main>⟶</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>ps</span> <span class=free><span class=bound><span class=entity>os</span></span></span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> no_match_ML.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>

<span class=keyword1><span class=command>inductive_set</span></span>
  <span class=entity>Red_ml</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ml <span class=main>*</span> ml<span class=main>)</span>set"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity>Red_ml_list</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>ml list <span class=main>*</span> ml list<span class=main>)</span>set"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>red_ml</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>ml<span class=main>,</span> ml<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⇒</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>red_ml_list</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>ml list<span class=main>,</span> ml list<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⇒</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>reds_ml</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>ml<span class=main>,</span> ml<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⇒*</span>"</span> 50<span class=main>)</span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Red_ml</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>ss</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Red_ml_list</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>⇒*</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Red_ml</span><span class=main>^*</span>"</span></span>
 <span class=comment1>― ‹ML $\beta$-reduction›</span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>u</span></span></span><span class=main>)</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>]</span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>u</span></span></span><span class=main>[</span><span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
 <span class=comment1>― ‹Execution of a compiled rewrite rule›</span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>,</span><span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>:</span> compR <span class=main>⟹</span> <span class=main>∀</span> <span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
   <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main><span class=free>⇒</span></span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>
<span class=comment1>― ‹default rule:›</span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=bound>i</span><span class=main>)</span>
   <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>=</span> map <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>[</span><span class=main>0</span><span class=main>..&lt;</span><span class=free><span class=bound><span class=entity>arity</span></span></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>]</span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main>=</span> map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span>
   <span class=main>⟹</span> no_match_compR <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span>
   <span class=main>⟹</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span>
 <span class=comment1>― ‹Equations for function \texttt{apply}›</span>
<span class=main>|</span> apply_Clo1<span class=main>:</span> <span class=quoted><span class=quoted>"apply <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> apply_Clo2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main>&gt;</span> <span class=main>0</span> <span class=main>⟹</span>
 apply <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>Suc <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main><span class=free>⇒</span></span> Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>
<span class=main>|</span> apply_C<span class=main>:</span> <span class=quoted><span class=quoted>"apply <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main><span class=free>⇒</span></span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> apply_V<span class=main>:</span> <span class=quoted><span class=quoted>"apply <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main><span class=free>⇒</span></span> V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span>
 <span class=comment1>― ‹Context rules›</span>
<span class=main>|</span> ctxt_C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main>⟹</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span>"</span></span>
<span class=main>|</span> ctxt_V<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main>⟹</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span>"</span></span>
<span class=main>|</span> ctxt_Clo1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>f'</span></span></span>   <span class=main>⟹</span> Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main><span class=free>⇒</span></span> Clo <span class=free><span class=bound><span class=entity>f'</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>
<span class=main>|</span> ctxt_Clo3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main>⟹</span> Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span> <span class=main><span class=free>⇒</span></span> Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span>
<span class=main>|</span> ctxt_apply1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>s'</span></span></span>   <span class=main>⟹</span> apply <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> apply <span class=free><span class=bound><span class=entity>s'</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span>"</span></span>
<span class=main>|</span> ctxt_apply2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span>   <span class=main>⟹</span> apply <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> apply <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span>"</span></span>
<span class=main>|</span> ctxt_A_ML1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>f'</span></span></span>   <span class=main>⟹</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>f'</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span>"</span></span>
<span class=main>|</span> ctxt_A_ML2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main>⟹</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span>"</span></span>
<span class=main>|</span> ctxt_list1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>v'</span></span></span>   <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>v'</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>vs</span></span></span>"</span></span>
<span class=main>|</span> ctxt_list2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>vs'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>#</span><span class=free><span class=bound><span class=entity>vs'</span></span></span>"</span></span>

<span class=keyword1><span class=command>inductive_set</span></span>
  <span class=entity>Red_term</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>tm <span class=main>*</span> tm<span class=main>)</span>set"</span></span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>red_term</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>tm<span class=main>,</span> tm<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⇒</span>"</span> 50<span class=main>)</span>
  <span class=keyword2><span class=keyword>and</span></span> <span class=entity><span class=free>reds_term</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>[</span>tm<span class=main>,</span> tm<span class=main>]</span> <span class=main>=&gt;</span> bool"</span></span>  <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>⇒*</span>"</span> 50<span class=main>)</span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Red_term</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>⇒*</span></span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>∈</span> <span class=free>Red_term</span><span class=main>^*</span>"</span></span>
 <span class=comment1>― ‹function \texttt{term}›</span>
<span class=main>|</span> term_C<span class=main>:</span> <span class=quoted><span class=quoted>"term <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main><span class=free>⇒</span></span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map term <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> term_V<span class=main>:</span> <span class=quoted><span class=quoted>"term <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main><span class=free>⇒</span></span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map term <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=main>|</span> term_Clo<span class=main>:</span> <span class=quoted><span class=quoted>"term<span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>vf</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main><span class=free>⇒</span></span> Λ <span class=main>(</span>term <span class=main>(</span>apply <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>vf</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
 <span class=comment1>― ‹context rules›</span>
<span class=main>|</span> ctxt_Lam<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>⟹</span> Λ <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> Λ <span class=free><span class=bound><span class=entity>t'</span></span></span>"</span></span>
<span class=main>|</span> ctxt_At1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>s'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>s'</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span>"</span></span>
<span class=main>|</span> ctxt_At2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>t'</span></span></span> <span class=main>⟹</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main><span class=free>⇒</span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t'</span></span></span>"</span></span>
<span class=main>|</span> ctxt_term<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>⇒</span> <span class=free><span class=bound><span class=entity>v'</span></span></span> <span class=main>⟹</span> term <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main><span class=free>⇒</span></span> term <span class=free><span class=bound><span class=entity>v'</span></span></span>"</span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Kernel"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹First a special size function and some lemmas for the
termination proof of the kernel function.›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>size'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>  <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>size'</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>+</span> <span class=main>(</span><span class=main>∑</span><span class=bound>v</span><span class=main>←</span><span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=free>size'</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span><span class=main>+</span><span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>size'</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>+</span> <span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∑</span><span class=bound>v</span><span class=main>←</span><span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=free>size'</span> <span class=bound>v</span><span class=main>)</span><span class=main>+</span><span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∑</span><span class=bound>v</span><span class=main>←</span><span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=free>size'</span> <span class=bound>v</span><span class=main>)</span><span class=main>+</span><span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>size'</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>+</span> <span class=main>(</span><span class=main>∑</span><span class=bound>v</span><span class=main>←</span><span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=free>size'</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span><span class=main>+</span><span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size'</span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>size'</span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>+</span> <span class=free>size'</span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span><span class=main>+</span><span class=main>1</span>"</span></span>

<span class=keyword1 id="NBE-sum_list_size'"><span class=command>lemma</span></span> sum_list_size'<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> set <span class=free>vs</span> <span class=main>⟹</span> size' <span class=free>v</span> <span class=main>&lt;</span> Suc<span class=main>(</span>sum_list <span class=main>(</span>map size' <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>

<span class=keyword1><span class=command>corollary</span></span> cor_sum_list_size'<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> set <span class=free>vs</span> <span class=main>⟹</span> size' <span class=free>v</span> <span class=main>&lt;</span> Suc<span class=main>(</span><span class=free>m</span> <span class=main>+</span> sum_list <span class=main>(</span>map size' <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> sum_list_size'<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>arith</span>

<span class=keyword1 id="NBE-size'_lift_ML"><span class=command>lemma</span></span> size'_lift_ML<span class=main>:</span> <span class=quoted><span class=quoted>"size' <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> size' <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>size'.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id="NBE-size'_subst_ML"><span class=command>lemma</span></span> size'_subst_ML<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span> <span class=bound>j</span><span class=main>.</span> size'<span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>⟹</span> size' <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> size' <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>size'.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_allE<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_mp<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> size'_lift_ML <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id="NBE-size'_lift"><span class=command>lemma</span></span> size'_lift<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"size' <span class=main>(</span><span class=keyword1>lift</span> <span class=free>i</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> size' <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>size'.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>sum_list</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> map_ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>kernel</span>  <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> tm"</span></span>  <span class=main>(</span><span class=quoted>"_<span class=keyword1>!</span>"</span> 300<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> C <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main><span class=free>!</span></span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=free>kernel</span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> Λ <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main><span class=free>!</span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=free>kernel</span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=free>kernel</span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>f</span></span></span><span class=main><span class=free>!</span></span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=free>kernel</span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span>apply <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main><span class=free>!</span></span> <span class=main>∙</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>w</span></span></span><span class=main><span class=free>!</span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> undefined"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure size'"</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>kernelt</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> tm"</span></span> <span class=main>(</span><span class=quoted>"_<span class=keyword1>!</span>"</span> 300<span class=main>)</span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> C <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> V <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main><span class=free>!</span></span><span class=main>)</span> <span class=main>∙</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main><span class=free>!</span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> Λ<span class=main>(</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main><span class=free>!</span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span>term <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span><span class=main><span class=free>!</span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>!</span>"</span></span>

<span class=keyword1><span class=command>abbreviation</span></span>
  <span class=entity>kernels</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml list <span class=main>⇒</span> tm list"</span></span> <span class=main>(</span><span class=quoted>"_<span class=keyword1>!</span>"</span> 300<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main><span class=free>!</span></span> <span class=main>≡</span> map kernel <span class=free><span class=bound><span class=entity>vs</span></span></span>"</span></span>

<span class=keyword1 id=NBE-kernel_pure><span class=command>lemma</span></span> kernel_pure<span class=main>:</span> <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"pure <span class=free>t</span>"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>t</span><span class=main>!</span> <span class=main>=</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-kernel_foldl_At><span class=command>lemma</span></span> kernel_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span> <span class=main>(</span><span class=free>s</span><span class=main>!</span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span>map kernelt <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-kernelt_o_term><span class=command>lemma</span></span> kernelt_o_term<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>kernelt <span class=main>∘</span> term<span class=main>)</span> <span class=main>=</span> kernel"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span> <span class=operator>simp</span>

<span class=keyword1 id=NBE-pure_foldl><span class=command>lemma</span></span> pure_foldl<span class=main>:</span>
 <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> pure <span class=bound>t</span> <span class=main>⟹</span> 
 <span class=main>(</span><span class=main>!!</span><span class=bound>s</span> <span class=bound>t</span><span class=main>.</span> pure <span class=bound>s</span> <span class=main>⟹</span> pure <span class=bound>t</span> <span class=main>⟹</span> pure<span class=main>(</span><span class=free>f</span> <span class=bound>s</span> <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=main>⟹</span>
 pure<span class=main>(</span>foldl <span class=free>f</span> <span class=free>t</span> <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-pure_kernel><span class=command>lemma</span></span> pure_kernel<span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=main>::</span> <span class=quoted>ml</span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span> pure<span class=main>(</span><span class=free>v</span><span class=main>!</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>kernel.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>v</span><span class=main>)</span>
  <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> subst_ML_coincidence<span class=main>)</span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> closed_ML_subst_ML<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> 3<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>pure_foldl<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>pure_foldl<span class=main>)</span>

<span class=keyword1><span class=command>corollary</span></span> subst_V_kernel<span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=main>::</span> <span class=quoted>ml</span> <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span> subst V <span class=main>(</span><span class=free>v</span><span class=main>!</span><span class=main>)</span> <span class=main>=</span> <span class=free>v</span><span class=main>!</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> pure_kernel subst_V<span class=main>)</span>

<span class=keyword1 id=NBE-kernel_lift_tm><span class=command>lemma</span></span> kernel_lift_tm<span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=main>::</span> <span class=quoted>ml</span> <span class=keyword2><span class=keyword>shows</span></span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=free>i</span> <span class=free>v</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=free>i</span> <span class=main>(</span><span class=free>v</span><span class=main>!</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> kernel.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"Suc <span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> meta_impE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_subst_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=main>(</span>Suc <span class=improper>i</span><span class=main>)</span> <span class=main>∘</span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_lift_ml<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> closed_ML_subst_ML2<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=quoted><span class=quoted>"<span class=main><span class=main>1</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"An auxiliary substitution"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹This function is only introduced to prove the involved susbtitution
lemma <span class=antiquoted><span class=raw_text><span class=antiquoted><span class=raw_text><span class=operator><span class=operator>‹</span></span>kernel_subst1›</span></span></span></span> below.›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>subst_ml</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span>nat <span class=main>⇒</span> nat<span class=main>)</span> <span class=main>⇒</span> ml <span class=main>⇒</span> ml"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>X</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>(</span>map <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>(</span><span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> Clo <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>u</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> apply <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>u</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>subst_ml</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1 id=NBE-lift_ML_subst_ml><span class=command>lemma</span></span> lift_ML_subst_ml<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=main>(</span>subst_ml <span class=free>σ</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> subst_ml <span class=free>σ</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>subst_ml.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-subst_ml_subst_ML><span class=command>lemma</span></span> subst_ml_subst_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"subst_ml <span class=free>σ</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>subst_ml <span class=free>σ</span> <span class=keyword1>o</span> <span class=free>σ'</span><span class=main>)</span> <span class=main>(</span>subst_ml <span class=free>σ</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ'</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> subst_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span>subst_ml <span class=improper>σ'</span> <span class=main>∘</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=improper>σ</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=main>(</span>subst_ml <span class=improper>σ'</span> <span class=main>∘</span> <span class=improper>σ</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lift_ML_subst_ml<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Maybe this should be the def of lift:›</span></span>
<span class=keyword1 id=NBE-lift_is_subst_ml><span class=command>lemma</span></span> lift_is_subst_ml<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=free>k</span> <span class=free>v</span> <span class=main>=</span> subst_ml <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>&lt;</span><span class=free>k</span> <span class=keyword1>then</span> <span class=bound>n</span> <span class=keyword1>else</span> <span class=bound>n</span><span class=main>+</span><span class=main>1</span><span class=main>)</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>k</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>lift_ml.induct<span class=main>)</span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>

<span class=keyword1 id=NBE-subst_ml_comp><span class=command>lemma</span></span> subst_ml_comp<span class=main>:</span>  <span class=quoted><span class=quoted>"subst_ml <span class=free>σ</span> <span class=main>(</span>subst_ml <span class=free>σ'</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> subst_ml <span class=main>(</span><span class=free>σ</span> <span class=keyword1>o</span> <span class=free>σ'</span><span class=main>)</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ'</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>subst_ml.induct<span class=main>)</span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>

<span class=keyword1 id=NBE-subst_kernel><span class=command>lemma</span></span> subst_kernel<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span>  subst <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> V<span class=main>(</span><span class=free>σ</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=free>v</span><span class=main>!</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>subst_ml <span class=free>σ</span> <span class=free>v</span><span class=main>)</span><span class=main>!</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>kernel.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>case</span> <span class=bound>n</span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>0</span> <span class=main>|</span> Suc <span class=bound>k</span> <span class=main>⇒</span> Suc<span class=main>(</span><span class=improper>σ</span> <span class=bound>k</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> meta_impE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> closed_ML_subst_ML2<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted><span class=quoted>"Suc <span class=main><span class=main>0</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> closed_ML_lift<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> V<span class=main>(</span><span class=keyword1>case</span> <span class=bound>n</span> <span class=keyword1>of</span> <span class=main>0</span> <span class=main>⇒</span> <span class=main>0</span> <span class=main>|</span> Suc <span class=bound>k</span> <span class=main>⇒</span> Suc <span class=main>(</span><span class=improper>σ</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> V<span class=main>(</span><span class=improper>σ</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>subst_ml_subst_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fun_eq_iff <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_is_subst_ml subst_ml_comp<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>kernel</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span>case_nat <span class=main>0</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> Suc <span class=main>(</span><span class=improper>σ</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span> <span class=main>∘</span> Suc<span class=main>)</span> <span class=main>=</span> Suc <span class=keyword1>o</span> <span class=improper>σ</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fun_eq_iff <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.split<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span>subst_ml <span class=main>(</span>case_nat <span class=main>0</span> <span class=main>(</span><span class=main>λ</span><span class=bound>k</span><span class=main>.</span> Suc <span class=main>(</span><span class=improper>σ</span> <span class=bound>k</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∘</span>
               <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
             <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fun_eq_iff<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-if_cong0><span class=command>lemma</span></span> if_cong0<span class=main>:</span> <span class=quoted><span class=quoted>"If <span class=free>x</span> <span class=free>y</span> <span class=free>z</span> <span class=main>=</span> If <span class=free>x</span> <span class=free>y</span> <span class=free>z</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=NBE-kernel_subst1><span class=command>lemma</span></span> kernel_subst1<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=free>u</span> <span class=main>⟹</span>
   kernel<span class=main>(</span><span class=free>u</span><span class=main>[</span><span class=free>v</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>kernel<span class=main>(</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=free>u</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>[</span><span class=free>v</span><span class=main>!</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>u</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>kernel.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>w</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>=</span> <span class=var>?R</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>=</span> Λ<span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=skolem>w</span><span class=main>[</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=skolem>v</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span> <span class=main>!</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>if_cong0<span class=main>)</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ<span class=main>(</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>only</span><span class=main><span class=main>:</span></span> lift_subst_ML1 lift_lift_ML_comm<span class=main>)</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ<span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>=</span><span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span>
            <span class=keyword1>if</span> <span class=bound>n</span><span class=main>=</span>Suc <span class=main>0</span> <span class=keyword1>then</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=numeral>2</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span> <span class=main>!</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>kernel</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> subst_ML_comp2<span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> 3
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ<span class=main>(</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>kernel</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> subst_ML_comp2<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> 3
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ<span class=main>(</span><span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span><span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>[</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span><span class=main>!</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> arg_cong<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted>Λ</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> 3<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> closed_ML_lift 3<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc<span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=skolem>w</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
      <span class=keyword1><span class=command>using</span></span> 3
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span>  <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>defer</span></span></span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> closed_ML_lift<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> closed_ML_subst_ML2<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ<span class=main>(</span><span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>[</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span><span class=main>!</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>=</span> <span class=var>?M</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span> <span class=main>=</span>
                         lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> lift_subst_ML<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_def if_distrib<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"lift_ml <span class=main>0</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>if_cong<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>=</span> <span class=var>?M</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?R</span> <span class=main>=</span> Λ <span class=main>(</span>subst <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> subst_decr <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span><span class=main>)</span>
          <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> Suc <span class=main>0</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> subst_decr_ML <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>if_cong<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fun_eq_iff cons_ML_def <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.splits<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ <span class=main>(</span>subst <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> subst_decr <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span><span class=main>)</span>
          <span class=main>(</span><span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> lift_subst_ML<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_def if_distrib<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted>"lift_ml <span class=main>0</span>"</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>if_cong<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span>Suc <span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span> <span class=main>=</span>
               <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span> <span class=main>0</span><span class=main>]</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?l</span> <span class=main>=</span> <span class=var>?r</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?l</span> <span class=main>=</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span><span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>1</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span> <span class=keyword1>else</span>
                      <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=numeral>2</span><span class=main>)</span><span class=main>)</span>
               <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span>subst_ML_comp2<span class=main>)</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=var>?r</span>"</span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span>subst_ML_comp2<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Λ <span class=main>(</span>subst <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> subst_decr <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=var>?r</span> <span class=main>!</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=var>?M</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subst <span class=main>(</span>subst_decr <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span>lift_tm <span class=main>0</span> <span class=main>(</span>kernel <span class=skolem>v</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span> <span class=main>=</span>
    subst <span class=main>(</span>subst_decr <span class=main>0</span> <span class=main>(</span>kernel<span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>v</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?a</span> <span class=main>=</span> <span class=var>?b</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
      <span class=keyword3><span class=command>define</span></span> <span class=skolem><span class=skolem>pi</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>pi</span> <span class=skolem>n</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=main>1</span> <span class=keyword1>else</span> <span class=keyword1>if</span> <span class=skolem>n</span> <span class=main>=</span> <span class=main>1</span> <span class=keyword1>then</span> <span class=main>0</span> <span class=keyword1>else</span> <span class=skolem>n</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span> <span class=main>::</span> <span class=quoted>nat</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> V <span class=main>(</span><span class=skolem>pi</span> <span class=bound>i</span><span class=main>)</span><span class=main>[</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span> subst_decr <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>pi_def<span class=main>)</span>
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=var>?a</span> <span class=main>=</span>
  subst <span class=main>(</span>subst_decr <span class=main>0</span> <span class=main>(</span>lift_tm <span class=main>0</span> <span class=main>(</span>kernel <span class=skolem>v</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>subst <span class=main>(</span><span class=main>λ</span> <span class=bound>n</span><span class=main>.</span> V<span class=main>(</span><span class=skolem>pi</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> subst_comp<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ _ refl<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 3 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>using</span></span> 3<span class=main>(</span>3<span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> pure_kernel<span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> closed_ML_subst_ML2<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted><span class=quoted>"Suc <span class=main><span class=main>0</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> closed_ML_subst_ML2<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted><span class=quoted>"Suc<span class=main><span class=main>(</span></span>Suc <span class=main><span class=main>0</span></span><span class=main><span class=main>)</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span>
 <span class=main>(</span>subst_ml <span class=skolem>pi</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>!</span><span class=main>[</span>lift_tm <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> subst_kernel<span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span> 3 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> closed_ML_subst_ML2<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted><span class=quoted>"Suc <span class=main><span class=main>0</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> closed_ML_subst_ML2<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k<span class=main><span class=main><span class=main>=</span></span></span><span class=quoted><span class=quoted><span class=quoted>"Suc<span class=main><span class=main>(</span></span>Suc <span class=main><span class=main>0</span></span><span class=main><span class=main>)</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span>subst_ml <span class=skolem>pi</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>!</span><span class=main>[</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>!</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=skolem>v</span><span class=main>!</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>v</span><span class=main>!</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> 3<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> kernel_lift_tm<span class=main>)</span>
        <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>if_cong<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=var>?b</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"subst_ml <span class=skolem>pi</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>lift_is_subst_ml subst_ml_comp<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=skolem>pi</span> <span class=main>∘</span> <span class=main>(</span>Suc <span class=main>∘</span> Suc<span class=main>)</span> <span class=main>=</span> <span class=main>(</span>Suc <span class=main>∘</span> Suc<span class=main>)</span>"</span></span><span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>pi_def fun_eq_iff<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subst_ml <span class=skolem>pi</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span> <span class=main>=</span>
             lift_ml <span class=main>0</span> <span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>w</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>1</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> subst_ml_subst_ML<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> subst_ml_subst_ML<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> 1<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> subst_ML_comp<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> subst_ML_comp2<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>pi_def<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
        <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
    <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>if_cong0 <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>shift_subst_decr<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?R</span> <span class=main>=</span> <span class=var>?M</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?L</span> <span class=main>=</span> <span class=var>?R</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=var>?L</span> <span class=main>=</span> <span class=var>?M</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq<span class=main><span class=keyword3>,</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span><span class=main><span class=keyword3>?</span></span><span class=main>)</span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Compiler \label{sec:Compiler}›</span></span>

<span class=keyword1><span class=command>axiomatization</span></span> <span class=free>arity</span> <span class=main>::</span> <span class=quoted><span class=quoted>"cname <span class=main>⇒</span> nat"</span></span>

<span class=keyword1><span class=command>primrec</span></span> <span class=entity>compile</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> <span class=main>(</span>nat <span class=main>⇒</span> ml<span class=main>)</span> <span class=main>⇒</span> ml"</span></span>
<span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>=</span>
    <span class=main>(</span><span class=keyword1>if</span> arity <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>&gt;</span> <span class=main>0</span> <span class=keyword1>then</span> Clo <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span>arity <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=keyword1>else</span> <span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>=</span> apply <span class=main>(</span><span class=free>compile</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>compile</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>compile</span> <span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>σ</span></span></span> <span class=main>=</span> Clo <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=free>compile</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=free><span class=bound><span class=entity>σ</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>[]</span> <span class=main>1</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Compiler for open terms and for terms with fixed free variables:›</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"<span class=free>comp_open</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span> compile <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span></span>
<span class=keyword1><span class=command>abbreviation</span></span> <span class=quoted><span class=quoted>"<span class=free>comp_fixed</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>≡</span> compile <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>(</span><span class=main>λ</span><span class=bound>i</span><span class=main>.</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=bound>i</span> <span class=main>[]</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Compiled rules:›</span></span>

<span class=keyword1 id=NBE-size_args_less_size_tm><span class=command>lemma</span></span> size_args_less_size_tm<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> set <span class=main>(</span>args_tm <span class=free>t</span><span class=main>)</span> <span class=main>⟹</span> size <span class=free>s</span> <span class=main>&lt;</span> size <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>comp_pat</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>comp_pat</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>=</span>
   <span class=main>(</span><span class=keyword1>case</span> head_tm <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=keyword1>of</span>
     C <span class=bound>nm</span> <span class=main>⇒</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=bound>nm</span> <span class=main>(</span>map <span class=free>comp_pat</span> <span class=main>(</span>rev <span class=main>(</span>args_tm <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
   <span class=main>|</span> V <span class=bound>X</span> <span class=main>⇒</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>X</span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> comp_pat.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span> size_args_less_size_tm<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>

<span class=keyword1 id=NBE-comp_pat_V><span class=command>lemma</span></span> comp_pat_V<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"comp_pat<span class=main>(</span>V <span class=free>X</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>X</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_pat.simps<span class=main>)</span>

<span class=keyword1 id=NBE-comp_pat_C><span class=command>lemma</span></span> comp_pat_C<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"comp_pat<span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free>nm</span> <span class=main>(</span>map comp_pat <span class=main>(</span>rev <span class=free>ts</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_pat.simps<span class=main>)</span>

<span class=keyword1 id=NBE-comp_pat_C_Nil><span class=command>lemma</span></span> comp_pat_C_Nil<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"comp_pat<span class=main>(</span>C <span class=free>nm</span><span class=main>)</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free>nm</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_pat.simps<span class=main>)</span>


<span class=keyword1><span class=command>overloading</span></span> compR <span class=main>≡</span> <span class=quoted>compR</span>
<span class=keyword2><span class=keyword>begin</span></span>
  <span class=keyword1><span class=command>definition</span></span> <span class=quoted><span class=quoted>"compR <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>nm</span><span class=main>,</span><span class=bound>ts</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>nm</span><span class=main>,</span> map comp_pat <span class=main>(</span>rev <span class=bound>ts</span><span class=main>)</span><span class=main>,</span> comp_open <span class=bound>t</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> R"</span></span>
<span class=keyword2><span class=keyword>end</span></span>


<span class=keyword1 id=NBE-fv_ML_comp_open><span class=command>lemma</span></span> fv_ML_comp_open<span class=main>:</span> <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span>comp_open <span class=free>t</span><span class=main>)</span> <span class=main>=</span> fv <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_open_def<span class=main>)</span>

<span class=keyword1 id=NBE-fv_ML_comp_pat><span class=command>lemma</span></span> fv_ML_comp_pat<span class=main>:</span> <span class=quoted><span class=quoted>"pattern <span class=free>t</span> <span class=main>⟹</span> <span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span>comp_pat <span class=free>t</span><span class=main>)</span> <span class=main>=</span> fv <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pattern<span class=main>)</span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_open_def<span class=main>)</span>

<span class=keyword1 id=NBE-fv_compR_aux><span class=command>lemma</span></span> fv_compR_aux<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span><span class=free>ts</span><span class=main>,</span><span class=free>t'</span><span class=main>)</span> <span class=main>:</span> R <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>comp_open <span class=free>t'</span><span class=main>)</span>
   <span class=main>⟹</span> <span class=main>∃</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> <span class=free>x</span> <span class=main>∈</span> <span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span>comp_pat <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> pure_R<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fv_ML_comp_open<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> <span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> fv_R<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> bexI<span class=main>)</span> <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> pattern_R<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fv_ML_comp_pat<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-fv_compR><span class=command>lemma</span></span> fv_compR<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span><span class=free>vs</span><span class=main>,</span><span class=free>v</span><span class=main>)</span> <span class=main>:</span> compR <span class=main>⟹</span> <span class=free>x</span> <span class=main>∈</span> <span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>u</span><span class=main>∈</span>set <span class=free>vs</span><span class=main>.</span> <span class=free>x</span> <span class=main>∈</span> <span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>u</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>compR_def image_def <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> fv_compR_aux<span class=main>)</span>

<span class=keyword1 id=NBE-lift_compile><span class=command>lemma</span></span> lift_compile<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>σ</span> <span class=bound>k</span><span class=main>.</span> <span class=keyword1>lift</span> <span class=bound>k</span> <span class=main>(</span>compile <span class=free>t</span> <span class=bound>σ</span><span class=main>)</span> <span class=main>=</span> compile <span class=free>t</span> <span class=main>(</span><span class=keyword1>lift</span> <span class=bound>k</span> <span class=main>∘</span> <span class=bound>σ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> f <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"compile <span class=improper>t</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> arg_cong<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> lift_lift_ML_comm<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-subst_ML_compile><span class=command>lemma</span></span> subst_ML_compile<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=main>(</span>compile <span class=free>t</span> <span class=free>σ</span><span class=main>)</span> <span class=main>=</span> compile <span class=free>t</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ'</span> <span class=keyword1>o</span> <span class=free>σ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>σ'</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=improper>σ'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>∘</span> <span class=improper>σ</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> f <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"compile <span class=improper>t</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> arg_cong<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>subst_ML_ext lift_ML_subst_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>theorem</span></span> kernel_compile<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=bound>i</span> <span class=main>[]</span> <span class=main>⟹</span> <span class=main>(</span>compile <span class=free>t</span> <span class=free>σ</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> lift_compile<span class=main>)</span> <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> subst_ML_compile<span class=main>)</span> <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span> <span class=main>∘</span>
               <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>∘</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=improper>σ</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> V<span class=hidden>⇩</span><sub>U</sub> <span class=bound>a</span> <span class=main>[]</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> ext<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-kernel_subst_ML_pat><span class=command>lemma</span></span> kernel_subst_ML_pat<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> pattern <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
   <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=main>(</span>comp_pat <span class=free>t</span><span class=main>)</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span> subst <span class=main>(</span>kernel <span class=main>∘</span> <span class=free>σ</span><span class=main>)</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> pattern_At_decomp<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> pattern_AtD12<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> comp_pat.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_map<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-kernel_subst_ML><span class=command>lemma</span></span> kernel_subst_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
   <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=main>(</span>comp_open <span class=free>t</span><span class=main>)</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span> subst <span class=main>(</span>kernel <span class=main>∘</span> <span class=free>σ</span><span class=main>)</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Lam <span class=skolem>t</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>lift</span> <span class=main>0</span> <span class=keyword1>o</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>=</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>fun_eq_iff<span class=main>)</span>
  <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span> <span class=main>(</span>comp_open <span class=main>(</span>Λ <span class=skolem>t</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span>
    Λ <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>∘</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>(</span>comp_open <span class=skolem>t</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Lam <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> lift_subst_ML comp_open_def lift_compile<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> Λ <span class=main>(</span>subst <span class=main>(</span>V <span class=main>0</span> <span class=main>##</span> <span class=main>(</span>kernel <span class=main>∘</span> <span class=skolem>σ</span><span class=main>)</span><span class=main>)</span> <span class=skolem>t</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Lam
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> subst_ML_comp subst_ext kernel_lift_tm<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> subst <span class=main>(</span>kernel <span class=keyword1>o</span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>(</span>Λ <span class=skolem>t</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>.</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>comp_open_def<span class=main>)</span>

<span class=keyword1 id=NBE-kernel_subst_ML_pat_map><span class=command>lemma</span></span> kernel_subst_ML_pat_map<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=free>ts</span><span class=main>.</span> pure <span class=bound>t</span> <span class=main>⟹</span> patterns <span class=free>ts</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span>
   map kernel <span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span><span class=main>)</span> <span class=main>(</span>map comp_pat <span class=free>ts</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span>
   map <span class=main>(</span>subst <span class=main>(</span>kernel <span class=main>∘</span> <span class=free>σ</span><span class=main>)</span><span class=main>)</span> <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq kernel_subst_ML_pat<span class=main>)</span>

<span class=keyword1 id=NBE-compR_Red_tm><span class=command>lemma</span></span> compR_Red_tm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span> <span class=free>vs</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>:</span> compR <span class=main>⟹</span> <span class=main>∀</span> <span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span>
  <span class=main>⟹</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span><span class=main>)</span> <span class=main>(</span>rev <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>!</span> <span class=main>→*</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span><span class=main>!</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>compR_def rev_map <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> pure_R<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> kernel_subst_ML<span class=main>)</span> <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fast</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> kernel_subst_ML_pat_map<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fast</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>fast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>pattern_R<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> r_into_rtrancl<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> Red_tm.intros<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Correctness"</span></span>

<span class=comment1>(* Without this special rule one "also" in the next proof *diverges*,
   probably because of HOU. *)</span>
<span class=keyword1 id=NBE-eq_Red_tm_trans><span class=command>lemma</span></span> eq_Red_tm_trans<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>=</span> <span class=free>t</span> <span class=main>⟹</span> <span class=free>t</span> <span class=main>→</span> <span class=free>t'</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>→</span> <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Soundness of reduction:›</span></span>
<span class=keyword1><span class=command>theorem</span></span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=main>::</span> <span class=quoted>ml</span> <span class=keyword2><span class=keyword>shows</span></span> Red_ml_sound<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>⇒</span> <span class=free>v'</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v</span> <span class=main>⟹</span> <span class=free>v</span><span class=main>!</span> <span class=main>→*</span> <span class=free>v'</span><span class=main>!</span> <span class=main>∧</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>v'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
  <span class=quoted><span class=quoted>"<span class=free>vs</span> <span class=main>⇒</span> <span class=free>vs'</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>v</span><span class=main>∈</span>set <span class=free>vs</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=bound>v</span> <span class=main>⟹</span>
   <span class=free>vs</span><span class=main>!</span> <span class=main>→*</span> <span class=free>vs'</span><span class=main>!</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v'</span><span class=main>∈</span>set <span class=free>vs'</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=bound>v'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_ml_Red_ml_list.inducts<span class=main>)</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>u</span> <span class=skolem>v</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?v</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>u</span><span class=main>)</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> cl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>u</span><span class=main>)</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?u'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>lift_ml <span class=main>0</span> <span class=skolem>u</span><span class=main>)</span><span class=main>[</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?v</span><span class=main>!</span> <span class=main>=</span> <span class=main>(</span>Λ<span class=main>(</span><span class=main>(</span><span class=var>?u'</span><span class=main>)</span><span class=main>!</span><span class=main>)</span><span class=main>)</span> <span class=main>∙</span> <span class=main>(</span><span class=skolem>v</span> <span class=main>!</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>→</span> <span class=main>(</span><span class=var>?u'</span> <span class=main>!</span><span class=main>)</span><span class=main>[</span><span class=skolem>v</span><span class=main>!</span><span class=main>/</span><span class=main>0</span><span class=main>]</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>_</span> <span class=main>→</span> <span class=var>?R</span>"</span></span><span class=main>)</span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> Red_tm.intros<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span><span class=main>(</span>eq_Red_tm_trans<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?R</span> <span class=main>=</span> <span class=skolem>u</span><span class=main>[</span><span class=skolem>v</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>!</span>"</span></span> <span class=keyword1><span class=command>using</span></span> cl
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cut_tac</span> u <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=skolem>u</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> v <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> kernel_subst1<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"kernel<span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>u</span><span class=main>)</span> <span class=main>[</span><span class=skolem>v</span><span class=main>]</span><span class=main>)</span> <span class=main>→*</span> kernel<span class=main>(</span><span class=skolem>u</span><span class=main>[</span><span class=skolem>v</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> r_into_rtrancl<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=skolem>u</span><span class=main>[</span><span class=skolem>v</span><span class=main>/</span><span class=main>0</span><span class=main>]</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?C</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?σ</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=keyword1>if</span> <span class=bound>n</span> <span class=main>=</span> <span class=main>0</span> <span class=keyword1>then</span> <span class=skolem>v</span> <span class=keyword1>else</span> <span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=bound>n</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?σ'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>n</span><span class=main>.</span> <span class=skolem>v</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> clu<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=main>0</span><span class=main>)</span> <span class=skolem>u</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> clv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=skolem>v</span>"</span></span> <span class=keyword1><span class=command>using</span></span> cl <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=var>?σ'</span> <span class=skolem>u</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> closed_ML_subst_ML clv<span class=main>)</span>
    <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=var>?σ</span> <span class=skolem>u</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> subst_ML_coincidence<span class=main>[</span><span class=operator>OF</span> clu<span class=main>,</span> <span class=operator>of</span> <span class=var><span class=quoted><span class=var>?σ</span></span></span> <span class=var><span class=quoted><span class=var>?σ'</span></span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>∧</span> <span class=var>?C</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>σ</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> ml"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>nm</span> <span class=skolem>vs</span> <span class=skolem>v</span>
  <span class=keyword3><span class=command>assume</span></span> σ<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=skolem>σ</span> <span class=bound>i</span><span class=main>)</span>"</span></span>  <span class=keyword2><span class=keyword>and</span></span> compR<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>nm</span><span class=main>,</span> <span class=skolem>vs</span><span class=main>,</span> <span class=skolem>v</span><span class=main>)</span> <span class=main>∈</span> compR"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"map <span class=main>(</span>subst V<span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>!</span><span class=main>)</span> <span class=main>=</span> map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>!</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>list_eq_iff_nth_eq subst_V_kernel closed_ML_subst_ML<span class=main><span class=main>[</span></span><span class=operator>OF</span> σ<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> compR_Red_tm<span class=main>[</span><span class=operator>OF</span> compR σ<span class=main>]</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>C <span class=skolem>nm</span><span class=main>)</span> <span class=main>∙∙</span> <span class=main>(</span><span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span><span class=main>)</span> <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>!</span><span class=main>)</span> <span class=main>→*</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span> <span class=skolem>v</span><span class=main>)</span><span class=main>!</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>subst_V_kernel closed_ML_subst_ML<span class=main><span class=main>[</span></span><span class=operator>OF</span> σ<span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>nm</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>!</span> <span class=main>→*</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span> <span class=skolem>v</span><span class=main>!</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rev_map<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>σ</span> <span class=skolem>v</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=var><span class=quoted><span class=var>?C</span></span></span><span class=main>)</span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> closed_ML_subst_ML σ<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>∧</span> <span class=var>?C</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>Reds_tm_list_foldl_At Red_tm_rev rev_map<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>

<span class=keyword1><span class=command>theorem</span></span> Red_term_sound<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>⇒</span> <span class=free>t'</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>t</span> <span class=main>⟹</span> kernelt <span class=free>t</span> <span class=main>→*</span> kernelt <span class=free>t'</span>  <span class=main>∧</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term.inducts<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> term_C <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>closed_tm_ML_foldl_At<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> term_V <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>closed_tm_ML_foldl_At<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>term_Clo <span class=skolem>vf</span> <span class=skolem>vs</span> <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=skolem>vf</span><span class=main>!</span><span class=main>)</span> <span class=main>∙∙</span> map kernel <span class=main>(</span>rev <span class=main>(</span>map <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>
         <span class=main>=</span> <span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span><span class=skolem>vf</span><span class=main>!</span> <span class=main>∙∙</span> <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>!</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>kernel_lift_tm list_eq_iff_nth_eq<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rev_nth rev_map kernel_lift_tm<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
  <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"term <span class=main>(</span>Clo <span class=skolem>vf</span> <span class=skolem>vs</span> <span class=skolem>n</span><span class=main>)</span><span class=main>!</span> <span class=main>→*</span>
       Λ <span class=main>(</span>term <span class=main>(</span>apply <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>Clo <span class=skolem>vf</span> <span class=skolem>vs</span> <span class=skolem>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>!</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> term_Clo
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>lift_foldl_At <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> r_into_rtrancl Red_tm.intros<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span>Λ <span class=main>(</span>term <span class=main>(</span>apply <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>Clo <span class=skolem>vf</span> <span class=skolem>vs</span> <span class=skolem>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> term_Clo <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>..</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> ctxt_term <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> Red_ml_sound<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1><span class=command>corollary</span></span> kernel_inv<span class=main>:</span>
 <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t</span> <span class=main>::</span> tm<span class=main>)</span> <span class=main>⇒*</span> <span class=free>t'</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>t</span> <span class=main>⟹</span> <span class=free>t</span><span class=main>!</span> <span class=main>→*</span> <span class=free>t'</span><span class=main>!</span> <span class=main>∧</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=free>t'</span> "</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> rtrancl.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> rtrancl_eq_or_trancl<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> Red_term_sound rtrancl_trans<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-closed_ML_compile><span class=command>lemma</span></span>  closed_ML_compile<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>n</span> <span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>n</span> <span class=main>(</span>compile <span class=free>t</span> <span class=free>σ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>n</span></span> <span class=quoted><span class=free>σ</span></span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Lam <span class=skolem>t</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>Suc <span class=skolem>n</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>##</span> <span class=skolem>σ</span><span class=main>)</span> <span class=bound>i</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Lam<span class=main>(</span>3-<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> closed_ML_Suc<span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Lam<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> 1<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>apply_cons_ML<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>theorem</span></span> nbe_correct<span class=main>:</span> <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>t</span> <span class=main>::</span> <span class=quoted>tm</span>
<span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"pure <span class=free>t</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"term <span class=main>(</span>comp_fixed <span class=free>t</span><span class=main>)</span> <span class=main>⇒*</span> <span class=free>t'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"pure <span class=free>t'</span>"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>→*</span> <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> ML_cl<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>closed<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>0</span> <span class=main>(</span>term <span class=main>(</span>comp_fixed <span class=free>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> closed_ML_compile<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹pure <span class=free>t</span>›</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>term <span class=main>(</span>comp_fixed <span class=free>t</span><span class=main>)</span><span class=main>)</span><span class=main>!</span> <span class=main>=</span> <span class=free>t</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> kernel_compile<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹pure <span class=free>t</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"term <span class=main>(</span>comp_fixed <span class=free>t</span><span class=main>)</span><span class=main>!</span> <span class=main>→*</span> <span class=free>t'</span><span class=main>!</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> kernel_inv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> ML_cl<span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>→*</span> <span class=free>t'</span><span class=main>!</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> kernel_pure<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹pure <span class=free>t'</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Normal Forms"</span></span>

<span class=keyword1><span class=command>inductive</span></span> <span class=entity>normal</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=free>normal</span> <span class=bound>t</span> <span class=main>⟹</span> <span class=free>normal</span><span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∙∙</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>normal</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>⟹</span> <span class=free>normal</span><span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=free>normal</span> <span class=bound>t</span> <span class=main>⟹</span>
 <span class=main>∀</span><span class=bound>σ</span><span class=main>.</span> <span class=main>∀</span><span class=main>(</span><span class=bound>nm'</span><span class=main>,</span><span class=bound>ls</span><span class=main>,</span><span class=bound>r</span><span class=main>)</span><span class=main>∈</span>R<span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>=</span> <span class=bound>nm'</span> <span class=main>∧</span> take <span class=main>(</span>size <span class=bound>ls</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span> map <span class=main>(</span>subst <span class=bound>σ</span><span class=main>)</span> <span class=bound>ls</span><span class=main>)</span>
 <span class=main>⟹</span> <span class=free>normal</span><span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>∙∙</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>C_normal_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> bool"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>C'_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span><span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span>
  <span class=main>(</span><span class=main>(</span><span class=main>∀</span><span class=bound>v</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span> <span class=main>∧</span> no_match_compR <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>V<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> True"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>A<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span><span class=keyword1>Lam<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>Clo <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>apply <span class=free><span class=bound><span class=entity>u</span></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>u</span></span></span> <span class=main>∧</span> <span class=keyword1><span class=free>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>size_tm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> nat"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>size_tm</span> <span class=main>(</span>C <span class=main><span class=bound><span class=entity>_</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size_tm</span> <span class=main>(</span>At <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>size_tm</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>+</span> <span class=free>size_tm</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>+</span> <span class=main>1</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>size_tm</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> <span class=main>0</span>"</span></span>

<span class=keyword1 id=NBE-size_tm_foldl_At><span class=command>lemma</span></span> size_tm_foldl_At<span class=main>:</span> <span class=quoted><span class=quoted>"size_tm<span class=main>(</span><span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> size_tm <span class=free>t</span> <span class=main>+</span> size_list size_tm <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-termination_no_match><span class=command>lemma</span></span> termination_no_match<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length <span class=free>ss</span> <span class=main>⟹</span> <span class=free>ss</span> <span class=main>!</span> <span class=free>i</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span>
   <span class=main>⟹</span> sum_list <span class=main>(</span>map size_tm <span class=free>ts</span><span class=main>)</span> <span class=main>&lt;</span> sum_list <span class=main>(</span>map size_tm <span class=free>ss</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>:</span> set <span class=free>ss</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> sum_list_map_remove1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>size_tm</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>size_tm_foldl_At size_list_conv_sum_list<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>declare</span></span> conj_cong <span class=main>[</span><span class=operator>fundef_cong</span><span class=main>]</span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>no_match</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list <span class=main>⇒</span> tm list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>no_match</span> <span class=free><span class=bound><span class=entity>ps</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>=</span>
  <span class=main>(</span><span class=main>∃</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> min <span class=main>(</span>size <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span> <span class=main>(</span>size <span class=free><span class=bound><span class=entity>ps</span></span></span><span class=main>)</span><span class=main>.</span>
   <span class=main>∃</span><span class=bound>nm</span> <span class=bound>nm'</span> <span class=bound>rs</span> <span class=bound>rs'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ps</span></span></span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> <span class=main>(</span>C <span class=bound>nm</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>rs</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> <span class=main>(</span>C <span class=bound>nm'</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>rs'</span> <span class=main>∧</span>
      <span class=main>(</span><span class=bound>nm</span><span class=main>=</span><span class=bound>nm'</span> <span class=main>⟶</span> <span class=free>no_match</span> <span class=bound>rs</span> <span class=bound>rs'</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure<span class=main>(</span><span class=main>%</span><span class=main>(</span><span class=bound>ts</span><span class=main>::</span>tm list<span class=main>,</span><span class=main><span class=bound>_</span></span><span class=main>)</span><span class=main>.</span> <span class=main>∑</span><span class=bound>t</span><span class=main>←</span><span class=bound>ts</span><span class=main>.</span> size_tm <span class=bound>t</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>termination_no_match<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>declare</span></span> no_match.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>

<span class=keyword1><span class=command>abbreviation</span></span>
<span class=quoted><span class=quoted>"<span class=free>no_match_R</span> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>≡</span> <span class=main>∀</span><span class=main>(</span><span class=bound>nm'</span><span class=main>,</span><span class=bound>ps</span><span class=main>,</span><span class=bound>t</span><span class=main>)</span><span class=main>∈</span> R<span class=main>.</span> <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>=</span><span class=bound>nm'</span> <span class=main>⟶</span> no_match <span class=bound>ps</span> <span class=free><span class=bound><span class=entity>ts</span></span></span>"</span></span>


<span class=keyword1 id=NBE-no_match><span class=command>lemma</span></span> no_match<span class=main>:</span> <span class=quoted><span class=quoted>"no_match <span class=free>ps</span> <span class=free>ts</span> <span class=main>⟹</span> <span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>σ</span><span class=main>.</span> map <span class=main>(</span>subst <span class=bound>σ</span><span class=main>)</span> <span class=free>ps</span> <span class=main>=</span> <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>ps</span> <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match.simps<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>ps</span></span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-no_match_take><span class=command>lemma</span></span> no_match_take<span class=main>:</span> <span class=quoted><span class=quoted>"no_match <span class=free>ps</span> <span class=free>ts</span> <span class=main>⟹</span> no_match <span class=free>ps</span> <span class=main>(</span>take <span class=main>(</span>size <span class=free>ps</span><span class=main>)</span> <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>dterm_ML</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> tm"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> C <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>∙∙</span> map <span class=keyword1><span class=free>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> V <span class=main>0</span>"</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>dterm</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> tm"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>dterm</span> <span class=main>(</span>V <span class=free><span class=bound><span class=entity>n</span></span></span><span class=main>)</span> <span class=main>=</span> V <span class=free><span class=bound><span class=entity>n</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>dterm</span> <span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span><span class=main>)</span> <span class=main>=</span> C <span class=free><span class=bound><span class=entity>nm</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>dterm</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>dterm</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free>dterm</span> <span class=free><span class=bound><span class=entity>t</span></span></span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>dterm</span> <span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> Λ <span class=main>(</span><span class=free>dterm</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>dterm</span> <span class=main>(</span>term <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span>"</span></span>

<span class=keyword1 id=NBE-dterm_pure><span class=command>lemma</span></span> dterm_pure<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> dterm <span class=free>t</span> <span class=main>=</span> <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-map_dterm_pure><span class=command>lemma</span></span> map_dterm_pure<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> pure <span class=bound>t</span> <span class=main>⟹</span> map dterm <span class=free>ts</span> <span class=main>=</span> <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-map_dterm_term><span class=command>lemma</span></span> map_dterm_term<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"map dterm <span class=main>(</span>map term <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>vs</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-dterm_foldl_At><span class=command>lemma</span></span> dterm_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"dterm<span class=main>(</span><span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> dterm <span class=free>t</span> <span class=main>∙∙</span> map dterm <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-no_match_coincide><span class=command>lemma</span></span> no_match_coincide<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=free>vs</span> <span class=main>⟹</span>
  no_match <span class=main>(</span>map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=free>ps</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rotate_tac</span> 1<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>elim</span> exE conjE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=quoted>"<span class=improper>nm</span><span class=main>=</span><span class=improper>nm'</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>no_asm</span><span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> min_less_iff_conj<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>min_less_iff_conj nth_map<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>safe</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>vs</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>vs'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>no_asm</span><span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> min_less_iff_conj<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=improper>vs</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=improper>vs'</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-dterm_ML_comp_patD><span class=command>lemma</span></span> dterm_ML_comp_patD<span class=main>:</span>
  <span class=quoted><span class=quoted>"pattern <span class=free>t</span> <span class=main>⟹</span> <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>comp_pat <span class=free>t</span><span class=main>)</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>rs</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=bound>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pattern<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1 id=NBE-no_match_R_coincide_aux><span class=command>lemma</span></span> no_match_R_coincide_aux<span class=main>[</span><span class=operator>rule_format</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"patterns <span class=free>ts</span> <span class=main>⟹</span>
  no_match <span class=main>(</span>map <span class=main>(</span><span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>∘</span> comp_pat<span class=main>)</span> <span class=free>ts</span><span class=main>)</span> <span class=free>rs</span> <span class=main>⟶</span> no_match <span class=free>ts</span> <span class=free>rs</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>rs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> no_match.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cut_tac</span> t <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=improper>ps</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> dterm_ML_comp_patD<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>assumption</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>clarsimp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>tsa</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>rs'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rev_map<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth pattern_At_vecD<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-no_match_R_coincide><span class=command>lemma</span></span> no_match_R_coincide<span class=main>:</span>
  <span class=quoted><span class=quoted>"no_match_compR <span class=free>nm</span> <span class=main>(</span>rev <span class=free>vs</span><span class=main>)</span> <span class=main>⟹</span> no_match_R <span class=free>nm</span> <span class=main>(</span>map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span> map comp_pat <span class=main>(</span>rev <span class=improper>aa</span><span class=main>)</span><span class=main>,</span> comp_open <span class=improper>b</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> bspec<span class=main>)</span>
 <span class=keyword1><span class=command>unfolding</span></span> compR_def
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>image_def<span class=main>)</span> 
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>force</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> no_match_coincide<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> pure_R<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> pattern_R<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_map no_match.simps<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>"map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>vs</span>"</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cut_tac</span> t <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=improper>aa</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> dterm_ML_comp_patD<span class=main><span class=keyword3>,</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>,</span></span> <span class=operator>assumption</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rev_map<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> no_match_R_coincide_aux<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth pattern_At_vecD<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>inductive</span></span> <span class=entity>C_normal</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=free>C_normal</span> <span class=bound>t</span> <span class=main>⟹</span> <span class=free>C_normal</span><span class=main>(</span>V <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>∙∙</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>C_normal</span> <span class=free><span class=bound><span class=entity>t</span></span></span> <span class=main>⟹</span> <span class=free>C_normal</span><span class=main>(</span>Λ <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free><span class=bound><span class=entity>v</span></span></span> <span class=main>⟹</span> <span class=free>C_normal</span><span class=main>(</span>term <span class=free><span class=bound><span class=entity>v</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=free>C_normal</span> <span class=bound>t</span> <span class=main>⟹</span> no_match_R <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>(</span>map dterm <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>
 <span class=main>⟹</span> <span class=free>C_normal</span><span class=main>(</span>C <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>∙∙</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>declare</span></span> C_normal.intros<span class=main>[</span><span class=operator>simp</span><span class=main>]</span>

<span class=keyword1 id=NBE-C_normal_term><span class=command>lemma</span></span> C_normal_term<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>term <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> C_normal.cases<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>Λ <span class=free>t</span><span class=main>)</span> <span class=main>=</span> C_normal <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> C_normal.cases<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>V <span class=free>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>using</span></span> C_normal.intros<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=quoted><span class=free>x</span></span><span class=main>]</span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"dterm <span class=main>(</span><span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>dterm_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=quoted><span class=quoted>"<span class=free>u</span><span class=main>⇒</span><span class=main>(</span><span class=free>v</span><span class=main>::</span>ml<span class=main>)</span> <span class=main>⟹</span> True"</span></span> <span class=keyword2><span class=keyword>and</span></span>
  Red_ml_list_length<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>vs</span> <span class=main>⇒</span> <span class=free>vs'</span> <span class=main>⟹</span> length <span class=free>vs</span> <span class=main>=</span> length <span class=free>vs'</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> Red_ml_Red_ml_list.inducts<span class=main>)</span> <span class=operator>simp_all</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span><span class=main>::</span>ml<span class=main>)</span> <span class=main>⇒</span> <span class=free>v'</span> <span class=main>⟹</span> True"</span></span> <span class=keyword2><span class=keyword>and</span></span>
  Red_ml_list_nth<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span><span class=main>::</span>ml list<span class=main>)</span> <span class=main>⇒</span> <span class=free>vs'</span>
  <span class=main>⟹</span> <span class=main>∃</span><span class=bound>v'</span> <span class=bound>k</span><span class=main>.</span> <span class=bound>k</span><span class=main>&lt;</span>size <span class=free>vs</span> <span class=main>∧</span> <span class=free>vs</span><span class=main>!</span><span class=bound>k</span> <span class=main>⇒</span> <span class=bound>v'</span> <span class=main>∧</span> <span class=free>vs'</span> <span class=main>=</span> <span class=free>vs</span><span class=main>[</span><span class=bound>k</span> <span class=main>:=</span> <span class=bound>v'</span><span class=main>]</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> Red_ml_Red_ml_list.inducts<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>split</span><span class=main><span class=main>:</span></span>nat.splits<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-Red_ml_list_pres_no_match><span class=command>lemma</span></span> Red_ml_list_pres_no_match<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=free>vs</span> <span class=main>⟹</span> <span class=free>vs</span> <span class=main>⇒</span> <span class=free>vs'</span> <span class=main>⟹</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=free>vs'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>vs'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match_ML.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>vs</span> <span class=skolem>os</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2-3<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=operator>-</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> Red_ml_list_length<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rotate_tac</span> -2<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarify</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rename_tac</span> i nm nm' us us'<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> Red_ml_list_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarify</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rename_tac</span> k<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=quoted>"<span class=improper>k</span> <span class=main>=</span> length <span class=skolem>os</span> <span class=main>-</span> Suc <span class=improper>i</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>us'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth nth_list_update<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> Red_ml.cases<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-no_match_ML_subst_ML><span class=command>lemma</span></span> no_match_ML_subst_ML<span class=main>[</span><span class=operator>rule_format</span><span class=main>]</span><span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>v</span><span class=main>∈</span>set <span class=free>vs</span><span class=main>.</span> <span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>v</span><span class=main>.</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=free>σ</span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟹</span>
   <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=free>vs</span> <span class=main>⟶</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span><span class=main>)</span> <span class=improper>vs'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>vs</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=improper>vs'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> UN_I fv_ML.simps<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> in_set_conv_nth length_rev rev_nth set_rev<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-lift_is_CUD><span class=command>lemma</span></span> lift_is_CUD<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free>nm</span> <span class=free>vs'</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>vs</span><span class=main>.</span> <span class=free>v</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=free>nm</span> <span class=bound>vs</span> <span class=main>∧</span> <span class=free>vs'</span> <span class=main>=</span> map <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span><span class=main>)</span> <span class=bound>vs</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>v</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-no_match_ML_lift_ML><span class=command>lemma</span></span> no_match_ML_lift_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=free>vs</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> lift_is_CUD<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"map <span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span><span class=main>)</span> <span class=improper>vs'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-C_normal_ML_lift_ML><span class=command>lemma</span></span> C_normal_ML_lift_ML<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span><span class=keyword1>lift<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>C_normal_ML.induct<span class=main>)</span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>no_match_ML_lift_ML<span class=main>)</span>

<span class=keyword1 id=NBE-no_match_compR_Cons><span class=command>lemma</span></span> no_match_compR_Cons<span class=main>:</span>
  <span class=quoted><span class=quoted>"no_match_compR <span class=free>nm</span> <span class=free>vs</span> <span class=main>⟹</span> no_match_compR <span class=free>nm</span> <span class=main>(</span><span class=free>v</span> <span class=main>#</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> bspec<span class=main><span class=keyword3>,</span></span> <span class=operator>assumption</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_append<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-C_normal_ML_comp_open><span class=command>lemma</span></span> C_normal_ML_comp_open<span class=main>:</span> <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span>comp_open <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pure<span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>comp_open_def<span class=main>)</span>

<span class=keyword1 id=NBE-C_normal_compR_rhs><span class=command>lemma</span></span> C_normal_compR_rhs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>nm</span><span class=main>,</span> <span class=free>vs</span><span class=main>,</span> <span class=free>v</span><span class=main>)</span> <span class=main>∈</span> compR <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> compR_def image_def Bex_def pure_R C_normal_ML_comp_open<span class=main>)</span>


<span class=keyword1 id=NBE-C_normal_ML_subst_ML><span class=command>lemma</span></span> C_normal_ML_subst_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span><span class=main>.</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=free>σ</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>subst_ML.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 4 <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>apply_cons_ML<span class=main>)</span><span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> C_normal_ML_lift_ML<span class=main>)</span>
      <span class=comment1>(* weird - force suffices in apply style *)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-C_normal_ML_subst_ML_iff><span class=command>lemma</span></span> C_normal_ML_subst_ML_iff<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>⟹</span>
  <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>σ</span> <span class=free>v</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=keyword1>fv<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span><span class=main>.</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span><span class=free>σ</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>σ</span></span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>subst_ML.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 4 <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span>apply_cons_ML<span class=main>)</span><span class=main>(</span><span class=operator>force</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> C_normal_ML_lift_ML<span class=main>)</span>
      <span class=comment1>(* weird - force suffices in apply style *)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> 5 <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> no_match_ML_subst_ML<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-C_normal_ML_inv><span class=command>lemma</span></span> C_normal_ML_inv<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>⇒</span> <span class=free>v'</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
      <span class=quoted><span class=quoted>"<span class=free>vs</span> <span class=main>⇒</span> <span class=free>vs'</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>v</span><span class=main>∈</span>set <span class=free>vs</span><span class=main>.</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>v</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>v'</span><span class=main>∈</span>set <span class=free>vs'</span><span class=main>.</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>v'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_ml_Red_ml_list.inducts<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> C_normal_ML_subst_ML_iff<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>metis</span> C_normal_ML_subst_ML C_normal_compR_rhs
        fv_compR C_normal_ML_subst_ML_iff<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>!</span></span><span class=main><span class=main>:</span></span>no_match_compR_Cons<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>blast</span> <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span>Red_ml_list_pres_no_match<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1 id=NBE-Red_term_hnf_induct><span class=command>lemma</span></span> Red_term_hnf_induct<span class=main>[</span><span class=operator>consumes</span> 1<span class=main>]</span><span class=main>:</span>
<span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t</span><span class=main>::</span>tm<span class=main>)</span> <span class=main>⇒</span> <span class=free>t'</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>nm</span> <span class=bound>vs</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span><span class=main>(</span>term <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=bound>nm</span> <span class=bound>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span>C <span class=bound>nm</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=bound>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>vs</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>P</span> <span class=main>(</span>term <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=bound>x</span> <span class=bound>vs</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span><span class=main>(</span>V <span class=bound>x</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=bound>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>vf</span> <span class=bound>vs</span> <span class=bound>n</span> <span class=bound>ts</span><span class=main>.</span>
    <span class=free>P</span> <span class=main>(</span>term <span class=main>(</span>Clo <span class=bound>vf</span> <span class=bound>vs</span> <span class=bound>n</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>
     <span class=main>(</span><span class=main>(</span>Λ <span class=main>(</span>term <span class=main>(</span>apply <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>Clo <span class=bound>vf</span> <span class=bound>vs</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span> <span class=bound>t'</span> <span class=bound>ts</span><span class=main>.</span> <span class=main>⟦</span><span class=bound>t</span> <span class=main>⇒</span> <span class=bound>t'</span><span class=main>;</span> <span class=free>P</span> <span class=bound>t</span> <span class=bound>t'</span><span class=main>⟧</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Λ <span class=bound>t</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span>Λ <span class=bound>t'</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>v</span> <span class=bound>v'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>v</span> <span class=main>⇒</span> <span class=bound>v'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>term <span class=bound>v</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span>term <span class=bound>v'</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>i</span> <span class=bound>t'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>t'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span><span class=bound>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=bound>t'</span><span class=main>)</span>
    <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>V <span class=bound>x</span>  <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span>V <span class=bound>x</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>t'</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>nm</span> <span class=bound>i</span> <span class=bound>t'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>t'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span><span class=bound>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=bound>t'</span><span class=main>)</span>
    <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>C <span class=bound>nm</span>  <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span>C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>t'</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>t</span> <span class=bound>i</span> <span class=bound>t'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>t'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span><span class=bound>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=bound>t'</span><span class=main>)</span>
    <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>Λ <span class=bound>t</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span>Λ <span class=bound>t</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>t'</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>v</span> <span class=bound>i</span> <span class=bound>t'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>t'</span> <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span><span class=bound>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>(</span><span class=bound>t'</span><span class=main>)</span>
    <span class=main>⟹</span> <span class=free>P</span> <span class=main>(</span>term <span class=bound>v</span>  <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>)</span> <span class=main>(</span>term <span class=bound>v</span> <span class=main>∙∙</span> <span class=main>(</span><span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>t'</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free>t</span> <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>ts</span> <span class=keyword1><span class=command>from</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>(</span><span class=free>t</span> <span class=main>∙∙</span> <span class=skolem>ts</span><span class=main>)</span> <span class=main>(</span><span class=free>t'</span> <span class=main>∙∙</span> <span class=skolem>ts</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term.induct<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> term_C <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> term_V <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> term_Clo <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> ctxt_Lam <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> foldl_Nil<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_At1 <span class=skolem>s</span> <span class=skolem>s'</span> <span class=skolem>t</span> <span class=skolem>ts</span><span class=main>)</span>
      <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At1<span class=main>(</span>2<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span><span class=main>#</span><span class=skolem>ts</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_At2 <span class=skolem>t</span> <span class=skolem>t'</span> <span class=skolem>s</span> <span class=skolem>ts</span><span class=main>)</span>
      <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span> <span class=skolem>rs</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>=</span> V <span class=skolem>n</span> <span class=main>∙∙</span> <span class=skolem>rs</span>"</span></span>
        <span class=keyword1><span class=command>hence</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At2<span class=main>(</span>8<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"size <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span> <span class=main>@</span> <span class=skolem>t</span> <span class=main>#</span> <span class=skolem>ts</span>"</span></span> <span class=quoted><span class=skolem>t'</span></span> <span class=quoted><span class=skolem>n</span></span><span class=main>]</span> ctxt_At2
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> foldl_Nil<span class=main>)</span>
      <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>nm</span> <span class=skolem>rs</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>=</span> C <span class=skolem>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span>"</span></span>
        <span class=keyword1><span class=command>hence</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At2<span class=main>(</span>9<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"size <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span> <span class=main>@</span> <span class=skolem>t</span> <span class=main>#</span> <span class=skolem>ts</span>"</span></span> <span class=quoted><span class=skolem>t'</span></span> <span class=quoted><span class=skolem>nm</span></span><span class=main>]</span> ctxt_At2
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> foldl_Nil<span class=main>)</span>
      <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>r</span> <span class=skolem>rs</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>=</span> Λ <span class=skolem>r</span> <span class=main>∙∙</span> <span class=skolem>rs</span>"</span></span>
        <span class=keyword1><span class=command>hence</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At2<span class=main>(</span>10<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"size <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span> <span class=main>@</span> <span class=skolem>t</span> <span class=main>#</span> <span class=skolem>ts</span>"</span></span> <span class=quoted><span class=skolem>t'</span></span><span class=main>]</span> ctxt_At2
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> foldl_Nil<span class=main>)</span>
      <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span> <span class=skolem>rs</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>=</span> term <span class=skolem>v</span> <span class=main>∙∙</span> <span class=skolem>rs</span>"</span></span>
        <span class=keyword1><span class=command>hence</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At2<span class=main>(</span>11<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"size <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span> <span class=main>@</span> <span class=skolem>t</span> <span class=main>#</span> <span class=skolem>ts</span>"</span></span> <span class=quoted><span class=skolem>t'</span></span><span class=main>]</span> ctxt_At2
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> foldl_Nil<span class=main>)</span>
      <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> tm_vector_cases<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>s</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>from</span></span> this<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span><span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>corollary</span></span> Red_term_hnf_cases<span class=main>[</span><span class=operator>consumes</span> 1<span class=main>]</span><span class=main>:</span>
<span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>t</span><span class=main>::</span>tm<span class=main>)</span> <span class=main>⇒</span> <span class=free>t'</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>nm</span> <span class=bound>vs</span> <span class=bound>ts</span><span class=main>.</span>
  <span class=free>t</span> <span class=main>=</span> term <span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=bound>nm</span> <span class=bound>vs</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> <span class=main>(</span>C <span class=bound>nm</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=bound>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>vs</span> <span class=bound>ts</span><span class=main>.</span>
  <span class=free>t</span> <span class=main>=</span> term <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=bound>x</span> <span class=bound>vs</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> <span class=main>(</span>V <span class=bound>x</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=bound>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>vf</span> <span class=bound>vs</span> <span class=bound>n</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> term <span class=main>(</span>Clo <span class=bound>vf</span> <span class=bound>vs</span> <span class=bound>n</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span>
     <span class=free>t'</span> <span class=main>=</span> Λ <span class=main>(</span>term <span class=main>(</span>apply <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>Clo <span class=bound>vf</span> <span class=bound>vs</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span> <span class=bound>s'</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> Λ <span class=bound>s</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> Λ <span class=bound>s'</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>s</span> <span class=main>⇒</span> <span class=bound>s'</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>v</span> <span class=bound>v'</span> <span class=bound>ts</span><span class=main>.</span> <span class=free>t</span> <span class=main>=</span> term <span class=bound>v</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> term <span class=bound>v'</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>v</span> <span class=main>⇒</span> <span class=bound>v'</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span> <span class=bound>i</span> <span class=bound>r'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>r'</span>
    <span class=main>⟹</span> <span class=free>t</span> <span class=main>=</span> V <span class=bound>x</span>  <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> V <span class=bound>x</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>r'</span><span class=main>]</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>nm</span> <span class=bound>i</span> <span class=bound>r'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>r'</span>
    <span class=main>⟹</span> <span class=free>t</span> <span class=main>=</span> C <span class=bound>nm</span>  <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>r'</span><span class=main>]</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span> <span class=bound>i</span> <span class=bound>r'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>r'</span>
    <span class=main>⟹</span> <span class=free>t</span> <span class=main>=</span> Λ <span class=bound>s</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> Λ <span class=bound>s</span> <span class=main>∙∙</span> <span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>r'</span><span class=main>]</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
  <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>v</span> <span class=bound>i</span> <span class=bound>r'</span> <span class=bound>ts</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=bound>ts</span> <span class=main>⟹</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒</span> <span class=bound>r'</span>
    <span class=main>⟹</span> <span class=free>t</span> <span class=main>=</span> term <span class=bound>v</span>  <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>⟹</span> <span class=free>t'</span> <span class=main>=</span> term <span class=bound>v</span> <span class=main>∙∙</span> <span class=main>(</span><span class=bound>ts</span><span class=main>[</span><span class=bound>i</span><span class=main>:=</span><span class=bound>r'</span><span class=main>]</span><span class=main>)</span> <span class=main>⟹</span> <span class=free>P</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>-</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term_hnf_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>term <span class=free>v</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟷</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>∧</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> C_normal.cases<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>Λ <span class=free>t</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟷</span> C_normal <span class=free>t</span> <span class=main>∧</span> <span class=free>ts</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> C_normal.cases<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟷</span>
  <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> C_normal <span class=bound>t</span><span class=main>)</span> <span class=main>∧</span> no_match_R <span class=free>nm</span> <span class=main>(</span>map dterm <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> C_normal.cases<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"C_normal<span class=main>(</span>V <span class=free>x</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span> <span class=main>∈</span> set <span class=free>ts</span><span class=main>.</span> C_normal <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> C_normal.cases<span class=main>)</span>

<span class=keyword1 id=NBE-no_match_ML_lift><span class=command>lemma</span></span> no_match_ML_lift<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=free>vs</span> <span class=main>⟶</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match_ML.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span>1 2<span class=main><span class=main>)</span></span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"map <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span><span class=main>)</span> <span class=improper>vs'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-no_match_compR_lift><span class=command>lemma</span></span> no_match_compR_lift<span class=main>:</span>
  <span class=quoted><span class=quoted>"no_match_compR <span class=free>nm</span> <span class=free>vs</span> <span class=main>⟹</span> no_match_compR <span class=free>nm</span> <span class=main>(</span>map <span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> no_match_ML_lift<span class=main>)</span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span><span class=keyword1>lift</span> <span class=free>k</span> <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>v</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>k</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>lift_ml.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>no_match_compR_lift<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>simp_depth_limit</span> <span class=main><span class=main>=</span></span> 10<span class=main>]</span><span class=main>]</span>

<span class=keyword1 id=NBE-Red_term_pres_no_match><span class=command>lemma</span></span> Red_term_pres_no_match<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span><span class=free>i</span> <span class=main>&lt;</span> length <span class=free>ts</span><span class=main>;</span> <span class=free>ts</span> <span class=main>!</span> <span class=free>i</span> <span class=main>⇒</span> <span class=free>t'</span><span class=main>;</span> no_match <span class=free>ps</span> <span class=free>dts</span><span class=main>;</span> <span class=free>dts</span> <span class=main>=</span> <span class=main>(</span>map dterm <span class=free>ts</span><span class=main>)</span><span class=main>⟧</span>
   <span class=main>⟹</span> no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=main>(</span><span class=free>ts</span><span class=main>[</span><span class=free>i</span> <span class=main>:=</span> <span class=free>t'</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>dts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>i</span></span> <span class=quoted><span class=free>t'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>no_match.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>ps</span> <span class=skolem>dts</span> <span class=skolem>ts</span> <span class=skolem>i</span> <span class=skolem>t'</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹no_match <span class=skolem>ps</span> <span class=skolem>dts</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>dts</span> <span class=main>=</span> map dterm <span class=skolem>ts</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>j</span></span> <span class=skolem><span class=skolem>nm</span></span> <span class=skolem><span class=skolem>nm'</span></span> <span class=skolem><span class=skolem>rs</span></span> <span class=skolem><span class=skolem>rs'</span></span> <span class=keyword2><span class=keyword>where</span></span> ob<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> size <span class=skolem>ts</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> size <span class=skolem>ps</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>ps</span><span class=main>!</span><span class=skolem>j</span> <span class=main>=</span> C <span class=skolem>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"dterm <span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=skolem>j</span><span class=main>)</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=skolem>rs'</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>nm</span> <span class=main>=</span> <span class=skolem>nm'</span> <span class=main>⟶</span> no_match <span class=skolem>rs</span> <span class=skolem>rs'</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match.simps<span class=main>)</span> <span class=operator>fastforce</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>subst</span> no_match.simps<span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&lt;</span>min <span class=main>(</span>length <span class=main>(</span>map dterm <span class=main>(</span><span class=skolem>ts</span><span class=main>[</span><span class=skolem>i</span> <span class=main>:=</span> <span class=skolem>t'</span><span class=main>]</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>length <span class=skolem>ps</span><span class=main>)</span><span class=main>.</span>
       <span class=main>∃</span><span class=bound>nm</span> <span class=bound>nm'</span> <span class=bound>rs</span> <span class=bound>rs'</span><span class=main>.</span> <span class=skolem>ps</span><span class=main>!</span><span class=bound>k</span>  <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>rs</span> <span class=main>∧</span>
         map dterm <span class=main>(</span><span class=skolem>ts</span><span class=main>[</span><span class=skolem>i</span> <span class=main>:=</span> <span class=skolem>t'</span><span class=main>]</span><span class=main>)</span> <span class=main>!</span> <span class=bound>k</span> <span class=main>=</span> C <span class=bound>nm'</span> <span class=main>∙∙</span> <span class=bound>rs'</span> <span class=main>∧</span>
        <span class=main>(</span><span class=bound>nm</span> <span class=main>=</span> <span class=bound>nm'</span> <span class=main>⟶</span> no_match <span class=bound>rs</span> <span class=bound>rs'</span><span class=main>)</span>"</span></span>
      <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span> <span class=main>&lt;</span> <span class=var>?m</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>k</span>"</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
      <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>assume</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span><span class=main>=</span><span class=skolem>i</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>rs'</span><span class=main>.</span> dterm <span class=skolem>t'</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=bound>rs'</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>nm</span> <span class=main>=</span> <span class=skolem>nm'</span> <span class=main>⟶</span> no_match <span class=skolem>rs</span> <span class=bound>rs'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>ts</span> <span class=main>!</span> <span class=skolem>i</span> <span class=main>⇒</span> <span class=skolem>t'</span>›</span></span>
        <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term_hnf_cases<span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>5 <span class=skolem>v</span> <span class=skolem>v'</span> <span class=skolem>ts''</span><span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>vs</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span>
            <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=skolem>nm'</span> <span class=skolem>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs'</span> <span class=main>=</span> map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span> <span class=main>@</span> map dterm <span class=skolem>ts''</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> ob <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>v</span></span><span class=main>)</span> <span class=operator>auto</span>
          <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>vs'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v'</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=skolem>nm'</span> <span class=skolem>vs'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs</span> <span class=main>⇒</span> <span class=skolem>vs'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>v</span><span class=main>⇒</span><span class=skolem>v'</span>›</span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> Red_ml.cases<span class=main>)</span> <span class=operator>auto</span>
          <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v'</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>arith</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>vs</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>v'</span>"</span></span>
            <span class=keyword2><span class=keyword>and</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>=</span> <span class=skolem>vs</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> <span class=skolem>v'</span><span class=main>]</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> Red_ml_list_nth<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>vs</span><span class=main>⇒</span><span class=skolem>vs'</span>›</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>rs'</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>rs'</span> <span class=main>∧</span> <span class=var>?Q</span> <span class=bound>rs'</span>"</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>proof</span></span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rs'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"map dterm <span class=main>(</span><span class=main>(</span>map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>ts''</span><span class=main>)</span><span class=main>[</span><span class=main>(</span>size <span class=skolem>vs</span> <span class=main>-</span> <span class=skolem>k</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>:=</span>term <span class=skolem>v'</span><span class=main>]</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=var>?rs'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ob 5
              <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> list_update_append map_update<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span> rev_update<span class=main>)</span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span> <span class=var>?rs'</span>"</span></span>
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> <span class=quoted>"1.hyps"</span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ ob<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
              <span class=keyword1><span class=command>using</span></span> <span class=quoted>"1.prems"</span> 5 ob
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>nth_append rev_nth ctxt_term<span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>vs</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>v'</span>›</span></span><span class=main><span class=main>]</span></span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
              <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=var>?rs'</span> <span class=main>∧</span> <span class=var>?Q</span> <span class=var>?rs'</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>7 <span class=skolem>nm''</span> <span class=skolem>k</span> <span class=skolem>r'</span> <span class=skolem>ts''</span><span class=main>)</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>rs'</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>rs'</span>"</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>proof</span></span>
            <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span>map dterm <span class=main>(</span><span class=skolem>ts''</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> <span class=skolem>r'</span><span class=main>]</span><span class=main>)</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> 7 ob
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> <span class=quoted>"1.hyps"</span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ ob<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
              <span class=keyword1><span class=command>using</span></span> 7 <span class=quoted>"1.prems"</span> ob <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>9 <span class=skolem>v</span> <span class=skolem>k</span> <span class=skolem>r'</span> <span class=skolem>ts''</span><span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>vs</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=skolem>nm'</span> <span class=skolem>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs'</span> <span class=main>=</span> map <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span> <span class=main>@</span> map dterm <span class=skolem>ts''</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> ob <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>v</span></span><span class=main>)</span> <span class=operator>auto</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>rs'</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>rs'</span> <span class=main>∧</span> <span class=var>?Q</span> <span class=bound>rs'</span>"</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>proof</span></span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rs'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"map dterm <span class=main>(</span><span class=main>(</span>map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>ts''</span><span class=main>)</span><span class=main>[</span><span class=skolem>k</span><span class=main>+</span>size <span class=skolem>vs</span><span class=main>:=</span><span class=skolem>r'</span><span class=main>]</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=var>?rs'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ob 9 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> list_update_append<span class=main>)</span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span> <span class=var>?rs'</span>"</span></span>
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
              <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> <span class=quoted>"1.hyps"</span><span class=main><span class=main>[</span></span><span class=operator>OF</span> _ ob<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
              <span class=keyword1><span class=command>using</span></span> 9 <span class=quoted>"1.prems"</span> ob <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>nth_append <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=var>?rs'</span> <span class=main>∧</span> <span class=var>?Q</span> <span class=var>?rs'</span>"</span></span> <span class=keyword1><span class=command>..</span></span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>insert</span> ob<span class=main><span class=keyword3>,</span></span> <span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>rs'</span><span class=main>.</span> dterm <span class=main>(</span><span class=skolem>ts</span><span class=main>[</span><span class=skolem>i</span> <span class=main>:=</span> <span class=skolem>t'</span><span class=main>]</span> <span class=main>!</span> <span class=skolem>j</span><span class=main>)</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=bound>rs'</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>nm</span> <span class=main>=</span> <span class=skolem>nm'</span> <span class=main>⟶</span> no_match <span class=skolem>rs</span> <span class=bound>rs'</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>ts</span>›</span></span> ob <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_list_update<span class=main>)</span>
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ob <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> <span class=var>?m</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>j</span> <span class=main>&lt;</span> length <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>j</span> <span class=main>&lt;</span> size <span class=skolem>ps</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>declare</span></span> <span class=main>[</span><span class=main>[</span><span class=operator>simp_depth_limit</span> <span class=main><span class=main>=</span></span> 50<span class=main>]</span><span class=main>]</span>

<span class=keyword1 id=NBE-Red_term_pres_no_match_it><span class=command>lemma</span></span> Red_term_pres_no_match_it<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>⟦</span> <span class=main>∀</span> <span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> length <span class=free>ts</span><span class=main>.</span> <span class=main>(</span><span class=free>ts</span> <span class=main>!</span> <span class=bound>i</span><span class=main>,</span> <span class=free>ts'</span> <span class=main>!</span> <span class=bound>i</span><span class=main>)</span> <span class=main>:</span> Red_term <span class=main>^^</span> <span class=main>(</span><span class=free>ns</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span><span class=main>;</span>
    size <span class=free>ts'</span> <span class=main>=</span> size <span class=free>ts</span><span class=main>;</span> size <span class=free>ns</span> <span class=main>=</span> size <span class=free>ts</span><span class=main>;</span>
    no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=free>ts</span><span class=main>)</span><span class=main>⟧</span>
   <span class=main>⟹</span> no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=free>ts'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=quoted>"sum_list <span class=free>ns</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>ns</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> size <span class=skolem>ts</span><span class=main>.</span> <span class=skolem>ns</span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> <span class=main>0</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>with</span></span> 0 <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> nth_equalityI<span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>n</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sum_list <span class=skolem>ns</span> <span class=main>≠</span> <span class=main>0</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>arith</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=skolem><span class=skolem>l</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>ts</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ns</span><span class=main>!</span><span class=skolem>k</span> <span class=main>=</span> Suc <span class=skolem>l</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> <span class=quoted><span class=quoted>‹length <span class=skolem>ns</span> <span class=main>=</span> length <span class=skolem>ts</span>›</span></span> gr0_implies_Suc in_set_conv_nth<span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ns</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=skolem>ns</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> <span class=skolem>l</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> sum_list <span class=var>?ns</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹Suc <span class=skolem>n</span> <span class=main>=</span> sum_list <span class=skolem>ns</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹size <span class=skolem>ns</span> <span class=main>=</span> size <span class=skolem>ts</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>sum_list_update<span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ts</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>t'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t'</span><span class=main>,</span> <span class=free>ts'</span><span class=main>!</span><span class=skolem>k</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>l</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Suc<span class=main>(</span>3<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹size <span class=skolem>ns</span> <span class=main>=</span> size <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>ns</span><span class=main>!</span><span class=skolem>k</span> <span class=main>=</span> Suc <span class=skolem>l</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> relpow_Suc_E2<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>size<span class=main>(</span><span class=skolem>ts</span><span class=main>[</span><span class=skolem>k</span><span class=main>:=</span><span class=skolem>t'</span><span class=main>]</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=skolem>ts</span><span class=main>[</span><span class=skolem>k</span><span class=main>:=</span><span class=skolem>t'</span><span class=main>]</span><span class=main>!</span><span class=bound>i</span><span class=main>,</span> <span class=free>ts'</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=main>(</span><span class=var>?ns</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Suc<span class=main>(</span>3<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹size <span class=skolem>ns</span> <span class=main>=</span> size <span class=skolem>ts</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_list_update<span class=main>)</span>
  <span class=keyword1><span class=command>note</span></span> nm1 <span class=main>=</span> Red_term_pres_no_match<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>ts</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>t'</span>›</span></span> <span class=quoted><span class=quoted>‹no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=skolem>ts</span><span class=main>)</span>›</span></span><span class=main>]</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>rule</span> Suc<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>n</span> <span class=main>=</span> sum_list <span class=var>?ns</span>›</span></span> 1 _ _ nm1<span class=main><span class=main>]</span></span><span class=main>)</span>
               <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹size <span class=free>ts'</span> <span class=main>=</span> size <span class=skolem>ts</span>›</span></span> <span class=quoted><span class=quoted>‹size <span class=skolem>ns</span> <span class=main>=</span> size <span class=skolem>ts</span>›</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=NBE-Red_term_pres_no_match_star><span class=command>lemma</span></span> Red_term_pres_no_match_star<span class=main>:</span>
<span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> length<span class=main>(</span><span class=free>ts</span><span class=main>::</span>tm list<span class=main>)</span><span class=main>.</span> <span class=free>ts</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>⇒*</span> <span class=free>ts'</span> <span class=main>!</span> <span class=bound>i</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"size <span class=free>ts'</span> <span class=main>=</span> size <span class=free>ts</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=free>ts'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>%</span><span class=bound>ns</span><span class=main>.</span> size <span class=bound>ns</span> <span class=main>=</span> size <span class=free>ts</span> <span class=main>∧</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span> <span class=main>&lt;</span> length <span class=free>ts</span><span class=main>.</span><span class=main>(</span><span class=free>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>,</span> <span class=free>ts'</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=main>(</span><span class=bound>ns</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>ns</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>ns</span>"</span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subst</span> Skolem_list_nth<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
      <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>rtrancl_power<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> someI_ex<span class=main>[</span><span class=operator>OF</span> this<span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> Red_term_pres_no_match_it<span class=main><span class=main>[</span></span><span class=operator>OF</span> _ assms<span class=main><span class=main><span class=main>(</span></span></span>2<span class=main><span class=main><span class=main>)</span></span></span> _ assms<span class=main><span class=main><span class=main>(</span></span></span>3<span class=main><span class=main><span class=main>)</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-not_pure_term><span class=command>lemma</span></span> not_pure_term<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> pure<span class=main>(</span>term <span class=free>v</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"pure<span class=main>(</span>term <span class=free>v</span><span class=main>)</span>"</span></span> <span class=keyword3><span class=command>thus</span></span> <span class=quoted>False</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>cases</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>abbreviation</span></span> <span class=entity>RedMLs</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list <span class=main>⇒</span> tm list <span class=main>⇒</span> bool"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>infix</span></span> <span class=quoted>"<span class=keyword1>[⇒*]</span>"</span> 50<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=main><span class=free>[⇒*]</span></span> <span class=free><span class=bound><span class=entity>ts</span></span></span>  <span class=main>≡</span>  size <span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=main>=</span> size <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>size <span class=free><span class=bound><span class=entity>ss</span></span></span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ss</span></span></span><span class=main>!</span><span class=bound>i</span> <span class=main>⇒*</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>!</span><span class=bound>i</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>fun</span></span> <span class=entity>C_U_args</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm <span class=main>⇒</span> tm list"</span></span> <span class=main>(</span><span class=quoted>"<span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>'_args</span>"</span><span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C<span class=hidden>⇩</span><sub>U</sub>_args</span></span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∙</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=keyword1><span class=free>C<span class=hidden>⇩</span><sub>U</sub>_args</span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>]</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C<span class=hidden>⇩</span><sub>U</sub>_args</span></span><span class=main>(</span>term<span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> map term <span class=main>(</span>rev <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=keyword1><span class=free>C<span class=hidden>⇩</span><sub>U</sub>_args</span></span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> <span class=main>[]</span>"</span></span>

<span class=keyword1><span class=command>lemma</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span><span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rev_induct<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-redts_term_cong><span class=command>lemma</span></span> redts_term_cong<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>⇒*</span> <span class=free>v'</span> <span class=main>⟹</span> term <span class=free>v</span> <span class=main>⇒*</span> term <span class=free>v'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> converse_rtrancl_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> rtrancl_refl<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>fast</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span> converse_rtrancl_into_rtrancl <span class=quasi_keyword>dest</span><span class=main><span class=main>:</span></span> ctxt_term<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-C_Red_term_ML><span class=command>lemma</span></span> C_Red_term_ML<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>⇒</span> <span class=free>v'</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>⟹</span> <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span>
   <span class=main>⟹</span> <span class=keyword1>dterm<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v'</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> map dterm <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span><span class=main>(</span>term <span class=free>v'</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
      <span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span><span class=main>(</span>term <span class=free>v</span><span class=main>)</span> <span class=main>[⇒*]</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span><span class=main>(</span>term <span class=free>v'</span><span class=main>)</span> <span class=main>∧</span>
      <span class=free>ts</span> <span class=main>=</span> map dterm <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span><span class=main>(</span>term <span class=free>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span><span class=main>::</span> ml list<span class=main>)</span> <span class=main>⇒</span> <span class=free>vs'</span> <span class=main>⟹</span> <span class=free>i</span> <span class=main>&lt;</span> length <span class=free>vs</span> <span class=main>⟹</span> <span class=free>vs</span> <span class=main>!</span> <span class=free>i</span> <span class=main>⇒*</span> <span class=free>vs'</span> <span class=main>!</span> <span class=free>i</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>nm</span></span> <span class=quoted><span class=free>ts</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_ml_Red_ml_list.inducts<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>Red_ml_list_length <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> Red_ml_list_length<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> redts_term_cong rev_nth <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_Cons' r_into_rtrancl <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_Cons'<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1 id=NBE-C_normal_subterm><span class=command>lemma</span></span> C_normal_subterm<span class=main>:</span>
  <span class=quoted><span class=quoted>"C_normal <span class=free>t</span> <span class=main>⟹</span> dterm <span class=free>t</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟹</span> <span class=free>s</span> <span class=main>∈</span> set<span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t</span><span class=main>)</span> <span class=main>⟹</span> C_normal <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> C_normal.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper>v</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-C_normal_subterms><span class=command>lemma</span></span> C_normal_subterms<span class=main>:</span>
  <span class=quoted><span class=quoted>"C_normal <span class=free>t</span> <span class=main>⟹</span> dterm <span class=free>t</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟹</span> <span class=free>ts</span> <span class=main>=</span> map dterm <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> C_normal.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper>v</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-C_redt><span class=command>lemma</span></span> C_redt<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>⇒</span> <span class=free>t'</span> <span class=main>⟹</span> C_normal <span class=free>t</span> <span class=main>⟹</span> 
    C_normal <span class=free>t'</span> <span class=main>∧</span> <span class=main>(</span>dterm <span class=free>t</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟶</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>ts'</span><span class=main>.</span> <span class=bound>ts'</span> <span class=main>=</span> map dterm <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t'</span><span class=main>)</span> <span class=main>∧</span> dterm <span class=free>t'</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=bound>ts'</span> <span class=main>∧</span>
     <span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t</span> <span class=main>[⇒*]</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t'</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>nm</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term_hnf_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>del</span><span class=main><span class=main>:</span></span> map_map<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> no_match_R_coincide rev_rev_ident<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> C_normal_ML_inv<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarify</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> <span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> C_Red_term_ML<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> insert_iff subsetD set_update_subset_insert<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> insert_iff subsetD set_update_subset_insert<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarify</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> bspec<span class=main><span class=keyword3>,</span></span> <span class=operator>assumption</span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match.simps<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> no_match.simps<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rename_tac</span> j nm nm' rs rs'<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>j</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=quoted>"<span class=improper>i</span><span class=main>=</span><span class=improper>j</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>rs'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> all_set_conv_all_nth<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>metis</span> C_normal_subterms Red_term_pres_no_match_star<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>nth_list_update<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1 id=NBE-C_redts><span class=command>lemma</span></span> C_redts<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>t</span> <span class=main>⇒*</span> <span class=free>t'</span> <span class=main>⟹</span> C_normal <span class=free>t</span> <span class=main>⟹</span>
    C_normal <span class=free>t'</span> <span class=main>∧</span> <span class=main>(</span>dterm <span class=free>t</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span> <span class=main>⟶</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>ts'</span><span class=main>.</span> dterm <span class=free>t'</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=bound>ts'</span> <span class=main>∧</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t</span> <span class=main>[⇒*]</span> <span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t'</span> <span class=main>∧</span>
     <span class=bound>ts'</span> <span class=main>=</span> map dterm <span class=main>(</span><span class=keyword1>C<span class=hidden>⇩</span><sub>U</sub>_args</span> <span class=free>t'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>nm</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>converse_rtrancl_induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>using</span></span> tm_vector_cases<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>t'</span></span><span class=main>]</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>elim</span> disjE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=improper>v</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule_tac</span> nm<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> ts<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>ts</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> C_redt<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarify</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarify</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> rtrancl_trans<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-no_match_preserved><span class=command>lemma</span></span> no_match_preserved<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> C_normal <span class=bound>t</span> <span class=main>⟹</span> <span class=free>ts</span> <span class=main>[⇒*]</span> <span class=free>ts'</span>
   <span class=main>⟹</span> no_match <span class=free>ps</span> <span class=free>os</span> <span class=main>⟹</span> <span class=free>os</span> <span class=main>=</span> map dterm <span class=free>ts</span> <span class=main>⟹</span> no_match <span class=free>ps</span> <span class=main>(</span>map dterm <span class=free>ts'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quoted><span class=free>os</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>ts</span></span> <span class=quoted><span class=free>ts'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> no_match.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>ps</span> <span class=skolem>os</span><span class=main>)</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=skolem><span class=skolem>nm</span></span> <span class=skolem><span class=skolem>nm'</span></span> <span class=skolem><span class=skolem>ps'</span></span> <span class=skolem><span class=skolem>os'</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>ps</span><span class=main>!</span><span class=skolem>i</span> <span class=main>=</span> C <span class=skolem>nm</span>  <span class=main>∙∙</span> <span class=skolem>ps'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>ps</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>os</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>os</span><span class=main>!</span><span class=skolem>i</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=skolem>os'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>nm</span><span class=main>=</span><span class=skolem>nm'</span> <span class=main>⟶</span> no_match <span class=skolem>ps'</span> <span class=skolem>os'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>4<span class=main>)</span> no_match.simps<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>ps</span></span> <span class=quoted><span class=skolem>os</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>note</span></span> 1<span class=main>(</span>5<span class=main>)</span><span class=main>[</span><span class=operator>simp</span><span class=main>]</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"C_normal <span class=main>(</span><span class=skolem>ts</span> <span class=main>!</span> <span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>os</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span> <span class=main>⇒*</span> <span class=skolem>ts'</span><span class=main>!</span><span class=skolem>i</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>3<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>os</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dterm <span class=main>(</span><span class=skolem>ts</span> <span class=main>!</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=skolem>os'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>os</span><span class=main>!</span><span class=skolem>i</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=skolem>os'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>os</span>›</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_map<span class=main>)</span>
  <span class=keyword1><span class=command>with</span></span> C_redts <span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span> <span class=main>⇒*</span> <span class=skolem>ts'</span><span class=main>!</span><span class=skolem>i</span>›</span></span> <span class=quoted><span class=quoted>‹C_normal <span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span>›</span></span><span class=main>]</span>
    C_normal_subterm<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹C_normal <span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span>›</span></span><span class=main>]</span>
    C_normal_subterms<span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹C_normal <span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span>›</span></span><span class=main>]</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ss'</span></span> <span class=skolem><span class=skolem>rs</span></span> <span class=skolem><span class=skolem>rs'</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list"</span></span> <span class=keyword2><span class=keyword>where</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=skolem>rs</span><span class=main>.</span> C_normal <span class=bound>t</span>"</span></span>
    <span class=quoted><span class=quoted>"dterm <span class=main>(</span><span class=skolem>ts'</span> <span class=main>!</span> <span class=skolem>i</span><span class=main>)</span> <span class=main>=</span> C <span class=skolem>nm'</span> <span class=main>∙∙</span> <span class=skolem>ss'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>rs</span> <span class=main>=</span> length <span class=skolem>rs'</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>length <span class=skolem>rs</span><span class=main>.</span> <span class=skolem>rs</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>⇒*</span> <span class=skolem>rs'</span> <span class=main>!</span> <span class=bound>i</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ss'</span> <span class=main>=</span> map dterm <span class=skolem>rs'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>os'</span> <span class=main>=</span> map dterm <span class=skolem>rs</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match.simps<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=skolem>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2-5<span class=main>)</span> a b
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>i</span></span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>nm'</span></span></span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>nm'</span></span></span></span> <span class=quoted><span class=quoted><span class=quoted>"map dterm <span class=skolem><span class=skolem>rs</span></span>"</span></span></span> <span class=quoted><span class=skolem><span class=quoted><span class=skolem>rs</span></span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-Lam_Red_term_itE><span class=command>lemma</span></span> Lam_Red_term_itE<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>(</span>Λ <span class=free>t</span><span class=main>,</span> <span class=free>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=free>i</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>t''</span><span class=main>.</span> <span class=free>t'</span> <span class=main>=</span> Λ <span class=bound>t''</span> <span class=main>∧</span> <span class=main>(</span><span class=free>t</span><span class=main>,</span><span class=bound>t''</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=free>i</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>t'</span></span><span class=main>)</span><span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> relpow_Suc_E<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> Red_term.cases<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>simp_all</span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1 id=NBE-Red_term_it><span class=command>lemma</span></span> Red_term_it<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>V <span class=free>x</span> <span class=main>∙∙</span> <span class=free>rs</span><span class=main>,</span> <span class=free>r</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=free>i</span>
  <span class=main>⟹</span> <span class=main>∃</span><span class=bound>ts</span> <span class=bound>is</span><span class=main>.</span> <span class=free>r</span> <span class=main>=</span> V <span class=free>x</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>∧</span> size <span class=bound>ts</span> <span class=main>=</span> size <span class=free>rs</span> <span class=main>&amp;</span> size <span class=bound>is</span> <span class=main>=</span> size <span class=free>rs</span> <span class=main>∧</span>
       <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span>size <span class=bound>ts</span><span class=main>.</span> <span class=main>(</span><span class=free>rs</span><span class=main>!</span><span class=bound>j</span><span class=main>,</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=main>(</span><span class=bound>is</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>is</span><span class=main>!</span><span class=bound>j</span> <span class=main>&lt;=</span> <span class=free>i</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>rs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>is</span><span class=main>.</span> length <span class=bound>is</span> <span class=main>=</span> length <span class=skolem>rs</span> <span class=main>∧</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span>size <span class=skolem>rs</span><span class=main>.</span> <span class=main>(</span><span class=skolem>rs</span><span class=main>!</span><span class=bound>j</span><span class=main>,</span> <span class=skolem>rs</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=bound>is</span><span class=main>!</span><span class=bound>j</span> <span class=main>∧</span> <span class=bound>is</span><span class=main>!</span><span class=bound>j</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>is</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>is</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span>replicate <span class=main>(</span>size <span class=skolem>rs</span><span class=main>)</span> <span class=main>0</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span> <span class=skolem>rs</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>(</span>V <span class=free>x</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>,</span> <span class=free>r</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> Suc <span class=skolem>i</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r'</span></span> <span class=keyword2><span class=keyword>where</span></span> r'<span class=main>:</span> <span class=quoted><span class=quoted>"V <span class=free>x</span> <span class=main>∙∙</span> <span class=skolem>rs</span> <span class=main>⇒</span> <span class=skolem>r'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>r'</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>i</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> relpow_Suc_D2<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> r' <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&lt;</span>size <span class=skolem>rs</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=skolem>rs</span><span class=main>!</span><span class=bound>k</span> <span class=main>⇒</span> <span class=bound>s</span> <span class=main>∧</span> <span class=skolem>r'</span> <span class=main>=</span> V <span class=free>x</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>[</span><span class=bound>k</span><span class=main>:=</span><span class=bound>s</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=skolem>rs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>r'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rev_induct<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Red_term.cases<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>snoc <span class=skolem>r</span> <span class=skolem>rs</span><span class=main>)</span>
    <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>V <span class=free>x</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>)</span> <span class=main>∙</span> <span class=skolem>r</span> <span class=main>⇒</span> <span class=skolem>r'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term.cases<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_At1 <span class=skolem>s'</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=skolem><span class=skolem>s''</span></span> <span class=keyword2><span class=keyword>where</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span>length <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span> <span class=main>!</span> <span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>s''</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>=</span> V <span class=free>x</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> <span class=skolem>s''</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> snoc<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span> <span class=main>&lt;</span> <span class=var>?n</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>k</span> <span class=bound>s</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span><span class=var>?n</span> <span class=main>∧</span> <span class=var>?P</span> <span class=skolem>k</span> <span class=skolem>s''</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At1 aux
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_append<span class=main>)</span> <span class=main>(</span><span class=operator>metis</span> last_snoc butlast_snoc list_update_append1<span class=main>)</span>
        <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_At2 <span class=skolem>t'</span><span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span> <span class=main>&lt;</span> <span class=var>?n</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>k</span> <span class=bound>s</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"size <span class=skolem>rs</span><span class=main>&lt;</span><span class=var>?n</span> <span class=main>∧</span> <span class=var>?P</span> <span class=main>(</span>size <span class=skolem>rs</span><span class=main>)</span> <span class=skolem>t'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>s</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>r'</span> <span class=main>=</span> V <span class=free>x</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>[</span><span class=skolem>k</span><span class=main>:=</span><span class=skolem>s</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>from</span></span> Suc<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span><span class=main>[</span><span class=skolem>k</span><span class=main>:=</span><span class=skolem>s</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=skolem>r'</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>i</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>rs</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>rs</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>s</span>›</span></span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>is</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> Suc<span class=main>(</span><span class=improper>is</span><span class=main>!</span><span class=skolem>k</span><span class=main>)</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>nth_list_update<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=skolem>k</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> allE<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> relpow_Suc_I2 relpow.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-C_Red_term_it><span class=command>lemma</span></span> C_Red_term_it<span class=main>:</span>  <span class=quoted><span class=quoted>"<span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>rs</span><span class=main>,</span> <span class=free>r</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=free>i</span>
  <span class=main>⟹</span> <span class=main>∃</span><span class=bound>ts</span> <span class=bound>is</span><span class=main>.</span> <span class=free>r</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=bound>ts</span> <span class=main>∧</span> size <span class=bound>ts</span> <span class=main>=</span> size <span class=free>rs</span> <span class=main>∧</span> size <span class=bound>is</span> <span class=main>=</span> size <span class=free>rs</span> <span class=main>∧</span>
        <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span>size <span class=bound>ts</span><span class=main>.</span> <span class=main>(</span><span class=free>rs</span><span class=main>!</span><span class=bound>j</span><span class=main>,</span> <span class=bound>ts</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>∈</span> Red_term<span class=main>^^</span><span class=main>(</span><span class=bound>is</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>is</span><span class=main>!</span><span class=bound>j</span> <span class=main>≤</span> <span class=free>i</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span><span class=quoted><span class=free>rs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>is</span><span class=main>.</span> length <span class=bound>is</span> <span class=main>=</span> length <span class=skolem>rs</span> <span class=main>∧</span>
   <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span>size <span class=skolem>rs</span><span class=main>.</span> <span class=main>(</span><span class=skolem>rs</span><span class=main>!</span><span class=bound>j</span><span class=main>,</span> <span class=skolem>rs</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=bound>is</span><span class=main>!</span><span class=bound>j</span> <span class=main>∧</span> <span class=bound>is</span><span class=main>!</span><span class=bound>j</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span>"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>is</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>is</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span><span class=main>(</span>replicate <span class=main>(</span>size <span class=skolem>rs</span><span class=main>)</span> <span class=main>0</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span> <span class=skolem>rs</span><span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>,</span> <span class=free>r</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> Suc <span class=skolem>i</span>›</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>r'</span></span> <span class=keyword2><span class=keyword>where</span></span> r'<span class=main>:</span> <span class=quoted><span class=quoted>"C <span class=free>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span> <span class=main>⇒</span> <span class=skolem>r'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>r'</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>i</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> relpow_Suc_D2<span class=main>)</span>
  <span class=keyword1><span class=command>from</span></span> r' <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span><span class=main>&lt;</span>size <span class=skolem>rs</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=skolem>rs</span><span class=main>!</span><span class=bound>k</span> <span class=main>⇒</span> <span class=bound>s</span> <span class=main>∧</span> <span class=skolem>r'</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>[</span><span class=bound>k</span><span class=main>:=</span><span class=bound>s</span><span class=main>]</span>"</span></span>
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=skolem>rs</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>r'</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rev_induct<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> Red_term.cases<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>snoc <span class=skolem>r</span> <span class=skolem>rs</span><span class=main>)</span>
    <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>)</span> <span class=main>∙</span> <span class=skolem>r</span> <span class=main>⇒</span> <span class=skolem>r'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>Red_term.cases<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_At1 <span class=skolem>s'</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=skolem><span class=skolem>s''</span></span> <span class=keyword2><span class=keyword>where</span></span> aux<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span>length <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span> <span class=main>!</span> <span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>s''</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> <span class=skolem>s''</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> snoc<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span> <span class=main>&lt;</span> <span class=var>?n</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>k</span> <span class=bound>s</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span><span class=var>?n</span> <span class=main>∧</span> <span class=var>?P</span> <span class=skolem>k</span> <span class=skolem>s''</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At1 aux
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>nth_append<span class=main>)</span> <span class=main>(</span><span class=operator>metis</span> last_snoc butlast_snoc list_update_append1<span class=main>)</span>
        <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_At2 <span class=skolem>t'</span><span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound><span class=bound>k</span></span> <span class=main>&lt;</span> <span class=var>?n</span><span class=main>.</span> <span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=var>?P</span> <span class=bound>k</span> <span class=bound>s</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"size <span class=skolem>rs</span><span class=main>&lt;</span><span class=var>?n</span> <span class=main>∧</span> <span class=var>?P</span> <span class=main>(</span>size <span class=skolem>rs</span><span class=main>)</span> <span class=skolem>t'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> ctxt_At2 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>rs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>s</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>r'</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=skolem>rs</span><span class=main>[</span><span class=skolem>k</span><span class=main>:=</span><span class=skolem>s</span><span class=main>]</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>from</span></span> Suc<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>rs</span><span class=main>[</span><span class=skolem>k</span><span class=main>:=</span><span class=skolem>s</span><span class=main>]</span>"</span></span><span class=main>]</span> <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=skolem>r'</span><span class=main>,</span><span class=free>r</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>i</span>›</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>&lt;</span>size <span class=skolem>rs</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>rs</span><span class=main>!</span><span class=skolem>k</span> <span class=main>⇒</span> <span class=skolem>s</span>›</span></span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>is</span><span class=main>[</span><span class=skolem>k</span> <span class=main>:=</span> Suc<span class=main>(</span><span class=improper>is</span><span class=main>!</span><span class=skolem>k</span><span class=main>)</span><span class=main>]</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>nth_list_update<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=skolem>k</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> allE<span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> relpow_Suc_I2 relpow.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=NBE-pure_At><span class=command>lemma</span></span> pure_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"pure<span class=main>(</span><span class=free>s</span> <span class=main>∙</span> <span class=free>t</span><span class=main>)</span> <span class=main>⟷</span> pure <span class=free>s</span> <span class=main>∧</span> pure <span class=free>t</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>elim</span><span class=main><span class=main>:</span></span> pure.cases<span class=main>)</span>

<span class=keyword1 id=NBE-pure_foldl_At><span class=command>lemma</span></span> pure_foldl_At<span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"pure<span class=main>(</span><span class=free>s</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>⟷</span> pure <span class=free>s</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=free>ts</span><span class=main>.</span> pure <span class=bound>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-nbe_C_normal_ML><span class=command>lemma</span></span> nbe_C_normal_ML<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"term <span class=free>v</span> <span class=main>⇒*</span> <span class=free>t'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>v</span>"</span></span> <span class=quoted><span class=quoted>"pure <span class=free>t'</span>"</span></span> <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"normal <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>t</span> <span class=skolem>t'</span> <span class=skolem>i</span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>t</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i</span>"</span></span>
    <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> term <span class=skolem>v</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>v</span> <span class=main>⟹</span> pure <span class=skolem>t'</span> <span class=main>⟹</span> normal <span class=skolem>t'</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=skolem>i</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>t</span></span> <span class=quoted><span class=skolem>t'</span></span> <span class=quoted><span class=skolem>v</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>less_induct<span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>less <span class=skolem>k</span><span class=main>)</span>
    <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>k</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> 0 <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> less <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>i</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i'</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>⇒</span> <span class=skolem>s</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> red<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=main>[</span><span class=operator>arith</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span> <span class=main>&lt;=</span> <span class=skolem>i</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> eq_imp_le less<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> Suc relpow_Suc_D2<span class=main>)</span>
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"term <span class=skolem>v</span> <span class=main>⇒</span> <span class=skolem>s</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Suc less <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>cases</span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>term_C <span class=skolem>nm</span> <span class=skolem>vs</span><span class=main>)</span>
        <span class=keyword1><span class=command>with</span></span> less <span class=keyword1><span class=command>have</span></span> 0<span class=main>:</span><span class=quoted><span class=quoted>"no_match_compR <span class=skolem>nm</span> <span class=skolem>vs</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"size <span class=skolem>vs</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>C <span class=skolem>nm</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> term_C <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>with</span></span> C_Red_term_it<span class=main>[</span><span class=operator>OF</span> 1<span class=main>]</span> 
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ts</span></span> <span class=skolem><span class=skolem>ks</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>=</span> C <span class=skolem>nm</span> <span class=main>∙∙</span> <span class=skolem>ts</span>"</span></span>
          <span class=keyword2><span class=keyword>and</span></span> sz<span class=main>:</span> <span class=quoted><span class=quoted>"size <span class=skolem>ts</span> <span class=main>=</span> <span class=var>?n</span> <span class=main>∧</span> size <span class=skolem>ks</span> <span class=main>=</span> <span class=var>?n</span> <span class=main>∧</span>
          <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span><span class=var>?n</span><span class=main>.</span> <span class=main>(</span>term<span class=main>(</span><span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span><span class=main>,</span> <span class=skolem>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=main>(</span><span class=skolem>ks</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>ks</span> <span class=main>!</span> <span class=bound>i</span> <span class=main>≤</span> <span class=skolem>i'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>conj_cong<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> pure_ts<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set <span class=skolem>ts</span><span class=main>.</span> pure <span class=bound>t</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹pure <span class=skolem>t'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>{</span></span> <span class=keyword3><span class=command>fix</span></span> <span class=skolem>i</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span><span class=main>&lt;</span>size <span class=skolem>vs</span>"</span></span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command><span class=improper>hence</span></span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>term<span class=main>(</span><span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span><span class=main>,</span> <span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=main>(</span><span class=skolem>ks</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> sz<span class=main>)</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"normal <span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>-</span>
            <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> less<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>)</span>
            <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 5 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
            <span class=keyword1><span class=command>using</span></span> sz Suc <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
            <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> refl<span class=main>)</span>
            <span class=keyword1><span class=command>using</span></span> less term_C
            <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
            <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth length_rev set_rev<span class=main>)</span>
            <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth pure_ts sz<span class=main>)</span>
            <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
        <span class=keyword1><span class=command>}</span></span> <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
        <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"no_match_R <span class=skolem>nm</span> <span class=main>(</span>map dterm <span class=main>(</span>map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> map_dterm_term<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> no_match_R_coincide<span class=main>)</span> <span class=keyword1><span class=command>using</span></span> 0 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>have</span></span> 4<span class=main>:</span> <span class=quoted><span class=quoted>"map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span> <span class=main>[⇒*]</span> <span class=skolem>ts</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>C <span class=skolem>nm</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span><span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> red term_C <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>from</span></span> C_Red_term_it<span class=main>[</span><span class=operator>OF</span> this<span class=main>]</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ts'</span></span> <span class=quoted>"<span class=skolem><span class=skolem>is</span></span>"</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>=</span> C <span class=skolem>nm</span>  <span class=main>∙∙</span> <span class=skolem>ts'</span>"</span></span>
            <span class=keyword2><span class=keyword>and</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>ts'</span> <span class=main>=</span> <span class=var>?n</span> <span class=main>∧</span> length <span class=skolem>is</span> <span class=main>=</span><span class=var>?n</span> <span class=main>∧</span>
              <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span> <span class=var>?n</span><span class=main>.</span> <span class=main>(</span>map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span> <span class=main>!</span> <span class=bound>j</span><span class=main>,</span> <span class=skolem>ts'</span> <span class=main>!</span> <span class=bound>j</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>is</span> <span class=main>!</span> <span class=bound>j</span> <span class=main>∧</span> <span class=skolem>is</span> <span class=main>!</span> <span class=bound>j</span> <span class=main>≤</span> <span class=skolem>i'</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> sz <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>t'</span> <span class=main>=</span> C <span class=skolem>nm</span> <span class=main>∙∙</span> <span class=skolem>ts'</span>›</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>t'</span> <span class=main>=</span> C <span class=skolem>nm</span> <span class=main>∙∙</span> <span class=skolem>ts</span>›</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ts</span> <span class=main>=</span> <span class=skolem>ts'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> sz <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span>  <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rtrancl_is_UN_relpow<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>have</span></span> 5<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>t</span><span class=main>∈</span>set<span class=main>(</span>map term <span class=skolem>vs</span><span class=main>)</span><span class=main>.</span> C_normal <span class=bound>t</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> less term_C <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"no_match_R <span class=skolem>nm</span> <span class=main>(</span>map dterm <span class=skolem>ts</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"no_match <span class=improper>aa</span> <span class=main>(</span>map dterm <span class=main>(</span>map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2
          <span class=keyword1><span class=command>using</span></span> 3 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>blast</span> 
          <span class=keyword1><span class=command>using</span></span> 4 5 no_match_preserved<span class=main>[</span><span class=operator>OF</span> _ _ _ refl<span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=quoted>"map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>ts</span>"</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>hence</span></span> 6<span class=main>:</span> <span class=quoted><span class=quoted>"no_match_R <span class=skolem>nm</span> <span class=skolem>ts</span>"</span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> map_dterm_pure<span class=main><span class=main>[</span></span><span class=operator>OF</span> pure_ts<span class=main><span class=main>]</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"normal <span class=skolem>t'</span>"</span></span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> normal.intros<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
          <span class=keyword1><span class=command>using</span></span> 2 sz <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>set_conv_nth<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"no_match <span class=improper>aa</span> <span class=main>(</span>take <span class=main>(</span>size <span class=improper>aa</span><span class=main>)</span> <span class=skolem>ts</span><span class=main>)</span>"</span></span><span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> no_match<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>intro</span><span class=main><span class=main>:</span></span>no_match_take<span class=main>)</span>
          <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>term_V <span class=skolem>x</span> <span class=skolem>vs</span><span class=main>)</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"size <span class=skolem>vs</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>V <span class=skolem>x</span> <span class=main>∙∙</span> map term <span class=main>(</span>rev <span class=skolem>vs</span><span class=main>)</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> term_V <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>with</span></span> Red_term_it<span class=main>[</span><span class=operator>OF</span> 1<span class=main>]</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ts</span></span> <span class=quoted>"<span class=skolem><span class=skolem>is</span></span>"</span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>=</span> V <span class=skolem>x</span> <span class=main>∙∙</span> <span class=skolem>ts</span>"</span></span>
          <span class=keyword2><span class=keyword>and</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>ts</span> <span class=main>=</span> <span class=var>?n</span> <span class=main>∧</span>
            length <span class=skolem>is</span> <span class=main>=</span> <span class=var>?n</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span><span class=var>?n</span><span class=main>.</span> <span class=main>(</span>term <span class=main>(</span>rev <span class=skolem>vs</span> <span class=main>!</span> <span class=bound>j</span><span class=main>)</span><span class=main>,</span> <span class=skolem>ts</span> <span class=main>!</span> <span class=bound>j</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>is</span> <span class=main>!</span> <span class=bound>j</span> <span class=main>∧</span>
            <span class=skolem>is</span> <span class=main>!</span> <span class=bound>j</span> <span class=main>≤</span> <span class=skolem>i'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>cong</span><span class=main><span class=main>:</span></span>conj_cong<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span><span class=var>?n</span><span class=main>.</span> normal<span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=bound>j</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>clarify</span><span class=main>)</span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>j</span> <span class=keyword3><span class=command>assume</span></span> 0<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>j</span> <span class=main>&lt;</span> <span class=var>?n</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>is</span><span class=main>!</span><span class=skolem>j</span> <span class=main>&lt;</span> <span class=skolem>k</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span><span class=main>=</span>Suc <span class=skolem>i</span>›</span></span> 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>have</span></span> red<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>term <span class=main>(</span>rev <span class=skolem>vs</span> <span class=main>!</span> <span class=skolem>j</span><span class=main>)</span><span class=main>,</span> <span class=skolem>ts</span> <span class=main>!</span> <span class=skolem>j</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>is</span> <span class=main>!</span> <span class=skolem>j</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>j</span> <span class=main>&lt;</span> <span class=var>?n</span>›</span></span> 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>have</span></span> pure<span class=main>:</span> <span class=quoted><span class=quoted>"pure <span class=main>(</span><span class=skolem>ts</span> <span class=main>!</span> <span class=skolem>j</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹pure <span class=skolem>t'</span>›</span></span> 0 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>have</span></span> Cnm<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=skolem>vs</span> <span class=main>!</span> <span class=skolem>j</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>using</span></span> less term_V
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> 0 in_set_conv_nth length_rev set_rev<span class=main>)</span>
          <span class=keyword1><span class=command>from</span></span> less<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>is</span><span class=main>!</span><span class=skolem>j</span> <span class=main>&lt;</span> <span class=skolem>k</span>›</span></span> refl Cnm pure red<span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"normal<span class=main>(</span><span class=skolem>ts</span><span class=main>!</span><span class=skolem>j</span><span class=main>)</span>"</span></span> <span class=keyword1><span class=command>.</span></span>
        <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>note</span></span> 3<span class=main>=</span>this
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> normal.intros<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> in_set_conv_nth 2 3<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>term_Clo <span class=skolem>f</span> <span class=skolem>vs</span> <span class=skolem>n</span><span class=main>)</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?u</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"apply <span class=main>(</span><span class=keyword1>lift</span> <span class=main>0</span> <span class=main>(</span>Clo <span class=skolem>f</span> <span class=skolem>vs</span> <span class=skolem>n</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>V<span class=hidden>⇩</span><sub>U</sub> <span class=main>0</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>from</span></span> term_Clo <span class=quoted><span class=quoted>‹<span class=main>(</span><span class=skolem>s</span><span class=main>,</span><span class=skolem>t'</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>›</span></span>
        <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>t''</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>=</span> Λ <span class=skolem>t''</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>term <span class=var>?u</span><span class=main>,</span> <span class=skolem>t''</span><span class=main>)</span> <span class=main>:</span> Red_term<span class=main>^^</span><span class=skolem>i'</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>metis</span> Lam_Red_term_itE<span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span> <span class=main>&lt;</span> <span class=skolem>k</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span> <span class=main>=</span> Suc <span class=skolem>i</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>arith</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"pure <span class=skolem>t''</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹pure <span class=skolem>t'</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=var>?u</span>"</span></span> <span class=keyword1><span class=command>using</span></span> less term_Clo <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span><span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> less<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>i'</span> <span class=main>&lt;</span> <span class=skolem>k</span>›</span></span> refl <span class=quoted><span class=quoted>‹<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=var>?u</span>›</span></span> <span class=quoted><span class=quoted>‹pure <span class=skolem>t''</span>›</span></span> 1<span class=main>]</span>
        <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>normal.intros<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>ctxt_term <span class=skolem>u'</span><span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i'</span> <span class=main>&lt;</span> <span class=skolem>k</span>"</span></span> <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>k</span> <span class=main>=</span> Suc <span class=skolem>i</span>›</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>arith</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>u'</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>rule</span> C_normal_ML_inv<span class=main>)</span> <span class=main>(</span><span class=operator>insert</span> less ctxt_term<span class=main><span class=keyword3>,</span></span> <span class=operator>simp_all</span><span class=main>)</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>term <span class=skolem>u'</span><span class=main>,</span> <span class=skolem>t'</span><span class=main>)</span> <span class=main>∈</span> Red_term <span class=main>^^</span> <span class=skolem>i'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> red ctxt_term <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>from</span></span> less<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>OF</span> <span class=quoted><span class=quoted>‹<span class=skolem>i'</span> <span class=main>&lt;</span> <span class=skolem>k</span>›</span></span> refl <span class=quoted><span class=quoted>‹<span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=skolem>u'</span>›</span></span> <span class=quoted><span class=quoted>‹pure <span class=skolem>t'</span>›</span></span> this<span class=main>]</span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>.</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2-<span class=main>)</span> rtrancl_imp_relpow<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-C_normal_ML_compile><span class=command>lemma</span></span> C_normal_ML_compile<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>.</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span><span class=main>(</span><span class=free>σ</span> <span class=bound>i</span><span class=main>)</span> <span class=main>⟹</span> <span class=keyword1>C_normal<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>compile <span class=free>t</span> <span class=free>σ</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>t</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>σ</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>simp_all</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> C_normal_ML_lift_ML<span class=main>)</span>

<span class=keyword1><span class=command>corollary</span></span> nbe_normal<span class=main>:</span>
  <span class=quoted><span class=quoted>"pure <span class=free>t</span> <span class=main>⟹</span> term<span class=main>(</span>comp_fixed <span class=free>t</span><span class=main>)</span> <span class=main>⇒*</span> <span class=free>t'</span> <span class=main>⟹</span> pure <span class=free>t'</span> <span class=main>⟹</span> normal <span class=free>t'</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> nbe_C_normal_ML<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> C_normal_ML_compile<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>section</span></span><span class=quoted><span class=plain_text>‹Refinements›</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹We ensure that all occurrences of <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=free>nm</span></span> <span class=free><span class=free>vs</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> satisfy
the invariant <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>prop</span></span><span class=quoted><span class=quoted>"size <span class=free><span class=free>vs</span></span> <span class=main><span class=main>=</span></span> arity <span class=free><span class=free>nm</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>.›</span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹A constructor value:›</span></span>

<span class=keyword1><span class=command>fun</span></span> <span class=entity>C<span class=hidden>⇩</span><sub>U</sub>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"ml <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>C<span class=hidden>⇩</span><sub>U</sub>s</span><span class=main>(</span>C<span class=hidden>⇩</span><sub>U</sub> <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>size <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>=</span> arity <span class=free><span class=bound><span class=entity>nm</span></span></span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span><span class=main>∈</span>set <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>.</span> <span class=free>C<span class=hidden>⇩</span><sub>U</sub>s</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=main>|</span>
<span class=quoted><span class=quoted>"<span class=free>C<span class=hidden>⇩</span><sub>U</sub>s</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> False"</span></span>

<span class=keyword1 id=NBE-size_foldl_At><span class=command>lemma</span></span> size_foldl_At<span class=main>:</span> <span class=quoted><span class=quoted>"size<span class=main>(</span>C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts</span><span class=main>)</span> <span class=main>=</span> size <span class=free>ts</span> <span class=main>+</span> sum_list<span class=main>(</span>map size <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>rev_induct<span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=NBE-termination_linpats><span class=command>lemma</span></span> termination_linpats<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=free>i</span> <span class=main>&lt;</span> length <span class=free>ts</span> <span class=main>⟹</span> <span class=free>ts</span><span class=main>!</span><span class=free>i</span> <span class=main>=</span> C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts'</span>
   <span class=main>⟹</span> length <span class=free>ts'</span> <span class=main>+</span> sum_list <span class=main>(</span>map size <span class=free>ts'</span><span class=main>)</span> <span class=main>&lt;</span> length <span class=free>ts</span> <span class=main>+</span> sum_list <span class=main>(</span>map size <span class=free>ts</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"C <span class=free>nm</span> <span class=main>∙∙</span> <span class=free>ts'</span> <span class=main>:</span> set <span class=free>ts</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> sum_list_map_remove1<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=quoted>size</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>size_foldl_At<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> gr_implies_not0 length_0_conv<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹Linear patterns:›</span></span>

<span class=keyword1><span class=command>function</span></span> <span class=entity>linpats</span> <span class=main>::</span> <span class=quoted><span class=quoted>"tm list <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
<span class=quoted><span class=quoted>"<span class=free>linpats</span> <span class=free><span class=bound><span class=entity>ts</span></span></span> <span class=main>⟷</span>
 <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>size <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> V <span class=bound>x</span><span class=main>)</span> <span class=main>∨</span>
    <span class=main>(</span><span class=main>∃</span><span class=bound>nm</span> <span class=bound>ts'</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ts'</span> <span class=main>∧</span> arity <span class=bound>nm</span> <span class=main>=</span> size <span class=bound>ts'</span> <span class=main>∧</span> <span class=free>linpats</span> <span class=bound>ts'</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
 <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>size <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=main>∀</span><span class=bound><span class=bound>j</span></span><span class=main>&lt;</span>size <span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>.</span> <span class=bound>i</span><span class=main>≠</span><span class=bound>j</span> <span class=main>⟶</span> fv<span class=main>(</span><span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>!</span><span class=bound>i</span><span class=main>)</span> <span class=main>∩</span> fv<span class=main>(</span><span class=free><span class=bound><span class=entity>ts</span></span></span><span class=main>!</span><span class=bound>j</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=operator>pat_completeness</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>termination</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>relation</span> <span class=quoted><span class=quoted>"measure<span class=main>(</span><span class=main>%</span><span class=bound>ts</span><span class=main>.</span> size <span class=bound>ts</span> <span class=main>+</span> <span class=main>(</span><span class=keyword1>SUM</span> <span class=bound>t</span><span class=main>&lt;-</span><span class=bound>ts</span><span class=main>.</span> size <span class=bound>t</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>termination_linpats<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1><span class=command>declare</span></span> linpats.simps<span class=main>[</span><span class=operator>simp</span> <span class=quasi_keyword>del</span><span class=main>]</span>

<span class=comment1>(* FIXME move *)</span>
<span class=keyword1 id=NBE-eq_lists_iff_eq_nth><span class=command>lemma</span></span> eq_lists_iff_eq_nth<span class=main>:</span>
  <span class=quoted><span class=quoted>"size <span class=free>xs</span> <span class=main>=</span> size <span class=free>ys</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>xs</span><span class=main>=</span><span class=free>ys</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>size <span class=free>xs</span><span class=main>.</span> <span class=free>xs</span><span class=main>!</span><span class=bound>i</span> <span class=main>=</span> <span class=free>ys</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> nth_equalityI<span class=main>)</span>

<span class=keyword1 id=NBE-pattern_subst_ML_coincidence><span class=command>lemma</span></span> pattern_subst_ML_coincidence<span class=main>:</span>
 <span class=quoted><span class=quoted>"pattern <span class=free>t</span> <span class=main>⟹</span> <span class=main>∀</span><span class=bound>i</span><span class=main>∈</span>fv <span class=free>t</span><span class=main>.</span> <span class=free>σ</span> <span class=bound>i</span> <span class=main>=</span> <span class=free>σ'</span> <span class=bound>i</span>
  <span class=main>⟹</span> subst_ML <span class=free>σ</span> <span class=main>(</span>comp_pat <span class=free>t</span><span class=main>)</span> <span class=main>=</span> subst_ML <span class=free>σ'</span> <span class=main>(</span>comp_pat <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quasi_keyword>pred</span><span class=main><span class=main>:</span></span>pattern<span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=NBE-linpats_pattern><span class=command>lemma</span></span> linpats_pattern<span class=main>:</span> <span class=quoted><span class=quoted>"linpats <span class=free>ts</span> <span class=main>⟹</span> patterns <span class=free>ts</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ts</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>linpats.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>1 <span class=skolem>ts</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>t</span> <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>:</span> set <span class=skolem>ts</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>i</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>ts</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=main>[</span><span class=operator>simp</span><span class=main>]</span><span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>=</span> <span class=skolem>ts</span><span class=main>!</span><span class=skolem>i</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> in_set_conv_nth<span class=main>)</span>
    <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=skolem>t</span> <span class=main>=</span> V <span class=bound>x</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>nm</span> <span class=bound>ts'</span><span class=main>.</span> <span class=skolem>t</span> <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ts'</span> <span class=main>∧</span> arity <span class=bound>nm</span> <span class=main>=</span> size <span class=bound>ts'</span> <span class=main>&amp;</span> linpats <span class=bound>ts'</span><span class=main>)</span>"</span></span>
      <span class=main>(</span><span class=keyword2><span class=keyword>is</span></span> <span class=quoted><span class=quoted>"<span class=var>?V</span> <span class=main>|</span> <span class=var>?C</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>linpats.simps<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=skolem>ts</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>thus</span></span> <span class=quoted><span class=quoted>"pattern <span class=skolem>t</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=var>?V</span>"</span></span> <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>pat_V<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=var>?C</span>"</span></span> <span class=keyword3><span class=command>thus</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> <span class=quoted><span class=quoted>‹<span class=skolem>i</span> <span class=main>&lt;</span> size <span class=skolem>ts</span>›</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> <span class=main>(</span><span class=operator>metis</span> pat_C<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=NBE-no_match_ML_swap_rev><span class=command>lemma</span></span> no_match_ML_swap_rev<span class=main>:</span>
  <span class=quoted><span class=quoted>"length <span class=free>ps</span> <span class=main>=</span> length <span class=free>vs</span> <span class=main>⟹</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=free>ps</span> <span class=main>(</span>rev <span class=free>vs</span><span class=main>)</span> <span class=main>⟹</span> <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>rev <span class=free>ps</span><span class=main>)</span> <span class=free>vs</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> no_match_ML.simps<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=quoted><span class=free>ps</span></span><span class=main><span class=main>]</span></span> no_match_ML.simps<span class=main><span class=main>[</span></span><span class=operator>of</span> <span class=main><span class=main>_</span></span> <span class=quoted><span class=free>vs</span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"size <span class=free>ps</span> <span class=main>-</span> <span class=improper>i</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>fastforce</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>rev_nth<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=keyword1 id=NBE-no_match_ML_aux><span class=command>lemma</span></span> no_match_ML_aux<span class=main>:</span>
  <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> set <span class=free>cvs</span><span class=main>.</span> C<span class=hidden>⇩</span><sub>U</sub>s <span class=bound>v</span> <span class=main>⟹</span> linpats <span class=free>ps</span> <span class=main>⟹</span> size <span class=free>ps</span> <span class=main>=</span> size <span class=free>cvs</span> <span class=main>⟹</span>
  <span class=main>∀</span><span class=bound>σ</span><span class=main>.</span> map <span class=main>(</span><span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>σ</span><span class=main>)</span> <span class=main>(</span>map comp_pat <span class=free>ps</span><span class=main>)</span> <span class=main>≠</span> <span class=free>cvs</span> <span class=main>⟹</span>
  <span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>map comp_pat <span class=free>ps</span><span class=main>)</span> <span class=free>cvs</span>"</span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induct</span> <span class=quoted><span class=free>ps</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>cvs</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span>linpats.induct<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>frule</span> linpats_pattern<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> <span class=main><span class=main>(</span></span><span class=quasi_keyword>asm</span><span class=main><span class=main>)</span></span> linpats.simps<span class=main>)</span> <span class=keyword1><span class=command><span class=improper><span class=command>back</span></span></span></span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound><span class=bound>i</span></span><span class=main>&lt;</span>size <span class=improper>ts</span><span class=main>.</span> <span class=main>∃</span><span class=bound>σ</span><span class=main>.</span> <span class=keyword1>subst<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=bound>σ</span> <span class=main>(</span>comp_pat <span class=main>(</span><span class=improper>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=improper>cvs</span><span class=main>!</span><span class=bound>i</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>Skolem_list_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rename_tac</span> <span class=quoted>"σs"</span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>%</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=improper>σs</span><span class=main>!</span><span class=main>(</span><span class=keyword1>THE</span> <span class=bound>i</span><span class=main>.</span> <span class=bound>i</span><span class=main>&lt;</span>size <span class=improper>ts</span> <span class=main>&amp;</span> <span class=bound>x</span> <span class=main>:</span> fv<span class=main>(</span><span class=improper>ts</span><span class=main>!</span><span class=bound>i</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=bound>x</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> allE<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>eq_lists_iff_eq_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rotate_tac</span> -3<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> allE<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rotate_tac</span> -1<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule</span> sym<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule</span> contrapos_np<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> pattern_subst_ML_coincidence<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> in_set_conv_nth<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> a<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> theI2<span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> disjoint_iff_not_equal<span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> disjoint_iff_not_equal<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subst</span> no_match_ML.simps<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"size <span class=improper>ts</span> <span class=main>-</span> <span class=improper>i</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>rule</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=improper>ts</span><span class=main>!</span><span class=improper>i</span> <span class=main>=</span> V <span class=bound>x</span><span class=main>)</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>nm</span> <span class=bound>ts'</span><span class=main>.</span> <span class=improper>ts</span><span class=main>!</span><span class=improper>i</span> <span class=main>=</span> C <span class=bound>nm</span> <span class=main>∙∙</span> <span class=bound>ts'</span> <span class=main>&amp;</span> size <span class=bound>ts'</span> <span class=main>=</span> arity <span class=bound>nm</span> <span class=main>&amp;</span> linpats <span class=bound>ts'</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>clarsimp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> exI<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>nm'</span> <span class=bound>vs'</span><span class=main>.</span> <span class=improper>cvs</span><span class=main>!</span><span class=improper>i</span> <span class=main>=</span> C<span class=hidden>⇩</span><sub>U</sub> <span class=bound>nm'</span> <span class=bound>vs'</span> <span class=main>&amp;</span> size <span class=bound>vs'</span> <span class=main>=</span> arity <span class=bound>nm'</span> <span class=main>&amp;</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v'</span> <span class=main>∈</span> set <span class=bound>vs'</span><span class=main>.</span> C<span class=hidden>⇩</span><sub>U</sub>s <span class=bound>v'</span><span class=main>)</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>prefer</span></span></span></span> 2
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>drule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>cvs</span><span class=main>!</span><span class=improper>i</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> bspec<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>case_tac</span> <span class=quoted><span class=quoted>"<span class=improper>cvs</span><span class=main>!</span><span class=improper>i</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp_all</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>clarsimp</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span>rev_nth rev_map<span class=main><span class=main>[</span></span><span class=operator>symmetric</span><span class=main><span class=main>]</span></span><span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>i</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=improper>nm'</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=improper>ts'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"rev <span class=improper>vs'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>in</span></span></span> meta_allE<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>subgoal_tac</span> <span class=quoted><span class=quoted>"<span class=keyword1>no_match<span class=hidden>⇩</span><sub>M</sub><span class=hidden>⇩</span><sub>L</sub></span> <span class=main>(</span>map comp_pat <span class=improper>ts'</span><span class=main>)</span> <span class=main>(</span>rev <span class=improper>vs'</span><span class=main>)</span>"</span></span><span class=main>)</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> no_match_ML_swap_rev<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>simp</span>
 <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=operator>assumption</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>erule_tac</span> meta_mp<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>metis</span> rev_rev_ident<span class=main>)</span>
<span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>



<span class=comment1>(*&lt;*)</span>
<span class=keyword2><span class=keyword>end</span></span>
<span class=comment1>(*&gt;*)</span>
</pre></div></main></div></div></body></html>